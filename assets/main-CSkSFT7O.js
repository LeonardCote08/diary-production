const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MinimalistAudioEngine-DgOAyMp5.js","assets/HapticManager-Dt_agXzK.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const qu=!1,Gu=(s,t)=>s===t,Zu=Symbol("solid-track"),Zr={equals:Gu};let Ac=kc;const Ti=1,Xr=2,Ic={owned:null,cleanups:null,context:null,owner:null};var ht=null;let Hs=null,Xu=null,st=null,St=null,Jt=null,fs=0;function zr(s,t){const e=st,i=ht,n=s.length===0,r=t===void 0?i:t,o=n?Ic:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>qt(()=>Xn(o)));ht=o,st=null;try{return sr(a,!0)}finally{st=e,ht=i}}function re(s,t){t=t?Object.assign({},Zr,t):Zr;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),Mc(e,n));return[Dc.bind(e),i]}function Le(s,t,e){const i=Io(s,t,!1,Ti);rr(i)}function Li(s,t,e){Ac=Ju;const i=Io(s,t,!1,Ti);i.user=!0,Jt?Jt.push(i):rr(i)}function Vt(s,t,e){e=e?Object.assign({},Zr,e):Zr;const i=Io(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,rr(i),Dc.bind(i)}function qt(s){if(st===null)return s();const t=st;st=null;try{return s()}finally{st=t}}function Yr(s){Li(()=>qt(s))}function Zn(s){return ht===null||(ht.cleanups===null?ht.cleanups=[s]:ht.cleanups.push(s)),s}function Yu(s){const t=Vt(s),e=Vt(()=>eo(t()));return e.toArray=()=>{const i=e();return Array.isArray(i)?i:i!=null?[i]:[]},e}function Dc(){if(this.sources&&this.state)if(this.state===Ti)rr(this);else{const s=St;St=null,sr(()=>Qr(this),!1),St=s}if(st){const s=this.observers?this.observers.length:0;st.sources?(st.sources.push(this),st.sourceSlots.push(s)):(st.sources=[this],st.sourceSlots=[s]),this.observers?(this.observers.push(st),this.observerSlots.push(st.sources.length-1)):(this.observers=[st],this.observerSlots=[st.sources.length-1])}return this.value}function Mc(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&sr(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=Hs&&Hs.running;o&&Hs.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?St.push(r):Jt.push(r),r.observers&&Fc(r)),o||(r.state=Ti)}if(St.length>1e6)throw St=[],new Error},!1)),t}function rr(s){if(!s.fn)return;Xn(s);const t=fs;Ku(s,s.value,t)}function Ku(s,t,e){let i;const n=ht,r=st;st=ht=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=Ti,s.owned&&s.owned.forEach(Xn),s.owned=null),s.updatedAt=e+1,Oc(o)}finally{st=r,ht=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?Mc(s,i):s.value=i,s.updatedAt=e)}function Io(s,t,e,i=Ti,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:ht,context:ht?ht.context:null,pure:e};return ht===null||ht!==Ic&&(ht.owned?ht.owned.push(r):ht.owned=[r]),r}function Kr(s){if(s.state===0)return;if(s.state===Xr)return Qr(s);if(s.suspense&&qt(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<fs);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===Ti)rr(s);else if(s.state===Xr){const i=St;St=null,sr(()=>Qr(s,t[0]),!1),St=i}}function sr(s,t){if(St)return s();let e=!1;t||(St=[]),Jt?e=!0:Jt=[],fs++;try{const i=s();return Qu(e),i}catch(i){e||(Jt=null),St=null,Oc(i)}}function Qu(s){if(St&&(kc(St),St=null),s)return;const t=Jt;Jt=null,t.length&&sr(()=>Ac(t),!1)}function kc(s){for(let t=0;t<s.length;t++)Kr(s[t])}function Ju(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:Kr(i)}for(t=0;t<e;t++)Kr(s[t])}function Qr(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===Ti?i!==t&&(!i.updatedAt||i.updatedAt<fs)&&Kr(i):n===Xr&&Qr(i,t)}}}function Fc(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=Xr,e.pure?St.push(e):Jt.push(e),e.observers&&Fc(e))}}function Xn(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)Xn(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)Xn(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function $u(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function Oc(s,t=ht){throw $u(s)}function eo(s){if(typeof s=="function"&&!s.length)return eo(s());if(Array.isArray(s)){const t=[];for(let e=0;e<s.length;e++){const i=eo(s[e]);Array.isArray(i)?t.push.apply(t,i):t.push(i)}return t}return s}const ed=Symbol("fallback");function el(s){for(let t=0;t<s.length;t++)s[t]()}function td(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return Zn(()=>el(r)),()=>{let l=s()||[],c=l.length,u,d;return l[Zu],qt(()=>{let m,y,_,T,x,V,L,W,J;if(c===0)o!==0&&(el(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[ed],n[0]=zr(ee=>(r[0]=ee,e.fallback())),o=1);else if(o===0){for(n=new Array(c),d=0;d<c;d++)i[d]=l[d],n[d]=zr(p);o=c}else{for(_=new Array(c),T=new Array(c),a&&(x=new Array(c)),V=0,L=Math.min(o,c);V<L&&i[V]===l[V];V++);for(L=o-1,W=c-1;L>=V&&W>=V&&i[L]===l[W];L--,W--)_[W]=n[L],T[W]=r[L],a&&(x[W]=a[L]);for(m=new Map,y=new Array(W+1),d=W;d>=V;d--)J=l[d],u=m.get(J),y[d]=u===void 0?-1:u,m.set(J,d);for(u=V;u<=L;u++)J=i[u],d=m.get(J),d!==void 0&&d!==-1?(_[d]=n[u],T[d]=r[u],a&&(x[d]=a[u]),d=y[d],m.set(J,d)):r[u]();for(d=V;d<c;d++)d in _?(n[d]=_[d],r[d]=T[d],a&&(a[d]=x[d],a[d](d))):n[d]=zr(p);n=n.slice(0,o=c),i=l.slice(0)}return n});function p(m){if(r[d]=m,a){const[y,_]=re(d);return a[d]=_,t(l[d],y)}return t(l[d])}}}function me(s,t){return qt(()=>s(t||{}))}const Vc=s=>`Stale read from <${s}>.`;function to(s){const t="fallback"in s&&{fallback:()=>s.fallback};return Vt(td(()=>s.each,s.children,t||void 0))}function ke(s){const t=s.keyed,e=Vt(()=>s.when,void 0,void 0),i=t?e:Vt(e,void 0,{equals:(n,r)=>!n==!r});return Vt(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?qt(()=>r(t?n:()=>{if(!qt(i))throw Vc("Show");return e()})):r}return s.fallback},void 0,void 0)}function id(s){const t=Yu(()=>s.children),e=Vt(()=>{const i=t(),n=Array.isArray(i)?i:[i];let r=()=>{};for(let o=0;o<n.length;o++){const a=o,l=n[o],c=r,u=Vt(()=>c()?void 0:l.when,void 0,void 0),d=l.keyed?u:Vt(u,void 0,{equals:(p,m)=>!p==!m});r=()=>c()||(d()?[a,u,l]:void 0)}return r});return Vt(()=>{const i=e()();if(!i)return s.fallback;const[n,r,o]=i,a=o.children;return typeof a=="function"&&a.length>0?qt(()=>a(o.keyed?r():()=>{var c;if(((c=qt(e)())==null?void 0:c[0])!==n)throw Vc("Match");return r()})):a},void 0,void 0)}function Fn(s){return s}const Dt=s=>Vt(()=>s());function nd(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,l=t[n-1].nextSibling,c=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const u=r<i?a?e[a-1].nextSibling:e[r-a]:l;for(;a<r;)s.insertBefore(e[a++],u)}else if(r===a)for(;o<n;)(!c||!c.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const u=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],u),t[n]=e[r]}else{if(!c){c=new Map;let d=a;for(;d<r;)c.set(e[d],d++)}const u=c.get(t[o]);if(u!=null)if(a<u&&u<r){let d=o,p=1,m;for(;++d<n&&d<r&&!((m=c.get(t[d]))==null||m!==u+p);)p++;if(p>u-a){const y=t[o];for(;a<u;)s.insertBefore(e[a++],y)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const tl="_$DX_DELEGATE";function rd(s,t,e,i={}){let n;return zr(r=>{n=r,t===document?s():Z(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function O(s,t,e,i){let n;const r=()=>{const a=document.createElement("template");return a.innerHTML=s,a.content.firstChild},o=()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function ii(s,t=window.document){const e=t[tl]||(t[tl]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,od))}}function Bt(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function it(s,t){t==null?s.removeAttribute("class"):s.className=t}function sd(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function zn(s,t,e){if(!t)return e?Bt(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function Lc(s,t,e){return qt(()=>s(t,e))}function Z(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return Jr(s,t,i,e);Le(n=>Jr(s,t(),n,e),i)}function od(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=l=>Object.defineProperty(s,"target",{configurable:!0,value:l}),o=()=>{const l=t[e];if(l&&!t.disabled){const c=t[`${e}Data`];if(c!==void 0?l.call(t,c,s):l.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const l=s.composedPath();r(l[0]);for(let c=0;c<l.length-2&&(t=l[c],!!o());c++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function Jr(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=Qi(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=Qi(s,e,i);else{if(r==="function")return Le(()=>{let a=t();for(;typeof a=="function";)a=a();e=Jr(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],l=e&&Array.isArray(e);if(io(a,t,e,n))return Le(()=>e=Jr(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=Qi(s,e,i),o)return e}else l?e.length===0?il(s,a,i):nd(s,e,a):(e&&Qi(s),il(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=Qi(s,e,i,t);Qi(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function io(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],l=e&&e[s.length],c;if(!(a==null||a===!0||a===!1))if((c=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=io(s,a,l)||n;else if(c==="function")if(i){for(;typeof a=="function";)a=a();n=io(s,Array.isArray(a)?a:[a],Array.isArray(l)?l:[l])||n}else s.push(a),n=!0;else{const u=String(a);l&&l.nodeType===3&&l.data===u?s.push(l):s.push(document.createTextNode(u))}}return n}function il(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function Qi(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const l=a.parentNode===s;!r&&!o?l?s.replaceChild(n,a):s.insertBefore(n,e):l&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}const ad="modulepreload",ld=function(s){return"/"+s},nl={},Br=function(t,e,i){let n=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(e.map(l=>{if(l=ld(l),l in nl)return;nl[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":ad,c||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),c)return new Promise((p,m)=>{d.addEventListener("load",p),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return n.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},cd=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream,i=/android/i.test(s),n=/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;if(n||t||e||i)return console.log("Mobile/Safari/iOS/Android detected - FORCING canvas drawer (Research: WebGL regression in 5.0.0+)"),"canvas";if(t&&!n)return console.log("Desktop Safari detected - using canvas drawer (WebKit compatibility)"),"canvas";const r=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),o=/firefox|fxios/i.test(s);return r||o?(console.log("Desktop Chrome/Firefox detected - using canvas drawer (Research: Better tile performance)"),"canvas"):(console.log("Unknown browser detected - defaulting to canvas drawer"),"canvas")},Ge=()=>{var a;const s=navigator.userAgent.toLowerCase(),t=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;if(localStorage.getItem("forceDesktopMode")==="true")return console.log("[Mobile Detection] Desktop mode forced via localStorage"),!1;if(localStorage.getItem("forceMobileMode")==="true")return console.log("[Mobile Detection] Mobile mode forced via localStorage"),!0;if(window.navigator.userAgent.includes("Chrome")&&window.navigator.userAgent.includes("Mobile")&&window.innerWidth>1024)return console.log("[Mobile Detection] Chrome DevTools mobile emulation detected - treating as DESKTOP"),!1;if(t.test(s)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1)return!0;const i="ontouchstart"in window||navigator.maxTouchPoints>0,n=window.innerWidth<=768,r=window.innerWidth<=1024;return i&&n?!0:i&&r&&navigator.maxTouchPoints>1?window.innerHeight>1200?(console.log("[Mobile Detection] Large screen detected, treating as desktop despite touch"),!1):!0:/mobi|tablet/i.test(s)||((a=navigator.userAgentData)==null?void 0:a.mobile)||!1};typeof window<"u"&&(window.forceDesktopMode=()=>{localStorage.setItem("forceDesktopMode","true"),localStorage.removeItem("overlayType"),console.log("Desktop mode forced - reload page to apply"),console.log("Use window.clearDeviceMode() to reset")},window.forceMobileMode=()=>{localStorage.removeItem("forceDesktopMode"),localStorage.setItem("forceMobileMode","true"),console.log("Mobile mode forced - reload page to apply"),console.log("Use window.clearDeviceMode() to reset")},window.clearDeviceMode=()=>{localStorage.removeItem("forceDesktopMode"),localStorage.removeItem("forceMobileMode"),localStorage.removeItem("overlayType"),console.log("Device detection reset to automatic - reload page to apply")},window.checkDeviceDetection=()=>{console.log("Current detection:",{isMobile:Ge(),userAgent:navigator.userAgent,screenSize:`${window.innerWidth}x${window.innerHeight}`,touchPoints:navigator.maxTouchPoints,platform:navigator.platform,forcedMode:localStorage.getItem("forceDesktopMode")||localStorage.getItem("forceMobileMode")||"auto"})},console.log("Device detection commands available:"),console.log("- window.forceDesktopMode()"),console.log("- window.forceMobileMode()"),console.log("- window.clearDeviceMode()"),console.log("- window.checkDeviceDetection()"));const Nc=()=>{const s=navigator.userAgent;return/iPhone/.test(s)&&!/iPad/.test(s)},hd=Object.freeze(Object.defineProperty({__proto__:null,getBrowserOptimalDrawer:cd,isIPhone:Nc,isMobile:Ge},Symbol.toStringTag,{value:"Module"}));var ud=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function dd(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var zc={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var l in o)a=l;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,l=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/l}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var l,c,u,d,p,m,y=arguments[0]||{},_=arguments.length,T=!1,x=1;for(typeof y=="boolean"&&(T=y,y=arguments[1]||{},x=2),typeof y!="object"&&!t.isFunction(y)&&(y={}),_===x&&(y=this,--x);x<_;x++)if(l=arguments[x],l!==null||l!==void 0)for(c in l){var V=Object.getOwnPropertyDescriptor(l,c);if(V!==void 0){if(V.get||V.set){Object.defineProperty(y,c,V);continue}d=V.value}else{e.console.warn('Could not copy inherited property "'+c+'".');continue}y!==d&&(T&&d&&(t.isPlainObject(d)||(p=t.isArray(d)))?(u=y[c],p?(p=!1,m=u&&t.isArray(u)?u:[]):m=u&&t.isPlainObject(u)?u:{},y[c]=t.extend(T,m,d)):d!==void 0&&(y[c]=d))}return y};var i=function(){if(typeof navigator!="object")return!1;var l=navigator.userAgent;return typeof l!="string"?!1:l.indexOf("iPhone")!==-1||l.indexOf("iPad")!==-1||l.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(l,c){return function(){var u=arguments;return u===void 0&&(u=[]),c.apply(l,u)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(l){return e._viewers.get(this.getElement(l))},getElement:function(l){return typeof l=="string"&&(l=document.getElementById(l)),l},getElementPosition:function(l){var c=new e.Point,u,d;for(l=e.getElement(l),u=e.getElementStyle(l).position==="fixed",d=a(l,u);d;)c.x+=l.offsetLeft,c.y+=l.offsetTop,u&&(c=c.plus(e.getPageScroll())),l=d,u=e.getElementStyle(l).position==="fixed",d=a(l,u);return c},getElementOffset:function(l){l=e.getElement(l);var c=l&&l.ownerDocument,u,d,p={top:0,left:0};return c?(u=c.documentElement,typeof l.getBoundingClientRect<"u"&&(p=l.getBoundingClientRect()),d=c===c.window?c:c.nodeType===9?c.defaultView||c.parentWindow:!1,new e.Point(p.left+(d.pageXOffset||u.scrollLeft)-(u.clientLeft||0),p.top+(d.pageYOffset||u.scrollTop)-(u.clientTop||0))):new e.Point},getElementSize:function(l){return l=e.getElement(l),new e.Point(l.clientWidth,l.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(l){return l=e.getElement(l),l.currentStyle}:function(l){return l=e.getElement(l),window.getComputedStyle(l,"")},getCssPropertyWithVendorPrefix:function(l){var c={};return e.getCssPropertyWithVendorPrefix=function(u){if(c[u]!==void 0)return c[u];var d=document.createElement("div").style,p=null;if(d[u]!==void 0)p=u;else for(var m=["Webkit","Moz","MS","O","webkit","moz","ms","o"],y=e.capitalizeFirstLetter(u),_=0;_<m.length;_++){var T=m[_]+y;if(d[T]!==void 0){p=T;break}}return c[u]=p,p},e.getCssPropertyWithVendorPrefix(l)},capitalizeFirstLetter:function(l){return l.charAt(0).toUpperCase()+l.slice(1)},positiveModulo:function(l,c){var u=l%c;return u<0&&(u+=c),u},pointInElement:function(l,c){l=e.getElement(l);var u=e.getElementOffset(l),d=e.getElementSize(l);return c.x>=u.x&&c.x<u.x+d.x&&c.y<u.y+d.y&&c.y>=u.y},getMousePosition:function(l){if(typeof l.pageX=="number")e.getMousePosition=function(c){var u=new e.Point;return u.x=c.pageX,u.y=c.pageY,u};else if(typeof l.clientX=="number")e.getMousePosition=function(c){var u=new e.Point;return u.x=c.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,u.y=c.clientY+document.body.scrollTop+document.documentElement.scrollTop,u};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(l)},getPageScroll:function(){var l=document.documentElement||{},c=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(c.scrollLeft||c.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(l.scrollLeft||l.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(l){if(typeof window.scrollTo<"u")e.setPageScroll=function(d){window.scrollTo(d.x,d.y)};else{var c=e.getPageScroll();if(c.x===l.x&&c.y===l.y)return;document.body.scrollLeft=l.x,document.body.scrollTop=l.y;var u=e.getPageScroll();if(u.x!==c.x&&u.y!==c.y){e.setPageScroll=function(d){document.body.scrollLeft=d.x,document.body.scrollTop=d.y};return}if(document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y,u=e.getPageScroll(),u.x!==c.x&&u.y!==c.y){e.setPageScroll=function(d){document.documentElement.scrollLeft=d.x,document.documentElement.scrollTop=d.y};return}e.setPageScroll=function(d){}}e.setPageScroll(l)},getWindowSize:function(){var l=document.documentElement||{},c=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(l.clientWidth||l.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(c.clientWidth||c.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(l){l=e.getElement(l);var c=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(c[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(c[1].style,{display:"table-row"}),e.extend(c[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),c[0].appendChild(c[1]),c[1].appendChild(c[2]),c[2].appendChild(l),c[0]},makeNeutralElement:function(l){var c=document.createElement(l),u=c.style;return u.background="transparent none",u.border="none",u.margin="0px",u.padding="0px",u.position="static",c},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(l){var c=e.makeNeutralElement("img");return c.src=l,c},setElementOpacity:function(l,c,u){var d,p;l=e.getElement(l),u&&!e.Browser.alpha&&(c=Math.round(c)),e.Browser.opacity?l.style.opacity=c<1?c:"":c<1?(d=Math.round(100*c),p="alpha(opacity="+d+")",l.style.filter=p):l.style.filter=""},setElementTouchActionNone:function(l){l=e.getElement(l),typeof l.style.touchAction<"u"?l.style.touchAction="none":typeof l.style.msTouchAction<"u"&&(l.style.msTouchAction="none")},setElementPointerEvents:function(l,c){l=e.getElement(l),typeof l.style<"u"&&typeof l.style.pointerEvents<"u"&&(l.style.pointerEvents=c)},setElementPointerEventsNone:function(l){e.setElementPointerEvents(l,"none")},addClass:function(l,c){l=e.getElement(l),l.className?(" "+l.className+" ").indexOf(" "+c+" ")===-1&&(l.className+=" "+c):l.className=c},indexOf:function(l,c,u){return Array.prototype.indexOf?this.indexOf=function(d,p,m){return d.indexOf(p,m)}:this.indexOf=function(d,p,m){var y,_=m||0,T;if(!d)throw new TypeError;if(T=d.length,T===0||_>=T)return-1;for(_<0&&(_=T-Math.abs(_)),y=_;y<T;y++)if(d[y]===p)return y;return-1},this.indexOf(l,c,u)},removeClass:function(l,c){var u,d=[],p;for(l=e.getElement(l),u=l.className.split(/\s+/),p=0;p<u.length;p++)u[p]&&u[p]!==c&&d.push(u[p]);l.className=d.join(" ")},normalizeEventListenerOptions:function(l){var c;return typeof l<"u"?typeof l=="boolean"?c=e.supportsEventListenerOptions?{capture:l}:l:c=e.supportsEventListenerOptions?l:typeof l.capture<"u"?l.capture:!1:c=e.supportsEventListenerOptions?{capture:!1}:!1,c},addEvent:function(){if(e.supportsAddEventListener)return function(l,c,u,d){d=e.normalizeEventListenerOptions(d),l=e.getElement(l),l.addEventListener(c,u,d)};if(document.documentElement.attachEvent&&document.attachEvent)return function(l,c,u){l=e.getElement(l),l.attachEvent("on"+c,u)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(l,c,u,d){d=e.normalizeEventListenerOptions(d),l=e.getElement(l),l.removeEventListener(c,u,d)};if(document.documentElement.detachEvent&&document.detachEvent)return function(l,c,u){l=e.getElement(l),l.detachEvent("on"+c,u)};throw new Error("No known event model.")}(),cancelEvent:function(l){l.preventDefault()},eventIsCanceled:function(l){return l.defaultPrevented},stopEvent:function(l){l.stopPropagation()},createCallback:function(l,c){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var u=[],d;for(d=2;d<arguments.length;d++)u.push(arguments[d]);return function(){var p=u.concat([]),m;for(m=0;m<arguments.length;m++)p.push(arguments[m]);return c.apply(l,p)}},getUrlParameter:function(l){var c=o[l];return c||null},getUrlProtocol:function(l){var c=l.match(/^([a-z]+:)\/\//i);return c===null?window.location.protocol:c[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(l,c,u){var d,p,m,y;e.isPlainObject(l)&&(c=l.success,u=l.error,d=l.withCredentials,p=l.headers,m=l.responseType||null,y=l.postData||null,l=l.url);var _=e.getUrlProtocol(l),T=e.createAjaxRequest();if(!e.isFunction(c))throw new Error("makeAjaxRequest requires a success callback");T.onreadystatechange=function(){T.readyState===4&&(T.onreadystatechange=function(){},T.status>=200&&T.status<300||T.status===0&&_!=="http:"&&_!=="https:"?c(T):e.isFunction(u)?u(T):e.console.error("AJAX request returned %d: %s",T.status,l))};var x=y?"POST":"GET";try{if(T.open(x,l,!0),m&&(T.responseType=m),p)for(var V in p)Object.prototype.hasOwnProperty.call(p,V)&&p[V]&&T.setRequestHeader(V,p[V]);d&&(T.withCredentials=!0),T.send(y)}catch(L){e.console.error("%s while making AJAX request: %s",L.name,L.message),T.onreadystatechange=function(){},e.isFunction(u)&&u(T,L)}return T},jsonp:function(l){var c,u=l.url,d=document.head||document.getElementsByTagName("head")[0]||document.documentElement,p=l.callbackName||"openseadragon"+e.now(),m=window[p],y="$1"+p+"$2",_=l.param||"callback",T=l.callback;u=u.replace(/(=)\?(&|$)|\?\?/i,y),u+=(/\?/.test(u)?"&":"?")+_+"="+p,window[p]=function(x){if(m)window[p]=m;else try{delete window[p]}catch{}T&&e.isFunction(T)&&T(x)},c=document.createElement("script"),(l.async!==void 0||l.async!==!1)&&(c.async="async"),l.scriptCharset&&(c.charset=l.scriptCharset),c.src=u,c.onload=c.onreadystatechange=function(x,V){(V||!c.readyState||/loaded|complete/.test(c.readyState))&&(c.onload=c.onreadystatechange=null,d&&c.parentNode&&d.removeChild(c),c=void 0)},d.insertBefore(c,d.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(l){if(window.DOMParser)e.parseXml=function(c){var u=null,d;return d=new DOMParser,u=d.parseFromString(c,"text/xml"),u};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(l)},parseJSON:function(l){return e.parseJSON=window.JSON.parse,e.parseJSON(l)},imageFormatSupported:function(l){return l=l||"",!!r[l.toLowerCase()]},setImageFormatsSupported:function(l){e.extend(r,l)}});var n=function(l){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var l=navigator.appVersion,c=navigator.userAgent,u;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(c.substring(c.indexOf("MSIE")+5,c.indexOf(";",c.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(c.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(c.substring(c.indexOf("Edge")+5))):c.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(c.substring(c.indexOf("Edg")+4))):c.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(c.substring(c.indexOf("Firefox")+8))):c.indexOf("Safari")>=0?(e.Browser.vendor=c.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(c.substring(c.substring(0,c.indexOf("Safari")).lastIndexOf("/")+1,c.indexOf("Safari")))):(u=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),u.exec(c)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(l);break}var d=window.location.search.substring(1),p=d.split("&"),m,y,_;for(_=0;_<p.length;_++)if(m=p[_],y=m.indexOf("="),y>0){var T=m.substring(0,y),x=m.substring(y+1);try{o[T]=decodeURIComponent(x)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",T,x)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(l){var c=l.requestAnimationFrame||l.mozRequestAnimationFrame||l.webkitRequestAnimationFrame||l.msRequestAnimationFrame,u=l.cancelAnimationFrame||l.mozCancelAnimationFrame||l.webkitCancelAnimationFrame||l.msCancelAnimationFrame;if(c&&u)e.requestAnimationFrame=function(){return c.apply(l,arguments)},e.cancelAnimationFrame=function(){return u.apply(l,arguments)};else{var d=[],p=[],m=0,y;e.requestAnimationFrame=function(_){return d.push([++m,_]),y||(y=setInterval(function(){if(d.length){var T=e.now(),x=p;for(p=d,d=x;p.length;)p.shift()[1](T)}else clearInterval(y),y=void 0},1e3/50)),m},e.cancelAnimationFrame=function(_){var T,x;for(T=0,x=d.length;T<x;T+=1)if(d[T][0]===_){d.splice(T,1);return}for(T=0,x=p.length;T<x;T+=1)if(p[T][0]===_){p.splice(T,1);return}}}}(window);function a(l,c){return c&&l!==document.body?document.body:l.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(ud,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var l=o[0*3+0],c=o[0*3+1],u=o[0*3+2],d=o[1*3+0],p=o[1*3+1],m=o[1*3+2],y=o[2*3+0],_=o[2*3+1],T=o[2*3+2],x=a[0*3+0],V=a[0*3+1],L=a[0*3+2],W=a[1*3+0],J=a[1*3+1],ee=a[1*3+2],F=a[2*3+0],E=a[2*3+1],P=a[2*3+2];return new i([x*l+V*d+L*y,x*c+V*p+L*_,x*u+V*m+L*T,W*l+J*d+ee*y,W*c+J*p+ee*_,W*u+J*m+ee*T,F*l+E*d+P*y,F*c+E*p+P*_,F*u+E*m+P*T])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var l=this;o=o||1;var c=0,u=function(d){return c++,c===o&&l.removeHandler(i,u),n(d)};return this.addHandler(i,u,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var l=a.length,c={handler:n,userData:r||null,priority:o||0};for(a[l]=c;l>0&&a[l-1].priority<a[l].priority;)a[l]=a[l-1],a[l-1]=c,l--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,l=n.length;for(a=0;a<l;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(b){var w=arguments;e.isPlainObject(b)||(b={element:w[0],clickTimeThreshold:w[1],clickDistThreshold:w[2]}),this.hash=Math.random(),this.element=e.getElement(b.element),this.clickTimeThreshold=b.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=b.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=b.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=b.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=b.userData||null,this.stopDelay=b.stopDelay||50,this.preProcessEventHandler=b.preProcessEventHandler||null,this.contextMenuHandler=b.contextMenuHandler||null,this.enterHandler=b.enterHandler||null,this.leaveHandler=b.leaveHandler||null,this.exitHandler=b.exitHandler||null,this.overHandler=b.overHandler||null,this.outHandler=b.outHandler||null,this.pressHandler=b.pressHandler||null,this.nonPrimaryPressHandler=b.nonPrimaryPressHandler||null,this.releaseHandler=b.releaseHandler||null,this.nonPrimaryReleaseHandler=b.nonPrimaryReleaseHandler||null,this.moveHandler=b.moveHandler||null,this.scrollHandler=b.scrollHandler||null,this.clickHandler=b.clickHandler||null,this.dblClickHandler=b.dblClickHandler||null,this.dragHandler=b.dragHandler||null,this.dragEndHandler=b.dragEndHandler||null,this.pinchHandler=b.pinchHandler||null,this.stopHandler=b.stopHandler||null,this.keyDownHandler=b.keyDownHandler||null,this.keyUpHandler=b.keyUpHandler||null,this.keyHandler=b.keyHandler||null,this.focusHandler=b.focusHandler||null,this.blurHandler=b.blurHandler||null;var C=this;i[this.hash]={click:function(A){L(C,A)},dblclick:function(A){W(C,A)},keydown:function(A){J(C,A)},keyup:function(A){ee(C,A)},keypress:function(A){F(C,A)},focus:function(A){E(C,A)},blur:function(A){P(C,A)},contextmenu:function(A){M(C,A)},wheel:function(A){k(C,A)},mousewheel:function(A){D(C,A)},DOMMouseScroll:function(A){D(C,A)},MozMousePixelScroll:function(A){D(C,A)},losecapture:function(A){Ce(C,A)},mouseenter:function(A){Y(C,A)},mouseleave:function(A){oe(C,A)},mouseover:function(A){le(C,A)},mouseout:function(A){_e(C,A)},mousedown:function(A){ge(C,A)},mouseup:function(A){Oe(C,A)},mousemove:function(A){Te(C,A)},touchstart:function(A){q(C,A)},touchend:function(A){ne(C,A)},touchmove:function(A){te(C,A)},touchcancel:function(A){$(C,A)},gesturestart:function(A){H(C,A)},gesturechange:function(A){se(C,A)},gotpointercapture:function(A){ce(C,A)},lostpointercapture:function(A){ue(C,A)},pointerenter:function(A){Y(C,A)},pointerleave:function(A){oe(C,A)},pointerover:function(A){le(C,A)},pointerout:function(A){_e(C,A)},pointerdown:function(A){ge(C,A)},pointerup:function(A){Oe(C,A)},pointermove:function(A){Te(C,A)},pointercancel:function(A){pe(C,A)},pointerupcaptured:function(A){qe(C,A)},pointermovecaptured:function(A){Se(C,A)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),b.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){l(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(b){return b?a(this):l(this),this},getActivePointersListByType:function(b){var w=i[this.hash],C,A=w?w.activePointersLists.length:0,U;for(C=0;C<A;C++)if(w.activePointersLists[C].type===b)return w.activePointersLists[C];return U=new e.MouseTracker.GesturePointList(b),w&&w.activePointersLists.push(U),U},getActivePointerCount:function(){var b=i[this.hash],w,C=b.activePointersLists.length,A=0;for(w=0;w<C;w++)A+=b.activePointersLists[w].getLength();return A},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(b){try{return b.addEventListener&&b.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var b=[],w=0,C=0,A=function(je,Re){return je.hash.toString()+Re.type+Re.id.toString()},U=function(){var je,Re=b.length,ct,$e,Mt=e.now(),kt,ni,Xt;for(kt=Mt-C,C=Mt,je=0;je<Re;je++)ct=b[je],$e=ct.gPoint,$e.direction=Math.atan2($e.currentPos.y-ct.lastPos.y,$e.currentPos.x-ct.lastPos.x),ni=ct.lastPos.distanceTo($e.currentPos),ct.lastPos=$e.currentPos,Xt=1e3*ni/(kt+1),$e.speed=.75*Xt+.25*$e.speed},ie=function(je,Re){var ct=A(je,Re);b.push({guid:ct,gPoint:Re,lastPos:Re.currentPos}),b.length===1&&(C=e.now(),w=window.setInterval(U,50))},Ee=function(je,Re){var ct=A(je,Re),$e,Mt=b.length;for($e=0;$e<Mt;$e++)if(b[$e].guid===ct){b.splice($e,1),Mt--,Mt===0&&window.clearInterval(w);break}};return{addPoint:ie,removePoint:Ee}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var b=document.createElement("div");return e.isFunction(b.setPointerCapture)&&e.isFunction(b.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var b=document.createElement("div");return e.isFunction(b.setCapture)&&e.isFunction(b.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(b){this._gPoints=[],this.type=b,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(b){return this._gPoints.push(b)},removeById:function(b){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].id===b){this._gPoints.splice(w,1);break}return this._gPoints.length},getByIndex:function(b){return b<this._gPoints.length?this._gPoints[b]:null},getById:function(b){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].id===b)return this._gPoints[w];return null},getPrimary:function(b){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].isPrimary)return this._gPoints[w];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(b){var w=i[b.hash],C,A,U,ie,Ee,je=w.activePointersLists.length;for(C=0;C<je;C++)if(U=w.activePointersLists[C],U.getLength()>0){for(Ee=[],ie=U.asArray(),A=0;A<ie.length;A++)Ee.push(ie[A]);for(A=0;A<Ee.length;A++)Xe(b,U,Ee[A])}for(C=0;C<je;C++)w.activePointersLists.pop();w.sentDragEvent=!1}function a(b){var w=i[b.hash],C,A;if(!w.tracking){for(A=0;A<e.MouseTracker.subscribeEvents.length;A++)C=e.MouseTracker.subscribeEvents[A],e.addEvent(b.element,C,w[C],C===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(b),w.tracking=!0}}function l(b){var w=i[b.hash],C,A;if(w.tracking){for(A=0;A<e.MouseTracker.subscribeEvents.length;A++)C=e.MouseTracker.subscribeEvents[A],e.removeEvent(b.element,C,w[C],!1);o(b),w.tracking=!1}}function c(b,w){var C=i[b.hash];if(w==="pointerevent")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(w==="mouse")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(w==="touch")return{upName:"touchend",upHandler:C.touchendcaptured,moveName:"touchmove",moveHandler:C.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function u(b,w){var C;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{b.element.setPointerCapture(w.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else b.element.setCapture(!0);else C=c(b,e.MouseTracker.havePointerEvents?"pointerevent":w.type),n&&r(window.top)&&e.addEvent(window.top,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0);N(b,w,!0)}function d(b,w){var C,A,U;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(A=b.getActivePointersListByType(w.type),U=A.getById(w.id),!U||!U.captured)return;try{b.element.releasePointerCapture(w.id)}catch{}}else b.element.releaseCapture();else C=c(b,e.MouseTracker.havePointerEvents?"pointerevent":w.type),n&&r(window.top)&&e.removeEvent(window.top,C.upName,C.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0);N(b,w,!1)}function p(b){return e.MouseTracker.havePointerEvents?b.pointerId:e.MouseTracker.mousePointerId}function m(b){return e.MouseTracker.havePointerEvents&&b.pointerType?b.pointerType:"mouse"}function y(b){return e.MouseTracker.havePointerEvents?b.isPrimary:!0}function _(b){return e.getMousePosition(b)}function T(b,w){return x(_(b),w)}function x(b,w){var C=e.getElementOffset(w);return b.minus(C)}function V(b,w){return new e.Point((b.x+w.x)/2,(b.y+w.y)/2)}function L(b,w){var C={originalEvent:w,eventType:"click",pointerType:"mouse",isEmulated:!1};S(b,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(w),C.stopPropagation&&e.stopEvent(w)}function W(b,w){var C={originalEvent:w,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};S(b,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(w),C.stopPropagation&&e.stopEvent(w)}function J(b,w){var C=null,A={originalEvent:w,eventType:"keydown",pointerType:"",isEmulated:!1};S(b,A),b.keyDownHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:b,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:A.preventDefault||A.defaultPrevented,userData:b.userData},b.keyDownHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function ee(b,w){var C=null,A={originalEvent:w,eventType:"keyup",pointerType:"",isEmulated:!1};S(b,A),b.keyUpHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:b,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:A.preventDefault||A.defaultPrevented,userData:b.userData},b.keyUpHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function F(b,w){var C=null,A={originalEvent:w,eventType:"keypress",pointerType:"",isEmulated:!1};S(b,A),b.keyHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:b,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:A.preventDefault||A.defaultPrevented,userData:b.userData},b.keyHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function E(b,w){var C={originalEvent:w,eventType:"focus",pointerType:"",isEmulated:!1};S(b,C),b.focusHandler&&!C.preventGesture&&b.focusHandler({eventSource:b,originalEvent:w,userData:b.userData})}function P(b,w){var C={originalEvent:w,eventType:"blur",pointerType:"",isEmulated:!1};S(b,C),b.blurHandler&&!C.preventGesture&&b.blurHandler({eventSource:b,originalEvent:w,userData:b.userData})}function M(b,w){var C=null,A={originalEvent:w,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};S(b,A),b.contextMenuHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:b,position:x(_(w),b.element),originalEvent:A.originalEvent,preventDefault:A.preventDefault||A.defaultPrevented,userData:b.userData},b.contextMenuHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function k(b,w){I(b,w,w)}function D(b,w){var C={target:w.target||w.srcElement,type:"wheel",shiftKey:w.shiftKey||!1,clientX:w.clientX,clientY:w.clientY,pageX:w.pageX?w.pageX:w.clientX,pageY:w.pageY?w.pageY:w.clientY,deltaMode:w.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?C.deltaY=-w.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:C.deltaY=w.detail,I(b,C,w)}function I(b,w,C){var A=0,U,ie=null;A=w.deltaY?w.deltaY<0?1:-1:0,U={originalEvent:w,eventType:"wheel",pointerType:"mouse",isEmulated:w!==C},S(b,U),b.scrollHandler&&!U.preventGesture&&!U.defaultPrevented&&(ie={eventSource:b,pointerType:"mouse",position:T(w,b.element),scroll:A,shift:w.shiftKey,isTouchEvent:!1,originalEvent:C,preventDefault:U.preventDefault||U.defaultPrevented,userData:b.userData},b.scrollHandler(ie)),U.stopPropagation&&e.stopEvent(C),(ie&&ie.preventDefault||U.preventDefault&&!U.defaultPrevented)&&e.cancelEvent(C)}function Ce(b,w){var C={id:e.MouseTracker.mousePointerId,type:"mouse"},A={originalEvent:w,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};S(b,A),w.target===b.element&&N(b,C,!1),A.stopPropagation&&e.stopEvent(w)}function q(b,w){var C,A,U=w.changedTouches.length,ie,Ee=b.getActivePointersListByType("touch");C=e.now(),Ee.getLength()>w.touches.length-U&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var je={originalEvent:w,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(S(b,je),A=0;A<U;A++)ie={id:w.changedTouches[A].identifier,type:"touch",isPrimary:Ee.getLength()===0,currentPos:_(w.changedTouches[A]),currentTime:C},X(b,je,ie),de(b,je,ie,0),N(b,ie,!0);je.preventDefault&&!je.defaultPrevented&&e.cancelEvent(w),je.stopPropagation&&e.stopEvent(w)}function ne(b,w){var C,A,U=w.changedTouches.length,ie;C=e.now();var Ee={originalEvent:w,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(S(b,Ee),A=0;A<U;A++)ie={id:w.changedTouches[A].identifier,type:"touch",currentPos:_(w.changedTouches[A]),currentTime:C},xe(b,Ee,ie,0),N(b,ie,!1),B(b,Ee,ie);Ee.preventDefault&&!Ee.defaultPrevented&&e.cancelEvent(w),Ee.stopPropagation&&e.stopEvent(w)}function te(b,w){var C,A,U=w.changedTouches.length,ie;C=e.now();var Ee={originalEvent:w,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(S(b,Ee),A=0;A<U;A++)ie={id:w.changedTouches[A].identifier,type:"touch",currentPos:_(w.changedTouches[A]),currentTime:C},we(b,Ee,ie);Ee.preventDefault&&!Ee.defaultPrevented&&e.cancelEvent(w),Ee.stopPropagation&&e.stopEvent(w)}function $(b,w){var C=w.changedTouches.length,A,U,ie={originalEvent:w,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(S(b,ie),A=0;A<C;A++)U={id:w.changedTouches[A].identifier,type:"touch"},fe(b,ie,U);ie.stopPropagation&&e.stopEvent(w)}function H(b,w){return e.eventIsCanceled(w)||w.preventDefault(),!1}function se(b,w){return e.eventIsCanceled(w)||w.preventDefault(),!1}function ce(b,w){var C={originalEvent:w,eventType:"gotpointercapture",pointerType:m(w),isEmulated:!1};S(b,C),w.target===b.element&&N(b,{id:w.pointerId,type:m(w)},!0),C.stopPropagation&&e.stopEvent(w)}function ue(b,w){var C={originalEvent:w,eventType:"lostpointercapture",pointerType:m(w),isEmulated:!1};S(b,C),w.target===b.element&&N(b,{id:w.pointerId,type:m(w)},!1),C.stopPropagation&&e.stopEvent(w)}function Y(b,w){var C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerenter",pointerType:C.type,isEmulated:!1};S(b,A),X(b,A,C)}function oe(b,w){var C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerleave",pointerType:C.type,isEmulated:!1};S(b,A),B(b,A,C)}function le(b,w){var C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerover",pointerType:C.type,isEmulated:!1};S(b,A),ae(b,A,C),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function _e(b,w){var C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerout",pointerType:C.type,isEmulated:!1};S(b,A),G(b,A,C),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function ge(b,w){var C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()},A=e.MouseTracker.havePointerEvents&&C.type==="touch",U={originalEvent:w,eventType:"pointerdown",pointerType:C.type,isEmulated:!1};S(b,U),de(b,U,C,w.button),U.preventDefault&&!U.defaultPrevented&&e.cancelEvent(w),U.stopPropagation&&e.stopEvent(w),U.shouldCapture&&(A?N(b,C,!0):u(b,C))}function Oe(b,w){De(b,w)}function qe(b,w){var C=b.getActivePointersListByType(m(w));C.getById(w.pointerId)&&De(b,w),e.stopEvent(w)}function De(b,w){var C;C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()};var A={originalEvent:w,eventType:"pointerup",pointerType:C.type,isEmulated:!1};S(b,A),xe(b,A,C,w.button),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w),A.shouldReleaseCapture&&(w.target===b.element?d(b,C):N(b,C,!1))}function Te(b,w){Ae(b,w)}function Se(b,w){var C=b.getActivePointersListByType(m(w));C.getById(w.pointerId)&&Ae(b,w),e.stopEvent(w)}function Ae(b,w){var C={id:p(w),type:m(w),isPrimary:y(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointermove",pointerType:C.type,isEmulated:!1};S(b,A),we(b,A,C),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function pe(b,w){var C={id:w.pointerId,type:m(w)},A={originalEvent:w,eventType:"pointercancel",pointerType:C.type,isEmulated:!1};S(b,A),fe(b,A,C),A.stopPropagation&&e.stopEvent(w)}function be(b,w){return w.speed=0,w.direction=0,w.contactPos=w.currentPos,w.contactTime=w.currentTime,w.lastPos=w.currentPos,w.lastTime=w.currentTime,b.add(w)}function Xe(b,w,C){var A,U=w.getById(C.id);return U?(U.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),d(b,U)),w.removeContact(),A=w.removeById(C.id)):A=w.getLength(),A}function g(b,w){switch(w.eventType){case"pointermove":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!b.hasGestureHandlers,w.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break;case"pointerdown":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!b.hasGestureHandlers,w.stopPropagation=!1;break;case"pointerup":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!b.hasGestureHandlers,w.stopPropagation=!1;break;case"wheel":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!b.hasScrollHandler,w.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":w.isStoppable=!0,w.isCancelable=!1,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break;case"click":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!!b.clickHandler,w.preventGesture=!1,w.stopPropagation=!1;break;case"dblclick":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!!b.dblClickHandler,w.preventGesture=!1,w.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:w.isStoppable=!1,w.isCancelable=!1,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break}}function S(b,w){w.eventSource=b,w.eventPhase=w.originalEvent&&typeof w.originalEvent.eventPhase<"u"?w.originalEvent.eventPhase:0,w.defaultPrevented=e.eventIsCanceled(w.originalEvent),w.shouldCapture=!1,w.shouldReleaseCapture=!1,w.userData=b.userData,g(b,w),b.preProcessEventHandler&&b.preProcessEventHandler(w)}function N(b,w,C){var A=b.getActivePointersListByType(w.type),U=A.getById(w.id);U?C&&!U.captured?(U.captured=!0,A.captureCount++):!C&&U.captured&&(U.captured=!1,A.captureCount--,A.captureCount<0&&(A.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function X(b,w,C){var A=b.getActivePointersListByType(C.type),U;U=A.getById(C.id),U?(U.insideElement=!0,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime,C=U):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,be(A,C)),b.enterHandler&&b.enterHandler({eventSource:b,pointerType:C.type,position:x(C.currentPos,b.element),buttons:A.buttons,pointers:b.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData})}function B(b,w,C){var A=b.getActivePointersListByType(C.type),U,ie;U=A.getById(C.id),U?(U.captured?(U.insideElement=!1,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime):Xe(b,A,U),C=U):(C.captured=!1,C.insideElementPressed=!1),(b.leaveHandler||b.exitHandler)&&(ie={eventSource:b,pointerType:C.type,position:C.currentPos&&x(C.currentPos,b.element),buttons:A.buttons,pointers:b.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData},b.leaveHandler&&b.leaveHandler(ie),b.exitHandler&&b.exitHandler(ie))}function ae(b,w,C){var A,U;A=b.getActivePointersListByType(C.type),U=A.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),b.overHandler&&b.overHandler({eventSource:b,pointerType:C.type,position:x(C.currentPos,b.element),buttons:A.buttons,pointers:b.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData})}function G(b,w,C){var A,U;A=b.getActivePointersListByType(C.type),U=A.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),b.outHandler&&b.outHandler({eventSource:b,pointerType:C.type,position:C.currentPos&&x(C.currentPos,b.element),buttons:A.buttons,pointers:b.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData})}function de(b,w,C,A){var U=i[b.hash],ie=b.getActivePointersListByType(C.type),Ee;if(typeof w.originalEvent.buttons<"u"?ie.buttons=w.originalEvent.buttons:A===0?ie.buttons|=1:A===1?ie.buttons|=4:A===2?ie.buttons|=2:A===3?ie.buttons|=8:A===4?ie.buttons|=16:A===5&&(ie.buttons|=32),A!==0){w.shouldCapture=!1,w.shouldReleaseCapture=!1,b.nonPrimaryPressHandler&&!w.preventGesture&&!w.defaultPrevented&&(w.preventDefault=!0,b.nonPrimaryPressHandler({eventSource:b,pointerType:C.type,position:x(C.currentPos,b.element),button:A,buttons:ie.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData}));return}Ee=ie.getById(C.id),Ee?(Ee.insideElementPressed=!0,Ee.insideElement=!0,Ee.originalTarget=w.originalEvent.target,Ee.contactPos=C.currentPos,Ee.contactTime=C.currentTime,Ee.lastPos=Ee.currentPos,Ee.lastTime=Ee.currentTime,Ee.currentPos=C.currentPos,Ee.currentTime=C.currentTime,C=Ee):(C.captured=!1,C.insideElementPressed=!0,C.insideElement=!0,C.originalTarget=w.originalEvent.target,be(ie,C)),ie.addContact(),!w.preventGesture&&!w.defaultPrevented?(w.shouldCapture=!0,w.shouldReleaseCapture=!1,w.preventDefault=!0,(b.dragHandler||b.dragEndHandler||b.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(b,C),ie.contacts===1?b.pressHandler&&!w.preventGesture&&b.pressHandler({eventSource:b,pointerType:C.type,position:x(C.contactPos,b.element),buttons:ie.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData}):ie.contacts===2&&b.pinchHandler&&C.type==="touch"&&(U.pinchGPoints=ie.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=V(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(w.shouldCapture=!1,w.shouldReleaseCapture=!1)}function xe(b,w,C,A){var U=i[b.hash],ie=b.getActivePointersListByType(C.type),Ee,je,Re,ct=!1,$e;if(typeof w.originalEvent.buttons<"u"?ie.buttons=w.originalEvent.buttons:A===0?ie.buttons^=-2:A===1?ie.buttons^=-5:A===2?ie.buttons^=-3:A===3?ie.buttons^=-9:A===4?ie.buttons^=-17:A===5&&(ie.buttons^=-33),w.shouldCapture=!1,A!==0){w.shouldReleaseCapture=!1,b.nonPrimaryReleaseHandler&&!w.preventGesture&&!w.defaultPrevented&&(w.preventDefault=!0,b.nonPrimaryReleaseHandler({eventSource:b,pointerType:C.type,position:x(C.currentPos,b.element),button:A,buttons:ie.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData}));return}Re=ie.getById(C.id),Re?(ie.removeContact(),Re.captured&&(ct=!0),Re.lastPos=Re.currentPos,Re.lastTime=Re.currentTime,Re.currentPos=C.currentPos,Re.currentTime=C.currentTime,Re.insideElement||Xe(b,ie,Re),Ee=Re.currentPos,je=Re.currentTime):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,be(ie,C),Re=C),!w.preventGesture&&!w.defaultPrevented&&(ct?(w.shouldReleaseCapture=!0,w.preventDefault=!0,(b.dragHandler||b.dragEndHandler||b.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(b,Re),ie.contacts===0?(b.releaseHandler&&Ee&&b.releaseHandler({eventSource:b,pointerType:Re.type,position:x(Ee,b.element),buttons:ie.buttons,insideElementPressed:Re.insideElementPressed,insideElementReleased:Re.insideElement,isTouchEvent:Re.type==="touch",originalEvent:w.originalEvent,userData:b.userData}),b.dragEndHandler&&U.sentDragEvent&&b.dragEndHandler({eventSource:b,pointerType:Re.type,position:x(Re.currentPos,b.element),speed:Re.speed,direction:Re.direction,shift:w.originalEvent.shiftKey,isTouchEvent:Re.type==="touch",originalEvent:w.originalEvent,userData:b.userData}),U.sentDragEvent=!1,(b.clickHandler||b.dblClickHandler)&&Re.insideElement&&($e=je-Re.contactTime<=b.clickTimeThreshold&&Re.contactPos.distanceTo(Ee)<=b.clickDistThreshold,b.clickHandler&&b.clickHandler({eventSource:b,pointerType:Re.type,position:x(Re.currentPos,b.element),quick:$e,shift:w.originalEvent.shiftKey,isTouchEvent:Re.type==="touch",originalEvent:w.originalEvent,originalTarget:Re.originalTarget,userData:b.userData}),b.dblClickHandler&&$e&&(ie.clicks++,ie.clicks===1?(U.lastClickPos=Ee,U.dblClickTimeOut=setTimeout(function(){ie.clicks=0},b.dblClickTimeThreshold)):ie.clicks===2&&(clearTimeout(U.dblClickTimeOut),ie.clicks=0,U.lastClickPos.distanceTo(Ee)<=b.dblClickDistThreshold&&b.dblClickHandler({eventSource:b,pointerType:Re.type,position:x(Re.currentPos,b.element),shift:w.originalEvent.shiftKey,isTouchEvent:Re.type==="touch",originalEvent:w.originalEvent,userData:b.userData}),U.lastClickPos=null)))):ie.contacts===2&&b.pinchHandler&&Re.type==="touch"&&(U.pinchGPoints=ie.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=V(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(w.shouldReleaseCapture=!1,b.releaseHandler&&Ee&&(b.releaseHandler({eventSource:b,pointerType:Re.type,position:x(Ee,b.element),buttons:ie.buttons,insideElementPressed:Re.insideElementPressed,insideElementReleased:Re.insideElement,isTouchEvent:Re.type==="touch",originalEvent:w.originalEvent,userData:b.userData}),w.preventDefault=!0)))}function we(b,w,C){var A=i[b.hash],U=b.getActivePointersListByType(C.type),ie,Ee,je;if(typeof w.originalEvent.buttons<"u"&&(U.buttons=w.originalEvent.buttons),ie=U.getById(C.id),ie)ie.lastPos=ie.currentPos,ie.lastTime=ie.currentTime,ie.currentPos=C.currentPos,ie.currentTime=C.currentTime;else return;w.shouldCapture=!1,w.shouldReleaseCapture=!1,b.stopHandler&&C.type==="mouse"&&(clearTimeout(b.stopTimeOut),b.stopTimeOut=setTimeout(function(){Ne(b,w.originalEvent,C.type)},b.stopDelay)),U.contacts===0?b.moveHandler&&b.moveHandler({eventSource:b,pointerType:C.type,position:x(C.currentPos,b.element),buttons:U.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:b.userData}):U.contacts===1?(b.moveHandler&&(ie=U.asArray()[0],b.moveHandler({eventSource:b,pointerType:ie.type,position:x(ie.currentPos,b.element),buttons:U.buttons,isTouchEvent:ie.type==="touch",originalEvent:w.originalEvent,userData:b.userData})),b.dragHandler&&!w.preventGesture&&!w.defaultPrevented&&(ie=U.asArray()[0],je=ie.currentPos.minus(ie.lastPos),b.dragHandler({eventSource:b,pointerType:ie.type,position:x(ie.currentPos,b.element),buttons:U.buttons,delta:je,speed:ie.speed,direction:ie.direction,shift:w.originalEvent.shiftKey,isTouchEvent:ie.type==="touch",originalEvent:w.originalEvent,userData:b.userData}),w.preventDefault=!0,A.sentDragEvent=!0)):U.contacts===2&&(b.moveHandler&&(Ee=U.asArray(),b.moveHandler({eventSource:b,pointerType:Ee[0].type,position:x(V(Ee[0].currentPos,Ee[1].currentPos),b.element),buttons:U.buttons,isTouchEvent:Ee[0].type==="touch",originalEvent:w.originalEvent,userData:b.userData})),b.pinchHandler&&C.type==="touch"&&!w.preventGesture&&!w.defaultPrevented&&(je=A.pinchGPoints[0].currentPos.distanceTo(A.pinchGPoints[1].currentPos),je!==A.currentPinchDist&&(A.lastPinchDist=A.currentPinchDist,A.currentPinchDist=je,A.lastPinchCenter=A.currentPinchCenter,A.currentPinchCenter=V(A.pinchGPoints[0].currentPos,A.pinchGPoints[1].currentPos),b.pinchHandler({eventSource:b,pointerType:"touch",gesturePoints:A.pinchGPoints,lastCenter:x(A.lastPinchCenter,b.element),center:x(A.currentPinchCenter,b.element),lastDistance:A.lastPinchDist,distance:A.currentPinchDist,shift:w.originalEvent.shiftKey,originalEvent:w.originalEvent,userData:b.userData}),w.preventDefault=!0)))}function fe(b,w,C){var A=b.getActivePointersListByType(C.type),U;U=A.getById(C.id),U&&Xe(b,A,U)}function Ne(b,w,C){b.stopHandler&&b.stopHandler({eventSource:b,pointerType:C,position:T(w,b.element),buttons:b.getActivePointersListByType(C).buttons,isTouchEvent:C==="touch",originalEvent:w,userData:b.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(g){var S=arguments,N=this,X;e.isPlainObject(g)||(g={id:S[0],xmlPath:S.length>1?S[1]:void 0,prefixUrl:S.length>2?S[2]:void 0,controls:S.length>3?S[3]:void 0,overlays:S.length>4?S[4]:void 0}),g.config&&(e.extend(!0,g,g.config),delete g.config);let B=["useCanvas"];if(g.drawerOptions=Object.assign({},B.reduce((G,de)=>(G[de]=g[de],delete g[de],G),{}),g.drawerOptions),e.extend(!0,this,{id:g.id,hash:g.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,g),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(G){var de=e.getString("Errors.OpenFailed",G.eventSource,G.message);N._showMessage(de)}),e.ControlDock.call(this,g),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(G){G.width="100%",G.height="100%",G.overflow="hidden",G.position="absolute",G.top="0px",G.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),g.tabIndex!==""&&(this.canvas.tabIndex=g.tabIndex===void 0?0:g.tabIndex),this.container.className="openseadragon-container",function(G){G.width="100%",G.height="100%",G.position="relative",G.overflow="hidden",G.left="0px",G.top="0px",G.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,T),keyDownHandler:e.delegate(this,x),keyHandler:e.delegate(this,V),clickHandler:e.delegate(this,L),dblClickHandler:e.delegate(this,W),dragHandler:e.delegate(this,J),dragEndHandler:e.delegate(this,ee),enterHandler:e.delegate(this,F),leaveHandler:e.delegate(this,E),pressHandler:e.delegate(this,P),releaseHandler:e.delegate(this,M),nonPrimaryPressHandler:e.delegate(this,k),nonPrimaryReleaseHandler:e.delegate(this,D),scrollHandler:e.delegate(this,ne),pinchHandler:e.delegate(this,I),focusHandler:e.delegate(this,Ce),blurHandler:e.delegate(this,q)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,te),leaveHandler:e.delegate(this,$)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[N.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(G){N.source=N.world.getItemAt(0).source,i[N.hash].forceRedraw=!0,N._updateRequestId||(N._updateRequestId=c(N,H))}),this.world.addHandler("remove-item",function(G){N.world.getItemCount()?N.source=N.world.getItemAt(0).source:N.source=null,i[N.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(G){N.viewport&&N.viewport._setContentBounds(N.world.getHomeBounds(),N.world.getContentFactor())}),this.world.addHandler("item-index-change",function(G){N.source=N.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:g.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let ae=Array.isArray(this.drawer)?this.drawer:[this.drawer];ae.length===0&&(ae=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const G of ae)if(this.requestDrawer(G,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(X=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(X,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(X=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(X,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),X=0;X<this.customControls.length;X++)this.addControl(this.customControls[X].id,{anchor:this.customControls[X].anchor});e.requestAnimationFrame(function(){d(N)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(g){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(g)},openTileSource:function(g){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(g)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(g,S){var N=this;if(this.close(),!g)return this;if(this.sequenceMode&&e.isArray(g))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof S<"u"&&!isNaN(S)&&(this.initialPage=S),this.tileSources=g,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(g)||(g=[g]),!g.length)return this;this._opening=!0;for(var X=g.length,B=0,ae=0,G,de=function(){if(B+ae===X)if(B){(N._firstOpen||!N.preserveViewport)&&(N.viewport.goHome(!0),N.viewport.update()),N._firstOpen=!1;var fe=g[0];if(fe.tileSource&&(fe=fe.tileSource),N.overlays&&!N.preserveOverlays)for(var Ne=0;Ne<N.overlays.length;Ne++)N.currentOverlays[Ne]=a(N,N.overlays[Ne]);N._drawOverlays(),N._opening=!1,N.raiseEvent("open",{source:fe})}else N._opening=!1,N.raiseEvent("open-failed",G)},xe=function(fe){(!e.isPlainObject(fe)||!fe.tileSource)&&(fe={tileSource:fe}),fe.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete fe.index),fe.collectionImmediately===void 0&&(fe.collectionImmediately=!0);var Ne=fe.success;fe.success=function(w){if(B++,fe.tileSource.overlays)for(var C=0;C<fe.tileSource.overlays.length;C++)N.addOverlay(fe.tileSource.overlays[C]);Ne&&Ne(w),de()};var b=fe.error;fe.error=function(w){ae++,G||(G=w),b&&b(w),de()},N.addTiledImage(fe)},we=0;we<g.length;we++)xe(g[we]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(g,S){const N={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};S=e.extend(!0,N,S);const X=S.mainDrawer,B=S.redrawImmediately,ae=S.drawerOptions,G=this.drawer;let de=null;if(g&&g.prototype instanceof e.DrawerBase?(de=g,g="custom"):typeof g=="string"&&(de=e.determineDrawer(g)),de||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),de&&de.isSupported()){G&&X&&G.destroy();const xe=new de({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:ae||this.drawerOptions[g]});return X&&(this.drawer=xe,B&&this.forceRedraw()),xe}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(g){return this.innerTracker.setTracking(g),this.outerTracker.setTracking(g),this.raiseEvent("mouse-enabled",{enabled:g}),this},areControlsEnabled:function(){var g=this.controls.length,S;for(S=0;S<this.controls.length;S++)g=g&&this.controls[S].isVisible();return g},setControlsEnabled:function(g){return g?m(this):d(this),this.raiseEvent("controls-enabled",{enabled:g}),this},setDebugMode:function(g){for(var S=0;S<this.world.getItemCount();S++)this.world.getItemAt(S).debugMode=g;this.debugMode=g,this.forceRedraw()},setAjaxHeaders:function(g,S){if(g===null&&(g={}),!e.isPlainObject(g)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(S===void 0&&(S=!0),this.ajaxHeaders=g,S){for(var N=0;N<this.world.getItemCount();N++)this.world.getItemAt(N)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var X in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[X].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(g){this.buttonGroup.addButton(g)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(g){var S=document.body,N=S.style,X=document.documentElement.style,B=this,ae,G;if(g===this.isFullPage())return this;var de={fullPage:g,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",de),de.preventDefaultAction)return this;if(g&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=N.margin,this.docMargin=X.margin,N.margin="0",X.margin="0",this.bodyPadding=N.padding,this.docPadding=X.padding,N.padding="0",X.padding="0",this.bodyWidth=N.width,this.docWidth=X.width,N.width="100%",X.width="100%",this.bodyHeight=N.height,this.docHeight=X.height,N.height="100%",X.height="100%",this.bodyDisplay=N.display,N.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,ae=S.childNodes.length,G=0;G<ae;G++)this.previousBody.push(S.childNodes[0]),S.removeChild(S.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,S.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),S.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,te)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,N.margin=this.bodyMargin,X.margin=this.docMargin,N.padding=this.bodyPadding,X.padding=this.docPadding,N.width=this.bodyWidth,X.width=this.docWidth,N.height=this.bodyHeight,X.height=this.docHeight,N.display=this.bodyDisplay,S.removeChild(this.element),ae=this.previousBody.length,G=0;G<ae;G++)S.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(S.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var xe=0,we=function(){e.setPageScroll(B.pageScroll);var fe=e.getPageScroll();xe++,xe<10&&(fe.x!==B.pageScroll.x||fe.y!==B.pageScroll.y)&&e.requestAnimationFrame(we)};e.requestAnimationFrame(we),i[this.hash].fullPage=!1,e.delegate(this,$)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:g}),this},setFullScreen:function(g){var S=this;if(!e.supportsFullScreen)return this.setFullPage(g);if(e.isFullScreen()===g)return this;var N={fullScreen:g,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",N),N.preventDefaultAction)return this;if(g){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var X=function(){var B=e.isFullScreen();B||(e.removeEvent(document,e.fullScreenEventName,X),e.removeEvent(document,e.fullScreenErrorEventName,X),S.setFullPage(!1),S.isFullPage()&&(S.element.style.width=S.fullPageStyleWidth,S.element.style.height=S.fullPageStyleHeight)),S.navigator&&S.viewport&&setTimeout(function(){S.navigator.update(S.viewport)}),S.raiseEvent("full-screen",{fullScreen:B})};e.addEvent(document,e.fullScreenEventName,X),e.addEvent(document,e.fullScreenErrorEventName,X),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(g){return this.container.style.visibility=g?"":"hidden",this.raiseEvent("visible",{visible:g}),this},addTiledImage:function(g){e.console.assert(g,"[Viewer.addTiledImage] options is required"),e.console.assert(g.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!g.replace||g.index>-1&&g.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var S=this;g.replace&&(g.replaceItem=S.world.getItemAt(g.index)),this._hideMessage(),g.placeholderFillStyle===void 0&&(g.placeholderFillStyle=this.placeholderFillStyle),g.opacity===void 0&&(g.opacity=this.opacity),g.preload===void 0&&(g.preload=this.preload),g.compositeOperation===void 0&&(g.compositeOperation=this.compositeOperation),g.crossOriginPolicy===void 0&&(g.crossOriginPolicy=g.tileSource.crossOriginPolicy!==void 0?g.tileSource.crossOriginPolicy:this.crossOriginPolicy),g.ajaxWithCredentials===void 0&&(g.ajaxWithCredentials=this.ajaxWithCredentials),g.loadTilesWithAjax===void 0&&(g.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(g.ajaxHeaders)||(g.ajaxHeaders={});var N={options:g};function X(G){for(var de=0;de<S._loadQueue.length;de++)if(S._loadQueue[de]===N){S._loadQueue.splice(de,1);break}S._loadQueue.length===0&&B(N),S.raiseEvent("add-item-failed",G),g.error&&g.error(G)}function B(G){S.collectionMode&&(S.world.arrange({immediately:G.options.collectionImmediately,rows:S.collectionRows,columns:S.collectionColumns,layout:S.collectionLayout,tileSize:S.collectionTileSize,tileMargin:S.collectionTileMargin}),S.world.setAutoRefigureSizes(!0))}if(e.isArray(g.tileSource)){setTimeout(function(){X({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:g.tileSource,options:g})});return}this._loadQueue.push(N);function ae(){for(var G,de,xe;S._loadQueue.length&&(G=S._loadQueue[0],!!G.tileSource);){if(S._loadQueue.splice(0,1),G.options.replace){var we=S.world.getIndexOfItem(G.options.replaceItem);we!==-1&&(G.options.index=we),S.world.removeItem(G.options.replaceItem)}de=new e.TiledImage({viewer:S,source:G.tileSource,viewport:S.viewport,drawer:S.drawer,tileCache:S.tileCache,imageLoader:S.imageLoader,x:G.options.x,y:G.options.y,width:G.options.width,height:G.options.height,fitBounds:G.options.fitBounds,fitBoundsPlacement:G.options.fitBoundsPlacement,clip:G.options.clip,placeholderFillStyle:G.options.placeholderFillStyle,opacity:G.options.opacity,preload:G.options.preload,degrees:G.options.degrees,flipped:G.options.flipped,compositeOperation:G.options.compositeOperation,springStiffness:S.springStiffness,animationTime:S.animationTime,minZoomImageRatio:S.minZoomImageRatio,wrapHorizontal:S.wrapHorizontal,wrapVertical:S.wrapVertical,maxTilesPerFrame:S.maxTilesPerFrame,immediateRender:S.immediateRender,blendTime:S.blendTime,alwaysBlend:S.alwaysBlend,minPixelRatio:S.minPixelRatio,smoothTileEdgesMinZoom:S.smoothTileEdgesMinZoom,iOSDevice:S.iOSDevice,crossOriginPolicy:G.options.crossOriginPolicy,ajaxWithCredentials:G.options.ajaxWithCredentials,loadTilesWithAjax:G.options.loadTilesWithAjax,ajaxHeaders:G.options.ajaxHeaders,debugMode:S.debugMode,subPixelRoundingForTransparency:S.subPixelRoundingForTransparency}),S.collectionMode&&S.world.setAutoRefigureSizes(!1),S.navigator&&(xe=e.extend({},G.options,{replace:!1,originalTiledImage:de,tileSource:G.tileSource}),S.navigator.addTiledImage(xe)),S.world.addItem(de,{index:G.options.index}),S._loadQueue.length===0&&B(G),S.world.getItemCount()===1&&!S.preserveViewport&&S.viewport.goHome(!0),G.options.success&&G.options.success({item:de})}}o(this,g.tileSource,g,function(G){N.tileSource=G,ae()},function(G){G.options=g,X(G),ae()})},addSimpleImage:function(g){e.console.assert(g,"[Viewer.addSimpleImage] options is required"),e.console.assert(g.url,"[Viewer.addSimpleImage] options.url is required");var S=e.extend({},g,{tileSource:{type:"image",url:g.url}});delete S.url,this.addTiledImage(S)},addLayer:function(g){var S=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var N=e.extend({},g,{success:function(X){S.raiseEvent("add-layer",{options:g,drawer:X.item})},error:function(X){S.raiseEvent("add-layer-failed",X)}});return this.addTiledImage(N),this},getLayerAtLevel:function(g){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(g)},getLevelOfLayer:function(g){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(g)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(g,S){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(g,S)},removeLayer:function(g){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(g)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var g=e.delegate(this,y),S=e.delegate(this,_),N=e.delegate(this,this.goToNextPage),X=e.delegate(this,this.goToPreviousPage),B=this.navImages,ae=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(ae=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:Y(this.prefixUrl,B.previous.REST),srcGroup:Y(this.prefixUrl,B.previous.GROUP),srcHover:Y(this.prefixUrl,B.previous.HOVER),srcDown:Y(this.prefixUrl,B.previous.DOWN),onRelease:X,onFocus:g,onBlur:S}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:Y(this.prefixUrl,B.next.REST),srcGroup:Y(this.prefixUrl,B.next.GROUP),srcHover:Y(this.prefixUrl,B.next.HOVER),srcDown:Y(this.prefixUrl,B.next.DOWN),onRelease:N,onFocus:g,onBlur:S}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),ae&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var g=e.delegate(this,oe),S=e.delegate(this,_e),N=e.delegate(this,qe),X=e.delegate(this,le),B=e.delegate(this,De),ae=e.delegate(this,Se),G=e.delegate(this,Ae),de=e.delegate(this,pe),xe=e.delegate(this,be),we=e.delegate(this,Xe),fe=e.delegate(this,y),Ne=e.delegate(this,_),b=this.navImages,w=[],C=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(C=!1),this.showZoomControl&&(w.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:Y(this.prefixUrl,b.zoomIn.REST),srcGroup:Y(this.prefixUrl,b.zoomIn.GROUP),srcHover:Y(this.prefixUrl,b.zoomIn.HOVER),srcDown:Y(this.prefixUrl,b.zoomIn.DOWN),onPress:g,onRelease:S,onClick:N,onEnter:g,onExit:S,onFocus:fe,onBlur:Ne})),w.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:Y(this.prefixUrl,b.zoomOut.REST),srcGroup:Y(this.prefixUrl,b.zoomOut.GROUP),srcHover:Y(this.prefixUrl,b.zoomOut.HOVER),srcDown:Y(this.prefixUrl,b.zoomOut.DOWN),onPress:X,onRelease:S,onClick:B,onEnter:X,onExit:S,onFocus:fe,onBlur:Ne}))),this.showHomeControl&&w.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:Y(this.prefixUrl,b.home.REST),srcGroup:Y(this.prefixUrl,b.home.GROUP),srcHover:Y(this.prefixUrl,b.home.HOVER),srcDown:Y(this.prefixUrl,b.home.DOWN),onRelease:ae,onFocus:fe,onBlur:Ne})),this.showFullPageControl&&w.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:Y(this.prefixUrl,b.fullpage.REST),srcGroup:Y(this.prefixUrl,b.fullpage.GROUP),srcHover:Y(this.prefixUrl,b.fullpage.HOVER),srcDown:Y(this.prefixUrl,b.fullpage.DOWN),onRelease:G,onFocus:fe,onBlur:Ne})),this.showRotationControl&&(w.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:Y(this.prefixUrl,b.rotateleft.REST),srcGroup:Y(this.prefixUrl,b.rotateleft.GROUP),srcHover:Y(this.prefixUrl,b.rotateleft.HOVER),srcDown:Y(this.prefixUrl,b.rotateleft.DOWN),onRelease:de,onFocus:fe,onBlur:Ne})),w.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:Y(this.prefixUrl,b.rotateright.REST),srcGroup:Y(this.prefixUrl,b.rotateright.GROUP),srcHover:Y(this.prefixUrl,b.rotateright.HOVER),srcDown:Y(this.prefixUrl,b.rotateright.DOWN),onRelease:xe,onFocus:fe,onBlur:Ne}))),this.showFlipControl&&w.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:Y(this.prefixUrl,b.flip.REST),srcGroup:Y(this.prefixUrl,b.flip.GROUP),srcHover:Y(this.prefixUrl,b.flip.HOVER),srcDown:Y(this.prefixUrl,b.flip.DOWN),onRelease:we,onFocus:fe,onBlur:Ne})),C?(this.buttonGroup=new e.ButtonGroup({buttons:w,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,Te)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=w),this},currentPage:function(){return this._sequenceIndex},goToPage:function(g){return this.tileSources&&g>=0&&g<this.tileSources.length&&(this._sequenceIndex=g,this._updateSequenceButtons(g),this.open(this.tileSources[g]),this.referenceStrip&&this.referenceStrip.setFocus(g),this.raiseEvent("page",{page:g})),this},addOverlay:function(g,S,N,X){var B;if(e.isPlainObject(g)?B=g:B={element:g,location:S,placement:N,onDraw:X},g=e.getElement(B.element),l(this.currentOverlays,g)>=0)return this;var ae=a(this,B);return this.currentOverlays.push(ae),ae.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:g,location:B.location,placement:B.placement}),this},updateOverlay:function(g,S,N){var X;return g=e.getElement(g),X=l(this.currentOverlays,g),X>=0&&(this.currentOverlays[X].update(S,N),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:g,location:S,placement:N})),this},removeOverlay:function(g){var S;return g=e.getElement(g),S=l(this.currentOverlays,g),S>=0&&(this.currentOverlays[S].destroy(),this.currentOverlays.splice(S,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:g})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(g){var S;return g=e.getElement(g),S=l(this.currentOverlays,g),S>=0?this.currentOverlays[S]:null},_updateSequenceButtons:function(g){this.nextButton&&(!this.tileSources||this.tileSources.length-1===g?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(g>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(g){this._hideMessage();var S=e.makeNeutralElement("div");S.appendChild(document.createTextNode(g)),this.messageDiv=e.makeCenteredNode(S),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var g=this.messageDiv;g&&(g.parentNode.removeChild(g),delete this.messageDiv)},gestureSettingsByDeviceType:function(g){switch(g){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var g,S=this.currentOverlays.length;for(g=0;g<S;g++)this.currentOverlays[g].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var g=e.pixelDensityRatio,S=e.getCurrentPixelDensityRatio();g!==S&&(e.pixelDensityRatio=S,this.forceResize())},goToPreviousPage:function(){var g=this._sequenceIndex-1;this.navPrevNextWrap&&g<0&&(g+=this.tileSources.length),this.goToPage(g)},goToNextPage:function(){var g=this._sequenceIndex+1;this.navPrevNextWrap&&g>=this.tileSources.length&&(g=0),this.goToPage(g)},isAnimating:function(){return i[this.hash].animating}});function r(g){return g=e.getElement(g),new e.Point(g.clientWidth===0?1:g.clientWidth,g.clientHeight===0?1:g.clientHeight)}function o(g,S,N,X,B){var ae=g;if(e.type(S)==="string"){if(S.match(/^\s*<.*>\s*$/))S=e.parseXml(S);else if(S.match(/^\s*[{[].*[}\]]\s*$/))try{var G=e.parseJSON(S);S=G}catch{}}function de(xe,we){xe.ready?X(xe):(xe.addHandler("ready",function(){X(xe)}),xe.addHandler("open-failed",function(fe){B({message:fe.message,source:we})}))}setTimeout(function(){if(e.type(S)==="string")S=new e.TileSource({url:S,crossOriginPolicy:N.crossOriginPolicy!==void 0?N.crossOriginPolicy:g.crossOriginPolicy,ajaxWithCredentials:g.ajaxWithCredentials,ajaxHeaders:N.ajaxHeaders?N.ajaxHeaders:g.ajaxHeaders,splitHashDataForPost:g.splitHashDataForPost,success:function(Ne){X(Ne.tileSource)}}),S.addHandler("open-failed",function(Ne){B(Ne)});else if(e.isPlainObject(S)||S.nodeType)if(S.crossOriginPolicy===void 0&&(N.crossOriginPolicy!==void 0||g.crossOriginPolicy!==void 0)&&(S.crossOriginPolicy=N.crossOriginPolicy!==void 0?N.crossOriginPolicy:g.crossOriginPolicy),S.ajaxWithCredentials===void 0&&(S.ajaxWithCredentials=g.ajaxWithCredentials),e.isFunction(S.getTileUrl)){var xe=new e.TileSource(S);xe.getTileUrl=S.getTileUrl,X(xe)}else{var we=e.TileSource.determineType(ae,S);if(!we){B({message:"Unable to load TileSource",source:S});return}var fe=we.prototype.configure.apply(ae,[S]);de(new we(fe),S)}else de(S,S)})}function a(g,S){if(S instanceof e.Overlay)return S;var N=null;if(S.element)N=e.getElement(S.element);else{var X=S.id?S.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);N=e.getElement(S.id),N||(N=document.createElement("a"),N.href="#/overlay/"+X),N.id=X,e.addClass(N,S.className?S.className:"openseadragon-overlay")}var B=S.location,ae=S.width,G=S.height;if(!B){var de=S.x,xe=S.y;if(S.px!==void 0){var we=g.viewport.imageToViewportRectangle(new e.Rect(S.px,S.py,ae||0,G||0));de=we.x,xe=we.y,ae=ae!==void 0?we.width:void 0,G=G!==void 0?we.height:void 0}B=new e.Point(de,xe)}var fe=S.placement;return fe&&e.type(fe)==="string"&&(fe=e.Placement[S.placement.toUpperCase()]),new e.Overlay({element:N,location:B,placement:fe,onDraw:S.onDraw,checkResize:S.checkResize,width:ae,height:G,rotationMode:S.rotationMode})}function l(g,S){var N;for(N=g.length-1;N>=0;N--)if(g[N].element===S)return N;return-1}function c(g,S){return e.requestAnimationFrame(function(){S(g)})}function u(g){e.requestAnimationFrame(function(){p(g)})}function d(g){g.autoHideControls&&(g.controlsShouldFade=!0,g.controlsFadeBeginTime=e.now()+g.controlsFadeDelay,window.setTimeout(function(){u(g)},g.controlsFadeDelay))}function p(g){var S,N,X,B;if(g.controlsShouldFade){for(S=e.now(),N=S-g.controlsFadeBeginTime,X=1-N/g.controlsFadeLength,X=Math.min(1,X),X=Math.max(0,X),B=g.controls.length-1;B>=0;B--)g.controls[B].autoFade&&g.controls[B].setOpacity(X);X>0&&u(g)}}function m(g){var S;for(g.controlsShouldFade=!1,S=g.controls.length-1;S>=0;S--)g.controls[S].setOpacity(1)}function y(){m(this)}function _(){d(this)}function T(g){var S={tracker:g.eventSource,position:g.position,originalEvent:g.originalEvent,preventDefault:g.preventDefault};this.raiseEvent("canvas-contextmenu",S),g.preventDefault=S.preventDefault}function x(g){var S={originalEvent:g.originalEvent,preventDefaultAction:!1,preventVerticalPan:g.preventVerticalPan||!this.panVertical,preventHorizontalPan:g.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",S),!S.preventDefaultAction&&!g.ctrl&&!g.alt&&!g.meta)switch(g.keyCode){case 38:S.preventVerticalPan||(g.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 40:S.preventVerticalPan||(g.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 37:S.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 39:S.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 87:S.preventVerticalPan||(g.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 83:S.preventVerticalPan||(g.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 65:S.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 68:S.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 82:g.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),g.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:g.preventDefault=!1;break}else g.preventDefault=!1}function V(g){var S={originalEvent:g.originalEvent};this.raiseEvent("canvas-key-press",S)}function L(g){var S,N=document.activeElement===this.canvas;N||this.canvas.focus(),this.viewport.flipped&&(g.position.x=this.viewport.getContainerSize().x-g.position.x);var X={tracker:g.eventSource,position:g.position,quick:g.quick,shift:g.shift,originalEvent:g.originalEvent,originalTarget:g.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",X),!X.preventDefaultAction&&this.viewport&&g.quick&&(S=this.gestureSettingsByDeviceType(g.pointerType),S.clickToZoom===!0&&(this.viewport.zoomBy(g.shift?1/this.zoomPerClick:this.zoomPerClick,S.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints()),S.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function W(g){var S,N={tracker:g.eventSource,position:g.position,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",N),!N.preventDefaultAction&&this.viewport&&(S=this.gestureSettingsByDeviceType(g.pointerType),S.dblClickToZoom&&(this.viewport.zoomBy(g.shift?1/this.zoomPerClick:this.zoomPerClick,S.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints()))}function J(g){var S,N={tracker:g.eventSource,pointerType:g.pointerType,position:g.position,delta:g.delta,speed:g.speed,direction:g.direction,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",N),S=this.gestureSettingsByDeviceType(g.pointerType),!N.preventDefaultAction&&this.viewport){if(S.dblClickDragToZoom&&i[this.hash].draggingToZoom){var X=Math.pow(this.zoomPerDblClickDrag,g.delta.y/50);this.viewport.zoomBy(X)}else if(S.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(g.delta.x=0),this.panVertical||(g.delta.y=0),this.viewport.flipped&&(g.delta.x=-g.delta.x),this.constrainDuringPan){var B=this.viewport.deltaPointsFromPixels(g.delta.negate());this.viewport.centerSpringX.target.value+=B.x,this.viewport.centerSpringY.target.value+=B.y;var ae=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=B.x,this.viewport.centerSpringY.target.value-=B.y,ae.xConstrained&&(g.delta.x=0),ae.yConstrained&&(g.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(g.delta.negate()),S.flickEnabled&&!this.constrainDuringPan)}}}function ee(g){var S,N={tracker:g.eventSource,pointerType:g.pointerType,position:g.position,speed:g.speed,direction:g.direction,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",N),S=this.gestureSettingsByDeviceType(g.pointerType),!N.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&S.dragToPan&&S.flickEnabled&&g.speed>=S.flickMinSpeed){var X=0;this.panHorizontal&&(X=S.flickMomentum*g.speed*Math.cos(g.direction));var B=0;this.panVertical&&(B=S.flickMomentum*g.speed*Math.sin(g.direction));var ae=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),G=this.viewport.pointFromPixel(new e.Point(ae.x-X,ae.y-B));this.viewport.panTo(G,!1)}this.viewport.applyConstraints()}S.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function F(g){this.raiseEvent("canvas-enter",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function E(g){this.raiseEvent("canvas-exit",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function P(g){var S;if(this.raiseEvent("canvas-press",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElementReleased,originalEvent:g.originalEvent}),S=this.gestureSettingsByDeviceType(g.pointerType),S.dblClickDragToZoom){var N=i[this.hash].lastClickTime,X=e.now();if(N===null)return;X-N<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function M(g){this.raiseEvent("canvas-release",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElementReleased,originalEvent:g.originalEvent})}function k(g){this.raiseEvent("canvas-nonprimary-press",{tracker:g.eventSource,position:g.position,pointerType:g.pointerType,button:g.button,buttons:g.buttons,originalEvent:g.originalEvent})}function D(g){this.raiseEvent("canvas-nonprimary-release",{tracker:g.eventSource,position:g.position,pointerType:g.pointerType,button:g.button,buttons:g.buttons,originalEvent:g.originalEvent})}function I(g){var S,N,X,B,ae={tracker:g.eventSource,pointerType:g.pointerType,gesturePoints:g.gesturePoints,lastCenter:g.lastCenter,center:g.center,lastDistance:g.lastDistance,distance:g.distance,shift:g.shift,originalEvent:g.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",ae),this.viewport&&(S=this.gestureSettingsByDeviceType(g.pointerType),S.pinchToZoom&&(!ae.preventDefaultPanAction||!ae.preventDefaultZoomAction)&&(N=this.viewport.pointFromPixel(g.center,!0),S.zoomToRefPoint&&!ae.preventDefaultPanAction&&(X=this.viewport.pointFromPixel(g.lastCenter,!0),B=X.minus(N),this.panHorizontal||(B.x=0),this.panVertical||(B.y=0),this.viewport.panBy(B,!0)),ae.preventDefaultZoomAction||this.viewport.zoomBy(g.distance/g.lastDistance,N,!0),this.viewport.applyConstraints()),S.pinchRotate&&!ae.preventDefaultRotateAction)){var G=Math.atan2(g.gesturePoints[0].currentPos.y-g.gesturePoints[1].currentPos.y,g.gesturePoints[0].currentPos.x-g.gesturePoints[1].currentPos.x),de=Math.atan2(g.gesturePoints[0].lastPos.y-g.gesturePoints[1].lastPos.y,g.gesturePoints[0].lastPos.x-g.gesturePoints[1].lastPos.x);N=this.viewport.pointFromPixel(g.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(G-de)*(180/Math.PI),N,!0)}}function Ce(g){this.raiseEvent("canvas-focus",{tracker:g.eventSource,originalEvent:g.originalEvent})}function q(g){this.raiseEvent("canvas-blur",{tracker:g.eventSource,originalEvent:g.originalEvent})}function ne(g){var S,N,X,B,ae;B=e.now(),ae=B-this._lastScrollTime,ae>this.minScrollDeltaTime?(this._lastScrollTime=B,S={tracker:g.eventSource,position:g.position,scroll:g.scroll,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",S),!S.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(g.position.x=this.viewport.getContainerSize().x-g.position.x),N=this.gestureSettingsByDeviceType(g.pointerType),N.scrollToZoom&&(X=Math.pow(this.zoomPerScroll,g.scroll),this.viewport.zoomBy(X,N.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints())),g.preventDefault=S.preventDefault):g.preventDefault=!0}function te(g){i[this.hash].mouseInside=!0,m(this),this.raiseEvent("container-enter",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function $(g){g.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||d(this)),this.raiseEvent("container-exit",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function H(g){ce(g),g.isOpen()?g._updateRequestId=c(g,H):g._updateRequestId=!1}function se(g,S){var N=g.viewport,X=N.getZoom(),B=N.getCenter();N.resize(S,g.preserveImageSizeOnResize),N.panTo(B,!0);var ae;if(g.preserveImageSizeOnResize)ae=i[g.hash].prevContainerSize.x/S.x;else{var G=new e.Point(0,0),de=new e.Point(i[g.hash].prevContainerSize.x,i[g.hash].prevContainerSize.y).distanceTo(G),xe=new e.Point(S.x,S.y).distanceTo(G);ae=xe/de*i[g.hash].prevContainerSize.x/S.x}N.zoomTo(X*ae,null,!0),i[g.hash].prevContainerSize=S,i[g.hash].forceRedraw=!0,i[g.hash].needsResize=!1,i[g.hash].forceResize=!1}function ce(g){if(!(g._opening||!i[g.hash])){if(g.autoResize||i[g.hash].forceResize){var S;if(g._autoResizePolling){S=r(g.container);var N=i[g.hash].prevContainerSize;S.equals(N)||(i[g.hash].needsResize=!0)}i[g.hash].needsResize&&se(g,S||r(g.container))}var X=g.viewport.update(),B=g.world.update(X)||X;X&&g.raiseEvent("viewport-change"),g.referenceStrip&&(B=g.referenceStrip.update(g.viewport)||B);var ae=i[g.hash].animating;!ae&&B&&(g.raiseEvent("animation-start"),m(g));var G=ae&&!B;G&&(i[g.hash].animating=!1),(B||G||i[g.hash].forceRedraw||g.world.needsDraw())&&(ue(g),g._drawOverlays(),g.navigator&&g.navigator.update(g.viewport),i[g.hash].forceRedraw=!1,B&&g.raiseEvent("animation")),G&&(g.raiseEvent("animation-finish"),i[g.hash].mouseInside||d(g)),i[g.hash].animating=B}}function ue(g){g.imageLoader.clear(),g.world.draw(),g.raiseEvent("update-viewport",{})}function Y(g,S){return g?g+S:S}function oe(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,ge(this)}function le(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,ge(this)}function _e(){i[this.hash].zooming=!1}function ge(g){e.requestAnimationFrame(e.delegate(g,Oe))}function Oe(){var g,S,N;i[this.hash].zooming&&this.viewport&&(g=e.now(),S=g-i[this.hash].lastZoomTime,N=Math.pow(i[this.hash].zoomFactor,S/1e3),this.viewport.zoomBy(N),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=g,ge(this))}function qe(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function De(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function Te(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function Se(){this.viewport&&this.viewport.goHome()}function Ae(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function pe(){if(this.viewport){var g=this.viewport.getRotation();this.viewport.flipped?g+=this.rotationIncrement:g-=this.rotationIncrement,this.viewport.setRotation(g)}}function be(){if(this.viewport){var g=this.viewport.getRotation();this.viewport.flipped?g-=this.rotationIncrement:g+=this.rotationIncrement,this.viewport.setRotation(g)}}function Xe(){this.viewport.toggleFlip()}e.determineDrawer=function(g){for(let S in t){const N=t[S],X=N.prototype;if(X&&X instanceof t.DrawerBase&&e.isFunction(X.getType)&&X.getType.call(N)===g)return N}return null}}(t),function(e){e.Navigator=function(c){var u=c.viewer,d=this,p,m;c.element||c.id?(c.element?(c.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),c.element.id?c.id=c.element.id:c.id="navigator-"+e.now(),this.element=c.element):this.element=document.getElementById(c.id),c.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(c.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),c.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:c.autoFade},c.position&&(c.position==="BOTTOM_RIGHT"?c.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:c.position==="BOTTOM_LEFT"?c.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:c.position==="TOP_RIGHT"?c.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:c.position==="TOP_LEFT"?c.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:c.position==="ABSOLUTE"&&(c.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,c.controlOptions.top=c.top,c.controlOptions.left=c.left,c.controlOptions.height=c.height,c.controlOptions.width=c.width))),this.element.id=c.id,this.element.className+=" navigator",c=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},c,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:c.animationTime,autoResize:!1,minZoomImageRatio:1,background:c.background,opacity:c.opacity,borderColor:c.borderColor,displayRegionColor:c.displayRegionColor}),c.minPixelRatio=this.minPixelRatio=u.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),c.controlOptions.anchor!==e.ControlAnchor.NONE&&function(T,x){T.margin="0px",T.border=x+"px solid "+c.borderColor,T.padding="0px",T.background=c.background,T.opacity=c.opacity,T.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(T,x){T.position="relative",T.top="0px",T.left="0px",T.fontSize="0px",T.overflow="hidden",T.border=x+"px solid "+c.displayRegionColor,T.margin="0px",T.padding="0px",T.background="transparent",T.float="left",T.cssFloat="left",T.zIndex=999999999,T.cursor="default",T.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),u.addControl(this.element,c.controlOptions),this._resizeWithViewer=c.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&c.controlOptions.anchor!==e.ControlAnchor.NONE,c.width&&c.height?(this.setWidth(c.width),this.setHeight(c.height)):this._resizeWithViewer&&(p=e.getElementSize(u.element),this.element.style.height=Math.round(p.y*c.sizeRatio)+"px",this.element.style.width=Math.round(p.x*c.sizeRatio)+"px",this.oldViewerSize=p,m=e.getElementSize(this.element),this.elementArea=m.x*m.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[c]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function y(T,x){a(d.displayRegionContainer,T),a(d.displayRegion,-T),d.viewport.setRotation(T,x)}if(c.navigatorRotate){var _=c.viewer.viewport?c.viewer.viewport.getRotation():c.viewer.degrees||0;y(_,!0),c.viewer.addHandler("rotate",function(T){y(T.degrees,T.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(T){T.eventType==="wheel"&&(T.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){d.viewport&&d.viewport.goHome(!0)}),u.world.addHandler("item-index-change",function(T){window.setTimeout(function(){var x=d.world.getItemAt(T.previousIndex);d.world.setItemIndex(x,T.newIndex)},1)}),u.world.addHandler("remove-item",function(T){var x=T.item,V=d._getMatchingItem(x);V&&d.world.removeItem(V)}),this.update(u.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var c=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);c.equals(this.oldContainerSize)||(this.viewport.resize(c,!0),this.viewport.goHome(!0),this.oldContainerSize=c,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(c){this.width=c,this.element.style.width=typeof c=="number"?c+"px":c,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(c){this.height=c,this.element.style.height=typeof c=="number"?c+"px":c,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(c){return this.viewport.setFlip(c),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(c){l(this.canvas,c),l(this.element,c)},update:function(c){var u,d,p,m,y,_;if(c||(c=this.viewer.viewport),u=e.getElementSize(this.viewer.element),this._resizeWithViewer&&u.x&&u.y&&!u.equals(this.oldViewerSize)&&(this.oldViewerSize=u,this.maintainSizeRatio||!this.elementArea?(d=u.x*this.sizeRatio,p=u.y*this.sizeRatio):(d=Math.sqrt(this.elementArea*(u.x/u.y)),p=this.elementArea/d),this.element.style.width=Math.round(d)+"px",this.element.style.height=Math.round(p)+"px",this.elementArea||(this.elementArea=d*p),this.updateSize()),c&&this.viewport){if(m=c.getBoundsNoRotate(!0),y=this.viewport.pixelFromPointNoRotate(m.getTopLeft(),!1),_=this.viewport.pixelFromPointNoRotate(m.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var T=c.getRotation(!0);a(this.displayRegion,-T)}var x=this.displayRegion.style;x.display=this.world.getItemCount()?"block":"none",x.top=y.y.toFixed(2)+"px",x.left=y.x.toFixed(2)+"px";var V=_.x-y.x,L=_.y-y.y;x.width=Math.round(Math.max(V,0))+"px",x.height=Math.round(Math.max(L,0))+"px"}},addTiledImage:function(c){var u=this,d=c.originalTiledImage;delete c.original;var p=e.extend({},c,{success:function(m){var y=m.item;y._originalForNavigator=d,u._matchBounds(y,d,!0),u._matchOpacity(y,d),u._matchCompositeOperation(y,d);function _(){u._matchBounds(y,d)}function T(){u._matchOpacity(y,d)}function x(){u._matchCompositeOperation(y,d)}d.addHandler("bounds-change",_),d.addHandler("clip-change",_),d.addHandler("opacity-change",T),d.addHandler("composite-operation-change",x)}});return e.Viewer.prototype.addTiledImage.apply(this,[p])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(c){for(var u=this.world.getItemCount(),d,p=0;p<u;p++)if(d=this.world.getItemAt(p),d._originalForNavigator===c)return d;return null},_matchBounds:function(c,u,d){var p=u.getBoundsNoRotate();c.setPosition(p.getTopLeft(),d),c.setWidth(p.width,d),c.setRotation(u.getRotation(),d),c.setClip(u.getClip()),c.setFlip(u.getFlip())},_matchOpacity:function(c,u){c.setOpacity(u.opacity)},_matchCompositeOperation:function(c,u){c.setCompositeOperation(u.compositeOperation)}});function i(c){var u={tracker:c.eventSource,position:c.position,quick:c.quick,shift:c.shift,originalEvent:c.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",u),!u.preventDefaultAction&&c.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(c.position.x=this.viewport.getContainerSize().x-c.position.x);var d=this.viewport.pointFromPixel(c.position);this.panVertical?this.panHorizontal||(d.x=this.viewer.viewport.getCenter(!0).x):d.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(d),this.viewer.viewport.applyConstraints()}}function n(c){var u={tracker:c.eventSource,position:c.position,delta:c.delta,speed:c.speed,direction:c.direction,shift:c.shift,originalEvent:c.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",u),!u.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(c.delta.x=0),this.panVertical||(c.delta.y=0),this.viewer.viewport.flipped&&(c.delta.x=-c.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(c.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(c){c.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(c){var u={tracker:c.eventSource,position:c.position,scroll:c.scroll,shift:c.shift,originalEvent:c.originalEvent,preventDefault:c.preventDefault};this.viewer.raiseEvent("navigator-scroll",u),c.preventDefault=u.preventDefault}function a(c,u){l(c,"rotate("+u+"deg)")}function l(c,u){c.style.webkitTransform=u,c.style.mozTransform=u,c.style.msTransform=u,c.style.oTransform=u,c.style.transform=u}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,l=i,c;for(c=0;c<r.length-1;c++)l=l[r[c]]||{};return o=l[r[c]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(u){var d=parseInt(u.match(/\d+/),10)+1;return d<a.length?a[d]:""})},setString:function(n,r){var o=n.split("."),a=i,l;for(l=0;l<o.length-1;l++)a[o[l]]||(a[o[l]]={}),a=a[o[l]];a[o[l]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var l=i*Math.PI/180;r=Math.cos(l),o=Math.sin(l)}var c=r*(this.x-n.x)-o*(this.y-n.y)+n.x,u=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(c,u)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,l,c){var u=this,d=arguments,p,m;if(e.isPlainObject(n)?p=n:p={width:d[0],height:d[1],tileSize:d[2],tileOverlap:d[3],minLevel:d[4],maxLevel:d[5]},e.EventSource.call(this),e.extend(!0,this,p),!this.success){for(m=0;m<arguments.length;m++)if(e.isFunction(arguments[m])){this.success=arguments[m];break}}this.success&&this.addHandler("ready",function(y){u.success(y)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=p.width&&p.height?p.width/p.height:1,this.dimensions=new e.Point(p.width,p.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=p.tileOverlap?p.tileOverlap:0,this.minLevel=p.minLevel?p.minLevel:0,this.maxLevel=p.maxLevel!==void 0&&p.maxLevel!==null?p.maxLevel:p.width&&p.height?Math.ceil(Math.log(Math.max(p.width,p.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),l=r.x*a,c=r.y*a,u=Math.floor(l/this.getTileWidth(n)),d=Math.floor(c/this.getTileHeight(n));r.x>=1&&(u=this.getNumTiles(n).x-1);var p=1e-15;return r.y>=1/this.aspectRatio-p&&(d=this.getNumTiles(n).y-1),new e.Point(u,d)},getTileBounds:function(n,r,o,a){var l=this.dimensions.times(this.getLevelScale(n)),c=this.getTileWidth(n),u=this.getTileHeight(n),d=r===0?0:c*r-this.tileOverlap,p=o===0?0:u*o-this.tileOverlap,m=c+(r===0?1:2)*this.tileOverlap,y=u+(o===0?1:2)*this.tileOverlap,_=1/l.x;return m=Math.min(m,l.x-d),y=Math.min(y,l.y-p),a?new e.Rect(0,0,m,y):new e.Rect(d*_,p*_,m*_,y*_)},getImageInfo:function(n){var r=this,o,a,l,c,u,d,p;n&&(u=n.split("/"),d=u[u.length-1],p=d.lastIndexOf("."),p>-1&&(u[u.length-1]=d.slice(0,p)));var m=null;if(this.splitHashDataForPost){var y=n.indexOf("#");y!==-1&&(m=n.substring(y+1),n=n.substr(0,y))}a=function(_){typeof _=="string"&&(_=e.parseXml(_));var T=e.TileSource.determineType(r,_,n);if(!T){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}c=T.prototype.configure.apply(r,[_,n,m]),c.ajaxWithCredentials===void 0&&(c.ajaxWithCredentials=r.ajaxWithCredentials),l=new T(c),r.ready=!0,r.raiseEvent("ready",{tileSource:l})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:m,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(_){var T=i(_);a(T)},error:function(_,T){var x;try{x="HTTP "+_.status+" attempting to load TileSource: "+n}catch{var V;typeof T>"u"||!T.toString?V="Unknown error":V=T.toString(),x=V+" attempting to load TileSource: "+n}e.console.error(x),r.raiseEvent("open-failed",{message:x,source:n,postData:m})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,l,c){function u(d){return l?d+"+"+JSON.stringify(l):d}return u(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(l){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(l?null:o,r.request,l)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(l){var c;try{c=new window.Blob([l.response])}catch(p){var u=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(p.name==="TypeError"&&u){var d=new u;d.append(l.response),c=d.getBlob()}}c.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(c)},error:function(l){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,l;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{l=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{l=n.responseText}else if(r.match(/\s*[{[].*/))try{l=e.parseJSON(r)}catch{l=r}else l=r;return l}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,l,c,u,d,p,m){var y,_,T,x;if(e.isPlainObject(r)?x=r:x={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=x.tilesUrl,this.fileFormat=x.fileFormat,this.displayRects=x.displayRects,this.displayRects)for(y=this.displayRects.length-1;y>=0;y--)for(_=this.displayRects[y],T=_.minLevel;T<=_.maxLevel;T++)this._levelRects[T]||(this._levelRects[T]=[]),this._levelRects[T].push(_);e.TileSource.apply(this,[x])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var l;return e.isPlainObject(r)?l=n(this,r):l=i(this,r),o&&!l.tilesUrl&&(l.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?l.queryParams=o.match(/\?.*/):l.queryParams=""),l},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var l=this._levelRects[r],c,u,d,p,m,y,_;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!l||!l.length)return!0;for(_=l.length-1;_>=0;_--)if(c=l[_],!(r<c.minLevel||r>c.maxLevel)&&(u=this.getLevelScale(r),d=c.x*u,p=c.y*u,m=d+c.width*u,y=p+c.height*u,d=Math.floor(d/this._tileWidth),p=Math.floor(p/this._tileWidth),m=Math.ceil(m/this._tileWidth),y=Math.ceil(y/this._tileWidth),d<=o&&o<m&&p<=a&&a<y))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,l=a.localName||a.tagName,c=o.documentElement.namespaceURI,u=null,d=[],p,m,y,_,T;if(l==="Image")try{if(_=a.getElementsByTagName("Size")[0],_===void 0&&(_=a.getElementsByTagNameNS(c,"Size")[0]),u={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(_.getAttribute("Height"),10),Width:parseInt(_.getAttribute("Width"),10)}}},!e.imageFormatSupported(u.Image.Format))throw new Error(e.getString("Errors.ImageFormat",u.Image.Format.toUpperCase()));for(p=a.getElementsByTagName("DisplayRect"),p===void 0&&(p=a.getElementsByTagNameNS(c,"DisplayRect")[0]),T=0;T<p.length;T++)m=p[T],y=m.getElementsByTagName("Rect")[0],y===void 0&&(y=m.getElementsByTagNameNS(c,"Rect")[0]),d.push({Rect:{X:parseInt(y.getAttribute("X"),10),Y:parseInt(y.getAttribute("Y"),10),Width:parseInt(y.getAttribute("Width"),10),Height:parseInt(y.getAttribute("Height"),10),MinLevel:parseInt(m.getAttribute("MinLevel"),10),MaxLevel:parseInt(m.getAttribute("MaxLevel"),10)}});return d.length&&(u.Image.DisplayRect=d),n(r,u)}catch(L){throw L instanceof Error?L:new Error(e.getString("Errors.Dzi"))}else{if(l==="Collection")throw new Error(e.getString("Errors.Dzc"));if(l==="Error"){var x=a.getElementsByTagName("Message")[0],V=x.firstChild.nodeValue;throw new Error(V)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,l=a.Url,c=a.Format,u=a.Size,d=a.DisplayRect||[],p=parseInt(u.Width,10),m=parseInt(u.Height,10),y=parseInt(a.TileSize,10),_=parseInt(a.Overlap,10),T=[],x,V;for(V=0;V<d.length;V++)x=d[V].Rect,T.push(new e.DisplayRect(parseInt(x.X,10),parseInt(x.Y,10),parseInt(x.Width,10),parseInt(x.Height,10),parseInt(x.MinLevel,10),parseInt(x.MaxLevel,10)));return e.extend(!0,{width:p,height:m,tileSize:y,tileOverlap:_,minLevel:null,maxLevel:null,tilesUrl:l,fileFormat:c,displayRects:T},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var l=0;l<this.tiles.length;l++)for(var c=0;c<this.tiles[l].scaleFactors.length;c++){var u=this.tiles[l].scaleFactors[c];this.scale_factors.push(u),a.tileSizePerScaleFactor[u]={width:this.tiles[l].width,height:this.tiles[l].height||this.tiles[l].width}}}else if(i(a)){for(var d=Math.min(this.height,this.width),p=[256,512,1024],m=[],y=0;y<p.length;y++)p[y]<=d&&m.push(p[y]);m.length>0?a.tileSize=Math.max.apply(null,m):a.tileSize=d}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var _=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(_)*Math.LOG2E)}if(this.sizes){var T=this.sizes.length;(T===a.maxLevel||T===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((x,V)=>x.width-V.width),T===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,l){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,l,c){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=l.replace("/info.json",""),a.version=1;else{var d=a["@context"];if(Array.isArray(d)){for(var p=0;p<d.length;p++)if(typeof d[p]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(d[p])||d[p]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){d=d[p];break}}switch(d){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var m=0;m<a.preferredFormats.length;m++)if(t.imageFormatSupported(a.preferredFormats[m])){a.tileFormat=a.preferredFormats[m];break}}return a}else{var u=r(a);return u["@context"]="http://iiif.io/api/image/1.0/context.json",u["@id"]=l.replace("/info.xml",""),u.version=1,u}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var l=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[l]?this.tileSizePerScaleFactor[l].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var l=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[l]?this.tileSizePerScaleFactor[l].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var l=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(l=this.levels[a].width/this.levels[this.maxLevel].width),l}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var l=this.getLevelScale(a);return l?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var c=this.levelSizes[a],u=Math.ceil(c.width/this.getTileWidth(a)),d=Math.ceil(c.height/this.getTileHeight(a));return new e.Point(u,d)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,l){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var c=l.x>=0&&l.x<=1&&l.y>=0&&l.y<=1/this.aspectRatio;e.console.assert(c,"[TileSource.getTileAtPoint] must be called with a valid point.");var u=this.levelSizes[a].width,d=l.x*u,p=l.y*u,m=Math.floor(d/this.getTileWidth(a)),y=Math.floor(p/this.getTileHeight(a));l.x>=1&&(m=this.getNumTiles(a).x-1);var _=1e-15;return l.y>=1/this.aspectRatio-_&&(y=this.getNumTiles(a).y-1),new e.Point(m,y)}return e.TileSource.prototype.getTileAtPoint.call(this,a,l)},getTileUrl:function(a,l,c){if(this.emulateLegacyImagePyramid){var u=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(u=this.levels[a].url),u}var d="0",p=Math.pow(.5,this.maxLevel-a),m,y,_,T,x,V,L,W,J,ee,F,E,P,M,k,D;return this.levelSizes?(m=this.levelSizes[a].width,y=this.levelSizes[a].height):(m=Math.ceil(this.width*p),y=Math.ceil(this.height*p)),_=this.getTileWidth(a),T=this.getTileHeight(a),x=Math.round(_/p),V=Math.round(T/p),this.version===1?k="native."+this.tileFormat:k="default."+this.tileFormat,m<_&&y<T?(this.version===2&&m===this.width?E="full":this.version===3&&m===this.width&&y===this.height?E="max":this.version===3?E=m+","+y:E=m+",",L="full"):(W=l*x,J=c*V,ee=Math.min(x,this.width-W),F=Math.min(V,this.height-J),l===0&&c===0&&ee===this.width&&F===this.height?L="full":L=[W,J,ee,F].join(","),P=Math.min(_,m-l*_),M=Math.min(T,y-c*T),this.version===2&&P===this.width?E="full":this.version===3&&P===this.width&&M===this.height?E="max":this.version===3?E=P+","+M:E=P+","),D=[this._id,L,E,d,k].join("/"),D},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var l=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],c=Array.isArray(a.profile)?a.profile[0]:a.profile,u=l.indexOf(c)!==-1,d=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(d=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(d=a.extraFeatures.indexOf("sizeByWh")!==-1),!u||d}function n(a){for(var l=[],c=0;c<a.sizes.length;c++)l.push({url:a._id+"/full/"+a.sizes[c].width+","+(a.version===3?a.sizes[c].height:"")+"/0/default."+a.tileFormat,width:a.sizes[c].width,height:a.sizes[c].height});return l.sort(function(u,d){return u.width-d.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var l=a.documentElement,c=l.tagName,u=null;if(c==="info")try{return u={},o(l,u),u}catch(d){throw d instanceof Error?d:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,l,c){var u,d;if(a.nodeType===3&&c)d=a.nodeValue.trim(),d.match(/^\d*$/)&&(d=Number(d)),l[c]?(e.isArray(l[c])||(l[c]=[l[c]]),l[c].push(d)):l[c]=d;else if(a.nodeType===1)for(u=0;u<a.childNodes.length;u++)o(a.childNodes[u],l,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var l;e.isPlainObject(i)?l=i:l={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!l.width||!l.height)&&(l.width=65572864,l.height=65572864),l.tileSize||(l.tileSize=256,l.tileOverlap=0),l.tilesUrl||(l.tilesUrl="http://tile.openstreetmap.org/"),l.minLevel=8,e.TileSource.apply(this,[l])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var l;e.isPlainObject(i)?l=i:l={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var c=Math.ceil(l.width/256)*256,u=Math.ceil(l.height/256)*256,d;c>u?d=c/256:d=u/256,l.maxLevel=Math.ceil(Math.log(d)/Math.log(2))-1,l.tileSize=256,l.width=c,l.height=u,e.TileSource.apply(this,[l])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},l=0;l<i;l++)a=this.gridSize[l],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,l,c;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(l=a.levels[a.levels.length-1].width,c=a.levels[a.levels.length-1].height):(l=0,c=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:l,height:c,tileSize:Math.max(c,l),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,l){var c;return e.isPlainObject(o)?c=r(this,o):c=n(this,o),c},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,l){var c=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(c=this.levels[o].url),c}});function i(o){var a=[],l,c;for(c=0;c<o.length;c++)l=o[c],l.height&&l.width&&l.url?a.push({url:l.url,width:Number(l.width),height:Number(l.height)}):e.console.error("Unsupported image format: %s",l.url?l.url:"<no URL>");return a.sort(function(u,d){return u.height-d.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var l=a.documentElement,c=l.tagName,u=null,d=[],p,m;if(c==="image")try{for(u={type:l.getAttribute("type"),levels:[]},d=l.getElementsByTagName("level"),m=0;m<d.length;m++)p=d[m],u.levels.push({url:p.getAttribute("url"),width:parseInt(p.getAttribute("width"),10),height:parseInt(p.getAttribute("height"),10)});return r(o,u)}catch(y){throw y instanceof Error?y:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(c==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(c==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+c)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var l=document.createElement("canvas"),c=l.getContext("2d");l.width=n,l.height=r,c.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:c,width:n,height:r}),o=l,a=c}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(c){var u=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},c),this.element=c.element||e.makeNeutralElement("div"),c.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(d){d.insideElementPressed?(a(u,e.ButtonState.DOWN),u.raiseEvent("enter",{originalEvent:d.originalEvent})):d.buttonDownAny||a(u,e.ButtonState.HOVER)},focusHandler:function(d){u.tracker.enterHandler(d),u.raiseEvent("focus",{originalEvent:d.originalEvent})},leaveHandler:function(d){l(u,e.ButtonState.GROUP),d.insideElementPressed&&u.raiseEvent("exit",{originalEvent:d.originalEvent})},blurHandler:function(d){u.tracker.leaveHandler(d),u.raiseEvent("blur",{originalEvent:d.originalEvent})},pressHandler:function(d){a(u,e.ButtonState.DOWN),u.raiseEvent("press",{originalEvent:d.originalEvent})},releaseHandler:function(d){d.insideElementPressed&&d.insideElementReleased?(l(u,e.ButtonState.HOVER),u.raiseEvent("release",{originalEvent:d.originalEvent})):d.insideElementPressed?l(u,e.ButtonState.GROUP):a(u,e.ButtonState.HOVER)},clickHandler:function(d){d.quick&&u.raiseEvent("click",{originalEvent:d.originalEvent})},keyHandler:function(d){d.keyCode===13?(u.raiseEvent("click",{originalEvent:d.originalEvent}),u.raiseEvent("release",{originalEvent:d.originalEvent}),d.preventDefault=!0):d.preventDefault=!1}}),l(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){l(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(c){e.requestAnimationFrame(function(){n(c)})}function n(c){var u,d,p;c.shouldFade&&(u=e.now(),d=u-c.fadeBeginTime,p=1-d/c.fadeLength,p=Math.min(1,p),p=Math.max(0,p),c.imgGroup&&e.setElementOpacity(c.imgGroup,p,!0),p>0&&i(c))}function r(c){c.shouldFade=!0,c.fadeBeginTime=e.now()+c.fadeDelay,window.setTimeout(function(){i(c)},c.fadeDelay)}function o(c){c.shouldFade=!1,c.imgGroup&&e.setElementOpacity(c.imgGroup,1,!0)}function a(c,u){c.element.disabled||(u>=e.ButtonState.GROUP&&c.currentState===e.ButtonState.REST&&(o(c),c.currentState=e.ButtonState.GROUP),u>=e.ButtonState.HOVER&&c.currentState===e.ButtonState.GROUP&&(c.imgHover&&(c.imgHover.style.visibility=""),c.currentState=e.ButtonState.HOVER),u>=e.ButtonState.DOWN&&c.currentState===e.ButtonState.HOVER&&(c.imgDown&&(c.imgDown.style.visibility=""),c.currentState=e.ButtonState.DOWN))}function l(c,u){c.element.disabled||(u<=e.ButtonState.HOVER&&c.currentState===e.ButtonState.DOWN&&(c.imgDown&&(c.imgDown.style.visibility="hidden"),c.currentState=e.ButtonState.HOVER),u<=e.ButtonState.GROUP&&c.currentState===e.ButtonState.HOVER&&(c.imgHover&&(c.imgHover.style.visibility="hidden"),c.currentState=e.ButtonState.GROUP),u<=e.ButtonState.REST&&c.currentState===e.ButtonState.GROUP&&(r(c),c.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var l;for(l=0;l<r.buttons.length;l++)r.buttons[l].notifyGroupEnter()},leaveHandler:function(a){var l;if(!a.insideElementPressed)for(l=0;l<r.buttons.length;l++)r.buttons[l].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var l,c;this.degrees>=270?(l=this.getTopRight(),this.x=l.x,this.y=l.y,c=this.height,this.height=this.width,this.width=c,this.degrees-=270):this.degrees>=180?(l=this.getBottomRight(),this.x=l.x,this.y=l.y,this.degrees-=180):this.degrees>=90&&(l=this.getBottomLeft(),this.x=l.x,this.y=l.y,c=this.height,this.height=this.width,this.width=c,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),l=n.minus(i),c=Math.atan(l.y/l.x);return l.x<0?c+=Math.PI:l.y<0&&(c+=2*Math.PI),new e.Rect(i.x,i.y,o,a,c/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),l=Math.max(n.x+n.width,r.x+r.width),c=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,l-o,c-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var l=this.getBottomLeft();i.containsPoint(l,n)&&r.push(l);var c=this.getBottomRight();i.containsPoint(c,n)&&r.push(c);var u=i.getTopLeft();this.containsPoint(u,n)&&r.push(u);var d=i.getTopRight();this.containsPoint(d,n)&&r.push(d);var p=i.getBottomLeft();this.containsPoint(p,n)&&r.push(p);var m=i.getBottomRight();this.containsPoint(m,n)&&r.push(m);for(var y=this._getSegments(),_=i._getSegments(),T=0;T<y.length;T++)for(var x=y[T],V=0;V<_.length;V++){var L=_[V],W=J(x[0],x[1],L[0],L[1]);W&&r.push(W)}function J(D,I,Ce,q){var ne=I.minus(D),te=q.minus(Ce),$=-te.x*ne.y+ne.x*te.y;if($===0)return null;var H=(ne.x*(D.y-Ce.y)-ne.y*(D.x-Ce.x))/$,se=(te.x*(D.y-Ce.y)-te.y*(D.x-Ce.x))/$;return-n<=H&&H<=1-n&&-n<=se&&se<=1-n?new e.Point(D.x+se*ne.x,D.y+se*ne.y):null}if(r.length===0)return null;for(var ee=r[0].x,F=r[0].x,E=r[0].y,P=r[0].y,M=1;M<r.length;M++){var k=r[M];k.x<ee&&(ee=k.x),k.x>F&&(F=k.x),k.y<E&&(E=k.y),k.y>P&&(P=k.y)}return new e.Rect(ee,E,F-ee,P-E)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(c){var u=1e-15;return Math.abs(c)<u?0:c});var l=Math.atan(a.y/a.x);return a.x<0?l+=Math.PI:a.y<0&&(l+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,l/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),l=Math.max(i.x,n.x,r.x,o.x),c=Math.min(i.y,n.y,r.y,o.y),u=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,c,l-a,u-c)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),l=o.minus(r),c=a.minus(r);return(i.x-r.x)*l.x+(i.y-r.y)*l.y>=-n&&(i.x-o.x)*l.x+(i.y-o.y)*l.y<=n&&(i.x-r.x)*c.x+(i.y-r.y)*c.y>=-n&&(i.x-a.x)*c.x+(i.y-a.y)*c.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(p){var m=this,y=p.viewer,_=e.getElementSize(y.element),T,x,V;for(p.id||(p.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=p.id,this.element.className="referencestrip"),p=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},p,{element:this.element}),e.extend(this,p),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,x=this.element.style,x.marginTop="0px",x.marginRight="0px",x.marginBottom="0px",x.marginLeft="0px",x.left="0px",x.bottom="0px",x.border="0px",x.background="#000",x.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=y,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,l),leaveHandler:e.delegate(this,c),keyDownHandler:e.delegate(this,u),keyHandler:e.delegate(this,d),preProcessEventHandler:function(L){L.eventType==="wheel"&&(L.preventDefault=!0)}}),p.width&&p.height?(this.element.style.width=p.width+"px",this.element.style.height=p.height+"px",y.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):p.scroll==="horizontal"?(this.element.style.width=_.x*p.sizeRatio*y.tileSources.length+12*y.tileSources.length+"px",this.element.style.height=_.y*p.sizeRatio+"px",y.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=_.y*p.sizeRatio*y.tileSources.length+12*y.tileSources.length+"px",this.element.style.width=_.x*p.sizeRatio+"px",y.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=_.x*this.sizeRatio+8,this.panelHeight=_.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},V=0;V<y.tileSources.length;V++)T=e.makeNeutralElement("div"),T.id=this.element.id+"-"+V,T.style.width=m.panelWidth+"px",T.style.height=m.panelHeight+"px",T.style.display="inline",T.style.float="left",T.style.cssFloat="left",T.style.padding="2px",e.setElementTouchActionNone(T),e.setElementPointerEventsNone(T),this.element.appendChild(T),T.activePanel=!1,this.panels.push(T);a(this,this.scroll==="vertical"?_.y:_.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(p){var m=this.element.querySelector("#"+this.element.id+"-"+p),y=e.getElementSize(this.viewer.canvas),_=Number(this.element.style.width.replace("px","")),T=Number(this.element.style.height.replace("px","")),x=-Number(this.element.style.marginLeft.replace("px","")),V=-Number(this.element.style.marginTop.replace("px","")),L;this.currentSelected!==m&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=m,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(L=Number(p)*(this.panelWidth+3),L>x+y.x-this.panelWidth?(L=Math.min(L,_-y.x),this.element.style.marginLeft=-L+"px",a(this,y.x,-L)):L<x&&(L=Math.max(0,L-y.x/2),this.element.style.marginLeft=-L+"px",a(this,y.x,-L))):(L=Number(p)*(this.panelHeight+3),L>V+y.y-this.panelHeight?(L=Math.min(L,T-y.y),this.element.style.marginTop=-L+"px",a(this,y.y,-L)):L<V&&(L=Math.max(0,L-y.y/2),this.element.style.marginTop=-L+"px",a(this,y.y,-L))),this.currentPage=p,l.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var p in this.miniViewers)this.miniViewers[p].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(p){if(p.quick){var m;this.scroll==="horizontal"?m=Math.floor(p.position.x/(this.panelWidth+4)):m=Math.floor(p.position.y/this.panelHeight),this.viewer.goToPage(m)}this.element.focus()}function r(p){if(this.dragging=!0,this.element){var m=Number(this.element.style.marginLeft.replace("px","")),y=Number(this.element.style.marginTop.replace("px","")),_=Number(this.element.style.width.replace("px","")),T=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-p.delta.x>0?m>-(_-x.x)&&(this.element.style.marginLeft=m+p.delta.x*2+"px",a(this,x.x,m+p.delta.x*2)):-p.delta.x<0&&m<0&&(this.element.style.marginLeft=m+p.delta.x*2+"px",a(this,x.x,m+p.delta.x*2)):-p.delta.y>0?y>-(T-x.y)&&(this.element.style.marginTop=y+p.delta.y*2+"px",a(this,x.y,y+p.delta.y*2)):-p.delta.y<0&&y<0&&(this.element.style.marginTop=y+p.delta.y*2+"px",a(this,x.y,y+p.delta.y*2))}}function o(p){if(this.element){var m=Number(this.element.style.marginLeft.replace("px","")),y=Number(this.element.style.marginTop.replace("px","")),_=Number(this.element.style.width.replace("px","")),T=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?p.scroll>0?m>-(_-x.x)&&(this.element.style.marginLeft=m-p.scroll*60+"px",a(this,x.x,m-p.scroll*60)):p.scroll<0&&m<0&&(this.element.style.marginLeft=m-p.scroll*60+"px",a(this,x.x,m-p.scroll*60)):p.scroll<0?y>x.y-T&&(this.element.style.marginTop=y+p.scroll*60+"px",a(this,x.y,y+p.scroll*60)):p.scroll>0&&y<0&&(this.element.style.marginTop=y+p.scroll*60+"px",a(this,x.y,y+p.scroll*60)),p.preventDefault=!0}}function a(p,m,y){var _,T,x,V,L,W;for(p.scroll==="horizontal"?_=p.panelWidth:_=p.panelHeight,T=Math.ceil(m/_)+5,x=Math.ceil((Math.abs(y)+m)/_)+1,T=x-T,T=T<0?0:T,L=T;L<x&&L<p.panels.length;L++)if(W=p.panels[L],!W.activePanel){var J,ee=p.viewer.tileSources[L];ee.referenceStripThumbnailUrl?J={type:"image",url:ee.referenceStripThumbnailUrl}:J=ee,V=new e.Viewer({id:W.id,tileSources:[J],element:W,navigatorSizeRatio:p.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:p.viewer.loadTilesWithAjax,ajaxHeaders:p.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(V.canvas),e.setElementPointerEventsNone(V.container),V.innerTracker.setTracking(!1),V.outerTracker.setTracking(!1),p.miniViewers[W.id]=V,W.activePanel=!0}}function l(p){var m=p.eventSource.element;this.scroll==="horizontal"?m.style.marginBottom="0px":m.style.marginLeft="0px"}function c(p){var m=p.eventSource.element;this.scroll==="horizontal"?m.style.marginBottom="-"+e.getElementSize(m).y/2+"px":m.style.marginLeft="-"+e.getElementSize(m).x/2+"px"}function u(p){if(!p.ctrl&&!p.alt&&!p.meta)switch(p.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;default:p.preventDefault=!1;break}else p.preventDefault=!1}function d(p){if(!p.ctrl&&!p.alt&&!p.meta)switch(p.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;default:p.preventDefault=!1;break}else p.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,l){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=l},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(u){i(o,u,n.callback)},l={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},c=new e.ImageJob(l);!this.jobLimit||this.jobsInProgress<this.jobLimit?(c.start(),this.jobsInProgress++):this.jobQueue.push(c)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,l,c,u,d,p,m,y){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=p,this.exists=a,this._url=l,this.postData=m,this.context2D=c,this.loadWithAjax=u,this.ajaxHeaders=d,y===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),y=e.TileSource.prototype.getTileHashKey(i,n,r,l,d,m)),this.cacheKey=y,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(l){return l%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,l=this.size=o.size,c="";n.overlayPreserveContentDirection&&(c=n.flipped?" scaleX(-1)":" scaleX(1)");var u=n.flipped?-o.rotate:o.rotate,d=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,l,this.element);else{var p=this.style,m=this.element.style;m.display="block",p.left=a.x+"px",p.top=a.y+"px",this.width!==null&&(m.width=l.x+"px"),this.height!==null&&(m.height=l.y+"px");var y=e.getCssPropertyWithVendorPrefix("transformOrigin"),_=e.getCssPropertyWithVendorPrefix("transform");y&&_&&(u&&!n.flipped?(m[_]="",p[y]=this._getTransformOrigin(),p[_]="rotate("+u+"deg)"):!u&&n.flipped?(m[_]=c,p[y]=this._getTransformOrigin(),p[_]=d):u&&n.flipped?(m[_]=c,p[y]=this._getTransformOrigin(),p[_]="rotate("+u+"deg)"+d):(m[_]="",p[y]="",p[_]="")),p.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),l=this._getBoundingBox(a,i.getRotation(!0));n=l.getTopLeft(),r=l.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(l){l.opacity!==0&&a._drawTiles(l)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(u=>u.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var l=a.length-1;l>=0;l--){var c=a[l];this._drawTile(c),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:c})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var l=o.getImage();if(!l)return;o.element=e.makeNeutralElement("div"),o.imgElement=l.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(u){super(u),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let u=e.makeNeutralElement("canvas"),d=this._calculateCanvasSize();return u.width=d.x,u.height=d.y,u}draw(u){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const d of u)d.opacity!==0&&this._drawTiles(d)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(u){return!0}setImageSmoothingEnabled(u){this._imageSmoothingEnabled=!!u,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(u){var d=this.context;d.save(),d.lineWidth=2*e.pixelDensityRatio,d.strokeStyle=this.debugGridColor[0],d.fillStyle=this.debugGridColor[0],d.strokeRect(u.x*e.pixelDensityRatio,u.y*e.pixelDensityRatio,u.width*e.pixelDensityRatio,u.height*e.pixelDensityRatio),d.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(u,d,p,m){this.viewer.raiseEvent("tile-drawing",{tiledImage:u,context:d,tile:p,rendered:m})}_prepareNewFrame(){var u=this._calculateCanvasSize();if((this.canvas.width!==u.x||this.canvas.height!==u.y)&&(this.canvas.width=u.x,this.canvas.height=u.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var d=this._calculateSketchCanvasSize();this.sketchCanvas.width=d.x,this.sketchCanvas.height=d.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(u,d){var p=this._getContext(u);if(d)p.clearRect(d.x,d.y,d.width,d.height);else{var m=p.canvas;p.clearRect(0,0,m.width,m.height)}}_drawTiles(u){var d=u.getTilesToDraw().map(D=>D.tile);if(!(u.opacity===0||d.length===0&&!u.placeholderFillStyle)){var p=d[0],m;p&&(m=u.opacity<1||u.compositeOperation&&u.compositeOperation!=="source-over"||!u._isBottomItem()&&u.source.hasTransparency(p.context2D,p.getUrl(),p.ajaxHeaders,p.postData));var y,_,T=this.viewport.getZoom(!0),x=u.viewportToImageZoom(T);d.length>1&&x>u.smoothTileEdgesMinZoom&&!u.iOSDevice&&u.getRotation(!0)%360===0&&(m=!0,y=p.getScaleForEdgeSmoothing(),_=p.getTranslationForEdgeSmoothing(y,this._getCanvasSize(!1),this._getCanvasSize(!0)));var V;m&&(y||(V=this.viewport.viewportToViewerElementRectangle(u.getClippedBounds(!0)).getIntegerBoundingBox(),V=V.times(e.pixelDensityRatio)),this._clear(!0,V)),y||this._setRotations(u,m);var L=!1;if(u._clip){this._saveContext(m);var W=u.imageToViewportRectangle(u._clip,!0);W=W.rotate(-u.getRotation(!0),u._getRotationPoint(!0));var J=this.viewportToDrawerRectangle(W);y&&(J=J.times(y)),_&&(J=J.translate(_)),this._setClip(J,m),L=!0}if(u._croppingPolygons){var ee=this;L||this._saveContext(m);try{var F=u._croppingPolygons.map(function(D){return D.map(function(I){var Ce=u.imageToViewportCoordinates(I.x,I.y,!0).rotate(-u.getRotation(!0),u._getRotationPoint(!0)),q=ee.viewportCoordToDrawerCoord(Ce);return y&&(q=q.times(y)),_&&(q=q.plus(_)),q})});this._clipWithPolygons(F,m)}catch(D){e.console.error(D)}L=!0}if(u._hasOpaqueTile=!1,u.placeholderFillStyle&&u._hasOpaqueTile===!1){let D=this.viewportToDrawerRectangle(u.getBoundsNoRotate(!0));y&&(D=D.times(y)),_&&(D=D.translate(_));let I=null;typeof u.placeholderFillStyle=="function"?I=u.placeholderFillStyle(u,this.context):I=u.placeholderFillStyle,this._drawRectangle(D,I,m)}var E=l(u.subPixelRoundingForTransparency),P=!1;if(E===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)P=!0;else if(E===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var M=this.viewer&&this.viewer.isAnimating();P=!M}for(var k=0;k<d.length;k++)p=d[k],this._drawTile(p,u,m,y,_,P,u.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:u,tile:p});L&&this._restoreContext(m),y||(u.getRotation(!0)%360!==0&&this._restoreRotationChanges(m),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(m)),m&&(y&&this._setRotations(u),this.blendSketch({opacity:u.opacity,scale:y,translate:_,compositeOperation:u.compositeOperation,bounds:V}),y&&(u.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(u,d),this._raiseTiledImageDrawnEvent(u,d)}}_drawDebugInfo(u,d){if(u.debugMode)for(var p=d.length-1;p>=0;p--){var m=d[p];try{this._drawDebugInfoOnTile(m,d.length,p,u)}catch(y){e.console.error(y)}}}_clipWithPolygons(u,d){var p=this._getContext(d);p.beginPath();for(const m of u)for(const[y,_]of m.entries())p[y===0?"moveTo":"lineTo"](_.x,_.y);p.clip()}_drawTile(u,d,p,m,y,_,T){e.console.assert(u,"[Drawer._drawTile] tile is required"),e.console.assert(d,"[Drawer._drawTile] drawingHandler is required");var x=this._getContext(p);m=m||1,this._drawTileToCanvas(u,x,d,m,y,_,T)}_drawTileToCanvas(u,d,p,m,y,_,T){var x=u.position.times(e.pixelDensityRatio),V=u.size.times(e.pixelDensityRatio),L;if(!u.context2D&&!u.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",u.toString());return}if(L=u.getCanvasContext(),!u.loaded||!L){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",u.toString());return}d.save(),typeof m=="number"&&m!==1&&(x=x.times(m),V=V.times(m)),y instanceof e.Point&&(x=x.plus(y)),d.globalAlpha===1&&u.hasTransparency&&(_&&(x.x=Math.round(x.x),x.y=Math.round(x.y),V.x=Math.round(V.x),V.y=Math.round(V.y)),d.clearRect(x.x,x.y,V.x,V.y)),this._raiseTileDrawingEvent(p,d,u,L);var W,J;u.sourceBounds?(W=Math.min(u.sourceBounds.width,L.canvas.width),J=Math.min(u.sourceBounds.height,L.canvas.height)):(W=L.canvas.width,J=L.canvas.height),d.translate(x.x+V.x/2,0),u.flipped&&d.scale(-1,1),d.drawImage(L.canvas,0,0,W,J,-V.x/2,x.y,V.x,V.y),d.restore()}_getContext(u){var d=this.context;if(u){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var p=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=p.x,this.sketchCanvas.height=p.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var m=this;this.viewer.addHandler("rotate",function y(){if(m.viewport.getRotation()!==0){m.viewer.removeHandler("rotate",y);var _=m._calculateSketchCanvasSize();m.sketchCanvas.width=_.x,m.sketchCanvas.height=_.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}d=this.sketchContext}return d}_saveContext(u){this._getContext(u).save()}_restoreContext(u){this._getContext(u).restore()}_setClip(u,d){var p=this._getContext(d);p.beginPath(),p.rect(u.x,u.y,u.width,u.height),p.clip()}_drawRectangle(u,d,p){var m=this._getContext(p);m.save(),m.fillStyle=d,m.fillRect(u.x,u.y,u.width,u.height),m.restore()}blendSketch(u,d,p,m){var y=u;e.isPlainObject(y)||(y={opacity:u,scale:d,translate:p,compositeOperation:m}),u=y.opacity,m=y.compositeOperation;var _=y.bounds;if(this.context.save(),this.context.globalAlpha=u,m&&(this.context.globalCompositeOperation=m),_)_.x<0&&(_.width+=_.x,_.x=0),_.x+_.width>this.canvas.width&&(_.width=this.canvas.width-_.x),_.y<0&&(_.height+=_.y,_.y=0),_.y+_.height>this.canvas.height&&(_.height=this.canvas.height-_.y),this.context.drawImage(this.sketchCanvas,_.x,_.y,_.width,_.height,_.x,_.y,_.width,_.height);else{d=y.scale||1,p=y.translate;var T=p instanceof e.Point?p:new e.Point(0,0),x=0,V=0;if(p){var L=this.sketchCanvas.width-this.canvas.width,W=this.sketchCanvas.height-this.canvas.height;x=Math.round(L/2),V=Math.round(W/2)}this.context.drawImage(this.sketchCanvas,T.x-x*d,T.y-V*d,(this.canvas.width+2*x)*d,(this.canvas.height+2*V)*d,-x,-V,this.canvas.width+2*x,this.canvas.height+2*V)}this.context.restore()}_drawDebugInfoOnTile(u,d,p,m){var y=this.viewer.world.getIndexOfItem(m)%this.debugGridColor.length,_=this.context;_.save(),_.lineWidth=2*e.pixelDensityRatio,_.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",_.strokeStyle=this.debugGridColor[y],_.fillStyle=this.debugGridColor[y],this._setRotations(m),this._viewportFlipped&&this._flip({point:u.position.plus(u.size.divide(2))}),_.strokeRect(u.position.x*e.pixelDensityRatio,u.position.y*e.pixelDensityRatio,u.size.x*e.pixelDensityRatio,u.size.y*e.pixelDensityRatio);var T=(u.position.x+u.size.x/2)*e.pixelDensityRatio,x=(u.position.y+u.size.y/2)*e.pixelDensityRatio;_.translate(T,x);const V=this.viewport.getRotation(!0);_.rotate(Math.PI/180*-V),_.translate(-T,-x),u.x===0&&u.y===0&&(_.fillText("Zoom: "+this.viewport.getZoom(),u.position.x*e.pixelDensityRatio,(u.position.y-30)*e.pixelDensityRatio),_.fillText("Pan: "+this.viewport.getBounds().toString(),u.position.x*e.pixelDensityRatio,(u.position.y-20)*e.pixelDensityRatio)),_.fillText("Level: "+u.level,(u.position.x+10)*e.pixelDensityRatio,(u.position.y+20)*e.pixelDensityRatio),_.fillText("Column: "+u.x,(u.position.x+10)*e.pixelDensityRatio,(u.position.y+30)*e.pixelDensityRatio),_.fillText("Row: "+u.y,(u.position.x+10)*e.pixelDensityRatio,(u.position.y+40)*e.pixelDensityRatio),_.fillText("Order: "+p+" of "+d,(u.position.x+10)*e.pixelDensityRatio,(u.position.y+50)*e.pixelDensityRatio),_.fillText("Size: "+u.size.toString(),(u.position.x+10)*e.pixelDensityRatio,(u.position.y+60)*e.pixelDensityRatio),_.fillText("Position: "+u.position.toString(),(u.position.x+10)*e.pixelDensityRatio,(u.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),m.getRotation(!0)%360!==0&&this._restoreRotationChanges(),_.restore()}_updateImageSmoothingEnabled(u){u.msImageSmoothingEnabled=this._imageSmoothingEnabled,u.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(u){var d=this._getContext(u).canvas;return new e.Point(d.width,d.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(u,d=!1){var p=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:d,saveContext:p}),p=!1),u.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:u.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(u._getRotationPoint(!0),!0),useSketch:d,saveContext:p})}_offsetForRotation(u){var d=u.point?u.point.times(e.pixelDensityRatio):this._getCanvasCenter(),p=this._getContext(u.useSketch);p.save(),p.translate(d.x,d.y),p.rotate(Math.PI/180*u.degrees),p.translate(-d.x,-d.y)}_flip(u){u=u||{};var d=u.point?u.point.times(e.pixelDensityRatio):this._getCanvasCenter(),p=this._getContext(u.useSketch);p.translate(d.x,0),p.scale(-1,1),p.translate(-d.x,0)}_restoreRotationChanges(u){var d=this._getContext(u);d.restore()}_calculateCanvasSize(){var u=e.pixelDensityRatio,d=this.viewport.getContainerSize();return{x:Math.round(d.x*u),y:Math.round(d.y*u)}}_calculateSketchCanvasSize(){var u=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return u;var d=Math.ceil(Math.sqrt(u.x*u.x+u.y*u.y));return{x:d,y:d}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(c){return c!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&c!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&c!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(c){return o(c)?r:c}function l(c){if(typeof c=="number")return a(c);if(!c||!e.Browser)return r;var u=c[e.Browser.vendor];return o(u)&&(u=c["*"]),a(u)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let l=0;l<o;++l)r.activeTexture(r.TEXTURE0+l),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let l={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},c=this.viewport.flipped?-1:1,u=e.Mat3.makeTranslation(-l.center.x,-l.center.y),d=e.Mat3.makeScaling(2/l.bounds.width*c,-2/l.bounds.height),p=e.Mat3.makeRotation(-l.rotation),m=d.multiply(p).multiply(u);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let y=!1;r.forEach((_,T)=>{if(_.isTainted()){y&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),y=!1);const x=this._getBackupCanvasDrawer();x.draw([_]),this._outputContext.drawImage(x.canvas,0,0)}else{let x=_.getTilesToDraw();if(_.placeholderFillStyle&&_._hasOpaqueTile===!1&&this._drawPlaceholder(_),x.length===0||_.getOpacity()===0)return;let V=x[0],L=_.compositeOperation||this.viewer.compositeOperation||_._clip||_._croppingPolygons||_.debugMode,W=L||_.opacity<1||V.hasTransparency;L&&(y&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),W?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let J=m,ee=_.getRotation(!0);if(ee%360!==0){let D=e.Mat3.makeRotation(-ee*Math.PI/180),I=_.getBoundsNoRotate(!0).getCenter(),Ce=e.Mat3.makeTranslation(I.x,I.y),q=e.Mat3.makeTranslation(-I.x,-I.y),ne=Ce.multiply(D).multiply(q);J=m.multiply(ne)}let F=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(F<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${F}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let E=new Float32Array(F*12),P=new Array(F),M=new Array(F),k=new Array(F);for(let D=0;D<x.length;D++){let I=x[D].tile,Ce=D%F,q=Ce+1,ne=I.getCanvasContext(),te=ne?this._TextureMap.get(ne.canvas):null;if(te||(this._tileReadyHandler({tile:I,tiledImage:_}),te=ne?this._TextureMap.get(ne.canvas):null),te&&this._getTileData(I,_,te,J,Ce,E,P,M,k),q===F||D===x.length-1){for(let $=0;$<=q;$++)o.activeTexture(o.TEXTURE0+$),o.bindTexture(o.TEXTURE_2D,P[$]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,E,o.DYNAMIC_DRAW),M.forEach(($,H)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[H],!1,$)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(k)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*q)}}W&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,_.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),y=!0,L&&(this._applyContext2dPipeline(_,x,T),y=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),T===0&&this._raiseTiledImageDrawnEvent(_,x.map(D=>D.tile))}}),y&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const l=this.viewer.viewport.getFlip();l&&this._flip(),this._drawDebugInfo(o,r,l),l&&this._flip()}}_getTileData(r,o,a,l,c,u,d,p,m){let y=a.texture,_=a.position;u.set(_,c*12);let T=this._calculateOverlapFraction(r,o),x=r.positionedBounds.width*T.x,V=r.positionedBounds.height*T.y,L=r.positionedBounds.x+(r.x===0?0:x),W=r.positionedBounds.y+(r.y===0?0:V),J=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:x),ee=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:V),F=J-L,E=ee-W,P=new e.Mat3([F,0,0,0,E,0,L,W,1]);if(r.flipped){let k=e.Mat3.makeTranslation(.5,0),D=e.Mat3.makeTranslation(-.5,0),I=k.multiply(e.Mat3.makeScaling(-1,1)).multiply(D);P=P.multiply(I)}let M=l.multiply(P);m[c]=r.opacity,d[c]=y,p[c]=M.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(y=>`uniform mat3 u_matrix_${y};`).join(`
`),a=()=>[...Array(r).keys()].map(y=>`${y>0?"else ":""}if(int(a_index) == ${y}) { transform_matrix = u_matrix_${y}; }`).join(`
`);const l=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,c=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let u=this._gl,d=this.constructor.initShaderProgram(u,l,c);u.useProgram(d),this._firstPass={shaderProgram:d,aOutputPosition:u.getAttribLocation(d,"a_output_position"),aTexturePosition:u.getAttribLocation(d,"a_texture_position"),aIndex:u.getAttribLocation(d,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(y=>u.getUniformLocation(d,`u_matrix_${y}`)),uImages:u.getUniformLocation(d,"u_images"),uOpacities:u.getUniformLocation(d,"u_opacities"),bufferOutputPosition:u.createBuffer(),bufferTexturePosition:u.createBuffer(),bufferIndex:u.createBuffer()},u.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let p=new Float32Array(r*12);for(let y=0;y<r;++y)p.set(Float32Array.from(this._unitQuad),y*12);u.bindBuffer(u.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),u.bufferData(u.ARRAY_BUFFER,p,u.STATIC_DRAW),u.enableVertexAttribArray(this._firstPass.aOutputPosition),u.bindBuffer(u.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),u.enableVertexAttribArray(this._firstPass.aTexturePosition),u.bindBuffer(u.ARRAY_BUFFER,this._firstPass.bufferIndex);let m=[...Array(this._glNumTextures).keys()].map(y=>Array(6).fill(y)).flat();u.bufferData(u.ARRAY_BUFFER,new Float32Array(m),u.STATIC_DRAW),u.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,l=this.constructor.initShaderProgram(a,r,o);a.useProgram(l),this._secondPass={shaderProgram:l,aOutputPosition:a.getAttribLocation(l,"a_output_position"),aTexturePosition:a.getAttribLocation(l,"a_texture_position"),uMatrix:a.getUniformLocation(l,"u_matrix"),uImage:a.getUniformLocation(l,"u_image"),uOpacityMultiplier:a.getUniformLocation(l,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let c=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,c.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,l){return new Float32Array([r,l,o,l,r,a,r,a,o,l,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let l=o.getCanvasContext(),c=l&&l.canvas;if(!c||e.isCanvasTainted(c)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(c)){let d=this._gl,p=d.createTexture(),m,y=a.source.tileOverlap,_,T;if(o.sourceBounds?(_=Math.min(o.sourceBounds.width,c.width)/c.width,T=Math.min(o.sourceBounds.height,c.height)/c.height):(_=1,T=1),y>0){let V=this._calculateOverlapFraction(o,a),L=(o.x===0?0:V.x)*_,W=(o.y===0?0:V.y)*T,J=(o.isRightMost?1:1-V.x)*_,ee=(o.isBottomMost?1:1-V.y)*T;m=this._makeQuadVertexBuffer(L,J,W,ee)}else _===1&&T===1?m=this._unitQuad:m=this._makeQuadVertexBuffer(0,_,0,T);let x={texture:p,position:m};this._TextureMap.set(c,x),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,p),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this._textureFilter()),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(l)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,l=r.sourceBounds.width,c=r.sourceBounds.height,u=(r.x===0?0:a)+(r.isRightMost?0:a),d=(r.y===0?0:a)+(r.isBottomMost?0:a),p=a/(l+u),m=a/(c+d);return{x:p,y:m}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(l){e.console.error("Error uploading image data to WebGL",l)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(l=>{let c=r.imageToViewportCoordinates(l.x,l.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(c)});this._clippingContext.beginPath(),a.forEach((l,c)=>{this._clippingContext[c===0?"moveTo":"lineTo"](l.x,l.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(l=>{let c=r.imageToViewportCoordinates(l.x,l.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(c)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((l,c)=>{this._clippingContext[c===0?"moveTo":"lineTo"](l.x,l.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var l=r.length-1;l>=0;l--){var c=r[l].tile;try{this._drawDebugInfoOnTile(c,r.length,l,o,a)}catch(u){e.console.error(u)}}}_drawDebugInfoOnTile(r,o,a,l,c){var u=this.viewer.world.getIndexOfItem(l)%this.debugGridColor.length,d=this.context;d.save(),d.lineWidth=2*e.pixelDensityRatio,d.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",d.strokeStyle=this.debugGridColor[u],d.fillStyle=this.debugGridColor[u],this._setRotations(l),c&&this._flip({point:r.position.plus(r.size.divide(2))}),d.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var p=(r.position.x+r.size.x/2)*e.pixelDensityRatio,m=(r.position.y+r.size.y/2)*e.pixelDensityRatio;d.translate(p,m);const y=this.viewport.getRotation(!0);d.rotate(Math.PI/180*-y),d.translate(-p,-m),r.x===0&&r.y===0&&(d.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),d.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),d.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),d.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),d.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),d.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),d.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),d.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.getRotation(!0)%360!==0&&this._restoreRotationChanges(),d.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),l=this._outputContext;let c;typeof r.placeholderFillStyle=="function"?c=r.placeholderFillStyle(r,l):c=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),l.fillStyle=c,l.translate(a.x,a.y),l.rotate(Math.PI/180*o.degrees),l.translate(-a.x,-a.y),l.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function l(p,m,y){const _=p.createShader(m);return p.shaderSource(_,y),p.compileShader(_),p.getShaderParameter(_,p.COMPILE_STATUS)?_:(e.console.error(`An error occurred compiling the shaders: ${p.getShaderInfoLog(_)}`),p.deleteShader(_),null)}const c=l(r,r.VERTEX_SHADER,o),u=l(r,r.FRAGMENT_SHADER,a),d=r.createProgram();return r.attachShader(d,c),r.attachShader(d,u),r.linkProgram(d),r.getProgramParameter(d,r.LINK_STATUS)?d:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(d)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,l,c,u,d,p,m;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),l=1/a,c=l/this.getAspectRatio(),u=new e.Rect(n.x-l/2,n.y-c/2,l,c),d=this._pixelFromPoint(this.zoomPoint,u),p=d.minus(o).rotate(-this.getRotation(!0)),m=p.divide(this._containerInnerSize.x*a),r.plus(m)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var l=n.x+n.width,c=r.x+r.width,u,d,p;n.width>r.width?u=this.visibilityRatio*r.width:u=this.visibilityRatio*n.width,d=r.x-l+u,p=c-n.x-u,u>r.width?(n.x+=(d+p)/2,o=!0):p<0?(n.x+=p,o=!0):d>0&&(n.x+=d,o=!0)}if(!this.wrapVertical){var m=n.y+n.height,y=r.y+r.height,_,T,x;n.height>r.height?_=this.visibilityRatio*r.height:_=this.visibilityRatio*n.height,T=r.y-m+_,x=y-n.y-_,_>r.height?(n.y+=(T+x)/2,a=!0):x<0?(n.y+=x,a=!0):T>0&&(n.y+=T,a=!0)}var V=o||a,L=V?this.viewerElementToViewportRectangle(n):i.clone();return L.xConstrained=o,L.yConstrained=a,L.constraintApplied=V,L},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),l=i.getCenter(),c=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();c.getAspectRatio()>=a?c.height=c.width/a:c.width=c.height*a,c.x=l.x-c.width/2,c.y=l.y-c.height/2;var u=1/c.width;if(r)return this.panTo(l,!0),this.zoomTo(u,null,!0),o&&this.applyConstraints(!0),this;var d=this.getCenter(!0),p=this.getZoom(!0);this.panTo(d,!0),this.zoomTo(p,null,!0);var m=this.getBounds(),y=this.getZoom();if(y===0||Math.abs(u/y-1)<1e-8)return this.zoomTo(u,null,!0),this.panTo(l,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(l,!1),u=this._applyZoomConstraints(u),this.zoomTo(u,null,!1);var _=this.getConstrainedBounds();this.panTo(d,!0),this.zoomTo(p,null,!0),this.fitBounds(_)}else{var T=c.rotate(-this.getRotation()),x=T.getTopLeft().times(u).minus(m.getTopLeft().times(y)).divide(u-y);this.zoomTo(u,x,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),l=e.positiveModulo(i,360),c=l-a;c>180?l-=360:c<-180&&(l+=360);var u=a-l;this.degreesSpring.resetTo(i+u),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var l=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),l},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var l=this.viewer.world.getItemCount();if(l>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(l===1){var c=this.viewer.world.getItemAt(0);return c.imageToViewportRectangle(i,n,r,o,!0)}}var u=this.imageToViewportCoordinates(a.x,a.y),d=this._imageToViewportDelta(a.width,a.height);return new e.Rect(u.x,u.y,d.x,d.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var l=this.viewer.world.getItemCount();if(l>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(l===1){var c=this.viewer.world.getItemAt(0);return c.viewportToImageRectangle(i,n,r,o,!0)}}var u=this.viewportToImageCoordinates(a.x,a.y),d=this._viewportToImageDelta(a.width,a.height);return new e.Rect(u.x,u.y,d.x,d.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,l=this._contentBoundsNoRotate.width,c=a/o*l;return i*c},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,l=this._contentBoundsNoRotate.width,c=o/a/l;return i*c},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var l=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var c=i.degrees||0;delete i.degrees;var u=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:c,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,l,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(u,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),l=n||r||o||a||this._needsUpdate;if(l||i||!this._fullyLoaded){let c=this._updateLevelsForViewport();this._setFullyLoaded(c)}return this._needsUpdate=!1,l?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,l=(o.y+r%o.y)%o.y,c=this.source.getTileBounds(i,a,l);return this.getFlip()&&(c.x=Math.max(0,1-c.x-c.width)),c.x+=(n-a)/o.x,c.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-l)/o.y),c},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var l=i;l instanceof e.Rect?a=n:l=new e.Rect(i,n,r,o);var c=this.imageToViewportCoordinates(l.getTopLeft(),a),u=this._imageToViewportDelta(l.width,l.height,a);return new e.Rect(c.x,c.y,u.x,u.y,l.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var l=i;i instanceof e.Rect?a=n:l=new e.Rect(i,n,r,o);var c=this.viewportToImageCoordinates(l.getTopLeft(),a),u=this._viewportToImageDelta(l.width,l.height,a);return new e.Rect(c.x,c.y,u.x,u.y,l.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,l=0,c=0,u=1,d=1;if(this._clip&&(a=this._clip.getAspectRatio(),u=this._clip.width/this.source.dimensions.x,d=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(l=this._clip.x/this._clip.height*i.height,c=this._clip.y/this._clip.height*i.height):(l=this._clip.x/this._clip.width*i.width,c=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var p=i.height/d,m=0;o.isHorizontallyCentered?m=(i.width-i.height*a)/2:o.isRight&&(m=i.width-i.height*a),this.setPosition(new e.Point(i.x-l+m,i.y-c),r),this.setHeight(p,r)}else{var y=i.width/u,_=0;o.isVerticallyCentered?_=(i.height-i.width/a)/2:o.isBottom&&(_=i.height-i.width/a),this.setPosition(new e.Point(i.x-l,i.y-c+_),r),this.setWidth(y,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var l in this.tilesMatrix){n=this.source.getNumTiles(l);for(var c in this.tilesMatrix[l]){r=(n.x+c%n.x)%n.x;for(var u in this.tilesMatrix[l][c])if(o=(n.y+u%n.y)%n.y,a=this.tilesMatrix[l][c][u],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var d=this.source.getTileAjaxHeaders(l,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,d)}else a.ajaxHeaders=null}}for(var p=0;p<this._imageLoader.jobQueue.length;p++){var m=this._imageLoader.jobQueue[p];m.loadWithAjax=m.tile.loadWithAjax,m.ajaxHeaders=m.tile.loadWithAjax?m.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),l=e.now();if(this._lastDrawn.forEach(J=>{J.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var c=new Array(r-n+1);for(let J=0,ee=r;ee>=n;ee--,J++)c[J]=ee;for(let J=r+1;J<=this.source.maxLevel;J++){var u=this.tilesMatrix[J]&&this.tilesMatrix[J][0]&&this.tilesMatrix[J][0][0];if(u&&u.isBottomMost&&u.isRightMost&&u.loaded){c.push(J);break}}let d=!1;for(let J=0;J<c.length;J++){let ee=c[J];var p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(ee),!0).x*this._scaleSpring.current.value;if(J===c.length-1||p>=this.minPixelRatio)d=!0;else if(!d)continue;var m=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(ee),!1).x*this._scaleSpring.current.value,y=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,_=this.immediateRender?1:y,T=Math.min(1,(p-.5)/.5),x=_/Math.abs(_-m),V=this._updateLevel(ee,T,x,a,l,o);o=V.bestTiles;var L=V.updatedTiles.filter(F=>F.loaded),W=function(F,E,P){return function(M){return{tile:M,level:F,levelOpacity:E,currentTime:P}}}(ee,T,l);if(this._tilesToDraw[ee]=L.map(W),this._providesCoverage(this.coverage,ee))break}return o&&o.length>0?(o.forEach(function(J){J&&!J.context2D&&this._loadTile(J,l)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function l(u){let d=u.tile;if(d&&d.loaded){let p=r._blendTile(d,d.x,d.y,u.level,u.levelOpacity,n,o);r._isBlending=r._isBlending||p,r._needsDraw=r._needsDraw||p||r._wasBlending}}let c=0;for(let u=0;u<i.length;u++){let d=i[u];l(d),this._providesCoverage(this.coverage,d.level)&&(c=Math.max(c,d.level))}if(c>0)for(let u in this._tilesToDraw)u<c&&delete this._tilesToDraw[u]},_blendTile:function(i,n,r,o,a,l,c){let u=1e3*this.blendTime,d,p;return i.blendStart||(i.blendStart=l),d=l-i.blendStart,p=u?Math.min(1,d/u):1,o===c&&(p=1,d=u),this.alwaysBlend&&(p*=a),i.opacity=p,p===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),d<u},_updateLevel:function(i,n,r,o,a,l){var c=o.getBoundingBox().getTopLeft(),u=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:c,bottomright:u,currenttime:a,best:l}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var d=this._getCornerTiles(i,c,u),p=d.topLeft,m=d.bottomRight,y=this.source.getNumTiles(i),_=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(m.x+=1,this.wrapHorizontal||(m.x=Math.min(m.x,y.x-1)));for(var T=Math.max(0,(m.x-p.x)*(m.y-p.y)),x=new Array(T),V=0,L=p.x;L<=m.x;L++)for(var W=p.y;W<=m.y;W++){var J;if(this.getFlip()){var ee=(y.x+L%y.x)%y.x;J=L+y.x-ee-ee-1}else J=L;if(o.intersection(this.getTileBounds(i,J,W))!==null){var F=this._updateTile(J,W,i,r,_,y,a,l);l=F.bestTiles,x[V]=F.tile,V+=1}}return{bestTiles:l,updatedTiles:x}},_positionTile:function(i,n,r,o,a){var l=i.bounds.getTopLeft();l.x*=this._scaleSpring.current.value,l.y*=this._scaleSpring.current.value,l.x+=this._xSpring.current.value,l.y+=this._ySpring.current.value;var c=i.bounds.getSize();c.x*=this._scaleSpring.current.value,c.y*=this._scaleSpring.current.value,i.positionedBounds.x=l.x,i.positionedBounds.y=l.y,i.positionedBounds.width=c.x,i.positionedBounds.height=c.y;var u=r.pixelFromPointNoRotate(l,!0),d=r.pixelFromPointNoRotate(l,!1),p=r.deltaPixelsFromPointsNoRotate(c,!0),m=r.deltaPixelsFromPointsNoRotate(c,!1),y=d.plus(m.divide(2)),_=o.squaredDistanceTo(y);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(p=p.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(p.x+=.75),i.isBottomMost&&this.wrapVertical&&(p.y+=.75)),i.position=u,i.size=p,i.squaredDistance=_,i.visibility=a},_updateTile:function(i,n,r,o,a,l,c,u){var d=this._getTile(i,n,r,c,l);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:d}),this._setCoverage(this.coverage,r,i,n,!1);var p=d.loaded||d.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,p),!d.exists)return{bestTiles:u,tile:d};if(d.loaded&&d.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(d,this.source.tileOverlap,this.viewport,a,o),!d.loaded)if(d.context2D)this._setTileLoaded(d);else{var m=this._tileCache.getImageRecord(d.cacheKey);m&&this._setTileLoaded(d,m.getData())}return d.loading?this._tilesLoading++:p||(u=this._compareTiles(u,d,this.maxTilesPerFrame)),{bestTiles:u,tile:d}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var l,c,u=1/this.source.aspectRatio;this.wrapVertical?(l=e.positiveModulo(n.y,u),c=e.positiveModulo(r.y,u)):(l=Math.max(0,n.y),c=Math.min(u,r.y));var d=this.source.getTileAtPoint(i,new e.Point(o,l)),p=this.source.getTileAtPoint(i,new e.Point(a,c)),m=this.source.getNumTiles(i);return this.wrapHorizontal&&(d.x+=m.x*Math.floor(n.x),p.x+=m.x*Math.floor(r.x)),this.wrapVertical&&(d.y+=m.y*Math.floor(n.y/u),p.y+=m.y*Math.floor(r.y/u)),{topLeft:d,bottomRight:p}},_getTile:function(i,n,r,o,a){var l,c,u,d,p,m,y,_,T,x,V=this.tilesMatrix,L=this.source;return V[r]||(V[r]={}),V[r][i]||(V[r][i]={}),(!V[r][i][n]||!V[r][i][n].flipped!=!this.flipped)&&(l=(a.x+i%a.x)%a.x,c=(a.y+n%a.y)%a.y,u=this.getTileBounds(r,i,n),d=L.getTileBounds(r,l,c,!0),p=L.tileExists(r,l,c),m=L.getTileUrl(r,l,c),y=L.getTilePostData(r,l,c),this.loadTilesWithAjax?(_=L.getTileAjaxHeaders(r,l,c),e.isPlainObject(this.ajaxHeaders)&&(_=e.extend({},this.ajaxHeaders,_))):_=null,T=L.getContext2D?L.getContext2D(r,l,c):void 0,x=new e.Tile(r,i,n,u,p,m,T,this.loadTilesWithAjax,_,d,y,L.getTileHashKey(r,l,c,m,_,y)),this.getFlip()?l===0&&(x.isRightMost=!0):l===a.x-1&&(x.isRightMost=!0),c===a.y-1&&(x.isBottomMost=!0),x.flipped=this.flipped,V[r][i][n]=x),x=V[r][i][n],x.lastTouchTime=o,x},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,l){r._onTileLoad(i,n,o,a,l)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var l=this,c=function(){var u=l.source,d=u.getClosestLevel();l._setTileLoaded(i,r,d,a)};c()},_setTileLoaded:function(i,n,r,o){var a=0,l=!1,c=this;function u(){return l&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,d}function d(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=c.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||c._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:c}),c.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:c,tileRequest:o}),c._needsDraw=!0)}var p=u();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:u}),l=!0,p()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,l,c,u;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(c in a)if(Object.prototype.hasOwnProperty.call(a,c)){l=a[c];for(u in l)if(Object.prototype.hasOwnProperty.call(l,u)&&!l[u])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,l=this._imagesLoaded[r.tile.cacheKey];if(l||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),l=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),l.addTile(r.tile),r.tile.cacheImageRecord=l,this._imagesLoadedCount>this._maxImageCacheCount){for(var c=null,u=-1,d=null,p,m,y,_,T,x,V=this._tilesLoaded.length-1;V>=0;V--)if(x=this._tilesLoaded[V],p=x.tile,!(p.level<=o||p.beingDrawn)){if(!c){c=p,u=V,d=x;continue}_=p.lastTouchTime,m=c.lastTouchTime,T=p.level,y=c.level,(_<m||_===m&&T>y)&&(c=p,u=V,d=x)}c&&u>=0&&(this._unloadTile(d),a=u)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let l=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var c=this._imagesLoaded[o.cacheKey];c&&(c.removeTile(o),c.getTileCount()||(c.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,l&&(l.canvas.width=0,l.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:l,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,l=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,c=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,u=l+c,d;!i.rows&&a?d=a:d=Math.ceil(this._items.length/o);var p=0,m=0,y,_,T,x,V;this.setAutoRefigureSizes(!1);for(var L=0;L<this._items.length;L++)L&&L%d===0&&(r==="horizontal"?(m+=u,p=0):(p+=u,m=0)),y=this._items[L],_=y.getBounds(),_.width>_.height?T=l:T=l*(_.width/_.height),x=T*(_.height/_.width),V=new e.Point(p+(l-T)/2,m+(l-x)/2),y.setPosition(V,n),y.setWidth(T,n),r==="horizontal"?p+=u:m+=u;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var l=o.getClippedBounds().getBoundingBox(),c=l.x,u=l.y,d=l.x+l.width,p=l.y+l.height,m=1;m<this._items.length;m++)o=this._items[m],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),l=o.getClippedBounds().getBoundingBox(),c=Math.min(c,l.x),u=Math.min(u,l.y),d=Math.max(d,l.x+l.width),p=Math.max(p,l.y+l.height);this._homeBounds=new e.Rect(c,u,d-c,p-u),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(zc);var pd=zc.exports;const ft=dd(pd);class Us{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.25,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.opacityInterpolation={current:1,target:1,velocity:0,animationId:null,interpolationRate:.12,velocityDecay:.92,minDelta:.001,lastWheelTime:0,wheelAccumulator:0},this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=50,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}getCachedViewportRect(){const t=performance.now();return(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t),this.cachedViewportRect}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),l=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-l}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],l=i[r];if((a[0]-o[0])*(l[1]-o[1])-(a[1]-o[1])*(l[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],l=t[(r+1)%n],c=Math.atan2(a[1]-o[1],a[0]-o[0]);let d=Math.atan2(l[1]-a[1],l[0]-a[0])-c;for(;d>Math.PI;)d-=2*Math.PI;for(;d<-Math.PI;)d+=2*Math.PI;const p=Math.sqrt(Math.pow(l[0]-a[0],2)+Math.pow(l[1]-a[1],2)),m=Math.abs(d)/(p+1e-10);e+=m,i=Math.max(i,m)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let u=0;u<e;u++){const d=t[(u+1)%e];n+=Math.sqrt(Math.pow(t[u][0]-d[0],2)+Math.pow(t[u][1]-d[1],2))}const o=n/e*3;for(let u=0;u<e;u++)for(let d=0;d<e;d++){if(u===d)continue;Math.sqrt(Math.pow(t[u][0]-t[d][0],2)+Math.pow(t[u][1]-t[d][1],2))<o&&i[u]++}const a=Math.max(...i),l=i.reduce((u,d)=>u+d,0)/e,c=i.reduce((u,d)=>u+Math.pow(d-l,2),0)/e;return{maxDensity:a,avgDensity:l,variance:c,uniformityScore:1-Math.sqrt(c)/(l+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e,i;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(console.log(" [SPOTLIGHT] CSSOverlayManager: selectHotspot called",{hotspotId:t==null?void 0:t.id,previousSelected:((i=this.state.selectedHotspot)==null?void 0:i.id)||"none"}),this.state.isManualSelection=!0,this.state.selectedHotspot&&this.state.selectedHotspot.id!==(t==null?void 0:t.id)&&(console.log(" CSSOverlayManager: Clearing previous selection"),this.state.targetOpacity=0,this.state.currentOpacity=0,this.overlayElement&&(this.overlayElement.style.opacity="0",this.overlayElement.style.mask="",this.overlayElement.style.webkitMask="")),this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation(),setTimeout(()=>{this.state.isManualSelection=!1},1e3)):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation(),this.state.isManualSelection=!1))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getCachedViewportRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const o=this.expandPolygon(i,1),a=[];let l=0,c=0;o.forEach(([d,p])=>{const m=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(d,p)),y=this.viewer.viewport.viewportToWindowCoordinates(m);l+=y.x,c+=y.y}),l/=o.length,c/=o.length;let u=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(u=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([d,p])=>{const m=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(d,p)),y=this.viewer.viewport.viewportToWindowCoordinates(m),_=l+(y.x-l)*u,T=c+(y.y-c)*u;a.push(`${_},${T}`)}),a.length>0)if(this.useClipPath){const d=e.width,p=e.height,m=`0,0 ${d},0 ${d},${p} 0,${p} 0,0`,y=a.slice().reverse().join(" "),_=`polygon(${m} ${y})`;this.overlayElement.style.clipPath=_,this.overlayElement.style.webkitClipPath=_}else{const d=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,m=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(d)))}`;this.overlayElement.style.mask=`url("${m}")`,this.overlayElement.style.webkitMask=`url("${m}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,l=o*this.viewer.container.clientHeight,u=Math.max(a,l)*.75;return Math.max(50,Math.min(500,u))}trackFocusReference(){if(!this.state.selectedHotspot||!this.viewer||!this.viewer.viewport)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;const r=.85,o=.4;if(i>=r)n=1;else if(i<=o)n=0;else{const c=(i-o)/(r-o);n=1-Math.pow(1-c,3)}let a=1;if(this.state.selectedHotspot&&e){const c=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0];let u=0,d=0;c.forEach(([L,W])=>{u+=L,d+=W}),u/=c.length,d/=c.length;const p=new ft.Point(u,d),m=this.viewer.viewport.imageToViewportCoordinates(p),y=e.x-m.x,_=e.y-m.y,T=Math.sqrt(y*y+_*_),x=.002,V=.04;if(T<=x)a=1;else if(T>=V)a=0;else{const L=(T-x)/(V-x);a=1-Math.pow(L,2.5)}}return a<.1?a:Math.min(n,a)}quantizeToLevels(t,e){let i=e[0],n=Math.abs(t-e[0]);for(const r of e){const o=Math.abs(t-r);o<n&&(n=o,i=r)}return i}detectWheelVelocity(t){const e=performance.now(),i=e-this.opacityInterpolation.lastWheelTime;this.opacityInterpolation.lastWheelTime=e;const n=Math.abs(t)/Math.max(i,1)*1e3;return n>2e3?(this.opacityInterpolation.interpolationRate=.18,this.opacityInterpolation.velocityDecay=.88,this.opacityInterpolation.velocity+=t*5e-4):n<500?(this.opacityInterpolation.interpolationRate=.08,this.opacityInterpolation.velocityDecay=.95,this.opacityInterpolation.velocity=0):(this.opacityInterpolation.interpolationRate=.12,this.opacityInterpolation.velocityDecay=.92,this.opacityInterpolation.velocity+=t*2e-4),n}setTargetOpacity(t,e=null){e!==null&&this.detectWheelVelocity(e),this.opacityInterpolation.target=t,this.opacityInterpolation.animationId||this.interpolateOpacity()}interpolateOpacity(){const t=this.opacityInterpolation;t.velocity*=t.velocityDecay;const e=t.target-t.current;if(t.current+=e*t.interpolationRate,this.spotlightOverlay){const i=Math.max(0,Math.min(1,t.current))*this.config.maxOpacity;this.spotlightOverlay.style.opacity=i.toString()}Math.abs(e)>t.minDelta||Math.abs(t.velocity)>.001?t.animationId=requestAnimationFrame(()=>this.interpolateOpacity()):(t.animationId=null,t.current=t.target)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const l=e[o][0],c=e[o][1],u=e[a][0],d=e[a][1];c>n!=d>n&&i<(u-l)*(n-c)/(d-c)+l&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const l=e.x+a*n,c=e.y+a*r;return Math.sqrt(Math.pow(t.x-l,2)+Math.pow(t.y-c,2))}autoDeselect(){var t;if(this.state.isManualSelection){console.log(" Skipping auto-deselect during manual selection");return}console.log(" [SPOTLIGHT] CSSOverlayManager: Auto-deselecting hotspot",{selectedHotspot:((t=this.state.selectedHotspot)==null?void 0:t.id)||"none",currentOpacity:this.state.opacity}),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&(window.nativeHotspotRenderer.instantDeselect(),window.nativeHotspotRenderer.eventCoordinator&&(console.log(" CSSOverlayManager: Ensuring drag state reset after auto-deselect"),window.nativeHotspotRenderer.eventCoordinator.resetDragState())),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){if(!this.overlayElement)return;this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([l,c])=>{e=Math.min(e,l),i=Math.min(i,c),n=Math.max(n,l),r=Math.max(r,c)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t);this.calculateZunicRosinConvexity(t);const i=this.calculateDiscreteRoughness(t);let n=0;return i.maxCurvature>10&&(n=Math.max(n,.5)),(e.aspectRatio>3||e.aspectRatio<.33)&&(n=Math.max(n,.4)),1+n*.1}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const l=o-n,c=a-r;return[n+l*e,r+c*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}resetAnimationState(){console.log(" CSSOverlayManager: Animation state reset (no-op)")}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class fd{constructor(t,e=null){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isWebKit="WebkitAppearance"in document.documentElement.style&&!window.chrome,this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.isSafariOrWebKit=this.isSafari||this.isWebKit,this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1,isManualSelection:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.25,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:200,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.zoomConfig={fadeStartZoom:2,fadeEndZoom:4,minCoverageRatio:1,enableZoomFade:!1},this.useEllipse=!1,this.ellipseLocked=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0,baseRadiusX:100,baseRadiusY:100},this.tuningParams={circleMultiplier:.22,ellipseMultiplierX:1.2,ellipseMultiplierY:1.15,gradientMultiplier:1.5,pixelRadiusMultiplier:1,adaptivePaddingMultiplier:1.3,offsetX:0,offsetY:0},window.safariTuning=this.tuningParams,this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.zoomUpdateTimeout=null,this.lastUpdateTime=0,this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.lastPositionUpdate=0,this.positionUpdateThrottle=16,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=100,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[l,c]=i,u=n*(a-c)-r*(o-l)+o*c-l*a;if(Math.abs(u)<1e-10)return this.minCircleTrivial([t,e]);const d=(n*n+r*r)*(c-a)+(o*o+a*a)*(r-c)+(l*l+c*c)*(a-r),p=(n*n+r*r)*(o-l)+(o*o+a*a)*(l-n)+(l*l+c*c)*(n-o),m=-d/(2*u),y=-p/(2*u),_=n-m,T=r-y,x=Math.sqrt(_*_+T*T);return{x:m,y,r:x}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonArea(t),r=i.width*i.height,o=n/r,a=this.calculateConvexHull(t),l=this.calculatePolygonArea(a),c=n/l;let u=1;return c<.6?u=1.4:o<.7?u=1.3:u=1.2,this.isMobile&&(u*=.8),e*u*this.tuningParams.adaptivePaddingMultiplier}calculateEllipseFromPolygon(t){var c,u;const e=((c=this.state.selectedHotspot)==null?void 0:c.id)||`${t.length}_${JSON.stringify(t.slice(0,3))}`;if(this.ellipseCache.has(e)){const d=this.ellipseCache.get(e);return this.useEllipse=d.useEllipse,d.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=i.width/i.height,r=(Math.max(i.width,i.height)-Math.min(i.width,i.height))/(i.width+i.height);let o=!1;if(n<=1.5&&r<=.3?o=!1:n>2||r>.5?o=!0:o=Math.abs(i.width-i.height)/Math.max(i.width,i.height)>.3,console.log("Shape decision:",{hotspotId:(u=this.state.selectedHotspot)==null?void 0:u.id,aspectRatio:n.toFixed(2),elongationIndex:r.toFixed(2),useEllipse:o}),!o)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const a=1.2,l={radiusX:i.width/2*a*this.tuningParams.ellipseMultiplierX,radiusY:i.height/2*a*this.tuningParams.ellipseMultiplierY,rotation:0,aspectRatio:n,centerX:i.centerX,centerY:i.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:l}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.state.selectedHotspot||this.ellipseCache.clear()},3e4),l}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],l=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const c=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);l*c<0&&e++}}return Math.min(e/(i*.5),1)}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),l=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-l}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],l=i[r];if((a[0]-o[0])*(l[1]-o[1])-(a[1]-o[1])*(l[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height,o=this.calculateElongationIndex(n);return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,elongationIndex:o,vertexDensity:t.length/i}}calculateElongationIndex(t){const e=Math.max(t.width,t.height),i=Math.min(t.width,t.height);return(e-i)/(e+i)}calculateZoomAwareOpacity(t){if(!this.viewer||!this.zoomConfig.enableZoomFade)return t;const e=this.viewer.viewport.getZoom();if(e<=this.zoomConfig.fadeStartZoom)return t;if(e>=this.zoomConfig.fadeEndZoom)return 0;const i=this.zoomConfig.fadeEndZoom-this.zoomConfig.fadeStartZoom,n=(e-this.zoomConfig.fadeStartZoom)/i,r=1-Math.pow(1-n,2);return t*(1-r)}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.createOverlayElement(),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}createOverlayElement(){try{this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer&&this.viewer.container?(this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement))):(console.error("SafariOverlayManager: No viewer container available"),this.overlayElement=null)}catch(t){console.error("SafariOverlayManager: Error creating overlay element:",t),this.overlayElement=null}}getHotspotBounds(t){if(!t||!t.coordinates)return null;if(t.shape==="polygon"||t.shape==="multipolygon"){let e=1/0,i=1/0,n=-1/0,r=-1/0;(t.shape==="multipolygon"?t.coordinates.flat():t.coordinates).forEach(([d,p])=>{e=Math.min(e,d),i=Math.min(i,p),n=Math.max(n,d),r=Math.max(r,p)});const a=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(e,i)),l=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(n,r)),c=this.viewer.viewport.viewportToWindowCoordinates(a),u=this.viewer.viewport.viewportToWindowCoordinates(l);return{x:c.x,y:c.y,width:u.x-c.x,height:u.y-c.y}}if(t.shape==="ellipse"||t.shape==="circle"){const e=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(t.cx||0,t.cy||0)),i=this.viewer.viewport.viewportToWindowCoordinates(e),n=(t.rx||t.r||50)*this.viewer.viewport.getZoom(),r=(t.ry||t.r||50)*this.viewer.viewport.getZoom();return{x:i.x-n,y:i.y-r,width:n*2,height:r*2}}return null}applyInitialStyles(){if(!this.overlayElement){console.error("SafariOverlayManager: Cannot apply styles - no overlay element");return}const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"block",visibility:"hidden","-webkit-mask-image":this.createGradientMask(50,50,0,0),"mask-image":this.createGradientMask(50,50,0,0),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const d=o.radiusX*n*this.tuningParams.ellipseMultiplierX,p=o.radiusY*n*this.tuningParams.ellipseMultiplierY,y=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(_=>{const T=d*_.position,x=p*_.position,V=(T+x)/2;return`rgba(0,0,0,${_.opacity}) ${V*this.tuningParams.gradientMultiplier}px`}).join(", ");return`radial-gradient(ellipse ${d*this.tuningParams.gradientMultiplier}px ${p*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%, 
        rgba(0,0,0,0) 0px,
        ${y})`}const l=i*n*this.tuningParams.circleMultiplier,u=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(d=>{const p=l+l*this.tuningParams.gradientMultiplier*.8*d.position;return`rgba(0,0,0,${d.opacity}) ${p}px`}).join(", ");return`radial-gradient(circle ${l*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%,
    rgba(0,0,0,0) 0px,
    rgba(0,0,0,0) ${l}px,
    ${u})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&(this.cachedViewportRect=null,this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.zoomUpdateTimeout=setTimeout(()=>{this.checkAutoDeselect()},100))}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&!this.animationFrame&&this.startAnimation()}),this.resizeHandler=()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()},window.addEventListener("resize",this.resizeHandler)}selectHotspot(t,e={}){var i,n;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(i=this.state.selectedHotspot)==null?void 0:i.id}),!this.overlayElement&&(console.warn("SafariOverlayManager: Overlay element missing, recreating..."),this.createOverlayElement(),!this.overlayElement)){console.error("SafariOverlayManager: Failed to create overlay element");return}if(((n=this.state.selectedHotspot)==null?void 0:n.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.isManualSelection=!0,this.state.selectedHotspot&&this.state.selectedHotspot.id!==(t==null?void 0:t.id)&&(console.log(" SafariOverlayManager: Clearing previous selection"),this.state.targetOpacity=0,this.state.opacity=0,this.state.currentScale=0,this.state.targetScale=0,this.ellipseLocked=!1,this.useEllipse=!1,this.overlayElement&&(this.overlayElement.style.opacity="0",this.overlayElement.style.maskImage="",this.overlayElement.style.webkitMaskImage="")),this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.overlayElement&&(this.overlayElement.style.display="block",this.overlayElement.style.visibility="visible"),console.log("Starting animation..."),this.startAnimation(),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,this.state.opacity=.25,this.overlayElement&&(this.overlayElement.style.opacity="0.25"),console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,setTimeout(()=>{this.trackFocusReference()},800),setTimeout(()=>{this.state.isManualSelection=!1},1e3)):(console.log("Deselecting hotspot"),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.ellipseLocked=!1,this.startAnimation(),this.state.isManualSelection=!1)}resetMask(){console.log("[SafariOverlayManager] Resetting mask to clean state"),this.overlayElement&&(this.overlayElement.style.removeProperty("-webkit-mask-image"),this.overlayElement.style.removeProperty("-webkit-mask-size"),this.overlayElement.style.removeProperty("-webkit-mask-position"),this.overlayElement.style.removeProperty("-webkit-mask-repeat"),this.overlayElement.style.removeProperty("mask-image"),this.overlayElement.style.removeProperty("mask-size"),this.overlayElement.style.removeProperty("mask-position"),this.overlayElement.style.removeProperty("mask-repeat"),this.overlayElement.style.opacity="0",this.overlayElement.offsetHeight,this.state.opacity=0,this.state.targetOpacity=0,this.state.isAnimating=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)),this.resetFocusTracking(),console.log("[SafariOverlayManager] Mask reset complete")}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;if(this.isUpdatingPosition){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,requestAnimationFrame(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()}));return}const t=performance.now();if(t-this.lastPositionUpdate<this.positionUpdateThrottle){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,setTimeout(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()},this.positionUpdateThrottle-(t-this.lastPositionUpdate)));return}this.isUpdatingPosition=!0,this.lastPositionUpdate=t;try{const e=this.state.selectedHotspot,i=this.getPerformanceMode();let n="full",r;if(i==="reduced"){const T=e.shape==="polygon"?e.coordinates:e.coordinates[0],x=this.simplifyPolygon(T,.5),V={...e,coordinates:e.shape==="polygon"?x:[x]};r=this.calculateSpotlightGeometry(V),n="simplified"}else r=this.calculateSpotlightGeometry(e);(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t);const o=this.cachedViewportRect,a=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(r.center.x,r.center.y)),l=this.viewer.viewport.viewportToWindowCoordinates(a),c=l.x/o.width*100+this.tuningParams.offsetX,u=l.y/o.height*100+this.tuningParams.offsetY;this.state.targetPosition={x:c,y:u};const d=this.viewer.world.getItemAt(0).getContentSize(),p=r.radius/d.x,m=this.viewer.viewport.getZoom(),y=p*o.width*m,_=this.getHotspotBounds(e);if(_){const T=_.width/d.x*o.width*m,x=_.height/d.y*o.height*m,L=Math.max(T,x)/2*this.zoomConfig.minCoverageRatio;this.state.targetRadius=Math.max(L,y*this.tuningParams.pixelRadiusMultiplier)}else this.state.targetRadius=Math.max(80,Math.min(400,y*this.tuningParams.pixelRadiusMultiplier));if(r.ellipseData){const T=r.ellipseData.radiusX/d.x*o.width*m,x=r.ellipseData.radiusY/d.y*o.height*m;(!this.useEllipse||!this.ellipseLocked)&&(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:r.ellipseData.rotation,baseRadiusX:r.ellipseData.radiusX,baseRadiusY:r.ellipseData.radiusY}),this.ellipseData.targetRadiusX=T,this.ellipseData.targetRadiusY=x,this.ellipseData.rotation=r.ellipseData.rotation,this.useEllipse=!0,this.ellipseLocked=!0}else if(this.ellipseLocked&&this.useEllipse&&this.ellipseData&&this.ellipseData.baseRadiusX){const T=this.ellipseData.baseRadiusX/d.x*o.width*m,x=this.ellipseData.baseRadiusY/d.y*o.height*m;this.ellipseData.targetRadiusX=T,this.ellipseData.targetRadiusY=x,this.useEllipse=!0}else this.ellipseLocked||(this.useEllipse=!1);this.aspectRatio=r.aspectRatio,this.state.isAnimating?this.animationFrame||this.startAnimation():(this.state.currentPosition={...this.state.targetPosition},this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0&&(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY),this.applySpotlightStyles())}finally{this.isUpdatingPosition=!1}}invalidateViewportCache(){this.cachedViewportRect=null,this.viewportRectCacheTime=0}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateEllipseFromPolygon(e);if(n)return{center:{x:n.centerX,y:n.centerY},radius:Math.max(n.radiusX,n.radiusY),aspectRatio:n.aspectRatio,bounds:i,ellipseData:n,useEllipse:!0};{const r=this.calculateMinimumEnclosingCircle(e);r.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),r.r=Math.max(i.width,i.height)/2);const o=this.calculateAdaptivePadding(e,r.r);return{center:{x:r.x,y:r.y},radius:r.r+o,aspectRatio:i.width/i.height,bounds:i,ellipseData:null,useEllipse:!1}}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let c=0,u=o-1;c<o;u=c++){const d=e[c][0],p=e[c][1],m=e[u][0],y=e[u][1],_=d*y-m*p;i+=_,n+=(d+m)*_,r+=(p+y)*_}i*=.5;const a=n/(6*i),l=r/(6*i);if(!isFinite(a)||!isFinite(l)){let c=0,u=0;return e.forEach(([d,p])=>{c+=d,u+=p}),{x:c/e.length,y:u/e.length}}return{x:a,y:l}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}if(!this.viewer||!this.viewer.viewport){console.warn("SafariOverlayManager: viewer or viewport is null in trackFocusReference");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||this.isUpdatingPosition)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking||!this.focusTracking.referenceZoom||!this.viewer||!this.viewer.viewport)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;const r=.85,o=.4;if(i>=r)n=1;else if(i<=o)n=0;else{const l=(i-o)/(r-o);n=1-Math.pow(1-l,3)}let a=1;if(this.state.selectedHotspot&&e){const l=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates?this.state.selectedHotspot.coordinates[0]:null;if(l){let c=0,u=0;l.forEach(([V,L])=>{c+=V,u+=L}),c/=l.length,u/=l.length;const d=new ft.Point(c,u),p=this.viewer.viewport.imageToViewportCoordinates(d),m=e.x-p.x,y=e.y-p.y,_=Math.sqrt(m*m+y*y),T=.002,x=.04;if(_<=T)a=1;else if(_>=x)a=0;else{const V=(_-T)/(x-T);a=1-Math.pow(V,2.5)}}}return a<.1?a:Math.min(n,a)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const l=e[o][0],c=e[o][1],u=e[a][0],d=e[a][1];c>n!=d>n&&i<(u-l)*(n-c)/(d-c)+l&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const l=e.x+a*n,c=e.y+a*r;return Math.sqrt(Math.pow(t.x-l,2)+Math.pow(t.y-c,2))}calculateEllipseDistance(t,e,i,n,r,o,a){const l=a*Math.PI/180,c=Math.cos(l),u=Math.sin(l),d=i-t,p=n-e,m=d*c+p*u,y=-d*u+p*c;return Math.sqrt(m*m/(r*r)+y*y/(o*o))}autoDeselect(){if(this.state.isManualSelection){console.log(" Skipping auto-deselect during manual selection");return}console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement&&(this.overlayElement.style.opacity="0",this.overlayElement.style.display="none"),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.ellipseLocked=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startZoomAnimation(){this.state.selectedHotspot&&this.overlayElement&&(console.log(" Safari: Ensuring spotlight visible for zoom animation"),this.state.opacity=Math.max(this.state.opacity,.3),this.overlayElement.style.opacity=Math.max(parseFloat(this.overlayElement.style.opacity)||0,.3),this.overlayElement.style.display="block",this.overlayElement.style.visibility="visible")}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}if(!this.overlayElement&&(console.warn("SafariOverlayManager: Cannot start animation - no overlay element"),this.createOverlayElement(),!this.overlayElement)){console.error("SafariOverlayManager: Failed to create overlay element for animation");return}this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,this.overlayElement&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block"),this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity*this.config.maxOpacity,i=e-this.state.opacity,n=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(i)>.001?(this.state.opacity+=i*n,this.state.opacity=Math.max(0,Math.min(this.config.maxOpacity,this.state.opacity))):this.state.opacity=e;const r=this.state.targetScale-this.state.scale;Math.abs(r)>.01?this.state.scale+=r*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const o=this.state.targetPosition.x-this.state.currentPosition.x,a=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(o)>.1||Math.abs(a)>.1?(this.state.currentPosition.x+=o*this.config.positionSpeed,this.state.currentPosition.y+=a*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const l=this.state.targetRadius-this.state.currentRadius;if(Math.abs(l)>1?this.state.currentRadius+=l*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const u=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,d=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(u)>1||Math.abs(d)>1?(this.ellipseData.radiusX+=u*this.config.radiusSpeed,this.ellipseData.radiusY+=d*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(i)<=.001&&Math.abs(o)<=.1&&Math.abs(a)<=.1&&Math.abs(l)<=1&&Math.abs(r)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement&&(this.overlayElement.style.display="none")):this.overlayElement?this.animationFrame=requestAnimationFrame(this.animate):(this.state.isAnimating=!1,console.warn("SafariOverlayManager: Stopping animation - no overlay element"))}applySpotlightStyles(){if(!this.overlayElement){console.warn("SafariOverlayManager: overlayElement is null in applySpotlightStyles");return}this.state.opacity>0&&(this.overlayElement.style.visibility="visible"),this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none"),e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none",this.overlayElement.style.visibility="hidden")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([l,c])=>{e=Math.min(e,l),i=Math.min(i,c),n=Math.max(n,l),r=Math.max(r,c)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}resetAnimationState(){console.log(" SafariOverlayManager: Resetting animation state"),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.overlayElement&&this.state.selectedHotspot&&(this.updateSpotlightPosition(),!this.state.isAnimating&&this.state.targetOpacity>0&&this.startAnimation())}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}forceRecalculation(){this.state.selectedHotspot&&(this.ellipseCache.clear(),this.updateSpotlightPosition(),!this.state.isAnimating&&this.applySpotlightStyles())}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.cachedViewportRect=null,this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const l=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=l,t.style.webkitMaskImage=l,o++,requestAnimationFrame(a)}else{const l=performance.now()-r,c=o/l*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${c.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){}}class Bc{constructor(t,e,i){if(this.viewer=t,this.canvas=document.createElement("canvas"),this.canvas.className="magnetic-ink-canvas",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="10000",this.canvas.style.opacity="1",this.viewer&&this.viewer.container){this.viewer.container.appendChild(this.canvas);const n=this.viewer.container.getBoundingClientRect();this.canvas.width=n.width,this.canvas.height=n.height}this.context=this.canvas.getContext("2d",{alpha:!0,desynchronized:!0}),this.state="IDLE",this.stateStartTime=0,this.activeAnimations=new Map,this.animationFrame=null,this.pathCache=new Map,this.polygonPool=new yd(50),this.frameTime=1e3/30,this.lastFrameTime=0,this.forceField=null,this.config={phase1:{duration:300,scale:1.15,easing:this.elasticEaseOut},phase2:{duration:800,staggerDelay:150,magneticStrength:5e3,minRadius:50,progressSpeed:.02},phase3:{duration:600,fadeInSpeed:.0025,undulationDecay:.98},inkThickness:3,shadowBlur:8,shadowColor:"rgba(0, 0, 0, 0.4)",strokeColor:"#000000",simplifyTolerance:3,maxCacheSize:100,usePathBatching:!0},this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.isIOS&&this.applyIOSOptimizations(),this.animate=this.animate.bind(this)}startReveal(t,e,i){console.log("[MagneticInkAnimator] Starting magnetic ink reveal",{central:t==null?void 0:t.id,secondary:(e==null?void 0:e.length)||0,tapPoint:i}),this.clearAnimations(),this.context&&this.canvas&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.centralHotspot=t,this.secondaryHotspots=e.slice(0,4),this.tapPoint=i;const n=this.canvas.getBoundingClientRect();this.forceField=new gd(n.width,n.height),this.setState("PHASE_1_SCALING"),this.animate(performance.now())}setState(t){switch(this.state=t,this.stateStartTime=performance.now(),t){case"PHASE_1_SCALING":this.startPhaseOne();break;case"PHASE_2_MAGNETIC":this.startPhaseTwo();break;case"PHASE_3_STABILIZE":this.startPhaseThree();break}}startPhaseOne(){if(!this.centralHotspot)return;const t=this.polygonPool.acquire();t.hotspot=this.centralHotspot,t.type="central",t.visible=!0,t.progress=1,t.scale=1;const e=new rl(this.centralHotspot.coordinates||[]);t.renderer=e,t.deformable=new sl(e.polygon),this.activeAnimations.set(this.centralHotspot.id,t);const i=this.imageToCanvasCoordinates(this.tapPoint);this.forceField.addRepulsor(i.x,i.y,this.config.phase2.magneticStrength,this.config.phase2.minRadius),console.log("[MagneticInkAnimator] Phase 1 started - central hotspot scaling")}startPhaseTwo(){this.secondaryHotspots&&(this.forceField.updateField(),this.secondaryHotspots.forEach((t,e)=>{setTimeout(()=>{const i=this.polygonPool.acquire();i.hotspot=t,i.type="secondary",i.visible=!0,i.progress=0,i.opacity=.3;const n=this.simplifyPolygon(t.coordinates||[],this.config.simplifyTolerance),r=new rl(n);i.renderer=r,i.deformable=new sl(r.polygon),this.activeAnimations.set(t.id,i)},e*this.config.phase2.staggerDelay)}),console.log("[MagneticInkAnimator] Phase 2 started - magnetic repulsion"))}startPhaseThree(){this.magneticDecay=1,console.log("[MagneticInkAnimator] Phase 3 started - stabilization")}animate(t){if(t-this.lastFrameTime<this.frameTime){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastFrameTime=t;const e=t-this.stateStartTime,i=.016;switch(this.state){case"PHASE_1_SCALING":this.updatePhaseOne(e),e>this.config.phase1.duration&&this.setState("PHASE_2_MAGNETIC");break;case"PHASE_2_MAGNETIC":this.updatePhaseTwo(e,i,t),e>this.config.phase2.duration&&this.setState("PHASE_3_STABILIZE");break;case"PHASE_3_STABILIZE":this.updatePhaseThree(e,i,t),e>this.config.phase3.duration&&(this.setState("COMPLETE"),setTimeout(()=>{this.clearAnimations()},500));break}this.render(),this.state!=="COMPLETE"&&this.state!=="IDLE"&&(this.animationFrame=requestAnimationFrame(this.animate))}updatePhaseOne(t){const e=Array.from(this.activeAnimations.values()).find(r=>r.type==="central");if(!e)return;const i=t/this.config.phase1.duration,n=1+(this.config.phase1.scale-1)*this.elasticEaseOut(i);e.scale=n}updatePhaseTwo(t,e,i){this.activeAnimations.forEach(n=>{n.type==="secondary"&&n.visible&&(n.progress=Math.min(1,n.progress+this.config.phase2.progressSpeed),this.forceField&&n.deformable&&n.deformable.applyMagneticDeformation(this.forceField,e,i),n.opacity=Math.min(1,n.opacity+.002))})}updatePhaseThree(t,e,i){this.magneticDecay>.1&&(this.magneticDecay*=this.config.phase3.undulationDecay,this.forceField&&(this.forceField.repulsors.forEach(n=>{n.strength*=this.magneticDecay}),this.forceField.updateField())),this.activeAnimations.forEach(n=>{n.deformable&&this.forceField&&n.deformable.applyMagneticDeformation(this.forceField,e,i)})}render(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.save(),this.context.strokeStyle="#000000",this.context.lineWidth=3,this.context.lineCap="round",this.context.shadowBlur=6,this.context.shadowColor="rgba(0, 0, 0, 0.5)",this.activeAnimations.forEach(t=>{if(!t.visible||!t.hotspot)return;const e=t.hotspot.coordinates||[];if(e.length<2)return;const i=Math.floor(e.length*t.progress);if(!(i<2)){this.context.strokeStyle="rgba(255, 255, 255, 0.3)",this.context.lineWidth=5,this.context.shadowBlur=0,this.context.beginPath();for(let n=0;n<=i;n++){const r=e[n%e.length],o=this.imageToCanvasCoordinates({x:r[0],y:r[1]});n===0?this.context.moveTo(o.x,o.y):this.context.lineTo(o.x,o.y)}t.progress>=1&&this.context.closePath(),this.context.stroke(),this.context.strokeStyle="#000000",this.context.lineWidth=3,this.context.shadowBlur=4,this.context.shadowColor="rgba(0, 0, 0, 0.6)",this.context.beginPath();for(let n=0;n<=i;n++){const r=e[n%e.length],o=this.imageToCanvasCoordinates({x:r[0],y:r[1]});n===0?this.context.moveTo(o.x,o.y):this.context.lineTo(o.x,o.y)}if(t.progress>=1&&this.context.closePath(),t.type==="central"&&t.scale){const n=this.getHotspotCenter(e.map(o=>({x:o[0],y:o[1]}))),r=this.imageToCanvasCoordinates(n);this.context.save(),this.context.translate(r.x,r.y),this.context.scale(t.scale,t.scale),this.context.translate(-r.x,-r.y)}this.context.globalAlpha=t.opacity||1,this.context.stroke(),t.type==="central"&&t.scale&&this.context.restore()}}),this.context.restore()}getAnimationPath(t){let e;if(t.deformable)e=t.deformable.currentPoints;else if(t.renderer)e=t.renderer.generateProgressivePath(t.progress);else return null;const i=this.convertToScreenCoords(e);if(i.length<2)return null;const n=`${t.hotspot.id}_${Math.floor(t.progress*100)}`;let r=this.pathCache.get(n);if(!r){if(r=new Path2D,t.type==="central"&&t.scale!==1){const o=this.getHotspotCenter(i),a=new DOMMatrix().translateSelf(o.x,o.y).scaleSelf(t.scale,t.scale).translateSelf(-o.x,-o.y);r.addPath(this.createPolygonPath(i),a)}else r.addPath(this.createPolygonPath(i));if(this.pathCache.size>this.config.maxCacheSize){const o=this.pathCache.keys().next().value;this.pathCache.delete(o)}this.pathCache.set(n,r)}return r}createPolygonPath(t){const e=new Path2D;if(t.length<2)return e;e.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)e.lineTo(t[i].x,t[i].y);return e.closePath(),e}renderSingleAnimation(t){const e=this.getAnimationPath(t);e&&(this.context.save(),this.context.globalAlpha=t.opacity||1,this.context.strokeStyle=this.config.strokeColor,this.context.lineWidth=this.config.inkThickness,this.context.lineCap="round",this.context.lineJoin="round",t.type==="central"&&(this.context.shadowBlur=this.config.shadowBlur*1.5,this.context.shadowColor=this.config.shadowColor),this.context.stroke(e),this.context.restore())}imageToCanvasCoordinates(t){if(!this.viewer||!this.viewer.viewport)return{x:0,y:0};try{const e=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(t.x,t.y)),i=this.viewer.viewport.pixelFromPoint(e);return{x:i.x,y:i.y}}catch(e){return console.error("[MagneticInkAnimator] Coordinate conversion error:",e),{x:0,y:0}}}convertToScreenCoords(t){return Array.isArray(t)?t.map(e=>typeof e.x<"u"&&typeof e.y<"u"?this.imageToCanvasCoordinates(e):Array.isArray(e)&&e.length>=2?this.imageToCanvasCoordinates({x:e[0],y:e[1]}):{x:0,y:0}):[]}getHotspotCenter(t){if(!t||t.length===0)return{x:0,y:0};let e=0,i=0;return t.forEach(n=>{e+=n.x,i+=n.y}),{x:e/t.length,y:i/t.length}}simplifyPolygon(t,e){return t.length<=3?t:new md().simplify(t,e)}applyIOSOptimizations(){const e=window.devicePixelRatio||1;if(this.canvas.width*e>3840||this.canvas.height*e>3840){const i=3840/Math.max(this.canvas.width*e,this.canvas.height*e);this.canvas.width*=i,this.canvas.height*=i}this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.canvas.style.transform="translateZ(0)",this.canvas.style.willChange="transform",this.frameTime=1e3/24}clearAnimations(){this.activeAnimations.forEach(t=>{this.polygonPool.release(t)}),this.activeAnimations.clear(),this.pathCache.clear(),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.state="IDLE",this.context&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}elasticEaseOut(t){return t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)+1}easeOutCubic(t){return 1-Math.pow(1-t,3)}destroy(){this.clearAnimations(),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.viewer=null,this.canvas=null,this.context=null,this.forceField=null}}class rl{constructor(t){this.polygon=this.normalizeCoordinates(t),this.segments=this.preprocessPolygon(this.polygon),this.totalLength=this.segments.reduce((e,i)=>e+i.length,0)}normalizeCoordinates(t){return!t||t.length===0?[]:t.map(e=>Array.isArray(e)&&e.length>=2?{x:e[0],y:e[1]}:e)}preprocessPolygon(t){const e=[];let i=0;for(let n=0;n<t.length;n++){const r=t[n],o=t[(n+1)%t.length],a=Math.hypot(o.x-r.x,o.y-r.y);e.push({start:r,end:o,length:a,cumulativeLength:i}),i+=a}return e}getPointAtDistance(t){const e=t%this.totalLength;for(const i of this.segments)if(e<=i.cumulativeLength+i.length){const r=(e-i.cumulativeLength)/i.length;return{x:i.start.x+(i.end.x-i.start.x)*r,y:i.start.y+(i.end.y-i.start.y)*r}}return this.polygon[0]||{x:0,y:0}}generateProgressivePath(t){if(t<=0)return[];if(t>=1)return[...this.polygon];const e=Math.max(2,Math.floor(this.polygon.length*2)),i=this.totalLength*t,n=[];for(let r=0;r<=i;r+=this.totalLength/e)n.push(this.getPointAtDistance(r));return n}}class gd{constructor(t,e,i=20){this.width=t,this.height=e,this.resolution=i,this.cols=Math.floor(t/i),this.rows=Math.floor(e/i),this.field=new Float32Array(this.cols*this.rows*2),this.repulsors=[]}addRepulsor(t,e,i,n=50){this.repulsors.push({x:t,y:e,strength:i,minRadius:n,maxForce:i/(n*n)})}calculateForce(t,e,i){const n=t-i.x,r=e-i.y,o=Math.sqrt(n*n+r*r);if(o<.001)return{x:0,y:0};const a=Math.max(o,i.minRadius),l=i.strength/(a*a),c=Math.min(l,i.maxForce),u=n/o,d=r/o;return{x:u*c,y:d*c}}updateField(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const i=e*this.resolution,n=t*this.resolution,r=(t*this.cols+e)*2;let o=0,a=0;for(const l of this.repulsors){const c=this.calculateForce(i,n,l);o+=c.x,a+=c.y}this.field[r]=o,this.field[r+1]=a}}getForceAt(t,e){const i=Math.floor(t/this.resolution),n=Math.floor(e/this.resolution);if(i>=0&&i<this.cols&&n>=0&&n<this.rows){const r=(n*this.cols+i)*2;return{x:this.field[r],y:this.field[r+1]}}return{x:0,y:0}}}class sl{constructor(t){this.originalPoints=[...t],this.currentPoints=t.map(e=>({...e,vx:0,vy:0})),this.noiseOffsets=t.map(()=>Math.random()*1e3)}applyMagneticDeformation(t,e,i){this.currentPoints.forEach((a,l)=>{const c=t.getForceAt(a.x,a.y),u=Math.sin(i*.001+this.noiseOffsets[l])*3,d=Math.cos(i*.001+this.noiseOffsets[l]*1.3)*3;a.vx+=(c.x+u)*e,a.vy+=(c.y+d)*e;const p=(this.originalPoints[l].x-a.x)*.08,m=(this.originalPoints[l].y-a.y)*.08;a.vx+=p,a.vy+=m,a.x+=a.vx*e,a.y+=a.vy*e,a.vx*=.92,a.vy*=.92})}}class md{simplify(t,e){if(t.length<=3)return t;const i=this.normalizePoints(t),n=[{start:0,end:i.length-1}],r=new Set([0,i.length-1]);for(;n.length>0;){const{start:o,end:a}=n.pop();let l=0,c=-1;for(let u=o+1;u<a;u++){const d=this.perpendicularDistance(i[u],i[o],i[a]);d>l&&(l=d,c=u)}l>e&&c!==-1&&(r.add(c),n.push({start:o,end:c}),n.push({start:c,end:a}))}return i.filter((o,a)=>r.has(a))}normalizePoints(t){return t.map(e=>Array.isArray(e)&&e.length>=2?{x:e[0],y:e[1]}:e)}perpendicularDistance(t,e,i){const n=t.x-e.x,r=t.y-e.y,o=i.x-e.x,a=i.y-e.y,l=n*o+r*a,c=o*o+a*a,u=c!==0?l/c:-1;let d,p;u<0?(d=e.x,p=e.y):u>1?(d=i.x,p=i.y):(d=e.x+u*o,p=e.y+u*a);const m=t.x-d,y=t.y-p;return Math.sqrt(m*m+y*y)}}class yd{constructor(t=50){this.available=[],this.inUse=new Set;for(let e=0;e<t;e++)this.available.push(this.createNew())}acquire(){let t=this.available.pop()||this.createNew();return this.inUse.add(t),this.reset(t),t}release(t){this.inUse.has(t)&&(this.inUse.delete(t),this.available.push(t))}reset(t){t.hotspot=null,t.type=null,t.visible=!1,t.progress=0,t.opacity=1,t.scale=1,t.renderer=null,t.deformable=null}createNew(){return{hotspot:null,type:null,visible:!1,progress:0,opacity:1,scale:1,renderer:null,deformable:null}}}typeof window<"u"&&(window.MagneticInkAnimator=Bc);class js{constructor(t){this.viewer=t,this.canvas=null,this.context=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.maskCache=new Map,this.transformCache=new Map,this.state={selectedHotspot:null,currentOpacity:0,targetOpacity:0,isAnimating:!1,selectionZoom:null,selectionBounds:null,selectionScale:null,autoDeselectThreshold:.3,selectionCenter:null,panThreshold:.02,isCinematicZooming:!1,lastPinchZoom:null,lastLoggedZoom:0,lastLoggedScale:0,isPinching:!1,cinematicZoomCompleted:!1,debugInfo:null},this.config={maxOpacity:.7,fadeSpeed:.25,fadeSpeedQuickClose:.4,updateThrottle:33,maxVerticesMobile:50,simplificationTolerance:2,devicePixelRatioMax:2,smoothingFactor:.8,positionSmoothingMultiplier:1,zoomSmoothingMultiplier:.9,useInterpolation:!0},console.log("Canvas2DOverlayManager: Constructor - auto-deselect threshold:",this.state.autoDeselectThreshold),this.frameCount=0,this.lastFrameTime=0,this.frameHistory=[],this.animationFrame=null,this.lastUpdateTime=0,this.animate=this.animate.bind(this),this.redraw=this.redraw.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this),this.magneticInkAnimator=null}initialize(){if(this.isInitialized)return;console.log("Canvas2DOverlayManager: Initializing..."),console.log("Canvas2DOverlayManager: Auto-deselect feature enabled, threshold:",this.state.autoDeselectThreshold),this.canvas=document.createElement("canvas"),this.canvas.className="canvas2d-spotlight-overlay",Object.assign(this.canvas.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"9999",opacity:"0",transform:"translateZ(0)",willChange:"opacity"}),this.context=this.canvas.getContext("2d",{alpha:!0,desynchronized:!1,willReadFrequently:!1}),this.resize();const t=this.viewer.container;t.appendChild(this.canvas),t.classList.add("canvas2d-active"),console.log("Canvas2DOverlayManager: Canvas added to container"),this.setupEventListeners(),this.isInitialized=!0,console.log("Canvas2DOverlayManager: Initialized successfully"),this.magneticInkAnimator=new Bc(this.viewer,this.canvas,this.context),console.log("Canvas2DOverlayManager: MagneticInkAnimator initialized")}setupEventListeners(){let t=!1;this.viewer.addHandler("animation-start",()=>{t=!0}),this.viewer.addHandler("animation-finish",()=>{t=!1,this.state.isCinematicZooming&&this.state.selectedHotspot&&(console.log("Canvas2D: Animation finished, checking if cinematic zoom completed..."),setTimeout(()=>{this.state.isCinematicZooming&&(console.log("Canvas2D: Auto-completing cinematic zoom (mobile fallback)"),this.updateSelectionZoom())},150))}),this.updateHandler=()=>{if(!this.state.selectedHotspot)return;const e=this.viewer.viewport.getZoom();!t&&this.state.cinematicZoomCompleted&&this.state.selectionZoom&&e<this.state.selectionZoom&&console.log(`Canvas2D: Zooming out from ${this.state.selectionZoom.toFixed(2)} to ${e.toFixed(2)}`);let i=1,n=1;const r=this.state.selectionZoom||this.state.startingZoom;this.state.selectionCenter||this.state.startingCenter;const o=this.isViewportInsideHotspot();if(this.state.selectedHotspot){const l=this.viewer.viewport.getBounds(),u=this.viewer.viewport.getContainerSize().x/l.width,d=this.state.selectionScale||this.state.startingScale,p=d?u/d:1;(Math.abs(this.state.lastLoggedScale-u)>1||!this.state.debugInfo)&&(console.log(`Canvas2D Bounds Debug: scale=${u.toFixed(1)}, ref=${(d==null?void 0:d.toFixed(1))||"null"}, ratio=${p.toFixed(3)}, bounds.w=${l.width.toFixed(3)}`),this.state.lastLoggedScale=u),this.state.debugInfo={scale:u,refScale:d||0,ratio:p,opacity:0,bounds:l.width};const m=.85,y=.4;if(p>=m)i=1;else if(p<=y)i=0;else{const _=(p-y)/(m-y);i=Math.pow(_,2)}this.state.debugInfo&&(this.state.debugInfo.opacity=i)}if(this.state.selectedHotspot&&!this.state.isCinematicZooming&&this.state.cinematicZoomCompleted){const l=this.viewer.viewport.getCenter(),c=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0];let u=0,d=0;c.forEach(([L,W])=>{u+=L,d+=W}),u/=c.length,d/=c.length;const p=new ft.Point(u,d),m=this.viewer.viewport.imageToViewportCoordinates(p),y=l.x-m.x,_=l.y-m.y,T=Math.sqrt(y*y+_*_),x=.002,V=.04;if(T<=x)n=1;else if(T>=V)n=0;else{const L=(T-x)/(V-x);n=1-Math.pow(L,2.5)}}const a=Math.min(i,n);if(this.state.selectedHotspot&&Math.abs(this.state.targetOpacity-a)>.01){const l=this.viewer.viewport.getZoom(),c=r?l/r:1,u=c>=.95?" (full)":c<=.5?" (hidden)":` (fading ${((1-i)*100).toFixed(0)}%)`,d=n===1?"":n===0?" PAN:hidden":` PAN:${(n*100).toFixed(0)}%`;console.log(`Canvas2D Fade: zoomRatio=${c.toFixed(3)}${u}, zoom=${i.toFixed(3)}, pan=${n.toFixed(3)}${d}, target=${a.toFixed(3)}`)}if(Math.abs(this.state.targetOpacity-a)>.001){this.state.targetOpacity=a,this.startAnimation();const l=.02;if(a<l&&this.state.selectedHotspot&&!this.state.isCinematicZooming){console.log(`Canvas2D: Auto-deselecting - opacity ${a.toFixed(3)} below threshold ${l}`),this.forceCompleteRemoval(),this.autoDeselect();return}this.state.isCinematicZooming?console.log(`Canvas2D: Cinematic zoom progress - currentZoom: ${this.viewer.viewport.getZoom().toFixed(2)}, targetOpacity: ${a.toFixed(2)}`):!this.state.previousInsideState!==o&&(console.log(`Canvas2D: Viewport ${o?"INSIDE":"OUTSIDE"} hotspot, opacity: ${a.toFixed(2)}`),this.state.previousInsideState=o)}this.redrawSynchronized()},this.viewer.addHandler("update-viewport",this.updateHandler),this.viewer.addHandler("resize",()=>{this.resize(),this.state.selectedHotspot&&this.redrawSynchronized()}),this.resizeHandler=()=>this.resize(),window.addEventListener("resize",this.resizeHandler)}resize(){if(!this.canvas)return;const t=this.viewer.container.getBoundingClientRect(),e=Math.min(window.devicePixelRatio||1,this.config.devicePixelRatioMax);this.canvas.width=Math.round(t.width*e),this.canvas.height=Math.round(t.height*e),this.canvas.style.width=`${Math.round(t.width)}px`,this.canvas.style.height=`${Math.round(t.height)}px`,this.context.setTransform(1,0,0,1,0,0),this.context.scale(e,e),this.transformCache.clear(),console.log(`Canvas2DOverlayManager: Resized to ${t.width}x${t.height} (DPR: ${e})`)}createDebugOverlay(){this.isMobile&&(this.debugDiv||(this.debugDiv=document.createElement("div"),this.debugDiv.id="canvas2d-debug-overlay",this.debugDiv.style.cssText=`
                position: fixed;
                top: 10px;
                left: 10px;
                background: rgba(255, 255, 255, 0.95);
                border: 2px solid #000;
                padding: 10px;
                z-index: 10000;
                font-family: monospace;
                font-size: 12px;
                color: #000;
                min-width: 200px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                border-radius: 5px;
                pointer-events: none;
            `,document.body.appendChild(this.debugDiv),console.log("Canvas2DOverlayManager: Debug overlay created for mobile testing")))}updateDebugOverlay(){if(!this.debugDiv||!this.state.selectedHotspot)return;const t=this.viewer.viewport.getBounds(),i=this.viewer.viewport.getContainerSize().x/t.width,n=this.viewer.viewport.getZoom(),r=this.state.selectionScale||i,o=i/r;let a=1;if(o>=.85)a=1;else if(o<=.4)a=0;else{const u=(o-.4)/.44999999999999996;a=Math.pow(u,2)}const l=this.state.isCinematicZooming?" IN PROGRESS":this.state.cinematicZoomCompleted?" COMPLETED":" NOT STARTED",c=r?r===this.state.startingScale?" USING START":r===this.state.selectionScale?" USING SELECTION":" UNKNOWN":" WAITING";this.debugDiv.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 5px; color: blue;">Canvas2D Debug</div>
            <div><b>Current:</b> ${i.toFixed(1)}</div>
            <div><b>Reference:</b> ${r?r.toFixed(1):"NOT SET"} ${c}</div>
            <div style="font-size: 10px;">Start: ${this.state.startingScale?this.state.startingScale.toFixed(1):"null"} | Sel: ${this.state.selectionScale?this.state.selectionScale.toFixed(1):"null"}</div>
            <div style="color: ${o!==1?"green":"red"}; font-weight: bold;">Ratio: ${o.toFixed(3)}</div>
            <div style="color: ${a<1?"blue":"black"};">Opacity: ${a.toFixed(2)}</div>
            <div style="font-size: 10px;">Zoom: ${n.toFixed(2)} | Bounds: ${t.width.toFixed(3)}</div>
            <div style="margin-top: 3px; padding-top: 3px; border-top: 1px solid #ccc;">
                <div>Cinematic: ${l}</div>
            </div>
            <div style="margin-top: 3px; padding-top: 3px; border-top: 1px solid #ccc;">
                ${o>=.85?" FULL":o<=.4?" HIDDEN":" FADING"}
            </div>
        `}selectHotspot(t){var e,i,n,r;if(console.log("Canvas2DOverlayManager: selectHotspot called",{newHotspotId:(t==null?void 0:t.id)||"null",currentHotspotId:((e=this.state.selectedHotspot)==null?void 0:e.id)||"null",isInitialized:this.isInitialized,canvasExists:!!this.canvas,contextExists:!!this.context,canvasDisplay:(n=(i=this.canvas)==null?void 0:i.style)==null?void 0:n.display,timestamp:Date.now()}),((r=this.state.selectedHotspot)==null?void 0:r.id)===(t==null?void 0:t.id))if(this.canvas&&this.canvas.style.display==="none")console.warn("Canvas2DOverlayManager: Same hotspot but canvas is hidden, reinitializing spotlight");else{console.warn("Canvas2DOverlayManager: Same hotspot already selected and visible, skipping");return}if(this.isInitialized||(console.error("Canvas2DOverlayManager: Not initialized! Initializing now..."),this.initialize()),console.log("Canvas2DOverlayManager: Selecting hotspot",(t==null?void 0:t.id)||"null"),this.state.selectedHotspot=t,t){const o=this.viewer.viewport.getZoom(),a=this.viewer.viewport.getCenter(),l=this.viewer.viewport.getBounds(),u=this.viewer.viewport.getContainerSize().x/l.width;this.state.startingZoom=o,this.state.startingCenter=a,this.state.startingScale=u,this.state.selectionZoom=null,this.state.selectionBounds=null,this.state.selectionScale=null,this.state.selectionCenter=null,this.state.isCinematicZooming=!0,this.state.cinematicZoomCompleted=!1,this.state.isPinching=!1,this.state.lastPinchZoom=o,console.log(`Canvas2DOverlayManager: Starting cinematic zoom from zoom=${o.toFixed(2)}, scale=${u.toFixed(1)}`),this.cinematicTimeout&&clearTimeout(this.cinematicTimeout),this.cinematicTimeout=setTimeout(()=>{this.state.isCinematicZooming&&this.state.selectedHotspot&&(console.log("Canvas2D: Cinematic zoom timeout - forcing completion (mobile safety)"),this.updateSelectionZoom())},2e3),this.maskCache.has(t.id)||this.preRenderMask(t),this.state.currentOpacity=0,this.state.targetOpacity=1,this.canvas.style.opacity="1",this.canvas.style.display="block",this.startAnimation(),this.redrawSynchronized()}else this.state.targetOpacity=0,this.startAnimation()}clearSelection(){if(console.log("Canvas2DOverlayManager: Clearing selection"),this.state.selectionZoom=null,this.state.selectionCenter=null,this.state.isCinematicZooming=!1,this.canvas){if(this.context){const e=this.viewer.container.getBoundingClientRect();this.context.clearRect(0,0,e.width,e.height);const i=Math.min(window.devicePixelRatio||1,this.config.devicePixelRatioMax);this.context.setTransform(i,0,0,i,0,0),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1}this.canvas.style.display="none",this.state.currentOpacity=0,this.state.targetOpacity=0,this.canvas.style.opacity="1"}this.state.selectedHotspot=null,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),document.querySelectorAll('g[data-canvas2d-selected="true"]').forEach(e=>{e.removeAttribute("data-canvas2d-selected"),e.style.display==="none"&&(e.style.display="");const i=e.querySelector(".main-path");i&&(i.style.stroke==="transparent"&&(i.style.stroke=""),(i.style.strokeWidth==="0"||i.style.strokeWidth==="0px")&&(i.style.strokeWidth=""),i.style.opacity==="0"&&(i.style.opacity=""))}),this.onSpotlightCleared&&(console.log(" [SPOTLIGHT] Canvas2DOverlayManager: Notifying renderer that spotlight has been cleared"),this.onSpotlightCleared())}setSmoothingFactor(t){this.config.smoothingFactor=Math.max(.1,Math.min(1,t)),console.log(`Canvas2DOverlayManager: Smoothing factor set to ${this.config.smoothingFactor}`)}setInterpolation(t){this.config.useInterpolation=t,t||(this.lastTransform=null),console.log(`Canvas2DOverlayManager: Interpolation ${t?"enabled":"disabled"}`)}setAutoDeselectThreshold(t){this.state.autoDeselectThreshold=Math.max(.1,Math.min(1,t)),console.log(`Canvas2DOverlayManager: Auto-deselect threshold set to ${this.state.autoDeselectThreshold}`)}updateSelectionZoom(){if(!this.state.isCinematicZooming||!this.state.selectedHotspot){console.log("Canvas2D: updateSelectionZoom skipped - already completed or no hotspot");return}this.cinematicTimeout&&(clearTimeout(this.cinematicTimeout),this.cinematicTimeout=null);const t=this.isMobile?100:50;setTimeout(()=>{var o;const e=this.viewer.viewport.getZoom(),i=this.viewer.viewport.getBounds(),r=this.viewer.viewport.getContainerSize().x/i.width;this.state.selectionZoom=e,this.state.selectionBounds=i,this.state.selectionScale=r,this.state.selectionCenter=this.viewer.viewport.getCenter(),this.state.isCinematicZooming=!1,this.state.cinematicZoomCompleted=!0,this.state.lastPinchZoom=e,console.log("Canvas2DOverlayManager: Stable values captured:"),console.log(`  - Zoom: ${e.toFixed(2)}`),console.log(`  - Scale: ${r.toFixed(1)}`),console.log(`  - Bounds width: ${i.width.toFixed(3)}`),console.log(`  - Previous starting scale: ${((o=this.state.startingScale)==null?void 0:o.toFixed(1))||"null"}`),console.log(`  - Delay: ${t}ms`),console.log("Canvas2DOverlayManager: Ready for fade on dezoom")},t)}autoDeselect(){this.state.selectedHotspot&&(console.log("Canvas2DOverlayManager: Auto-deselecting hotspot"),this.clearSelection(),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.deselectHotspot())}forceCompleteRemoval(){if(!this.context||!this.canvas)return;console.log("Canvas2DOverlayManager: Forcing complete removal of all artifacts");const t=this.viewer.container.getBoundingClientRect();this.context.clearRect(0,0,t.width,t.height);const e=Math.min(window.devicePixelRatio||1,this.config.devicePixelRatioMax);this.context.setTransform(e,0,0,e,0,0),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1,this.canvas.style.opacity="0",this.canvas.style.display="none",this.canvas.offsetHeight,setTimeout(()=>{this.canvas&&(this.canvas.style.display="block",this.canvas.style.opacity="1")},10),this.state.currentOpacity=0,this.state.targetOpacity=0}forceRecalculation(){this.lastTransform=null,console.log("Canvas2DOverlayManager: Forced recalculation")}preRenderMask(t){console.log(`Canvas2DOverlayManager: Pre-rendering mask for hotspot ${t.id}`);let e=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.isMobile&&e.length>this.config.maxVerticesMobile&&(e=this.simplifyPolygon(e,this.config.simplificationTolerance),console.log(`Simplified polygon from ${t.coordinates.length} to ${e.length} vertices`));const i=this.getPolygonBounds(e),n=document.createElement("canvas"),r=0;n.width=i.width+r*2,n.height=i.height+r*2;const o=n.getContext("2d");o.translate(-i.x+r,-i.y+r),o.beginPath(),o.moveTo(e[0][0],e[0][1]);for(let a=1;a<e.length;a++)o.lineTo(e[a][0],e[a][1]);o.closePath(),o.fill(),this.maskCache.set(t.id,{canvas:n,bounds:i,coords:e})}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}isViewportInsideHotspot(){if(!this.state.selectedHotspot)return!1;const t=this.viewer.viewport.getCenter(),e=this.viewer.viewport.viewportToImageCoordinates(t),i=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0];return this.pointInPolygon(e.x,e.y,i)}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const l=e.x+a*n,c=e.y+a*r;return Math.sqrt(Math.pow(t.x-l,2)+Math.pow(t.y-c,2))}pointInPolygon(t,e,i){let n=!1;for(let r=0,o=i.length-1;r<i.length;o=r++){const a=i[r][0],l=i[r][1],c=i[o][0],u=i[o][1];l>e!=u>e&&t<(c-a)*(e-l)/(u-l)+a&&(n=!n)}return n}easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}getPolygonBounds(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}redrawSynchronized(){if(!this.context){console.error("Canvas2DOverlayManager: No context available for redraw!"),this.isInitialized||(console.error("Canvas2DOverlayManager: Manager not initialized, initializing now..."),this.initialize());return}if(!this.state.selectedHotspot){console.warn("Canvas2DOverlayManager: No selected hotspot for redraw");return}const t=this.maskCache.get(this.state.selectedHotspot.id);if(!t){console.error("Canvas2DOverlayManager: No mask data cached for hotspot:",this.state.selectedHotspot.id),this.preRenderMask(this.state.selectedHotspot);return}const e=this.viewer.container.getBoundingClientRect(),i=Math.min(window.devicePixelRatio||1,this.config.devicePixelRatioMax);this.context.clearRect(0,0,e.width,e.height),this.context.setTransform(i,0,0,i,0,0),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1;const n=this.state.currentOpacity*this.config.maxOpacity;this.context.fillStyle=`rgba(0, 0, 0, ${n})`,this.context.fillRect(0,0,e.width,e.height);const r=this.transformCoordinatesPrecise(t.coords),o=.99,a=r.reduce((u,d)=>u+d[0],0)/r.length,l=r.reduce((u,d)=>u+d[1],0)/r.length,c=r.map(u=>{const d=u[0]-a,p=u[1]-l;return[a+d*o,l+p*o]});this.context.save(),this.context.globalCompositeOperation="destination-out",this.context.fillStyle="rgba(255, 255, 255, 1)",this.context.beginPath(),this.context.moveTo(c[0][0],c[0][1]);for(let u=1;u<c.length;u++)this.context.lineTo(c[u][0],c[u][1]);this.context.closePath(),this.context.fill(),this.context.restore()}transformCoordinatesPrecise(t){const e=this.viewer.viewport;return t.map(([i,n])=>{const r=new ft.Point(i,n),o=e.imageToViewportCoordinates(r),a=e.viewportToWindowCoordinates(o);return[a.x,a.y]})}transformCoordinates(t,e=null){if(e){const i=this.viewer.viewport.getContainerSize(),n=e.scale;return t.map(([r,o])=>{const a=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(r,o)),l=a.x*n+i.x/2-e.viewportCenter.x*n,c=a.y*n+i.y/2-e.viewportCenter.y*n;return[l,c]})}else return t.map(([n,r])=>{const o=this.viewer.viewport.imageToViewportCoordinates(new ft.Point(n,r)),a=this.viewer.viewport.viewportToWindowCoordinates(o);return[a.x,a.y]})}handleViewportChange(){}startAnimation(){this.state.isAnimating||(console.log("Canvas2DOverlayManager: Starting animation, target opacity:",this.state.targetOpacity),this.state.isAnimating=!0,this.lastFrameTime=performance.now(),this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const i=this.state.targetOpacity-this.state.currentOpacity;Math.abs(i)>.001?(this.state.currentOpacity+=i*this.config.fadeSpeed,this.redrawSynchronized(),this.animationFrame=requestAnimationFrame(this.animate)):(this.state.currentOpacity=this.state.targetOpacity,this.state.isAnimating=!1,this.state.currentOpacity===0&&(this.canvas.style.display="none",this.state.selectedHotspot&&this.onSpotlightCleared&&(console.log(" [SPOTLIGHT] Canvas2DOverlayManager: Spotlight fully faded out, notifying renderer"),this.onSpotlightCleared()))),this.updatePerformanceMetrics(t)}redrawSmooth(t){if(!this.context||!this.state.selectedHotspot)return;const e=performance.now();this.canvas.style.display==="none"&&(this.canvas.style.display="block");const i=Math.min(window.devicePixelRatio||1,this.config.devicePixelRatioMax),n=this.viewer.container.getBoundingClientRect();this.context.clearRect(0,0,n.width,n.height),this.context.setTransform(i,0,0,i,0,0),this.context.globalCompositeOperation="source-over";const r=this.state.currentOpacity*this.config.maxOpacity;this.context.save(),this.context.globalAlpha=r,this.context.fillStyle="black",this.context.fillRect(0,0,n.width,n.height),this.context.restore();const o=this.maskCache.get(this.state.selectedHotspot.id);if(!o){console.warn("Canvas2DOverlayManager: No mask data found for hotspot");return}const a=this.transformCoordinates(o.coords,t),l=.99,c=a.reduce((m,y)=>m+y[0],0)/a.length,u=a.reduce((m,y)=>m+y[1],0)/a.length,d=a.map(m=>{const y=m[0]-c,_=m[1]-u;return[c+y*l,u+_*l]});this.context.save(),this.context.globalCompositeOperation="destination-out",this.context.imageSmoothingEnabled=!0,this.context.imageSmoothingQuality="high",this.context.fillStyle="rgba(255, 255, 255, 1)",this.context.beginPath(),this.context.moveTo(d[0][0],d[0][1]);for(let m=1;m<d.length;m++)this.context.lineTo(d[m][0],d[m][1]);this.context.closePath(),this.context.fill(),this.context.restore();const p=performance.now()-e;this.frameHistory.push(p),this.frameHistory.length>60&&this.frameHistory.shift()}redraw(){if(!this.context||!this.state.selectedHotspot)return;this.canvas.style.display==="none"&&(this.canvas.style.display="block");const t=Math.min(window.devicePixelRatio||1,this.config.devicePixelRatioMax),e=this.viewer.container.getBoundingClientRect();this.context.clearRect(0,0,e.width,e.height),this.context.setTransform(t,0,0,t,0,0),this.context.globalCompositeOperation="source-over";const i=this.state.currentOpacity*this.config.maxOpacity;this.context.save(),this.context.globalAlpha=i,this.context.fillStyle="black",this.context.fillRect(0,0,e.width,e.height),this.context.restore();const n=this.maskCache.get(this.state.selectedHotspot.id);if(!n){console.warn("Canvas2DOverlayManager: No mask data found for hotspot");return}const r=this.transformCoordinates(n.coords);this.context.save(),this.context.globalCompositeOperation="destination-out",this.context.fillStyle="rgba(255, 255, 255, 1)",this.context.beginPath(),this.context.moveTo(r[0][0],r[0][1]);for(let o=1;o<r.length;o++)this.context.lineTo(r[o][0],r[o][1]);this.context.closePath(),this.context.fill(),this.context.restore()}updatePerformanceMetrics(t){this.frameCount++,t-this.lastFrameTime>=1e3&&(this.frameCount,this.frameHistory.length>0&&this.frameHistory.reduce((e,i)=>e+i)/this.frameHistory.length,this.frameCount=0,this.lastFrameTime=t)}startMagneticInkReveal(t,e,i){if(!this.magneticInkAnimator){console.error("Canvas2DOverlayManager: MagneticInkAnimator not initialized");return}console.log("Canvas2DOverlayManager: Starting magnetic ink reveal",{central:t==null?void 0:t.id,secondary:e==null?void 0:e.length,tapPoint:i}),this.magneticInkAnimator.startReveal(t,e,i)}clearMagneticInkAnimation(){this.magneticInkAnimator&&this.magneticInkAnimator.clearAnimations()}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.magneticInkAnimator&&(this.magneticInkAnimator.destroy(),this.magneticInkAnimator=null),this.viewer&&(this.viewer.removeHandler("update-viewport",this.updateHandler),this.viewer.removeHandler("resize")),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.debugDiv&&this.debugDiv.parentNode&&(this.debugDiv.parentNode.removeChild(this.debugDiv),this.debugDiv=null),this.viewer&&this.viewer.container.classList.remove("canvas2d-active"),this.maskCache.clear(),this.transformCache.clear(),this.canvas=null,this.context=null,this.viewer=null,this.isInitialized=!1}}class ai{static create(t,e=null){const i=this.detectBrowser(),n=this.detectPerformanceCapabilities();return console.log("Browser detection:",{isSafari:i.isSafari,isIOS:i.isIOS,isWebKit:i.isWebKit,isMobile:n.isMobile,isLowEnd:n.isLowEnd,userAgent:navigator.userAgent}),i.isSafari||i.isIOS||i.isMacOSSafari||i.isWebKit&&!window.chrome?(console.log("Using Canvas2DOverlayManager for Safari/WebKit browser (reliable sharp outline)"),new js(t)):n.isMobile?n.isMobile?(console.log("Using Canvas2DOverlayManager for mobile performance optimization"),new js(t)):(console.log("Using CSSOverlayManager (default)"),new Us(t)):(console.log("Using CSSOverlayManager for non-Safari desktop browser"),new Us(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r=n&&!i&&/Mac/.test(e),o="WebkitAppearance"in document.documentElement.style&&!window.chrome,a=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:o,isIOSChrome:a,isMacOSSafari:r,isWebKitBased:n||i||a}}static detectPerformanceCapabilities(){var m;const t=navigator.userAgent.toLowerCase(),e=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(t),i=navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,n=window.screen.width,r=window.screen.height,o=Math.min(n,r)>768,a=e||i||("ontouchstart"in window||navigator.maxTouchPoints>0)&&!o,l=navigator.hardwareConcurrency||4,c=navigator.deviceMemory||4,u=((m=navigator.connection)==null?void 0:m.effectiveType)||"4g",d=l<=2||c<=2||u==="slow-2g"||u==="2g"||u==="3g",p=a||d&&l<=4;return{isMobile:a,isLowEnd:d,cores:l,memory:c,connection:u,shouldUseCanvas2D:p,screenWidth:window.screen.width,screenHeight:window.screen.height,pixelRatio:window.devicePixelRatio||1}}static setPreference(t){return t==="css"||t==="safari"||t==="canvas2d"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css', 'safari', or 'canvas2d'.`),!1)}static clearPreference(){localStorage.removeItem("overlayType"),console.log("Overlay preference cleared - will use auto-detection")}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari"||e==="canvas2d")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"||i==="canvas2d"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t,e=null){var o;const i=this.detectBrowser();!this.detectPerformanceCapabilities().isMobile&&!i.isSafari&&!i.isWebKit&&localStorage.getItem("overlayType")==="canvas2d"&&(console.log("CLEANUP: Removing invalid canvas2d preference for desktop Chrome/Firefox"),localStorage.removeItem("overlayType"));const r=this.getCurrentType();if(r==="safari"){console.log("Creating SafariOverlayManager (forced)");const a=e||((o=window.nativeHotspotRenderer)==null?void 0:o.colorScheme);return new fd(t,a)}else{if(r==="css")return console.log("Creating CSSOverlayManager (forced)"),new Us(t);if(r==="canvas2d")return console.log("Creating Canvas2DOverlayManager (forced)"),new js(t)}return this.create(t,e)}}typeof window<"u"&&(window.OverlayManagerFactory=ai,window.clearOverlayPreference=()=>{localStorage.removeItem("overlayType"),console.log("Overlay preference cleared - will use auto-detection on next reload")},console.log("Debug: Use window.clearOverlayPreference() to reset overlay type"));function vd(){var mr,Ri,xn,Zi,Ai,Ft,En;const[s,t]=re(!0),[e,i]=re(!1),[n,r]=re(!1);console.log("[useViewerState] Initializing state:",{isLoading:s(),viewerReady:e(),previewLoaded:n()});const[o,a]=re(null),[l,c]=re(null),[u,d]=re(null),[p,m]=re(null),[y,_]=re(!1),[T,x]=re(!1),[V,L]=re(!1),[W,J]=re(!1),[ee,F]=re({x:0,y:0}),[E,P]=re(!1),[M,k]=re(!1),[D,I]=re({}),[Ce,q]=re(null),[ne,te]=re(parseInt(localStorage.getItem("debugLevel")??"1")),[$,H]=re(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[se,ce]=re(((mr=window.safariTuning)==null?void 0:mr.circleMultiplier)||(Ge()?.8:1.2)),[ue,Y]=re(((Ri=window.safariTuning)==null?void 0:Ri.ellipseMultiplierX)||(Ge()?.8:1.15)),[oe,le]=re(((xn=window.safariTuning)==null?void 0:xn.ellipseMultiplierY)||(Ge()?.8:1.15)),[_e,ge]=re(((Zi=window.safariTuning)==null?void 0:Zi.gradientMultiplier)||(Ge()?1:1.5)),[Oe,qe]=re(((Ai=window.safariTuning)==null?void 0:Ai.offsetX)||0),[De,Te]=re(((Ft=window.safariTuning)==null?void 0:Ft.offsetY)||0),[Se,Ae]=re(.8),[pe,be]=re(!0),[Xe,g]=re(.5),[S,N]=re(.3),[X,B]=re(!1),[ae,G]=re({x:0,y:0}),[de,xe]=re(!1),[we,fe]=re({x:0,y:0}),[Ne,b]=re(0),[w,C]=re(null),A=(ze,Ii,Sn,yr=!1)=>{if(yr)return Ii;const ri=localStorage.getItem(ze);return ri&&Sn.includes(ri)?ri:(ri&&(console.warn(`[useViewerState] Invalid ${ze} value: "${ri}". Using default: ${Ii}`),localStorage.removeItem(ze)),Ii)},U=()=>{if(!Ge())return A("revealType","single",["single","border-radial"],!1);const ze=localStorage.getItem("hasSetRevealPreference");return localStorage.getItem("revealType"),ze?A("revealType","single",["single","refined","refined2","border-radial"],!1):(console.log("[useViewerState] Mobile first visit or no preference set - defaulting to single"),"single")},[ie,Ee]=re(A("interactionMode",Ge()?"temporal":"direct",["direct","temporal"])),[je,Re]=re(U()),ct=ze=>{Ee(ze),localStorage.setItem("interactionMode",ze),window.modeStateManager&&(window.modeStateManager.setMode(ze),console.log(`[useViewerState] Synced interaction mode to ModeStateManager: ${ze}`)),window.eventCoordinator&&(window.eventCoordinator.currentMode=ze,console.log(`[useViewerState] Updated EventCoordinator mode: ${ze}`))},$e=ze=>{console.log(`[useViewerState] setRevealType called with: ${ze}`),Re(ze),localStorage.setItem("revealType",ze),localStorage.setItem("hasSetRevealPreference","true"),console.log(`[useViewerState] User preference saved: ${ze}`),window.temporalEchoController?(window.temporalEchoController.setRevealType(ze),console.log(`[useViewerState] Updated TemporalEchoController reveal type: ${ze}`),console.log("[useViewerState] Controller config now:",window.temporalEchoController.config.revealType)):console.log("[useViewerState] TemporalEchoController not found yet. Mode saved in localStorage and will be applied when controller initializes.")},[Mt,kt]=re(localStorage.getItem("revealStyle")||"invert"),[ni,Xt]=re(localStorage.getItem("borderStyle")||"default"),[Yt,dr]=re({}),[Gi,pr]=re(null),[Ei,fr]=re(null),[gt,gr]=re(((En=window.nativeHotspotRenderer)==null?void 0:En.currentPalette)||"tech"),[Si,Pi]=re(ai.getCurrentType()||(ai.detectBrowser().isWebKitBased?"safari":"css"));return{isLoading:s,setIsLoading:ze=>{console.log(`[useViewerState] setIsLoading called with: ${ze}`),t(ze)},viewerReady:e,setViewerReady:ze=>{console.log(`[useViewerState] setViewerReady called with: ${ze}`),i(ze)},previewLoaded:n,setPreviewLoaded:r,hoveredHotspot:o,setHoveredHotspot:a,selectedHotspot:l,setSelectedHotspot:c,currentPlayingHotspot:u,setCurrentPlayingHotspot:d,currentMediaHotspot:p,setCurrentMediaHotspot:m,showExpandButton:y,setShowExpandButton:_,expandButtonFading:T,setExpandButtonFading:x,isFullscreen:V,setIsFullscreen:L,showMediaButton:W,setShowMediaButton:J,mediaButtonPosition:ee,setMediaButtonPosition:F,isZoomingToHotspot:E,setIsZoomingToHotspot:P,isExpandingToFullView:M,setIsExpandingToFullView:k,components:D,setComponents:I,modeStateManager:Ce,setModeStateManager:q,debugLevel:ne,setDebugLevel:te,zoomSpeedMultiplier:$,setZoomSpeedMultiplier:H,circleMultiplierValue:se,setCircleMultiplierValue:ce,ellipseXValue:ue,setEllipseXValue:Y,ellipseYValue:oe,setEllipseYValue:le,gradientSpreadValue:_e,setGradientSpreadValue:ge,offsetXValue:Oe,setOffsetXValue:qe,offsetYValue:De,setOffsetYValue:Te,smoothingFactorValue:Se,setSmoothingFactorValue:Ae,interpolationEnabled:pe,setInterpolationEnabled:be,autoDeselectThreshold:Xe,setAutoDeselectThreshold:g,panDeselectThreshold:S,setPanDeselectThreshold:N,showFloatingPanel:X,setShowFloatingPanel:B,panelPosition:ae,setPanelPosition:G,isDragging:de,setIsDragging:xe,dragStart:we,setDragStart:fe,tapCount:Ne,setTapCount:b,tapTimeout:w,setTapTimeout:C,interactionMode:ie,setInteractionMode:ct,revealType:je,setRevealType:$e,revealStyle:Mt,setRevealStyle:kt,updateRevealStyle:ze=>{kt(ze),localStorage.setItem("revealStyle",ze),window.updateRevealStyle&&window.updateRevealStyle(ze)},borderStyle:ni,setBorderStyle:Xt,updateBorderStyle:ze=>{Xt(ze),localStorage.setItem("borderStyle",ze),window.updateBorderStyle&&window.updateBorderStyle(ze)},performanceMetrics:Yt,setPerformanceMetrics:dr,safariHybridMetrics:Gi,setSafariHybridMetrics:pr,performanceStatus:Ei,setPerformanceStatus:fr,currentPalette:gt,setCurrentPalette:gr,currentOverlayType:Si,setCurrentOverlayType:Pi}}const Do=(s,t,e)=>{let i;if(s.coordinates){let x=1/0,V=1/0,L=-1/0,W=-1/0;(ee=>{Array.isArray(ee[0])&&typeof ee[0][0]=="number"?ee.forEach(([F,E])=>{x=Math.min(x,F),V=Math.min(V,E),L=Math.max(L,F),W=Math.max(W,E)}):ee.forEach(F=>{F.forEach(([E,P])=>{x=Math.min(x,E),V=Math.min(V,P),L=Math.max(L,E),W=Math.max(W,P)})})})(s.coordinates),i={minX:x,minY:V,maxX:L,maxY:W}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new ft.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new ft.Point(i.maxX,i.maxY)),a=o.x-r.x,l=o.y-r.y,c=r.x+a/2,u=r.y+l/2,d=t.viewport.getAspectRatio(),p=a/l,m=e?.85:.8;let y,_;p>d?(y=a/m,_=y/d):(_=l/m,y=_*d);const T=new ft.Rect(c-y/2,u-_/2,y,_);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:c,y:u},dimensions:{width:y,height:_},aspectRatios:{hotspot:p.toFixed(2),viewport:d.toFixed(2)},paddingFactor:m,zoomBounds:T}),T},wd=Object.freeze(Object.defineProperty({__proto__:null,calculateHotspotBounds:Do},Symbol.toStringTag,{value:"Module"}));let sn=new Map,on=null,Bn=null,an=!1,Oi=null,Vi=null,Hn=!1;function xT(s){if(console.log("=== APPLYING ENHANCED TILE CASCADE FIX ==="),!s){console.error("OpenSeadragon not provided - cannot apply tile cascade fix");return}if(Hn){console.log("TileCascadeFix already applied - skipping to prevent recursion");return}if(Oi||(Oi=s.TiledImage.prototype._getLevelsInterval),Vi||(Vi=s.TiledImage.prototype._updateLevels),!Oi){console.error("_getLevelsInterval method not found - cannot apply fix");return}s.TiledImage.prototype._getLevelsInterval=function(){const t=this.viewer.viewport.getZoom();if(an)return Oi.call(this);if(on!==null&&Math.abs(t-on)<.01&&sn.has(this))return sn.get(this);const e=Oi.call(this);if(!e||typeof e.lowestLevel>"u")return e;let i=e;const n=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;if(t<3&&!n){const r=/Android|iPhone|iPad/i.test(navigator.userAgent),o=Math.floor(Math.log2(t*1024/256)),a=Math.max(8,Math.min(12,o+11)),l=an?4:2;i={lowestLevel:Math.max(8,a-Math.floor(l/2)),highestLevel:Math.min(14,a+Math.floor(l/2))},i.highestLevel-i.lowestLevel>l-1&&(i.lowestLevel=i.highestLevel-(l-1))}return sn.set(this,i),on=t,Bn&&clearTimeout(Bn),Bn=setTimeout(()=>{sn.clear(),on=null},100),i},Vi&&(s.TiledImage.prototype._updateLevels=function(){if(this.viewer.isAnimating()||an)return Vi.call(this);const t=Vi.call(this),e=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;if(this.viewer.viewport.getZoom()<3&&this._tilesToDraw&&!an&&!e){const n=this._getLevelsInterval();this._tilesToDraw=this._tilesToDraw.filter(r=>r.level>=n.lowestLevel&&r.level<=n.highestLevel)}return t}),Hn=!0,console.log("=== ENHANCED TILE CASCADE FIX APPLIED ===")}function Ji(s){an=s,s&&(sn.clear(),on=null),console.log(`TileCascadeFix: Cinematic mode ${s?"ENABLED":"DISABLED"}`)}function ET(s){sn.clear(),on=null,an=!1,Bn&&clearTimeout(Bn),Hn&&s&&Oi&&(s.TiledImage.prototype._getLevelsInterval=Oi),Hn&&s&&Vi&&(s.TiledImage.prototype._updateLevels=Vi),Hn=!1,console.log("=== TILE CASCADE FIX REMOVED ===")}function _d(s,t,e){const{isZoomingToHotspot:i,setIsZoomingToHotspot:n,isExpandingToFullView:r,setIsExpandingToFullView:o,setShowExpandButton:a,zoomSpeedMultiplier:l}=t;return{isHotspotWellFramed:(m,y)=>{if(!s||!y)return!1;const _=s.viewport.getBounds();s.viewport.getZoom();const T=s.viewport.imageToViewportRectangle(y.x,y.y,y.width,y.height),x=_.intersection(T);if(!x)return!1;const V=T.width*T.height,W=x.width*x.height/V,J=T.getCenter(),ee=_.getCenter(),F=Math.sqrt(Math.pow(J.x-ee.x,2)+Math.pow(J.y-ee.y,2)),E=W>.8&&F<.1;return console.log("Well-framed check:",{overlapRatio:W,centerDistance:F,isWellFramed:E}),E},zoomToHotspot:async m=>{if(console.log(" Starting stabilized cinematic zoom",{hotspotId:m.id,isZoomingToHotspot:i()}),!s||i()||r())return;const y=Do(m,s,Ge());if(!y)return;n(!0);const _=e().cinematicZoomManager;if(!_){console.error("CinematicZoomManager not initialized"),n(!1);return}Ji(!0);const T={type:"consciousness",useSpringPhysics:!0,onComplete:()=>{var x;console.log(" Cinematic zoom completed"),n(!1),a(!0),((x=e().overlayManager)==null?void 0:x.constructor.name)==="Canvas2DOverlayManager"&&e().overlayManager.updateSelectionZoom&&e().overlayManager.updateSelectionZoom(),Ji(!1),s.forceRedraw(),e().renderer&&(Ge()&&e().renderer.showOverlay(),setTimeout(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibility(),e().renderer.styleManager&&e().renderer.styleManager.animationsPaused&&(console.log("[useViewerAnimations]  Force resuming stuck animations after zoom"),e().renderer.styleManager.resumeAllAnimations())},100))}};try{e().renderer&&(e().renderer.pauseUpdates(),Ge()&&e().renderer.hideOverlay()),e().overlayManager&&e().overlayManager.startZoomAnimation&&e().overlayManager.startZoomAnimation(),await _.performAdaptiveZoom(y,T)}catch(x){console.error("Cinematic zoom failed:",x),n(!1),Ji(!1)}},cleanupExpandAnimation:()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(m=>clearTimeout(m)),window.expandToFullViewTimeouts=[])},expandToFullView:async()=>{if(console.log("expandToFullView with stabilized zoom"),!s||r())return;i()&&n(!1),a(!1),o(!0),e().renderer&&e().renderer.deselectHotspot&&(console.log("Calling renderer.deselectHotspot() to properly reset visual states"),e().renderer.deselectHotspot()),window.artworkViewerHandleHotspotClick&&(console.log("Clearing selected hotspot for full view expansion using handleHotspotClick"),window.artworkViewerHandleHotspotClick(null));const m=s.world.getItemAt(0);if(!m){o(!1);return}const y=m.getBounds(),_=e().cinematicZoomManager;if(!_){console.error("CinematicZoomManager not initialized"),o(!1);return}Ji(!0);const T={animationTime:Ge()?.7:.9,springStiffness:Ge()?9:7,onComplete:()=>{console.log(" Full view expansion completed"),o(!1),Ji(!1),s.forceRedraw(),e().renderer&&(Ge()&&e().renderer.showOverlay(),setTimeout(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibility(),e().renderer.styleManager&&e().renderer.styleManager.animationsPaused&&(console.log("[useViewerAnimations]  Force resuming stuck animations after zoom"),e().renderer.styleManager.resumeAllAnimations())},100))}};try{e().renderer&&(e().renderer.pauseUpdates(),Ge()&&e().renderer.hideOverlay()),await _.performCinematicZoom(y,T)}catch(x){console.error("Full view expansion failed:",x),o(!1),Ji(!1)}}}}var Td=O('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),bd=O('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),xd=O('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),Ed=O('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),Sd=O('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),Pd=O('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),Cd=O('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),Rd=O("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),Ad=O('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+)">'),Id=O('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+)">'),Dd=O("<input type=range class=volume-slider min=0 max=100>"),Md=O("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+: Skip</span><span>M: Mute</span><span>Esc: Minimize"),kd=O('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),Fd=O("<div>");const ol=()=>Td(),al=()=>bd(),Od=()=>xd(),Vd=()=>Ed(),Ld=()=>Sd(),Nd=()=>Pd(),zd=()=>Cd();function Bd(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=re(!0),[r,o]=re(!1),[a,l]=re(0),[c,u]=re(0),[d,p]=re(0),[m,y]=re(80),[_,T]=re(!1),[x,V]=re(!1),[L,W]=re(!0),[J,ee]=re(!1);Li(()=>{e()&&r()&&i()&&(ee(!0),setTimeout(()=>ee(!1),500))});const F=()=>window.innerWidth<=768;Li(()=>{t&&(t.onProgress=$=>{x()||(l($.percent),u($.current),p($.duration))},t.onPlaybackStart=()=>{o(!0),i()&&L()?(n(!1),W(!1)):i()||W(!1)},t.onPlaybackEnd=()=>{o(!1),l(0),u(0)},t.setVolume(m()/100))}),Li(()=>{const $=H=>{if(e()&&H.target.tagName!=="INPUT")switch(H.key){case" ":i()||(H.preventDefault(),E());break;case"ArrowLeft":H.shiftKey&&!i()&&(H.preventDefault(),M());break;case"ArrowRight":H.shiftKey&&!i()&&(H.preventDefault(),P());break;case"m":case"M":i()||k();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",$),Zn(()=>window.removeEventListener("keydown",$))}),Li(()=>{if(t){const $=t.getState();o($.isPlaying),T($.isMuted)}});const E=()=>{!t||!e()||(r()?t.pause():t.resume())},P=()=>{t&&t.skip(15)},M=()=>{t&&t.skip(-15)},k=()=>{if(!t)return;const $=t.toggleMute();T($)},D=$=>{if(!t)return;const H=$.currentTarget.getBoundingClientRect(),se=($.clientX-H.left)/H.width*100;t.seekToPercent(se),l(se)},I=$=>{if(!x())return;const H=$.currentTarget.getBoundingClientRect(),se=Math.max(0,Math.min(100,($.clientX-H.left)/H.width*100));l(se)},Ce=()=>{x()&&t&&(t.seekToPercent(a()),V(!1))},q=$=>{const H=parseInt($.target.value);y(H),t&&(t.setVolume(H/100),H>0&&_()&&(t.toggleMute(),T(!1)))},ne=$=>{if(!$||isNaN($))return"0:00";const H=Math.floor($/60),se=Math.floor($%60);return`${H}:${se.toString().padStart(2,"0")}`},te=()=>{const $=e();return $?$.narrationTitle||`Hotspot ${$.id}`:""};return me(ke,{get when(){return e()},get children(){var $=Fd();return $.addEventListener("mouseleave",Ce),$.$$mouseup=Ce,Z($,me(ke,{get when(){return i()},get children(){var H=Rd(),se=H.firstChild,ce=se.nextSibling,ue=ce.firstChild;return se.$$click=()=>{r()?E():n(!1)},Z(se,(()=>{var Y=Dt(()=>!!r());return()=>Y()?me(al,{}):me(ol,{})})()),Z(ue,te),Le(Y=>{var oe=`btn-play-mini ${r()?"playing":""} ${J()?"changing":""}`,le=r()?"Pause":"Play";return oe!==Y.e&&it(se,Y.e=oe),le!==Y.t&&Bt(se,"title",Y.t=le),Y},{e:void 0,t:void 0}),H}}),null),Z($,me(ke,{get when(){return!i()},get children(){var H=kd(),se=H.firstChild,ce=se.firstChild,ue=ce.nextSibling,Y=se.nextSibling,oe=Y.firstChild,le=oe.nextSibling,_e=le.firstChild,ge=_e.firstChild,Oe=ge.nextSibling,qe=le.nextSibling,De=Y.nextSibling,Te=De.firstChild,Se=Te.firstChild,Ae=Te.nextSibling,pe=Ae.firstChild;return Z(ce,te),ue.$$click=()=>n(!0),Z(ue,me(zd,{})),Z(oe,()=>ne(c())),le.$$mousemove=I,le.$$mousedown=()=>V(!0),le.$$click=D,Z(qe,()=>ne(d())),Z(Te,me(ke,{get when(){return!F()},get children(){var be=Ad();return be.$$click=M,Z(be,me(Od,{})),be}}),Se),Se.$$click=E,Z(Se,me(ke,{get when(){return!r()},get children(){return me(ol,{})}}),null),Z(Se,me(ke,{get when(){return r()},get children(){return me(al,{})}}),null),Z(Te,me(ke,{get when(){return!F()},get children(){var be=Id();return be.$$click=P,Z(be,me(Vd,{})),be}}),null),pe.$$click=k,Z(pe,me(ke,{get when(){return Dt(()=>!_())()&&m()>0},get children(){return me(Ld,{})}}),null),Z(pe,me(ke,{get when(){return _()||m()===0},get children(){return me(Nd,{})}}),null),Z(Ae,me(ke,{get when(){return!F()},get children(){var be=Dd();return be.$$input=q,Le(()=>Bt(be,"title",`Volume: ${m()}%`)),Le(()=>be.value=m()),be}}),null),Z(H,me(ke,{when:!1,get children(){return Md()}}),null),Le(be=>{var Xe=`${a()}%`,g=`${a()}%`,S=`btn-play ${r()?"playing":""}`,N=r()?"Pause (Space)":"Play (Space)",X=_()?"Unmute (M)":"Mute (M)";return Xe!==be.e&&((be.e=Xe)!=null?ge.style.setProperty("width",Xe):ge.style.removeProperty("width")),g!==be.t&&((be.t=g)!=null?Oe.style.setProperty("left",g):Oe.style.removeProperty("left")),S!==be.a&&it(Se,be.a=S),N!==be.o&&Bt(Se,"title",be.o=N),X!==be.i&&Bt(pe,"title",be.i=X),be},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),H}}),null),Le(()=>it($,`audio-player ${i()?"minimized":""} ${F()?"mobile":"desktop"}`)),$}})}ii(["mouseup","click","mousedown","mousemove","input"]);ii(["click"]);function no(s,t){if(navigator.vibrate)try{navigator.vibrate(50)}catch{}if(t&&s){const e=document.createElement("span");e.className="ripple";const i=t.getBoundingClientRect(),n=Math.max(i.width,i.height),r=s.touches?s.touches[0].clientX:s.clientX,o=s.touches?s.touches[0].clientY:s.clientY,a=r-i.left-n/2,l=o-i.top-n/2;e.style.width=e.style.height=n+"px",e.style.left=a+"px",e.style.top=l+"px",t.appendChild(e),setTimeout(()=>e.remove(),600)}t&&(t.classList.add("tapped"),setTimeout(()=>t.classList.remove("tapped"),200))}ii(["click"]);ii(["click"]);const Ws="app_cache_version",qs="1.0.2";class Hd{constructor(){this.storageAvailable=this.checkStorageAvailability(),this.storageAvailable?this.checkVersion():console.warn("[CacheManager] Storage not available (private browsing or disabled)")}checkStorageAvailability(){try{const t="__cache_test__";return localStorage.setItem(t,"test"),localStorage.removeItem(t),!0}catch{return!1}}checkVersion(){if(this.storageAvailable)try{const t=localStorage.getItem(Ws),e=localStorage.getItem("revealType");(e==="refined"||e==="refined2")&&(console.log(`[CacheManager] Migrating revealType from '${e}' to 'single'`),localStorage.setItem("revealType","single")),t!==qs&&(console.log(`[CacheManager] Version mismatch (stored: ${t}, current: ${qs}). Clearing cache...`),this.clearAll(),localStorage.setItem(Ws,qs))}catch(t){console.error("[CacheManager] Error checking version:",t)}}clearAll(){if(this.storageAvailable)try{const t=[Ws],e={};t.forEach(i=>{const n=localStorage.getItem(i);n!==null&&(e[i]=n)}),localStorage.clear(),sessionStorage.clear(),Object.entries(e).forEach(([i,n])=>{localStorage.setItem(i,n)}),console.log("[CacheManager] Cache cleared successfully")}catch(t){console.error("[CacheManager] Error clearing cache:",t)}}initDevelopmentMode(){this.storageAvailable}clearStaleData(){if(this.storageAvailable)try{["debugTuningValues","rendererState","modeState","viewer_state","hotspot_state","animation_state","revealStyle","revealType","hasSetRevealPreference","borderStyle","interactionMode","temporalRevealStyle","consciousnessMode","performanceMode"].forEach(e=>{localStorage.removeItem(e)})}catch(t){console.error("[CacheManager] Error clearing stale data:",t)}}forceReset(){console.log("[CacheManager] Force reset triggered"),this.clearAll(),window.location.reload()}}const ro=new Hd;ro.initDevelopmentMode();var Ud=O("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>Hovered</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Selected</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Type</span><span class=debug-stat-value>"),jd=O('<div class=debug-stat-row style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);"><span class=debug-stat-label style=color:#00ffff;>Safari Hybrid</span><span class=debug-stat-value style=color:#00ffff;>Active'),Wd=O("<div class=debug-stat-row><span class=debug-stat-label>Render Time</span><span class=debug-stat-value>ms"),qd=O("<div class=debug-stat-row><span class=debug-stat-label>Visible/Total</span><span class=debug-stat-value>/"),Gd=O("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>FPS</span><span class=debug-stat-value><span style=opacity:0.7;font-size:10px> (avg: <!>)</span></span></div><div class=debug-stat-row><span class=debug-stat-label>Status</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Memory</span><span class=debug-stat-value>MB</span></div><div class=debug-stat-row><span class=debug-stat-label>Frame Time</span><span class=debug-stat-value>ms</span></div><div class=debug-stat-row><span class=debug-stat-label>Zoom</span><span class=debug-stat-value>x"),Zd=O("<div class=debug-control><label class=debug-control-label>Zoom Animation Speed<span class=debug-control-value>x</span></label><input type=range class=debug-slider min=0.5 max=2.5 step=0.1><p class=debug-control-description>How fast the artwork zooms when you click on elements"),Xd=O('<div class=debug-control><label class=debug-control-label>Color Theme<span class=debug-help-icon title="Changes the highlight colors">?</span></label><div class=debug-toggle-group><button type=button>Cyan Tech</button><button type=button>Golden Magic</button><button type=button>Blue Moon</button></div><div class=debug-toggle-group style=margin-top:8px;><button type=button>Pure White</button><button type=button>Soft White</button><button type=button>Dark Mode'),Yd=O("<div class=debug-control><label class=debug-control-label>Stroke Animation Speed</label><div style=display:flex;align-items:center;gap:12px;><span style=font-size:11px;color:#888;min-width:30px;>Fast</span><input type=range min=0.3 max=4.0 step=0.1 style=flex:1;cursor:pointer;><span style=font-size:11px;color:#888;min-width:30px;text-align:right;>Slow</span></div><p class=debug-control-description style=margin-top:8px;text-align:center;><span style=color:#666;font-size:10px;>"),Kd=O("<div class=debug-control><label class=debug-control-label>Hotspot Reveal Mode</label><div class=debug-toggle-group><button type=button>Focus</button><button type=button>Ripple (experimental)</button></div><p class=debug-control-description>"),ll=O("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>FPS Target</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Effects</span><span class=debug-stat-value style=font-size:10px;></span></div><div class=debug-stat-row><span class=debug-stat-label>GPU</span><span class=debug-stat-value>"),cl=O('<div class=debug-control style=margin-top:16px;><button class="debug-toggle-option active"style=width:100%; type=button>Test Random Zoom'),Qd=O("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>Cache Version</span><span class=debug-stat-value>1.0.2</span></div><div class=debug-stat-row><span class=debug-stat-label>Status</span><span class=debug-stat-value>Active</span></div><div class=debug-stat-row><span class=debug-stat-label>localStorage Size</span><span class=debug-stat-value>"),Jd=O("<div class=debug-control style=margin-top:16px;><button class=debug-toggle-option> Clear Cache & Reload</button><p class=debug-control-description>Fixes stuck animations and broken hover states"),$d=O("<button class=glass-button> Initialize Audio"),ep=O('<div style=margin-bottom:20px;><h4 style="margin:0 0 12px 0;color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Sand Variations  OSRS Style</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;"><button class=glass-button>Sand Shift</button><button class=glass-button>Sand Crystal</button><button class=glass-button>Sand Whisper</button><button class=glass-button>Sand Trickle</button><button class=glass-button>Sand Magic</button><button class=glass-button> Random Sand'),tp=O('<div><h4 style="margin:0 0 12px 0;color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Activate  Hotspot Click</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;"><button>Absorbed Impact</button><button>Paper Wave</button><button>Ink Saturation</button><button>Surface Echo'),ip=O('<div style="margin-top:16px;padding:10px;background:rgba(0, 0, 0, 0.2);border:1px solid rgba(255, 255, 255, 0.05);border-radius:4px;"><p style=font-size:10px;color:#666;margin:0;line-height:1.4;><span style=color:#999>Reveal:</span> <br><span style=color:#999>Activate:</span> '),np=O("<div class=debug-stats-classic>"),rp=O('<div><button style=background:none;border:none;color:#fff;font-size:14px;padding:8px;cursor:pointer;opacity:0.8;hover:opacity:1;> Last</button><button style=background:none;border:none;color:#fff;font-size:14px;padding:8px;cursor:pointer;opacity:0.8;> 15</button><button style="background:none;border:none;color:#fff;font-size:18px;padding:8px 16px;cursor:pointer;"></button><button style=background:none;border:none;color:#fff;font-size:14px;padding:8px;cursor:pointer;opacity:0.8;>15 </button><button style=background:none;border:none;color:#fff;font-size:14px;padding:8px;cursor:pointer;opacity:0.8;>Next '),sp=O('<div><button style=background:none;border:none;color:rgba(255,255,255,0.5);font-size:12px;padding:4px;cursor:pointer;></button><button style=background:none;border:none;color:rgba(255,255,255,0.5);font-size:10px;padding:4px;cursor:pointer;>-15</button><button style="background:none;border:none;color:#fff;font-size:16px;padding:4px 8px;cursor:pointer;"></button><button style=background:none;border:none;color:rgba(255,255,255,0.5);font-size:10px;padding:4px;cursor:pointer;>+15</button><button style=background:none;border:none;color:rgba(255,255,255,0.5);font-size:12px;padding:4px;cursor:pointer;>'),op=O("<div><div><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:16px;padding:4px;cursor:pointer;></button><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:14px;padding:4px;cursor:pointer;></button><button style=background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:18px;padding:8px;border-radius:50%;width:40px;height:40px;cursor:pointer;></button><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:14px;padding:4px;cursor:pointer;></button><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:16px;padding:4px;cursor:pointer;>"),ap=O('<div><div style=display:flex;align-items:center;justify-content:center;gap:24px;margin-bottom:12px;><button style="background:none;border:none;color:rgba(255,255,255,0.7);font-size:18px;cursor:pointer;transition:color 0.2s;"></button><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:16px;cursor:pointer;></button><button style=background:#1db954;border:none;color:#000;font-size:16px;padding:0;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;></button><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:16px;cursor:pointer;></button><button style=background:none;border:none;color:rgba(255,255,255,0.7);font-size:18px;cursor:pointer;></button></div><div style=display:flex;align-items:center;gap:8px;><span style=font-size:11px;color:rgba(255,255,255,0.5);>0:00</span><div style=flex:1;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;position:relative;><div style=position:absolute;left:0;top:0;width:30%;height:100%;background:#1db954;border-radius:2px;></div></div><span style=font-size:11px;color:rgba(255,255,255,0.5);>1:30'),lp=O(`<div class=debug-stats-classic><div style=margin-bottom:20px;><h4 style="margin:0 0 12px 0;color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Select Player Style</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"><button class=glass-button>Deji's Vision</button><button class=glass-button>Ultra Minimal</button><button class=glass-button>Floating Bar</button><button class=glass-button>Spotify-like</button></div></div><div style=margin-bottom:20px;><h4 style="margin:0 0 12px 0;color:#666;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Player Preview (Segment <!>/<!>)</h4></div><div style="padding:10px;background:rgba(0, 0, 0, 0.2);border:1px solid rgba(255, 255, 255, 0.05);border-radius:4px;"><p style=font-size:10px;color:#666;margin:0;line-height:1.4;>Test different audio player styles for the narration system. Each style has different visual approaches while maintaining the same core functionality.`),cp=O("<span class=debug-mobile-compact-fps> FPS"),hp=O('<div class="debug-mobile-compact glass-button"><div class=debug-mobile-compact-content><span class=debug-mobile-compact-icon><svg width=16 height=16 viewBox="0 0 20 20"fill=none><path d="M4 4v12M10 2v4M10 14v4M16 8v8M10 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16 5.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM10 14.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round></path></svg></span><span class=debug-mobile-compact-label>Debug'),up=O("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>Cache Version</span><span class=debug-stat-value>1.0.2</span></div><div class=debug-stat-row><span class=debug-stat-label>Status</span><span class=debug-stat-value style=color:#4CAF50>Active</span></div><div style=margin-top:20px;><button class=glass-button> Clear Cache & Reload</button><p style=margin-top:10px;font-size:11px;opacity:0.6;text-align:center;>Clears localStorage, sessionStorage and reloads the app"),dp=O('<div><div><div class=debug-mobile-sheet-handle><div class=debug-mobile-sheet-handle-bar></div></div><div class=debug-mobile-sheet-header><h3 class=debug-mobile-sheet-title><svg width=18 height=18 viewBox="0 0 20 20"fill=none><path d="M4 4v12M10 2v4M10 14v4M16 8v8M10 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16 5.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM10 14.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round></path></svg>Artwork Controls</h3></div><div class=debug-mobile-tabs></div><div class=debug-mobile-content>'),pp=O("<button><span class=debug-mobile-tab-icon></span><span class=debug-mobile-tab-label>"),fp=O("<span style=margin-left:8px;>Artwork Controls"),gp=O('<button title="Minimize panel"><svg viewBox="0 0 20 20"><rect x=11 y=15 width=14 height=2>'),mp=O(`<div><div class=debug-panel-header><h3 class=debug-panel-title style="margin:0;display:'flex';alignItems:'center';"><svg viewBox="0 0 20 20"fill=none><path d="M4 4v12M10 2v4M10 14v4M16 8v8M10 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16 5.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM10 14.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>`),yp=O("<div><div class=debug-section-header><div class=debug-section-title><span class=debug-section-icon></span><span></span></div><span class=debug-section-chevron></span></div><div class=debug-section-content><div class=debug-section-body>");function vp(s){const[t,e]=re(!0),[i,n]=re({artwork:!1,performance:!1,visual:!1,navigation:!1,overlay:!1,easing:!1,consciousness:!1,cache:!1,osrsAudio:!1,audioPlayerTest:!1}),[r,o]=re({x:null,y:null}),[a,l]=re(!1),[c,u]=re({x:0,y:0,elementX:0,elementY:0});re(0),window.animationSpeedMultiplier||(window.animationSpeedMultiplier=.8);const[d,p]=re(window.animationSpeedMultiplier),[m,y]=re(!1),[_,T]=re(0),[x,V]=re(!1),L=()=>{V(!0),setTimeout(()=>{y(!1),V(!1)},300)};let W,J=0,ee=0;const F=q=>{J=q.touches[0].clientY,ee=0},E=q=>{if(!m()||!W)return;const te=q.touches[0].clientY-J;te>0&&(ee=te,W.style.transform=`translateY(${te}px)`)},P=()=>{W&&(ee>100&&L(),W.style.transform="",ee=0)},M=[{id:"artwork",icon:"",title:"Active Element",content:()=>(()=>{var q=Ud(),ne=q.firstChild,te=ne.firstChild,$=te.nextSibling,H=ne.nextSibling,se=H.firstChild,ce=se.nextSibling,ue=H.nextSibling,Y=ue.firstChild,oe=Y.nextSibling;return Z($,()=>{var le;return((le=s.hoveredHotspot())==null?void 0:le.id)||"none"}),Z(ce,()=>{var le;return((le=s.selectedHotspot())==null?void 0:le.id)||"none"}),Z(oe,()=>{var le,_e;return((le=s.hoveredHotspot())==null?void 0:le.type)||((_e=s.selectedHotspot())==null?void 0:_e.type)||"none"}),q})()},{id:"performance",icon:"",title:"Performance",content:()=>(()=>{var q=Gd(),ne=q.firstChild,te=ne.firstChild,$=te.nextSibling,H=$.firstChild,se=H.firstChild,ce=se.nextSibling;ce.nextSibling;var ue=ne.nextSibling,Y=ue.firstChild,oe=Y.nextSibling,le=ue.nextSibling,_e=le.firstChild,ge=_e.nextSibling,Oe=ge.firstChild,qe=le.nextSibling,De=qe.firstChild,Te=De.nextSibling,Se=Te.firstChild,Ae=qe.nextSibling,pe=Ae.firstChild,be=pe.nextSibling,Xe=be.firstChild;return Z($,()=>{var g,S;return((S=(g=s.performanceMetrics)==null?void 0:g.currentFPS)==null?void 0:S.toFixed(0))||"60"},H),Z(H,()=>{var g;return((g=s.performanceMetrics)==null?void 0:g.averageFPS)||"60"},ce),Z(oe,()=>{var g;return((g=s.performanceMetrics)==null?void 0:g.performanceLevel)||"excellent"}),Z(ge,()=>{var g,S;return((S=(g=s.performanceMetrics)==null?void 0:g.memoryUsage)==null?void 0:S.toFixed(0))||"0"},Oe),Z(Te,()=>{var g;return((g=s.performanceMetrics)==null?void 0:g.frameTime)||"16.67"},Se),Z(be,()=>{var g;return((g=s.performanceMetrics)==null?void 0:g.zoomLevel)||"1.00"},Xe),Z(q,me(ke,{get when(){return s.safariHybridMetrics},get children(){return[jd(),(()=>{var g=Wd(),S=g.firstChild,N=S.nextSibling,X=N.firstChild;return Z(N,()=>{var B;return((B=s.safariHybridMetrics.renderTime)==null?void 0:B.toFixed(2))||"0.00"},X),Le(B=>(B=s.safariHybridMetrics.renderTime>16.67?"#FF9800":"#4CAF50")!=null?N.style.setProperty("color",B):N.style.removeProperty("color")),g})(),(()=>{var g=qd(),S=g.firstChild,N=S.nextSibling,X=N.firstChild;return Z(N,()=>s.safariHybridMetrics.visibleHotspots||"0",X),Z(N,()=>s.safariHybridMetrics.hotspotCount||"0",null),g})()]}}),null),Le(g=>{var ae,G,de,xe,we;var S=(((ae=s.performanceMetrics)==null?void 0:ae.currentFPS)||60)<55?"#FF9800":"#4CAF50",N={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"}[((G=s.performanceMetrics)==null?void 0:G.performanceLevel)||"excellent"],X=(((de=s.performanceMetrics)==null?void 0:de.memoryUsage)||0)>250?"#FF9800":"#4CAF50",B=parseFloat(((xe=s.performanceMetrics)==null?void 0:xe.frameTime)||16.67)>33?"#F44336":parseFloat(((we=s.performanceMetrics)==null?void 0:we.frameTime)||16.67)>20?"#FF9800":"#4CAF50";return S!==g.e&&((g.e=S)!=null?$.style.setProperty("color",S):$.style.removeProperty("color")),N!==g.t&&((g.t=N)!=null?oe.style.setProperty("color",N):oe.style.removeProperty("color")),X!==g.a&&((g.a=X)!=null?ge.style.setProperty("color",X):ge.style.removeProperty("color")),B!==g.o&&((g.o=B)!=null?Te.style.setProperty("color",B):Te.style.removeProperty("color")),g},{e:void 0,t:void 0,a:void 0,o:void 0}),q})()},{id:"visual",icon:"",title:"Viewer Preferences",content:()=>[(()=>{var q=Zd(),ne=q.firstChild,te=ne.firstChild,$=te.nextSibling,H=$.firstChild,se=ne.nextSibling;return Z($,()=>s.zoomSpeed().toFixed(1),H),se.$$input=ce=>s.setZoomSpeed(parseFloat(ce.target.value)),Le(()=>se.value=s.zoomSpeed()),q})(),(()=>{var q=Xd(),ne=q.firstChild,te=ne.nextSibling,$=te.firstChild,H=$.nextSibling,se=H.nextSibling,ce=te.nextSibling,ue=ce.firstChild,Y=ue.nextSibling,oe=Y.nextSibling;return $.$$click=()=>{console.log("Setting palette to tech"),s.setPalette("tech")},H.$$click=()=>{console.log("Setting palette to enchantedJournal"),s.setPalette("enchantedJournal")},se.$$click=()=>{console.log("Setting palette to moonlitManuscript"),s.setPalette("moonlitManuscript")},ue.$$click=()=>{console.log("Setting palette to pureWhiteHigh"),s.setPalette("pureWhiteHigh")},Y.$$click=()=>{console.log("Setting palette to pureWhiteBalanced"),s.setPalette("pureWhiteBalanced")},oe.$$click=()=>{console.log("Setting palette to blackOnBlack"),s.setPalette("blackOnBlack")},Le(le=>{var _e=`debug-toggle-option ${s.currentPalette()==="tech"?"active":""}`,ge=`debug-toggle-option ${s.currentPalette()==="enchantedJournal"?"active":""}`,Oe=`debug-toggle-option ${s.currentPalette()==="moonlitManuscript"?"active":""}`,qe=`debug-toggle-option ${s.currentPalette()==="pureWhiteHigh"?"active":""}`,De=`debug-toggle-option ${s.currentPalette()==="pureWhiteBalanced"?"active":""}`,Te=`debug-toggle-option ${s.currentPalette()==="blackOnBlack"?"active":""}`;return _e!==le.e&&it($,le.e=_e),ge!==le.t&&it(H,le.t=ge),Oe!==le.a&&it(se,le.a=Oe),qe!==le.o&&it(ue,le.o=qe),De!==le.i&&it(Y,le.i=De),Te!==le.n&&it(oe,le.n=Te),le},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),q})()]},...Ge()?[]:[{id:"easing",icon:"",title:"Hover Animation Speed",content:()=>(()=>{var q=Yd(),ne=q.firstChild,te=ne.nextSibling,$=te.firstChild,H=$.nextSibling,se=te.nextSibling,ce=se.firstChild;return H.$$input=ue=>{const Y=parseFloat(ue.target.value);window.animationSpeedMultiplier=Y,p(Y),console.log(`[Animation Speed] Set to ${Y}x (${Y<1?"faster":Y>1?"slower":"normal"})`)},Z(se,()=>`${d().toFixed(1)}x speed`,ce),Z(ce,(()=>{var ue=Dt(()=>d()<1);return()=>ue()?" (faster)":d()>1?" (slower)":" (normal)"})()),Le(()=>H.value=d()),q})()}],...Ge()?[{id:"revealType",icon:"",title:"Reveal Type",content:()=>(()=>{var q=Kd(),ne=q.firstChild,te=ne.nextSibling,$=te.firstChild,H=$.nextSibling,se=te.nextSibling;return $.$$click=()=>{var ce;return(ce=s.setRevealType)==null?void 0:ce.call(s,"focus")},H.$$click=()=>{var ce;return(ce=s.setRevealType)==null?void 0:ce.call(s,"ripple")},Z(se,(()=>{var ce=Dt(()=>{var ue;return((ue=s.revealType)==null?void 0:ue.call(s))==="focus"});return()=>{var ue;return ce()?"Reveals only the closest hotspot on tap":((ue=s.revealType)==null?void 0:ue.call(s))==="ripple"?"Experimental: Ripple effect reveals neighboring zones in expanding wave":"Reveals only the closest hotspot on tap"}})()),Le(ce=>{var oe,le;var ue=`debug-toggle-option ${((oe=s.revealType)==null?void 0:oe.call(s))==="focus"||!s.revealType?"active":""}`,Y=`debug-toggle-option ${((le=s.revealType)==null?void 0:le.call(s))==="ripple"?"active":""}`;return ue!==ce.e&&it($,ce.e=ue),Y!==ce.t&&it(H,ce.t=Y),ce},{e:void 0,t:void 0}),q})()}]:[],{id:"consciousness",icon:"",title:"Journey Mode (Test)",content:()=>{var ne;const q=((ne=s.consciousnessMetrics)==null?void 0:ne.call(s))||{};return[(()=>{var te=ll(),$=te.firstChild,H=$.firstChild,se=H.nextSibling,ce=$.nextSibling,ue=ce.firstChild,Y=ue.nextSibling,oe=ce.nextSibling,le=oe.firstChild,_e=le.nextSibling;return Z(se,()=>q.targetFPS||"60"),Z(Y,()=>{var ge;return((ge=q.effects)==null?void 0:ge.join(", "))||"none"}),Z(_e,()=>q.gpu||"unknown"),te})(),(()=>{var te=cl(),$=te.firstChild;return $.$$click=()=>{var ce,ue;console.log(" Testing consciousness zoom...");const H=window.nativeHotspotRenderer;if(!H){console.error(" NativeHotspotRenderer not found");return}const se=((ce=H.spatialIndex)==null?void 0:ce.getAllHotspots())||[];if(console.log(` Found ${se.length} hotspots`),se.length>0){const Y=se[Math.floor(Math.random()*se.length)];console.log(" Selected hotspot:",Y.id);const oe=Do(Y,window.viewer,Ge());oe?(console.log(" Bounds:",oe),(ue=window.cinematicZoomManager)==null||ue.performAdaptiveZoom(oe,{type:"consciousness"})):console.error(" Could not calculate bounds for hotspot")}else console.warn(" No hotspots found")},te})()]}},{id:"cache",icon:"",title:"Cache Management",content:()=>[(()=>{var q=Qd(),ne=q.firstChild,te=ne.nextSibling,$=te.firstChild,H=$.nextSibling,se=te.nextSibling,ce=se.firstChild,ue=ce.nextSibling;return H.style.setProperty("color","#4CAF50"),Z(ue,()=>{let Y=0;for(let oe in localStorage)localStorage.hasOwnProperty(oe)&&(Y+=localStorage[oe].length+oe.length);return(Y/1024).toFixed(1)+" KB"}),q})(),(()=>{var q=Jd(),ne=q.firstChild;return ne.$$click=()=>{confirm("Clear all cached data and reload? This will fix any stuck animations or broken state.")&&ro.forceReset()},ne.style.setProperty("width","100%"),ne.style.setProperty("background","rgba(255, 87, 34, 0.08)"),ne.style.setProperty("border","1px solid rgba(255, 87, 34, 0.2)"),ne.style.setProperty("color","#FF5722"),q})()]},{id:"minimalistAudio",icon:"",title:"Sound Test",content:()=>{const[q,ne]=re(null),[te,$]=re("inkDiffusion"),[H,se]=re("absorbedImpact"),[ce,ue]=re(!1),Y=async()=>{if(window.minimalistAudioEngine)ne(window.minimalistAudioEngine),window.minimalistAudioEngine.isUnlocked||await window.minimalistAudioEngine.init(),ue(!0),$(window.minimalistAudioEngine.currentReveal),se(window.minimalistAudioEngine.currentActivate),console.log("[Minimalist Audio] Using global engine");else if(!q()){const _e=(await Br(async()=>{const{default:Oe}=await import("./MinimalistAudioEngine-DgOAyMp5.js");return{default:Oe}},__vite__mapDeps([0,1]))).default,ge=new _e;await ge.init(),ne(ge),window.minimalistAudioEngine=ge,ue(!0),console.log("[Minimalist Audio] Created new engine")}},oe=_e=>{if(q())switch(_e){case"sandShift":q().playSandShift();break;case"sandCrystal":q().playSandCrystal();break;case"sandWhisper":q().playSandWhisper();break;case"sandTrickle":q().playSandTrickle();break;case"sandMagic":q().playSandMagic();break;default:q().playReveal();break}},le=_e=>{q()&&(se(_e),q().setActivateSound(_e),q().playActivate())};return(()=>{var _e=np();return Z(_e,me(ke,{get when(){return!ce()},get children(){var ge=$d();return ge.$$click=Y,ge.style.setProperty("width","100%"),ge.style.setProperty("padding","12px"),ge.style.setProperty("background","rgba(76, 175, 80, 0.1)"),ge.style.setProperty("border","1px solid rgba(76, 175, 80, 0.3)"),ge.style.setProperty("color","#4CAF50"),ge.style.setProperty("marginBottom","16px"),ge}}),null),Z(_e,me(ke,{get when(){return ce()},get children(){return[(()=>{var ge=ep(),Oe=ge.firstChild,qe=Oe.nextSibling,De=qe.firstChild,Te=De.nextSibling,Se=Te.nextSibling,Ae=Se.nextSibling,pe=Ae.nextSibling,be=pe.nextSibling;return De.$$click=()=>oe("sandShift"),De.style.setProperty("padding","12px 8px"),De.style.setProperty("fontSize","11px"),De.style.setProperty("background","rgba(255, 255, 255, 0.02)"),De.style.setProperty("border","1px solid rgba(255, 255, 255, 0.08)"),De.style.setProperty("color","#999"),Te.$$click=()=>oe("sandCrystal"),Te.style.setProperty("padding","12px 8px"),Te.style.setProperty("fontSize","11px"),Te.style.setProperty("background","rgba(255, 255, 255, 0.02)"),Te.style.setProperty("border","1px solid rgba(255, 255, 255, 0.08)"),Te.style.setProperty("color","#999"),Se.$$click=()=>oe("sandWhisper"),Se.style.setProperty("padding","12px 8px"),Se.style.setProperty("fontSize","11px"),Se.style.setProperty("background","rgba(255, 255, 255, 0.02)"),Se.style.setProperty("border","1px solid rgba(255, 255, 255, 0.08)"),Se.style.setProperty("color","#999"),Ae.$$click=()=>oe("sandTrickle"),Ae.style.setProperty("padding","12px 8px"),Ae.style.setProperty("fontSize","11px"),Ae.style.setProperty("background","rgba(255, 255, 255, 0.02)"),Ae.style.setProperty("border","1px solid rgba(255, 255, 255, 0.08)"),Ae.style.setProperty("color","#999"),pe.$$click=()=>oe("sandMagic"),pe.style.setProperty("padding","12px 8px"),pe.style.setProperty("fontSize","11px"),pe.style.setProperty("background","rgba(255, 255, 255, 0.02)"),pe.style.setProperty("border","1px solid rgba(255, 255, 255, 0.08)"),pe.style.setProperty("color","#999"),be.$$click=()=>oe("random"),be.style.setProperty("padding","12px 8px"),be.style.setProperty("fontSize","11px"),be.style.setProperty("background","rgba(139, 69, 19, 0.1)"),be.style.setProperty("border","1px solid rgba(139, 69, 19, 0.3)"),be.style.setProperty("color","#8B4513"),be.style.setProperty("gridColumn","span 2"),ge})(),(()=>{var ge=tp(),Oe=ge.firstChild,qe=Oe.nextSibling,De=qe.firstChild,Te=De.nextSibling,Se=Te.nextSibling,Ae=Se.nextSibling;return De.$$click=()=>le("absorbedImpact"),De.style.setProperty("padding","12px 8px"),De.style.setProperty("fontSize","11px"),Te.$$click=()=>le("paperWave"),Te.style.setProperty("padding","12px 8px"),Te.style.setProperty("fontSize","11px"),Se.$$click=()=>le("inkSaturation"),Se.style.setProperty("padding","12px 8px"),Se.style.setProperty("fontSize","11px"),Ae.$$click=()=>le("surfaceEcho"),Ae.style.setProperty("padding","12px 8px"),Ae.style.setProperty("fontSize","11px"),Le(pe=>{var be=`glass-button ${H()==="absorbedImpact"?"active":""}`,Xe=H()==="absorbedImpact"?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.02)",g=H()==="absorbedImpact"?"1px solid rgba(255, 255, 255, 0.2)":"1px solid rgba(255, 255, 255, 0.08)",S=H()==="absorbedImpact"?"#fff":"#999",N=`glass-button ${H()==="paperWave"?"active":""}`,X=H()==="paperWave"?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.02)",B=H()==="paperWave"?"1px solid rgba(255, 255, 255, 0.2)":"1px solid rgba(255, 255, 255, 0.08)",ae=H()==="paperWave"?"#fff":"#999",G=`glass-button ${H()==="inkSaturation"?"active":""}`,de=H()==="inkSaturation"?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.02)",xe=H()==="inkSaturation"?"1px solid rgba(255, 255, 255, 0.2)":"1px solid rgba(255, 255, 255, 0.08)",we=H()==="inkSaturation"?"#fff":"#999",fe=`glass-button ${H()==="surfaceEcho"?"active":""}`,Ne=H()==="surfaceEcho"?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.02)",b=H()==="surfaceEcho"?"1px solid rgba(255, 255, 255, 0.2)":"1px solid rgba(255, 255, 255, 0.08)",w=H()==="surfaceEcho"?"#fff":"#999";return be!==pe.e&&it(De,pe.e=be),Xe!==pe.t&&((pe.t=Xe)!=null?De.style.setProperty("background",Xe):De.style.removeProperty("background")),g!==pe.a&&((pe.a=g)!=null?De.style.setProperty("border",g):De.style.removeProperty("border")),S!==pe.o&&((pe.o=S)!=null?De.style.setProperty("color",S):De.style.removeProperty("color")),N!==pe.i&&it(Te,pe.i=N),X!==pe.n&&((pe.n=X)!=null?Te.style.setProperty("background",X):Te.style.removeProperty("background")),B!==pe.s&&((pe.s=B)!=null?Te.style.setProperty("border",B):Te.style.removeProperty("border")),ae!==pe.h&&((pe.h=ae)!=null?Te.style.setProperty("color",ae):Te.style.removeProperty("color")),G!==pe.r&&it(Se,pe.r=G),de!==pe.d&&((pe.d=de)!=null?Se.style.setProperty("background",de):Se.style.removeProperty("background")),xe!==pe.l&&((pe.l=xe)!=null?Se.style.setProperty("border",xe):Se.style.removeProperty("border")),we!==pe.u&&((pe.u=we)!=null?Se.style.setProperty("color",we):Se.style.removeProperty("color")),fe!==pe.c&&it(Ae,pe.c=fe),Ne!==pe.w&&((pe.w=Ne)!=null?Ae.style.setProperty("background",Ne):Ae.style.removeProperty("background")),b!==pe.m&&((pe.m=b)!=null?Ae.style.setProperty("border",b):Ae.style.removeProperty("border")),w!==pe.f&&((pe.f=w)!=null?Ae.style.setProperty("color",w):Ae.style.removeProperty("color")),pe},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0}),ge})(),(()=>{var ge=ip(),Oe=ge.firstChild,qe=Oe.firstChild,De=qe.nextSibling,Te=De.nextSibling,Se=Te.nextSibling;return Se.nextSibling,Z(Oe,te,Te),Z(Oe,H,null),ge})()]}}),null),_e})()}},{id:"audioPlayerTest",icon:"",title:"Audio Player Styles",content:()=>{const[q,ne]=re("deji"),[te,$]=re(!1),[H,se]=re(1),[ce]=re(5),ue=ge=>{console.log(`[Audio Player Test] Activating ${ge} style`),window.setGlobalAudioPlayerStyle&&window.setGlobalAudioPlayerStyle(ge),Ge()&&s.closeDebugPanel?s.closeDebugPanel():Ge()&&L(),Ge()||e(!0)},Y=()=>{$(!te()),console.log("[Audio Player Test] Play/Pause toggled:",te())},oe=()=>{H()>1&&(se(H()-1),console.log("[Audio Player Test] Previous segment:",H()))},le=()=>{H()<ce()&&(se(H()+1),console.log("[Audio Player Test] Next segment:",H()))},_e=ge=>{console.log(`[Audio Player Test] Skip ${ge} seconds`)};return(()=>{var ge=lp(),Oe=ge.firstChild,qe=Oe.firstChild,De=qe.nextSibling,Te=De.firstChild,Se=Te.nextSibling,Ae=Se.nextSibling,pe=Ae.nextSibling,be=Oe.nextSibling,Xe=be.firstChild,g=Xe.firstChild,S=g.nextSibling,N=S.nextSibling,X=N.nextSibling;return X.nextSibling,Te.$$click=()=>{ne("deji"),ue("deji")},Te.style.setProperty("padding","10px"),Se.$$click=()=>{ne("minimal"),ue("minimal")},Se.style.setProperty("padding","10px"),Ae.$$click=()=>{ne("floating"),ue("floating")},Ae.style.setProperty("padding","10px"),pe.$$click=()=>{ne("spotify"),ue("spotify")},pe.style.setProperty("padding","10px"),Z(Xe,H,S),Z(Xe,ce,X),Z(be,me(ke,{get when(){return q()==="deji"},get children(){var B=rp(),ae=B.firstChild,G=ae.nextSibling,de=G.nextSibling,xe=de.nextSibling,we=xe.nextSibling;return B.style.setProperty("background","rgba(0, 0, 0, 0.95)"),B.style.setProperty("border","1px solid rgba(255, 255, 255, 0.1)"),B.style.setProperty("borderRadius","4px"),B.style.setProperty("padding","12px"),B.style.setProperty("display","flex"),B.style.setProperty("alignItems","center"),B.style.setProperty("justifyContent","space-between"),B.style.setProperty("gap","8px"),B.style.setProperty("minHeight","56px"),ae.$$click=oe,G.$$click=()=>_e(-15),de.$$click=Y,Z(de,()=>te()?"":""),xe.$$click=()=>_e(15),we.$$click=le,B}}),null),Z(be,me(ke,{get when(){return q()==="minimal"},get children(){var B=sp(),ae=B.firstChild,G=ae.nextSibling,de=G.nextSibling,xe=de.nextSibling,we=xe.nextSibling;return B.style.setProperty("display","flex"),B.style.setProperty("alignItems","center"),B.style.setProperty("justifyContent","center"),B.style.setProperty("gap","20px"),B.style.setProperty("padding","20px"),B.style.setProperty("background","transparent"),ae.$$click=oe,G.$$click=()=>_e(-15),de.$$click=Y,Z(de,()=>te()?"":""),xe.$$click=()=>_e(15),we.$$click=le,B}}),null),Z(be,me(ke,{get when(){return q()==="floating"},get children(){var B=op(),ae=B.firstChild,G=ae.firstChild,de=G.nextSibling,xe=de.nextSibling,we=xe.nextSibling,fe=we.nextSibling;return B.style.setProperty("position","relative"),B.style.setProperty("height","80px"),B.style.setProperty("display","flex"),B.style.setProperty("alignItems","flex-end"),ae.style.setProperty("background","rgba(0, 0, 0, 0.8)"),ae.style.setProperty("backdropFilter","blur(10px)"),ae.style.setProperty("borderRadius","24px"),ae.style.setProperty("padding","8px 16px"),ae.style.setProperty("display","flex"),ae.style.setProperty("alignItems","center"),ae.style.setProperty("gap","12px"),ae.style.setProperty("boxShadow","0 4px 12px rgba(0,0,0,0.3)"),G.$$click=oe,de.$$click=()=>_e(-15),xe.$$click=Y,Z(xe,()=>te()?"":""),we.$$click=()=>_e(15),fe.$$click=le,B}}),null),Z(be,me(ke,{get when(){return q()==="spotify"},get children(){var B=ap(),ae=B.firstChild,G=ae.firstChild,de=G.nextSibling,xe=de.nextSibling,we=xe.nextSibling,fe=we.nextSibling;return B.style.setProperty("background","linear-gradient(to bottom, rgba(40,40,40,0.95), rgba(18,18,18,0.95))"),B.style.setProperty("borderRadius","8px"),B.style.setProperty("padding","16px"),B.style.setProperty("boxShadow","0 8px 24px rgba(0,0,0,0.4)"),G.$$click=oe,de.$$click=()=>_e(-15),xe.$$click=Y,Z(xe,()=>te()?"":""),we.$$click=()=>_e(15),fe.$$click=le,B}}),null),Le(B=>{var ae=q()==="deji"?"rgba(0, 0, 0, 0.3)":"rgba(0, 0, 0, 0.1)",G=q()==="deji"?"1px solid rgba(255, 255, 255, 0.3)":"1px solid rgba(255, 255, 255, 0.1)",de=q()==="deji"?"#fff":"#999",xe=q()==="minimal"?"rgba(0, 0, 0, 0.3)":"rgba(0, 0, 0, 0.1)",we=q()==="minimal"?"1px solid rgba(255, 255, 255, 0.3)":"1px solid rgba(255, 255, 255, 0.1)",fe=q()==="minimal"?"#fff":"#999",Ne=q()==="floating"?"rgba(0, 0, 0, 0.3)":"rgba(0, 0, 0, 0.1)",b=q()==="floating"?"1px solid rgba(255, 255, 255, 0.3)":"1px solid rgba(255, 255, 255, 0.1)",w=q()==="floating"?"#fff":"#999",C=q()==="spotify"?"rgba(0, 0, 0, 0.3)":"rgba(0, 0, 0, 0.1)",A=q()==="spotify"?"1px solid rgba(255, 255, 255, 0.3)":"1px solid rgba(255, 255, 255, 0.1)",U=q()==="spotify"?"#fff":"#999";return ae!==B.e&&((B.e=ae)!=null?Te.style.setProperty("background",ae):Te.style.removeProperty("background")),G!==B.t&&((B.t=G)!=null?Te.style.setProperty("border",G):Te.style.removeProperty("border")),de!==B.a&&((B.a=de)!=null?Te.style.setProperty("color",de):Te.style.removeProperty("color")),xe!==B.o&&((B.o=xe)!=null?Se.style.setProperty("background",xe):Se.style.removeProperty("background")),we!==B.i&&((B.i=we)!=null?Se.style.setProperty("border",we):Se.style.removeProperty("border")),fe!==B.n&&((B.n=fe)!=null?Se.style.setProperty("color",fe):Se.style.removeProperty("color")),Ne!==B.s&&((B.s=Ne)!=null?Ae.style.setProperty("background",Ne):Ae.style.removeProperty("background")),b!==B.h&&((B.h=b)!=null?Ae.style.setProperty("border",b):Ae.style.removeProperty("border")),w!==B.r&&((B.r=w)!=null?Ae.style.setProperty("color",w):Ae.style.removeProperty("color")),C!==B.d&&((B.d=C)!=null?pe.style.setProperty("background",C):pe.style.removeProperty("background")),A!==B.l&&((B.l=A)!=null?pe.style.setProperty("border",A):pe.style.removeProperty("border")),U!==B.u&&((B.u=U)!=null?pe.style.setProperty("color",U):pe.style.removeProperty("color")),B},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0}),ge})()}}];if(Ge()){const q=[{id:"reveal",label:"Reveal",icon:""},{id:"consciousness",label:"Journey (test)",icon:""},{id:"cache",label:"Cache",icon:""},{id:"minimalistAudio",label:"Sound",icon:""},{id:"audioPlayerTest",label:"Player",icon:""}];return[(()=>{var ne=hp(),te=ne.firstChild,$=te.firstChild;return $.nextSibling,ne.$$click=H=>{no(H,H.currentTarget),y(!0)},ne.style.setProperty("position","fixed"),ne.style.setProperty("bottom","20px"),ne.style.setProperty("left","20px"),ne.style.setProperty("transform","none"),ne.style.setProperty("zIndex","1000"),Z(te,me(ke,{get when(){var H;return(H=s.performanceMetrics)==null?void 0:H.currentFPS},get children(){var H=cp(),se=H.firstChild;return Z(H,()=>{var ce,ue;return(ue=(ce=s.performanceMetrics)==null?void 0:ce.currentFPS)==null?void 0:ue.toFixed(0)},se),Le(ce=>{var ue;return(ce=(((ue=s.performanceMetrics)==null?void 0:ue.currentFPS)||60)<45?"#FF9800":"#4CAF50")!=null?H.style.setProperty("color",ce):H.style.removeProperty("color")}),H}}),null),Le(H=>(H=m()?"none":"flex")!=null?ne.style.setProperty("display",H):ne.style.removeProperty("display")),ne})(),me(ke,{get when(){return m()},get children(){var ne=dp(),te=ne.firstChild,$=te.firstChild,H=$.nextSibling,se=H.firstChild,ce=H.nextSibling,ue=ce.nextSibling;ne.$$click=oe=>{oe.target===oe.currentTarget&&L()},te.$$pointerdown=oe=>oe.stopPropagation(),te.$$click=oe=>oe.stopPropagation(),te.$$touchend=P,te.$$touchmove=E,te.$$touchstart=F;var Y=W;return typeof Y=="function"?Lc(Y,te):W=te,te.style.setProperty("position","fixed"),te.style.setProperty("bottom","0"),te.style.setProperty("left","50%"),te.style.setProperty("transform","translateX(-50%)"),te.style.setProperty("transition","transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"),te.style.setProperty("willChange","transform"),te.style.setProperty("width","90%"),te.style.setProperty("maxWidth","500px"),te.style.setProperty("minHeight","60vh"),te.style.setProperty("maxHeight","85vh"),te.style.setProperty("display","flex"),te.style.setProperty("flexDirection","column"),$.style.setProperty("padding","8px"),H.style.setProperty("padding","12px 20px"),se.style.setProperty("fontSize","14px"),se.style.setProperty("margin","0"),se.style.setProperty("display","flex"),se.style.setProperty("alignItems","center"),se.style.setProperty("gap","8px"),Z(ce,me(to,{each:q,children:(oe,le)=>(()=>{var _e=pp(),ge=_e.firstChild,Oe=ge.nextSibling;return _e.$$click=()=>T(le()),Z(ge,()=>oe.icon),Z(Oe,()=>oe.label),Le(()=>it(_e,`debug-mobile-tab ${_()===le()?"active":""}`)),_e})()})),ue.style.setProperty("flex","1"),ue.style.setProperty("overflowY","auto"),ue.style.setProperty("WebkitOverflowScrolling","touch"),ue.style.setProperty("padding","32px 24px 40px"),ue.style.setProperty("minHeight","300px"),Z(ue,me(id,{get children(){return[me(Fn,{get when(){return _()===0},get children(){var oe;return(oe=M.find(le=>le.id==="revealType"))==null?void 0:oe.content()}}),me(Fn,{get when(){return _()===1},get children(){return(()=>{var le;const oe=((le=s.consciousnessMetrics)==null?void 0:le.call(s))||{};return[(()=>{var _e=ll(),ge=_e.firstChild,Oe=ge.firstChild,qe=Oe.nextSibling,De=ge.nextSibling,Te=De.firstChild,Se=Te.nextSibling,Ae=De.nextSibling,pe=Ae.firstChild,be=pe.nextSibling;return Z(qe,()=>oe.targetFPS||"60"),Z(Se,()=>{var Xe;return((Xe=oe.effects)==null?void 0:Xe.join(", "))||"none"}),Z(be,()=>oe.gpu||"unknown"),_e})(),(()=>{var _e=cl(),ge=_e.firstChild;return ge.$$click=()=>{var De;console.log(" Testing consciousness zoom...");const Oe=window.nativeHotspotRenderer;if(!Oe){console.error(" NativeHotspotRenderer not found");return}const qe=((De=Oe.spatialIndex)==null?void 0:De.getAllHotspots())||[];if(console.log(` Found ${qe.length} hotspots`),qe.length>0){const Te=qe[Math.floor(Math.random()*qe.length)];console.log(" Selected hotspot:",Te.id),Br(async()=>{const{calculateHotspotBounds:Se}=await Promise.resolve().then(()=>wd);return{calculateHotspotBounds:Se}},void 0).then(({calculateHotspotBounds:Se})=>{Br(async()=>{const{isMobile:Ae}=await Promise.resolve().then(()=>hd);return{isMobile:Ae}},void 0).then(({isMobile:Ae})=>{var be;const pe=Se(Te,window.viewer,Ae());pe?(console.log(" Bounds:",pe),(be=window.cinematicZoomManager)==null||be.performAdaptiveZoom(pe,{type:"consciousness"})):console.error(" Could not calculate bounds for hotspot")})})}else console.warn(" No hotspots found")},_e})()]})()}}),me(Fn,{get when(){return _()===2},get children(){var oe=up(),le=oe.firstChild,_e=le.nextSibling,ge=_e.nextSibling,Oe=ge.firstChild;return Oe.$$click=()=>{confirm("Clear all cached data and reload?")&&ro.forceReset()},Oe.style.setProperty("width","100%"),Oe.style.setProperty("padding","12px"),Oe.style.setProperty("background","rgba(255, 87, 34, 0.1)"),Oe.style.setProperty("border","1px solid rgba(255, 87, 34, 0.3)"),Oe.style.setProperty("color","#FF5722"),oe}}),me(Fn,{get when(){return _()===3},get children(){var oe;return(oe=M.find(le=>le.id==="minimalistAudio"))==null?void 0:oe.content()}}),me(Fn,{get when(){return _()===4},get children(){var oe;return(oe=M.find(le=>le.id==="audioPlayerTest"))==null?void 0:oe.content()}})]}})),Le(oe=>{var le=`debug-mobile-backdrop ${x()?"closing":""}`,_e=`debug-mobile-sheet ${x()?"closing":"expanded"}`;return le!==oe.e&&it(ne,oe.e=le),_e!==oe.t&&it(te,oe.t=_e),oe},{e:void 0,t:void 0}),ne}})]}const k=q=>{if(!q.target.closest(".debug-panel-header")||t())return;q.preventDefault(),l(!0);const te=q.currentTarget.getBoundingClientRect();let $=te.left;r().x===null&&!t()?$=te.left:r().x!==null&&($=r().x),u({x:q.clientX,y:q.clientY,elementX:$,elementY:r().y!==null?r().y:te.top})},D=q=>{if(!a())return;const ne=q.clientX-c().x,te=q.clientY-c().y;o({x:c().elementX+ne,y:c().elementY+te})},I=()=>{l(!1)};Yr(()=>{document.addEventListener("mousemove",D),document.addEventListener("mouseup",I)}),Zn(()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",I)}),Yr(()=>{if(document.addEventListener("mousemove",D),document.addEventListener("mouseup",I),t()){const q=document.querySelector(".debug-panel.glass-button");q&&no(q)}});const Ce=q=>{n(ne=>({...ne,[q]:!ne[q]}))};return(()=>{var q=mp(),ne=q.firstChild,te=ne.firstChild,$=te.firstChild;return q.$$mousedown=k,ne.$$click=()=>{t()&&e(!1)},$.style.setProperty("transition","all 0.3s"),$.style.setProperty("color","rgba(255, 255, 255, 0.9)"),Z(te,me(ke,{get when(){return!t()},get children(){return fp()}}),null),Z(ne,me(ke,{get when(){return!t()},get children(){var H=gp(),se=H.firstChild;return H.addEventListener("mouseleave",ce=>{ce.currentTarget.style.background="rgba(255,255,255,0.08)",ce.currentTarget.style.borderColor="rgba(255,255,255,0.12)",ce.currentTarget.style.color="rgba(255,255,255,0.5)"}),H.addEventListener("mouseenter",ce=>{ce.currentTarget.style.background="rgba(255,255,255,0.12)",ce.currentTarget.style.borderColor="rgba(255,255,255,0.2)",ce.currentTarget.style.color="rgba(255,255,255,0.8)"}),H.$$click=ce=>{ce.stopPropagation(),e(!t())},H.style.setProperty("position","absolute"),H.style.setProperty("top","12px"),H.style.setProperty("right","12px"),H.style.setProperty("background","rgba(255,255,255,0.08)"),H.style.setProperty("border","1px solid rgba(255,255,255,0.12)"),H.style.setProperty("color","rgba(255,255,255,0.5)"),H.style.setProperty("fontSize","14px"),H.style.setProperty("lineHeight","1"),H.style.setProperty("cursor","pointer"),H.style.setProperty("padding","0"),H.style.setProperty("width","28px"),H.style.setProperty("height","28px"),H.style.setProperty("display","flex"),H.style.setProperty("alignItems","center"),H.style.setProperty("justifyContent","center"),H.style.setProperty("borderRadius","8px"),H.style.setProperty("transition","all 0.2s"),se.style.setProperty("width","16px"),se.style.setProperty("height","16px"),se.style.setProperty("fill","currentColor"),H}}),null),Z(q,me(ke,{get when(){return!t()},get children(){return me(to,{each:M,children:H=>(()=>{var se=yp(),ce=se.firstChild,ue=ce.firstChild,Y=ue.firstChild,oe=Y.nextSibling,le=ce.nextSibling,_e=le.firstChild;return ce.$$click=()=>Ce(H.id),Z(Y,()=>H.icon),Z(oe,()=>H.title),Z(_e,()=>H.content()),Le(()=>it(se,`debug-section ${i()[H.id]?"expanded":""}`)),se})()})}}),null),Le(H=>{var le,_e,ge;var se=`debug-panel ${t()?"glass-button":""}`,ce={...r().x!==null&&!t()?{position:"fixed",left:`${r().x}px`,top:`${r().y}px`,transform:"none",width:((le=s.style)==null?void 0:le.width)||"320px",maxWidth:((_e=s.style)==null?void 0:_e.maxWidth)||"320px",zIndex:((ge=s.style)==null?void 0:ge.zIndex)||1e3}:t()?{position:"fixed",bottom:"20px",left:"20px",zIndex:1e3,width:"44px",minWidth:"44px",height:"44px",borderRadius:"50%"}:{position:"fixed",top:"20px",left:"20px",transform:"none",width:"320px",maxWidth:"320px",maxHeight:"calc(100vh - 100px)",zIndex:1e3,...s.style||{}},cursor:a()?"grabbing":"default",transition:a()?"none":"all 0.2s"},ue={cursor:t()?"pointer":"grab",...t()?{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:0}:{}},Y=t()?"20":"18",oe=t()?"20":"18";return se!==H.e&&it(q,H.e=se),H.t=zn(q,ce,H.t),H.a=zn(ne,ue,H.a),Y!==H.o&&Bt($,"width",H.o=Y),oe!==H.i&&Bt($,"height",H.i=oe),H},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),q})()}ii(["input","click","touchstart","touchmove","touchend","pointerdown","mousedown"]);var wp=O("<span class=thermal-icon>"),_p=O("<div class=performance-indicator><span class=fps-value> FPS</span><span class=quality-icon>");function Tp(s){const t=()=>{if(!s.status)return"#666";const n=s.status.fps;return n>=30?"#4CAF50":n>=25?"#FFC107":n>=20?"#FF9800":"#F44336"},e=n=>{switch(n){case"high":return"";case"medium":return"";case"low":return"";case"ultra-low":return"";default:return""}},i=n=>{switch(n){case"normal":return"";case"warm":return"";case"hot":return"";case"critical":return"";default:return""}};return me(ke,{get when(){return s.visible&&s.status},get children(){var n=_p(),r=n.firstChild,o=r.firstChild,a=r.nextSibling;return Z(r,()=>s.status.fps,o),Z(a,()=>e(s.status.quality)),Z(n,me(ke,{get when(){return s.status.thermal!=="normal"},get children(){var l=wp();return Z(l,()=>i(s.status.thermal)),l}}),null),Le(l=>(l=t())!=null?n.style.setProperty("color",l):n.style.removeProperty("color")),n}})}let pt={blendTime:{value:0,min:0,max:.5,step:.01,description:"Tile blending duration - 0 eliminates transparency artifacts"},maxTilesPerFrame:{value:1,min:1,max:6,step:1,description:"Max concurrent tiles - lower prevents cascade artifacts"},animationTime:{value:1.2,min:.1,max:3,step:.1,description:"Zoom animation duration - affects smoothness"},springStiffness:{value:6.5,min:1,max:20,step:.5,description:"Animation responsiveness - affects zoom feel"},immediateRender:{value:!1,description:"Force immediate tile rendering"},imageLoaderLimit:{value:2,min:1,max:8,step:1,description:"Concurrent image loading limit"},enableProgressiveQuality:{value:!0,description:"Reduce quality during zoom for smoother animation"},qualityReductionThreshold:{value:2,min:.5,max:5,step:.1,description:"Zoom level to start quality reduction"},minQualityLevel:{value:.6,min:.1,max:1,step:.05,description:"Lowest quality during animation (0.1-1.0)"},enableMouseWheelSmoothing:{value:!0,description:"Smooth discrete mouse wheel events"},wheelEventThrottleMs:{value:16,min:8,max:100,step:4,description:"Mouse wheel event throttling (ms)"},wheelZoomStep:{value:.02,min:.01,max:.2,step:.01,description:"Zoom increment per wheel tick"},enableTileCascadePrevention:{value:!0,description:"Prevent multiple pyramid levels simultaneously"},maxTileLevels:{value:3,min:1,max:5,step:1,description:"Maximum tile pyramid levels at low zoom"},cascadePreventionZoom:{value:3,min:1,max:10,step:.5,description:"Zoom threshold for cascade prevention"},forceSafariCanvas:{value:!0,description:"Force Canvas renderer on Safari (40-50% performance boost)"},disableWebGLOnMobile:{value:!0,description:"Disable WebGL on mobile devices (research shows 15 FPS improvement)"},tileOverlap:{value:1,min:0,max:4,step:1,description:"Tile overlap in pixels (prevents seams)"},wheelEventThrottleMs:{value:16,min:8,max:100,step:4,description:"Mouse wheel event throttling (ms)"},wheelZoomStep:{value:.02,min:.01,max:.2,step:.01,description:"Zoom increment per wheel tick"}};function Mo(s,t){if(!s||!t)return;const e=pt;s.blendTime=e.blendTime.value,s.animationTime=e.animationTime.value,s.springStiffness=e.springStiffness.value,t.viewer.blendTime=e.blendTime.value,t.viewer.maxTilesPerFrame=e.maxTilesPerFrame.value,t.viewer.animationTime=e.animationTime.value,t.viewer.springStiffness=e.springStiffness.value,t.viewer.immediateRender=e.immediateRender.value,t.viewer.imageLoaderLimit=e.imageLoaderLimit.value,t.viewer.artifactElimination&&(t.viewer.artifactElimination.enableTileCascadePrevention=e.enableTileCascadePrevention.value,t.viewer.artifactElimination.enableBlendingOptimization=e.blendTime.value===0,t.viewer.artifactElimination.enableMouseWheelSmoothing=e.enableMouseWheelSmoothing.value,t.viewer.artifactElimination.enableProgressiveQuality=e.enableProgressiveQuality.value),s.forceRedraw&&s.forceRedraw(),console.log("Applied debug tuning values:",{blendTime:e.blendTime.value,maxTilesPerFrame:e.maxTilesPerFrame.value,animationTime:e.animationTime.value,springStiffness:e.springStiffness.value})}function bp(s,t){pt[s]&&(typeof pt[s].value=="boolean"?pt[s].value=!!t:pt[s].value=Number(t),localStorage.setItem(`debugTuning_${s}`,String(pt[s].value)),window.viewer&&Mo(window.viewer,window.performanceConfig),console.log(`Updated tuning parameter ${s}:`,pt[s].value))}function xp(){Object.keys(pt).forEach(s=>{const t=localStorage.getItem(`debugTuning_${s}`);t!==null&&(typeof pt[s].value=="boolean"?pt[s].value=t==="true":pt[s].value=Number(t))}),console.log("Loaded saved tuning values:",pt)}function Ep(){const s={blendTime:0,maxTilesPerFrame:1,animationTime:1.2,springStiffness:6.5,immediateRender:!1,imageLoaderLimit:2,enableProgressiveQuality:!0,qualityReductionThreshold:2,minQualityLevel:.6,enableMouseWheelSmoothing:!0,wheelEventThrottleMs:16,wheelZoomStep:.02,enableTileCascadePrevention:!0,maxTileLevels:3,cascadePreventionZoom:3,forceSafariCanvas:!0,disableWebGLOnMobile:!0,tileOverlap:1,wheelEventThrottleMs:16,wheelZoomStep:.02};Object.keys(s).forEach(t=>{pt[t]&&(pt[t].value=s[t],localStorage.setItem(`debugTuning_${t}`,String(s[t])))}),window.viewer&&Mo(window.viewer,window.performanceConfig),console.log("Reset tuning to research-based defaults")}function Sp(){const s={};Object.keys(pt).forEach(e=>{s[e]=pt[e].value});const t=JSON.stringify(s,null,2);return navigator.clipboard&&(navigator.clipboard.writeText(t),console.log("Tuning config copied to clipboard:",s)),s}function ST(){return pt}function Pp(){xp(),window.debugTuning={state:pt,update:bp,reset:Ep,export:Sp,apply:Mo}}class Cp{constructor(){this.support=this.detectSupport()}detectSupport(){const t=document.documentElement;return t.requestFullscreen?{request:"requestFullscreen",exit:"exitFullscreen",element:"fullscreenElement",enabled:"fullscreenEnabled",change:"fullscreenchange",error:"fullscreenerror"}:t.webkitRequestFullscreen?{request:"webkitRequestFullscreen",exit:"webkitExitFullscreen",element:"webkitFullscreenElement",enabled:"webkitFullscreenEnabled",change:"webkitfullscreenchange",error:"webkitfullscreenerror"}:t.webkitRequestFullScreen?{request:"webkitRequestFullScreen",exit:"webkitCancelFullScreen",element:"webkitCurrentFullScreenElement",enabled:"webkitFullScreenEnabled",change:"webkitfullscreenchange",error:"webkitfullscreenerror"}:t.mozRequestFullScreen?{request:"mozRequestFullScreen",exit:"mozCancelFullScreen",element:"mozFullScreenElement",enabled:"mozFullScreenEnabled",change:"mozfullscreenchange",error:"mozfullscreenerror"}:t.msRequestFullscreen?{request:"msRequestFullscreen",exit:"msExitFullscreen",element:"msFullscreenElement",enabled:"msFullscreenEnabled",change:"MSFullscreenChange",error:"MSFullscreenError"}:null}isSupported(){return this.support!==null}isEnabled(){return this.support?document[this.support.enabled]===!0:!1}async requestFullscreen(t=document.documentElement){if(!this.support)return console.warn("Fullscreen API not supported"),!1;try{const e=t[this.support.request]();return e&&typeof e.then=="function"&&await e,!0}catch(e){return console.error("Fullscreen request failed:",e),!1}}async exitFullscreen(){if(!this.support)return!1;try{const t=document[this.support.exit]();return t&&typeof t.then=="function"&&await t,!0}catch(t){return console.error("Exit fullscreen failed:",t),!1}}async toggleFullscreen(t=document.documentElement){return this.isFullscreen()?await this.exitFullscreen():await this.requestFullscreen(t)}isFullscreen(){return this.support?!!document[this.support.element]:!1}getFullscreenElement(){return this.support?document[this.support.element]:null}addChangeListener(t){return this.support?(document.addEventListener(this.support.change,t),()=>document.removeEventListener(this.support.change,t)):()=>{}}addErrorListener(t){return this.support?(document.addEventListener(this.support.error,t),()=>document.removeEventListener(this.support.error,t)):()=>{}}}const Ir=new Cp;var Rp=O('<img class=preview-image alt="Loading preview">'),Ap=O("<div class=viewer-loading><p>Loading high-resolution artwork...</p><p style=font-size:12px;margin-top:10px;opacity:0.7;>Debug: isLoading=<!>, viewerReady="),Ip=O("<div style=margin-bottom:16px;><div style=display:flex;align-items:center;justify-content:space-between;><label style=font-size:11px;color:rgba(255,255,255,0.8);>Smooth Interpolation</label><button></button></div><div style=font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;>OFF = Perfect sync, ON = Smooth movement"),Dp=O("<div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Smoothing: </label><input type=range min=0.1 max=1.0 step=0.05><div style=font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;>Lower = smoother, Higher = more responsive"),Mp=O("<div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Zoom fade distance: <!>%</label><input type=range min=0.1 max=1.0 step=0.05><div style=font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;>Darkness gradually fades when zooming below this level"),kp=O("<div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Pan fade distance: <!>%</label><input type=range min=0.1 max=1.0 step=0.05><div style=font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px;>Darkness gradually fades as you pan away this distance"),Fp=O("<div><div><div style=font-size:12px;color:#FFFFFF;font-weight:600;letter-spacing:0.5px;text-align:center;>SPOTLIGHT FINE-TUNING</div><button></button></div><div class=floating-panel-scrollable><div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Circle Size: </label><input type=range max=3.0 step=0.05>"),Op=O('<button aria-label="Expand to Full View"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>'),Vp=O('<div class=fullscreen-button-container><button class="fullscreen-button glass-button">'),Lp=O("<div class=viewer-container><div class=openseadragon-viewer>"),Np=O('<svg width=20 height=20 viewBox="0 0 20 20"fill=none><path d="M5 1v4H1M15 1v4h4M5 19v-4H1M15 19v-4h4"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>'),zp=O('<svg width=20 height=20 viewBox="0 0 20 20"fill=none><path d="M1 5V1h4M19 5V1h-4M1 15v4h4M19 15v4h-4"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>');let Dr=[];function Bp(s){let t;const[e,i]=re(null);let n={};const r=vd(),[o,a]=re(null),l=y=>{console.log(`Switching overlay system to: ${y}`);try{r.setCurrentOverlayType(y),r.components().overlayManager&&typeof r.components().overlayManager.destroy=="function"&&(console.log("Destroying old overlay manager"),r.components().overlayManager.destroy()),ai.setPreference(y),console.log("Creating new overlay manager with type:",y);const _=ai.createWithOverride(e());if(_.initialize(),y==="canvas2d"&&_.setAutoDeselectThreshold){const T=r.autoDeselectThreshold();_.setAutoDeselectThreshold(T),console.log("Set auto-deselect threshold on new Canvas2D manager:",T)}r.setComponents(T=>({...T,overlayManager:_})),window.overlayManager=_,r.selectedHotspot()&&(console.log("Re-selecting hotspot after overlay switch:",r.selectedHotspot().id),setTimeout(()=>{_.selectHotspot(r.selectedHotspot())},100)),console.log("Overlay system switch completed successfully")}catch(_){console.error("Error switching overlay system:",_),alert("Error switching overlay system. Please refresh the page to continue.")}},c=()=>{n.handleKeyPress&&window.removeEventListener("keydown",n.handleKeyPress),n.fullscreenCleanup&&n.fullscreenCleanup(),Object.values(n).forEach(y=>{typeof y=="number"&&clearInterval(y)}),n.performanceUpdate&&clearInterval(n.performanceUpdate),r.components().resizeObserver&&t&&r.components().resizeObserver.disconnect(),Object.values(r.components()).forEach(y=>{y&&typeof y.destroy=="function"&&y.destroy()}),r.components().unifiedPerformanceMonitor&&r.components().unifiedPerformanceMonitor.destroy(),e()&&e().destroy(),["performanceMonitor","viewer","tileOptimizer","lowZoomOptimizer","safariPerformanceOptimizer","unifiedPerformanceMonitor"].forEach(y=>{(window[y]===r.components()[y]||window[y]===e())&&delete window[y]})},u=async y=>{var T,x,V,L,W,J,ee,F,E,P,M,k;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:y?y.id:"null (deselecting)",isZoomingToHotspot:r.isZoomingToHotspot(),isExpandingToFullView:r.isExpandingToFullView(),timestamp:Date.now()}),r.isZoomingToHotspot()&&(console.log(" FORCE RESET: Clearing stuck isZoomingToHotspot state"),r.setIsZoomingToHotspot(!1),r.components().renderOptimizer&&r.components().renderOptimizer.endCinematicZoom(),r.components().renderer&&(r.components().renderer.resumeUpdates(),Ge()&&r.components().renderer.showOverlay()),await new Promise(D=>setTimeout(D,16))),console.log("Components available?",!!r.components()),console.log("OverlayManager available?",!!((T=r.components())!=null&&T.overlayManager)),console.log("OverlayManager type:",(V=(x=r.components())==null?void 0:x.overlayManager)==null?void 0:V.constructor.name),console.log("OverlayManager initialized?",(W=(L=r.components())==null?void 0:L.overlayManager)==null?void 0:W.isInitialized),!y){r.setSelectedHotspot(null),r.setShowMediaButton(!1),r.setCurrentPlayingHotspot(null),r.setCurrentMediaHotspot(null),r.components().overlayManager?(console.log("Calling overlayManager.clearSelection()"),r.components().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(r.isExpandingToFullView()&&(console.log("Interrupting Full View animation for hotspot click"),(J=e())==null||J.viewport.stopAnimation(),(ee=o())==null||ee.cleanupExpandAnimation(),r.setIsExpandingToFullView(!1),r.components().renderOptimizer&&r.components().renderOptimizer.endCinematicZoom(),r.components().renderer&&(r.components().renderer.resumeUpdates(),Ge()&&r.components().renderer.showOverlay()),await new Promise(D=>setTimeout(D,50))),r.isZoomingToHotspot()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),r.setIsZoomingToHotspot(!1)),r.setShowMediaButton(!1),r.setSelectedHotspot(y),r.setCurrentPlayingHotspot(y),console.log(" Checking renderer for setVisualSelectedState:",{hasRenderer:!!r.components().renderer,hasMethod:!!(r.components().renderer&&r.components().renderer.setVisualSelectedState),rendererType:(E=(F=r.components().renderer)==null?void 0:F.constructor)==null?void 0:E.name}),r.components().renderer&&r.components().renderer.setVisualSelectedState?(console.log(" Setting visual selected state for:",y.id),r.components().renderer.setVisualSelectedState(y)):console.warn(" Cannot set visual selected state - renderer or method not available"),(P=r.components())!=null&&P.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(y==null?void 0:y.id)||"null"),console.log("Hotspot data being passed:",y),console.log("OverlayManager method exists?",typeof r.components().overlayManager.selectHotspot);try{const D=r.components().renderer;let I={};if(D&&y){const Ce=D.getAnimationDuration?D.getAnimationDuration(y.id):.8,q=D.timingEasing||"cubic-bezier(0.25, 0.40, 0.40, 0.90)";I={duration:Ce,timingEasing:q},console.log("Animation params for Safari:",I)}r.components().overlayManager.selectHotspot(y,I),console.log("selectHotspot call completed")}catch(D){console.error("Error calling selectHotspot:",D)}}else console.error("No overlay manager available in components!"),console.error("Components object:",r.components());(y.image_url_1||((M=r.components().imageOverlayManager)==null?void 0:M.getOverlay(y.id)))&&(r.components().imageOverlayManager.shouldAutoReveal(y.id)?d(y.id):r.components().imageOverlayManager.shouldShowButton(y.id)),console.log(" FIXED: Guaranteed zoom to hotspot:",y.id);try{await((k=o())==null?void 0:k.zoomToHotspot(y))}catch(D){console.error("Zoom failed, forcing state reset:",D),r.setIsZoomingToHotspot(!1)}},d=y=>{console.log("Media button clicked for:",y),r.setShowMediaButton(!1),r.components().imageOverlayManager&&r.components().imageOverlayManager.openOverlay(y)},p=async()=>{try{await Ir.toggleFullscreen()||console.log("Fullscreen toggle failed or not supported")}catch(y){console.error("Error toggling fullscreen:",y)}},m=y=>{const _=y.currentTarget;no(y,_),p()};return window.artworkViewerHandleHotspotClick=u,Yr(async()=>{Pp();try{Dr=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${Dr.length} hotspots`)}catch(P){console.error("Failed to load hotspots:",P),Dr=[]}const y=new Image;y.onload=()=>r.setPreviewLoaded(!0),y.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`,console.log("About to import and initialize viewer...");const{initializeViewer:_}=await Br(async()=>{const{initializeViewer:P}=await import("./viewerSetup-wOrKDdfe.js").then(M=>M.v);return{initializeViewer:P}},[]),T={setIsLoading:r.setIsLoading,setViewerReady:r.setViewerReady},x=await _(t,s,r,u);console.log("Viewer initialization result:",x),i(x.viewer),n=x.intervals,x.homeViewport,console.log("Viewer assigned:",!!x.viewer);const V=_d(x.viewer,r,r.components);a(V),window.animations=V,console.log("Animation hooks set:",!!V);const L=setTimeout(()=>{var P;r.isLoading()&&(console.warn(" Failsafe: Force hiding loading screen after 5 seconds"),T.setIsLoading(!1),T.setViewerReady(!0),x.viewer&&((P=x.viewer.world)==null?void 0:P.getItemCount())>0&&console.log("Viewer has items, forcing ready state"))},5e3);Ge()&&r.currentOverlayType()!=="canvas2d"&&(console.log("Setting Canvas2D overlay manager for mobile performance optimization"),l("canvas2d")),setTimeout(()=>{var P,M;if((P=r.components().overlayManager)!=null&&P.setAutoDeselectThreshold){const k=r.autoDeselectThreshold();r.components().overlayManager.setAutoDeselectThreshold(k),console.log("ArtworkViewer: Set auto-deselect threshold after mount:",k)}if((M=r.components().overlayManager)!=null&&M.state){const k=r.panDeselectThreshold();r.components().overlayManager.state.panThreshold=k,console.log("ArtworkViewer: Set pan threshold after mount:",k)}},500);const W=()=>{r.setIsFullscreen(Ir.isFullscreen())},J=Ir.addChangeListener(W);n.fullscreenCleanup=J;const ee=P=>{if(r.isDragging()){const M=P.touches?P.touches[0].clientX:P.clientX,k=P.touches?P.touches[0].clientY:P.clientY;r.setPanelPosition({x:M-r.dragStart().x,y:k-r.dragStart().y})}},F=P=>{r.isDragging()&&(P.preventDefault(),ee(P))},E=()=>{r.setIsDragging(!1)};window.addEventListener("mousemove",ee),window.addEventListener("mouseup",E,{passive:!0}),window.addEventListener("touchmove",F,{passive:!1}),window.addEventListener("touchend",E,{passive:!0}),Zn(()=>{window.removeEventListener("mousemove",ee),window.removeEventListener("mouseup",E),window.removeEventListener("touchmove",F),window.removeEventListener("touchend",E),clearTimeout(L)}),Zn(c)}),(()=>{var y=Lp(),_=y.firstChild;return Z(y,me(ke,{get when(){return Dt(()=>!!r.previewLoaded())()&&!r.viewerReady()},get children(){var T=Rp();return Le(()=>Bt(T,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),T}}),_),Lc(T=>{t=T,console.log("ViewerRef assigned:",!!T)},_),Z(y,me(ke,{get when(){return r.isLoading()},get children(){var T=Ap(),x=T.firstChild,V=x.nextSibling,L=V.firstChild,W=L.nextSibling;return W.nextSibling,Z(V,()=>String(r.isLoading()),W),Z(V,()=>String(r.viewerReady()),null),T}}),null),Z(y,me(ke,{get when(){return r.viewerReady()},get children(){return[me(Tp,{get visible(){return Ge()},get status(){return r.performanceStatus()}}),me(vp,{get style(){return{position:"fixed",top:"10px",right:"10px",width:Ge()?"90%":"320px",maxWidth:"320px",zIndex:1e3}},get selectedHotspot(){return r.selectedHotspot},get hoveredHotspot(){return r.hoveredHotspot},get totalHotspots(){return Dr.length},get visibleHotspotCount(){var T,x;return(x=(T=r.components().renderer)==null?void 0:T.visibleOverlays)==null?void 0:x.size},get revealStyle(){return r.revealStyle},get setRevealStyle(){return r.updateRevealStyle},get revealType(){return r.revealType},get setRevealType(){return r.setRevealType},get borderStyle(){return r.borderStyle},get updateBorderStyle(){return r.updateBorderStyle},get performanceMetrics(){return r.performanceMetrics()},get zoomSpeed(){return r.zoomSpeedMultiplier},get setZoomSpeed(){return r.setZoomSpeedMultiplier},get setDebugLevel(){return r.setDebugLevel},get currentPalette(){return r.currentPalette},setPalette:T=>{var x;window.setHotspotPalette&&(window.setHotspotPalette(T),r.setCurrentPalette(T),(x=e())==null||x.forceRedraw())},get interactionMode(){return r.interactionMode},setInteractionMode:T=>{var x;r.setInteractionMode(T),localStorage.setItem("interactionMode",T),(x=r.components().renderer)!=null&&x.modeStateManager&&r.components().renderer.modeStateManager.setMode(T)},get overlayType(){return r.currentOverlayType()},toggleOverlay:T=>{console.log("DebugPanel requesting overlay switch to:",T),l(T)},get safariOptimizerState(){var T,x;return(x=(T=r.components().safariPerformanceOptimizer)==null?void 0:T.getState)==null?void 0:x.call(T)},get safariHybridMetrics(){return r.safariHybridMetrics()},consciousnessMetrics:()=>{var x,V,L,W,J,ee;const T=window.cinematicZoomManager;if(!T)return{};if(!((x=T.adaptiveRenderer)!=null&&x.isInitialized))return console.log(" Initializing adaptive renderer for metrics..."),(V=T.adaptiveRenderer)==null||V.initialize().then(()=>{console.log(" Adaptive renderer initialized"),r.setPerformanceMetrics(F=>({...F,_forceUpdate:Date.now()}))}).catch(F=>{console.error(" Failed to initialize adaptive renderer:",F)}),{mode:"consciousness",tier:"initializing...",targetFPS:"...",effects:[],gpu:"detecting..."};if(T.adaptiveRenderer){const F=T.adaptiveRenderer.getMetrics();return{mode:"consciousness",tier:F.tier,targetFPS:(L=F.settings)==null?void 0:L.targetFPS,effects:(W=F.settings)==null?void 0:W.effects,gpu:((ee=(J=F.capabilities)==null?void 0:J.gpu)==null?void 0:ee.tier)||"unknown"}}return{}},isMobile:()=>Ge(),get showFloatingPanel(){return r.showFloatingPanel},get setShowFloatingPanel(){return r.setShowFloatingPanel}})]}}),null),Z(y,me(ke,{get when(){return Dt(()=>!!r.showFloatingPanel())()&&(ai.getCurrentType()==="safari"||ai.detectBrowser().isWebKitBased&&!ai.getCurrentType())},get children(){var T=Fp(),x=T.firstChild,V=x.firstChild,L=V.nextSibling,W=x.nextSibling,J=W.firstChild,ee=J.firstChild;ee.firstChild;var F=ee.nextSibling;return T.style.setProperty("position","fixed"),T.style.setProperty("width","220px"),T.style.setProperty("background","rgba(20,20,20,0.85)"),T.style.setProperty("border","1px solid rgba(255,255,255,0.2)"),T.style.setProperty("borderRadius","12px"),T.style.setProperty("boxShadow","0 8px 32px rgba(0,0,0,0.6)"),T.style.setProperty("zIndex","10000"),T.style.setProperty("userSelect","none"),T.style.setProperty("backdropFilter","blur(20px)"),T.style.setProperty("-webkit-backdrop-filter","blur(20px)"),T.style.setProperty("display","flex"),T.style.setProperty("flexDirection","column"),T.style.setProperty("overflowY","auto"),T.style.setProperty("overflowX","hidden"),x.$$touchstart=E=>{const P=E.touches[0];r.setIsDragging(!0),r.setDragStart({x:P.clientX-r.panelPosition().x,y:P.clientY-r.panelPosition().y})},x.$$mousedown=E=>{r.setIsDragging(!0),r.setDragStart({x:E.clientX-r.panelPosition().x,y:E.clientY-r.panelPosition().y})},x.style.setProperty("position","relative"),x.style.setProperty("padding","12px 40px 12px 16px"),x.style.setProperty("borderBottom","1px solid rgba(255,255,255,0.1)"),x.style.setProperty("cursor","grab"),x.style.setProperty("background","rgba(255,255,255,0.03)"),x.style.setProperty("borderRadius","12px 12px 0 0"),L.$$click=()=>r.setShowFloatingPanel(!1),L.addEventListener("mouseleave",E=>{E.target.style.background="transparent",E.target.style.color="rgba(255,255,255,0.5)"}),L.addEventListener("mouseenter",E=>{E.target.style.background="rgba(255,255,255,0.1)",E.target.style.color="rgba(255,255,255,0.8)"}),L.style.setProperty("position","absolute"),L.style.setProperty("top","8px"),L.style.setProperty("right","8px"),L.style.setProperty("background","transparent"),L.style.setProperty("border","none"),L.style.setProperty("color","rgba(255,255,255,0.5)"),L.style.setProperty("fontSize","16px"),L.style.setProperty("cursor","pointer"),L.style.setProperty("padding","4px"),L.style.setProperty("width","24px"),L.style.setProperty("height","24px"),L.style.setProperty("display","flex"),L.style.setProperty("alignItems","center"),L.style.setProperty("justifyContent","center"),L.style.setProperty("borderRadius","4px"),L.style.setProperty("transition","all 0.2s"),W.style.setProperty("padding","16px"),W.style.setProperty("overflowY","auto"),W.style.setProperty("overflowX","hidden"),W.style.setProperty("flex","1"),W.style.setProperty("WebkitOverflowScrolling","touch"),W.style.setProperty("scrollbarWidth","thin"),W.style.setProperty("scrollbarColor","rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05)"),Z(ee,()=>r.circleMultiplierValue().toFixed(2),null),F.$$input=E=>{const P=parseFloat(E.target.value);r.setCircleMultiplierValue(P),window.safariTuning&&(window.safariTuning.circleMultiplier=P,r.components().overlayManager&&r.selectedHotspot()&&r.components().overlayManager.forceRecalculation())},F.style.setProperty("width","100%"),F.style.setProperty("height","20px"),F.style.setProperty("background","rgba(255,255,255,0.1)"),F.style.setProperty("borderRadius","10px"),F.style.setProperty("outline","none"),F.style.setProperty("appearance","none"),F.style.setProperty("WebkitAppearance","none"),Z(W,me(ke,{get when(){return r.currentOverlayType()==="canvas2d"},get children(){return[(()=>{var E=Ip(),P=E.firstChild,M=P.firstChild,k=M.nextSibling;return k.$$click=()=>{var I,Ce,q;const D=!(((I=r.interpolationEnabled)==null?void 0:I.call(r))??!0);(Ce=r.setInterpolationEnabled)==null||Ce.call(r,D),(q=r.components().overlayManager)!=null&&q.setInterpolation&&r.components().overlayManager.setInterpolation(D)},k.style.setProperty("border","none"),k.style.setProperty("borderRadius","12px"),k.style.setProperty("padding","4px 12px"),k.style.setProperty("fontSize","10px"),k.style.setProperty("color","white"),k.style.setProperty("cursor","pointer"),k.style.setProperty("transition","background 0.2s"),Z(k,()=>{var D;return((D=r.interpolationEnabled)==null?void 0:D.call(r))??!0?"ON":"OFF"}),Le(D=>{var I;return(D=((I=r.interpolationEnabled)==null?void 0:I.call(r))??!0?"rgba(76, 175, 80, 0.8)":"rgba(255,255,255,0.2)")!=null?k.style.setProperty("background",D):k.style.removeProperty("background")}),E})(),me(ke,{get when(){var E;return((E=r.interpolationEnabled)==null?void 0:E.call(r))??!0},get children(){var E=Dp(),P=E.firstChild;P.firstChild;var M=P.nextSibling;return Z(P,()=>{var k;return((k=r.smoothingFactorValue)==null?void 0:k.call(r))||.8},null),M.$$input=k=>{var I,Ce;const D=parseFloat(k.target.value);(I=r.setSmoothingFactorValue)==null||I.call(r,D),(Ce=r.components().overlayManager)!=null&&Ce.setSmoothingFactor&&r.components().overlayManager.setSmoothingFactor(D)},M.style.setProperty("width","100%"),M.style.setProperty("height","20px"),M.style.setProperty("background","rgba(255,255,255,0.1)"),M.style.setProperty("borderRadius","10px"),M.style.setProperty("outline","none"),M.style.setProperty("appearance","none"),M.style.setProperty("WebkitAppearance","none"),Le(()=>{var k;return M.value=((k=r.smoothingFactorValue)==null?void 0:k.call(r))||.8}),E}}),(()=>{var E=Mp(),P=E.firstChild,M=P.firstChild,k=M.nextSibling;k.nextSibling;var D=P.nextSibling;return Z(P,()=>Math.round(r.autoDeselectThreshold()*100),k),D.$$input=I=>{var q;const Ce=parseFloat(I.target.value);r.setAutoDeselectThreshold(Ce),(q=r.components().overlayManager)!=null&&q.setAutoDeselectThreshold&&r.components().overlayManager.setAutoDeselectThreshold(Ce)},D.style.setProperty("width","100%"),D.style.setProperty("height","20px"),D.style.setProperty("background","rgba(255,255,255,0.1)"),D.style.setProperty("borderRadius","10px"),D.style.setProperty("outline","none"),D.style.setProperty("appearance","none"),D.style.setProperty("WebkitAppearance","none"),Le(()=>D.value=r.autoDeselectThreshold()),E})(),(()=>{var E=kp(),P=E.firstChild,M=P.firstChild,k=M.nextSibling;k.nextSibling;var D=P.nextSibling;return Z(P,()=>Math.round(r.panDeselectThreshold()*100),k),D.$$input=I=>{var q;const Ce=parseFloat(I.target.value);r.setPanDeselectThreshold(Ce),(q=r.components().overlayManager)!=null&&q.state&&(r.components().overlayManager.state.panThreshold=Ce,console.log(`Set pan threshold to ${Ce}`))},D.style.setProperty("width","100%"),D.style.setProperty("height","20px"),D.style.setProperty("background","rgba(255,255,255,0.1)"),D.style.setProperty("borderRadius","10px"),D.style.setProperty("outline","none"),D.style.setProperty("appearance","none"),D.style.setProperty("WebkitAppearance","none"),Le(()=>D.value=r.panDeselectThreshold()),E})()]}}),null),Le(E=>{var P=`${r.panelPosition().x}px`,M=`${r.panelPosition().y}px`,k=r.isDragging()?"grabbing":"default",D=Ge()?"80vh":"none",I=Ge()?"0.2":"0.1";return P!==E.e&&((E.e=P)!=null?T.style.setProperty("left",P):T.style.removeProperty("left")),M!==E.t&&((E.t=M)!=null?T.style.setProperty("top",M):T.style.removeProperty("top")),k!==E.a&&((E.a=k)!=null?T.style.setProperty("cursor",k):T.style.removeProperty("cursor")),D!==E.o&&((E.o=D)!=null?T.style.setProperty("maxHeight",D):T.style.removeProperty("maxHeight")),I!==E.i&&Bt(F,"min",E.i=I),E},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),Le(()=>F.value=r.circleMultiplierValue()),T}}),null),Z(y,me(ke,{get when(){return r.showExpandButton()},get children(){var T=Op();return T.$$click=()=>{var x;return(x=o())==null?void 0:x.expandToFullView()},Le(()=>it(T,`expand-button glass-button ${r.expandButtonFading()?"fade-out":""}`)),T}}),null),Z(y,me(ke,{get when(){return Dt(()=>!!(r.viewerReady()&&!Nc()))()&&Ir.isSupported()},get children(){var T=Vp(),x=T.firstChild;return x.$$click=m,Z(x,(()=>{var V=Dt(()=>!!r.isFullscreen());return()=>V()?Np():zp()})()),Le(()=>Bt(x,"aria-label",r.isFullscreen()?"Exit fullscreen":"Enter fullscreen")),T}}),null),Z(y,me(ke,{get when(){return r.viewerReady()},get children(){return me(Bd,{get audioEngine(){return r.components().audioEngine},get currentHotspot(){return r.currentPlayingHotspot}})}}),null),y})()}ii(["mousedown","touchstart","click","input"]);const Hp=()=>{};var hl={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hc=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},Up=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],l=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(l>>10)),t[i++]=String.fromCharCode(56320+(l&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},Uc={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,l=n+2<s.length,c=l?s[n+2]:0,u=r>>2,d=(r&3)<<4|a>>4;let p=(a&15)<<2|c>>6,m=c&63;l||(m=64,o||(p=64)),i.push(e[u],e[d],e[p],e[m])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(Hc(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):Up(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const c=n<s.length?e[s.charAt(n)]:64;++n;const d=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||c==null||d==null)throw new jp;const p=r<<2|a>>4;if(i.push(p),c!==64){const m=a<<4&240|c>>2;if(i.push(m),d!==64){const y=c<<6&192|d;i.push(y)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class jp extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Wp=function(s){const t=Hc(s);return Uc.encodeByteArray(t,!0)},$r=function(s){return Wp(s).replace(/\./g,"")},qp=function(s){try{return Uc.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Gp(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zp=()=>Gp().__FIREBASE_DEFAULTS__,Xp=()=>{if(typeof process>"u"||typeof hl>"u")return;const s=hl.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},Yp=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&qp(s[1]);return t&&JSON.parse(t)},ko=()=>{try{return Hp()||Zp()||Xp()||Yp()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},Kp=s=>{var t,e;return(e=(t=ko())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},Qp=s=>{const t=Kp(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},jc=()=>{var s;return(s=ko())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jp{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fo(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function $p(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ef(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[$r(JSON.stringify(e)),$r(JSON.stringify(o)),""].join(".")}const Un={};function tf(){const s={prod:[],emulator:[]};for(const t of Object.keys(Un))Un[t]?s.emulator.push(t):s.prod.push(t);return s}function nf(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let ul=!1;function rf(s,t){if(typeof window>"u"||typeof document>"u"||!Fo(window.location.host)||Un[s]===t||Un[s]||ul)return;Un[s]=t;function e(p){return`__firebase__banner__${p}`}const i="__firebase__banner",r=tf().prod.length>0;function o(){const p=document.getElementById(i);p&&p.remove()}function a(p){p.style.display="flex",p.style.background="#7faaf0",p.style.position="fixed",p.style.bottom="5px",p.style.left="5px",p.style.padding=".5em",p.style.borderRadius="5px",p.style.alignItems="center"}function l(p,m){p.setAttribute("width","24"),p.setAttribute("id",m),p.setAttribute("height","24"),p.setAttribute("viewBox","0 0 24 24"),p.setAttribute("fill","none"),p.style.marginLeft="-6px"}function c(){const p=document.createElement("span");return p.style.cursor="pointer",p.style.marginLeft="16px",p.style.fontSize="24px",p.innerHTML=" &times;",p.onclick=()=>{ul=!0,o()},p}function u(p,m){p.setAttribute("id",m),p.innerText="Learn more",p.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",p.setAttribute("target","__blank"),p.style.paddingLeft="5px",p.style.textDecoration="underline"}function d(){const p=nf(i),m=e("text"),y=document.getElementById(m)||document.createElement("span"),_=e("learnmore"),T=document.getElementById(_)||document.createElement("a"),x=e("preprendIcon"),V=document.getElementById(x)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(p.created){const L=p.element;a(L),u(T,_);const W=c();l(V,x),L.append(V,y,T,W),document.body.appendChild(L)}r?(y.innerText="Preview backend disconnected.",V.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(V.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,y.innerText="Preview backend running in this workspace."),y.setAttribute("id",m)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",d):d()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sf(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function of(){var s;const t=(s=ko())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function af(){return!of()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function lf(){try{return typeof indexedDB=="object"}catch{return!1}}function cf(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hf="FirebaseError";class yn extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=hf,Object.setPrototypeOf(this,yn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Wc.prototype.create)}}class Wc{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?uf(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new yn(n,a,i)}}function uf(s,t){return s.replace(df,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const df=/\{\$([^}]+)}/g;function es(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if(dl(r)&&dl(o)){if(!es(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function dl(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Gt(s){return s&&s._delegate?s._delegate:s}class Yn{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fi="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pf{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new Jp;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(gf(t))try{this.getOrInitializeService({instanceIdentifier:Fi})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=Fi){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=Fi){return this.instances.has(t)}getOptions(t=Fi){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:ff(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=Fi){return this.component?this.component.multipleInstances?t:Fi:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function ff(s){return s===Fi?void 0:s}function gf(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mf{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new pf(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ue;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(Ue||(Ue={}));const yf={debug:Ue.DEBUG,verbose:Ue.VERBOSE,info:Ue.INFO,warn:Ue.WARN,error:Ue.ERROR,silent:Ue.SILENT},vf=Ue.INFO,wf={[Ue.DEBUG]:"log",[Ue.VERBOSE]:"log",[Ue.INFO]:"info",[Ue.WARN]:"warn",[Ue.ERROR]:"error"},_f=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=wf[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class qc{constructor(t){this.name=t,this._logLevel=vf,this._logHandler=_f,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Ue))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?yf[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Ue.DEBUG,...t),this._logHandler(this,Ue.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Ue.VERBOSE,...t),this._logHandler(this,Ue.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Ue.INFO,...t),this._logHandler(this,Ue.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Ue.WARN,...t),this._logHandler(this,Ue.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Ue.ERROR,...t),this._logHandler(this,Ue.ERROR,...t)}}const Tf=(s,t)=>t.some(e=>s instanceof e);let pl,fl;function bf(){return pl||(pl=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function xf(){return fl||(fl=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Gc=new WeakMap,so=new WeakMap,Zc=new WeakMap,Gs=new WeakMap,Oo=new WeakMap;function Ef(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(ci(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Gc.set(e,s)}).catch(()=>{}),Oo.set(t,s),t}function Sf(s){if(so.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});so.set(s,t)}let oo={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return so.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Zc.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return ci(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function Pf(s){oo=s(oo)}function Cf(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(Zs(this),t,...e);return Zc.set(i,t.sort?t.sort():[t]),ci(i)}:xf().includes(s)?function(...t){return s.apply(Zs(this),t),ci(Gc.get(this))}:function(...t){return ci(s.apply(Zs(this),t))}}function Rf(s){return typeof s=="function"?Cf(s):(s instanceof IDBTransaction&&Sf(s),Tf(s,bf())?new Proxy(s,oo):s)}function ci(s){if(s instanceof IDBRequest)return Ef(s);if(Gs.has(s))return Gs.get(s);const t=Rf(s);return t!==s&&(Gs.set(s,t),Oo.set(t,s)),t}const Zs=s=>Oo.get(s);function Af(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=ci(o);return i&&o.addEventListener("upgradeneeded",l=>{i(ci(o.result),l.oldVersion,l.newVersion,ci(o.transaction),l)}),e&&o.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),n&&l.addEventListener("versionchange",c=>n(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const If=["get","getKey","getAll","getAllKeys","count"],Df=["put","add","delete","clear"],Xs=new Map;function gl(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(Xs.get(t))return Xs.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=Df.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||If.includes(e)))return;const r=async function(o,...a){const l=this.transaction(o,n?"readwrite":"readonly");let c=l.store;return i&&(c=c.index(a.shift())),(await Promise.all([c[e](...a),n&&l.done]))[0]};return Xs.set(t,r),r}Pf(s=>({...s,get:(t,e,i)=>gl(t,e)||s.get(t,e,i),has:(t,e)=>!!gl(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mf{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(kf(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function kf(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const ao="@firebase/app",ml="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $t=new qc("@firebase/app"),Ff="@firebase/app-compat",Of="@firebase/analytics-compat",Vf="@firebase/analytics",Lf="@firebase/app-check-compat",Nf="@firebase/app-check",zf="@firebase/auth",Bf="@firebase/auth-compat",Hf="@firebase/database",Uf="@firebase/data-connect",jf="@firebase/database-compat",Wf="@firebase/functions",qf="@firebase/functions-compat",Gf="@firebase/installations",Zf="@firebase/installations-compat",Xf="@firebase/messaging",Yf="@firebase/messaging-compat",Kf="@firebase/performance",Qf="@firebase/performance-compat",Jf="@firebase/remote-config",$f="@firebase/remote-config-compat",eg="@firebase/storage",tg="@firebase/storage-compat",ig="@firebase/firestore",ng="@firebase/ai",rg="@firebase/firestore-compat",sg="firebase",og="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lo="[DEFAULT]",ag={[ao]:"fire-core",[Ff]:"fire-core-compat",[Vf]:"fire-analytics",[Of]:"fire-analytics-compat",[Nf]:"fire-app-check",[Lf]:"fire-app-check-compat",[zf]:"fire-auth",[Bf]:"fire-auth-compat",[Hf]:"fire-rtdb",[Uf]:"fire-data-connect",[jf]:"fire-rtdb-compat",[Wf]:"fire-fn",[qf]:"fire-fn-compat",[Gf]:"fire-iid",[Zf]:"fire-iid-compat",[Xf]:"fire-fcm",[Yf]:"fire-fcm-compat",[Kf]:"fire-perf",[Qf]:"fire-perf-compat",[Jf]:"fire-rc",[$f]:"fire-rc-compat",[eg]:"fire-gcs",[tg]:"fire-gcs-compat",[ig]:"fire-fst",[rg]:"fire-fst-compat",[ng]:"fire-vertex","fire-js":"fire-js",[sg]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ts=new Map,lg=new Map,co=new Map;function yl(s,t){try{s.container.addComponent(t)}catch(e){$t.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function is(s){const t=s.name;if(co.has(t))return $t.debug(`There were multiple attempts to register component ${t}.`),!1;co.set(t,s);for(const e of ts.values())yl(e,s);for(const e of lg.values())yl(e,s);return!0}function cg(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function hg(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ug={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},hi=new Wc("app","Firebase",ug);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dg{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new Yn("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw hi.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pg=og;function Xc(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:lo,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw hi.create("bad-app-name",{appName:String(n)});if(e||(e=jc()),!e)throw hi.create("no-options");const r=ts.get(n);if(r){if(es(e,r.options)&&es(i,r.config))return r;throw hi.create("duplicate-app",{appName:n})}const o=new mf(n);for(const l of co.values())o.addComponent(l);const a=new dg(e,i,o);return ts.set(n,a),a}function fg(s=lo){const t=ts.get(s);if(!t&&s===lo&&jc())return Xc();if(!t)throw hi.create("no-app",{appName:s});return t}function ln(s,t,e){var i;let n=(i=ag[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),$t.warn(a.join(" "));return}is(new Yn(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gg="firebase-heartbeat-database",mg=1,Kn="firebase-heartbeat-store";let Ys=null;function Yc(){return Ys||(Ys=Af(gg,mg,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(Kn)}catch(e){console.warn(e)}}}}).catch(s=>{throw hi.create("idb-open",{originalErrorMessage:s.message})})),Ys}async function yg(s){try{const e=(await Yc()).transaction(Kn),i=await e.objectStore(Kn).get(Kc(s));return await e.done,i}catch(t){if(t instanceof yn)$t.warn(t.message);else{const e=hi.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});$t.warn(e.message)}}}async function vl(s,t){try{const i=(await Yc()).transaction(Kn,"readwrite");await i.objectStore(Kn).put(t,Kc(s)),await i.done}catch(e){if(e instanceof yn)$t.warn(e.message);else{const i=hi.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});$t.warn(i.message)}}}function Kc(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vg=1024,wg=30;class _g{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new bg(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=wl();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>wg){const o=xg(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){$t.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=wl(),{heartbeatsToSend:i,unsentEntries:n}=Tg(this._heartbeatsCache.heartbeats),r=$r(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return $t.warn(e),""}}}function wl(){return new Date().toISOString().substring(0,10)}function Tg(s,t=vg){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),_l(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),_l(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class bg{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return lf()?cf().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await yg(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return vl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return vl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function _l(s){return $r(JSON.stringify({version:2,heartbeats:s})).length}function xg(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Eg(s){is(new Yn("platform-logger",t=>new Mf(t),"PRIVATE")),is(new Yn("heartbeat",t=>new _g(t),"PRIVATE")),ln(ao,ml,s),ln(ao,ml,"esm2017"),ln("fire-js","")}Eg("");var Tl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var ui,Qc;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(F,E){function P(){}P.prototype=E.prototype,F.D=E.prototype,F.prototype=new P,F.prototype.constructor=F,F.C=function(M,k,D){for(var I=Array(arguments.length-2),Ce=2;Ce<arguments.length;Ce++)I[Ce-2]=arguments[Ce];return E.prototype[k].apply(M,I)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(F,E,P){P||(P=0);var M=Array(16);if(typeof E=="string")for(var k=0;16>k;++k)M[k]=E.charCodeAt(P++)|E.charCodeAt(P++)<<8|E.charCodeAt(P++)<<16|E.charCodeAt(P++)<<24;else for(k=0;16>k;++k)M[k]=E[P++]|E[P++]<<8|E[P++]<<16|E[P++]<<24;E=F.g[0],P=F.g[1],k=F.g[2];var D=F.g[3],I=E+(D^P&(k^D))+M[0]+3614090360&4294967295;E=P+(I<<7&4294967295|I>>>25),I=D+(k^E&(P^k))+M[1]+3905402710&4294967295,D=E+(I<<12&4294967295|I>>>20),I=k+(P^D&(E^P))+M[2]+606105819&4294967295,k=D+(I<<17&4294967295|I>>>15),I=P+(E^k&(D^E))+M[3]+3250441966&4294967295,P=k+(I<<22&4294967295|I>>>10),I=E+(D^P&(k^D))+M[4]+4118548399&4294967295,E=P+(I<<7&4294967295|I>>>25),I=D+(k^E&(P^k))+M[5]+1200080426&4294967295,D=E+(I<<12&4294967295|I>>>20),I=k+(P^D&(E^P))+M[6]+2821735955&4294967295,k=D+(I<<17&4294967295|I>>>15),I=P+(E^k&(D^E))+M[7]+4249261313&4294967295,P=k+(I<<22&4294967295|I>>>10),I=E+(D^P&(k^D))+M[8]+1770035416&4294967295,E=P+(I<<7&4294967295|I>>>25),I=D+(k^E&(P^k))+M[9]+2336552879&4294967295,D=E+(I<<12&4294967295|I>>>20),I=k+(P^D&(E^P))+M[10]+4294925233&4294967295,k=D+(I<<17&4294967295|I>>>15),I=P+(E^k&(D^E))+M[11]+2304563134&4294967295,P=k+(I<<22&4294967295|I>>>10),I=E+(D^P&(k^D))+M[12]+1804603682&4294967295,E=P+(I<<7&4294967295|I>>>25),I=D+(k^E&(P^k))+M[13]+4254626195&4294967295,D=E+(I<<12&4294967295|I>>>20),I=k+(P^D&(E^P))+M[14]+2792965006&4294967295,k=D+(I<<17&4294967295|I>>>15),I=P+(E^k&(D^E))+M[15]+1236535329&4294967295,P=k+(I<<22&4294967295|I>>>10),I=E+(k^D&(P^k))+M[1]+4129170786&4294967295,E=P+(I<<5&4294967295|I>>>27),I=D+(P^k&(E^P))+M[6]+3225465664&4294967295,D=E+(I<<9&4294967295|I>>>23),I=k+(E^P&(D^E))+M[11]+643717713&4294967295,k=D+(I<<14&4294967295|I>>>18),I=P+(D^E&(k^D))+M[0]+3921069994&4294967295,P=k+(I<<20&4294967295|I>>>12),I=E+(k^D&(P^k))+M[5]+3593408605&4294967295,E=P+(I<<5&4294967295|I>>>27),I=D+(P^k&(E^P))+M[10]+38016083&4294967295,D=E+(I<<9&4294967295|I>>>23),I=k+(E^P&(D^E))+M[15]+3634488961&4294967295,k=D+(I<<14&4294967295|I>>>18),I=P+(D^E&(k^D))+M[4]+3889429448&4294967295,P=k+(I<<20&4294967295|I>>>12),I=E+(k^D&(P^k))+M[9]+568446438&4294967295,E=P+(I<<5&4294967295|I>>>27),I=D+(P^k&(E^P))+M[14]+3275163606&4294967295,D=E+(I<<9&4294967295|I>>>23),I=k+(E^P&(D^E))+M[3]+4107603335&4294967295,k=D+(I<<14&4294967295|I>>>18),I=P+(D^E&(k^D))+M[8]+1163531501&4294967295,P=k+(I<<20&4294967295|I>>>12),I=E+(k^D&(P^k))+M[13]+2850285829&4294967295,E=P+(I<<5&4294967295|I>>>27),I=D+(P^k&(E^P))+M[2]+4243563512&4294967295,D=E+(I<<9&4294967295|I>>>23),I=k+(E^P&(D^E))+M[7]+1735328473&4294967295,k=D+(I<<14&4294967295|I>>>18),I=P+(D^E&(k^D))+M[12]+2368359562&4294967295,P=k+(I<<20&4294967295|I>>>12),I=E+(P^k^D)+M[5]+4294588738&4294967295,E=P+(I<<4&4294967295|I>>>28),I=D+(E^P^k)+M[8]+2272392833&4294967295,D=E+(I<<11&4294967295|I>>>21),I=k+(D^E^P)+M[11]+1839030562&4294967295,k=D+(I<<16&4294967295|I>>>16),I=P+(k^D^E)+M[14]+4259657740&4294967295,P=k+(I<<23&4294967295|I>>>9),I=E+(P^k^D)+M[1]+2763975236&4294967295,E=P+(I<<4&4294967295|I>>>28),I=D+(E^P^k)+M[4]+1272893353&4294967295,D=E+(I<<11&4294967295|I>>>21),I=k+(D^E^P)+M[7]+4139469664&4294967295,k=D+(I<<16&4294967295|I>>>16),I=P+(k^D^E)+M[10]+3200236656&4294967295,P=k+(I<<23&4294967295|I>>>9),I=E+(P^k^D)+M[13]+681279174&4294967295,E=P+(I<<4&4294967295|I>>>28),I=D+(E^P^k)+M[0]+3936430074&4294967295,D=E+(I<<11&4294967295|I>>>21),I=k+(D^E^P)+M[3]+3572445317&4294967295,k=D+(I<<16&4294967295|I>>>16),I=P+(k^D^E)+M[6]+76029189&4294967295,P=k+(I<<23&4294967295|I>>>9),I=E+(P^k^D)+M[9]+3654602809&4294967295,E=P+(I<<4&4294967295|I>>>28),I=D+(E^P^k)+M[12]+3873151461&4294967295,D=E+(I<<11&4294967295|I>>>21),I=k+(D^E^P)+M[15]+530742520&4294967295,k=D+(I<<16&4294967295|I>>>16),I=P+(k^D^E)+M[2]+3299628645&4294967295,P=k+(I<<23&4294967295|I>>>9),I=E+(k^(P|~D))+M[0]+4096336452&4294967295,E=P+(I<<6&4294967295|I>>>26),I=D+(P^(E|~k))+M[7]+1126891415&4294967295,D=E+(I<<10&4294967295|I>>>22),I=k+(E^(D|~P))+M[14]+2878612391&4294967295,k=D+(I<<15&4294967295|I>>>17),I=P+(D^(k|~E))+M[5]+4237533241&4294967295,P=k+(I<<21&4294967295|I>>>11),I=E+(k^(P|~D))+M[12]+1700485571&4294967295,E=P+(I<<6&4294967295|I>>>26),I=D+(P^(E|~k))+M[3]+2399980690&4294967295,D=E+(I<<10&4294967295|I>>>22),I=k+(E^(D|~P))+M[10]+4293915773&4294967295,k=D+(I<<15&4294967295|I>>>17),I=P+(D^(k|~E))+M[1]+2240044497&4294967295,P=k+(I<<21&4294967295|I>>>11),I=E+(k^(P|~D))+M[8]+1873313359&4294967295,E=P+(I<<6&4294967295|I>>>26),I=D+(P^(E|~k))+M[15]+4264355552&4294967295,D=E+(I<<10&4294967295|I>>>22),I=k+(E^(D|~P))+M[6]+2734768916&4294967295,k=D+(I<<15&4294967295|I>>>17),I=P+(D^(k|~E))+M[13]+1309151649&4294967295,P=k+(I<<21&4294967295|I>>>11),I=E+(k^(P|~D))+M[4]+4149444226&4294967295,E=P+(I<<6&4294967295|I>>>26),I=D+(P^(E|~k))+M[11]+3174756917&4294967295,D=E+(I<<10&4294967295|I>>>22),I=k+(E^(D|~P))+M[2]+718787259&4294967295,k=D+(I<<15&4294967295|I>>>17),I=P+(D^(k|~E))+M[9]+3951481745&4294967295,F.g[0]=F.g[0]+E&4294967295,F.g[1]=F.g[1]+(k+(I<<21&4294967295|I>>>11))&4294967295,F.g[2]=F.g[2]+k&4294967295,F.g[3]=F.g[3]+D&4294967295}i.prototype.u=function(F,E){E===void 0&&(E=F.length);for(var P=E-this.blockSize,M=this.B,k=this.h,D=0;D<E;){if(k==0)for(;D<=P;)n(this,F,D),D+=this.blockSize;if(typeof F=="string"){for(;D<E;)if(M[k++]=F.charCodeAt(D++),k==this.blockSize){n(this,M),k=0;break}}else for(;D<E;)if(M[k++]=F[D++],k==this.blockSize){n(this,M),k=0;break}}this.h=k,this.o+=E},i.prototype.v=function(){var F=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);F[0]=128;for(var E=1;E<F.length-8;++E)F[E]=0;var P=8*this.o;for(E=F.length-8;E<F.length;++E)F[E]=P&255,P/=256;for(this.u(F),F=Array(16),E=P=0;4>E;++E)for(var M=0;32>M;M+=8)F[P++]=this.g[E]>>>M&255;return F};function r(F,E){var P=a;return Object.prototype.hasOwnProperty.call(P,F)?P[F]:P[F]=E(F)}function o(F,E){this.h=E;for(var P=[],M=!0,k=F.length-1;0<=k;k--){var D=F[k]|0;M&&D==E||(P[k]=D,M=!1)}this.g=P}var a={};function l(F){return-128<=F&&128>F?r(F,function(E){return new o([E|0],0>E?-1:0)}):new o([F|0],0>F?-1:0)}function c(F){if(isNaN(F)||!isFinite(F))return d;if(0>F)return T(c(-F));for(var E=[],P=1,M=0;F>=P;M++)E[M]=F/P|0,P*=4294967296;return new o(E,0)}function u(F,E){if(F.length==0)throw Error("number format error: empty string");if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(F.charAt(0)=="-")return T(u(F.substring(1),E));if(0<=F.indexOf("-"))throw Error('number format error: interior "-" character');for(var P=c(Math.pow(E,8)),M=d,k=0;k<F.length;k+=8){var D=Math.min(8,F.length-k),I=parseInt(F.substring(k,k+D),E);8>D?(D=c(Math.pow(E,D)),M=M.j(D).add(c(I))):(M=M.j(P),M=M.add(c(I)))}return M}var d=l(0),p=l(1),m=l(16777216);s=o.prototype,s.m=function(){if(_(this))return-T(this).m();for(var F=0,E=1,P=0;P<this.g.length;P++){var M=this.i(P);F+=(0<=M?M:4294967296+M)*E,E*=4294967296}return F},s.toString=function(F){if(F=F||10,2>F||36<F)throw Error("radix out of range: "+F);if(y(this))return"0";if(_(this))return"-"+T(this).toString(F);for(var E=c(Math.pow(F,6)),P=this,M="";;){var k=W(P,E).g;P=x(P,k.j(E));var D=((0<P.g.length?P.g[0]:P.h)>>>0).toString(F);if(P=k,y(P))return D+M;for(;6>D.length;)D="0"+D;M=D+M}},s.i=function(F){return 0>F?0:F<this.g.length?this.g[F]:this.h};function y(F){if(F.h!=0)return!1;for(var E=0;E<F.g.length;E++)if(F.g[E]!=0)return!1;return!0}function _(F){return F.h==-1}s.l=function(F){return F=x(this,F),_(F)?-1:y(F)?0:1};function T(F){for(var E=F.g.length,P=[],M=0;M<E;M++)P[M]=~F.g[M];return new o(P,~F.h).add(p)}s.abs=function(){return _(this)?T(this):this},s.add=function(F){for(var E=Math.max(this.g.length,F.g.length),P=[],M=0,k=0;k<=E;k++){var D=M+(this.i(k)&65535)+(F.i(k)&65535),I=(D>>>16)+(this.i(k)>>>16)+(F.i(k)>>>16);M=I>>>16,D&=65535,I&=65535,P[k]=I<<16|D}return new o(P,P[P.length-1]&-2147483648?-1:0)};function x(F,E){return F.add(T(E))}s.j=function(F){if(y(this)||y(F))return d;if(_(this))return _(F)?T(this).j(T(F)):T(T(this).j(F));if(_(F))return T(this.j(T(F)));if(0>this.l(m)&&0>F.l(m))return c(this.m()*F.m());for(var E=this.g.length+F.g.length,P=[],M=0;M<2*E;M++)P[M]=0;for(M=0;M<this.g.length;M++)for(var k=0;k<F.g.length;k++){var D=this.i(M)>>>16,I=this.i(M)&65535,Ce=F.i(k)>>>16,q=F.i(k)&65535;P[2*M+2*k]+=I*q,V(P,2*M+2*k),P[2*M+2*k+1]+=D*q,V(P,2*M+2*k+1),P[2*M+2*k+1]+=I*Ce,V(P,2*M+2*k+1),P[2*M+2*k+2]+=D*Ce,V(P,2*M+2*k+2)}for(M=0;M<E;M++)P[M]=P[2*M+1]<<16|P[2*M];for(M=E;M<2*E;M++)P[M]=0;return new o(P,0)};function V(F,E){for(;(F[E]&65535)!=F[E];)F[E+1]+=F[E]>>>16,F[E]&=65535,E++}function L(F,E){this.g=F,this.h=E}function W(F,E){if(y(E))throw Error("division by zero");if(y(F))return new L(d,d);if(_(F))return E=W(T(F),E),new L(T(E.g),T(E.h));if(_(E))return E=W(F,T(E)),new L(T(E.g),E.h);if(30<F.g.length){if(_(F)||_(E))throw Error("slowDivide_ only works with positive integers.");for(var P=p,M=E;0>=M.l(F);)P=J(P),M=J(M);var k=ee(P,1),D=ee(M,1);for(M=ee(M,2),P=ee(P,2);!y(M);){var I=D.add(M);0>=I.l(F)&&(k=k.add(P),D=I),M=ee(M,1),P=ee(P,1)}return E=x(F,k.j(E)),new L(k,E)}for(k=d;0<=F.l(E);){for(P=Math.max(1,Math.floor(F.m()/E.m())),M=Math.ceil(Math.log(P)/Math.LN2),M=48>=M?1:Math.pow(2,M-48),D=c(P),I=D.j(E);_(I)||0<I.l(F);)P-=M,D=c(P),I=D.j(E);y(D)&&(D=p),k=k.add(D),F=x(F,I)}return new L(k,F)}s.A=function(F){return W(this,F).h},s.and=function(F){for(var E=Math.max(this.g.length,F.g.length),P=[],M=0;M<E;M++)P[M]=this.i(M)&F.i(M);return new o(P,this.h&F.h)},s.or=function(F){for(var E=Math.max(this.g.length,F.g.length),P=[],M=0;M<E;M++)P[M]=this.i(M)|F.i(M);return new o(P,this.h|F.h)},s.xor=function(F){for(var E=Math.max(this.g.length,F.g.length),P=[],M=0;M<E;M++)P[M]=this.i(M)^F.i(M);return new o(P,this.h^F.h)};function J(F){for(var E=F.g.length+1,P=[],M=0;M<E;M++)P[M]=F.i(M)<<1|F.i(M-1)>>>31;return new o(P,F.h)}function ee(F,E){var P=E>>5;E%=32;for(var M=F.g.length-P,k=[],D=0;D<M;D++)k[D]=0<E?F.i(D+P)>>>E|F.i(D+P+1)<<32-E:F.i(D+P);return new o(k,F.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,Qc=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=c,o.fromString=u,ui=o}).apply(typeof Tl<"u"?Tl:typeof self<"u"?self:typeof window<"u"?window:{});var Mr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Jc,On,$c,Hr,ho,eh,th,ih;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(h,f,v){return h==Array.prototype||h==Object.prototype||(h[f]=v.value),h};function e(h){h=[typeof globalThis=="object"&&globalThis,h,typeof window=="object"&&window,typeof self=="object"&&self,typeof Mr=="object"&&Mr];for(var f=0;f<h.length;++f){var v=h[f];if(v&&v.Math==Math)return v}throw Error("Cannot find global object")}var i=e(this);function n(h,f){if(f)e:{var v=i;h=h.split(".");for(var R=0;R<h.length-1;R++){var z=h[R];if(!(z in v))break e;v=v[z]}h=h[h.length-1],R=v[h],f=f(R),f!=R&&f!=null&&t(v,h,{configurable:!0,writable:!0,value:f})}}function r(h,f){h instanceof String&&(h+="");var v=0,R=!1,z={next:function(){if(!R&&v<h.length){var j=v++;return{value:f(j,h[j]),done:!1}}return R=!0,{done:!0,value:void 0}}};return z[Symbol.iterator]=function(){return z},z}n("Array.prototype.values",function(h){return h||function(){return r(this,function(f,v){return v})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function l(h){var f=typeof h;return f=f!="object"?f:h?Array.isArray(h)?"array":f:"null",f=="array"||f=="object"&&typeof h.length=="number"}function c(h){var f=typeof h;return f=="object"&&h!=null||f=="function"}function u(h,f,v){return h.call.apply(h.bind,arguments)}function d(h,f,v){if(!h)throw Error();if(2<arguments.length){var R=Array.prototype.slice.call(arguments,2);return function(){var z=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(z,R),h.apply(f,z)}}return function(){return h.apply(f,arguments)}}function p(h,f,v){return p=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?u:d,p.apply(null,arguments)}function m(h,f){var v=Array.prototype.slice.call(arguments,1);return function(){var R=v.slice();return R.push.apply(R,arguments),h.apply(this,R)}}function y(h,f){function v(){}v.prototype=f.prototype,h.aa=f.prototype,h.prototype=new v,h.prototype.constructor=h,h.Qb=function(R,z,j){for(var he=Array(arguments.length-2),Ye=2;Ye<arguments.length;Ye++)he[Ye-2]=arguments[Ye];return f.prototype[z].apply(R,he)}}function _(h){const f=h.length;if(0<f){const v=Array(f);for(let R=0;R<f;R++)v[R]=h[R];return v}return[]}function T(h,f){for(let v=1;v<arguments.length;v++){const R=arguments[v];if(l(R)){const z=h.length||0,j=R.length||0;h.length=z+j;for(let he=0;he<j;he++)h[z+he]=R[he]}else h.push(R)}}class x{constructor(f,v){this.i=f,this.j=v,this.h=0,this.g=null}get(){let f;return 0<this.h?(this.h--,f=this.g,this.g=f.next,f.next=null):f=this.i(),f}}function V(h){return/^[\s\xa0]*$/.test(h)}function L(){var h=a.navigator;return h&&(h=h.userAgent)?h:""}function W(h){return W[" "](h),h}W[" "]=function(){};var J=L().indexOf("Gecko")!=-1&&!(L().toLowerCase().indexOf("webkit")!=-1&&L().indexOf("Edge")==-1)&&!(L().indexOf("Trident")!=-1||L().indexOf("MSIE")!=-1)&&L().indexOf("Edge")==-1;function ee(h,f,v){for(const R in h)f.call(v,h[R],R,h)}function F(h,f){for(const v in h)f.call(void 0,h[v],v,h)}function E(h){const f={};for(const v in h)f[v]=h[v];return f}const P="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function M(h,f){let v,R;for(let z=1;z<arguments.length;z++){R=arguments[z];for(v in R)h[v]=R[v];for(let j=0;j<P.length;j++)v=P[j],Object.prototype.hasOwnProperty.call(R,v)&&(h[v]=R[v])}}function k(h){var f=1;h=h.split(":");const v=[];for(;0<f&&h.length;)v.push(h.shift()),f--;return h.length&&v.push(h.join(":")),v}function D(h){a.setTimeout(()=>{throw h},0)}function I(){var h=H;let f=null;return h.g&&(f=h.g,h.g=h.g.next,h.g||(h.h=null),f.next=null),f}class Ce{constructor(){this.h=this.g=null}add(f,v){const R=q.get();R.set(f,v),this.h?this.h.next=R:this.g=R,this.h=R}}var q=new x(()=>new ne,h=>h.reset());class ne{constructor(){this.next=this.g=this.h=null}set(f,v){this.h=f,this.g=v,this.next=null}reset(){this.next=this.g=this.h=null}}let te,$=!1,H=new Ce,se=()=>{const h=a.Promise.resolve(void 0);te=()=>{h.then(ce)}};var ce=()=>{for(var h;h=I();){try{h.h.call(h.g)}catch(v){D(v)}var f=q;f.j(h),100>f.h&&(f.h++,h.next=f.g,f.g=h)}$=!1};function ue(){this.s=this.s,this.C=this.C}ue.prototype.s=!1,ue.prototype.ma=function(){this.s||(this.s=!0,this.N())},ue.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function Y(h,f){this.type=h,this.g=this.target=f,this.defaultPrevented=!1}Y.prototype.h=function(){this.defaultPrevented=!0};var oe=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var h=!1,f=Object.defineProperty({},"passive",{get:function(){h=!0}});try{const v=()=>{};a.addEventListener("test",v,f),a.removeEventListener("test",v,f)}catch{}return h}();function le(h,f){if(Y.call(this,h?h.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,h){var v=this.type=h.type,R=h.changedTouches&&h.changedTouches.length?h.changedTouches[0]:null;if(this.target=h.target||h.srcElement,this.g=f,f=h.relatedTarget){if(J){e:{try{W(f.nodeName);var z=!0;break e}catch{}z=!1}z||(f=null)}}else v=="mouseover"?f=h.fromElement:v=="mouseout"&&(f=h.toElement);this.relatedTarget=f,R?(this.clientX=R.clientX!==void 0?R.clientX:R.pageX,this.clientY=R.clientY!==void 0?R.clientY:R.pageY,this.screenX=R.screenX||0,this.screenY=R.screenY||0):(this.clientX=h.clientX!==void 0?h.clientX:h.pageX,this.clientY=h.clientY!==void 0?h.clientY:h.pageY,this.screenX=h.screenX||0,this.screenY=h.screenY||0),this.button=h.button,this.key=h.key||"",this.ctrlKey=h.ctrlKey,this.altKey=h.altKey,this.shiftKey=h.shiftKey,this.metaKey=h.metaKey,this.pointerId=h.pointerId||0,this.pointerType=typeof h.pointerType=="string"?h.pointerType:_e[h.pointerType]||"",this.state=h.state,this.i=h,h.defaultPrevented&&le.aa.h.call(this)}}y(le,Y);var _e={2:"touch",3:"pen",4:"mouse"};le.prototype.h=function(){le.aa.h.call(this);var h=this.i;h.preventDefault?h.preventDefault():h.returnValue=!1};var ge="closure_listenable_"+(1e6*Math.random()|0),Oe=0;function qe(h,f,v,R,z){this.listener=h,this.proxy=null,this.src=f,this.type=v,this.capture=!!R,this.ha=z,this.key=++Oe,this.da=this.fa=!1}function De(h){h.da=!0,h.listener=null,h.proxy=null,h.src=null,h.ha=null}function Te(h){this.src=h,this.g={},this.h=0}Te.prototype.add=function(h,f,v,R,z){var j=h.toString();h=this.g[j],h||(h=this.g[j]=[],this.h++);var he=Ae(h,f,R,z);return-1<he?(f=h[he],v||(f.fa=!1)):(f=new qe(f,this.src,j,!!R,z),f.fa=v,h.push(f)),f};function Se(h,f){var v=f.type;if(v in h.g){var R=h.g[v],z=Array.prototype.indexOf.call(R,f,void 0),j;(j=0<=z)&&Array.prototype.splice.call(R,z,1),j&&(De(f),h.g[v].length==0&&(delete h.g[v],h.h--))}}function Ae(h,f,v,R){for(var z=0;z<h.length;++z){var j=h[z];if(!j.da&&j.listener==f&&j.capture==!!v&&j.ha==R)return z}return-1}var pe="closure_lm_"+(1e6*Math.random()|0),be={};function Xe(h,f,v,R,z){if(Array.isArray(f)){for(var j=0;j<f.length;j++)Xe(h,f[j],v,R,z);return null}return v=xe(v),h&&h[ge]?h.K(f,v,c(R)?!!R.capture:!1,z):g(h,f,v,!1,R,z)}function g(h,f,v,R,z,j){if(!f)throw Error("Invalid event type");var he=c(z)?!!z.capture:!!z,Ye=G(h);if(Ye||(h[pe]=Ye=new Te(h)),v=Ye.add(f,v,R,he,j),v.proxy)return v;if(R=S(),v.proxy=R,R.src=h,R.listener=v,h.addEventListener)oe||(z=he),z===void 0&&(z=!1),h.addEventListener(f.toString(),R,z);else if(h.attachEvent)h.attachEvent(B(f.toString()),R);else if(h.addListener&&h.removeListener)h.addListener(R);else throw Error("addEventListener and attachEvent are unavailable.");return v}function S(){function h(v){return f.call(h.src,h.listener,v)}const f=ae;return h}function N(h,f,v,R,z){if(Array.isArray(f))for(var j=0;j<f.length;j++)N(h,f[j],v,R,z);else R=c(R)?!!R.capture:!!R,v=xe(v),h&&h[ge]?(h=h.i,f=String(f).toString(),f in h.g&&(j=h.g[f],v=Ae(j,v,R,z),-1<v&&(De(j[v]),Array.prototype.splice.call(j,v,1),j.length==0&&(delete h.g[f],h.h--)))):h&&(h=G(h))&&(f=h.g[f.toString()],h=-1,f&&(h=Ae(f,v,R,z)),(v=-1<h?f[h]:null)&&X(v))}function X(h){if(typeof h!="number"&&h&&!h.da){var f=h.src;if(f&&f[ge])Se(f.i,h);else{var v=h.type,R=h.proxy;f.removeEventListener?f.removeEventListener(v,R,h.capture):f.detachEvent?f.detachEvent(B(v),R):f.addListener&&f.removeListener&&f.removeListener(R),(v=G(f))?(Se(v,h),v.h==0&&(v.src=null,f[pe]=null)):De(h)}}}function B(h){return h in be?be[h]:be[h]="on"+h}function ae(h,f){if(h.da)h=!0;else{f=new le(f,this);var v=h.listener,R=h.ha||h.src;h.fa&&X(h),h=v.call(R,f)}return h}function G(h){return h=h[pe],h instanceof Te?h:null}var de="__closure_events_fn_"+(1e9*Math.random()>>>0);function xe(h){return typeof h=="function"?h:(h[de]||(h[de]=function(f){return h.handleEvent(f)}),h[de])}function we(){ue.call(this),this.i=new Te(this),this.M=this,this.F=null}y(we,ue),we.prototype[ge]=!0,we.prototype.removeEventListener=function(h,f,v,R){N(this,h,f,v,R)};function fe(h,f){var v,R=h.F;if(R)for(v=[];R;R=R.F)v.push(R);if(h=h.M,R=f.type||f,typeof f=="string")f=new Y(f,h);else if(f instanceof Y)f.target=f.target||h;else{var z=f;f=new Y(R,h),M(f,z)}if(z=!0,v)for(var j=v.length-1;0<=j;j--){var he=f.g=v[j];z=Ne(he,R,!0,f)&&z}if(he=f.g=h,z=Ne(he,R,!0,f)&&z,z=Ne(he,R,!1,f)&&z,v)for(j=0;j<v.length;j++)he=f.g=v[j],z=Ne(he,R,!1,f)&&z}we.prototype.N=function(){if(we.aa.N.call(this),this.i){var h=this.i,f;for(f in h.g){for(var v=h.g[f],R=0;R<v.length;R++)De(v[R]);delete h.g[f],h.h--}}this.F=null},we.prototype.K=function(h,f,v,R){return this.i.add(String(h),f,!1,v,R)},we.prototype.L=function(h,f,v,R){return this.i.add(String(h),f,!0,v,R)};function Ne(h,f,v,R){if(f=h.i.g[String(f)],!f)return!0;f=f.concat();for(var z=!0,j=0;j<f.length;++j){var he=f[j];if(he&&!he.da&&he.capture==v){var Ye=he.listener,mt=he.ha||he.src;he.fa&&Se(h.i,he),z=Ye.call(mt,R)!==!1&&z}}return z&&!R.defaultPrevented}function b(h,f,v){if(typeof h=="function")v&&(h=p(h,v));else if(h&&typeof h.handleEvent=="function")h=p(h.handleEvent,h);else throw Error("Invalid listener argument");return 2147483647<Number(f)?-1:a.setTimeout(h,f||0)}function w(h){h.g=b(()=>{h.g=null,h.i&&(h.i=!1,w(h))},h.l);const f=h.h;h.h=null,h.m.apply(null,f)}class C extends ue{constructor(f,v){super(),this.m=f,this.l=v,this.h=null,this.i=!1,this.g=null}j(f){this.h=arguments,this.g?this.i=!0:w(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function A(h){ue.call(this),this.h=h,this.g={}}y(A,ue);var U=[];function ie(h){ee(h.g,function(f,v){this.g.hasOwnProperty(v)&&X(f)},h),h.g={}}A.prototype.N=function(){A.aa.N.call(this),ie(this)},A.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Ee=a.JSON.stringify,je=a.JSON.parse,Re=class{stringify(h){return a.JSON.stringify(h,void 0)}parse(h){return a.JSON.parse(h,void 0)}};function ct(){}ct.prototype.h=null;function $e(h){return h.h||(h.h=h.i())}function Mt(){}var kt={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function ni(){Y.call(this,"d")}y(ni,Y);function Xt(){Y.call(this,"c")}y(Xt,Y);var Yt={},dr=null;function Gi(){return dr=dr||new we}Yt.La="serverreachability";function pr(h){Y.call(this,Yt.La,h)}y(pr,Y);function Ei(h){const f=Gi();fe(f,new pr(f))}Yt.STAT_EVENT="statevent";function fr(h,f){Y.call(this,Yt.STAT_EVENT,h),this.stat=f}y(fr,Y);function gt(h){const f=Gi();fe(f,new fr(f,h))}Yt.Ma="timingevent";function gr(h,f){Y.call(this,Yt.Ma,h),this.size=f}y(gr,Y);function Si(h,f){if(typeof h!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){h()},f)}function Pi(){this.g=!0}Pi.prototype.xa=function(){this.g=!1};function ya(h,f,v,R,z,j){h.info(function(){if(h.g)if(j)for(var he="",Ye=j.split("&"),mt=0;mt<Ye.length;mt++){var We=Ye[mt].split("=");if(1<We.length){var _t=We[0];We=We[1];var Tt=_t.split("_");he=2<=Tt.length&&Tt[1]=="type"?he+(_t+"="+We+"&"):he+(_t+"=redacted&")}}else he=null;else he=j;return"XMLHTTP REQ ("+R+") [attempt "+z+"]: "+f+`
`+v+`
`+he})}function va(h,f,v,R,z,j,he){h.info(function(){return"XMLHTTP RESP ("+R+") [ attempt "+z+"]: "+f+`
`+v+`
`+j+" "+he})}function Ci(h,f,v,R){h.info(function(){return"XMLHTTP TEXT ("+f+"): "+mr(h,v)+(R?" "+R:"")})}function wa(h,f){h.info(function(){return"TIMEOUT: "+f})}Pi.prototype.info=function(){};function mr(h,f){if(!h.g)return f;if(!f)return null;try{var v=JSON.parse(f);if(v){for(h=0;h<v.length;h++)if(Array.isArray(v[h])){var R=v[h];if(!(2>R.length)){var z=R[1];if(Array.isArray(z)&&!(1>z.length)){var j=z[0];if(j!="noop"&&j!="stop"&&j!="close")for(var he=1;he<z.length;he++)z[he]=""}}}}return Ee(v)}catch{return f}}var Ri={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},xn={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},Zi;function Ai(){}y(Ai,ct),Ai.prototype.g=function(){return new XMLHttpRequest},Ai.prototype.i=function(){return{}},Zi=new Ai;function Ft(h,f,v,R){this.j=h,this.i=f,this.l=v,this.R=R||1,this.U=new A(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new En}function En(){this.i=null,this.g="",this.h=!1}var ze={},Ii={};function Sn(h,f,v){h.L=1,h.v=Tr(Kt(f)),h.m=v,h.P=!0,yr(h,null)}function yr(h,f){h.F=Date.now(),vr(h),h.A=Kt(h.v);var v=h.A,R=h.R;Array.isArray(R)||(R=[String(R)]),Ma(v.i,"t",R),h.C=0,v=h.j.J,h.h=new En,h.g=Ka(h.j,v?f:null,!h.m),0<h.O&&(h.M=new C(p(h.Y,h,h.g),h.O)),f=h.U,v=h.g,R=h.ca;var z="readystatechange";Array.isArray(z)||(z&&(U[0]=z.toString()),z=U);for(var j=0;j<z.length;j++){var he=Xe(v,z[j],R||f.handleEvent,!1,f.h||f);if(!he)break;f.g[he.key]=he}f=h.H?E(h.H):{},h.m?(h.u||(h.u="POST"),f["Content-Type"]="application/x-www-form-urlencoded",h.g.ea(h.A,h.u,h.m,f)):(h.u="GET",h.g.ea(h.A,h.u,null,f)),Ei(),ya(h.i,h.u,h.A,h.l,h.R,h.m)}Ft.prototype.ca=function(h){h=h.target;const f=this.M;f&&Qt(h)==3?f.j():this.Y(h)},Ft.prototype.Y=function(h){try{if(h==this.g)e:{const Tt=Qt(this.g);var f=this.g.Ba();const Ki=this.g.Z();if(!(3>Tt)&&(Tt!=3||this.g&&(this.h.h||this.g.oa()||za(this.g)))){this.J||Tt!=4||f==7||(f==8||0>=Ki?Ei(3):Ei(2)),Ms(this);var v=this.g.Z();this.X=v;t:if(ri(this)){var R=za(this.g);h="";var z=R.length,j=Qt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Di(this),Pn(this);var he="";break t}this.h.i=new a.TextDecoder}for(f=0;f<z;f++)this.h.h=!0,h+=this.h.i.decode(R[f],{stream:!(j&&f==z-1)});R.length=0,this.h.g+=h,this.C=0,he=this.h.g}else he=this.g.oa();if(this.o=v==200,va(this.i,this.u,this.A,this.l,this.R,Tt,v),this.o){if(this.T&&!this.K){t:{if(this.g){var Ye,mt=this.g;if((Ye=mt.g?mt.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!V(Ye)){var We=Ye;break t}}We=null}if(v=We)Ci(this.i,this.l,v,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,ks(this,v);else{this.o=!1,this.s=3,gt(12),Di(this),Pn(this);break e}}if(this.P){v=!0;let Ot;for(;!this.J&&this.C<he.length;)if(Ot=Pu(this,he),Ot==Ii){Tt==4&&(this.s=4,gt(14),v=!1),Ci(this.i,this.l,null,"[Incomplete Response]");break}else if(Ot==ze){this.s=4,gt(15),Ci(this.i,this.l,he,"[Invalid Chunk]"),v=!1;break}else Ci(this.i,this.l,Ot,null),ks(this,Ot);if(ri(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Tt!=4||he.length!=0||this.h.h||(this.s=1,gt(16),v=!1),this.o=this.o&&v,!v)Ci(this.i,this.l,he,"[Invalid Chunked Response]"),Di(this),Pn(this);else if(0<he.length&&!this.W){this.W=!0;var _t=this.j;_t.g==this&&_t.ba&&!_t.M&&(_t.j.info("Great, no buffering proxy detected. Bytes received: "+he.length),zs(_t),_t.M=!0,gt(11))}}else Ci(this.i,this.l,he,null),ks(this,he);Tt==4&&Di(this),this.o&&!this.J&&(Tt==4?Ga(this.j,this):(this.o=!1,vr(this)))}else ju(this.g),v==400&&0<he.indexOf("Unknown SID")?(this.s=3,gt(12)):(this.s=0,gt(13)),Di(this),Pn(this)}}}catch{}finally{}};function ri(h){return h.g?h.u=="GET"&&h.L!=2&&h.j.Ca:!1}function Pu(h,f){var v=h.C,R=f.indexOf(`
`,v);return R==-1?Ii:(v=Number(f.substring(v,R)),isNaN(v)?ze:(R+=1,R+v>f.length?Ii:(f=f.slice(R,R+v),h.C=R+v,f)))}Ft.prototype.cancel=function(){this.J=!0,Di(this)};function vr(h){h.S=Date.now()+h.I,_a(h,h.I)}function _a(h,f){if(h.B!=null)throw Error("WatchDog timer not null");h.B=Si(p(h.ba,h),f)}function Ms(h){h.B&&(a.clearTimeout(h.B),h.B=null)}Ft.prototype.ba=function(){this.B=null;const h=Date.now();0<=h-this.S?(wa(this.i,this.A),this.L!=2&&(Ei(),gt(17)),Di(this),this.s=2,Pn(this)):_a(this,this.S-h)};function Pn(h){h.j.G==0||h.J||Ga(h.j,h)}function Di(h){Ms(h);var f=h.M;f&&typeof f.ma=="function"&&f.ma(),h.M=null,ie(h.U),h.g&&(f=h.g,h.g=null,f.abort(),f.ma())}function ks(h,f){try{var v=h.j;if(v.G!=0&&(v.g==h||Fs(v.h,h))){if(!h.K&&Fs(v.h,h)&&v.G==3){try{var R=v.Da.g.parse(f)}catch{R=null}if(Array.isArray(R)&&R.length==3){var z=R;if(z[0]==0){e:if(!v.u){if(v.g)if(v.g.F+3e3<h.F)Cr(v),Sr(v);else break e;Ns(v),gt(18)}}else v.za=z[1],0<v.za-v.T&&37500>z[2]&&v.F&&v.v==0&&!v.C&&(v.C=Si(p(v.Za,v),6e3));if(1>=xa(v.h)&&v.ca){try{v.ca()}catch{}v.ca=void 0}}else ki(v,11)}else if((h.K||v.g==h)&&Cr(v),!V(f))for(z=v.Da.g.parse(f),f=0;f<z.length;f++){let We=z[f];if(v.T=We[0],We=We[1],v.G==2)if(We[0]=="c"){v.K=We[1],v.ia=We[2];const _t=We[3];_t!=null&&(v.la=_t,v.j.info("VER="+v.la));const Tt=We[4];Tt!=null&&(v.Aa=Tt,v.j.info("SVER="+v.Aa));const Ki=We[5];Ki!=null&&typeof Ki=="number"&&0<Ki&&(R=1.5*Ki,v.L=R,v.j.info("backChannelRequestTimeoutMs_="+R)),R=v;const Ot=h.g;if(Ot){const Ar=Ot.g?Ot.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Ar){var j=R.h;j.g||Ar.indexOf("spdy")==-1&&Ar.indexOf("quic")==-1&&Ar.indexOf("h2")==-1||(j.j=j.l,j.g=new Set,j.h&&(Os(j,j.h),j.h=null))}if(R.D){const Bs=Ot.g?Ot.g.getResponseHeader("X-HTTP-Session-Id"):null;Bs&&(R.ya=Bs,Qe(R.I,R.D,Bs))}}v.G=3,v.l&&v.l.ua(),v.ba&&(v.R=Date.now()-h.F,v.j.info("Handshake RTT: "+v.R+"ms")),R=v;var he=h;if(R.qa=Ya(R,R.J?R.ia:null,R.W),he.K){Ea(R.h,he);var Ye=he,mt=R.L;mt&&(Ye.I=mt),Ye.B&&(Ms(Ye),vr(Ye)),R.g=he}else Wa(R);0<v.i.length&&Pr(v)}else We[0]!="stop"&&We[0]!="close"||ki(v,7);else v.G==3&&(We[0]=="stop"||We[0]=="close"?We[0]=="stop"?ki(v,7):Ls(v):We[0]!="noop"&&v.l&&v.l.ta(We),v.v=0)}}Ei(4)}catch{}}var Cu=class{constructor(h,f){this.g=h,this.map=f}};function Ta(h){this.l=h||10,a.PerformanceNavigationTiming?(h=a.performance.getEntriesByType("navigation"),h=0<h.length&&(h[0].nextHopProtocol=="hq"||h[0].nextHopProtocol=="h2")):h=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=h?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function ba(h){return h.h?!0:h.g?h.g.size>=h.j:!1}function xa(h){return h.h?1:h.g?h.g.size:0}function Fs(h,f){return h.h?h.h==f:h.g?h.g.has(f):!1}function Os(h,f){h.g?h.g.add(f):h.h=f}function Ea(h,f){h.h&&h.h==f?h.h=null:h.g&&h.g.has(f)&&h.g.delete(f)}Ta.prototype.cancel=function(){if(this.i=Sa(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const h of this.g.values())h.cancel();this.g.clear()}};function Sa(h){if(h.h!=null)return h.i.concat(h.h.D);if(h.g!=null&&h.g.size!==0){let f=h.i;for(const v of h.g.values())f=f.concat(v.D);return f}return _(h.i)}function Ru(h){if(h.V&&typeof h.V=="function")return h.V();if(typeof Map<"u"&&h instanceof Map||typeof Set<"u"&&h instanceof Set)return Array.from(h.values());if(typeof h=="string")return h.split("");if(l(h)){for(var f=[],v=h.length,R=0;R<v;R++)f.push(h[R]);return f}f=[],v=0;for(R in h)f[v++]=h[R];return f}function Au(h){if(h.na&&typeof h.na=="function")return h.na();if(!h.V||typeof h.V!="function"){if(typeof Map<"u"&&h instanceof Map)return Array.from(h.keys());if(!(typeof Set<"u"&&h instanceof Set)){if(l(h)||typeof h=="string"){var f=[];h=h.length;for(var v=0;v<h;v++)f.push(v);return f}f=[],v=0;for(const R in h)f[v++]=R;return f}}}function Pa(h,f){if(h.forEach&&typeof h.forEach=="function")h.forEach(f,void 0);else if(l(h)||typeof h=="string")Array.prototype.forEach.call(h,f,void 0);else for(var v=Au(h),R=Ru(h),z=R.length,j=0;j<z;j++)f.call(void 0,R[j],v&&v[j],h)}var Ca=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Iu(h,f){if(h){h=h.split("&");for(var v=0;v<h.length;v++){var R=h[v].indexOf("="),z=null;if(0<=R){var j=h[v].substring(0,R);z=h[v].substring(R+1)}else j=h[v];f(j,z?decodeURIComponent(z.replace(/\+/g," ")):"")}}}function Mi(h){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,h instanceof Mi){this.h=h.h,wr(this,h.j),this.o=h.o,this.g=h.g,_r(this,h.s),this.l=h.l;var f=h.i,v=new An;v.i=f.i,f.g&&(v.g=new Map(f.g),v.h=f.h),Ra(this,v),this.m=h.m}else h&&(f=String(h).match(Ca))?(this.h=!1,wr(this,f[1]||"",!0),this.o=Cn(f[2]||""),this.g=Cn(f[3]||"",!0),_r(this,f[4]),this.l=Cn(f[5]||"",!0),Ra(this,f[6]||"",!0),this.m=Cn(f[7]||"")):(this.h=!1,this.i=new An(null,this.h))}Mi.prototype.toString=function(){var h=[],f=this.j;f&&h.push(Rn(f,Aa,!0),":");var v=this.g;return(v||f=="file")&&(h.push("//"),(f=this.o)&&h.push(Rn(f,Aa,!0),"@"),h.push(encodeURIComponent(String(v)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),v=this.s,v!=null&&h.push(":",String(v))),(v=this.l)&&(this.g&&v.charAt(0)!="/"&&h.push("/"),h.push(Rn(v,v.charAt(0)=="/"?ku:Mu,!0))),(v=this.i.toString())&&h.push("?",v),(v=this.m)&&h.push("#",Rn(v,Ou)),h.join("")};function Kt(h){return new Mi(h)}function wr(h,f,v){h.j=v?Cn(f,!0):f,h.j&&(h.j=h.j.replace(/:$/,""))}function _r(h,f){if(f){if(f=Number(f),isNaN(f)||0>f)throw Error("Bad port number "+f);h.s=f}else h.s=null}function Ra(h,f,v){f instanceof An?(h.i=f,Vu(h.i,h.h)):(v||(f=Rn(f,Fu)),h.i=new An(f,h.h))}function Qe(h,f,v){h.i.set(f,v)}function Tr(h){return Qe(h,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),h}function Cn(h,f){return h?f?decodeURI(h.replace(/%25/g,"%2525")):decodeURIComponent(h):""}function Rn(h,f,v){return typeof h=="string"?(h=encodeURI(h).replace(f,Du),v&&(h=h.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),h):null}function Du(h){return h=h.charCodeAt(0),"%"+(h>>4&15).toString(16)+(h&15).toString(16)}var Aa=/[#\/\?@]/g,Mu=/[#\?:]/g,ku=/[#\?]/g,Fu=/[#\?@]/g,Ou=/#/g;function An(h,f){this.h=this.g=null,this.i=h||null,this.j=!!f}function si(h){h.g||(h.g=new Map,h.h=0,h.i&&Iu(h.i,function(f,v){h.add(decodeURIComponent(f.replace(/\+/g," ")),v)}))}s=An.prototype,s.add=function(h,f){si(this),this.i=null,h=Xi(this,h);var v=this.g.get(h);return v||this.g.set(h,v=[]),v.push(f),this.h+=1,this};function Ia(h,f){si(h),f=Xi(h,f),h.g.has(f)&&(h.i=null,h.h-=h.g.get(f).length,h.g.delete(f))}function Da(h,f){return si(h),f=Xi(h,f),h.g.has(f)}s.forEach=function(h,f){si(this),this.g.forEach(function(v,R){v.forEach(function(z){h.call(f,z,R,this)},this)},this)},s.na=function(){si(this);const h=Array.from(this.g.values()),f=Array.from(this.g.keys()),v=[];for(let R=0;R<f.length;R++){const z=h[R];for(let j=0;j<z.length;j++)v.push(f[R])}return v},s.V=function(h){si(this);let f=[];if(typeof h=="string")Da(this,h)&&(f=f.concat(this.g.get(Xi(this,h))));else{h=Array.from(this.g.values());for(let v=0;v<h.length;v++)f=f.concat(h[v])}return f},s.set=function(h,f){return si(this),this.i=null,h=Xi(this,h),Da(this,h)&&(this.h-=this.g.get(h).length),this.g.set(h,[f]),this.h+=1,this},s.get=function(h,f){return h?(h=this.V(h),0<h.length?String(h[0]):f):f};function Ma(h,f,v){Ia(h,f),0<v.length&&(h.i=null,h.g.set(Xi(h,f),_(v)),h.h+=v.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const h=[],f=Array.from(this.g.keys());for(var v=0;v<f.length;v++){var R=f[v];const j=encodeURIComponent(String(R)),he=this.V(R);for(R=0;R<he.length;R++){var z=j;he[R]!==""&&(z+="="+encodeURIComponent(String(he[R]))),h.push(z)}}return this.i=h.join("&")};function Xi(h,f){return f=String(f),h.j&&(f=f.toLowerCase()),f}function Vu(h,f){f&&!h.j&&(si(h),h.i=null,h.g.forEach(function(v,R){var z=R.toLowerCase();R!=z&&(Ia(this,R),Ma(this,z,v))},h)),h.j=f}function Lu(h,f){const v=new Pi;if(a.Image){const R=new Image;R.onload=m(oi,v,"TestLoadImage: loaded",!0,f,R),R.onerror=m(oi,v,"TestLoadImage: error",!1,f,R),R.onabort=m(oi,v,"TestLoadImage: abort",!1,f,R),R.ontimeout=m(oi,v,"TestLoadImage: timeout",!1,f,R),a.setTimeout(function(){R.ontimeout&&R.ontimeout()},1e4),R.src=h}else f(!1)}function Nu(h,f){const v=new Pi,R=new AbortController,z=setTimeout(()=>{R.abort(),oi(v,"TestPingServer: timeout",!1,f)},1e4);fetch(h,{signal:R.signal}).then(j=>{clearTimeout(z),j.ok?oi(v,"TestPingServer: ok",!0,f):oi(v,"TestPingServer: server error",!1,f)}).catch(()=>{clearTimeout(z),oi(v,"TestPingServer: error",!1,f)})}function oi(h,f,v,R,z){try{z&&(z.onload=null,z.onerror=null,z.onabort=null,z.ontimeout=null),R(v)}catch{}}function zu(){this.g=new Re}function Bu(h,f,v){const R=v||"";try{Pa(h,function(z,j){let he=z;c(z)&&(he=Ee(z)),f.push(R+j+"="+encodeURIComponent(he))})}catch(z){throw f.push(R+"type="+encodeURIComponent("_badmap")),z}}function br(h){this.l=h.Ub||null,this.j=h.eb||!1}y(br,ct),br.prototype.g=function(){return new xr(this.l,this.j)},br.prototype.i=function(h){return function(){return h}}({});function xr(h,f){we.call(this),this.D=h,this.o=f,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}y(xr,we),s=xr.prototype,s.open=function(h,f){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=h,this.A=f,this.readyState=1,Dn(this)},s.send=function(h){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const f={headers:this.u,method:this.B,credentials:this.m,cache:void 0};h&&(f.body=h),(this.D||a).fetch(new Request(this.A,f)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,In(this)),this.readyState=0},s.Sa=function(h){if(this.g&&(this.l=h,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=h.headers,this.readyState=2,Dn(this)),this.g&&(this.readyState=3,Dn(this),this.g)))if(this.responseType==="arraybuffer")h.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in h){if(this.j=h.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;ka(this)}else h.text().then(this.Ra.bind(this),this.ga.bind(this))};function ka(h){h.j.read().then(h.Pa.bind(h)).catch(h.ga.bind(h))}s.Pa=function(h){if(this.g){if(this.o&&h.value)this.response.push(h.value);else if(!this.o){var f=h.value?h.value:new Uint8Array(0);(f=this.v.decode(f,{stream:!h.done}))&&(this.response=this.responseText+=f)}h.done?In(this):Dn(this),this.readyState==3&&ka(this)}},s.Ra=function(h){this.g&&(this.response=this.responseText=h,In(this))},s.Qa=function(h){this.g&&(this.response=h,In(this))},s.ga=function(){this.g&&In(this)};function In(h){h.readyState=4,h.l=null,h.j=null,h.v=null,Dn(h)}s.setRequestHeader=function(h,f){this.u.append(h,f)},s.getResponseHeader=function(h){return this.h&&this.h.get(h.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const h=[],f=this.h.entries();for(var v=f.next();!v.done;)v=v.value,h.push(v[0]+": "+v[1]),v=f.next();return h.join(`\r
`)};function Dn(h){h.onreadystatechange&&h.onreadystatechange.call(h)}Object.defineProperty(xr.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(h){this.m=h?"include":"same-origin"}});function Fa(h){let f="";return ee(h,function(v,R){f+=R,f+=":",f+=v,f+=`\r
`}),f}function Vs(h,f,v){e:{for(R in v){var R=!1;break e}R=!0}R||(v=Fa(v),typeof h=="string"?v!=null&&encodeURIComponent(String(v)):Qe(h,f,v))}function tt(h){we.call(this),this.headers=new Map,this.o=h||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}y(tt,we);var Hu=/^https?$/i,Uu=["POST","PUT"];s=tt.prototype,s.Ha=function(h){this.J=h},s.ea=function(h,f,v,R){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+h);f=f?f.toUpperCase():"GET",this.D=h,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Zi.g(),this.v=this.o?$e(this.o):$e(Zi),this.g.onreadystatechange=p(this.Ea,this);try{this.B=!0,this.g.open(f,String(h),!0),this.B=!1}catch(j){Oa(this,j);return}if(h=v||"",v=new Map(this.headers),R)if(Object.getPrototypeOf(R)===Object.prototype)for(var z in R)v.set(z,R[z]);else if(typeof R.keys=="function"&&typeof R.get=="function")for(const j of R.keys())v.set(j,R.get(j));else throw Error("Unknown input type for opt_headers: "+String(R));R=Array.from(v.keys()).find(j=>j.toLowerCase()=="content-type"),z=a.FormData&&h instanceof a.FormData,!(0<=Array.prototype.indexOf.call(Uu,f,void 0))||R||z||v.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[j,he]of v)this.g.setRequestHeader(j,he);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Na(this),this.u=!0,this.g.send(h),this.u=!1}catch(j){Oa(this,j)}};function Oa(h,f){h.h=!1,h.g&&(h.j=!0,h.g.abort(),h.j=!1),h.l=f,h.m=5,Va(h),Er(h)}function Va(h){h.A||(h.A=!0,fe(h,"complete"),fe(h,"error"))}s.abort=function(h){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=h||7,fe(this,"complete"),fe(this,"abort"),Er(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Er(this,!0)),tt.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?La(this):this.bb())},s.bb=function(){La(this)};function La(h){if(h.h&&typeof o<"u"&&(!h.v[1]||Qt(h)!=4||h.Z()!=2)){if(h.u&&Qt(h)==4)b(h.Ea,0,h);else if(fe(h,"readystatechange"),Qt(h)==4){h.h=!1;try{const he=h.Z();e:switch(he){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var f=!0;break e;default:f=!1}var v;if(!(v=f)){var R;if(R=he===0){var z=String(h.D).match(Ca)[1]||null;!z&&a.self&&a.self.location&&(z=a.self.location.protocol.slice(0,-1)),R=!Hu.test(z?z.toLowerCase():"")}v=R}if(v)fe(h,"complete"),fe(h,"success");else{h.m=6;try{var j=2<Qt(h)?h.g.statusText:""}catch{j=""}h.l=j+" ["+h.Z()+"]",Va(h)}}finally{Er(h)}}}}function Er(h,f){if(h.g){Na(h);const v=h.g,R=h.v[0]?()=>{}:null;h.g=null,h.v=null,f||fe(h,"ready");try{v.onreadystatechange=R}catch{}}}function Na(h){h.I&&(a.clearTimeout(h.I),h.I=null)}s.isActive=function(){return!!this.g};function Qt(h){return h.g?h.g.readyState:0}s.Z=function(){try{return 2<Qt(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(h){if(this.g){var f=this.g.responseText;return h&&f.indexOf(h)==0&&(f=f.substring(h.length)),je(f)}};function za(h){try{if(!h.g)return null;if("response"in h.g)return h.g.response;switch(h.H){case"":case"text":return h.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in h.g)return h.g.mozResponseArrayBuffer}return null}catch{return null}}function ju(h){const f={};h=(h.g&&2<=Qt(h)&&h.g.getAllResponseHeaders()||"").split(`\r
`);for(let R=0;R<h.length;R++){if(V(h[R]))continue;var v=k(h[R]);const z=v[0];if(v=v[1],typeof v!="string")continue;v=v.trim();const j=f[z]||[];f[z]=j,j.push(v)}F(f,function(R){return R.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Mn(h,f,v){return v&&v.internalChannelParams&&v.internalChannelParams[h]||f}function Ba(h){this.Aa=0,this.i=[],this.j=new Pi,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Mn("failFast",!1,h),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Mn("baseRetryDelayMs",5e3,h),this.cb=Mn("retryDelaySeedMs",1e4,h),this.Wa=Mn("forwardChannelMaxRetries",2,h),this.wa=Mn("forwardChannelRequestTimeoutMs",2e4,h),this.pa=h&&h.xmlHttpFactory||void 0,this.Xa=h&&h.Tb||void 0,this.Ca=h&&h.useFetchStreams||!1,this.L=void 0,this.J=h&&h.supportsCrossDomainXhr||!1,this.K="",this.h=new Ta(h&&h.concurrentRequestLimit),this.Da=new zu,this.P=h&&h.fastHandshake||!1,this.O=h&&h.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=h&&h.Rb||!1,h&&h.xa&&this.j.xa(),h&&h.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&h&&h.detectBufferingProxy||!1,this.ja=void 0,h&&h.longPollingTimeout&&0<h.longPollingTimeout&&(this.ja=h.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=Ba.prototype,s.la=8,s.G=1,s.connect=function(h,f,v,R){gt(0),this.W=h,this.H=f||{},v&&R!==void 0&&(this.H.OSID=v,this.H.OAID=R),this.F=this.X,this.I=Ya(this,null,this.W),Pr(this)};function Ls(h){if(Ha(h),h.G==3){var f=h.U++,v=Kt(h.I);if(Qe(v,"SID",h.K),Qe(v,"RID",f),Qe(v,"TYPE","terminate"),kn(h,v),f=new Ft(h,h.j,f),f.L=2,f.v=Tr(Kt(v)),v=!1,a.navigator&&a.navigator.sendBeacon)try{v=a.navigator.sendBeacon(f.v.toString(),"")}catch{}!v&&a.Image&&(new Image().src=f.v,v=!0),v||(f.g=Ka(f.j,null),f.g.ea(f.v)),f.F=Date.now(),vr(f)}Xa(h)}function Sr(h){h.g&&(zs(h),h.g.cancel(),h.g=null)}function Ha(h){Sr(h),h.u&&(a.clearTimeout(h.u),h.u=null),Cr(h),h.h.cancel(),h.s&&(typeof h.s=="number"&&a.clearTimeout(h.s),h.s=null)}function Pr(h){if(!ba(h.h)&&!h.s){h.s=!0;var f=h.Ga;te||se(),$||(te(),$=!0),H.add(f,h),h.B=0}}function Wu(h,f){return xa(h.h)>=h.h.j-(h.s?1:0)?!1:h.s?(h.i=f.D.concat(h.i),!0):h.G==1||h.G==2||h.B>=(h.Va?0:h.Wa)?!1:(h.s=Si(p(h.Ga,h,f),Za(h,h.B)),h.B++,!0)}s.Ga=function(h){if(this.s)if(this.s=null,this.G==1){if(!h){this.U=Math.floor(1e5*Math.random()),h=this.U++;const z=new Ft(this,this.j,h);let j=this.o;if(this.S&&(j?(j=E(j),M(j,this.S)):j=this.S),this.m!==null||this.O||(z.H=j,j=null),this.P)e:{for(var f=0,v=0;v<this.i.length;v++){t:{var R=this.i[v];if("__data__"in R.map&&(R=R.map.__data__,typeof R=="string")){R=R.length;break t}R=void 0}if(R===void 0)break;if(f+=R,4096<f){f=v;break e}if(f===4096||v===this.i.length-1){f=v+1;break e}}f=1e3}else f=1e3;f=ja(this,z,f),v=Kt(this.I),Qe(v,"RID",h),Qe(v,"CVER",22),this.D&&Qe(v,"X-HTTP-Session-Id",this.D),kn(this,v),j&&(this.O?f="headers="+encodeURIComponent(String(Fa(j)))+"&"+f:this.m&&Vs(v,this.m,j)),Os(this.h,z),this.Ua&&Qe(v,"TYPE","init"),this.P?(Qe(v,"$req",f),Qe(v,"SID","null"),z.T=!0,Sn(z,v,null)):Sn(z,v,f),this.G=2}}else this.G==3&&(h?Ua(this,h):this.i.length==0||ba(this.h)||Ua(this))};function Ua(h,f){var v;f?v=f.l:v=h.U++;const R=Kt(h.I);Qe(R,"SID",h.K),Qe(R,"RID",v),Qe(R,"AID",h.T),kn(h,R),h.m&&h.o&&Vs(R,h.m,h.o),v=new Ft(h,h.j,v,h.B+1),h.m===null&&(v.H=h.o),f&&(h.i=f.D.concat(h.i)),f=ja(h,v,1e3),v.I=Math.round(.5*h.wa)+Math.round(.5*h.wa*Math.random()),Os(h.h,v),Sn(v,R,f)}function kn(h,f){h.H&&ee(h.H,function(v,R){Qe(f,R,v)}),h.l&&Pa({},function(v,R){Qe(f,R,v)})}function ja(h,f,v){v=Math.min(h.i.length,v);var R=h.l?p(h.l.Na,h.l,h):null;e:{var z=h.i;let j=-1;for(;;){const he=["count="+v];j==-1?0<v?(j=z[0].g,he.push("ofs="+j)):j=0:he.push("ofs="+j);let Ye=!0;for(let mt=0;mt<v;mt++){let We=z[mt].g;const _t=z[mt].map;if(We-=j,0>We)j=Math.max(0,z[mt].g-100),Ye=!1;else try{Bu(_t,he,"req"+We+"_")}catch{R&&R(_t)}}if(Ye){R=he.join("&");break e}}}return h=h.i.splice(0,v),f.D=h,R}function Wa(h){if(!h.g&&!h.u){h.Y=1;var f=h.Fa;te||se(),$||(te(),$=!0),H.add(f,h),h.v=0}}function Ns(h){return h.g||h.u||3<=h.v?!1:(h.Y++,h.u=Si(p(h.Fa,h),Za(h,h.v)),h.v++,!0)}s.Fa=function(){if(this.u=null,qa(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var h=2*this.R;this.j.info("BP detection timer enabled: "+h),this.A=Si(p(this.ab,this),h)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,gt(10),Sr(this),qa(this))};function zs(h){h.A!=null&&(a.clearTimeout(h.A),h.A=null)}function qa(h){h.g=new Ft(h,h.j,"rpc",h.Y),h.m===null&&(h.g.H=h.o),h.g.O=0;var f=Kt(h.qa);Qe(f,"RID","rpc"),Qe(f,"SID",h.K),Qe(f,"AID",h.T),Qe(f,"CI",h.F?"0":"1"),!h.F&&h.ja&&Qe(f,"TO",h.ja),Qe(f,"TYPE","xmlhttp"),kn(h,f),h.m&&h.o&&Vs(f,h.m,h.o),h.L&&(h.g.I=h.L);var v=h.g;h=h.ia,v.L=1,v.v=Tr(Kt(f)),v.m=null,v.P=!0,yr(v,h)}s.Za=function(){this.C!=null&&(this.C=null,Sr(this),Ns(this),gt(19))};function Cr(h){h.C!=null&&(a.clearTimeout(h.C),h.C=null)}function Ga(h,f){var v=null;if(h.g==f){Cr(h),zs(h),h.g=null;var R=2}else if(Fs(h.h,f))v=f.D,Ea(h.h,f),R=1;else return;if(h.G!=0){if(f.o)if(R==1){v=f.m?f.m.length:0,f=Date.now()-f.F;var z=h.B;R=Gi(),fe(R,new gr(R,v)),Pr(h)}else Wa(h);else if(z=f.s,z==3||z==0&&0<f.X||!(R==1&&Wu(h,f)||R==2&&Ns(h)))switch(v&&0<v.length&&(f=h.h,f.i=f.i.concat(v)),z){case 1:ki(h,5);break;case 4:ki(h,10);break;case 3:ki(h,6);break;default:ki(h,2)}}}function Za(h,f){let v=h.Ta+Math.floor(Math.random()*h.cb);return h.isActive()||(v*=2),v*f}function ki(h,f){if(h.j.info("Error code "+f),f==2){var v=p(h.fb,h),R=h.Xa;const z=!R;R=new Mi(R||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||wr(R,"https"),Tr(R),z?Lu(R.toString(),v):Nu(R.toString(),v)}else gt(2);h.G=0,h.l&&h.l.sa(f),Xa(h),Ha(h)}s.fb=function(h){h?(this.j.info("Successfully pinged google.com"),gt(2)):(this.j.info("Failed to ping google.com"),gt(1))};function Xa(h){if(h.G=0,h.ka=[],h.l){const f=Sa(h.h);(f.length!=0||h.i.length!=0)&&(T(h.ka,f),T(h.ka,h.i),h.h.i.length=0,_(h.i),h.i.length=0),h.l.ra()}}function Ya(h,f,v){var R=v instanceof Mi?Kt(v):new Mi(v);if(R.g!="")f&&(R.g=f+"."+R.g),_r(R,R.s);else{var z=a.location;R=z.protocol,f=f?f+"."+z.hostname:z.hostname,z=+z.port;var j=new Mi(null);R&&wr(j,R),f&&(j.g=f),z&&_r(j,z),v&&(j.l=v),R=j}return v=h.D,f=h.ya,v&&f&&Qe(R,v,f),Qe(R,"VER",h.la),kn(h,R),R}function Ka(h,f,v){if(f&&!h.J)throw Error("Can't create secondary domain capable XhrIo object.");return f=h.Ca&&!h.pa?new tt(new br({eb:v})):new tt(h.pa),f.Ha(h.J),f}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function Qa(){}s=Qa.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function Rr(){}Rr.prototype.g=function(h,f){return new Rt(h,f)};function Rt(h,f){we.call(this),this.g=new Ba(f),this.l=h,this.h=f&&f.messageUrlParams||null,h=f&&f.messageHeaders||null,f&&f.clientProtocolHeaderRequired&&(h?h["X-Client-Protocol"]="webchannel":h={"X-Client-Protocol":"webchannel"}),this.g.o=h,h=f&&f.initMessageHeaders||null,f&&f.messageContentType&&(h?h["X-WebChannel-Content-Type"]=f.messageContentType:h={"X-WebChannel-Content-Type":f.messageContentType}),f&&f.va&&(h?h["X-WebChannel-Client-Profile"]=f.va:h={"X-WebChannel-Client-Profile":f.va}),this.g.S=h,(h=f&&f.Sb)&&!V(h)&&(this.g.m=h),this.v=f&&f.supportsCrossDomainXhr||!1,this.u=f&&f.sendRawJson||!1,(f=f&&f.httpSessionIdParam)&&!V(f)&&(this.g.D=f,h=this.h,h!==null&&f in h&&(h=this.h,f in h&&delete h[f])),this.j=new Yi(this)}y(Rt,we),Rt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Rt.prototype.close=function(){Ls(this.g)},Rt.prototype.o=function(h){var f=this.g;if(typeof h=="string"){var v={};v.__data__=h,h=v}else this.u&&(v={},v.__data__=Ee(h),h=v);f.i.push(new Cu(f.Ya++,h)),f.G==3&&Pr(f)},Rt.prototype.N=function(){this.g.l=null,delete this.j,Ls(this.g),delete this.g,Rt.aa.N.call(this)};function Ja(h){ni.call(this),h.__headers__&&(this.headers=h.__headers__,this.statusCode=h.__status__,delete h.__headers__,delete h.__status__);var f=h.__sm__;if(f){e:{for(const v in f){h=v;break e}h=void 0}(this.i=h)&&(h=this.i,f=f!==null&&h in f?f[h]:void 0),this.data=f}else this.data=h}y(Ja,ni);function $a(){Xt.call(this),this.status=1}y($a,Xt);function Yi(h){this.g=h}y(Yi,Qa),Yi.prototype.ua=function(){fe(this.g,"a")},Yi.prototype.ta=function(h){fe(this.g,new Ja(h))},Yi.prototype.sa=function(h){fe(this.g,new $a)},Yi.prototype.ra=function(){fe(this.g,"b")},Rr.prototype.createWebChannel=Rr.prototype.g,Rt.prototype.send=Rt.prototype.o,Rt.prototype.open=Rt.prototype.m,Rt.prototype.close=Rt.prototype.close,ih=function(){return new Rr},th=function(){return Gi()},eh=Yt,ho={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ri.NO_ERROR=0,Ri.TIMEOUT=8,Ri.HTTP_ERROR=6,Hr=Ri,xn.COMPLETE="complete",$c=xn,Mt.EventType=kt,kt.OPEN="a",kt.CLOSE="b",kt.ERROR="c",kt.MESSAGE="d",we.prototype.listen=we.prototype.K,On=Mt,tt.prototype.listenOnce=tt.prototype.L,tt.prototype.getLastError=tt.prototype.Ka,tt.prototype.getLastErrorCode=tt.prototype.Ba,tt.prototype.getStatus=tt.prototype.Z,tt.prototype.getResponseJson=tt.prototype.Oa,tt.prototype.getResponseText=tt.prototype.oa,tt.prototype.send=tt.prototype.ea,tt.prototype.setWithCredentials=tt.prototype.Ha,Jc=tt}).apply(typeof Mr<"u"?Mr:typeof self<"u"?self:typeof window<"u"?window:{});const bl="@firebase/firestore",xl="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xt{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}xt.UNAUTHENTICATED=new xt(null),xt.GOOGLE_CREDENTIALS=new xt("google-credentials-uid"),xt.FIRST_PARTY=new xt("first-party-uid"),xt.MOCK_USER=new xt("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let vn="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hi=new qc("@firebase/firestore");function en(){return Hi.logLevel}function ve(s,...t){if(Hi.logLevel<=Ue.DEBUG){const e=t.map(Vo);Hi.debug(`Firestore (${vn}): ${s}`,...e)}}function ei(s,...t){if(Hi.logLevel<=Ue.ERROR){const e=t.map(Vo);Hi.error(`Firestore (${vn}): ${s}`,...e)}}function fi(s,...t){if(Hi.logLevel<=Ue.WARN){const e=t.map(Vo);Hi.warn(`Firestore (${vn}): ${s}`,...e)}}function Vo(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ie(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,nh(s,i,e)}function nh(s,t,e){let i=`FIRESTORE (${vn}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw ei(i),new Error(i)}function Ze(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||nh(t,n,i)}function Fe(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const K={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class ye extends yn{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zi{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rh{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Sg{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(xt.UNAUTHENTICATED))}shutdown(){}}class Pg{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class Cg{constructor(t){this.t=t,this.currentUser=xt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){Ze(this.o===void 0,42304);let i=this.i;const n=l=>this.i!==i?(i=this.i,e(l)):Promise.resolve();let r=new zi;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new zi,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const l=r;t.enqueueRetryable(async()=>{await l.promise,await n(this.currentUser)})},a=l=>{ve("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=l,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(l=>a(l)),setTimeout(()=>{if(!this.auth){const l=this.t.getImmediate({optional:!0});l?a(l):(ve("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new zi)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(ve("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(Ze(typeof i.accessToken=="string",31837,{l:i}),new rh(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return Ze(t===null||typeof t=="string",2055,{h:t}),new xt(t)}}class Rg{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=xt.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Ag{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new Rg(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(xt.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class El{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Ig{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,hg(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){Ze(this.o===void 0,3512);const i=r=>{r.error!=null&&ve("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,ve("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{ve("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):ve("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new El(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(Ze(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new El(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Dg(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sh(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lo{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=Dg(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function Ve(s,t){return s<t?-1:s>t?1:0}function uo(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return Ve(i,n);{const r=sh(),o=Mg(r.encode(Sl(s,e)),r.encode(Sl(t,e)));return o!==0?o:Ve(i,n)}}e+=i>65535?2:1}return Ve(s.length,t.length)}function Sl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function Mg(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return Ve(s[e],t[e]);return Ve(s.length,t.length)}function un(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pl="__name__";class zt{constructor(t,e,i){e===void 0?e=0:e>t.length&&Ie(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&Ie(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return zt.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof zt?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=zt.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return Ve(t.length,e.length)}static compareSegments(t,e){const i=zt.isNumericId(t),n=zt.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?zt.extractNumericId(t).compare(zt.extractNumericId(e)):uo(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return ui.fromString(t.substring(4,t.length-2))}}class Ke extends zt{construct(t,e,i){return new Ke(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new ye(K.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new Ke(e)}static emptyPath(){return new Ke([])}}const kg=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class vt extends zt{construct(t,e,i){return new vt(t,e,i)}static isValidIdentifier(t){return kg.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),vt.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===Pl}static keyField(){return new vt([Pl])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new ye(K.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new ye(K.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const l=t[n+1];if(l!=="\\"&&l!=="."&&l!=="`")throw new ye(K.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=l,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new ye(K.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new vt(e)}static emptyPath(){return new vt([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pe{constructor(t){this.path=t}static fromPath(t){return new Pe(Ke.fromString(t))}static fromName(t){return new Pe(Ke.fromString(t).popFirst(5))}static empty(){return new Pe(Ke.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Ke.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Ke.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new Pe(new Ke(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function oh(s,t,e){if(!e)throw new ye(K.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function Fg(s,t,e,i){if(t===!0&&i===!0)throw new ye(K.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function Cl(s){if(!Pe.isDocumentKey(s))throw new ye(K.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function Rl(s){if(Pe.isDocumentKey(s))throw new ye(K.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function ah(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function gs(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":Ie(12329,{type:typeof s})}function di(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new ye(K.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=gs(s);throw new ye(K.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function at(s,t){const e={typeString:s};return t&&(e.value=t),e}function or(s,t){if(!ah(s))throw new ye(K.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new ye(K.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Al=-62135596800,Il=1e6;class Je{static now(){return Je.fromMillis(Date.now())}static fromDate(t){return Je.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*Il);return new Je(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new ye(K.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new ye(K.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<Al)throw new ye(K.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new ye(K.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Il}_compareTo(t){return this.seconds===t.seconds?Ve(this.nanoseconds,t.nanoseconds):Ve(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:Je._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(or(t,Je._jsonSchema))return new Je(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-Al;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}Je._jsonSchemaVersion="firestore/timestamp/1.0",Je._jsonSchema={type:at("string",Je._jsonSchemaVersion),seconds:at("number"),nanoseconds:at("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Me{static fromTimestamp(t){return new Me(t)}static min(){return new Me(new Je(0,0))}static max(){return new Me(new Je(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qn=-1;function Og(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=Me.fromTimestamp(i===1e9?new Je(e+1,0):new Je(e,i));return new gi(n,Pe.empty(),t)}function Vg(s){return new gi(s.readTime,s.key,Qn)}class gi{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new gi(Me.min(),Pe.empty(),Qn)}static max(){return new gi(Me.max(),Pe.empty(),Qn)}}function Lg(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=Pe.comparator(s.documentKey,t.documentKey),e!==0?e:Ve(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ng="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class zg{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function wn(s){if(s.code!==K.FAILED_PRECONDITION||s.message!==Ng)throw s;ve("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Q{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ie(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Q((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof Q?e:Q.resolve(e)}catch(e){return Q.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):Q.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):Q.reject(e)}static resolve(t){return new Q((e,i)=>{e(t)})}static reject(t){return new Q((e,i)=>{i(t)})}static waitFor(t){return new Q((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},l=>i(l))}),o=!0,r===n&&e()})}static or(t){let e=Q.resolve(!1);for(const i of t)e=e.next(n=>n?Q.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new Q((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let l=0;l<r;l++){const c=l;e(t[c]).next(u=>{o[c]=u,++a,a===r&&i(o)},u=>n(u))}})}static doWhile(t,e){return new Q((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function Bg(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function _n(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ms{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}ms.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const No=-1;function ys(s){return s==null}function ns(s){return s===0&&1/s==-1/0}function Hg(s){return typeof s=="number"&&Number.isInteger(s)&&!ns(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lh="";function Ug(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=Dl(t)),t=jg(s.get(e),t);return Dl(t)}function jg(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case lh:e+="";break;default:e+=r}}return e}function Dl(s){return s+lh+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ml(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function bi(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function ch(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class et{constructor(t,e){this.comparator=t,this.root=e||yt.EMPTY}insert(t,e){return new et(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,yt.BLACK,null,null))}remove(t){return new et(this.comparator,this.root.remove(t,this.comparator).copy(null,null,yt.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new kr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new kr(this.root,t,this.comparator,!1)}getReverseIterator(){return new kr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new kr(this.root,t,this.comparator,!0)}}class kr{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class yt{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??yt.RED,this.left=n??yt.EMPTY,this.right=r??yt.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new yt(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return yt.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return yt.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,yt.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,yt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ie(43730,{key:this.key,value:this.value});if(this.right.isRed())throw Ie(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw Ie(27949);return t+(this.isRed()?0:1)}}yt.EMPTY=null,yt.RED=!0,yt.BLACK=!1;yt.EMPTY=new class{constructor(){this.size=0}get key(){throw Ie(57766)}get value(){throw Ie(16141)}get color(){throw Ie(16727)}get left(){throw Ie(29726)}get right(){throw Ie(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new yt(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ut{constructor(t){this.comparator=t,this.data=new et(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new kl(this.data.getIterator())}getIteratorFrom(t){return new kl(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof ut)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new ut(this.comparator);return e.data=t,e}}class kl{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class At{constructor(t){this.fields=t,t.sort(vt.comparator)}static empty(){return new At([])}unionWith(t){let e=new ut(vt.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new At(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return un(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hh extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wt{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new hh("Invalid base64 string: "+r):r}}(t);return new wt(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new wt(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Ve(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}wt.EMPTY_BYTE_STRING=new wt("");const Wg=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function mi(s){if(Ze(!!s,39018),typeof s=="string"){let t=0;const e=Wg.exec(s);if(Ze(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:nt(s.seconds),nanos:nt(s.nanos)}}function nt(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function yi(s){return typeof s=="string"?wt.fromBase64String(s):wt.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const uh="server_timestamp",dh="__type__",ph="__previous_value__",fh="__local_write_time__";function zo(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[dh])===null||e===void 0?void 0:e.stringValue)===uh}function vs(s){const t=s.mapValue.fields[ph];return zo(t)?vs(t):t}function Jn(s){const t=mi(s.mapValue.fields[fh].timestampValue);return new Je(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qg{constructor(t,e,i,n,r,o,a,l,c,u){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=l,this.useFetchStreams=c,this.isUsingEmulator=u}}const rs="(default)";class $n{constructor(t,e){this.projectId=t,this.database=e||rs}static empty(){return new $n("","")}get isDefaultDatabase(){return this.database===rs}isEqual(t){return t instanceof $n&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gh="__type__",Gg="__max__",Fr={mapValue:{}},mh="__vector__",ss="value";function vi(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?zo(s)?4:Xg(s)?9007199254740991:Zg(s)?10:11:Ie(28295,{value:s})}function Zt(s,t){if(s===t)return!0;const e=vi(s);if(e!==vi(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return Jn(s).isEqual(Jn(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=mi(n.timestampValue),a=mi(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return yi(n.bytesValue).isEqual(yi(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return nt(n.geoPointValue.latitude)===nt(r.geoPointValue.latitude)&&nt(n.geoPointValue.longitude)===nt(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return nt(n.integerValue)===nt(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=nt(n.doubleValue),a=nt(r.doubleValue);return o===a?ns(o)===ns(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return un(s.arrayValue.values||[],t.arrayValue.values||[],Zt);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(Ml(o)!==Ml(a))return!1;for(const l in o)if(o.hasOwnProperty(l)&&(a[l]===void 0||!Zt(o[l],a[l])))return!1;return!0}(s,t);default:return Ie(52216,{left:s})}}function er(s,t){return(s.values||[]).find(e=>Zt(e,t))!==void 0}function dn(s,t){if(s===t)return 0;const e=vi(s),i=vi(t);if(e!==i)return Ve(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return Ve(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=nt(r.integerValue||r.doubleValue),l=nt(o.integerValue||o.doubleValue);return a<l?-1:a>l?1:a===l?0:isNaN(a)?isNaN(l)?0:-1:1}(s,t);case 3:return Fl(s.timestampValue,t.timestampValue);case 4:return Fl(Jn(s),Jn(t));case 5:return uo(s.stringValue,t.stringValue);case 6:return function(r,o){const a=yi(r),l=yi(o);return a.compareTo(l)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),l=o.split("/");for(let c=0;c<a.length&&c<l.length;c++){const u=Ve(a[c],l[c]);if(u!==0)return u}return Ve(a.length,l.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=Ve(nt(r.latitude),nt(o.latitude));return a!==0?a:Ve(nt(r.longitude),nt(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return Ol(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,l,c,u;const d=r.fields||{},p=o.fields||{},m=(a=d[ss])===null||a===void 0?void 0:a.arrayValue,y=(l=p[ss])===null||l===void 0?void 0:l.arrayValue,_=Ve(((c=m==null?void 0:m.values)===null||c===void 0?void 0:c.length)||0,((u=y==null?void 0:y.values)===null||u===void 0?void 0:u.length)||0);return _!==0?_:Ol(m,y)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===Fr.mapValue&&o===Fr.mapValue)return 0;if(r===Fr.mapValue)return 1;if(o===Fr.mapValue)return-1;const a=r.fields||{},l=Object.keys(a),c=o.fields||{},u=Object.keys(c);l.sort(),u.sort();for(let d=0;d<l.length&&d<u.length;++d){const p=uo(l[d],u[d]);if(p!==0)return p;const m=dn(a[l[d]],c[u[d]]);if(m!==0)return m}return Ve(l.length,u.length)}(s.mapValue,t.mapValue);default:throw Ie(23264,{le:e})}}function Fl(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return Ve(s,t);const e=mi(s),i=mi(t),n=Ve(e.seconds,i.seconds);return n!==0?n:Ve(e.nanos,i.nanos)}function Ol(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=dn(e[n],i[n]);if(r)return r}return Ve(e.length,i.length)}function pn(s){return po(s)}function po(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=mi(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return yi(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return Pe.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=po(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${po(e.fields[o])}`;return n+"}"}(s.mapValue):Ie(61005,{value:s})}function Ur(s){switch(vi(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=vs(s);return t?16+Ur(t):16;case 5:return 2*s.stringValue.length;case 6:return yi(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+Ur(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return bi(i.fields,(r,o)=>{n+=r.length+Ur(o)}),n}(s.mapValue);default:throw Ie(13486,{value:s})}}function Vl(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function fo(s){return!!s&&"integerValue"in s}function Bo(s){return!!s&&"arrayValue"in s}function Ll(s){return!!s&&"nullValue"in s}function Nl(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function jr(s){return!!s&&"mapValue"in s}function Zg(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[gh])===null||e===void 0?void 0:e.stringValue)===mh}function jn(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return bi(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=jn(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=jn(s.arrayValue.values[e]);return t}return Object.assign({},s)}function Xg(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===Gg}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ct{constructor(t){this.value=t}static empty(){return new Ct({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!jr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=jn(e)}setAll(t){let e=vt.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const l=this.getFieldsMap(e);this.applyChanges(l,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=jn(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());jr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Zt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];jr(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){bi(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Ct(jn(this.value))}}function yh(s){const t=[];return bi(s.fields,(e,i)=>{const n=new vt([e]);if(jr(i)){const r=yh(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new At(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Et{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new Et(t,0,Me.min(),Me.min(),Me.min(),Ct.empty(),0)}static newFoundDocument(t,e,i,n){return new Et(t,1,e,Me.min(),i,n,0)}static newNoDocument(t,e){return new Et(t,2,e,Me.min(),Me.min(),Ct.empty(),0)}static newUnknownDocument(t,e){return new Et(t,3,e,Me.min(),Me.min(),Ct.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(Me.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Ct.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Ct.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Me.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof Et&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Et(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class os{constructor(t,e){this.position=t,this.inclusive=e}}function zl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=Pe.comparator(Pe.fromName(o.referenceValue),e.key):i=dn(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function Bl(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!Zt(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tr{constructor(t,e="asc"){this.field=t,this.dir=e}}function Yg(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vh{}class ot extends vh{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new Qg(t,e,i):e==="array-contains"?new em(t,i):e==="in"?new tm(t,i):e==="not-in"?new im(t,i):e==="array-contains-any"?new nm(t,i):new ot(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new Jg(t,i):new $g(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(dn(e,this.value)):e!==null&&vi(this.value)===vi(e)&&this.matchesComparison(dn(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return Ie(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Nt extends vh{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new Nt(t,e)}matches(t){return wh(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function wh(s){return s.op==="and"}function _h(s){return Kg(s)&&wh(s)}function Kg(s){for(const t of s.filters)if(t instanceof Nt)return!1;return!0}function go(s){if(s instanceof ot)return s.field.canonicalString()+s.op.toString()+pn(s.value);if(_h(s))return s.filters.map(t=>go(t)).join(",");{const t=s.filters.map(e=>go(e)).join(",");return`${s.op}(${t})`}}function Th(s,t){return s instanceof ot?function(i,n){return n instanceof ot&&i.op===n.op&&i.field.isEqual(n.field)&&Zt(i.value,n.value)}(s,t):s instanceof Nt?function(i,n){return n instanceof Nt&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&Th(o,n.filters[a]),!0):!1}(s,t):void Ie(19439)}function bh(s){return s instanceof ot?function(e){return`${e.field.canonicalString()} ${e.op} ${pn(e.value)}`}(s):s instanceof Nt?function(e){return e.op.toString()+" {"+e.getFilters().map(bh).join(" ,")+"}"}(s):"Filter"}class Qg extends ot{constructor(t,e,i){super(t,e,i),this.key=Pe.fromName(i.referenceValue)}matches(t){const e=Pe.comparator(t.key,this.key);return this.matchesComparison(e)}}class Jg extends ot{constructor(t,e){super(t,"in",e),this.keys=xh("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class $g extends ot{constructor(t,e){super(t,"not-in",e),this.keys=xh("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function xh(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>Pe.fromName(i.referenceValue))}class em extends ot{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Bo(e)&&er(e.arrayValue,this.value)}}class tm extends ot{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&er(this.value.arrayValue,e)}}class im extends ot{constructor(t,e){super(t,"not-in",e)}matches(t){if(er(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!er(this.value.arrayValue,e)}}class nm extends ot{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Bo(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>er(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rm{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function Hl(s,t=null,e=[],i=[],n=null,r=null,o=null){return new rm(s,t,e,i,n,r,o)}function Ho(s){const t=Fe(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>go(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),ys(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>pn(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>pn(i)).join(",")),t.Pe=e}return t.Pe}function Uo(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!Yg(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!Th(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!Bl(s.startAt,t.startAt)&&Bl(s.endAt,t.endAt)}function mo(s){return Pe.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tn{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,l=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=l,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function sm(s,t,e,i,n,r,o,a){return new Tn(s,t,e,i,n,r,o,a)}function jo(s){return new Tn(s)}function Ul(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function Eh(s){return s.collectionGroup!==null}function Wn(s){const t=Fe(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new ut(vt.comparator);return o.filters.forEach(l=>{l.getFlattenedFilters().forEach(c=>{c.isInequality()&&(a=a.add(c.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new tr(r,i))}),e.has(vt.keyField().canonicalString())||t.Te.push(new tr(vt.keyField(),i))}return t.Te}function Ht(s){const t=Fe(s);return t.Ie||(t.Ie=om(t,Wn(s))),t.Ie}function om(s,t){if(s.limitType==="F")return Hl(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new tr(n.field,r)});const e=s.endAt?new os(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new os(s.startAt.position,s.startAt.inclusive):null;return Hl(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function yo(s,t){const e=s.filters.concat([t]);return new Tn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function vo(s,t,e){return new Tn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function ws(s,t){return Uo(Ht(s),Ht(t))&&s.limitType===t.limitType}function Sh(s){return`${Ho(Ht(s))}|lt:${s.limitType}`}function tn(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>bh(n)).join(", ")}]`),ys(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>pn(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>pn(n)).join(",")),`Target(${i})`}(Ht(s))}; limitType=${s.limitType})`}function _s(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):Pe.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of Wn(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,l){const c=zl(o,a,l);return o.inclusive?c<=0:c<0}(i.startAt,Wn(i),n)||i.endAt&&!function(o,a,l){const c=zl(o,a,l);return o.inclusive?c>=0:c>0}(i.endAt,Wn(i),n))}(s,t)}function am(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function Ph(s){return(t,e)=>{let i=!1;for(const n of Wn(s)){const r=lm(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function lm(s,t,e){const i=s.field.isKeyField()?Pe.comparator(t.key,e.key):function(r,o,a){const l=o.data.field(r),c=a.data.field(r);return l!==null&&c!==null?dn(l,c):Ie(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return Ie(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ji{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){bi(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return ch(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cm=new et(Pe.comparator);function ti(){return cm}const Ch=new et(Pe.comparator);function Vn(...s){let t=Ch;for(const e of s)t=t.insert(e.key,e);return t}function Rh(s){let t=Ch;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function Ni(){return qn()}function Ah(){return qn()}function qn(){return new ji(s=>s.toString(),(s,t)=>s.isEqual(t))}const hm=new et(Pe.comparator),um=new ut(Pe.comparator);function Be(...s){let t=um;for(const e of s)t=t.add(e);return t}const dm=new ut(Ve);function pm(){return dm}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wo(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ns(t)?"-0":t}}function Ih(s){return{integerValue:""+s}}function fm(s,t){return Hg(t)?Ih(t):Wo(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ts{constructor(){this._=void 0}}function gm(s,t,e){return s instanceof as?function(n,r){const o={fields:{[dh]:{stringValue:uh},[fh]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&zo(r)&&(r=vs(r)),r&&(o.fields[ph]=r),{mapValue:o}}(e,t):s instanceof ir?Mh(s,t):s instanceof nr?kh(s,t):function(n,r){const o=Dh(n,r),a=jl(o)+jl(n.Ee);return fo(o)&&fo(n.Ee)?Ih(a):Wo(n.serializer,a)}(s,t)}function mm(s,t,e){return s instanceof ir?Mh(s,t):s instanceof nr?kh(s,t):e}function Dh(s,t){return s instanceof ls?function(i){return fo(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class as extends Ts{}class ir extends Ts{constructor(t){super(),this.elements=t}}function Mh(s,t){const e=Fh(t);for(const i of s.elements)e.some(n=>Zt(n,i))||e.push(i);return{arrayValue:{values:e}}}class nr extends Ts{constructor(t){super(),this.elements=t}}function kh(s,t){let e=Fh(t);for(const i of s.elements)e=e.filter(n=>!Zt(n,i));return{arrayValue:{values:e}}}class ls extends Ts{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function jl(s){return nt(s.integerValue||s.doubleValue)}function Fh(s){return Bo(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function ym(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof ir&&n instanceof ir||i instanceof nr&&n instanceof nr?un(i.elements,n.elements,Zt):i instanceof ls&&n instanceof ls?Zt(i.Ee,n.Ee):i instanceof as&&n instanceof as}(s.transform,t.transform)}class vm{constructor(t,e){this.version=t,this.transformResults=e}}class Lt{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Lt}static exists(t){return new Lt(void 0,t)}static updateTime(t){return new Lt(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Wr(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class bs{}function Oh(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new qo(s.key,Lt.none()):new ar(s.key,s.data,Lt.none());{const e=s.data,i=Ct.empty();let n=new ut(vt.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new xi(s.key,i,new At(n.toArray()),Lt.none())}}function wm(s,t,e){s instanceof ar?function(n,r,o){const a=n.value.clone(),l=ql(n.fieldTransforms,r,o.transformResults);a.setAll(l),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof xi?function(n,r,o){if(!Wr(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=ql(n.fieldTransforms,r,o.transformResults),l=r.data;l.setAll(Vh(n)),l.setAll(a),r.convertToFoundDocument(o.version,l).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function Gn(s,t,e,i){return s instanceof ar?function(r,o,a,l){if(!Wr(r.precondition,o))return a;const c=r.value.clone(),u=Gl(r.fieldTransforms,l,o);return c.setAll(u),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(s,t,e,i):s instanceof xi?function(r,o,a,l){if(!Wr(r.precondition,o))return a;const c=Gl(r.fieldTransforms,l,o),u=o.data;return u.setAll(Vh(r)),u.setAll(c),o.convertToFoundDocument(o.version,u).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(d=>d.field))}(s,t,e,i):function(r,o,a){return Wr(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function _m(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=Dh(i.transform,n||null);r!=null&&(e===null&&(e=Ct.empty()),e.set(i.field,r))}return e||null}function Wl(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&un(i,n,(r,o)=>ym(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class ar extends bs{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class xi extends bs{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Vh(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function ql(s,t,e){const i=new Map;Ze(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,mm(o,a,e[n]))}return i}function Gl(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,gm(r,o,t))}return i}class qo extends bs{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Tm extends bs{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bm{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&wm(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=Gn(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=Gn(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=Ah();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const l=Oh(o,a);l!==null&&i.set(n.key,l),o.isValidDocument()||o.convertToNoDocument(Me.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Be())}isEqual(t){return this.batchId===t.batchId&&un(this.mutations,t.mutations,(e,i)=>Wl(e,i))&&un(this.baseMutations,t.baseMutations,(e,i)=>Wl(e,i))}}class Go{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){Ze(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return hm}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new Go(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xm{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Em{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var rt,He;function Sm(s){switch(s){case K.OK:return Ie(64938);case K.CANCELLED:case K.UNKNOWN:case K.DEADLINE_EXCEEDED:case K.RESOURCE_EXHAUSTED:case K.INTERNAL:case K.UNAVAILABLE:case K.UNAUTHENTICATED:return!1;case K.INVALID_ARGUMENT:case K.NOT_FOUND:case K.ALREADY_EXISTS:case K.PERMISSION_DENIED:case K.FAILED_PRECONDITION:case K.ABORTED:case K.OUT_OF_RANGE:case K.UNIMPLEMENTED:case K.DATA_LOSS:return!0;default:return Ie(15467,{code:s})}}function Lh(s){if(s===void 0)return ei("GRPC error has no .code"),K.UNKNOWN;switch(s){case rt.OK:return K.OK;case rt.CANCELLED:return K.CANCELLED;case rt.UNKNOWN:return K.UNKNOWN;case rt.DEADLINE_EXCEEDED:return K.DEADLINE_EXCEEDED;case rt.RESOURCE_EXHAUSTED:return K.RESOURCE_EXHAUSTED;case rt.INTERNAL:return K.INTERNAL;case rt.UNAVAILABLE:return K.UNAVAILABLE;case rt.UNAUTHENTICATED:return K.UNAUTHENTICATED;case rt.INVALID_ARGUMENT:return K.INVALID_ARGUMENT;case rt.NOT_FOUND:return K.NOT_FOUND;case rt.ALREADY_EXISTS:return K.ALREADY_EXISTS;case rt.PERMISSION_DENIED:return K.PERMISSION_DENIED;case rt.FAILED_PRECONDITION:return K.FAILED_PRECONDITION;case rt.ABORTED:return K.ABORTED;case rt.OUT_OF_RANGE:return K.OUT_OF_RANGE;case rt.UNIMPLEMENTED:return K.UNIMPLEMENTED;case rt.DATA_LOSS:return K.DATA_LOSS;default:return Ie(39323,{code:s})}}(He=rt||(rt={}))[He.OK=0]="OK",He[He.CANCELLED=1]="CANCELLED",He[He.UNKNOWN=2]="UNKNOWN",He[He.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",He[He.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",He[He.NOT_FOUND=5]="NOT_FOUND",He[He.ALREADY_EXISTS=6]="ALREADY_EXISTS",He[He.PERMISSION_DENIED=7]="PERMISSION_DENIED",He[He.UNAUTHENTICATED=16]="UNAUTHENTICATED",He[He.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",He[He.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",He[He.ABORTED=10]="ABORTED",He[He.OUT_OF_RANGE=11]="OUT_OF_RANGE",He[He.UNIMPLEMENTED=12]="UNIMPLEMENTED",He[He.INTERNAL=13]="INTERNAL",He[He.UNAVAILABLE=14]="UNAVAILABLE",He[He.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pm=new ui([4294967295,4294967295],0);function Zl(s){const t=sh().encode(s),e=new Qc;return e.update(t),new Uint8Array(e.digest())}function Xl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new ui([e,i],0),new ui([n,r],0)]}class Zo{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new Ln(`Invalid padding: ${e}`);if(i<0)throw new Ln(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new Ln(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new Ln(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=ui.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(ui.fromNumber(i)));return n.compare(Pm)===1&&(n=new ui([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=Zl(t),[i,n]=Xl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new Zo(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=Zl(t),[i,n]=Xl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class Ln extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xs{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,lr.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new xs(Me.min(),n,new et(Ve),ti(),Be())}}class lr{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new lr(i,e,Be(),Be(),Be())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qr{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class Nh{constructor(t,e){this.targetId=t,this.De=e}}class zh{constructor(t,e,i=wt.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class Yl{constructor(){this.ve=0,this.Ce=Kl(),this.Fe=wt.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Be(),e=Be(),i=Be();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:Ie(38017,{changeType:r})}}),new lr(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Kl()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,Ze(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class Cm{constructor(t){this.We=t,this.Ge=new Map,this.ze=ti(),this.je=Or(),this.Je=Or(),this.He=new et(Ve)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:Ie(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(mo(r))if(i===0){const o=new Pe(r.path);this.Xe(e,o,Et.newNoDocument(o,Me.min()))}else Ze(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),l=a?this.ut(a,t,o):1;if(l!==0){this.rt(e);const c=l===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,c)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=yi(i).toUint8Array()}catch(l){if(l instanceof hh)return fi("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{a=new Zo(o,n,r)}catch(l){return fi(l instanceof Ln?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&mo(a.target)){const l=new Pe(a.target.path);this.Tt(l).has(o)||this.It(o,l)||this.Xe(o,l,Et.newNoDocument(l,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Be();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(l=>{const c=this.st(l);return!c||c.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new xs(t,e,this.He,this.ze,i);return this.ze=ti(),this.je=Or(),this.Je=Or(),this.He=new et(Ve),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new Yl,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new ut(Ve),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new ut(Ve),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||ve("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new Yl),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function Or(){return new et(Pe.comparator)}function Kl(){return new et(Pe.comparator)}const Rm={asc:"ASCENDING",desc:"DESCENDING"},Am={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Im={and:"AND",or:"OR"};class Dm{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function wo(s,t){return s.useProto3Json||ys(t)?t:{value:t}}function cs(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Bh(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function Mm(s,t){return cs(s,t.toTimestamp())}function Ut(s){return Ze(!!s,49232),Me.fromTimestamp(function(e){const i=mi(e);return new Je(i.seconds,i.nanos)}(s))}function Xo(s,t){return _o(s,t).canonicalString()}function _o(s,t){const e=function(n){return new Ke(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function Hh(s){const t=Ke.fromString(s);return Ze(Gh(t),10190,{key:t.toString()}),t}function To(s,t){return Xo(s.databaseId,t.path)}function Ks(s,t){const e=Hh(t);if(e.get(1)!==s.databaseId.projectId)throw new ye(K.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new ye(K.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new Pe(jh(e))}function Uh(s,t){return Xo(s.databaseId,t)}function km(s){const t=Hh(s);return t.length===4?Ke.emptyPath():jh(t)}function bo(s){return new Ke(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function jh(s){return Ze(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Ql(s,t,e){return{name:To(s,t),fields:e.value.mapValue.fields}}function Fm(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:Ie(39313,{state:c})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(c,u){return c.useProto3Json?(Ze(u===void 0||typeof u=="string",58123),wt.fromBase64String(u||"")):(Ze(u===void 0||u instanceof Buffer||u instanceof Uint8Array,16193),wt.fromUint8Array(u||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(c){const u=c.code===void 0?K.UNKNOWN:Lh(c.code);return new ye(u,c.message||"")}(o);e=new zh(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=Ks(s,i.document.name),r=Ut(i.document.updateTime),o=i.document.createTime?Ut(i.document.createTime):Me.min(),a=new Ct({mapValue:{fields:i.document.fields}}),l=Et.newFoundDocument(n,r,o,a),c=i.targetIds||[],u=i.removedTargetIds||[];e=new qr(c,u,l.key,l)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=Ks(s,i.document),r=i.readTime?Ut(i.readTime):Me.min(),o=Et.newNoDocument(n,r),a=i.removedTargetIds||[];e=new qr([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=Ks(s,i.document),r=i.removedTargetIds||[];e=new qr([],r,n,null)}else{if(!("filter"in t))return Ie(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new Em(n,r),a=i.targetId;e=new Nh(a,o)}}return e}function Om(s,t){let e;if(t instanceof ar)e={update:Ql(s,t.key,t.value)};else if(t instanceof qo)e={delete:To(s,t.key)};else if(t instanceof xi)e={update:Ql(s,t.key,t.data),updateMask:Wm(t.fieldMask)};else{if(!(t instanceof Tm))return Ie(16599,{Rt:t.type});e={verify:To(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof as)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof ir)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof nr)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof ls)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw Ie(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:Mm(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:Ie(27497)}(s,t.precondition)),e}function Vm(s,t){return s&&s.length>0?(Ze(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?Ut(n.updateTime):Ut(r);return o.isEqual(Me.min())&&(o=Ut(r)),new vm(o,n.transformResults||[])}(e,t))):[]}function Lm(s,t){return{documents:[Uh(s,t.path)]}}function Nm(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=Uh(s,n);const r=function(c){if(c.length!==0)return qh(Nt.create(c,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(c){if(c.length!==0)return c.map(u=>function(p){return{field:nn(p.field),direction:Hm(p.dir)}}(u))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=wo(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(t.endAt)),{Vt:e,parent:n}}function zm(s){let t=km(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){Ze(i===1,65062);const u=e.from[0];u.allDescendants?n=u.collectionId:t=t.child(u.collectionId)}let r=[];e.where&&(r=function(d){const p=Wh(d);return p instanceof Nt&&_h(p)?p.getFilters():[p]}(e.where));let o=[];e.orderBy&&(o=function(d){return d.map(p=>function(y){return new tr(rn(y.field),function(T){switch(T){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(y.direction))}(p))}(e.orderBy));let a=null;e.limit&&(a=function(d){let p;return p=typeof d=="object"?d.value:d,ys(p)?null:p}(e.limit));let l=null;e.startAt&&(l=function(d){const p=!!d.before,m=d.values||[];return new os(m,p)}(e.startAt));let c=null;return e.endAt&&(c=function(d){const p=!d.before,m=d.values||[];return new os(m,p)}(e.endAt)),sm(t,n,o,r,a,"F",l,c)}function Bm(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Ie(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Wh(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=rn(e.unaryFilter.field);return ot.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=rn(e.unaryFilter.field);return ot.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=rn(e.unaryFilter.field);return ot.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=rn(e.unaryFilter.field);return ot.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return Ie(61313);default:return Ie(60726)}}(s):s.fieldFilter!==void 0?function(e){return ot.create(rn(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return Ie(58110);default:return Ie(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return Nt.create(e.compositeFilter.filters.map(i=>Wh(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return Ie(1026)}}(e.compositeFilter.op))}(s):Ie(30097,{filter:s})}function Hm(s){return Rm[s]}function Um(s){return Am[s]}function jm(s){return Im[s]}function nn(s){return{fieldPath:s.canonicalString()}}function rn(s){return vt.fromServerFormat(s.fieldPath)}function qh(s){return s instanceof ot?function(e){if(e.op==="=="){if(Nl(e.value))return{unaryFilter:{field:nn(e.field),op:"IS_NAN"}};if(Ll(e.value))return{unaryFilter:{field:nn(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Nl(e.value))return{unaryFilter:{field:nn(e.field),op:"IS_NOT_NAN"}};if(Ll(e.value))return{unaryFilter:{field:nn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:nn(e.field),op:Um(e.op),value:e.value}}}(s):s instanceof Nt?function(e){const i=e.getFilters().map(n=>qh(n));return i.length===1?i[0]:{compositeFilter:{op:jm(e.op),filters:i}}}(s):Ie(54877,{filter:s})}function Wm(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Gh(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class li{constructor(t,e,i,n,r=Me.min(),o=Me.min(),a=wt.EMPTY_BYTE_STRING,l=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=l}withSequenceNumber(t){return new li(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new li(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new li(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new li(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qm{constructor(t){this.gt=t}}function Gm(s){const t=zm({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?vo(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zm{constructor(){this.Dn=new Xm}addToCollectionParentIndex(t,e){return this.Dn.add(e),Q.resolve()}getCollectionParents(t,e){return Q.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return Q.resolve()}deleteFieldIndex(t,e){return Q.resolve()}deleteAllFieldIndexes(t){return Q.resolve()}createTargetIndexes(t,e){return Q.resolve()}getDocumentsMatchingTarget(t,e){return Q.resolve(null)}getIndexType(t,e){return Q.resolve(0)}getFieldIndexes(t,e){return Q.resolve([])}getNextCollectionGroupToUpdate(t){return Q.resolve(null)}getMinOffset(t,e){return Q.resolve(gi.min())}getMinOffsetFromCollectionGroup(t,e){return Q.resolve(gi.min())}updateCollectionGroup(t,e,i){return Q.resolve()}updateIndexEntries(t,e){return Q.resolve()}}class Xm{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new ut(Ke.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new ut(Ke.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Jl={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Zh=41943040;class Pt{static withCacheSize(t){return new Pt(t,Pt.DEFAULT_COLLECTION_PERCENTILE,Pt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Pt.DEFAULT_COLLECTION_PERCENTILE=10,Pt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Pt.DEFAULT=new Pt(Zh,Pt.DEFAULT_COLLECTION_PERCENTILE,Pt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Pt.DISABLED=new Pt(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fn{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new fn(0)}static ur(){return new fn(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $l="LruGarbageCollector",Ym=1048576;function ec([s,t],[e,i]){const n=Ve(s,e);return n===0?Ve(t,i):n}class Km{constructor(t){this.Tr=t,this.buffer=new ut(ec),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();ec(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Qm{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){ve($l,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){_n(e)?ve($l,"Ignoring IndexedDB error during garbage collection: ",e):await wn(e)}await this.Rr(3e5)})}}class Jm{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return Q.resolve(ms.ue);const i=new Km(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(ve("LruGarbageCollector","Garbage collection skipped; disabled"),Q.resolve(Jl)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(ve("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Jl):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,l,c;const u=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(d=>(d>this.params.maximumSequenceNumbersToCollect?(ve("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${d}`),n=this.params.maximumSequenceNumbersToCollect):n=d,o=Date.now(),this.nthSequenceNumber(t,n))).next(d=>(i=d,a=Date.now(),this.removeTargets(t,i,e))).next(d=>(r=d,l=Date.now(),this.removeOrphanedDocuments(t,i))).next(d=>(c=Date.now(),en()<=Ue.DEBUG&&ve("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-u}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(l-a)+`ms
	Removed ${d} documents in `+(c-l)+`ms
Total Duration: ${c-u}ms`),Q.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:d})))}}function $m(s,t){return new Jm(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ey{constructor(){this.changes=new ji(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Et.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?Q.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ty{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iy{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&Gn(i.mutation,n,At.empty(),Je.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Be()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Be()){const n=Ni();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=Vn();return r.forEach((a,l)=>{o=o.insert(a,l.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=Ni();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Be()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=ti();const o=qn(),a=function(){return qn()}();return e.forEach((l,c)=>{const u=i.get(c.key);n.has(c.key)&&(u===void 0||u.mutation instanceof xi)?r=r.insert(c.key,c):u!==void 0?(o.set(c.key,u.mutation.getFieldMask()),Gn(u.mutation,c,u.mutation.getFieldMask(),Je.now())):o.set(c.key,At.empty())}),this.recalculateAndSaveOverlays(t,r).next(l=>(l.forEach((c,u)=>o.set(c,u)),e.forEach((c,u)=>{var d;return a.set(c,new ty(u,(d=o.get(c))!==null&&d!==void 0?d:null))}),a))}recalculateAndSaveOverlays(t,e){const i=qn();let n=new et((o,a)=>o-a),r=Be();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(l=>{const c=e.get(l);if(c===null)return;let u=i.get(l)||At.empty();u=a.applyToLocalView(c,u),i.set(l,u);const d=(n.get(a.batchId)||Be()).add(l);n=n.insert(a.batchId,d)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const l=a.getNext(),c=l.key,u=l.value,d=Ah();u.forEach(p=>{if(!r.has(p)){const m=Oh(e.get(p),i.get(p));m!==null&&d.set(p,m),r=r.add(p)}}),o.push(this.documentOverlayCache.saveOverlays(t,c,d))}return Q.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return Pe.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Eh(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):Q.resolve(Ni());let a=Qn,l=r;return o.next(c=>Q.forEach(c,(u,d)=>(a<d.largestBatchId&&(a=d.largestBatchId),r.get(u)?Q.resolve():this.remoteDocumentCache.getEntry(t,u).next(p=>{l=l.insert(u,p)}))).next(()=>this.populateOverlays(t,c,r)).next(()=>this.computeViews(t,l,c,Be())).next(u=>({batchId:a,changes:Rh(u)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new Pe(e)).next(i=>{let n=Vn();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=Vn();return this.indexManager.getCollectionParents(t,r).next(a=>Q.forEach(a,l=>{const c=function(d,p){return new Tn(p,null,d.explicitOrderBy.slice(),d.filters.slice(),d.limit,d.limitType,d.startAt,d.endAt)}(e,l.child(r));return this.getDocumentsMatchingCollectionQuery(t,c,i,n).next(u=>{u.forEach((d,p)=>{o=o.insert(d,p)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((l,c)=>{const u=c.getKey();o.get(u)===null&&(o=o.insert(u,Et.newInvalidDocument(u)))});let a=Vn();return o.forEach((l,c)=>{const u=r.get(l);u!==void 0&&Gn(u.mutation,c,At.empty(),Je.now()),_s(e,c)&&(a=a.insert(l,c))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ny{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return Q.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:Ut(n.createTime)}}(e)),Q.resolve()}getNamedQuery(t,e){return Q.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:Gm(n.bundledQuery),readTime:Ut(n.readTime)}}(e)),Q.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ry{constructor(){this.overlays=new et(Pe.comparator),this.kr=new Map}getOverlay(t,e){return Q.resolve(this.overlays.get(e))}getOverlays(t,e){const i=Ni();return Q.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),Q.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),Q.resolve()}getOverlaysForCollection(t,e,i){const n=Ni(),r=e.length+1,o=new Pe(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const l=a.getNext().value,c=l.getKey();if(!e.isPrefixOf(c.path))break;c.path.length===r&&l.largestBatchId>i&&n.set(l.getKey(),l)}return Q.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new et((c,u)=>c-u);const o=this.overlays.getIterator();for(;o.hasNext();){const c=o.getNext().value;if(c.getKey().getCollectionGroup()===e&&c.largestBatchId>i){let u=r.get(c.largestBatchId);u===null&&(u=Ni(),r=r.insert(c.largestBatchId,u)),u.set(c.getKey(),c)}}const a=Ni(),l=r.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((c,u)=>a.set(c,u)),!(a.size()>=n)););return Q.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new xm(e,i));let r=this.kr.get(e);r===void 0&&(r=Be(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sy{constructor(){this.sessionToken=wt.EMPTY_BYTE_STRING}getSessionToken(t){return Q.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,Q.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yo{constructor(){this.qr=new ut(dt.Qr),this.$r=new ut(dt.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new dt(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new dt(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new Pe(new Ke([])),i=new dt(e,t),n=new dt(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new Pe(new Ke([])),i=new dt(e,t),n=new dt(e,t+1);let r=Be();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new dt(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class dt{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return Pe.comparator(t.key,e.key)||Ve(t.Hr,e.Hr)}static Ur(t,e){return Ve(t.Hr,e.Hr)||Pe.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oy{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new ut(dt.Qr)}checkEmpty(t){return Q.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new bm(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new dt(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return Q.resolve(o)}lookupMutationBatch(t,e){return Q.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return Q.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return Q.resolve(this.mutationQueue.length===0?No:this.er-1)}getAllMutationBatches(t){return Q.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new dt(e,0),n=new dt(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),Q.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new ut(Ve);return e.forEach(n=>{const r=new dt(n,0),o=new dt(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),Q.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;Pe.isDocumentKey(r)||(r=r.child(""));const o=new dt(new Pe(r),0);let a=new ut(Ve);return this.Yr.forEachWhile(l=>{const c=l.key.path;return!!i.isPrefixOf(c)&&(c.length===n&&(a=a.add(l.Hr)),!0)},o),Q.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){Ze(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return Q.forEach(e.mutations,n=>{const r=new dt(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new dt(e,0),n=this.Yr.firstAfterOrEqual(i);return Q.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,Q.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ay{constructor(t){this.ni=t,this.docs=function(){return new et(Pe.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return Q.resolve(i?i.document.mutableCopy():Et.newInvalidDocument(e))}getEntries(t,e){let i=ti();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():Et.newInvalidDocument(n))}),Q.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=ti();const o=e.path,a=new Pe(o.child("__id-9223372036854775808__")),l=this.docs.getIteratorFrom(a);for(;l.hasNext();){const{key:c,value:{document:u}}=l.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||Lg(Vg(u),i)<=0||(n.has(u.key)||_s(e,u))&&(r=r.insert(u.key,u.mutableCopy()))}return Q.resolve(r)}getAllFromCollectionGroup(t,e,i,n){Ie(9500)}ri(t,e){return Q.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new ly(this)}getSize(t){return Q.resolve(this.size)}}class ly extends ey{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),Q.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cy{constructor(t){this.persistence=t,this.ii=new ji(e=>Ho(e),Uo),this.lastRemoteSnapshotVersion=Me.min(),this.highestTargetId=0,this.si=0,this.oi=new Yo,this.targetCount=0,this._i=fn.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),Q.resolve()}getLastRemoteSnapshotVersion(t){return Q.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Q.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),Q.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),Q.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new fn(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,Q.resolve()}updateTargetData(t,e){return this.hr(e),Q.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,Q.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),Q.waitFor(r).next(()=>n)}getTargetCount(t){return Q.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return Q.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),Q.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),Q.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),Q.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return Q.resolve(i)}containsKey(t,e){return Q.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xh{constructor(t,e){this.ai={},this.overlays={},this.ui=new ms(0),this.ci=!1,this.ci=!0,this.li=new sy,this.referenceDelegate=t(this),this.hi=new cy(this),this.indexManager=new Zm,this.remoteDocumentCache=function(n){return new ay(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new qm(e),this.Ti=new ny(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new ry,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new oy(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){ve("MemoryPersistence","Starting transaction:",t);const n=new hy(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return Q.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class hy extends zg{constructor(t){super(),this.currentSequenceNumber=t}}class Ko{constructor(t){this.persistence=t,this.Ai=new Yo,this.Ri=null}static Vi(t){return new Ko(t)}get mi(){if(this.Ri)return this.Ri;throw Ie(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),Q.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),Q.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),Q.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Q.forEach(this.mi,i=>{const n=Pe.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,Me.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return Q.or([()=>Q.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class hs{constructor(t,e){this.persistence=t,this.gi=new ji(i=>Ug(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=$m(this,e)}static Vi(t,e){return new hs(t,e)}Ii(){}di(t){return Q.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return Q.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?Q.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,Me.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),Q.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),Q.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),Q.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),Q.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=Ur(t.data.value)),e}Sr(t,e,i){return Q.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return Q.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qo{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Be(),n=Be();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new Qo(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uy{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dy{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return af()?8:Bg(sf())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new uy;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(en()<=Ue.DEBUG&&ve("QueryEngine","SDK will not create cache indexes for query:",tn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),Q.resolve()):(en()<=Ue.DEBUG&&ve("QueryEngine","Query:",tn(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(en()<=Ue.DEBUG&&ve("QueryEngine","The SDK decides to create cache indexes for query:",tn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Ht(e))):Q.resolve())}ps(t,e){if(Ul(e))return Q.resolve(null);let i=Ht(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=vo(e,null,"F"),i=Ht(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Be(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(l=>{const c=this.bs(e,a);return this.Ds(e,c,o,l.readTime)?this.ps(t,vo(e,null,"F")):this.vs(t,c,e,l)}))})))}ys(t,e,i,n){return Ul(e)||n.isEqual(Me.min())?Q.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?Q.resolve(null):(en()<=Ue.DEBUG&&ve("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),tn(e)),this.vs(t,o,e,Og(n,Qn)).next(a=>a))})}bs(t,e){let i=new ut(Ph(t));return e.forEach((n,r)=>{_s(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return en()<=Ue.DEBUG&&ve("QueryEngine","Using full collection scan to execute query:",tn(e)),this.gs.getDocumentsMatchingQuery(t,e,gi.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Jo="LocalStore",py=3e8;class fy{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new et(Ve),this.Ms=new ji(r=>Ho(r),Uo),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new iy(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function gy(s,t,e,i){return new fy(s,t,e,i)}async function Yh(s,t){const e=Fe(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let l=Be();for(const c of n){o.push(c.batchId);for(const u of c.mutations)l=l.add(u.key)}for(const c of r){a.push(c.batchId);for(const u of c.mutations)l=l.add(u.key)}return e.localDocuments.getDocuments(i,l).next(c=>({Bs:c,removedBatchIds:o,addedBatchIds:a}))})})}function my(s,t){const e=Fe(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,l,c,u){const d=c.batch,p=d.keys();let m=Q.resolve();return p.forEach(y=>{m=m.next(()=>u.getEntry(l,y)).next(_=>{const T=c.docVersions.get(y);Ze(T!==null,48541),_.version.compareTo(T)<0&&(d.applyToRemoteDocument(_,c),_.isValidDocument()&&(_.setReadTime(c.commitVersion),u.addEntry(_)))})}),m.next(()=>a.mutationQueue.removeMutationBatch(l,d))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let l=Be();for(let c=0;c<a.mutationResults.length;++c)a.mutationResults[c].transformResults.length>0&&(l=l.add(a.batch.mutations[c].key));return l}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function Kh(s){const t=Fe(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function yy(s,t){const e=Fe(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((u,d)=>{const p=n.get(d);if(!p)return;a.push(e.hi.removeMatchingKeys(r,u.removedDocuments,d).next(()=>e.hi.addMatchingKeys(r,u.addedDocuments,d)));let m=p.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(d)!==null?m=m.withResumeToken(wt.EMPTY_BYTE_STRING,Me.min()).withLastLimboFreeSnapshotVersion(Me.min()):u.resumeToken.approximateByteSize()>0&&(m=m.withResumeToken(u.resumeToken,i)),n=n.insert(d,m),function(_,T,x){return _.resumeToken.approximateByteSize()===0||T.snapshotVersion.toMicroseconds()-_.snapshotVersion.toMicroseconds()>=py?!0:x.addedDocuments.size+x.modifiedDocuments.size+x.removedDocuments.size>0}(p,m,u)&&a.push(e.hi.updateTargetData(r,m))});let l=ti(),c=Be();if(t.documentUpdates.forEach(u=>{t.resolvedLimboDocuments.has(u)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,u))}),a.push(vy(r,o,t.documentUpdates).next(u=>{l=u.Ls,c=u.ks})),!i.isEqual(Me.min())){const u=e.hi.getLastRemoteSnapshotVersion(r).next(d=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(u)}return Q.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,l,c)).next(()=>l)}).then(r=>(e.Fs=n,r))}function vy(s,t,e){let i=Be(),n=Be();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=ti();return e.forEach((a,l)=>{const c=r.get(a);l.isFoundDocument()!==c.isFoundDocument()&&(n=n.add(a)),l.isNoDocument()&&l.version.isEqual(Me.min())?(t.removeEntry(a,l.readTime),o=o.insert(a,l)):!c.isValidDocument()||l.version.compareTo(c.version)>0||l.version.compareTo(c.version)===0&&c.hasPendingWrites?(t.addEntry(l),o=o.insert(a,l)):ve(Jo,"Ignoring outdated watch update for ",a,". Current version:",c.version," Watch version:",l.version)}),{Ls:o,ks:n}})}function wy(s,t){const e=Fe(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=No),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function _y(s,t){const e=Fe(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,Q.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new li(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function xo(s,t,e){const i=Fe(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!_n(o))throw o;ve(Jo,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function tc(s,t,e){const i=Fe(s);let n=Me.min(),r=Be();return i.persistence.runTransaction("Execute query","readwrite",o=>function(l,c,u){const d=Fe(l),p=d.Ms.get(u);return p!==void 0?Q.resolve(d.Fs.get(p)):d.hi.getTargetData(c,u)}(i,o,Ht(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(l=>{r=l})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:Me.min(),e?r:Be())).next(a=>(Ty(i,am(t),a),{documents:a,qs:r})))}function Ty(s,t,e){let i=s.xs.get(t)||Me.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class ic{constructor(){this.activeTargetIds=pm()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class by{constructor(){this.Fo=new ic,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new ic,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xy{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nc="ConnectivityMonitor";class rc{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){ve(nc,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){ve(nc,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Vr=null;function Eo(){return Vr===null?Vr=function(){return 268435456+Math.round(2147483648*Math.random())}():Vr++,"0x"+Vr.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qs="RestConnection",Ey={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Sy{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===rs?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=Eo(),a=this.Go(t,e.toUriEncodedString());ve(Qs,`Sending RPC '${t}' ${o}:`,a,i);const l={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(l,n,r);const{host:c}=new URL(a),u=Fo(c);return this.jo(t,a,l,i,u).then(d=>(ve(Qs,`Received RPC '${t}' ${o}: `,d),d),d=>{throw fi(Qs,`RPC '${t}' ${o} failed with error: `,d,"url: ",a,"request:",i),d})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+vn}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=Ey[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Py{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bt="WebChannelConnection";class Cy extends Sy{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=Eo();return new Promise((a,l)=>{const c=new Jc;c.setWithCredentials(!0),c.listenOnce($c.COMPLETE,()=>{try{switch(c.getLastErrorCode()){case Hr.NO_ERROR:const d=c.getResponseJson();ve(bt,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(d)),a(d);break;case Hr.TIMEOUT:ve(bt,`RPC '${t}' ${o} timed out`),l(new ye(K.DEADLINE_EXCEEDED,"Request time out"));break;case Hr.HTTP_ERROR:const p=c.getStatus();if(ve(bt,`RPC '${t}' ${o} failed with status:`,p,"response text:",c.getResponseText()),p>0){let m=c.getResponseJson();Array.isArray(m)&&(m=m[0]);const y=m==null?void 0:m.error;if(y&&y.status&&y.message){const _=function(x){const V=x.toLowerCase().replace(/_/g,"-");return Object.values(K).indexOf(V)>=0?V:K.UNKNOWN}(y.status);l(new ye(_,y.message))}else l(new ye(K.UNKNOWN,"Server responded with status "+c.getStatus()))}else l(new ye(K.UNAVAILABLE,"Connection failed."));break;default:Ie(9055,{c_:t,streamId:o,l_:c.getLastErrorCode(),h_:c.getLastError()})}}finally{ve(bt,`RPC '${t}' ${o} completed.`)}});const u=JSON.stringify(n);ve(bt,`RPC '${t}' ${o} sending request:`,n),c.send(e,"POST",u,i,15)})}P_(t,e,i){const n=Eo(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=ih(),a=th(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(l.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(l.useFetchStreams=!0),this.zo(l.initMessageHeaders,e,i),l.encodeInitMessageHeaders=!0;const u=r.join("");ve(bt,`Creating RPC '${t}' stream ${n}: ${u}`,l);const d=o.createWebChannel(u,l);this.T_(d);let p=!1,m=!1;const y=new Py({Ho:T=>{m?ve(bt,`Not sending because RPC '${t}' stream ${n} is closed:`,T):(p||(ve(bt,`Opening RPC '${t}' stream ${n} transport.`),d.open(),p=!0),ve(bt,`RPC '${t}' stream ${n} sending:`,T),d.send(T))},Yo:()=>d.close()}),_=(T,x,V)=>{T.listen(x,L=>{try{V(L)}catch(W){setTimeout(()=>{throw W},0)}})};return _(d,On.EventType.OPEN,()=>{m||(ve(bt,`RPC '${t}' stream ${n} transport opened.`),y.s_())}),_(d,On.EventType.CLOSE,()=>{m||(m=!0,ve(bt,`RPC '${t}' stream ${n} transport closed`),y.__(),this.I_(d))}),_(d,On.EventType.ERROR,T=>{m||(m=!0,fi(bt,`RPC '${t}' stream ${n} transport errored. Name:`,T.name,"Message:",T.message),y.__(new ye(K.UNAVAILABLE,"The operation could not be completed")))}),_(d,On.EventType.MESSAGE,T=>{var x;if(!m){const V=T.data[0];Ze(!!V,16349);const L=V,W=(L==null?void 0:L.error)||((x=L[0])===null||x===void 0?void 0:x.error);if(W){ve(bt,`RPC '${t}' stream ${n} received error:`,W);const J=W.status;let ee=function(P){const M=rt[P];if(M!==void 0)return Lh(M)}(J),F=W.message;ee===void 0&&(ee=K.INTERNAL,F="Unknown error status: "+J+" with message "+W.message),m=!0,y.__(new ye(ee,F)),d.close()}else ve(bt,`RPC '${t}' stream ${n} received:`,V),y.a_(V)}}),_(a,eh.STAT_EVENT,T=>{T.stat===ho.PROXY?ve(bt,`RPC '${t}' stream ${n} detected buffering proxy`):T.stat===ho.NOPROXY&&ve(bt,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{y.o_()},0),y}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function Js(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Es(s){return new Dm(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qh{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&ve("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sc="PersistentStream";class Jh{constructor(t,e,i,n,r,o,a,l){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=l,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new Qh(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===K.RESOURCE_EXHAUSTED?(ei(e.toString()),ei("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===K.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new ye(K.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return ve(sc,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(ve(sc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Ry extends Jh{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=Fm(this.serializer,t),i=function(r){if(!("targetChange"in r))return Me.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?Me.min():o.readTime?Ut(o.readTime):Me.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=bo(this.serializer),e.addTarget=function(r,o){let a;const l=o.target;if(a=mo(l)?{documents:Lm(r,l)}:{query:Nm(r,l).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Bh(r,o.resumeToken);const c=wo(r,o.expectedCount);c!==null&&(a.expectedCount=c)}else if(o.snapshotVersion.compareTo(Me.min())>0){a.readTime=cs(r,o.snapshotVersion.toTimestamp());const c=wo(r,o.expectedCount);c!==null&&(a.expectedCount=c)}return a}(this.serializer,t);const i=Bm(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=bo(this.serializer),e.removeTarget=t,this.k_(e)}}class Ay extends Jh{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return Ze(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,Ze(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){Ze(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=Vm(t.writeResults,t.commitTime),i=Ut(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=bo(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>Om(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Iy{}class Dy extends Iy{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new ye(K.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,_o(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===K.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new ye(K.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,_o(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===K.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new ye(K.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class My{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?(ei(e),this._a=!1):ve("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ui="RemoteStore";class ky{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{Wi(this)&&(ve(Ui,"Restarting streams for network reachability change."),await async function(l){const c=Fe(l);c.Ia.add(4),await cr(c),c.Aa.set("Unknown"),c.Ia.delete(4),await Ss(c)}(this))})}),this.Aa=new My(i,n)}}async function Ss(s){if(Wi(s))for(const t of s.da)await t(!0)}async function cr(s){for(const t of s.da)await t(!1)}function $h(s,t){const e=Fe(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),ia(e)?ta(e):bn(e).x_()&&ea(e,t))}function $o(s,t){const e=Fe(s),i=bn(e);e.Ta.delete(t),i.x_()&&eu(e,t),e.Ta.size===0&&(i.x_()?i.B_():Wi(e)&&e.Aa.set("Unknown"))}function ea(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Me.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}bn(s).H_(t)}function eu(s,t){s.Ra.$e(t),bn(s).Y_(t)}function ta(s){s.Ra=new Cm({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),bn(s).start(),s.Aa.aa()}function ia(s){return Wi(s)&&!bn(s).M_()&&s.Ta.size>0}function Wi(s){return Fe(s).Ia.size===0}function tu(s){s.Ra=void 0}async function Fy(s){s.Aa.set("Online")}async function Oy(s){s.Ta.forEach((t,e)=>{ea(s,t)})}async function Vy(s,t){tu(s),ia(s)?(s.Aa.la(t),ta(s)):s.Aa.set("Unknown")}async function Ly(s,t,e){if(s.Aa.set("Online"),t instanceof zh&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){ve(Ui,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await us(s,i)}else if(t instanceof qr?s.Ra.Ye(t):t instanceof Nh?s.Ra.it(t):s.Ra.et(t),!e.isEqual(Me.min()))try{const i=await Kh(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((l,c)=>{if(l.resumeToken.approximateByteSize()>0){const u=r.Ta.get(c);u&&r.Ta.set(c,u.withResumeToken(l.resumeToken,o))}}),a.targetMismatches.forEach((l,c)=>{const u=r.Ta.get(l);if(!u)return;r.Ta.set(l,u.withResumeToken(wt.EMPTY_BYTE_STRING,u.snapshotVersion)),eu(r,l);const d=new li(u.target,l,c,u.sequenceNumber);ea(r,d)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){ve(Ui,"Failed to raise snapshot:",i),await us(s,i)}}async function us(s,t,e){if(!_n(t))throw t;s.Ia.add(1),await cr(s),s.Aa.set("Offline"),e||(e=()=>Kh(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{ve(Ui,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await Ss(s)})}function iu(s,t){return t().catch(e=>us(s,e,t))}async function Ps(s){const t=Fe(s),e=wi(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:No;for(;Ny(t);)try{const n=await wy(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,zy(t,n)}catch(n){await us(t,n)}nu(t)&&ru(t)}function Ny(s){return Wi(s)&&s.Pa.length<10}function zy(s,t){s.Pa.push(t);const e=wi(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function nu(s){return Wi(s)&&!wi(s).M_()&&s.Pa.length>0}function ru(s){wi(s).start()}async function By(s){wi(s).na()}async function Hy(s){const t=wi(s);for(const e of s.Pa)t.X_(e.mutations)}async function Uy(s,t,e){const i=s.Pa.shift(),n=Go.from(i,t,e);await iu(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await Ps(s)}async function jy(s,t){t&&wi(s).Z_&&await async function(i,n){if(function(o){return Sm(o)&&o!==K.ABORTED}(n.code)){const r=i.Pa.shift();wi(i).N_(),await iu(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await Ps(i)}}(s,t),nu(s)&&ru(s)}async function oc(s,t){const e=Fe(s);e.asyncQueue.verifyOperationInProgress(),ve(Ui,"RemoteStore received new credentials");const i=Wi(e);e.Ia.add(3),await cr(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await Ss(e)}async function Wy(s,t){const e=Fe(s);t?(e.Ia.delete(2),await Ss(e)):t||(e.Ia.add(2),await cr(e),e.Aa.set("Unknown"))}function bn(s){return s.Va||(s.Va=function(e,i,n){const r=Fe(e);return r.ia(),new Ry(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:Fy.bind(null,s),e_:Oy.bind(null,s),n_:Vy.bind(null,s),J_:Ly.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),ia(s)?ta(s):s.Aa.set("Unknown")):(await s.Va.stop(),tu(s))})),s.Va}function wi(s){return s.ma||(s.ma=function(e,i,n){const r=Fe(e);return r.ia(),new Ay(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:By.bind(null,s),n_:jy.bind(null,s),ea:Hy.bind(null,s),ta:Uy.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await Ps(s)):(await s.ma.stop(),s.Pa.length>0&&(ve(Ui,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class na{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new zi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new na(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new ye(K.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ra(s,t){if(ei("AsyncQueue",`${t}: ${s}`),_n(s))return new ye(K.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cn{static emptySet(t){return new cn(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||Pe.comparator(e.key,i.key):(e,i)=>Pe.comparator(e.key,i.key),this.keyedMap=Vn(),this.sortedSet=new et(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof cn)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new cn;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ac{constructor(){this.fa=new et(Pe.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):Ie(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class gn{constructor(t,e,i,n,r,o,a,l,c){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=l,this.hasCachedResults=c}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new gn(t,e,cn.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&ws(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qy{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class Gy{constructor(){this.queries=lc(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=Fe(e),r=n.queries;n.queries=lc(),r.forEach((o,a)=>{for(const l of a.wa)l.onError(i)})})(this,new ye(K.ABORTED,"Firestore shutting down"))}}function lc(){return new ji(s=>Sh(s),ws)}async function Zy(s,t){const e=Fe(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new qy,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=ra(o,`Initialization of query '${tn(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&sa(e)}async function Xy(s,t){const e=Fe(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function Yy(s,t){const e=Fe(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&sa(e)}function Ky(s,t,e){const i=Fe(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function sa(s){s.Da.forEach(t=>{t.next()})}var So,cc;(cc=So||(So={})).Fa="default",cc.Cache="cache";class Qy{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new gn(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=gn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==So.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class su{constructor(t){this.key=t}}class ou{constructor(t){this.key=t}}class Jy{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Be(),this.mutatedKeys=Be(),this.Xa=Ph(t),this.eu=new cn(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new ac,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const l=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,c=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((u,d)=>{const p=n.get(u),m=_s(this.query,d)?d:null,y=!!p&&this.mutatedKeys.has(p.key),_=!!m&&(m.hasLocalMutations||this.mutatedKeys.has(m.key)&&m.hasCommittedMutations);let T=!1;p&&m?p.data.isEqual(m.data)?y!==_&&(i.track({type:3,doc:m}),T=!0):this.iu(p,m)||(i.track({type:2,doc:m}),T=!0,(l&&this.Xa(m,l)>0||c&&this.Xa(m,c)<0)&&(a=!0)):!p&&m?(i.track({type:0,doc:m}),T=!0):p&&!m&&(i.track({type:1,doc:p}),T=!0,(l||c)&&(a=!0)),T&&(m?(o=o.add(m),r=_?r.add(u):r.delete(u)):(o=o.delete(u),r=r.delete(u)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const u=this.query.limitType==="F"?o.last():o.first();o=o.delete(u.key),r=r.delete(u.key),i.track({type:1,doc:u})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((u,d)=>function(m,y){const _=T=>{switch(T){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ie(20277,{At:T})}};return _(m)-_(y)}(u.type,d.type)||this.Xa(u.doc,d.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],l=this.Za.size===0&&this.current&&!n?1:0,c=l!==this.Ya;return this.Ya=l,o.length!==0||c?{snapshot:new gn(this.query,t.eu,r,o,t.mutatedKeys,l===0,c,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new ac,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Be(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new ou(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new su(i))}),e}uu(t){this.Ha=t.qs,this.Za=Be();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return gn.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const oa="SyncEngine";class $y{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class ev{constructor(t){this.key=t,this.lu=!1}}class tv{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new ji(a=>Sh(a),ws),this.Tu=new Map,this.Iu=new Set,this.du=new et(Pe.comparator),this.Eu=new Map,this.Au=new Yo,this.Ru={},this.Vu=new Map,this.mu=fn.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function iv(s,t,e=!0){const i=du(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await au(i,t,e,!0),n}async function nv(s,t){const e=du(s);await au(e,t,!0,!1)}async function au(s,t,e,i){const n=await _y(s.localStore,Ht(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await rv(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&$h(s.remoteStore,n),a}async function rv(s,t,e,i,n){s.gu=(d,p,m)=>async function(_,T,x,V){let L=T.view.nu(x);L.Ds&&(L=await tc(_.localStore,T.query,!1).then(({documents:F})=>T.view.nu(F,L)));const W=V&&V.targetChanges.get(T.targetId),J=V&&V.targetMismatches.get(T.targetId)!=null,ee=T.view.applyChanges(L,_.isPrimaryClient,W,J);return uc(_,T.targetId,ee._u),ee.snapshot}(s,d,p,m);const r=await tc(s.localStore,t,!0),o=new Jy(t,r.qs),a=o.nu(r.documents),l=lr.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),c=o.applyChanges(a,s.isPrimaryClient,l);uc(s,e,c._u);const u=new $y(t,e,o);return s.Pu.set(t,u),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),c.snapshot}async function sv(s,t,e){const i=Fe(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!ws(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await xo(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&$o(i.remoteStore,n.targetId),Po(i,n.targetId)}).catch(wn)):(Po(i,n.targetId),await xo(i.localStore,n.targetId,!0))}async function ov(s,t){const e=Fe(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),$o(e.remoteStore,i.targetId))}async function av(s,t,e){const i=fv(s);try{const n=await function(o,a){const l=Fe(o),c=Je.now(),u=a.reduce((m,y)=>m.add(y.key),Be());let d,p;return l.persistence.runTransaction("Locally write mutations","readwrite",m=>{let y=ti(),_=Be();return l.Os.getEntries(m,u).next(T=>{y=T,y.forEach((x,V)=>{V.isValidDocument()||(_=_.add(x))})}).next(()=>l.localDocuments.getOverlayedDocuments(m,y)).next(T=>{d=T;const x=[];for(const V of a){const L=_m(V,d.get(V.key).overlayedDocument);L!=null&&x.push(new xi(V.key,L,yh(L.value.mapValue),Lt.exists(!0)))}return l.mutationQueue.addMutationBatch(m,c,x,a)}).next(T=>{p=T;const x=T.applyToLocalDocumentSet(d,_);return l.documentOverlayCache.saveOverlays(m,T.batchId,x)})}).then(()=>({batchId:p.batchId,changes:Rh(d)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,l){let c=o.Ru[o.currentUser.toKey()];c||(c=new et(Ve)),c=c.insert(a,l),o.Ru[o.currentUser.toKey()]=c}(i,n.batchId,e),await hr(i,n.changes),await Ps(i.remoteStore)}catch(n){const r=ra(n,"Failed to persist write");e.reject(r)}}async function lu(s,t){const e=Fe(s);try{const i=await yy(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(Ze(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?Ze(o.lu,14607):n.removedDocuments.size>0&&(Ze(o.lu,42227),o.lu=!1))}),await hr(e,i,t)}catch(i){await wn(i)}}function hc(s,t,e){const i=Fe(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const l=Fe(o);l.onlineState=a;let c=!1;l.queries.forEach((u,d)=>{for(const p of d.wa)p.va(a)&&(c=!0)}),c&&sa(l)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function lv(s,t,e){const i=Fe(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new et(Pe.comparator);o=o.insert(r,Et.newNoDocument(r,Me.min()));const a=Be().add(r),l=new xs(Me.min(),new Map,new et(Ve),o,a);await lu(i,l),i.du=i.du.remove(r),i.Eu.delete(t),aa(i)}else await xo(i.localStore,t,!1).then(()=>Po(i,t,e)).catch(wn)}async function cv(s,t){const e=Fe(s),i=t.batch.batchId;try{const n=await my(e.localStore,t);hu(e,i,null),cu(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await hr(e,n)}catch(n){await wn(n)}}async function hv(s,t,e){const i=Fe(s);try{const n=await function(o,a){const l=Fe(o);return l.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let u;return l.mutationQueue.lookupMutationBatch(c,a).next(d=>(Ze(d!==null,37113),u=d.keys(),l.mutationQueue.removeMutationBatch(c,d))).next(()=>l.mutationQueue.performConsistencyCheck(c)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(c,u,a)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,u)).next(()=>l.localDocuments.getDocuments(c,u))})}(i.localStore,t);hu(i,t,e),cu(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await hr(i,n)}catch(n){await wn(n)}}function cu(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function hu(s,t,e){const i=Fe(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function Po(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||uu(s,i)})}function uu(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&($o(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),aa(s))}function uc(s,t,e){for(const i of e)i instanceof su?(s.Au.addReference(i.key,t),uv(s,i)):i instanceof ou?(ve(oa,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||uu(s,i.key)):Ie(19791,{yu:i})}function uv(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(ve(oa,"New document in limbo: "+e),s.Iu.add(i),aa(s))}function aa(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new Pe(Ke.fromString(t)),i=s.mu.next();s.Eu.set(i,new ev(e)),s.du=s.du.insert(e,i),$h(s.remoteStore,new li(Ht(jo(e.path)),i,"TargetPurposeLimboResolution",ms.ue))}}async function hr(s,t,e){const i=Fe(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,l)=>{o.push(i.gu(l,t,e).then(c=>{var u;if((c||e)&&i.isPrimaryClient){const d=c?!c.fromCache:(u=e==null?void 0:e.targetChanges.get(l.targetId))===null||u===void 0?void 0:u.current;i.sharedClientState.updateQueryState(l.targetId,d?"current":"not-current")}if(c){n.push(c);const d=Qo.Es(l.targetId,c);r.push(d)}}))}),await Promise.all(o),i.hu.J_(n),await async function(l,c){const u=Fe(l);try{await u.persistence.runTransaction("notifyLocalViewChanges","readwrite",d=>Q.forEach(c,p=>Q.forEach(p.Is,m=>u.persistence.referenceDelegate.addReference(d,p.targetId,m)).next(()=>Q.forEach(p.ds,m=>u.persistence.referenceDelegate.removeReference(d,p.targetId,m)))))}catch(d){if(!_n(d))throw d;ve(Jo,"Failed to update sequence numbers: "+d)}for(const d of c){const p=d.targetId;if(!d.fromCache){const m=u.Fs.get(p),y=m.snapshotVersion,_=m.withLastLimboFreeSnapshotVersion(y);u.Fs=u.Fs.insert(p,_)}}}(i.localStore,r))}async function dv(s,t){const e=Fe(s);if(!e.currentUser.isEqual(t)){ve(oa,"User change. New user:",t.toKey());const i=await Yh(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(l=>{l.reject(new ye(K.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await hr(e,i.Bs)}}function pv(s,t){const e=Fe(s),i=e.Eu.get(t);if(i&&i.lu)return Be().add(i.key);{let n=Be();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function du(s){const t=Fe(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=lu.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=pv.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=lv.bind(null,t),t.hu.J_=Yy.bind(null,t.eventManager),t.hu.pu=Ky.bind(null,t.eventManager),t}function fv(s){const t=Fe(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=cv.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=hv.bind(null,t),t}class ds{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=Es(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return gy(this.persistence,new dy,t.initialUser,this.serializer)}Du(t){return new Xh(Ko.Vi,this.serializer)}bu(t){return new by}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}ds.provider={build:()=>new ds};class gv extends ds{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){Ze(this.persistence.referenceDelegate instanceof hs,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new Qm(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?Pt.withCacheSize(this.cacheSizeBytes):Pt.DEFAULT;return new Xh(i=>hs.Vi(i,e),this.serializer)}}class Co{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>hc(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=dv.bind(null,this.syncEngine),await Wy(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new Gy}()}createDatastore(t){const e=Es(t.databaseInfo.databaseId),i=function(r){return new Cy(r)}(t.databaseInfo);return function(r,o,a,l){return new Dy(r,o,a,l)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new ky(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>hc(this.syncEngine,e,0),function(){return rc.C()?new rc:new xy}())}createSyncEngine(t,e){return function(n,r,o,a,l,c,u){const d=new tv(n,r,o,a,l,c);return u&&(d.fu=!0),d}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=Fe(n);ve(Ui,"RemoteStore shutting down."),r.Ia.add(5),await cr(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}Co.provider={build:()=>new Co};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mv{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):ei("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _i="FirestoreClient";class yv{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=xt.UNAUTHENTICATED,this.clientId=Lo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{ve(_i,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(ve(_i,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new zi;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=ra(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function $s(s,t){s.asyncQueue.verifyOperationInProgress(),ve(_i,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await Yh(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{fi("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{ve("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{fi("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function dc(s,t){s.asyncQueue.verifyOperationInProgress();const e=await vv(s);ve(_i,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>oc(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>oc(t.remoteStore,n)),s._onlineComponents=t}async function vv(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){ve(_i,"Using user provided OfflineComponentProvider");try{await $s(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===K.FAILED_PRECONDITION||n.code===K.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;fi("Error using user provided cache. Falling back to memory cache: "+e),await $s(s,new ds)}}else ve(_i,"Using default OfflineComponentProvider"),await $s(s,new gv(void 0));return s._offlineComponents}async function pu(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(ve(_i,"Using user provided OnlineComponentProvider"),await dc(s,s._uninitializedComponentsProvider._online)):(ve(_i,"Using default OnlineComponentProvider"),await dc(s,new Co))),s._onlineComponents}function wv(s){return pu(s).then(t=>t.syncEngine)}async function pc(s){const t=await pu(s),e=t.eventManager;return e.onListen=iv.bind(null,t.syncEngine),e.onUnlisten=sv.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=nv.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=ov.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fu(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fc=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gu="firestore.googleapis.com",gc=!0;class mc{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new ye(K.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=gu,this.ssl=gc}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:gc;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=Zh;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<Ym)throw new ye(K.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Fg("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=fu((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new ye(K.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new ye(K.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new ye(K.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Cs{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new mc({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new ye(K.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new ye(K.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new mc(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new Sg;switch(i.type){case"firstParty":return new Ag(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new ye(K.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=fc.get(e);i&&(ve("ComponentProvider","Removing Datastore"),fc.delete(e),i.terminate())}(this),Promise.resolve()}}function _v(s,t,e,i={}){var n;s=di(s,Cs);const r=Fo(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),l=`${t}:${e}`;r&&($p(`https://${l}`),rf("Firestore",!0)),o.host!==gu&&o.host!==l&&fi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const c=Object.assign(Object.assign({},o),{host:l,ssl:r,emulatorOptions:i});if(!es(c,a)&&(s._setSettings(c),i.mockUserToken)){let u,d;if(typeof i.mockUserToken=="string")u=i.mockUserToken,d=xt.MOCK_USER;else{u=ef(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const p=i.mockUserToken.sub||i.mockUserToken.user_id;if(!p)throw new ye(K.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");d=new xt(p)}s._authCredentials=new Pg(new rh(u,d))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qi{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new qi(this.firestore,t,this._query)}}class lt{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new pi(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new lt(this.firestore,t,this._key)}toJSON(){return{type:lt._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(or(e,lt._jsonSchema))return new lt(t,i||null,new Pe(Ke.fromString(e.referencePath)))}}lt._jsonSchemaVersion="firestore/documentReference/1.0",lt._jsonSchema={type:at("string",lt._jsonSchemaVersion),referencePath:at("string")};class pi extends qi{constructor(t,e,i){super(t,e,jo(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new lt(this.firestore,null,new Pe(t))}withConverter(t){return new pi(this.firestore,t,this._path)}}function yc(s,t,...e){if(s=Gt(s),oh("collection","path",t),s instanceof Cs){const i=Ke.fromString(t,...e);return Rl(i),new pi(s,null,i)}{if(!(s instanceof lt||s instanceof pi))throw new ye(K.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ke.fromString(t,...e));return Rl(i),new pi(s.firestore,null,i)}}function Ro(s,t,...e){if(s=Gt(s),arguments.length===1&&(t=Lo.newId()),oh("doc","path",t),s instanceof Cs){const i=Ke.fromString(t,...e);return Cl(i),new lt(s,null,new Pe(i))}{if(!(s instanceof lt||s instanceof pi))throw new ye(K.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ke.fromString(t,...e));return Cl(i),new lt(s.firestore,s instanceof pi?s.converter:null,new Pe(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vc="AsyncQueue";class wc{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new Qh(this,"async_queue_retry"),this.oc=()=>{const i=Js();i&&ve(vc,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=Js();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=Js();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new zi;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!_n(t))throw t;ve(vc,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,ei("INTERNAL UNHANDLED ERROR: ",_c(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=na.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&Ie(47125,{hc:_c(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function _c(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Tc(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class mn extends Cs{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new wc,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new wc(t),this._firestoreClient=void 0,await t}}}function Tv(s,t){const e=typeof s=="object"?s:fg(),i=typeof s=="string"?s:rs,n=cg(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=Qp("firestore");r&&_v(n,...r)}return n}function mu(s){if(s._terminated)throw new ye(K.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||bv(s),s._firestoreClient}function bv(s){var t,e,i;const n=s._freezeSettings(),r=function(a,l,c,u){return new qg(a,l,c,u.host,u.ssl,u.experimentalForceLongPolling,u.experimentalAutoDetectLongPolling,fu(u.experimentalLongPollingOptions),u.useFetchStreams,u.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new yv(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const l=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(l),_online:l}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class It{constructor(t){this._byteString=t}static fromBase64String(t){try{return new It(wt.fromBase64String(t))}catch(e){throw new ye(K.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new It(wt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:It._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(or(t,It._jsonSchema))return It.fromBase64String(t.bytes)}}It._jsonSchemaVersion="firestore/bytes/1.0",It._jsonSchema={type:at("string",It._jsonSchemaVersion),bytes:at("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rs{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new ye(K.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new vt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class la{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jt{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new ye(K.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new ye(K.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return Ve(this._lat,t._lat)||Ve(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:jt._jsonSchemaVersion}}static fromJSON(t){if(or(t,jt._jsonSchema))return new jt(t.latitude,t.longitude)}}jt._jsonSchemaVersion="firestore/geoPoint/1.0",jt._jsonSchema={type:at("string",jt._jsonSchemaVersion),latitude:at("number"),longitude:at("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wt{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:Wt._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(or(t,Wt._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new Wt(t.vectorValues);throw new ye(K.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}Wt._jsonSchemaVersion="firestore/vectorValue/1.0",Wt._jsonSchema={type:at("string",Wt._jsonSchemaVersion),vectorValues:at("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xv=/^__.*__$/;class Ev{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new xi(t,this.data,this.fieldMask,e,this.fieldTransforms):new ar(t,this.data,e,this.fieldTransforms)}}class yu{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new xi(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function vu(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ie(40011,{Ec:s})}}class ca{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new ca(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return ps(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(vu(this.Ec)&&xv.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class Sv{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||Es(t)}Dc(t,e,i,n=!1){return new ca({Ec:t,methodName:e,bc:i,path:vt.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ha(s){const t=s._freezeSettings(),e=Es(s._databaseId);return new Sv(s._databaseId,!!t.ignoreUndefinedProperties,e)}function Pv(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);ua("Data must be an object, but it was:",o,i);const a=wu(i,o);let l,c;if(r.merge)l=new At(o.fieldMask),c=o.fieldTransforms;else if(r.mergeFields){const u=[];for(const d of r.mergeFields){const p=Ao(t,d,e);if(!o.contains(p))throw new ye(K.INVALID_ARGUMENT,`Field '${p}' is specified in your field mask but missing from your input data.`);Tu(u,p)||u.push(p)}l=new At(u),c=o.fieldTransforms.filter(d=>l.covers(d.field))}else l=null,c=o.fieldTransforms;return new Ev(new Ct(a),l,c)}class As extends la{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof As}}function Cv(s,t,e,i){const n=s.Dc(1,t,e);ua("Data must be an object, but it was:",n,i);const r=[],o=Ct.empty();bi(i,(l,c)=>{const u=da(t,l,e);c=Gt(c);const d=n.gc(u);if(c instanceof As)r.push(u);else{const p=ur(c,d);p!=null&&(r.push(u),o.set(u,p))}});const a=new At(r);return new yu(o,a,n.fieldTransforms)}function Rv(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[Ao(t,i,e)],l=[n];if(r.length%2!=0)throw new ye(K.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let p=0;p<r.length;p+=2)a.push(Ao(t,r[p])),l.push(r[p+1]);const c=[],u=Ct.empty();for(let p=a.length-1;p>=0;--p)if(!Tu(c,a[p])){const m=a[p];let y=l[p];y=Gt(y);const _=o.gc(m);if(y instanceof As)c.push(m);else{const T=ur(y,_);T!=null&&(c.push(m),u.set(m,T))}}const d=new At(c);return new yu(u,d,o.fieldTransforms)}function Av(s,t,e,i=!1){return ur(e,s.Dc(i?4:3,t))}function ur(s,t){if(_u(s=Gt(s)))return ua("Unsupported field value:",t,s),wu(s,t);if(s instanceof la)return function(i,n){if(!vu(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let l=ur(a,n.yc(o));l==null&&(l={nullValue:"NULL_VALUE"}),r.push(l),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=Gt(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return fm(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=Je.fromDate(i);return{timestampValue:cs(n.serializer,r)}}if(i instanceof Je){const r=new Je(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:cs(n.serializer,r)}}if(i instanceof jt)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof It)return{bytesValue:Bh(n.serializer,i._byteString)};if(i instanceof lt){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:Xo(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof Wt)return function(o,a){return{mapValue:{fields:{[gh]:{stringValue:mh},[ss]:{arrayValue:{values:o.toArray().map(c=>{if(typeof c!="number")throw a.wc("VectorValues must only contain numeric values.");return Wo(a.serializer,c)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${gs(i)}`)}(s,t)}function wu(s,t){const e={};return ch(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):bi(s,(i,n)=>{const r=ur(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function _u(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof Je||s instanceof jt||s instanceof It||s instanceof lt||s instanceof la||s instanceof Wt)}function ua(s,t,e){if(!_u(e)||!ah(e)){const i=gs(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function Ao(s,t,e){if((t=Gt(t))instanceof Rs)return t._internalPath;if(typeof t=="string")return da(s,t);throw ps("Field path arguments must be of type string or ",s,!1,void 0,e)}const Iv=new RegExp("[~\\*/\\[\\]]");function da(s,t,e){if(t.search(Iv)>=0)throw ps(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new Rs(...t.split("."))._internalPath}catch{throw ps(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function ps(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let l="";return(r||o)&&(l+=" (found",r&&(l+=` in field ${i}`),o&&(l+=` in document ${n}`),l+=")"),new ye(K.INVALID_ARGUMENT,a+s+l)}function Tu(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bu{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new lt(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new Dv(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Is("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class Dv extends bu{data(){return super.data()}}function Is(s,t){return typeof t=="string"?da(s,t):t instanceof Rs?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mv(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new ye(K.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class pa{}class xu extends pa{}function kv(s,t,...e){let i=[];t instanceof pa&&i.push(t),i=i.concat(e),function(r){const o=r.filter(l=>l instanceof fa).length,a=r.filter(l=>l instanceof Ds).length;if(o>1||o>0&&a>0)throw new ye(K.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class Ds extends xu{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new Ds(t,e,i)}_apply(t){const e=this._parse(t);return Eu(t._query,e),new qi(t.firestore,t.converter,yo(t._query,e))}_parse(t){const e=ha(t.firestore);return function(r,o,a,l,c,u,d){let p;if(c.isKeyField()){if(u==="array-contains"||u==="array-contains-any")throw new ye(K.INVALID_ARGUMENT,`Invalid Query. You can't perform '${u}' queries on documentId().`);if(u==="in"||u==="not-in"){xc(d,u);const y=[];for(const _ of d)y.push(bc(l,r,_));p={arrayValue:{values:y}}}else p=bc(l,r,d)}else u!=="in"&&u!=="not-in"&&u!=="array-contains-any"||xc(d,u),p=Av(a,o,d,u==="in"||u==="not-in");return ot.create(c,u,p)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function Fv(s,t,e){const i=t,n=Is("where",s);return Ds._create(n,i,e)}class fa extends pa{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new fa(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:Nt.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const l of a)Eu(o,l),o=yo(o,l)}(t._query,e),new qi(t.firestore,t.converter,yo(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class ga extends xu{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new ga(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new ye(K.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new ye(K.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new tr(r,o)}(t._query,this._field,this._direction);return new qi(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new Tn(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function Ov(s,t="asc"){const e=t,i=Is("orderBy",s);return ga._create(i,e)}function bc(s,t,e){if(typeof(e=Gt(e))=="string"){if(e==="")throw new ye(K.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Eh(t)&&e.indexOf("/")!==-1)throw new ye(K.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(Ke.fromString(e));if(!Pe.isDocumentKey(i))throw new ye(K.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return Vl(s,new Pe(i))}if(e instanceof lt)return Vl(s,e._key);throw new ye(K.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${gs(e)}.`)}function xc(s,t){if(!Array.isArray(s)||s.length===0)throw new ye(K.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Eu(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new ye(K.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new ye(K.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class Vv{convertValue(t,e="none"){switch(vi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return nt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(yi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw Ie(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return bi(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[ss].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>nt(o.doubleValue));return new Wt(r)}convertGeoPoint(t){return new jt(nt(t.latitude),nt(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=vs(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(Jn(t));default:return null}}convertTimestamp(t){const e=mi(t);return new Je(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=Ke.fromString(t);Ze(Gh(i),9688,{name:t});const n=new $n(i.get(1),i.get(3)),r=new Pe(i.popFirst(5));return n.isEqual(e)||ei(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Lv(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class Nn{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Bi extends bu{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Gr(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(Is("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new ye(K.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=Bi._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}Bi._jsonSchemaVersion="firestore/documentSnapshot/1.0",Bi._jsonSchema={type:at("string",Bi._jsonSchemaVersion),bundleSource:at("string","DocumentSnapshot"),bundleName:at("string"),bundle:at("string")};class Gr extends Bi{data(t={}){return super.data(t)}}class hn{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new Nn(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new Gr(this._firestore,this._userDataWriter,i.key,i,new Nn(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new ye(K.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const l=new Gr(n._firestore,n._userDataWriter,a.doc.key,a.doc,new Nn(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:l,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const l=new Gr(n._firestore,n._userDataWriter,a.doc.key,a.doc,new Nn(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let c=-1,u=-1;return a.type!==0&&(c=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),u=o.indexOf(a.doc.key)),{type:Nv(a.type),doc:l,oldIndex:c,newIndex:u}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new ye(K.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=hn._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=Lo.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function Nv(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ie(61501,{type:s})}}hn._jsonSchemaVersion="firestore/querySnapshot/1.0",hn._jsonSchema={type:at("string",hn._jsonSchemaVersion),bundleSource:at("string","QuerySnapshot"),bundleName:at("string"),bundle:at("string")};class Su extends Vv{constructor(t){super(),this.firestore=t}convertBytes(t){return new It(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new lt(this.firestore,null,e)}}function zv(s,t,e,...i){s=di(s,lt);const n=di(s.firestore,mn),r=ha(n);let o;return o=typeof(t=Gt(t))=="string"||t instanceof Rs?Rv(r,"updateDoc",s._key,t,e,i):Cv(r,"updateDoc",s._key,t),ma(n,[o.toMutation(s._key,Lt.exists(!0))])}function Bv(s){return ma(di(s.firestore,mn),[new qo(s._key,Lt.none())])}function Hv(s,t){const e=di(s.firestore,mn),i=Ro(s),n=Lv(s.converter,t);return ma(e,[Pv(ha(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,Lt.exists(!1))]).then(()=>i)}function Uv(s,...t){var e,i,n;s=Gt(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||Tc(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(Tc(t[o])){const d=t[o];t[o]=(e=d.next)===null||e===void 0?void 0:e.bind(d),t[o+1]=(i=d.error)===null||i===void 0?void 0:i.bind(d),t[o+2]=(n=d.complete)===null||n===void 0?void 0:n.bind(d)}let l,c,u;if(s instanceof lt)c=di(s.firestore,mn),u=jo(s._key.path),l={next:d=>{t[o]&&t[o](jv(c,s,d))},error:t[o+1],complete:t[o+2]};else{const d=di(s,qi);c=di(d.firestore,mn),u=d._query;const p=new Su(c);l={next:m=>{t[o]&&t[o](new hn(c,p,d,m))},error:t[o+1],complete:t[o+2]},Mv(s._query)}return function(p,m,y,_){const T=new mv(_),x=new Qy(m,T,y);return p.asyncQueue.enqueueAndForget(async()=>Zy(await pc(p),x)),()=>{T.Ou(),p.asyncQueue.enqueueAndForget(async()=>Xy(await pc(p),x))}}(mu(c),u,a,l)}function ma(s,t){return function(i,n){const r=new zi;return i.asyncQueue.enqueueAndForget(async()=>av(await wv(i),n,r)),r.promise}(mu(s),t)}function jv(s,t,e){const i=e.docs.get(t._key),n=new Su(s);return new Bi(s,n,t._key,i,new Nn(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){vn=n})(pg),is(new Yn("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new mn(new Cg(i.getProvider("auth-internal")),new Ig(o,i.getProvider("app-check-internal")),function(c,u){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new ye(K.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new $n(c.options.projectId,u)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),ln(bl,xl,t),ln(bl,xl,"esm2017")})();var Wv="firebase",qv="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ln(Wv,qv,"app");const Gv={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},Zv=Xc(Gv),Lr=Tv(Zv);var Xv=O('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),Yv=O("<div style=margin-bottom:12px;>"),Kv=O('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;"> Add feedback'),Qv=O("<div style=margin-top:16px;>"),Jv=O('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),$v=O('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),ew=O('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),tw=O("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;>  </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),iw=O("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),nw=O('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function Ec({updateId:s,updateTitle:t}){const[e,i]=re([]),[n,r]=re(""),[o,a]=re(null),[l,c]=re(""),[u,d]=re(!1),[p,m]=re(localStorage.getItem("feedbackAuthor")||"Deji"),[y,_]=re(!1),[T,x]=re(!1),[V,L]=re(!1);Li(()=>{const E=kv(yc(Lr,"feedbacks"),Fv("updateId","==",s),Ov("timestamp","desc")),P=Uv(E,M=>{const k=[];M.forEach(D=>{k.push({id:D.id,...D.data()})}),i(k)});return()=>P()});const W=async E=>{if(E.preventDefault(),!!n().trim()){d(!0);try{await Hv(yc(Lr,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:p(),timestamp:new Date,edited:!1}),r(""),L(!1)}catch(P){console.error("Error adding feedback:",P)}d(!1)}},J=async E=>{if(l().trim())try{await zv(Ro(Lr,"feedbacks",E),{text:l(),edited:!0,editedAt:new Date}),a(null),c("")}catch(P){console.error("Error editing feedback:",P)}},ee=async E=>{if(confirm("Delete this feedback?"))try{await Bv(Ro(Lr,"feedbacks",E))}catch(P){console.error("Error deleting feedback:",P)}},F=E=>{if(!E)return"";const P=E.toDate?E.toDate():new Date(E),k=new Date-P,D=Math.floor(k/(1e3*60*60));return D<1?"Just now":D<24?`${D} hour${D>1?"s":""} ago`:D<48?"Yesterday":P.toLocaleDateString()};return(()=>{var E=Qv();return Z(E,me(ke,{get when(){return e().length>0},get children(){var P=Yv();return Z(P,me(to,{get each(){return Dt(()=>!!T())()?e():e().slice(0,2)},children:M=>(()=>{var k=$v();return Z(k,me(ke,{get when(){return o()===M.id},get fallback(){return[(()=>{var D=ew();return Z(D,()=>M.text),D})(),(()=>{var D=tw(),I=D.firstChild,Ce=I.firstChild,q=I.nextSibling,ne=q.firstChild,te=ne.nextSibling;return Z(I,()=>M.author,Ce),Z(I,()=>F(M.timestamp),null),Z(I,()=>M.edited&&" (edited)",null),ne.$$click=()=>{a(M.id),c(M.text)},te.$$click=()=>ee(M.id),D})()]},get children(){var D=Jv(),I=D.firstChild,Ce=I.nextSibling,q=Ce.firstChild,ne=q.nextSibling;return I.$$input=te=>c(te.target.value),q.$$click=()=>J(M.id),ne.$$click=()=>{a(null),c("")},Le(()=>I.value=l()),D}})),k})()}),null),Z(P,me(ke,{get when(){return e().length>2},get children(){var M=Xv();return M.$$click=()=>x(!T()),Z(M,(()=>{var k=Dt(()=>!!T());return()=>k()?` Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),M}}),null),P}}),null),Z(E,me(ke,{get when(){return!V()},get fallback(){return(()=>{var P=nw(),M=P.firstChild,k=M.firstChild,D=k.firstChild,I=D.nextSibling,Ce=k.nextSibling,q=M.nextSibling,ne=q.firstChild,te=ne.nextSibling,$=te.firstChild,H=$.nextSibling;return Z(I,p),Ce.$$click=()=>_(!y()),Z(P,me(ke,{get when(){return y()},get children(){var se=iw(),ce=se.firstChild,ue=ce.firstChild,Y=ue.nextSibling;return ue.$$click=()=>{m("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),_(!1)},Y.$$click=()=>{m("Deji"),localStorage.setItem("feedbackAuthor","Deji"),_(!1)},Le(oe=>{var le=`background: ${p()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,_e=`background: ${p()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return oe.e=zn(ue,le,oe.e),oe.t=zn(Y,_e,oe.t),oe},{e:void 0,t:void 0}),se}}),q),q.addEventListener("submit",W),ne.$$input=se=>r(se.target.value),Z($,()=>u()?"Posting...":"Post"),H.$$click=()=>{L(!1),r("")},Le(se=>{var ce=u(),ue=u()||!n().trim(),Y=`background: ${u()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${u()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return ce!==se.e&&(ne.disabled=se.e=ce),ue!==se.t&&($.disabled=se.t=ue),se.a=zn($,Y,se.a),se},{e:void 0,t:void 0,a:void 0}),Le(()=>ne.value=n()),P})()},get children(){var P=Kv();return P.$$click=()=>L(!0),P}}),null),E})()}ii(["click","input"]);var rw=O('<div class="floating-audio-player deji-style"><button class=player-close aria-label="Close player"></button><div class=player-controls><button class=control-button> Last</button><button class=control-button> 15</button><button class="control-button play-pause"></button><button class=control-button>15 </button><button class=control-button>Next </button></div><div class=segment-indicator>Segment <!>/'),sw=O('<div class="floating-audio-player minimal-style"><button class=player-close-minimal aria-label="Close player"></button><div class=player-controls-minimal><button class=control-minimal></button><button class="control-minimal small">-15</button><button class="control-minimal play"></button><button class="control-minimal small">+15</button><button class=control-minimal>'),ow=O('<div class="floating-audio-player floating-style"><button class=player-close-floating aria-label="Close player"></button><div class=player-bar><button class=control-floating></button><button class=control-floating></button><button class="control-floating play-button"></button><button class=control-floating></button><button class=control-floating></button></div><div class=segment-text>/'),aw=O('<div class="floating-audio-player spotify-style"><button class=player-close-spotify aria-label="Close player"></button><div class=spotify-container><div class=spotify-controls><button class=control-spotify></button><button class=control-spotify></button><button class="control-spotify play-spotify"></button><button class=control-spotify></button><button class=control-spotify></button></div><div class=spotify-progress><span class=time-label>0:00</span><div class=progress-bar><div class=progress-fill></div></div><span class=time-label>1:30');function lw(s){const[t,e]=re(!1),[i,n]=re(1),[r]=re(5),[o,a]=re(!1);Li(()=>{s.selectedStyle&&s.selectedStyle()!==null&&(a(!0),console.log("[FloatingAudioPlayer] Showing player with style:",s.selectedStyle()))});const l=()=>{e(!t()),console.log("[FloatingAudioPlayer] Play/Pause toggled:",t())},c=()=>{i()>1&&(n(i()-1),console.log("[FloatingAudioPlayer] Previous segment:",i()))},u=()=>{i()<r()&&(n(i()+1),console.log("[FloatingAudioPlayer] Next segment:",i()))},d=m=>{console.log(`[FloatingAudioPlayer] Skip ${m} seconds`)},p=()=>{a(!1),s.onClose&&s.onClose()};return!o()||!s.selectedStyle||!s.selectedStyle()?null:[me(ke,{get when(){return s.selectedStyle()==="deji"},get children(){var m=rw(),y=m.firstChild,_=y.nextSibling,T=_.firstChild,x=T.nextSibling,V=x.nextSibling,L=V.nextSibling,W=L.nextSibling,J=_.nextSibling,ee=J.firstChild,F=ee.nextSibling;return F.nextSibling,y.$$click=p,T.$$click=c,x.$$click=()=>d(-15),V.$$click=l,Z(V,()=>t()?"":""),L.$$click=()=>d(15),W.$$click=u,Z(J,i,F),Z(J,r,null),m}}),me(ke,{get when(){return s.selectedStyle()==="minimal"},get children(){var m=sw(),y=m.firstChild,_=y.nextSibling,T=_.firstChild,x=T.nextSibling,V=x.nextSibling,L=V.nextSibling,W=L.nextSibling;return y.$$click=p,T.$$click=c,x.$$click=()=>d(-15),V.$$click=l,Z(V,()=>t()?"":""),L.$$click=()=>d(15),W.$$click=u,m}}),me(ke,{get when(){return s.selectedStyle()==="floating"},get children(){var m=ow(),y=m.firstChild,_=y.nextSibling,T=_.firstChild,x=T.nextSibling,V=x.nextSibling,L=V.nextSibling,W=L.nextSibling,J=_.nextSibling,ee=J.firstChild;return y.$$click=p,T.$$click=c,x.$$click=()=>d(-15),V.$$click=l,Z(V,()=>t()?"":""),L.$$click=()=>d(15),W.$$click=u,Z(J,i,ee),Z(J,r,null),m}}),me(ke,{get when(){return s.selectedStyle()==="spotify"},get children(){var m=aw(),y=m.firstChild,_=y.nextSibling,T=_.firstChild,x=T.firstChild,V=x.nextSibling,L=V.nextSibling,W=L.nextSibling,J=W.nextSibling,ee=T.nextSibling,F=ee.firstChild,E=F.nextSibling,P=E.firstChild;return y.$$click=p,x.$$click=c,V.$$click=()=>d(-15),L.$$click=l,Z(L,()=>t()?"":""),W.$$click=()=>d(15),J.$$click=u,Le(M=>(M=`${i()/r()*100}%`)!=null?P.style.setProperty("width",M):P.style.removeProperty("width")),m}})]}ii(["click"]);var cw=O("<p>Fixed a bug that was breaking the tap-to-reveal feature on mobile after a few uses. The app was essentially forgetting to clean up after itself, causing it to stop working entirely."),Sc=O("<h4>What was happening"),hw=O("<p><strong>The problem:</strong> After tapping 3-4 times to reveal hotspots, nothing would appear anymore. You had to reload the page to get it working again.<br><strong>Why it happened:</strong> The app was creating invisible timers that never got cleared, like setting multiple alarms but forgetting which ones you set. These orphaned timers would interfere with new reveals."),uw=O("<h4>The fix"),dw=O("<p>Now the app properly tracks and cleans up all timers. You can tap and reveal hotspots indefinitely without any degradation. Mobile exploration is finally stable for extended sessions."),pw=O("<div><h4>Audio feedback (Mobile only)</h4><p>Added subtle sound effects and haptic vibrations on mobile devices to enhance the tactile experience. You'll now hear soft audio cues and feel gentle vibrations when revealing hotspots (100ms pulse) and clicking on them (120ms pulse), making the exploration feel more immersive."),fw=O('<p>Added an experimental "Ripple" exploration mode for mobile that reveals hotspots in an expanding pattern from where you tap. Just a weekend side project I wanted to try out.'),$i=O("<h4>What's new"),gw=O(`<p>Tap anywhere and hotspots appear in a ripple effect around your touch point - like sonar discovering what's hidden nearby. You can switch between "Focus" (one hotspot) and "Ripple" exploration modes using the debug button (bottom left corner).`),mw=O("<h4>Known issues"),yw=O("<p>This is very experimental. Currently reveals way too many hotspots (sometimes 30+) and the visual effect is chaotic rather than elegant. The animations need refinement."),vw=O("<h4>Why test this"),ww=O("<p>Testing if can we show 3-5 hotspots per tap in an elegant way without overwhelming users. Experimenting with finding the balance between helpful context and visual clarity for those tiny hotspots that single-tap might miss."),_w=O("<h4>Four critical improvements today"),Tw=O("<p><strong>1. Mobile fade finally works:</strong> Fixed the spotlight darkening that was stuck on mobile devices. The black overlay around hotspots now fades progressively when you pinch to zoom out on iPad, iPhone, and Android. I discovered that mobile browsers handle touch gestures differently than desktop, so I rewrote the entire fade system to work with how mobile devices actually track your finger movements."),bw=O("<p><strong>2. Instant fade response:</strong> The fade now begins immediately when you start zooming out. Previously, you had to pinch excessively before seeing any change - this delay is now completely eliminated."),xw=O("<p><strong>3. Clean transitions:</strong> Fixed the lingering white borders that would sometimes remain visible after the spotlight effect ended. All visual elements now synchronize properly for seamless transitions."),Ew=O("<p><strong>4. iPad clarity restored:</strong> Resolved the severe pixelation that was occurring during zoom and pan on iPad. The artwork now maintains crisp quality during all interactions while preserving smooth 30+ FPS performance."),Sw=O("<p><em>These fixes resolve all known mobile spotlight issues. The experience is now consistent and polished across every device."),Pw=O("<h4>1. Fixed a stability issue"),Cw=O("<p>Discovered and fixed a bug where hotspot animations could stop working after multiple page refreshes. The issue was that old animation code was accumulating in the browser's memory. The app now properly cleans itself up between page loads, preventing any animation glitches."),Rw=O("<h4>2. Google Sheets pipeline is ready"),Aw=O("<p>I've completed the pipeline to sync your Excel data. All 5 sheets (hotspots, journeys, gallery, overrides, settings) are mapped correctly with the 93 fields you defined. The app currently uses about 15% of these fields, but the pipeline preserves all of them for future features. Once you send me the Google Sheets credentials, you'll be able to update content directly in your spreadsheet, and I'll handle syncing the changes to the app when needed."),Iw=O("<p><em>The app is running smoothly and ready for the next phase with Google Sheets integration."),Dw=O('<p>Added a new "single" reveal mode for mobile that shows only the closest hotspot when tapping, addressing feedback about multiple hotspots being confusing.'),Mw=O("<p><strong>Single mode (default on mobile)</strong><br>When you tap the screen, only the single closest hotspot is revealed instead of multiple hotspots in a radius. This makes the experience less overwhelming and more focused."),kw=O("<p><strong>Multiple mode (optional)</strong><br>The original behavior of revealing multiple hotspots is still available for users who prefer seeing more context at once."),Fw=O('<p><strong>Debug panel toggle</strong><br>Added a new "Reveal" section to the mobile debug panel where users can switch between different reveal modes. The preference is saved and persists between sessions.'),Ow=O("<p><em>Note: The visual styling hasn't been refined yet - this is a functional implementation to test the concept. The animations and visual feedback will be polished based on user feedback."),Vw=O("<p><strong>iPhone black line:</strong> Fixed! The horizontal black line at the bottom is gone. Issue was with canvas sizing calculations on iOS."),Lw=O("<p><strong>iPad performance:</strong> Improved significantly. Now auto-detects iPad model and adjusts performance settings accordingly. Resolution catches up faster when zooming."),Nw=O("<p><strong>Known issue:</strong> Tiles sometimes flicker on iPad (reload too often). Working on this next."),zw=O("<p>Focused on making the viewer faster and more responsive, especially on phones. You should notice smoother panning and zooming now."),Pc=O("<h4>What's better"),Bw=O("<p><strong>Mobile performance:</strong> Significantly improved how the viewer handles touch navigation.<br><strong>Smooth transitions:</strong> Added subtle fade effects that make exploring feel more fluid.<br><strong>Safari fixes:</strong> Resolved the visual issues that were happening on Apple devices."),Hw=O("<p><em>A week of under-the-hood improvements. Nothing flashy, but everything should feel more solid."),Uw=O("<p>Made significant progress on mobile performance, particularly for panning and zooming. The viewer now feels noticeably more responsive when navigating the artwork on phones and tablets."),jw=O("<p><strong>Smoother panning:</strong> Dragging to explore the artwork now maintains better frame rates and feels more fluid.<br><strong>Responsive zoom:</strong> Pinch-to-zoom and double-tap zoom are more responsive with less lag.<br><strong>Smarter tile loading:</strong> The viewer now loads the right image tiles at the right time, reducing stuttering during navigation.<br><strong>Network adaptation:</strong> On slower connections, the viewer automatically adjusts quality to maintain smooth performance."),Cc=O("<h4>Technical improvements"),Ww=O("<p>We've implemented several optimizations including spatial indexing for faster hotspot detection, intelligent caching for better memory usage, and GPU-accelerated rendering for smoother animations. These changes lay the groundwork for future improvements."),qw=O("<h4>Work in progress"),Gw=O("<p>While navigation is much improved, there's still work to be done. The cinematic zoom animations need refinement, and overall performance can be pushed further. We're continuing to optimize for that perfect, buttery-smooth experience across all devices."),Zw=O("<p><em>Performance optimization is an ongoing journey. Each improvement gets us closer to the ideal experience, and your feedback helps identify what to prioritize next."),Xw=O("<p>Added a ripple effect when tapping on mobile devices. Now when you tap anywhere on the screen, you'll see a subtle expanding circle that helps confirm your touch was registered."),Yw=O("<p><strong>Visual feedback:</strong> A gentle white ripple emanates from your tap location, making the interface feel more responsive.<br><strong>Hotspot revealing:</strong> The ripple helps you discover hidden hotspots - up to 10 nearby hotspots briefly appear with a staggered animation.<br><strong>Touch confirmation:</strong> Especially helpful on dense areas of the artwork where you might wonder if your tap registered."),Kw=O("<h4>Technical details"),Qw=O("<p>The ripple expands to 200 pixels and reveals hotspots within that radius. Each hotspot appears with a 30ms delay, creating a smooth cascade effect. The entire sequence lasts 2 seconds before fading away."),Jw=O("<p><em>This makes exploring the artwork on phones and tablets feel more intuitive and satisfying."),$w=O("<p>Enhanced the hotspot stroke animation with authentic pigment liner characteristics inspired by your original artwork. The hover effects now better match the organic, hand-drawn quality of your pen work."),e_=O("<p><strong>Authentic pigment colors:</strong> Three color variants (neutral, warm, cool) that mirror real BlackPigment liner pens used in traditional ink work.<br><strong>Organic texture effects:</strong> Subtle micro-blur and grain that recreate the natural imperfections of physical ink on paper.<br><strong>Enhanced visibility:</strong> Improved contrast and brightness while maintaining the authentic look of hand-drawn lines."),t_=O("<p><strong>Adaptive animation system:</strong> Three-speed animation levels that respond to zoom depth that brings the strokes to life."),i_=O("<p>The stroke animation now starts from a different point each time you hover over a hotspot. Small detail, but it adds to the organic feel we've been building."),Nr=O("<h4>What changed"),n_=O("<p><strong>Random starting points:</strong> Each hover animation begins from a different position on the shape's outline.<br><strong>Safari compatibility:</strong> Fixed the implementation to work properly on Safari and iOS devices."),r_=O("<p>Together with yesterday's timing variations, each hotspot interaction now feels more natural and less repetitive."),s_=O("<p>Added subtle variations to animations to make them feel more organic and hand-drawn. Each hotspot now reveals with its own unique character, preventing the repetitive feel of identical animations."),o_=O("<p><strong>Timing variations:</strong> Each animation has a slightly different speed (10% variation), making the reveals feel more natural.<br><strong>Curve adjustments:</strong> The animation curves are subtly varied for each hotspot, creating unique motion personalities.<br><strong>Organic feel:</strong> As you explore and hover over different hotspots, each one feels hand-drawn and unique rather than computer-generated."),a_=O("<h4>Why it matters"),l_=O("<p>When you hover over different hotspots throughout your exploration, each one now feels unique rather than repetitive. Every animation has its own rhythm and flow, creating a more artistic and engaging experience. It's a small detail that makes a big difference in how alive the artwork feels."),c_=O('<p>These micro-variations are subtle enough to feel natural but significant enough to eliminate the "robot" feeling from animations.'),h_=O("<p>Refined the button controls and zoom behavior based on user feedback. The viewing experience is now more intuitive and responsive across all devices."),u_=O("<h4>Button improvements"),d_=O("<p><strong>Better positioning:</strong> Buttons are now optimally placed on both landscape and portrait orientations.<br><strong>Visual refinements:</strong> Updated button styles for better visibility and a more modern look.<br><strong>Touch targets:</strong> Improved button sizes and spacing for easier interaction on mobile devices."),p_=O("<h4>Zoom enhancements"),f_=O("<p><strong>Cinematic zoom:</strong> Smoother, more natural zoom animations when clicking on hotspots.<br><strong>Mouse wheel support:</strong> You can now zoom in and out using your mouse wheel or trackpad for precise control.<br><strong>Improved performance:</strong> Zoom operations are now more fluid, especially on mobile devices."),g_=O("<p>These improvements make navigation feel more natural and give you better control over your viewing experience. The combination of refined buttons and enhanced zoom creates a more professional and polished interface."),m_=O("<p>Completed a significant restructuring of the hotspot rendering system. The code is now much more organized and maintainable, which means faster improvements and easier bug fixes going forward."),y_=O("<h4>What changed under the hood"),v_=O("<p>Split the renderer file into smaller, focused modules. Each piece now handles one specific job - animations, Safari compatibility, performance optimization, etc. It's like organizing a cluttered workshop where every tool now has its proper place."),w_=O("<h4>What this means for you"),__=O("<p><strong>More reliable performance:</strong> The rendering system is now more efficient and predictable.<br><strong>Easier updates:</strong> Adding new features or fixing issues is now much simpler.<br><strong>Better stability:</strong> Less chance of one change breaking something else."),T_=O("<p>Everything should work exactly as before - this was purely about making the code cleaner and more professional. If you notice any differences in behavior, please let me know!"),b_=O("<p>Fixed the annoying flickering issue that occurred at the end of cinematic zoom animations. The zoom transitions are now smooth and stable across all platforms."),x_=O("<p>When zooming to a hotspot or expanding to full view, the animation would flicker between two zoom levels during the final moments. This was caused by conflicting optimization systems fighting for control."),E_=O("<h4>The complete solution"),S_=O("<p>The flickering issue is now mostly resolved, but a complete fix still requires switching renderers once. This is a known initialization issue that we're investigating."),P_=O(`<p><strong>Temporary workaround:</strong> If you still see flickering, press 'C' to open debug menu, click "Soft Glow" then "Sharp Outline" to fully eliminate the issue.`),C_=O("<p><strong>Alternative:</strong> Type <code>fixFlickering()</code> in the browser console."),R_=O("<ol><li><strong>Applied TileCascadeFix at startup</strong> - Prevents tile cascade issues</li><li><strong>Implemented CinematicZoomManager</strong> - Coordinates all zoom animations with proper damping</li><li><strong>Added forceRedraw() calls</strong> - Ensures the viewer refreshes properly after animations</li><li><strong>State reset after initialization</strong> - Attempts to clean up any initialization issues"),A_=O("<p><strong>Desktop:</strong> 1.0s animation with 6.5 spring stiffness<br><strong>Mobile:</strong> 1.2s animation with 8.0 spring stiffness<br><strong>Cinematic mode:</strong> Temporarily disables tile optimizations during zoom"),I_=O("<p><em>The difference is immediately noticeable - zoom animations now feel professional and polished, matching the quality of the rest of the viewer."),D_=O('<p>Removed the complex "Zoom Performance" section from the debug menu to simplify the interface.'),M_=O("<p>The debug menu now focuses on essential controls for visual customization, interaction behavior, and hotspot discovery. Advanced zoom tuning parameters have been removed as they were rarely used and added unnecessary complexity."),k_=O("<p><em>The artwork already performs at 60 FPS with the default settings, making manual tuning unnecessary for most users."),F_=O("<p>Fixed the issue where Playwright manual tests weren't opening a visible browser window. The tests were running in headless mode by default."),O_=O("<p>Added the <code>--headed</code> option to all manual test scripts. Now when you run tests for Safari or mobile debugging, an actual browser window will open for visual inspection."),V_=O("<h4>Available test commands"),L_=O("<p><strong>Safari Desktop Manual Test:</strong><br><code>npm run test:safari-desktop</code><br>Opens webkit browser for desktop Safari testing with debug overlays."),N_=O("<p><strong>iOS Safari Manual Test:</strong><br><code>npm run test:ios-safari</code><br>Opens webkit browser for mobile Safari testing."),z_=O("<p><strong>Direct command with options:</strong><br><code>npx playwright test tests/safari-desktop-manual-test.spec.js --project=webkit --headed"),B_=O("<p><em>The test window stays open for 10 minutes to allow thorough manual testing. Press Ctrl+C to stop the test when done."),H_=O("<p>Fixed a visual issue where the artwork was displaying grainy artifacts. The monochrome drawings now render cleanly at all zoom levels."),U_=O("<p>The image had a noisy, pixelated appearance that was distracting. Adjusted the rendering settings to better handle black and white artwork - the difference is quite striking."),j_=O("<p>Fixed several mobile-specific issues that were affecting the zoom experience and made the debug controls more reliable across all devices."),W_=O("<h4>Mobile zoom improvements"),q_=O("<p><strong>Smoother zooming</strong><br>The cinematic zoom when tapping hotspots now performs better on phones and tablets. Reduced stuttering during the animation and improved frame rates on lower-end devices."),G_=O("<p><strong>Touch responsiveness</strong><br>Fixed an issue where hotspots would sometimes become unresponsive after zooming. Touch interactions now reset properly after each zoom animation completes."),Z_=O("<h4>Debug panel refinements"),X_=O("<p>Made the mobile debug controls more stable - the slide-up panel now opens and closes more reliably, and the FPS counter updates consistently. Also improved the visual spacing on smaller screens."),Y_=O("<p><em>Small but important fixes that should make the mobile experience feel more polished and responsive."),K_=O("<p>The debug controls (press 'C' to open) now work on phones and tablets."),Q_=O("<p><strong>Mobile devices</strong><br>A compact bar at the bottom shows FPS and a settings icon. Tap it to reveal controls that slide up. Swipe down or tap outside to dismiss."),J_=O("<p><strong>Desktop</strong><br>The panel can now be minimized to a small floating button instead of closing completely."),$_=O("<p><em>Small quality-of-life improvement, but it makes testing on different devices much more pleasant!"),e0=O("<p>The experimental touch-hold system I mentioned yesterday is now more reliable. After testing, I found and fixed an issue where hotspots would sometimes stop responding after being activated once."),t0=O("<h4>What's improved"),i0=O(`<p>If you enable "Temporal" mode in the debug menu (press 'C'), the hold-to-interact system now works consistently. Hotspots stay visible while you hold them, and each interaction resets cleanly for the next one.`),n0=O("<h4>Also tweaked"),r0=O("<p>Added white color options to the border palette since you're working with black ink artwork. More importantly, <strong>temporal mode is now the default on mobile devices</strong> - meaning visitors will use the hold-to-interact system instead of direct taps. You can always switch back to standard tap-to-zoom in the debug menu if needed."),s0=O("<p>With ~600 interactive zones hidden throughout your artwork, I've added a way to briefly reveal what's clickable without disrupting the visual experience."),o0=O("<h4>How it works"),a0=O("<p>Press 'H' (desktop) or triple-tap anywhere (mobile) to make all nearby hotspots gently pulse for 6 seconds. The effect uses contrast inversion to ensure visibility on your black ink artwork while staying subtle enough not to break immersion."),l0=O("<h4>Also included: Alternative touch controls"),c0=O(`<p>For mobile users, I've prepared an experimental hold-to-interact system that's currently tucked away in the debug menu. If you're curious, press 'C' to open debug options and switch from "Direct" to "Temporal" interaction. This changes how taps work - but the standard tap-to-zoom remains the default for now.`),h0=O("<p>The reveal helper should make exploration feel less like guesswork and more like discovery. Let me know if the visibility needs adjusting - it's easy to make it bolder or more subtle based on your preference."),u0=O("<p><strong>Safari animations:</strong> Now working! Chrome/Firefox/Edge still have the edge visually, but Safari's functional. Requires Safari 13.1+ (2020 or newer)."),d0=O("<p><strong>Smart zoom behavior:</strong> Following Google Arts & Culture's approach, animations now adapt to zoom level. Below 8x zoom = full animations. Above 8x = quick 150ms transitions only. When you're examining details up close, decorative animations would just distract."),p0=O("<p><strong>Next:</strong> Making the cinematic zoom buttery smooth when clicking hotspots. Also thinking the stroke animation makes sense for desktop, but mobile needs something snappier."),f0=O("<p><em>Personal note: Getting really excited - it's starting to take shape! :D"),g0=O("<p><strong>Current status:</strong> While the hover animations now work on Safari, the visual effect isn't as pronounced as on Chrome/Firefox. I'm quite proud of the result on chrome at the moment. I think it's quite satisfying."),m0=O("<p><strong>Recommendation:</strong> Use Chrome for now to see the intended visual impact. The difference is noticeable - Chrome displays richer glows and better depth."),y0=O("<p><strong>What's next:</strong> Working on Safari-specific optimizations to improve the visual quality without compromising performance."),v0=O("<p><strong>Following up on July 7th:</strong> The Safari issue is fixed! The stroke reveal animation now works properly on Safari desktop where you can actually hover."),w0=O("<p><strong>Next up</strong>: Making the animation more visible and impactful for desktop users, plus exploring touch-friendly animations for mobile devices."),_0=O("<p><strong>Responding to your feedback:</strong> You mentioned the hover effect felt static with just the white border appearing. I've implemented a first animation to bring more life to the interactions."),T0=O(`<p><strong>What's new:</strong> A stroke reveal animation that progressively traces the hotspot outline when you hover. Instead of the border just "popping" into view, it now draws itself smoothly around the shape - like watching someone trace the contour with a pen.`),b0=O("<p><strong>Current settings:</strong><br> White stroke with subtle shadow for visibility<br> 1.2 second drawing animation<br> Works on Chrome, Firefox, and Edge"),x0=O("<p><strong>Needs refinement:</strong> The animation is quite subtle right now - you might have to look closely to see the progressive drawing effect. I'll be adjusting the timing and visibility to make it more noticeable and satisfying."),E0=O("<p><strong>Safari issue discovered:</strong> Just noticed the animation isn't working properly on Safari (There's always something with Safari ). Will fix this tomorrow along with the other refinements."),S0=O("<p><strong>Note:</strong> This is one hover effect I wanted to try first. I'm planning to experiment with additional animations to find what feels best for your artwork. Let me know your thoughts!"),P0=O("<p><strong>What's improved:</strong> The circular spotlight effect in Apple Mode (Safari/iOS) now adapts much better to different hotspot shapes."),C0=O("<p><strong>What changed:</strong><br> Spotlights are now tighter and more focused around each hotspot (both mobile and desktop)<br> Better detection of when to use circles vs ellipses based on hotspot shape"),R0=O("<p><strong>The result:</strong> Whether a hotspot is round, tall, wide, or irregular, the spotlight should now feel more natural and better frame the content the user is exploring."),A0=O("<p>Try clicking on different shaped hotspots - the spotlight should feel more consistent and purposeful now!"),I0=O("<p><strong>The issue:</strong> Some complex hotspots still extend outside the spotlight area after yesterday's improvements."),D0=O("<p><strong>Today's attempt:</strong> Since a single circular spotlight can't perfectly cover irregular shapes, I tried combining multiple circles at different positions to fill in the gaps. Unfortunately, Safari doesn't support this technique - it only displays one spotlight instead of blending them together like other browsers do."),M0=O("<p><strong>Next:</strong> Fine-tuning the spotlight sizing parameters to better fit each hotspot's unique shape."),k0=O("<p><strong>What's improved:</strong> The spotlight effect on Safari and iOS devices now much better matches the actual hotspot shapes, especially on desktop Safari!"),F0=O("<p><strong>Key changes:</strong><br> Spotlights now use elliptical shapes for elongated hotspots<br> Tighter, more precise spotlight coverage that follows the hotspot boundaries closely<br> Better visual consistency between the outline of the hotspot and the darkened area<br> Desktop Safari shows the most dramatic improvements, mobile iOS continues to be refined"),O0=O("<p><strong>Still fine-tuning:</strong> Some complex hotspots have small areas that peek slightly outside the spotlight. Mobile Safari needs additional optimization for the same precision as desktop."),V0=O("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),L0=O('<p><strong>How it works:</strong><br> Type your feedback in the text box below any update<br> Click "Post Feedback" to send<br> Edit or delete your comments anytime<br> Everything syncs in real-time between us'),N0=O('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),z0=O("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),B0=O("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),H0=O("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),U0=O("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),j0=O("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),W0=O("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),q0=O("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),G0=O("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br> Uses radial gradient masks instead of polygon cutouts<br> Provides a circular/elliptical spotlight effect around hotspots<br> Maintains smooth 60 FPS performance on all iOS devices"),Z0=O("<p><strong>What's Different:</strong><br> <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br> <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),X0=O("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),Y0=O("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),K0=O("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),Q0=O("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br> iPhone (Safari & Chrome)<br> iPad (Safari & Chrome)<br> Mac (Safari only - Chrome works fine!)"),J0=O("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),$0=O("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),eT=O("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),tT=O("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),iT=O("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),nT=O("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),rT=O(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now  `),sT=O("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),oT=O(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),aT=O("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),lT=O("<p>Hey Deji! "),cT=O("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),hT=O("<p>I totally relate to your potato mode confession  We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),uT=O("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable  I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),dT=O(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),pT=O("<p>Looking forward to showing you the improvements!<br>- Leonard"),fT=O('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),gT=O(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn></button></div><style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style><div class=message-toggle><button class=toggle-btn>`),Rc=O("<div class=update-section><h4> (<!>)"),mT=O("<div class=app-container>"),yT=O("<div class=loading-screen><p>Loading Interactive Art Diary...");function vT({onClose:s}){const[t,e]=re(!1);re(!1);const i=[{id:"memory-leak-fix-september10",date:"September 10",title:" Critical Mobile Fix",content:[cw(),Sc(),hw(),uw(),dw(),(()=>{var o=pw(),a=o.firstChild,l=a.nextSibling;return o.style.setProperty("background","linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(196, 181, 253, 0.1) 100%)"),o.style.setProperty("padding","16px"),o.style.setProperty("borderRadius","8px"),o.style.setProperty("border","1px solid rgba(147, 51, 234, 0.2)"),o.style.setProperty("marginTop","16px"),a.style.setProperty("color","#8b5cf6"),a.style.setProperty("margin","0 0 12px 0"),l.style.setProperty("color","#8b5cf6"),l.style.setProperty("margin","0"),o})()]},{id:"ripple-mode-september07",date:"September 7",title:" Experimental Ripple Mode for Mobile",content:[fw(),$i(),gw(),mw(),yw(),vw(),ww()]},{id:"performance-fix-september03",date:"September 3",title:" Major iPad Performance & Mobile Fade Fix",content:[_w(),Tw(),bw(),xw(),Ew(),Sw()]},{id:"cache-fix-september01",date:"September 1",title:" Animation Fix & Google Sheets Ready",content:[Pw(),Cw(),Rw(),Aw(),Iw()]},{id:"single-reveal-august29",date:"August 29",title:" Single Hotspot Reveal Mode",content:[Dw(),$i(),Mw(),kw(),Fw(),Ow()]},{id:"ios-fixes-august28",date:"August 28",title:" iOS Bug Fixes",content:[Vw(),Lw(),Nw()]},{id:"week-achievements-august14",date:"August 14",title:" Performance Week",content:[zw(),Pc(),Bw(),Hw()]},{id:"mobile-performance-august9",date:"August 7",title:" Mobile Performance Improvements",content:[Uw(),Pc(),jw(),Cc(),Ww(),qw(),Gw(),Zw()]},{id:"mobile-ripple-august1",date:"August 1",title:" Mobile Touch Feedback",content:[Xw(),$i(),Yw(),Kw(),Qw(),Jw()]},{id:"pigment-liner-improvements-july28",date:"July 28",title:" Authentic Pigment Liner Effects",content:[$w(),$i(),e_(),t_()]},{id:"random-trace-points-july27",date:"July 27",title:" Random Drawing Points",content:[i_(),Nr(),n_(),r_()]},{id:"organic-animations-july26",date:"July 26",title:" Natural Animation Variations",content:[s_(),$i(),o_(),a_(),l_(),c_()]},{id:"button-zoom-improvements-july25",date:"July 25",title:" Button Controls & Zoom Improvements",content:[h_(),u_(),d_(),p_(),f_(),g_()]},{id:"architecture-refactor-july24",date:"July 24",title:" Major Architecture Improvements",content:[m_(),y_(),v_(),w_(),__(),T_()]},{id:"cinematic-zoom-fix-july16",date:"July 16",title:" Cinematic Zoom Fixed - No More Flickering",content:[b_(),Sc(),x_(),E_(),S_(),P_(),C_(),R_(),Cc(),A_(),I_()]},{id:"debug-menu-cleanup-july15",date:"July 15",title:" Debug Menu Simplified",content:[D_(),Nr(),M_(),k_()]},{id:"playwright-manual-tests-july15",date:"July 15",title:" Manual Test Window Fix for Playwright",content:[F_(),Nr(),O_(),V_(),L_(),N_(),z_(),B_()]},{id:"visual-artifacts-july15",date:"July 15",title:" Visual Quality Fix - No More Grain",content:[H_(),Nr(),U_()]},{id:"mobile-zoom-july14",date:"July 14",title:" Mobile Zoom Performance & Debug Improvements",content:[j_(),W_(),q_(),G_(),Z_(),X_(),Y_()]},{id:"debug-panel-july13",date:"July 13",title:" Control Panel Goes Mobile-Friendly",content:[K_(),$i(),Q_(),J_(),$_()]},{id:"temporal-polish-july12",date:"July 12",title:" Mobile Touch Controls Refined",content:[e0(),t0(),i0(),n0(),r0()]},{id:"reveal-mode-july11",date:"July 11",title:" Easier Mobile Exploration",content:[s0(),o0(),a0(),l0(),c0(),h0()]},{id:"safari-compatibility-july10",date:"July 10",title:" Safari Compatibility & Smart Zoom Update",content:[u0(),d0(),p0(),f0()]},{id:"safari-visual-july9",date:"July 9",title:"Visual Effects - Browser Differences",content:[g0(),m0(),y0()]},{id:"safari-fix-july8",date:"July 8",title:" Safari Issue Resolved",content:[v0(),w0()]},{id:"hover-animations-july7",date:"July 7 - night",title:" Hover Animation Update",content:[_0(),T0(),b0(),x0(),E0(),S0()]},{id:"spotlight-refinements-july7",date:"July 7",title:" Apple Mode Spotlight Improvements",content:[P0(),C0(),R0(),A0()]},{id:"spotlight-coverage-july5",date:"July 5",title:" Working on Complete Hotspot Coverage for Safari/iOS",content:[I0(),D0(),M0()]},{id:"spotlight-improvements-july4",date:"July 4",title:" Spotlight Effect Improvements for Safari/iOS",content:[k0(),F0(),O0()]},{id:"feedback-system-july3",date:"July 3 - night",title:" New: Direct Feedback System",content:[V0(),L0(),N0(),z0()]},{id:"border-experiment-july3",date:"July 3",title:" Border Experiment for Apple Mode",content:[B0(),H0(),U0(),j0(),W0()]},{id:"safari-solution-july2",date:"July 2",title:" Safari/iOS Spotlight Solution Implemented",content:[q0(),G0(),Z0(),X0(),Y0()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:" Spotlight Effect - Browser Compatibility",content:[K0(),Q0(),J0(),$0(),eT(),tT()]},{id:"zoom-speed-july1",date:"July 1",title:" Zoom Speed Control & Performance Update",content:[iT(),nT(),rT(),sT()]},{id:"performance-june30",date:"June 30",title:" Performance Breakthrough",content:oT()},{id:"focus-mode-june29",date:"June 29",title:" New Feature",content:aT()},{id:"personal-june28",date:"June 28",title:" Personal Message",content:[lT(),cT(),hT(),uT(),dT(),pT()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=gT(),a=o.firstChild,l=a.firstChild,c=l.nextSibling,u=a.nextSibling,d=u.nextSibling,p=d.firstChild;return sd(c,"click",s),Z(o,()=>n.map(m=>(()=>{var y=Rc(),_=y.firstChild,T=_.firstChild,x=T.nextSibling;return x.nextSibling,Z(_,()=>m.title,T),Z(_,()=>m.date,x),Z(y,()=>m.content,null),Z(y,me(Ec,{get updateId(){return m.id},get updateTitle(){return m.title}}),null),y})()),d),p.$$click=()=>e(!t()),Z(p,()=>t()?" Hide previous updates":"+ Show previous updates"),Z(o,me(ke,{get when(){return t()},get children(){var m=fT();return m.firstChild,Z(m,()=>r.map(y=>(()=>{var _=Rc(),T=_.firstChild,x=T.firstChild,V=x.nextSibling;return V.nextSibling,Z(T,()=>y.title,x),Z(T,()=>y.date,V),Z(_,()=>y.content,null),Z(_,me(Ec,{get updateId(){return y.id},get updateTitle(){return y.title}}),null),_})()),null),m}}),null),o})()}function wT(){const[s,t]=re(!1),[e]=re("zebra"),[i,n]=re(!0),[r,o]=re(null);window.setGlobalAudioPlayerStyle=o;const a=()=>{n(!1)};return Yr(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var l=mT();return Z(l,(()=>{var c=Dt(()=>!!i());return()=>c()&&me(vT,{onClose:a})})(),null),Z(l,(()=>{var c=Dt(()=>!!s());return()=>c()?me(Bp,{get artworkId(){return e()}}):yT()})(),null),Z(l,me(lw,{selectedStyle:r,onClose:()=>o(null)}),null),l})()}ii(["click"]);const _T=document.getElementById("root");rd(()=>me(wT,{}),_T);export{ft as O,Br as _,xT as a,ST as b,ud as c,ai as d,Mo as e,dd as f,cd as g,Ge as i,ET as r};
