var Bu=Object.defineProperty;var Hu=(s,t,e)=>t in s?Bu(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var bn=(s,t,e)=>Hu(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const Nu=!1,zu=(s,t)=>s===t,Uu=Symbol("solid-track"),fs={equals:zu};let Cc=Mc;const Xi=1,ms=2,Ac={owned:null,cleanups:null,context:null,owner:null};var At=null;let ro=null,ju=null,bt=null,Wt=null,Ti=null,Os=0;function as(s,t){const e=bt,i=At,n=s.length===0,r=t===void 0?i:t,o=n?Ac:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>ai(()=>vr(o)));At=o,bt=null;try{return Ar(a,!0)}finally{bt=e,At=i}}function he(s,t){t=t?Object.assign({},fs,t):fs;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),Ic(e,n));return[Rc.bind(e),i]}function je(s,t,e){const i=Zo(s,t,!1,Xi);Cr(i)}function nn(s,t,e){Cc=Zu;const i=Zo(s,t,!1,Xi);i.user=!0,Ti?Ti.push(i):Cr(i)}function si(s,t,e){e=e?Object.assign({},fs,e):fs;const i=Zo(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,Cr(i),Rc.bind(i)}function ai(s){if(bt===null)return s();const t=bt;bt=null;try{return s()}finally{bt=t}}function Fs(s){nn(()=>ai(s))}function an(s){return At===null||(At.cleanups===null?At.cleanups=[s]:At.cleanups.push(s)),s}function qu(s){const t=si(s),e=si(()=>wo(t()));return e.toArray=()=>{const i=e();return Array.isArray(i)?i:i!=null?[i]:[]},e}function Rc(){if(this.sources&&this.state)if(this.state===Xi)Cr(this);else{const s=Wt;Wt=null,Ar(()=>vs(this),!1),Wt=s}if(bt){const s=this.observers?this.observers.length:0;bt.sources?(bt.sources.push(this),bt.sourceSlots.push(s)):(bt.sources=[this],bt.sourceSlots=[s]),this.observers?(this.observers.push(bt),this.observerSlots.push(bt.sources.length-1)):(this.observers=[bt],this.observerSlots=[bt.sources.length-1])}return this.value}function Ic(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&Ar(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=ro&&ro.running;o&&ro.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?Wt.push(r):Ti.push(r),r.observers&&Dc(r)),o||(r.state=Xi)}if(Wt.length>1e6)throw Wt=[],new Error},!1)),t}function Cr(s){if(!s.fn)return;vr(s);const t=Os;Wu(s,s.value,t)}function Wu(s,t,e){let i;const n=At,r=bt;bt=At=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=Xi,s.owned&&s.owned.forEach(vr),s.owned=null),s.updatedAt=e+1,kc(o)}finally{bt=r,At=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?Ic(s,i):s.value=i,s.updatedAt=e)}function Zo(s,t,e,i=Xi,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:At,context:At?At.context:null,pure:e};return At===null||At!==Ac&&(At.owned?At.owned.push(r):At.owned=[r]),r}function gs(s){if(s.state===0)return;if(s.state===ms)return vs(s);if(s.suspense&&ai(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<Os);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===Xi)Cr(s);else if(s.state===ms){const i=Wt;Wt=null,Ar(()=>vs(s,t[0]),!1),Wt=i}}function Ar(s,t){if(Wt)return s();let e=!1;t||(Wt=[]),Ti?e=!0:Ti=[],Os++;try{const i=s();return Gu(e),i}catch(i){e||(Ti=null),Wt=null,kc(i)}}function Gu(s){if(Wt&&(Mc(Wt),Wt=null),s)return;const t=Ti;Ti=null,t.length&&Ar(()=>Cc(t),!1)}function Mc(s){for(let t=0;t<s.length;t++)gs(s[t])}function Zu(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:gs(i)}for(t=0;t<e;t++)gs(s[t])}function vs(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===Xi?i!==t&&(!i.updatedAt||i.updatedAt<Os)&&gs(i):n===ms&&vs(i,t)}}}function Dc(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=ms,e.pure?Wt.push(e):Ti.push(e),e.observers&&Dc(e))}}function vr(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)vr(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)vr(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function Xu(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function kc(s,t=At){throw Xu(s)}function wo(s){if(typeof s=="function"&&!s.length)return wo(s());if(Array.isArray(s)){const t=[];for(let e=0;e<s.length;e++){const i=wo(s[e]);Array.isArray(i)?t.push.apply(t,i):t.push(i)}return t}return s}const Yu=Symbol("fallback");function nl(s){for(let t=0;t<s.length;t++)s[t]()}function Qu(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return an(()=>nl(r)),()=>{let c=s()||[],h=c.length,d,l;return c[Uu],ai(()=>{let f,m,v,w,b,I,O,N,q;if(h===0)o!==0&&(nl(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[Yu],n[0]=as(ie=>(r[0]=ie,e.fallback())),o=1);else if(o===0){for(n=new Array(h),l=0;l<h;l++)i[l]=c[l],n[l]=as(p);o=h}else{for(v=new Array(h),w=new Array(h),a&&(b=new Array(h)),I=0,O=Math.min(o,h);I<O&&i[I]===c[I];I++);for(O=o-1,N=h-1;O>=I&&N>=I&&i[O]===c[N];O--,N--)v[N]=n[O],w[N]=r[O],a&&(b[N]=a[O]);for(f=new Map,m=new Array(N+1),l=N;l>=I;l--)q=c[l],d=f.get(q),m[l]=d===void 0?-1:d,f.set(q,l);for(d=I;d<=O;d++)q=i[d],l=f.get(q),l!==void 0&&l!==-1?(v[l]=n[d],w[l]=r[d],a&&(b[l]=a[d]),l=m[l],f.set(q,l)):r[d]();for(l=I;l<h;l++)l in v?(n[l]=v[l],r[l]=w[l],a&&(a[l]=b[l],a[l](l))):n[l]=as(p);n=n.slice(0,o=h),i=c.slice(0)}return n});function p(f){if(r[l]=f,a){const[m,v]=he(l);return a[l]=v,t(c[l],m)}return t(c[l])}}}function ye(s,t){return ai(()=>s(t||{}))}const Oc=s=>`Stale read from <${s}>.`;function _o(s){const t="fallback"in s&&{fallback:()=>s.fallback};return si(Qu(()=>s.each,s.children,t||void 0))}function Ne(s){const t=s.keyed,e=si(()=>s.when,void 0,void 0),i=t?e:si(e,void 0,{equals:(n,r)=>!n==!r});return si(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?ai(()=>r(t?n:()=>{if(!ai(i))throw Oc("Show");return e()})):r}return s.fallback},void 0,void 0)}function Ku(s){const t=qu(()=>s.children),e=si(()=>{const i=t(),n=Array.isArray(i)?i:[i];let r=()=>{};for(let o=0;o<n.length;o++){const a=o,c=n[o],h=r,d=si(()=>h()?void 0:c.when,void 0,void 0),l=c.keyed?d:si(d,void 0,{equals:(p,f)=>!p==!f});r=()=>h()||(l()?[a,d,c]:void 0)}return r});return si(()=>{const i=e()();if(!i)return s.fallback;const[n,r,o]=i,a=o.children;return typeof a=="function"&&a.length>0?ai(()=>a(o.keyed?r():()=>{var h;if(((h=ai(e)())==null?void 0:h[0])!==n)throw Oc("Match");return r()})):a},void 0,void 0)}function so(s){return s}const Ct=s=>si(()=>s());function Ju(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,c=t[n-1].nextSibling,h=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const d=r<i?a?e[a-1].nextSibling:e[r-a]:c;for(;a<r;)s.insertBefore(e[a++],d)}else if(r===a)for(;o<n;)(!h||!h.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const d=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],d),t[n]=e[r]}else{if(!h){h=new Map;let l=a;for(;l<r;)h.set(e[l],l++)}const d=h.get(t[o]);if(d!=null)if(a<d&&d<r){let l=o,p=1,f;for(;++l<n&&l<r&&!((f=h.get(t[l]))==null||f!==d+p);)p++;if(p>d-a){const m=t[o];for(;a<d;)s.insertBefore(e[a++],m)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const rl="_$DX_DELEGATE";function $u(s,t,e,i={}){let n;return as(r=>{n=r,t===document?s():se(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function j(s,t,e,i){let n;const r=()=>{const a=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return a.innerHTML=s,e?a.content.firstChild.firstChild:i?a.firstChild:a.content.firstChild},o=t?()=>ai(()=>document.importNode(n||(n=r()),!0)):()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function hn(s,t=window.document){const e=t[rl]||(t[rl]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,ed))}}function Zt(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function Tt(s,t){t==null?s.removeAttribute("class"):s.className=t}function Fc(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function ur(s,t,e){if(!t)return e?Zt(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function Lc(s,t,e){return ai(()=>s(t,e))}function se(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return ys(s,t,i,e);je(n=>ys(s,t(),n,e),i)}function ed(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=c=>Object.defineProperty(s,"target",{configurable:!0,value:c}),o=()=>{const c=t[e];if(c&&!t.disabled){const h=t[`${e}Data`];if(h!==void 0?c.call(t,h,s):c.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const c=s.composedPath();r(c[0]);for(let h=0;h<c.length-2&&(t=c[h],!!o());h++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function ys(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=xn(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=xn(s,e,i);else{if(r==="function")return je(()=>{let a=t();for(;typeof a=="function";)a=a();e=ys(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],c=e&&Array.isArray(e);if(To(a,t,e,n))return je(()=>e=ys(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=xn(s,e,i),o)return e}else c?e.length===0?sl(s,a,i):Ju(s,e,a):(e&&xn(s),sl(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=xn(s,e,i,t);xn(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function To(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],c=e&&e[s.length],h;if(!(a==null||a===!0||a===!1))if((h=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=To(s,a,c)||n;else if(h==="function")if(i){for(;typeof a=="function";)a=a();n=To(s,Array.isArray(a)?a:[a],Array.isArray(c)?c:[c])||n}else s.push(a),n=!0;else{const d=String(a);c&&c.nodeType===3&&c.data===d?s.push(c):s.push(document.createTextNode(d))}}return n}function sl(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function xn(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const c=a.parentNode===s;!r&&!o?c?s.replaceChild(n,a):s.insertBefore(n,e):c&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}var Pn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function td(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Vc={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var c in o)a=c;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,c=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/c}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var c,h,d,l,p,f,m=arguments[0]||{},v=arguments.length,w=!1,b=1;for(typeof m=="boolean"&&(w=m,m=arguments[1]||{},b=2),typeof m!="object"&&!t.isFunction(m)&&(m={}),v===b&&(m=this,--b);b<v;b++)if(c=arguments[b],c!==null||c!==void 0)for(h in c){var I=Object.getOwnPropertyDescriptor(c,h);if(I!==void 0){if(I.get||I.set){Object.defineProperty(m,h,I);continue}l=I.value}else{e.console.warn('Could not copy inherited property "'+h+'".');continue}m!==l&&(w&&l&&(t.isPlainObject(l)||(p=t.isArray(l)))?(d=m[h],p?(p=!1,f=d&&t.isArray(d)?d:[]):f=d&&t.isPlainObject(d)?d:{},m[h]=t.extend(w,f,l)):l!==void 0&&(m[h]=l))}return m};var i=function(){if(typeof navigator!="object")return!1;var c=navigator.userAgent;return typeof c!="string"?!1:c.indexOf("iPhone")!==-1||c.indexOf("iPad")!==-1||c.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(c,h){return function(){var d=arguments;return d===void 0&&(d=[]),h.apply(c,d)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(c){return e._viewers.get(this.getElement(c))},getElement:function(c){return typeof c=="string"&&(c=document.getElementById(c)),c},getElementPosition:function(c){var h=new e.Point,d,l;for(c=e.getElement(c),d=e.getElementStyle(c).position==="fixed",l=a(c,d);l;)h.x+=c.offsetLeft,h.y+=c.offsetTop,d&&(h=h.plus(e.getPageScroll())),c=l,d=e.getElementStyle(c).position==="fixed",l=a(c,d);return h},getElementOffset:function(c){c=e.getElement(c);var h=c&&c.ownerDocument,d,l,p={top:0,left:0};return h?(d=h.documentElement,typeof c.getBoundingClientRect<"u"&&(p=c.getBoundingClientRect()),l=h===h.window?h:h.nodeType===9?h.defaultView||h.parentWindow:!1,new e.Point(p.left+(l.pageXOffset||d.scrollLeft)-(d.clientLeft||0),p.top+(l.pageYOffset||d.scrollTop)-(d.clientTop||0))):new e.Point},getElementSize:function(c){return c=e.getElement(c),new e.Point(c.clientWidth,c.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(c){return c=e.getElement(c),c.currentStyle}:function(c){return c=e.getElement(c),window.getComputedStyle(c,"")},getCssPropertyWithVendorPrefix:function(c){var h={};return e.getCssPropertyWithVendorPrefix=function(d){if(h[d]!==void 0)return h[d];var l=document.createElement("div").style,p=null;if(l[d]!==void 0)p=d;else for(var f=["Webkit","Moz","MS","O","webkit","moz","ms","o"],m=e.capitalizeFirstLetter(d),v=0;v<f.length;v++){var w=f[v]+m;if(l[w]!==void 0){p=w;break}}return h[d]=p,p},e.getCssPropertyWithVendorPrefix(c)},capitalizeFirstLetter:function(c){return c.charAt(0).toUpperCase()+c.slice(1)},positiveModulo:function(c,h){var d=c%h;return d<0&&(d+=h),d},pointInElement:function(c,h){c=e.getElement(c);var d=e.getElementOffset(c),l=e.getElementSize(c);return h.x>=d.x&&h.x<d.x+l.x&&h.y<d.y+l.y&&h.y>=d.y},getMousePosition:function(c){if(typeof c.pageX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.pageX,d.y=h.pageY,d};else if(typeof c.clientX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d.y=h.clientY+document.body.scrollTop+document.documentElement.scrollTop,d};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(c)},getPageScroll:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(h.scrollLeft||h.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(c.scrollLeft||c.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(c){if(typeof window.scrollTo<"u")e.setPageScroll=function(l){window.scrollTo(l.x,l.y)};else{var h=e.getPageScroll();if(h.x===c.x&&h.y===c.y)return;document.body.scrollLeft=c.x,document.body.scrollTop=c.y;var d=e.getPageScroll();if(d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.body.scrollLeft=l.x,document.body.scrollTop=l.y};return}if(document.documentElement.scrollLeft=c.x,document.documentElement.scrollTop=c.y,d=e.getPageScroll(),d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y};return}e.setPageScroll=function(l){}}e.setPageScroll(c)},getWindowSize:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(c.clientWidth||c.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(h.clientWidth||h.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(c){c=e.getElement(c);var h=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(h[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(h[1].style,{display:"table-row"}),e.extend(h[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),h[0].appendChild(h[1]),h[1].appendChild(h[2]),h[2].appendChild(c),h[0]},makeNeutralElement:function(c){var h=document.createElement(c),d=h.style;return d.background="transparent none",d.border="none",d.margin="0px",d.padding="0px",d.position="static",h},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(c){var h=e.makeNeutralElement("img");return h.src=c,h},setElementOpacity:function(c,h,d){var l,p;c=e.getElement(c),d&&!e.Browser.alpha&&(h=Math.round(h)),e.Browser.opacity?c.style.opacity=h<1?h:"":h<1?(l=Math.round(100*h),p="alpha(opacity="+l+")",c.style.filter=p):c.style.filter=""},setElementTouchActionNone:function(c){c=e.getElement(c),typeof c.style.touchAction<"u"?c.style.touchAction="none":typeof c.style.msTouchAction<"u"&&(c.style.msTouchAction="none")},setElementPointerEvents:function(c,h){c=e.getElement(c),typeof c.style<"u"&&typeof c.style.pointerEvents<"u"&&(c.style.pointerEvents=h)},setElementPointerEventsNone:function(c){e.setElementPointerEvents(c,"none")},addClass:function(c,h){c=e.getElement(c),c.className?(" "+c.className+" ").indexOf(" "+h+" ")===-1&&(c.className+=" "+h):c.className=h},indexOf:function(c,h,d){return Array.prototype.indexOf?this.indexOf=function(l,p,f){return l.indexOf(p,f)}:this.indexOf=function(l,p,f){var m,v=f||0,w;if(!l)throw new TypeError;if(w=l.length,w===0||v>=w)return-1;for(v<0&&(v=w-Math.abs(v)),m=v;m<w;m++)if(l[m]===p)return m;return-1},this.indexOf(c,h,d)},removeClass:function(c,h){var d,l=[],p;for(c=e.getElement(c),d=c.className.split(/\s+/),p=0;p<d.length;p++)d[p]&&d[p]!==h&&l.push(d[p]);c.className=l.join(" ")},normalizeEventListenerOptions:function(c){var h;return typeof c<"u"?typeof c=="boolean"?h=e.supportsEventListenerOptions?{capture:c}:c:h=e.supportsEventListenerOptions?c:typeof c.capture<"u"?c.capture:!1:h=e.supportsEventListenerOptions?{capture:!1}:!1,h},addEvent:function(){if(e.supportsAddEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.addEventListener(h,d,l)};if(document.documentElement.attachEvent&&document.attachEvent)return function(c,h,d){c=e.getElement(c),c.attachEvent("on"+h,d)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.removeEventListener(h,d,l)};if(document.documentElement.detachEvent&&document.detachEvent)return function(c,h,d){c=e.getElement(c),c.detachEvent("on"+h,d)};throw new Error("No known event model.")}(),cancelEvent:function(c){c.preventDefault()},eventIsCanceled:function(c){return c.defaultPrevented},stopEvent:function(c){c.stopPropagation()},createCallback:function(c,h){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var d=[],l;for(l=2;l<arguments.length;l++)d.push(arguments[l]);return function(){var p=d.concat([]),f;for(f=0;f<arguments.length;f++)p.push(arguments[f]);return h.apply(c,p)}},getUrlParameter:function(c){var h=o[c];return h||null},getUrlProtocol:function(c){var h=c.match(/^([a-z]+:)\/\//i);return h===null?window.location.protocol:h[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(c,h,d){var l,p,f,m;e.isPlainObject(c)&&(h=c.success,d=c.error,l=c.withCredentials,p=c.headers,f=c.responseType||null,m=c.postData||null,c=c.url);var v=e.getUrlProtocol(c),w=e.createAjaxRequest();if(!e.isFunction(h))throw new Error("makeAjaxRequest requires a success callback");w.onreadystatechange=function(){w.readyState===4&&(w.onreadystatechange=function(){},w.status>=200&&w.status<300||w.status===0&&v!=="http:"&&v!=="https:"?h(w):e.isFunction(d)?d(w):e.console.error("AJAX request returned %d: %s",w.status,c))};var b=m?"POST":"GET";try{if(w.open(b,c,!0),f&&(w.responseType=f),p)for(var I in p)Object.prototype.hasOwnProperty.call(p,I)&&p[I]&&w.setRequestHeader(I,p[I]);l&&(w.withCredentials=!0),w.send(m)}catch(O){e.console.error("%s while making AJAX request: %s",O.name,O.message),w.onreadystatechange=function(){},e.isFunction(d)&&d(w,O)}return w},jsonp:function(c){var h,d=c.url,l=document.head||document.getElementsByTagName("head")[0]||document.documentElement,p=c.callbackName||"openseadragon"+e.now(),f=window[p],m="$1"+p+"$2",v=c.param||"callback",w=c.callback;d=d.replace(/(=)\?(&|$)|\?\?/i,m),d+=(/\?/.test(d)?"&":"?")+v+"="+p,window[p]=function(b){if(f)window[p]=f;else try{delete window[p]}catch{}w&&e.isFunction(w)&&w(b)},h=document.createElement("script"),(c.async!==void 0||c.async!==!1)&&(h.async="async"),c.scriptCharset&&(h.charset=c.scriptCharset),h.src=d,h.onload=h.onreadystatechange=function(b,I){(I||!h.readyState||/loaded|complete/.test(h.readyState))&&(h.onload=h.onreadystatechange=null,l&&h.parentNode&&l.removeChild(h),h=void 0)},l.insertBefore(h,l.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(c){if(window.DOMParser)e.parseXml=function(h){var d=null,l;return l=new DOMParser,d=l.parseFromString(h,"text/xml"),d};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(c)},parseJSON:function(c){return e.parseJSON=window.JSON.parse,e.parseJSON(c)},imageFormatSupported:function(c){return c=c||"",!!r[c.toLowerCase()]},setImageFormatsSupported:function(c){e.extend(r,c)}});var n=function(c){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var c=navigator.appVersion,h=navigator.userAgent,d;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(h.substring(h.indexOf("MSIE")+5,h.indexOf(";",h.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(h.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edge")+5))):h.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edg")+4))):h.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(h.substring(h.indexOf("Firefox")+8))):h.indexOf("Safari")>=0?(e.Browser.vendor=h.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(h.substring(h.substring(0,h.indexOf("Safari")).lastIndexOf("/")+1,h.indexOf("Safari")))):(d=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),d.exec(h)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(c);break}var l=window.location.search.substring(1),p=l.split("&"),f,m,v;for(v=0;v<p.length;v++)if(f=p[v],m=f.indexOf("="),m>0){var w=f.substring(0,m),b=f.substring(m+1);try{o[w]=decodeURIComponent(b)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",w,b)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(c){var h=c.requestAnimationFrame||c.mozRequestAnimationFrame||c.webkitRequestAnimationFrame||c.msRequestAnimationFrame,d=c.cancelAnimationFrame||c.mozCancelAnimationFrame||c.webkitCancelAnimationFrame||c.msCancelAnimationFrame;if(h&&d)e.requestAnimationFrame=function(){return h.apply(c,arguments)},e.cancelAnimationFrame=function(){return d.apply(c,arguments)};else{var l=[],p=[],f=0,m;e.requestAnimationFrame=function(v){return l.push([++f,v]),m||(m=setInterval(function(){if(l.length){var w=e.now(),b=p;for(p=l,l=b;p.length;)p.shift()[1](w)}else clearInterval(m),m=void 0},1e3/50)),f},e.cancelAnimationFrame=function(v){var w,b;for(w=0,b=l.length;w<b;w+=1)if(l[w][0]===v){l.splice(w,1);return}for(w=0,b=p.length;w<b;w+=1)if(p[w][0]===v){p.splice(w,1);return}}}}(window);function a(c,h){return h&&c!==document.body?document.body:c.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(Pn,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var c=o[0*3+0],h=o[0*3+1],d=o[0*3+2],l=o[1*3+0],p=o[1*3+1],f=o[1*3+2],m=o[2*3+0],v=o[2*3+1],w=o[2*3+2],b=a[0*3+0],I=a[0*3+1],O=a[0*3+2],N=a[1*3+0],q=a[1*3+1],ie=a[1*3+2],k=a[2*3+0],S=a[2*3+1],E=a[2*3+2];return new i([b*c+I*l+O*m,b*h+I*p+O*v,b*d+I*f+O*w,N*c+q*l+ie*m,N*h+q*p+ie*v,N*d+q*f+ie*w,k*c+S*l+E*m,k*h+S*p+E*v,k*d+S*f+E*w])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var c=this;o=o||1;var h=0,d=function(l){return h++,h===o&&c.removeHandler(i,d),n(l)};return this.addHandler(i,d,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var c=a.length,h={handler:n,userData:r||null,priority:o||0};for(a[c]=h;c>0&&a[c-1].priority<a[c].priority;)a[c]=a[c-1],a[c-1]=h,c--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,c=n.length;for(a=0;a<c;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(x){var T=arguments;e.isPlainObject(x)||(x={element:T[0],clickTimeThreshold:T[1],clickDistThreshold:T[2]}),this.hash=Math.random(),this.element=e.getElement(x.element),this.clickTimeThreshold=x.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=x.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=x.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=x.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=x.userData||null,this.stopDelay=x.stopDelay||50,this.preProcessEventHandler=x.preProcessEventHandler||null,this.contextMenuHandler=x.contextMenuHandler||null,this.enterHandler=x.enterHandler||null,this.leaveHandler=x.leaveHandler||null,this.exitHandler=x.exitHandler||null,this.overHandler=x.overHandler||null,this.outHandler=x.outHandler||null,this.pressHandler=x.pressHandler||null,this.nonPrimaryPressHandler=x.nonPrimaryPressHandler||null,this.releaseHandler=x.releaseHandler||null,this.nonPrimaryReleaseHandler=x.nonPrimaryReleaseHandler||null,this.moveHandler=x.moveHandler||null,this.scrollHandler=x.scrollHandler||null,this.clickHandler=x.clickHandler||null,this.dblClickHandler=x.dblClickHandler||null,this.dragHandler=x.dragHandler||null,this.dragEndHandler=x.dragEndHandler||null,this.pinchHandler=x.pinchHandler||null,this.stopHandler=x.stopHandler||null,this.keyDownHandler=x.keyDownHandler||null,this.keyUpHandler=x.keyUpHandler||null,this.keyHandler=x.keyHandler||null,this.focusHandler=x.focusHandler||null,this.blurHandler=x.blurHandler||null;var C=this;i[this.hash]={click:function(M){O(C,M)},dblclick:function(M){N(C,M)},keydown:function(M){q(C,M)},keyup:function(M){ie(C,M)},keypress:function(M){k(C,M)},focus:function(M){S(C,M)},blur:function(M){E(C,M)},contextmenu:function(M){D(C,M)},wheel:function(M){L(C,M)},mousewheel:function(M){F(C,M)},DOMMouseScroll:function(M){F(C,M)},MozMousePixelScroll:function(M){F(C,M)},losecapture:function(M){V(C,M)},mouseenter:function(M){W(C,M)},mouseleave:function(M){_e(C,M)},mouseover:function(M){ze(C,M)},mouseout:function(M){gt(C,M)},mousedown:function(M){Le(C,M)},mouseup:function(M){vt(C,M)},mousemove:function(M){at(C,M)},touchstart:function(M){ne(C,M)},touchend:function(M){ce(C,M)},touchmove:function(M){G(C,M)},touchcancel:function(M){J(C,M)},gesturestart:function(M){$(C,M)},gesturechange:function(M){oe(C,M)},gotpointercapture:function(M){Oe(C,M)},lostpointercapture:function(M){we(C,M)},pointerenter:function(M){W(C,M)},pointerleave:function(M){_e(C,M)},pointerover:function(M){ze(C,M)},pointerout:function(M){gt(C,M)},pointerdown:function(M){Le(C,M)},pointerup:function(M){vt(C,M)},pointermove:function(M){at(C,M)},pointercancel:function(M){dt(C,M)},pointerupcaptured:function(M){ht(C,M)},pointermovecaptured:function(M){rt(C,M)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),x.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){c(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(x){return x?a(this):c(this),this},getActivePointersListByType:function(x){var T=i[this.hash],C,M=T?T.activePointersLists.length:0,U;for(C=0;C<M;C++)if(T.activePointersLists[C].type===x)return T.activePointersLists[C];return U=new e.MouseTracker.GesturePointList(x),T&&T.activePointersLists.push(U),U},getActivePointerCount:function(){var x=i[this.hash],T,C=x.activePointersLists.length,M=0;for(T=0;T<C;T++)M+=x.activePointersLists[T].getLength();return M},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(x){try{return x.addEventListener&&x.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var x=[],T=0,C=0,M=function(We,Pe){return We.hash.toString()+Pe.type+Pe.id.toString()},U=function(){var We,Pe=x.length,Pt,st,ti=e.now(),ci,Si,Pi;for(ci=ti-C,C=ti,We=0;We<Pe;We++)Pt=x[We],st=Pt.gPoint,st.direction=Math.atan2(st.currentPos.y-Pt.lastPos.y,st.currentPos.x-Pt.lastPos.x),Si=Pt.lastPos.distanceTo(st.currentPos),Pt.lastPos=st.currentPos,Pi=1e3*Si/(ci+1),st.speed=.75*Pi+.25*st.speed},te=function(We,Pe){var Pt=M(We,Pe);x.push({guid:Pt,gPoint:Pe,lastPos:Pe.currentPos}),x.length===1&&(C=e.now(),T=window.setInterval(U,50))},xe=function(We,Pe){var Pt=M(We,Pe),st,ti=x.length;for(st=0;st<ti;st++)if(x[st].guid===Pt){x.splice(st,1),ti--,ti===0&&window.clearInterval(T);break}};return{addPoint:te,removePoint:xe}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var x=document.createElement("div");return e.isFunction(x.setPointerCapture)&&e.isFunction(x.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var x=document.createElement("div");return e.isFunction(x.setCapture)&&e.isFunction(x.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(x){this._gPoints=[],this.type=x,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(x){return this._gPoints.push(x)},removeById:function(x){var T,C=this._gPoints.length;for(T=0;T<C;T++)if(this._gPoints[T].id===x){this._gPoints.splice(T,1);break}return this._gPoints.length},getByIndex:function(x){return x<this._gPoints.length?this._gPoints[x]:null},getById:function(x){var T,C=this._gPoints.length;for(T=0;T<C;T++)if(this._gPoints[T].id===x)return this._gPoints[T];return null},getPrimary:function(x){var T,C=this._gPoints.length;for(T=0;T<C;T++)if(this._gPoints[T].isPrimary)return this._gPoints[T];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(x){var T=i[x.hash],C,M,U,te,xe,We=T.activePointersLists.length;for(C=0;C<We;C++)if(U=T.activePointersLists[C],U.getLength()>0){for(xe=[],te=U.asArray(),M=0;M<te.length;M++)xe.push(te[M]);for(M=0;M<xe.length;M++)Je(x,U,xe[M])}for(C=0;C<We;C++)T.activePointersLists.pop();T.sentDragEvent=!1}function a(x){var T=i[x.hash],C,M;if(!T.tracking){for(M=0;M<e.MouseTracker.subscribeEvents.length;M++)C=e.MouseTracker.subscribeEvents[M],e.addEvent(x.element,C,T[C],C===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(x),T.tracking=!0}}function c(x){var T=i[x.hash],C,M;if(T.tracking){for(M=0;M<e.MouseTracker.subscribeEvents.length;M++)C=e.MouseTracker.subscribeEvents[M],e.removeEvent(x.element,C,T[C],!1);o(x),T.tracking=!1}}function h(x,T){var C=i[x.hash];if(T==="pointerevent")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(T==="mouse")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(T==="touch")return{upName:"touchend",upHandler:C.touchendcaptured,moveName:"touchmove",moveHandler:C.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function d(x,T){var C;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{x.element.setPointerCapture(T.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else x.element.setCapture(!0);else C=h(x,e.MouseTracker.havePointerEvents?"pointerevent":T.type),n&&r(window.top)&&e.addEvent(window.top,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0);B(x,T,!0)}function l(x,T){var C,M,U;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(M=x.getActivePointersListByType(T.type),U=M.getById(T.id),!U||!U.captured)return;try{x.element.releasePointerCapture(T.id)}catch{}}else x.element.releaseCapture();else C=h(x,e.MouseTracker.havePointerEvents?"pointerevent":T.type),n&&r(window.top)&&e.removeEvent(window.top,C.upName,C.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0);B(x,T,!1)}function p(x){return e.MouseTracker.havePointerEvents?x.pointerId:e.MouseTracker.mousePointerId}function f(x){return e.MouseTracker.havePointerEvents&&x.pointerType?x.pointerType:"mouse"}function m(x){return e.MouseTracker.havePointerEvents?x.isPrimary:!0}function v(x){return e.getMousePosition(x)}function w(x,T){return b(v(x),T)}function b(x,T){var C=e.getElementOffset(T);return x.minus(C)}function I(x,T){return new e.Point((x.x+T.x)/2,(x.y+T.y)/2)}function O(x,T){var C={originalEvent:T,eventType:"click",pointerType:"mouse",isEmulated:!1};R(x,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(T),C.stopPropagation&&e.stopEvent(T)}function N(x,T){var C={originalEvent:T,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};R(x,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(T),C.stopPropagation&&e.stopEvent(T)}function q(x,T){var C=null,M={originalEvent:T,eventType:"keydown",pointerType:"",isEmulated:!1};R(x,M),x.keyDownHandler&&!M.preventGesture&&!M.defaultPrevented&&(C={eventSource:x,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:M.preventDefault||M.defaultPrevented,userData:x.userData},x.keyDownHandler(C)),(C&&C.preventDefault||M.preventDefault&&!M.defaultPrevented)&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function ie(x,T){var C=null,M={originalEvent:T,eventType:"keyup",pointerType:"",isEmulated:!1};R(x,M),x.keyUpHandler&&!M.preventGesture&&!M.defaultPrevented&&(C={eventSource:x,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:M.preventDefault||M.defaultPrevented,userData:x.userData},x.keyUpHandler(C)),(C&&C.preventDefault||M.preventDefault&&!M.defaultPrevented)&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function k(x,T){var C=null,M={originalEvent:T,eventType:"keypress",pointerType:"",isEmulated:!1};R(x,M),x.keyHandler&&!M.preventGesture&&!M.defaultPrevented&&(C={eventSource:x,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:M.preventDefault||M.defaultPrevented,userData:x.userData},x.keyHandler(C)),(C&&C.preventDefault||M.preventDefault&&!M.defaultPrevented)&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function S(x,T){var C={originalEvent:T,eventType:"focus",pointerType:"",isEmulated:!1};R(x,C),x.focusHandler&&!C.preventGesture&&x.focusHandler({eventSource:x,originalEvent:T,userData:x.userData})}function E(x,T){var C={originalEvent:T,eventType:"blur",pointerType:"",isEmulated:!1};R(x,C),x.blurHandler&&!C.preventGesture&&x.blurHandler({eventSource:x,originalEvent:T,userData:x.userData})}function D(x,T){var C=null,M={originalEvent:T,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};R(x,M),x.contextMenuHandler&&!M.preventGesture&&!M.defaultPrevented&&(C={eventSource:x,position:b(v(T),x.element),originalEvent:M.originalEvent,preventDefault:M.preventDefault||M.defaultPrevented,userData:x.userData},x.contextMenuHandler(C)),(C&&C.preventDefault||M.preventDefault&&!M.defaultPrevented)&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function L(x,T){A(x,T,T)}function F(x,T){var C={target:T.target||T.srcElement,type:"wheel",shiftKey:T.shiftKey||!1,clientX:T.clientX,clientY:T.clientY,pageX:T.pageX?T.pageX:T.clientX,pageY:T.pageY?T.pageY:T.clientY,deltaMode:T.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?C.deltaY=-T.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:C.deltaY=T.detail,A(x,C,T)}function A(x,T,C){var M=0,U,te=null;M=T.deltaY?T.deltaY<0?1:-1:0,U={originalEvent:T,eventType:"wheel",pointerType:"mouse",isEmulated:T!==C},R(x,U),x.scrollHandler&&!U.preventGesture&&!U.defaultPrevented&&(te={eventSource:x,pointerType:"mouse",position:w(T,x.element),scroll:M,shift:T.shiftKey,isTouchEvent:!1,originalEvent:C,preventDefault:U.preventDefault||U.defaultPrevented,userData:x.userData},x.scrollHandler(te)),U.stopPropagation&&e.stopEvent(C),(te&&te.preventDefault||U.preventDefault&&!U.defaultPrevented)&&e.cancelEvent(C)}function V(x,T){var C={id:e.MouseTracker.mousePointerId,type:"mouse"},M={originalEvent:T,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};R(x,M),T.target===x.element&&B(x,C,!1),M.stopPropagation&&e.stopEvent(T)}function ne(x,T){var C,M,U=T.changedTouches.length,te,xe=x.getActivePointersListByType("touch");C=e.now(),xe.getLength()>T.touches.length-U&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var We={originalEvent:T,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(R(x,We),M=0;M<U;M++)te={id:T.changedTouches[M].identifier,type:"touch",isPrimary:xe.getLength()===0,currentPos:v(T.changedTouches[M]),currentTime:C},K(x,We,te),Ce(x,We,te,0),B(x,te,!0);We.preventDefault&&!We.defaultPrevented&&e.cancelEvent(T),We.stopPropagation&&e.stopEvent(T)}function ce(x,T){var C,M,U=T.changedTouches.length,te;C=e.now();var xe={originalEvent:T,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(R(x,xe),M=0;M<U;M++)te={id:T.changedTouches[M].identifier,type:"touch",currentPos:v(T.changedTouches[M]),currentTime:C},Be(x,xe,te,0),B(x,te,!1),re(x,xe,te);xe.preventDefault&&!xe.defaultPrevented&&e.cancelEvent(T),xe.stopPropagation&&e.stopEvent(T)}function G(x,T){var C,M,U=T.changedTouches.length,te;C=e.now();var xe={originalEvent:T,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(R(x,xe),M=0;M<U;M++)te={id:T.changedTouches[M].identifier,type:"touch",currentPos:v(T.changedTouches[M]),currentTime:C},ke(x,xe,te);xe.preventDefault&&!xe.defaultPrevented&&e.cancelEvent(T),xe.stopPropagation&&e.stopEvent(T)}function J(x,T){var C=T.changedTouches.length,M,U,te={originalEvent:T,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(R(x,te),M=0;M<C;M++)U={id:T.changedTouches[M].identifier,type:"touch"},ve(x,te,U);te.stopPropagation&&e.stopEvent(T)}function $(x,T){return e.eventIsCanceled(T)||T.preventDefault(),!1}function oe(x,T){return e.eventIsCanceled(T)||T.preventDefault(),!1}function Oe(x,T){var C={originalEvent:T,eventType:"gotpointercapture",pointerType:f(T),isEmulated:!1};R(x,C),T.target===x.element&&B(x,{id:T.pointerId,type:f(T)},!0),C.stopPropagation&&e.stopEvent(T)}function we(x,T){var C={originalEvent:T,eventType:"lostpointercapture",pointerType:f(T),isEmulated:!1};R(x,C),T.target===x.element&&B(x,{id:T.pointerId,type:f(T)},!1),C.stopPropagation&&e.stopEvent(T)}function W(x,T){var C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},M={originalEvent:T,eventType:"pointerenter",pointerType:C.type,isEmulated:!1};R(x,M),K(x,M,C)}function _e(x,T){var C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},M={originalEvent:T,eventType:"pointerleave",pointerType:C.type,isEmulated:!1};R(x,M),re(x,M,C)}function ze(x,T){var C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},M={originalEvent:T,eventType:"pointerover",pointerType:C.type,isEmulated:!1};R(x,M),me(x,M,C),M.preventDefault&&!M.defaultPrevented&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function gt(x,T){var C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},M={originalEvent:T,eventType:"pointerout",pointerType:C.type,isEmulated:!1};R(x,M),X(x,M,C),M.preventDefault&&!M.defaultPrevented&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function Le(x,T){var C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},M=e.MouseTracker.havePointerEvents&&C.type==="touch",U={originalEvent:T,eventType:"pointerdown",pointerType:C.type,isEmulated:!1};R(x,U),Ce(x,U,C,T.button),U.preventDefault&&!U.defaultPrevented&&e.cancelEvent(T),U.stopPropagation&&e.stopEvent(T),U.shouldCapture&&(M?B(x,C,!0):d(x,C))}function vt(x,T){yt(x,T)}function ht(x,T){var C=x.getActivePointersListByType(f(T));C.getById(T.pointerId)&&yt(x,T),e.stopEvent(T)}function yt(x,T){var C;C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()};var M={originalEvent:T,eventType:"pointerup",pointerType:C.type,isEmulated:!1};R(x,M),Be(x,M,C,T.button),M.preventDefault&&!M.defaultPrevented&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T),M.shouldReleaseCapture&&(T.target===x.element?l(x,C):B(x,C,!1))}function at(x,T){ut(x,T)}function rt(x,T){var C=x.getActivePointersListByType(f(T));C.getById(T.pointerId)&&ut(x,T),e.stopEvent(T)}function ut(x,T){var C={id:p(T),type:f(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},M={originalEvent:T,eventType:"pointermove",pointerType:C.type,isEmulated:!1};R(x,M),ke(x,M,C),M.preventDefault&&!M.defaultPrevented&&e.cancelEvent(T),M.stopPropagation&&e.stopEvent(T)}function dt(x,T){var C={id:T.pointerId,type:f(T)},M={originalEvent:T,eventType:"pointercancel",pointerType:C.type,isEmulated:!1};R(x,M),ve(x,M,C),M.stopPropagation&&e.stopEvent(T)}function ge(x,T){return T.speed=0,T.direction=0,T.contactPos=T.currentPos,T.contactTime=T.currentTime,T.lastPos=T.currentPos,T.lastTime=T.currentTime,x.add(T)}function Je(x,T,C){var M,U=T.getById(C.id);return U?(U.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),l(x,U)),T.removeContact(),M=T.removeById(C.id)):M=T.getLength(),M}function y(x,T){switch(T.eventType){case"pointermove":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"pointerdown":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerup":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasGestureHandlers,T.stopPropagation=!1;break;case"wheel":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasScrollHandler,T.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":T.isStoppable=!0,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"click":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!x.clickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"dblclick":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!x.dblClickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:T.isStoppable=!1,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break}}function R(x,T){T.eventSource=x,T.eventPhase=T.originalEvent&&typeof T.originalEvent.eventPhase<"u"?T.originalEvent.eventPhase:0,T.defaultPrevented=e.eventIsCanceled(T.originalEvent),T.shouldCapture=!1,T.shouldReleaseCapture=!1,T.userData=x.userData,y(x,T),x.preProcessEventHandler&&x.preProcessEventHandler(T)}function B(x,T,C){var M=x.getActivePointersListByType(T.type),U=M.getById(T.id);U?C&&!U.captured?(U.captured=!0,M.captureCount++):!C&&U.captured&&(U.captured=!1,M.captureCount--,M.captureCount<0&&(M.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function K(x,T,C){var M=x.getActivePointersListByType(C.type),U;U=M.getById(C.id),U?(U.insideElement=!0,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime,C=U):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,ge(M,C)),x.enterHandler&&x.enterHandler({eventSource:x,pointerType:C.type,position:b(C.currentPos,x.element),buttons:M.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData})}function re(x,T,C){var M=x.getActivePointersListByType(C.type),U,te;U=M.getById(C.id),U?(U.captured?(U.insideElement=!1,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime):Je(x,M,U),C=U):(C.captured=!1,C.insideElementPressed=!1),(x.leaveHandler||x.exitHandler)&&(te={eventSource:x,pointerType:C.type,position:C.currentPos&&b(C.currentPos,x.element),buttons:M.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData},x.leaveHandler&&x.leaveHandler(te),x.exitHandler&&x.exitHandler(te))}function me(x,T,C){var M,U;M=x.getActivePointersListByType(C.type),U=M.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),x.overHandler&&x.overHandler({eventSource:x,pointerType:C.type,position:b(C.currentPos,x.element),buttons:M.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData})}function X(x,T,C){var M,U;M=x.getActivePointersListByType(C.type),U=M.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),x.outHandler&&x.outHandler({eventSource:x,pointerType:C.type,position:C.currentPos&&b(C.currentPos,x.element),buttons:M.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:M.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData})}function Ce(x,T,C,M){var U=i[x.hash],te=x.getActivePointersListByType(C.type),xe;if(typeof T.originalEvent.buttons<"u"?te.buttons=T.originalEvent.buttons:M===0?te.buttons|=1:M===1?te.buttons|=4:M===2?te.buttons|=2:M===3?te.buttons|=8:M===4?te.buttons|=16:M===5&&(te.buttons|=32),M!==0){T.shouldCapture=!1,T.shouldReleaseCapture=!1,x.nonPrimaryPressHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,x.nonPrimaryPressHandler({eventSource:x,pointerType:C.type,position:b(C.currentPos,x.element),button:M,buttons:te.buttons,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData}));return}xe=te.getById(C.id),xe?(xe.insideElementPressed=!0,xe.insideElement=!0,xe.originalTarget=T.originalEvent.target,xe.contactPos=C.currentPos,xe.contactTime=C.currentTime,xe.lastPos=xe.currentPos,xe.lastTime=xe.currentTime,xe.currentPos=C.currentPos,xe.currentTime=C.currentTime,C=xe):(C.captured=!1,C.insideElementPressed=!0,C.insideElement=!0,C.originalTarget=T.originalEvent.target,ge(te,C)),te.addContact(),!T.preventGesture&&!T.defaultPrevented?(T.shouldCapture=!0,T.shouldReleaseCapture=!1,T.preventDefault=!0,(x.dragHandler||x.dragEndHandler||x.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(x,C),te.contacts===1?x.pressHandler&&!T.preventGesture&&x.pressHandler({eventSource:x,pointerType:C.type,position:b(C.contactPos,x.element),buttons:te.buttons,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData}):te.contacts===2&&x.pinchHandler&&C.type==="touch"&&(U.pinchGPoints=te.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=I(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(T.shouldCapture=!1,T.shouldReleaseCapture=!1)}function Be(x,T,C,M){var U=i[x.hash],te=x.getActivePointersListByType(C.type),xe,We,Pe,Pt=!1,st;if(typeof T.originalEvent.buttons<"u"?te.buttons=T.originalEvent.buttons:M===0?te.buttons^=-2:M===1?te.buttons^=-5:M===2?te.buttons^=-3:M===3?te.buttons^=-9:M===4?te.buttons^=-17:M===5&&(te.buttons^=-33),T.shouldCapture=!1,M!==0){T.shouldReleaseCapture=!1,x.nonPrimaryReleaseHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,x.nonPrimaryReleaseHandler({eventSource:x,pointerType:C.type,position:b(C.currentPos,x.element),button:M,buttons:te.buttons,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData}));return}Pe=te.getById(C.id),Pe?(te.removeContact(),Pe.captured&&(Pt=!0),Pe.lastPos=Pe.currentPos,Pe.lastTime=Pe.currentTime,Pe.currentPos=C.currentPos,Pe.currentTime=C.currentTime,Pe.insideElement||Je(x,te,Pe),xe=Pe.currentPos,We=Pe.currentTime):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,ge(te,C),Pe=C),!T.preventGesture&&!T.defaultPrevented&&(Pt?(T.shouldReleaseCapture=!0,T.preventDefault=!0,(x.dragHandler||x.dragEndHandler||x.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(x,Pe),te.contacts===0?(x.releaseHandler&&xe&&x.releaseHandler({eventSource:x,pointerType:Pe.type,position:b(xe,x.element),buttons:te.buttons,insideElementPressed:Pe.insideElementPressed,insideElementReleased:Pe.insideElement,isTouchEvent:Pe.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),x.dragEndHandler&&U.sentDragEvent&&x.dragEndHandler({eventSource:x,pointerType:Pe.type,position:b(Pe.currentPos,x.element),speed:Pe.speed,direction:Pe.direction,shift:T.originalEvent.shiftKey,isTouchEvent:Pe.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),U.sentDragEvent=!1,(x.clickHandler||x.dblClickHandler)&&Pe.insideElement&&(st=We-Pe.contactTime<=x.clickTimeThreshold&&Pe.contactPos.distanceTo(xe)<=x.clickDistThreshold,x.clickHandler&&x.clickHandler({eventSource:x,pointerType:Pe.type,position:b(Pe.currentPos,x.element),quick:st,shift:T.originalEvent.shiftKey,isTouchEvent:Pe.type==="touch",originalEvent:T.originalEvent,originalTarget:Pe.originalTarget,userData:x.userData}),x.dblClickHandler&&st&&(te.clicks++,te.clicks===1?(U.lastClickPos=xe,U.dblClickTimeOut=setTimeout(function(){te.clicks=0},x.dblClickTimeThreshold)):te.clicks===2&&(clearTimeout(U.dblClickTimeOut),te.clicks=0,U.lastClickPos.distanceTo(xe)<=x.dblClickDistThreshold&&x.dblClickHandler({eventSource:x,pointerType:Pe.type,position:b(Pe.currentPos,x.element),shift:T.originalEvent.shiftKey,isTouchEvent:Pe.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),U.lastClickPos=null)))):te.contacts===2&&x.pinchHandler&&Pe.type==="touch"&&(U.pinchGPoints=te.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=I(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(T.shouldReleaseCapture=!1,x.releaseHandler&&xe&&(x.releaseHandler({eventSource:x,pointerType:Pe.type,position:b(xe,x.element),buttons:te.buttons,insideElementPressed:Pe.insideElementPressed,insideElementReleased:Pe.insideElement,isTouchEvent:Pe.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),T.preventDefault=!0)))}function ke(x,T,C){var M=i[x.hash],U=x.getActivePointersListByType(C.type),te,xe,We;if(typeof T.originalEvent.buttons<"u"&&(U.buttons=T.originalEvent.buttons),te=U.getById(C.id),te)te.lastPos=te.currentPos,te.lastTime=te.currentTime,te.currentPos=C.currentPos,te.currentTime=C.currentTime;else return;T.shouldCapture=!1,T.shouldReleaseCapture=!1,x.stopHandler&&C.type==="mouse"&&(clearTimeout(x.stopTimeOut),x.stopTimeOut=setTimeout(function(){Xe(x,T.originalEvent,C.type)},x.stopDelay)),U.contacts===0?x.moveHandler&&x.moveHandler({eventSource:x,pointerType:C.type,position:b(C.currentPos,x.element),buttons:U.buttons,isTouchEvent:C.type==="touch",originalEvent:T.originalEvent,userData:x.userData}):U.contacts===1?(x.moveHandler&&(te=U.asArray()[0],x.moveHandler({eventSource:x,pointerType:te.type,position:b(te.currentPos,x.element),buttons:U.buttons,isTouchEvent:te.type==="touch",originalEvent:T.originalEvent,userData:x.userData})),x.dragHandler&&!T.preventGesture&&!T.defaultPrevented&&(te=U.asArray()[0],We=te.currentPos.minus(te.lastPos),x.dragHandler({eventSource:x,pointerType:te.type,position:b(te.currentPos,x.element),buttons:U.buttons,delta:We,speed:te.speed,direction:te.direction,shift:T.originalEvent.shiftKey,isTouchEvent:te.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),T.preventDefault=!0,M.sentDragEvent=!0)):U.contacts===2&&(x.moveHandler&&(xe=U.asArray(),x.moveHandler({eventSource:x,pointerType:xe[0].type,position:b(I(xe[0].currentPos,xe[1].currentPos),x.element),buttons:U.buttons,isTouchEvent:xe[0].type==="touch",originalEvent:T.originalEvent,userData:x.userData})),x.pinchHandler&&C.type==="touch"&&!T.preventGesture&&!T.defaultPrevented&&(We=M.pinchGPoints[0].currentPos.distanceTo(M.pinchGPoints[1].currentPos),We!==M.currentPinchDist&&(M.lastPinchDist=M.currentPinchDist,M.currentPinchDist=We,M.lastPinchCenter=M.currentPinchCenter,M.currentPinchCenter=I(M.pinchGPoints[0].currentPos,M.pinchGPoints[1].currentPos),x.pinchHandler({eventSource:x,pointerType:"touch",gesturePoints:M.pinchGPoints,lastCenter:b(M.lastPinchCenter,x.element),center:b(M.currentPinchCenter,x.element),lastDistance:M.lastPinchDist,distance:M.currentPinchDist,shift:T.originalEvent.shiftKey,originalEvent:T.originalEvent,userData:x.userData}),T.preventDefault=!0)))}function ve(x,T,C){var M=x.getActivePointersListByType(C.type),U;U=M.getById(C.id),U&&Je(x,M,U)}function Xe(x,T,C){x.stopHandler&&x.stopHandler({eventSource:x,pointerType:C,position:w(T,x.element),buttons:x.getActivePointersListByType(C).buttons,isTouchEvent:C==="touch",originalEvent:T,userData:x.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(y){var R=arguments,B=this,K;e.isPlainObject(y)||(y={id:R[0],xmlPath:R.length>1?R[1]:void 0,prefixUrl:R.length>2?R[2]:void 0,controls:R.length>3?R[3]:void 0,overlays:R.length>4?R[4]:void 0}),y.config&&(e.extend(!0,y,y.config),delete y.config);let re=["useCanvas"];if(y.drawerOptions=Object.assign({},re.reduce((X,Ce)=>(X[Ce]=y[Ce],delete y[Ce],X),{}),y.drawerOptions),e.extend(!0,this,{id:y.id,hash:y.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,y),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(X){var Ce=e.getString("Errors.OpenFailed",X.eventSource,X.message);B._showMessage(Ce)}),e.ControlDock.call(this,y),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(X){X.width="100%",X.height="100%",X.overflow="hidden",X.position="absolute",X.top="0px",X.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),y.tabIndex!==""&&(this.canvas.tabIndex=y.tabIndex===void 0?0:y.tabIndex),this.container.className="openseadragon-container",function(X){X.width="100%",X.height="100%",X.position="relative",X.overflow="hidden",X.left="0px",X.top="0px",X.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,w),keyDownHandler:e.delegate(this,b),keyHandler:e.delegate(this,I),clickHandler:e.delegate(this,O),dblClickHandler:e.delegate(this,N),dragHandler:e.delegate(this,q),dragEndHandler:e.delegate(this,ie),enterHandler:e.delegate(this,k),leaveHandler:e.delegate(this,S),pressHandler:e.delegate(this,E),releaseHandler:e.delegate(this,D),nonPrimaryPressHandler:e.delegate(this,L),nonPrimaryReleaseHandler:e.delegate(this,F),scrollHandler:e.delegate(this,ce),pinchHandler:e.delegate(this,A),focusHandler:e.delegate(this,V),blurHandler:e.delegate(this,ne)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,G),leaveHandler:e.delegate(this,J)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[B.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(X){B.source=B.world.getItemAt(0).source,i[B.hash].forceRedraw=!0,B._updateRequestId||(B._updateRequestId=h(B,$))}),this.world.addHandler("remove-item",function(X){B.world.getItemCount()?B.source=B.world.getItemAt(0).source:B.source=null,i[B.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(X){B.viewport&&B.viewport._setContentBounds(B.world.getHomeBounds(),B.world.getContentFactor())}),this.world.addHandler("item-index-change",function(X){B.source=B.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:y.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let me=Array.isArray(this.drawer)?this.drawer:[this.drawer];me.length===0&&(me=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const X of me)if(this.requestDrawer(X,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(K=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(K,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(K=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(K,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),K=0;K<this.customControls.length;K++)this.addControl(this.customControls[K].id,{anchor:this.customControls[K].anchor});e.requestAnimationFrame(function(){l(B)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(y){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(y)},openTileSource:function(y){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(y)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(y,R){var B=this;if(this.close(),!y)return this;if(this.sequenceMode&&e.isArray(y))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof R<"u"&&!isNaN(R)&&(this.initialPage=R),this.tileSources=y,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(y)||(y=[y]),!y.length)return this;this._opening=!0;for(var K=y.length,re=0,me=0,X,Ce=function(){if(re+me===K)if(re){(B._firstOpen||!B.preserveViewport)&&(B.viewport.goHome(!0),B.viewport.update()),B._firstOpen=!1;var ve=y[0];if(ve.tileSource&&(ve=ve.tileSource),B.overlays&&!B.preserveOverlays)for(var Xe=0;Xe<B.overlays.length;Xe++)B.currentOverlays[Xe]=a(B,B.overlays[Xe]);B._drawOverlays(),B._opening=!1,B.raiseEvent("open",{source:ve})}else B._opening=!1,B.raiseEvent("open-failed",X)},Be=function(ve){(!e.isPlainObject(ve)||!ve.tileSource)&&(ve={tileSource:ve}),ve.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete ve.index),ve.collectionImmediately===void 0&&(ve.collectionImmediately=!0);var Xe=ve.success;ve.success=function(T){if(re++,ve.tileSource.overlays)for(var C=0;C<ve.tileSource.overlays.length;C++)B.addOverlay(ve.tileSource.overlays[C]);Xe&&Xe(T),Ce()};var x=ve.error;ve.error=function(T){me++,X||(X=T),x&&x(T),Ce()},B.addTiledImage(ve)},ke=0;ke<y.length;ke++)Be(y[ke]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(y,R){const B={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};R=e.extend(!0,B,R);const K=R.mainDrawer,re=R.redrawImmediately,me=R.drawerOptions,X=this.drawer;let Ce=null;if(y&&y.prototype instanceof e.DrawerBase?(Ce=y,y="custom"):typeof y=="string"&&(Ce=e.determineDrawer(y)),Ce||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),Ce&&Ce.isSupported()){X&&K&&X.destroy();const Be=new Ce({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:me||this.drawerOptions[y]});return K&&(this.drawer=Be,re&&this.forceRedraw()),Be}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(y){return this.innerTracker.setTracking(y),this.outerTracker.setTracking(y),this.raiseEvent("mouse-enabled",{enabled:y}),this},areControlsEnabled:function(){var y=this.controls.length,R;for(R=0;R<this.controls.length;R++)y=y&&this.controls[R].isVisible();return y},setControlsEnabled:function(y){return y?f(this):l(this),this.raiseEvent("controls-enabled",{enabled:y}),this},setDebugMode:function(y){for(var R=0;R<this.world.getItemCount();R++)this.world.getItemAt(R).debugMode=y;this.debugMode=y,this.forceRedraw()},setAjaxHeaders:function(y,R){if(y===null&&(y={}),!e.isPlainObject(y)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(R===void 0&&(R=!0),this.ajaxHeaders=y,R){for(var B=0;B<this.world.getItemCount();B++)this.world.getItemAt(B)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var K in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[K].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(y){this.buttonGroup.addButton(y)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(y){var R=document.body,B=R.style,K=document.documentElement.style,re=this,me,X;if(y===this.isFullPage())return this;var Ce={fullPage:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",Ce),Ce.preventDefaultAction)return this;if(y&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=B.margin,this.docMargin=K.margin,B.margin="0",K.margin="0",this.bodyPadding=B.padding,this.docPadding=K.padding,B.padding="0",K.padding="0",this.bodyWidth=B.width,this.docWidth=K.width,B.width="100%",K.width="100%",this.bodyHeight=B.height,this.docHeight=K.height,B.height="100%",K.height="100%",this.bodyDisplay=B.display,B.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,me=R.childNodes.length,X=0;X<me;X++)this.previousBody.push(R.childNodes[0]),R.removeChild(R.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,R.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),R.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,G)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,B.margin=this.bodyMargin,K.margin=this.docMargin,B.padding=this.bodyPadding,K.padding=this.docPadding,B.width=this.bodyWidth,K.width=this.docWidth,B.height=this.bodyHeight,K.height=this.docHeight,B.display=this.bodyDisplay,R.removeChild(this.element),me=this.previousBody.length,X=0;X<me;X++)R.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(R.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var Be=0,ke=function(){e.setPageScroll(re.pageScroll);var ve=e.getPageScroll();Be++,Be<10&&(ve.x!==re.pageScroll.x||ve.y!==re.pageScroll.y)&&e.requestAnimationFrame(ke)};e.requestAnimationFrame(ke),i[this.hash].fullPage=!1,e.delegate(this,J)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:y}),this},setFullScreen:function(y){var R=this;if(!e.supportsFullScreen)return this.setFullPage(y);if(e.isFullScreen()===y)return this;var B={fullScreen:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",B),B.preventDefaultAction)return this;if(y){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var K=function(){var re=e.isFullScreen();re||(e.removeEvent(document,e.fullScreenEventName,K),e.removeEvent(document,e.fullScreenErrorEventName,K),R.setFullPage(!1),R.isFullPage()&&(R.element.style.width=R.fullPageStyleWidth,R.element.style.height=R.fullPageStyleHeight)),R.navigator&&R.viewport&&setTimeout(function(){R.navigator.update(R.viewport)}),R.raiseEvent("full-screen",{fullScreen:re})};e.addEvent(document,e.fullScreenEventName,K),e.addEvent(document,e.fullScreenErrorEventName,K),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(y){return this.container.style.visibility=y?"":"hidden",this.raiseEvent("visible",{visible:y}),this},addTiledImage:function(y){e.console.assert(y,"[Viewer.addTiledImage] options is required"),e.console.assert(y.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!y.replace||y.index>-1&&y.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var R=this;y.replace&&(y.replaceItem=R.world.getItemAt(y.index)),this._hideMessage(),y.placeholderFillStyle===void 0&&(y.placeholderFillStyle=this.placeholderFillStyle),y.opacity===void 0&&(y.opacity=this.opacity),y.preload===void 0&&(y.preload=this.preload),y.compositeOperation===void 0&&(y.compositeOperation=this.compositeOperation),y.crossOriginPolicy===void 0&&(y.crossOriginPolicy=y.tileSource.crossOriginPolicy!==void 0?y.tileSource.crossOriginPolicy:this.crossOriginPolicy),y.ajaxWithCredentials===void 0&&(y.ajaxWithCredentials=this.ajaxWithCredentials),y.loadTilesWithAjax===void 0&&(y.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(y.ajaxHeaders)||(y.ajaxHeaders={});var B={options:y};function K(X){for(var Ce=0;Ce<R._loadQueue.length;Ce++)if(R._loadQueue[Ce]===B){R._loadQueue.splice(Ce,1);break}R._loadQueue.length===0&&re(B),R.raiseEvent("add-item-failed",X),y.error&&y.error(X)}function re(X){R.collectionMode&&(R.world.arrange({immediately:X.options.collectionImmediately,rows:R.collectionRows,columns:R.collectionColumns,layout:R.collectionLayout,tileSize:R.collectionTileSize,tileMargin:R.collectionTileMargin}),R.world.setAutoRefigureSizes(!0))}if(e.isArray(y.tileSource)){setTimeout(function(){K({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:y.tileSource,options:y})});return}this._loadQueue.push(B);function me(){for(var X,Ce,Be;R._loadQueue.length&&(X=R._loadQueue[0],!!X.tileSource);){if(R._loadQueue.splice(0,1),X.options.replace){var ke=R.world.getIndexOfItem(X.options.replaceItem);ke!==-1&&(X.options.index=ke),R.world.removeItem(X.options.replaceItem)}Ce=new e.TiledImage({viewer:R,source:X.tileSource,viewport:R.viewport,drawer:R.drawer,tileCache:R.tileCache,imageLoader:R.imageLoader,x:X.options.x,y:X.options.y,width:X.options.width,height:X.options.height,fitBounds:X.options.fitBounds,fitBoundsPlacement:X.options.fitBoundsPlacement,clip:X.options.clip,placeholderFillStyle:X.options.placeholderFillStyle,opacity:X.options.opacity,preload:X.options.preload,degrees:X.options.degrees,flipped:X.options.flipped,compositeOperation:X.options.compositeOperation,springStiffness:R.springStiffness,animationTime:R.animationTime,minZoomImageRatio:R.minZoomImageRatio,wrapHorizontal:R.wrapHorizontal,wrapVertical:R.wrapVertical,maxTilesPerFrame:R.maxTilesPerFrame,immediateRender:R.immediateRender,blendTime:R.blendTime,alwaysBlend:R.alwaysBlend,minPixelRatio:R.minPixelRatio,smoothTileEdgesMinZoom:R.smoothTileEdgesMinZoom,iOSDevice:R.iOSDevice,crossOriginPolicy:X.options.crossOriginPolicy,ajaxWithCredentials:X.options.ajaxWithCredentials,loadTilesWithAjax:X.options.loadTilesWithAjax,ajaxHeaders:X.options.ajaxHeaders,debugMode:R.debugMode,subPixelRoundingForTransparency:R.subPixelRoundingForTransparency}),R.collectionMode&&R.world.setAutoRefigureSizes(!1),R.navigator&&(Be=e.extend({},X.options,{replace:!1,originalTiledImage:Ce,tileSource:X.tileSource}),R.navigator.addTiledImage(Be)),R.world.addItem(Ce,{index:X.options.index}),R._loadQueue.length===0&&re(X),R.world.getItemCount()===1&&!R.preserveViewport&&R.viewport.goHome(!0),X.options.success&&X.options.success({item:Ce})}}o(this,y.tileSource,y,function(X){B.tileSource=X,me()},function(X){X.options=y,K(X),me()})},addSimpleImage:function(y){e.console.assert(y,"[Viewer.addSimpleImage] options is required"),e.console.assert(y.url,"[Viewer.addSimpleImage] options.url is required");var R=e.extend({},y,{tileSource:{type:"image",url:y.url}});delete R.url,this.addTiledImage(R)},addLayer:function(y){var R=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var B=e.extend({},y,{success:function(K){R.raiseEvent("add-layer",{options:y,drawer:K.item})},error:function(K){R.raiseEvent("add-layer-failed",K)}});return this.addTiledImage(B),this},getLayerAtLevel:function(y){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(y)},getLevelOfLayer:function(y){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(y)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(y,R){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(y,R)},removeLayer:function(y){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(y)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var y=e.delegate(this,m),R=e.delegate(this,v),B=e.delegate(this,this.goToNextPage),K=e.delegate(this,this.goToPreviousPage),re=this.navImages,me=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(me=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:W(this.prefixUrl,re.previous.REST),srcGroup:W(this.prefixUrl,re.previous.GROUP),srcHover:W(this.prefixUrl,re.previous.HOVER),srcDown:W(this.prefixUrl,re.previous.DOWN),onRelease:K,onFocus:y,onBlur:R}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:W(this.prefixUrl,re.next.REST),srcGroup:W(this.prefixUrl,re.next.GROUP),srcHover:W(this.prefixUrl,re.next.HOVER),srcDown:W(this.prefixUrl,re.next.DOWN),onRelease:B,onFocus:y,onBlur:R}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),me&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var y=e.delegate(this,_e),R=e.delegate(this,gt),B=e.delegate(this,ht),K=e.delegate(this,ze),re=e.delegate(this,yt),me=e.delegate(this,rt),X=e.delegate(this,ut),Ce=e.delegate(this,dt),Be=e.delegate(this,ge),ke=e.delegate(this,Je),ve=e.delegate(this,m),Xe=e.delegate(this,v),x=this.navImages,T=[],C=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(C=!1),this.showZoomControl&&(T.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:W(this.prefixUrl,x.zoomIn.REST),srcGroup:W(this.prefixUrl,x.zoomIn.GROUP),srcHover:W(this.prefixUrl,x.zoomIn.HOVER),srcDown:W(this.prefixUrl,x.zoomIn.DOWN),onPress:y,onRelease:R,onClick:B,onEnter:y,onExit:R,onFocus:ve,onBlur:Xe})),T.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:W(this.prefixUrl,x.zoomOut.REST),srcGroup:W(this.prefixUrl,x.zoomOut.GROUP),srcHover:W(this.prefixUrl,x.zoomOut.HOVER),srcDown:W(this.prefixUrl,x.zoomOut.DOWN),onPress:K,onRelease:R,onClick:re,onEnter:K,onExit:R,onFocus:ve,onBlur:Xe}))),this.showHomeControl&&T.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:W(this.prefixUrl,x.home.REST),srcGroup:W(this.prefixUrl,x.home.GROUP),srcHover:W(this.prefixUrl,x.home.HOVER),srcDown:W(this.prefixUrl,x.home.DOWN),onRelease:me,onFocus:ve,onBlur:Xe})),this.showFullPageControl&&T.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:W(this.prefixUrl,x.fullpage.REST),srcGroup:W(this.prefixUrl,x.fullpage.GROUP),srcHover:W(this.prefixUrl,x.fullpage.HOVER),srcDown:W(this.prefixUrl,x.fullpage.DOWN),onRelease:X,onFocus:ve,onBlur:Xe})),this.showRotationControl&&(T.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:W(this.prefixUrl,x.rotateleft.REST),srcGroup:W(this.prefixUrl,x.rotateleft.GROUP),srcHover:W(this.prefixUrl,x.rotateleft.HOVER),srcDown:W(this.prefixUrl,x.rotateleft.DOWN),onRelease:Ce,onFocus:ve,onBlur:Xe})),T.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:W(this.prefixUrl,x.rotateright.REST),srcGroup:W(this.prefixUrl,x.rotateright.GROUP),srcHover:W(this.prefixUrl,x.rotateright.HOVER),srcDown:W(this.prefixUrl,x.rotateright.DOWN),onRelease:Be,onFocus:ve,onBlur:Xe}))),this.showFlipControl&&T.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:W(this.prefixUrl,x.flip.REST),srcGroup:W(this.prefixUrl,x.flip.GROUP),srcHover:W(this.prefixUrl,x.flip.HOVER),srcDown:W(this.prefixUrl,x.flip.DOWN),onRelease:ke,onFocus:ve,onBlur:Xe})),C?(this.buttonGroup=new e.ButtonGroup({buttons:T,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,at)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=T),this},currentPage:function(){return this._sequenceIndex},goToPage:function(y){return this.tileSources&&y>=0&&y<this.tileSources.length&&(this._sequenceIndex=y,this._updateSequenceButtons(y),this.open(this.tileSources[y]),this.referenceStrip&&this.referenceStrip.setFocus(y),this.raiseEvent("page",{page:y})),this},addOverlay:function(y,R,B,K){var re;if(e.isPlainObject(y)?re=y:re={element:y,location:R,placement:B,onDraw:K},y=e.getElement(re.element),c(this.currentOverlays,y)>=0)return this;var me=a(this,re);return this.currentOverlays.push(me),me.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:y,location:re.location,placement:re.placement}),this},updateOverlay:function(y,R,B){var K;return y=e.getElement(y),K=c(this.currentOverlays,y),K>=0&&(this.currentOverlays[K].update(R,B),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:y,location:R,placement:B})),this},removeOverlay:function(y){var R;return y=e.getElement(y),R=c(this.currentOverlays,y),R>=0&&(this.currentOverlays[R].destroy(),this.currentOverlays.splice(R,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:y})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(y){var R;return y=e.getElement(y),R=c(this.currentOverlays,y),R>=0?this.currentOverlays[R]:null},_updateSequenceButtons:function(y){this.nextButton&&(!this.tileSources||this.tileSources.length-1===y?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(y>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(y){this._hideMessage();var R=e.makeNeutralElement("div");R.appendChild(document.createTextNode(y)),this.messageDiv=e.makeCenteredNode(R),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var y=this.messageDiv;y&&(y.parentNode.removeChild(y),delete this.messageDiv)},gestureSettingsByDeviceType:function(y){switch(y){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var y,R=this.currentOverlays.length;for(y=0;y<R;y++)this.currentOverlays[y].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var y=e.pixelDensityRatio,R=e.getCurrentPixelDensityRatio();y!==R&&(e.pixelDensityRatio=R,this.forceResize())},goToPreviousPage:function(){var y=this._sequenceIndex-1;this.navPrevNextWrap&&y<0&&(y+=this.tileSources.length),this.goToPage(y)},goToNextPage:function(){var y=this._sequenceIndex+1;this.navPrevNextWrap&&y>=this.tileSources.length&&(y=0),this.goToPage(y)},isAnimating:function(){return i[this.hash].animating}});function r(y){return y=e.getElement(y),new e.Point(y.clientWidth===0?1:y.clientWidth,y.clientHeight===0?1:y.clientHeight)}function o(y,R,B,K,re){var me=y;if(e.type(R)==="string"){if(R.match(/^\s*<.*>\s*$/))R=e.parseXml(R);else if(R.match(/^\s*[{[].*[}\]]\s*$/))try{var X=e.parseJSON(R);R=X}catch{}}function Ce(Be,ke){Be.ready?K(Be):(Be.addHandler("ready",function(){K(Be)}),Be.addHandler("open-failed",function(ve){re({message:ve.message,source:ke})}))}setTimeout(function(){if(e.type(R)==="string")R=new e.TileSource({url:R,crossOriginPolicy:B.crossOriginPolicy!==void 0?B.crossOriginPolicy:y.crossOriginPolicy,ajaxWithCredentials:y.ajaxWithCredentials,ajaxHeaders:B.ajaxHeaders?B.ajaxHeaders:y.ajaxHeaders,splitHashDataForPost:y.splitHashDataForPost,success:function(Xe){K(Xe.tileSource)}}),R.addHandler("open-failed",function(Xe){re(Xe)});else if(e.isPlainObject(R)||R.nodeType)if(R.crossOriginPolicy===void 0&&(B.crossOriginPolicy!==void 0||y.crossOriginPolicy!==void 0)&&(R.crossOriginPolicy=B.crossOriginPolicy!==void 0?B.crossOriginPolicy:y.crossOriginPolicy),R.ajaxWithCredentials===void 0&&(R.ajaxWithCredentials=y.ajaxWithCredentials),e.isFunction(R.getTileUrl)){var Be=new e.TileSource(R);Be.getTileUrl=R.getTileUrl,K(Be)}else{var ke=e.TileSource.determineType(me,R);if(!ke){re({message:"Unable to load TileSource",source:R});return}var ve=ke.prototype.configure.apply(me,[R]);Ce(new ke(ve),R)}else Ce(R,R)})}function a(y,R){if(R instanceof e.Overlay)return R;var B=null;if(R.element)B=e.getElement(R.element);else{var K=R.id?R.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);B=e.getElement(R.id),B||(B=document.createElement("a"),B.href="#/overlay/"+K),B.id=K,e.addClass(B,R.className?R.className:"openseadragon-overlay")}var re=R.location,me=R.width,X=R.height;if(!re){var Ce=R.x,Be=R.y;if(R.px!==void 0){var ke=y.viewport.imageToViewportRectangle(new e.Rect(R.px,R.py,me||0,X||0));Ce=ke.x,Be=ke.y,me=me!==void 0?ke.width:void 0,X=X!==void 0?ke.height:void 0}re=new e.Point(Ce,Be)}var ve=R.placement;return ve&&e.type(ve)==="string"&&(ve=e.Placement[R.placement.toUpperCase()]),new e.Overlay({element:B,location:re,placement:ve,onDraw:R.onDraw,checkResize:R.checkResize,width:me,height:X,rotationMode:R.rotationMode})}function c(y,R){var B;for(B=y.length-1;B>=0;B--)if(y[B].element===R)return B;return-1}function h(y,R){return e.requestAnimationFrame(function(){R(y)})}function d(y){e.requestAnimationFrame(function(){p(y)})}function l(y){y.autoHideControls&&(y.controlsShouldFade=!0,y.controlsFadeBeginTime=e.now()+y.controlsFadeDelay,window.setTimeout(function(){d(y)},y.controlsFadeDelay))}function p(y){var R,B,K,re;if(y.controlsShouldFade){for(R=e.now(),B=R-y.controlsFadeBeginTime,K=1-B/y.controlsFadeLength,K=Math.min(1,K),K=Math.max(0,K),re=y.controls.length-1;re>=0;re--)y.controls[re].autoFade&&y.controls[re].setOpacity(K);K>0&&d(y)}}function f(y){var R;for(y.controlsShouldFade=!1,R=y.controls.length-1;R>=0;R--)y.controls[R].setOpacity(1)}function m(){f(this)}function v(){l(this)}function w(y){var R={tracker:y.eventSource,position:y.position,originalEvent:y.originalEvent,preventDefault:y.preventDefault};this.raiseEvent("canvas-contextmenu",R),y.preventDefault=R.preventDefault}function b(y){var R={originalEvent:y.originalEvent,preventDefaultAction:!1,preventVerticalPan:y.preventVerticalPan||!this.panVertical,preventHorizontalPan:y.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",R),!R.preventDefaultAction&&!y.ctrl&&!y.alt&&!y.meta)switch(y.keyCode){case 38:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 40:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 37:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 39:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 87:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 83:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 65:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 68:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 82:y.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),y.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:y.preventDefault=!1;break}else y.preventDefault=!1}function I(y){var R={originalEvent:y.originalEvent};this.raiseEvent("canvas-key-press",R)}function O(y){var R,B=document.activeElement===this.canvas;B||this.canvas.focus(),this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x);var K={tracker:y.eventSource,position:y.position,quick:y.quick,shift:y.shift,originalEvent:y.originalEvent,originalTarget:y.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",K),!K.preventDefaultAction&&this.viewport&&y.quick&&(R=this.gestureSettingsByDeviceType(y.pointerType),R.clickToZoom===!0&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,R.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()),R.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function N(y){var R,B={tracker:y.eventSource,position:y.position,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",B),!B.preventDefaultAction&&this.viewport&&(R=this.gestureSettingsByDeviceType(y.pointerType),R.dblClickToZoom&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,R.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()))}function q(y){var R,B={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,delta:y.delta,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",B),R=this.gestureSettingsByDeviceType(y.pointerType),!B.preventDefaultAction&&this.viewport){if(R.dblClickDragToZoom&&i[this.hash].draggingToZoom){var K=Math.pow(this.zoomPerDblClickDrag,y.delta.y/50);this.viewport.zoomBy(K)}else if(R.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(y.delta.x=0),this.panVertical||(y.delta.y=0),this.viewport.flipped&&(y.delta.x=-y.delta.x),this.constrainDuringPan){var re=this.viewport.deltaPointsFromPixels(y.delta.negate());this.viewport.centerSpringX.target.value+=re.x,this.viewport.centerSpringY.target.value+=re.y;var me=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=re.x,this.viewport.centerSpringY.target.value-=re.y,me.xConstrained&&(y.delta.x=0),me.yConstrained&&(y.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(y.delta.negate()),R.flickEnabled&&!this.constrainDuringPan)}}}function ie(y){var R,B={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",B),R=this.gestureSettingsByDeviceType(y.pointerType),!B.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&R.dragToPan&&R.flickEnabled&&y.speed>=R.flickMinSpeed){var K=0;this.panHorizontal&&(K=R.flickMomentum*y.speed*Math.cos(y.direction));var re=0;this.panVertical&&(re=R.flickMomentum*y.speed*Math.sin(y.direction));var me=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),X=this.viewport.pointFromPixel(new e.Point(me.x-K,me.y-re));this.viewport.panTo(X,!1)}this.viewport.applyConstraints()}R.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function k(y){this.raiseEvent("canvas-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function S(y){this.raiseEvent("canvas-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function E(y){var R;if(this.raiseEvent("canvas-press",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent}),R=this.gestureSettingsByDeviceType(y.pointerType),R.dblClickDragToZoom){var B=i[this.hash].lastClickTime,K=e.now();if(B===null)return;K-B<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function D(y){this.raiseEvent("canvas-release",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent})}function L(y){this.raiseEvent("canvas-nonprimary-press",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function F(y){this.raiseEvent("canvas-nonprimary-release",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function A(y){var R,B,K,re,me={tracker:y.eventSource,pointerType:y.pointerType,gesturePoints:y.gesturePoints,lastCenter:y.lastCenter,center:y.center,lastDistance:y.lastDistance,distance:y.distance,shift:y.shift,originalEvent:y.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",me),this.viewport&&(R=this.gestureSettingsByDeviceType(y.pointerType),R.pinchToZoom&&(!me.preventDefaultPanAction||!me.preventDefaultZoomAction)&&(B=this.viewport.pointFromPixel(y.center,!0),R.zoomToRefPoint&&!me.preventDefaultPanAction&&(K=this.viewport.pointFromPixel(y.lastCenter,!0),re=K.minus(B),this.panHorizontal||(re.x=0),this.panVertical||(re.y=0),this.viewport.panBy(re,!0)),me.preventDefaultZoomAction||this.viewport.zoomBy(y.distance/y.lastDistance,B,!0),this.viewport.applyConstraints()),R.pinchRotate&&!me.preventDefaultRotateAction)){var X=Math.atan2(y.gesturePoints[0].currentPos.y-y.gesturePoints[1].currentPos.y,y.gesturePoints[0].currentPos.x-y.gesturePoints[1].currentPos.x),Ce=Math.atan2(y.gesturePoints[0].lastPos.y-y.gesturePoints[1].lastPos.y,y.gesturePoints[0].lastPos.x-y.gesturePoints[1].lastPos.x);B=this.viewport.pointFromPixel(y.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(X-Ce)*(180/Math.PI),B,!0)}}function V(y){this.raiseEvent("canvas-focus",{tracker:y.eventSource,originalEvent:y.originalEvent})}function ne(y){this.raiseEvent("canvas-blur",{tracker:y.eventSource,originalEvent:y.originalEvent})}function ce(y){var R,B,K,re,me;re=e.now(),me=re-this._lastScrollTime,me>this.minScrollDeltaTime?(this._lastScrollTime=re,R={tracker:y.eventSource,position:y.position,scroll:y.scroll,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",R),!R.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x),B=this.gestureSettingsByDeviceType(y.pointerType),B.scrollToZoom&&(K=Math.pow(this.zoomPerScroll,y.scroll),this.viewport.zoomBy(K,B.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints())),y.preventDefault=R.preventDefault):y.preventDefault=!0}function G(y){i[this.hash].mouseInside=!0,f(this),this.raiseEvent("container-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function J(y){y.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||l(this)),this.raiseEvent("container-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function $(y){Oe(y),y.isOpen()?y._updateRequestId=h(y,$):y._updateRequestId=!1}function oe(y,R){var B=y.viewport,K=B.getZoom(),re=B.getCenter();B.resize(R,y.preserveImageSizeOnResize),B.panTo(re,!0);var me;if(y.preserveImageSizeOnResize)me=i[y.hash].prevContainerSize.x/R.x;else{var X=new e.Point(0,0),Ce=new e.Point(i[y.hash].prevContainerSize.x,i[y.hash].prevContainerSize.y).distanceTo(X),Be=new e.Point(R.x,R.y).distanceTo(X);me=Be/Ce*i[y.hash].prevContainerSize.x/R.x}B.zoomTo(K*me,null,!0),i[y.hash].prevContainerSize=R,i[y.hash].forceRedraw=!0,i[y.hash].needsResize=!1,i[y.hash].forceResize=!1}function Oe(y){if(!(y._opening||!i[y.hash])){if(y.autoResize||i[y.hash].forceResize){var R;if(y._autoResizePolling){R=r(y.container);var B=i[y.hash].prevContainerSize;R.equals(B)||(i[y.hash].needsResize=!0)}i[y.hash].needsResize&&oe(y,R||r(y.container))}var K=y.viewport.update(),re=y.world.update(K)||K;K&&y.raiseEvent("viewport-change"),y.referenceStrip&&(re=y.referenceStrip.update(y.viewport)||re);var me=i[y.hash].animating;!me&&re&&(y.raiseEvent("animation-start"),f(y));var X=me&&!re;X&&(i[y.hash].animating=!1),(re||X||i[y.hash].forceRedraw||y.world.needsDraw())&&(we(y),y._drawOverlays(),y.navigator&&y.navigator.update(y.viewport),i[y.hash].forceRedraw=!1,re&&y.raiseEvent("animation")),X&&(y.raiseEvent("animation-finish"),i[y.hash].mouseInside||l(y)),i[y.hash].animating=re}}function we(y){y.imageLoader.clear(),y.world.draw(),y.raiseEvent("update-viewport",{})}function W(y,R){return y?y+R:R}function _e(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,Le(this)}function ze(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,Le(this)}function gt(){i[this.hash].zooming=!1}function Le(y){e.requestAnimationFrame(e.delegate(y,vt))}function vt(){var y,R,B;i[this.hash].zooming&&this.viewport&&(y=e.now(),R=y-i[this.hash].lastZoomTime,B=Math.pow(i[this.hash].zoomFactor,R/1e3),this.viewport.zoomBy(B),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=y,Le(this))}function ht(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function yt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function at(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function rt(){this.viewport&&this.viewport.goHome()}function ut(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function dt(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y+=this.rotationIncrement:y-=this.rotationIncrement,this.viewport.setRotation(y)}}function ge(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y-=this.rotationIncrement:y+=this.rotationIncrement,this.viewport.setRotation(y)}}function Je(){this.viewport.toggleFlip()}e.determineDrawer=function(y){for(let R in t){const B=t[R],K=B.prototype;if(K&&K instanceof t.DrawerBase&&e.isFunction(K.getType)&&K.getType.call(B)===y)return B}return null}}(t),function(e){e.Navigator=function(h){var d=h.viewer,l=this,p,f;h.element||h.id?(h.element?(h.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),h.element.id?h.id=h.element.id:h.id="navigator-"+e.now(),this.element=h.element):this.element=document.getElementById(h.id),h.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(h.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),h.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:h.autoFade},h.position&&(h.position==="BOTTOM_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:h.position==="BOTTOM_LEFT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:h.position==="TOP_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:h.position==="TOP_LEFT"?h.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:h.position==="ABSOLUTE"&&(h.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,h.controlOptions.top=h.top,h.controlOptions.left=h.left,h.controlOptions.height=h.height,h.controlOptions.width=h.width))),this.element.id=h.id,this.element.className+=" navigator",h=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},h,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:h.animationTime,autoResize:!1,minZoomImageRatio:1,background:h.background,opacity:h.opacity,borderColor:h.borderColor,displayRegionColor:h.displayRegionColor}),h.minPixelRatio=this.minPixelRatio=d.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),h.controlOptions.anchor!==e.ControlAnchor.NONE&&function(w,b){w.margin="0px",w.border=b+"px solid "+h.borderColor,w.padding="0px",w.background=h.background,w.opacity=h.opacity,w.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(w,b){w.position="relative",w.top="0px",w.left="0px",w.fontSize="0px",w.overflow="hidden",w.border=b+"px solid "+h.displayRegionColor,w.margin="0px",w.padding="0px",w.background="transparent",w.float="left",w.cssFloat="left",w.zIndex=999999999,w.cursor="default",w.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),d.addControl(this.element,h.controlOptions),this._resizeWithViewer=h.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&h.controlOptions.anchor!==e.ControlAnchor.NONE,h.width&&h.height?(this.setWidth(h.width),this.setHeight(h.height)):this._resizeWithViewer&&(p=e.getElementSize(d.element),this.element.style.height=Math.round(p.y*h.sizeRatio)+"px",this.element.style.width=Math.round(p.x*h.sizeRatio)+"px",this.oldViewerSize=p,f=e.getElementSize(this.element),this.elementArea=f.x*f.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[h]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function m(w,b){a(l.displayRegionContainer,w),a(l.displayRegion,-w),l.viewport.setRotation(w,b)}if(h.navigatorRotate){var v=h.viewer.viewport?h.viewer.viewport.getRotation():h.viewer.degrees||0;m(v,!0),h.viewer.addHandler("rotate",function(w){m(w.degrees,w.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(w){w.eventType==="wheel"&&(w.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){l.viewport&&l.viewport.goHome(!0)}),d.world.addHandler("item-index-change",function(w){window.setTimeout(function(){var b=l.world.getItemAt(w.previousIndex);l.world.setItemIndex(b,w.newIndex)},1)}),d.world.addHandler("remove-item",function(w){var b=w.item,I=l._getMatchingItem(b);I&&l.world.removeItem(I)}),this.update(d.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var h=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);h.equals(this.oldContainerSize)||(this.viewport.resize(h,!0),this.viewport.goHome(!0),this.oldContainerSize=h,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(h){this.width=h,this.element.style.width=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(h){this.height=h,this.element.style.height=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(h){return this.viewport.setFlip(h),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(h){c(this.canvas,h),c(this.element,h)},update:function(h){var d,l,p,f,m,v;if(h||(h=this.viewer.viewport),d=e.getElementSize(this.viewer.element),this._resizeWithViewer&&d.x&&d.y&&!d.equals(this.oldViewerSize)&&(this.oldViewerSize=d,this.maintainSizeRatio||!this.elementArea?(l=d.x*this.sizeRatio,p=d.y*this.sizeRatio):(l=Math.sqrt(this.elementArea*(d.x/d.y)),p=this.elementArea/l),this.element.style.width=Math.round(l)+"px",this.element.style.height=Math.round(p)+"px",this.elementArea||(this.elementArea=l*p),this.updateSize()),h&&this.viewport){if(f=h.getBoundsNoRotate(!0),m=this.viewport.pixelFromPointNoRotate(f.getTopLeft(),!1),v=this.viewport.pixelFromPointNoRotate(f.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var w=h.getRotation(!0);a(this.displayRegion,-w)}var b=this.displayRegion.style;b.display=this.world.getItemCount()?"block":"none",b.top=m.y.toFixed(2)+"px",b.left=m.x.toFixed(2)+"px";var I=v.x-m.x,O=v.y-m.y;b.width=Math.round(Math.max(I,0))+"px",b.height=Math.round(Math.max(O,0))+"px"}},addTiledImage:function(h){var d=this,l=h.originalTiledImage;delete h.original;var p=e.extend({},h,{success:function(f){var m=f.item;m._originalForNavigator=l,d._matchBounds(m,l,!0),d._matchOpacity(m,l),d._matchCompositeOperation(m,l);function v(){d._matchBounds(m,l)}function w(){d._matchOpacity(m,l)}function b(){d._matchCompositeOperation(m,l)}l.addHandler("bounds-change",v),l.addHandler("clip-change",v),l.addHandler("opacity-change",w),l.addHandler("composite-operation-change",b)}});return e.Viewer.prototype.addTiledImage.apply(this,[p])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(h){for(var d=this.world.getItemCount(),l,p=0;p<d;p++)if(l=this.world.getItemAt(p),l._originalForNavigator===h)return l;return null},_matchBounds:function(h,d,l){var p=d.getBoundsNoRotate();h.setPosition(p.getTopLeft(),l),h.setWidth(p.width,l),h.setRotation(d.getRotation(),l),h.setClip(d.getClip()),h.setFlip(d.getFlip())},_matchOpacity:function(h,d){h.setOpacity(d.opacity)},_matchCompositeOperation:function(h,d){h.setCompositeOperation(d.compositeOperation)}});function i(h){var d={tracker:h.eventSource,position:h.position,quick:h.quick,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",d),!d.preventDefaultAction&&h.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(h.position.x=this.viewport.getContainerSize().x-h.position.x);var l=this.viewport.pointFromPixel(h.position);this.panVertical?this.panHorizontal||(l.x=this.viewer.viewport.getCenter(!0).x):l.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(l),this.viewer.viewport.applyConstraints()}}function n(h){var d={tracker:h.eventSource,position:h.position,delta:h.delta,speed:h.speed,direction:h.direction,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",d),!d.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(h.delta.x=0),this.panVertical||(h.delta.y=0),this.viewer.viewport.flipped&&(h.delta.x=-h.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(h.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(h){h.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(h){var d={tracker:h.eventSource,position:h.position,scroll:h.scroll,shift:h.shift,originalEvent:h.originalEvent,preventDefault:h.preventDefault};this.viewer.raiseEvent("navigator-scroll",d),h.preventDefault=d.preventDefault}function a(h,d){c(h,"rotate("+d+"deg)")}function c(h,d){h.style.webkitTransform=d,h.style.mozTransform=d,h.style.msTransform=d,h.style.oTransform=d,h.style.transform=d}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,c=i,h;for(h=0;h<r.length-1;h++)c=c[r[h]]||{};return o=c[r[h]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(d){var l=parseInt(d.match(/\d+/),10)+1;return l<a.length?a[l]:""})},setString:function(n,r){var o=n.split("."),a=i,c;for(c=0;c<o.length-1;c++)a[o[c]]||(a[o[c]]={}),a=a[o[c]];a[o[c]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var c=i*Math.PI/180;r=Math.cos(c),o=Math.sin(c)}var h=r*(this.x-n.x)-o*(this.y-n.y)+n.x,d=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(h,d)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,c,h){var d=this,l=arguments,p,f;if(e.isPlainObject(n)?p=n:p={width:l[0],height:l[1],tileSize:l[2],tileOverlap:l[3],minLevel:l[4],maxLevel:l[5]},e.EventSource.call(this),e.extend(!0,this,p),!this.success){for(f=0;f<arguments.length;f++)if(e.isFunction(arguments[f])){this.success=arguments[f];break}}this.success&&this.addHandler("ready",function(m){d.success(m)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=p.width&&p.height?p.width/p.height:1,this.dimensions=new e.Point(p.width,p.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=p.tileOverlap?p.tileOverlap:0,this.minLevel=p.minLevel?p.minLevel:0,this.maxLevel=p.maxLevel!==void 0&&p.maxLevel!==null?p.maxLevel:p.width&&p.height?Math.ceil(Math.log(Math.max(p.width,p.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),c=r.x*a,h=r.y*a,d=Math.floor(c/this.getTileWidth(n)),l=Math.floor(h/this.getTileHeight(n));r.x>=1&&(d=this.getNumTiles(n).x-1);var p=1e-15;return r.y>=1/this.aspectRatio-p&&(l=this.getNumTiles(n).y-1),new e.Point(d,l)},getTileBounds:function(n,r,o,a){var c=this.dimensions.times(this.getLevelScale(n)),h=this.getTileWidth(n),d=this.getTileHeight(n),l=r===0?0:h*r-this.tileOverlap,p=o===0?0:d*o-this.tileOverlap,f=h+(r===0?1:2)*this.tileOverlap,m=d+(o===0?1:2)*this.tileOverlap,v=1/c.x;return f=Math.min(f,c.x-l),m=Math.min(m,c.y-p),a?new e.Rect(0,0,f,m):new e.Rect(l*v,p*v,f*v,m*v)},getImageInfo:function(n){var r=this,o,a,c,h,d,l,p;n&&(d=n.split("/"),l=d[d.length-1],p=l.lastIndexOf("."),p>-1&&(d[d.length-1]=l.slice(0,p)));var f=null;if(this.splitHashDataForPost){var m=n.indexOf("#");m!==-1&&(f=n.substring(m+1),n=n.substr(0,m))}a=function(v){typeof v=="string"&&(v=e.parseXml(v));var w=e.TileSource.determineType(r,v,n);if(!w){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}h=w.prototype.configure.apply(r,[v,n,f]),h.ajaxWithCredentials===void 0&&(h.ajaxWithCredentials=r.ajaxWithCredentials),c=new w(h),r.ready=!0,r.raiseEvent("ready",{tileSource:c})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:f,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(v){var w=i(v);a(w)},error:function(v,w){var b;try{b="HTTP "+v.status+" attempting to load TileSource: "+n}catch{var I;typeof w>"u"||!w.toString?I="Unknown error":I=w.toString(),b=I+" attempting to load TileSource: "+n}e.console.error(b),r.raiseEvent("open-failed",{message:b,source:n,postData:f})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,c,h){function d(l){return c?l+"+"+JSON.stringify(c):l}return d(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(c){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(c?null:o,r.request,c)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(c){var h;try{h=new window.Blob([c.response])}catch(p){var d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(p.name==="TypeError"&&d){var l=new d;l.append(c.response),h=l.getBlob()}}h.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(h)},error:function(c){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,c;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{c=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{c=n.responseText}else if(r.match(/\s*[{[].*/))try{c=e.parseJSON(r)}catch{c=r}else c=r;return c}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,c,h,d,l,p,f){var m,v,w,b;if(e.isPlainObject(r)?b=r:b={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=b.tilesUrl,this.fileFormat=b.fileFormat,this.displayRects=b.displayRects,this.displayRects)for(m=this.displayRects.length-1;m>=0;m--)for(v=this.displayRects[m],w=v.minLevel;w<=v.maxLevel;w++)this._levelRects[w]||(this._levelRects[w]=[]),this._levelRects[w].push(v);e.TileSource.apply(this,[b])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var c;return e.isPlainObject(r)?c=n(this,r):c=i(this,r),o&&!c.tilesUrl&&(c.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?c.queryParams=o.match(/\?.*/):c.queryParams=""),c},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var c=this._levelRects[r],h,d,l,p,f,m,v;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!c||!c.length)return!0;for(v=c.length-1;v>=0;v--)if(h=c[v],!(r<h.minLevel||r>h.maxLevel)&&(d=this.getLevelScale(r),l=h.x*d,p=h.y*d,f=l+h.width*d,m=p+h.height*d,l=Math.floor(l/this._tileWidth),p=Math.floor(p/this._tileWidth),f=Math.ceil(f/this._tileWidth),m=Math.ceil(m/this._tileWidth),l<=o&&o<f&&p<=a&&a<m))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,c=a.localName||a.tagName,h=o.documentElement.namespaceURI,d=null,l=[],p,f,m,v,w;if(c==="Image")try{if(v=a.getElementsByTagName("Size")[0],v===void 0&&(v=a.getElementsByTagNameNS(h,"Size")[0]),d={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(v.getAttribute("Height"),10),Width:parseInt(v.getAttribute("Width"),10)}}},!e.imageFormatSupported(d.Image.Format))throw new Error(e.getString("Errors.ImageFormat",d.Image.Format.toUpperCase()));for(p=a.getElementsByTagName("DisplayRect"),p===void 0&&(p=a.getElementsByTagNameNS(h,"DisplayRect")[0]),w=0;w<p.length;w++)f=p[w],m=f.getElementsByTagName("Rect")[0],m===void 0&&(m=f.getElementsByTagNameNS(h,"Rect")[0]),l.push({Rect:{X:parseInt(m.getAttribute("X"),10),Y:parseInt(m.getAttribute("Y"),10),Width:parseInt(m.getAttribute("Width"),10),Height:parseInt(m.getAttribute("Height"),10),MinLevel:parseInt(f.getAttribute("MinLevel"),10),MaxLevel:parseInt(f.getAttribute("MaxLevel"),10)}});return l.length&&(d.Image.DisplayRect=l),n(r,d)}catch(O){throw O instanceof Error?O:new Error(e.getString("Errors.Dzi"))}else{if(c==="Collection")throw new Error(e.getString("Errors.Dzc"));if(c==="Error"){var b=a.getElementsByTagName("Message")[0],I=b.firstChild.nodeValue;throw new Error(I)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,c=a.Url,h=a.Format,d=a.Size,l=a.DisplayRect||[],p=parseInt(d.Width,10),f=parseInt(d.Height,10),m=parseInt(a.TileSize,10),v=parseInt(a.Overlap,10),w=[],b,I;for(I=0;I<l.length;I++)b=l[I].Rect,w.push(new e.DisplayRect(parseInt(b.X,10),parseInt(b.Y,10),parseInt(b.Width,10),parseInt(b.Height,10),parseInt(b.MinLevel,10),parseInt(b.MaxLevel,10)));return e.extend(!0,{width:p,height:f,tileSize:m,tileOverlap:v,minLevel:null,maxLevel:null,tilesUrl:c,fileFormat:h,displayRects:w},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var c=0;c<this.tiles.length;c++)for(var h=0;h<this.tiles[c].scaleFactors.length;h++){var d=this.tiles[c].scaleFactors[h];this.scale_factors.push(d),a.tileSizePerScaleFactor[d]={width:this.tiles[c].width,height:this.tiles[c].height||this.tiles[c].width}}}else if(i(a)){for(var l=Math.min(this.height,this.width),p=[256,512,1024],f=[],m=0;m<p.length;m++)p[m]<=l&&f.push(p[m]);f.length>0?a.tileSize=Math.max.apply(null,f):a.tileSize=l}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var v=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(v)*Math.LOG2E)}if(this.sizes){var w=this.sizes.length;(w===a.maxLevel||w===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((b,I)=>b.width-I.width),w===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,c){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,c,h){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=c.replace("/info.json",""),a.version=1;else{var l=a["@context"];if(Array.isArray(l)){for(var p=0;p<l.length;p++)if(typeof l[p]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(l[p])||l[p]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){l=l[p];break}}switch(l){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var f=0;f<a.preferredFormats.length;f++)if(t.imageFormatSupported(a.preferredFormats[f])){a.tileFormat=a.preferredFormats[f];break}}return a}else{var d=r(a);return d["@context"]="http://iiif.io/api/image/1.0/context.json",d["@id"]=c.replace("/info.xml",""),d.version=1,d}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var c=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(c=this.levels[a].width/this.levels[this.maxLevel].width),c}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var c=this.getLevelScale(a);return c?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var h=this.levelSizes[a],d=Math.ceil(h.width/this.getTileWidth(a)),l=Math.ceil(h.height/this.getTileHeight(a));return new e.Point(d,l)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,c){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var h=c.x>=0&&c.x<=1&&c.y>=0&&c.y<=1/this.aspectRatio;e.console.assert(h,"[TileSource.getTileAtPoint] must be called with a valid point.");var d=this.levelSizes[a].width,l=c.x*d,p=c.y*d,f=Math.floor(l/this.getTileWidth(a)),m=Math.floor(p/this.getTileHeight(a));c.x>=1&&(f=this.getNumTiles(a).x-1);var v=1e-15;return c.y>=1/this.aspectRatio-v&&(m=this.getNumTiles(a).y-1),new e.Point(f,m)}return e.TileSource.prototype.getTileAtPoint.call(this,a,c)},getTileUrl:function(a,c,h){if(this.emulateLegacyImagePyramid){var d=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(d=this.levels[a].url),d}var l="0",p=Math.pow(.5,this.maxLevel-a),f,m,v,w,b,I,O,N,q,ie,k,S,E,D,L,F;return this.levelSizes?(f=this.levelSizes[a].width,m=this.levelSizes[a].height):(f=Math.ceil(this.width*p),m=Math.ceil(this.height*p)),v=this.getTileWidth(a),w=this.getTileHeight(a),b=Math.round(v/p),I=Math.round(w/p),this.version===1?L="native."+this.tileFormat:L="default."+this.tileFormat,f<v&&m<w?(this.version===2&&f===this.width?S="full":this.version===3&&f===this.width&&m===this.height?S="max":this.version===3?S=f+","+m:S=f+",",O="full"):(N=c*b,q=h*I,ie=Math.min(b,this.width-N),k=Math.min(I,this.height-q),c===0&&h===0&&ie===this.width&&k===this.height?O="full":O=[N,q,ie,k].join(","),E=Math.min(v,f-c*v),D=Math.min(w,m-h*w),this.version===2&&E===this.width?S="full":this.version===3&&E===this.width&&D===this.height?S="max":this.version===3?S=E+","+D:S=E+","),F=[this._id,O,S,l,L].join("/"),F},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var c=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],h=Array.isArray(a.profile)?a.profile[0]:a.profile,d=c.indexOf(h)!==-1,l=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(l=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(l=a.extraFeatures.indexOf("sizeByWh")!==-1),!d||l}function n(a){for(var c=[],h=0;h<a.sizes.length;h++)c.push({url:a._id+"/full/"+a.sizes[h].width+","+(a.version===3?a.sizes[h].height:"")+"/0/default."+a.tileFormat,width:a.sizes[h].width,height:a.sizes[h].height});return c.sort(function(d,l){return d.width-l.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null;if(h==="info")try{return d={},o(c,d),d}catch(l){throw l instanceof Error?l:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,c,h){var d,l;if(a.nodeType===3&&h)l=a.nodeValue.trim(),l.match(/^\d*$/)&&(l=Number(l)),c[h]?(e.isArray(c[h])||(c[h]=[c[h]]),c[h].push(l)):c[h]=l;else if(a.nodeType===1)for(d=0;d<a.childNodes.length;d++)o(a.childNodes[d],c,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!c.width||!c.height)&&(c.width=65572864,c.height=65572864),c.tileSize||(c.tileSize=256,c.tileOverlap=0),c.tilesUrl||(c.tilesUrl="http://tile.openstreetmap.org/"),c.minLevel=8,e.TileSource.apply(this,[c])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var h=Math.ceil(c.width/256)*256,d=Math.ceil(c.height/256)*256,l;h>d?l=h/256:l=d/256,c.maxLevel=Math.ceil(Math.log(l)/Math.log(2))-1,c.tileSize=256,c.width=h,c.height=d,e.TileSource.apply(this,[c])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},c=0;c<i;c++)a=this.gridSize[c],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,c,h;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(c=a.levels[a.levels.length-1].width,h=a.levels[a.levels.length-1].height):(c=0,h=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:c,height:h,tileSize:Math.max(h,c),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,c){var h;return e.isPlainObject(o)?h=r(this,o):h=n(this,o),h},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,c){var h=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(h=this.levels[o].url),h}});function i(o){var a=[],c,h;for(h=0;h<o.length;h++)c=o[h],c.height&&c.width&&c.url?a.push({url:c.url,width:Number(c.width),height:Number(c.height)}):e.console.error("Unsupported image format: %s",c.url?c.url:"<no URL>");return a.sort(function(d,l){return d.height-l.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null,l=[],p,f;if(h==="image")try{for(d={type:c.getAttribute("type"),levels:[]},l=c.getElementsByTagName("level"),f=0;f<l.length;f++)p=l[f],d.levels.push({url:p.getAttribute("url"),width:parseInt(p.getAttribute("width"),10),height:parseInt(p.getAttribute("height"),10)});return r(o,d)}catch(m){throw m instanceof Error?m:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(h==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(h==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+h)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var c=document.createElement("canvas"),h=c.getContext("2d");c.width=n,c.height=r,h.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:h,width:n,height:r}),o=c,a=h}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(h){var d=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},h),this.element=h.element||e.makeNeutralElement("div"),h.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(l){l.insideElementPressed?(a(d,e.ButtonState.DOWN),d.raiseEvent("enter",{originalEvent:l.originalEvent})):l.buttonDownAny||a(d,e.ButtonState.HOVER)},focusHandler:function(l){d.tracker.enterHandler(l),d.raiseEvent("focus",{originalEvent:l.originalEvent})},leaveHandler:function(l){c(d,e.ButtonState.GROUP),l.insideElementPressed&&d.raiseEvent("exit",{originalEvent:l.originalEvent})},blurHandler:function(l){d.tracker.leaveHandler(l),d.raiseEvent("blur",{originalEvent:l.originalEvent})},pressHandler:function(l){a(d,e.ButtonState.DOWN),d.raiseEvent("press",{originalEvent:l.originalEvent})},releaseHandler:function(l){l.insideElementPressed&&l.insideElementReleased?(c(d,e.ButtonState.HOVER),d.raiseEvent("release",{originalEvent:l.originalEvent})):l.insideElementPressed?c(d,e.ButtonState.GROUP):a(d,e.ButtonState.HOVER)},clickHandler:function(l){l.quick&&d.raiseEvent("click",{originalEvent:l.originalEvent})},keyHandler:function(l){l.keyCode===13?(d.raiseEvent("click",{originalEvent:l.originalEvent}),d.raiseEvent("release",{originalEvent:l.originalEvent}),l.preventDefault=!0):l.preventDefault=!1}}),c(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){c(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(h){e.requestAnimationFrame(function(){n(h)})}function n(h){var d,l,p;h.shouldFade&&(d=e.now(),l=d-h.fadeBeginTime,p=1-l/h.fadeLength,p=Math.min(1,p),p=Math.max(0,p),h.imgGroup&&e.setElementOpacity(h.imgGroup,p,!0),p>0&&i(h))}function r(h){h.shouldFade=!0,h.fadeBeginTime=e.now()+h.fadeDelay,window.setTimeout(function(){i(h)},h.fadeDelay)}function o(h){h.shouldFade=!1,h.imgGroup&&e.setElementOpacity(h.imgGroup,1,!0)}function a(h,d){h.element.disabled||(d>=e.ButtonState.GROUP&&h.currentState===e.ButtonState.REST&&(o(h),h.currentState=e.ButtonState.GROUP),d>=e.ButtonState.HOVER&&h.currentState===e.ButtonState.GROUP&&(h.imgHover&&(h.imgHover.style.visibility=""),h.currentState=e.ButtonState.HOVER),d>=e.ButtonState.DOWN&&h.currentState===e.ButtonState.HOVER&&(h.imgDown&&(h.imgDown.style.visibility=""),h.currentState=e.ButtonState.DOWN))}function c(h,d){h.element.disabled||(d<=e.ButtonState.HOVER&&h.currentState===e.ButtonState.DOWN&&(h.imgDown&&(h.imgDown.style.visibility="hidden"),h.currentState=e.ButtonState.HOVER),d<=e.ButtonState.GROUP&&h.currentState===e.ButtonState.HOVER&&(h.imgHover&&(h.imgHover.style.visibility="hidden"),h.currentState=e.ButtonState.GROUP),d<=e.ButtonState.REST&&h.currentState===e.ButtonState.GROUP&&(r(h),h.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var c;for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupEnter()},leaveHandler:function(a){var c;if(!a.insideElementPressed)for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var c,h;this.degrees>=270?(c=this.getTopRight(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=270):this.degrees>=180?(c=this.getBottomRight(),this.x=c.x,this.y=c.y,this.degrees-=180):this.degrees>=90&&(c=this.getBottomLeft(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),c=n.minus(i),h=Math.atan(c.y/c.x);return c.x<0?h+=Math.PI:c.y<0&&(h+=2*Math.PI),new e.Rect(i.x,i.y,o,a,h/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),c=Math.max(n.x+n.width,r.x+r.width),h=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,c-o,h-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var c=this.getBottomLeft();i.containsPoint(c,n)&&r.push(c);var h=this.getBottomRight();i.containsPoint(h,n)&&r.push(h);var d=i.getTopLeft();this.containsPoint(d,n)&&r.push(d);var l=i.getTopRight();this.containsPoint(l,n)&&r.push(l);var p=i.getBottomLeft();this.containsPoint(p,n)&&r.push(p);var f=i.getBottomRight();this.containsPoint(f,n)&&r.push(f);for(var m=this._getSegments(),v=i._getSegments(),w=0;w<m.length;w++)for(var b=m[w],I=0;I<v.length;I++){var O=v[I],N=q(b[0],b[1],O[0],O[1]);N&&r.push(N)}function q(F,A,V,ne){var ce=A.minus(F),G=ne.minus(V),J=-G.x*ce.y+ce.x*G.y;if(J===0)return null;var $=(ce.x*(F.y-V.y)-ce.y*(F.x-V.x))/J,oe=(G.x*(F.y-V.y)-G.y*(F.x-V.x))/J;return-n<=$&&$<=1-n&&-n<=oe&&oe<=1-n?new e.Point(F.x+oe*ce.x,F.y+oe*ce.y):null}if(r.length===0)return null;for(var ie=r[0].x,k=r[0].x,S=r[0].y,E=r[0].y,D=1;D<r.length;D++){var L=r[D];L.x<ie&&(ie=L.x),L.x>k&&(k=L.x),L.y<S&&(S=L.y),L.y>E&&(E=L.y)}return new e.Rect(ie,S,k-ie,E-S)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(h){var d=1e-15;return Math.abs(h)<d?0:h});var c=Math.atan(a.y/a.x);return a.x<0?c+=Math.PI:a.y<0&&(c+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,c/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),c=Math.max(i.x,n.x,r.x,o.x),h=Math.min(i.y,n.y,r.y,o.y),d=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,h,c-a,d-h)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),c=o.minus(r),h=a.minus(r);return(i.x-r.x)*c.x+(i.y-r.y)*c.y>=-n&&(i.x-o.x)*c.x+(i.y-o.y)*c.y<=n&&(i.x-r.x)*h.x+(i.y-r.y)*h.y>=-n&&(i.x-a.x)*h.x+(i.y-a.y)*h.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(p){var f=this,m=p.viewer,v=e.getElementSize(m.element),w,b,I;for(p.id||(p.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=p.id,this.element.className="referencestrip"),p=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},p,{element:this.element}),e.extend(this,p),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,b=this.element.style,b.marginTop="0px",b.marginRight="0px",b.marginBottom="0px",b.marginLeft="0px",b.left="0px",b.bottom="0px",b.border="0px",b.background="#000",b.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=m,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,c),leaveHandler:e.delegate(this,h),keyDownHandler:e.delegate(this,d),keyHandler:e.delegate(this,l),preProcessEventHandler:function(O){O.eventType==="wheel"&&(O.preventDefault=!0)}}),p.width&&p.height?(this.element.style.width=p.width+"px",this.element.style.height=p.height+"px",m.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):p.scroll==="horizontal"?(this.element.style.width=v.x*p.sizeRatio*m.tileSources.length+12*m.tileSources.length+"px",this.element.style.height=v.y*p.sizeRatio+"px",m.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=v.y*p.sizeRatio*m.tileSources.length+12*m.tileSources.length+"px",this.element.style.width=v.x*p.sizeRatio+"px",m.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=v.x*this.sizeRatio+8,this.panelHeight=v.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},I=0;I<m.tileSources.length;I++)w=e.makeNeutralElement("div"),w.id=this.element.id+"-"+I,w.style.width=f.panelWidth+"px",w.style.height=f.panelHeight+"px",w.style.display="inline",w.style.float="left",w.style.cssFloat="left",w.style.padding="2px",e.setElementTouchActionNone(w),e.setElementPointerEventsNone(w),this.element.appendChild(w),w.activePanel=!1,this.panels.push(w);a(this,this.scroll==="vertical"?v.y:v.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(p){var f=this.element.querySelector("#"+this.element.id+"-"+p),m=e.getElementSize(this.viewer.canvas),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),b=-Number(this.element.style.marginLeft.replace("px","")),I=-Number(this.element.style.marginTop.replace("px","")),O;this.currentSelected!==f&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=f,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(O=Number(p)*(this.panelWidth+3),O>b+m.x-this.panelWidth?(O=Math.min(O,v-m.x),this.element.style.marginLeft=-O+"px",a(this,m.x,-O)):O<b&&(O=Math.max(0,O-m.x/2),this.element.style.marginLeft=-O+"px",a(this,m.x,-O))):(O=Number(p)*(this.panelHeight+3),O>I+m.y-this.panelHeight?(O=Math.min(O,w-m.y),this.element.style.marginTop=-O+"px",a(this,m.y,-O)):O<I&&(O=Math.max(0,O-m.y/2),this.element.style.marginTop=-O+"px",a(this,m.y,-O))),this.currentPage=p,c.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var p in this.miniViewers)this.miniViewers[p].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(p){if(p.quick){var f;this.scroll==="horizontal"?f=Math.floor(p.position.x/(this.panelWidth+4)):f=Math.floor(p.position.y/this.panelHeight),this.viewer.goToPage(f)}this.element.focus()}function r(p){if(this.dragging=!0,this.element){var f=Number(this.element.style.marginLeft.replace("px","")),m=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),b=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-p.delta.x>0?f>-(v-b.x)&&(this.element.style.marginLeft=f+p.delta.x*2+"px",a(this,b.x,f+p.delta.x*2)):-p.delta.x<0&&f<0&&(this.element.style.marginLeft=f+p.delta.x*2+"px",a(this,b.x,f+p.delta.x*2)):-p.delta.y>0?m>-(w-b.y)&&(this.element.style.marginTop=m+p.delta.y*2+"px",a(this,b.y,m+p.delta.y*2)):-p.delta.y<0&&m<0&&(this.element.style.marginTop=m+p.delta.y*2+"px",a(this,b.y,m+p.delta.y*2))}}function o(p){if(this.element){var f=Number(this.element.style.marginLeft.replace("px","")),m=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),b=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?p.scroll>0?f>-(v-b.x)&&(this.element.style.marginLeft=f-p.scroll*60+"px",a(this,b.x,f-p.scroll*60)):p.scroll<0&&f<0&&(this.element.style.marginLeft=f-p.scroll*60+"px",a(this,b.x,f-p.scroll*60)):p.scroll<0?m>b.y-w&&(this.element.style.marginTop=m+p.scroll*60+"px",a(this,b.y,m+p.scroll*60)):p.scroll>0&&m<0&&(this.element.style.marginTop=m+p.scroll*60+"px",a(this,b.y,m+p.scroll*60)),p.preventDefault=!0}}function a(p,f,m){var v,w,b,I,O,N;for(p.scroll==="horizontal"?v=p.panelWidth:v=p.panelHeight,w=Math.ceil(f/v)+5,b=Math.ceil((Math.abs(m)+f)/v)+1,w=b-w,w=w<0?0:w,O=w;O<b&&O<p.panels.length;O++)if(N=p.panels[O],!N.activePanel){var q,ie=p.viewer.tileSources[O];ie.referenceStripThumbnailUrl?q={type:"image",url:ie.referenceStripThumbnailUrl}:q=ie,I=new e.Viewer({id:N.id,tileSources:[q],element:N,navigatorSizeRatio:p.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:p.viewer.loadTilesWithAjax,ajaxHeaders:p.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(I.canvas),e.setElementPointerEventsNone(I.container),I.innerTracker.setTracking(!1),I.outerTracker.setTracking(!1),p.miniViewers[N.id]=I,N.activePanel=!0}}function c(p){var f=p.eventSource.element;this.scroll==="horizontal"?f.style.marginBottom="0px":f.style.marginLeft="0px"}function h(p){var f=p.eventSource.element;this.scroll==="horizontal"?f.style.marginBottom="-"+e.getElementSize(f).y/2+"px":f.style.marginLeft="-"+e.getElementSize(f).x/2+"px"}function d(p){if(!p.ctrl&&!p.alt&&!p.meta)switch(p.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;default:p.preventDefault=!1;break}else p.preventDefault=!1}function l(p){if(!p.ctrl&&!p.alt&&!p.meta)switch(p.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;default:p.preventDefault=!1;break}else p.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,c){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=c},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(d){i(o,d,n.callback)},c={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},h=new e.ImageJob(c);!this.jobLimit||this.jobsInProgress<this.jobLimit?(h.start(),this.jobsInProgress++):this.jobQueue.push(h)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,c,h,d,l,p,f,m){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=p,this.exists=a,this._url=c,this.postData=f,this.context2D=h,this.loadWithAjax=d,this.ajaxHeaders=l,m===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),m=e.TileSource.prototype.getTileHashKey(i,n,r,c,l,f)),this.cacheKey=m,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(c){return c%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,c=this.size=o.size,h="";n.overlayPreserveContentDirection&&(h=n.flipped?" scaleX(-1)":" scaleX(1)");var d=n.flipped?-o.rotate:o.rotate,l=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,c,this.element);else{var p=this.style,f=this.element.style;f.display="block",p.left=a.x+"px",p.top=a.y+"px",this.width!==null&&(f.width=c.x+"px"),this.height!==null&&(f.height=c.y+"px");var m=e.getCssPropertyWithVendorPrefix("transformOrigin"),v=e.getCssPropertyWithVendorPrefix("transform");m&&v&&(d&&!n.flipped?(f[v]="",p[m]=this._getTransformOrigin(),p[v]="rotate("+d+"deg)"):!d&&n.flipped?(f[v]=h,p[m]=this._getTransformOrigin(),p[v]=l):d&&n.flipped?(f[v]=h,p[m]=this._getTransformOrigin(),p[v]="rotate("+d+"deg)"+l):(f[v]="",p[m]="",p[v]="")),p.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),c=this._getBoundingBox(a,i.getRotation(!0));n=c.getTopLeft(),r=c.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(c){c.opacity!==0&&a._drawTiles(c)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(d=>d.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var c=a.length-1;c>=0;c--){var h=a[c];this._drawTile(h),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:h})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var c=o.getImage();if(!c)return;o.element=e.makeNeutralElement("div"),o.imgElement=c.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(d){super(d),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let d=e.makeNeutralElement("canvas"),l=this._calculateCanvasSize();return d.width=l.x,d.height=l.y,d}draw(d){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const l of d)l.opacity!==0&&this._drawTiles(l)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(d){return!0}setImageSmoothingEnabled(d){this._imageSmoothingEnabled=!!d,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(d){var l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.strokeStyle=this.debugGridColor[0],l.fillStyle=this.debugGridColor[0],l.strokeRect(d.x*e.pixelDensityRatio,d.y*e.pixelDensityRatio,d.width*e.pixelDensityRatio,d.height*e.pixelDensityRatio),l.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(d,l,p,f){this.viewer.raiseEvent("tile-drawing",{tiledImage:d,context:l,tile:p,rendered:f})}_prepareNewFrame(){var d=this._calculateCanvasSize();if((this.canvas.width!==d.x||this.canvas.height!==d.y)&&(this.canvas.width=d.x,this.canvas.height=d.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var l=this._calculateSketchCanvasSize();this.sketchCanvas.width=l.x,this.sketchCanvas.height=l.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(d,l){var p=this._getContext(d);if(l)p.clearRect(l.x,l.y,l.width,l.height);else{var f=p.canvas;p.clearRect(0,0,f.width,f.height)}}_drawTiles(d){var l=d.getTilesToDraw().map(F=>F.tile);if(!(d.opacity===0||l.length===0&&!d.placeholderFillStyle)){var p=l[0],f;p&&(f=d.opacity<1||d.compositeOperation&&d.compositeOperation!=="source-over"||!d._isBottomItem()&&d.source.hasTransparency(p.context2D,p.getUrl(),p.ajaxHeaders,p.postData));var m,v,w=this.viewport.getZoom(!0),b=d.viewportToImageZoom(w);l.length>1&&b>d.smoothTileEdgesMinZoom&&!d.iOSDevice&&d.getRotation(!0)%360===0&&(f=!0,m=p.getScaleForEdgeSmoothing(),v=p.getTranslationForEdgeSmoothing(m,this._getCanvasSize(!1),this._getCanvasSize(!0)));var I;f&&(m||(I=this.viewport.viewportToViewerElementRectangle(d.getClippedBounds(!0)).getIntegerBoundingBox(),I=I.times(e.pixelDensityRatio)),this._clear(!0,I)),m||this._setRotations(d,f);var O=!1;if(d._clip){this._saveContext(f);var N=d.imageToViewportRectangle(d._clip,!0);N=N.rotate(-d.getRotation(!0),d._getRotationPoint(!0));var q=this.viewportToDrawerRectangle(N);m&&(q=q.times(m)),v&&(q=q.translate(v)),this._setClip(q,f),O=!0}if(d._croppingPolygons){var ie=this;O||this._saveContext(f);try{var k=d._croppingPolygons.map(function(F){return F.map(function(A){var V=d.imageToViewportCoordinates(A.x,A.y,!0).rotate(-d.getRotation(!0),d._getRotationPoint(!0)),ne=ie.viewportCoordToDrawerCoord(V);return m&&(ne=ne.times(m)),v&&(ne=ne.plus(v)),ne})});this._clipWithPolygons(k,f)}catch(F){e.console.error(F)}O=!0}if(d._hasOpaqueTile=!1,d.placeholderFillStyle&&d._hasOpaqueTile===!1){let F=this.viewportToDrawerRectangle(d.getBoundsNoRotate(!0));m&&(F=F.times(m)),v&&(F=F.translate(v));let A=null;typeof d.placeholderFillStyle=="function"?A=d.placeholderFillStyle(d,this.context):A=d.placeholderFillStyle,this._drawRectangle(F,A,f)}var S=c(d.subPixelRoundingForTransparency),E=!1;if(S===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)E=!0;else if(S===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var D=this.viewer&&this.viewer.isAnimating();E=!D}for(var L=0;L<l.length;L++)p=l[L],this._drawTile(p,d,f,m,v,E,d.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:d,tile:p});O&&this._restoreContext(f),m||(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(f),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(f)),f&&(m&&this._setRotations(d),this.blendSketch({opacity:d.opacity,scale:m,translate:v,compositeOperation:d.compositeOperation,bounds:I}),m&&(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(d,l),this._raiseTiledImageDrawnEvent(d,l)}}_drawDebugInfo(d,l){if(d.debugMode)for(var p=l.length-1;p>=0;p--){var f=l[p];try{this._drawDebugInfoOnTile(f,l.length,p,d)}catch(m){e.console.error(m)}}}_clipWithPolygons(d,l){var p=this._getContext(l);p.beginPath();for(const f of d)for(const[m,v]of f.entries())p[m===0?"moveTo":"lineTo"](v.x,v.y);p.clip()}_drawTile(d,l,p,f,m,v,w){e.console.assert(d,"[Drawer._drawTile] tile is required"),e.console.assert(l,"[Drawer._drawTile] drawingHandler is required");var b=this._getContext(p);f=f||1,this._drawTileToCanvas(d,b,l,f,m,v,w)}_drawTileToCanvas(d,l,p,f,m,v,w){var b=d.position.times(e.pixelDensityRatio),I=d.size.times(e.pixelDensityRatio),O;if(!d.context2D&&!d.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",d.toString());return}if(O=d.getCanvasContext(),!d.loaded||!O){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",d.toString());return}l.save(),typeof f=="number"&&f!==1&&(b=b.times(f),I=I.times(f)),m instanceof e.Point&&(b=b.plus(m)),l.globalAlpha===1&&d.hasTransparency&&(v&&(b.x=Math.round(b.x),b.y=Math.round(b.y),I.x=Math.round(I.x),I.y=Math.round(I.y)),l.clearRect(b.x,b.y,I.x,I.y)),this._raiseTileDrawingEvent(p,l,d,O);var N,q;d.sourceBounds?(N=Math.min(d.sourceBounds.width,O.canvas.width),q=Math.min(d.sourceBounds.height,O.canvas.height)):(N=O.canvas.width,q=O.canvas.height),l.translate(b.x+I.x/2,0),d.flipped&&l.scale(-1,1),l.drawImage(O.canvas,0,0,N,q,-I.x/2,b.y,I.x,I.y),l.restore()}_getContext(d){var l=this.context;if(d){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var p=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=p.x,this.sketchCanvas.height=p.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var f=this;this.viewer.addHandler("rotate",function m(){if(f.viewport.getRotation()!==0){f.viewer.removeHandler("rotate",m);var v=f._calculateSketchCanvasSize();f.sketchCanvas.width=v.x,f.sketchCanvas.height=v.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}l=this.sketchContext}return l}_saveContext(d){this._getContext(d).save()}_restoreContext(d){this._getContext(d).restore()}_setClip(d,l){var p=this._getContext(l);p.beginPath(),p.rect(d.x,d.y,d.width,d.height),p.clip()}_drawRectangle(d,l,p){var f=this._getContext(p);f.save(),f.fillStyle=l,f.fillRect(d.x,d.y,d.width,d.height),f.restore()}blendSketch(d,l,p,f){var m=d;e.isPlainObject(m)||(m={opacity:d,scale:l,translate:p,compositeOperation:f}),d=m.opacity,f=m.compositeOperation;var v=m.bounds;if(this.context.save(),this.context.globalAlpha=d,f&&(this.context.globalCompositeOperation=f),v)v.x<0&&(v.width+=v.x,v.x=0),v.x+v.width>this.canvas.width&&(v.width=this.canvas.width-v.x),v.y<0&&(v.height+=v.y,v.y=0),v.y+v.height>this.canvas.height&&(v.height=this.canvas.height-v.y),this.context.drawImage(this.sketchCanvas,v.x,v.y,v.width,v.height,v.x,v.y,v.width,v.height);else{l=m.scale||1,p=m.translate;var w=p instanceof e.Point?p:new e.Point(0,0),b=0,I=0;if(p){var O=this.sketchCanvas.width-this.canvas.width,N=this.sketchCanvas.height-this.canvas.height;b=Math.round(O/2),I=Math.round(N/2)}this.context.drawImage(this.sketchCanvas,w.x-b*l,w.y-I*l,(this.canvas.width+2*b)*l,(this.canvas.height+2*I)*l,-b,-I,this.canvas.width+2*b,this.canvas.height+2*I)}this.context.restore()}_drawDebugInfoOnTile(d,l,p,f){var m=this.viewer.world.getIndexOfItem(f)%this.debugGridColor.length,v=this.context;v.save(),v.lineWidth=2*e.pixelDensityRatio,v.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",v.strokeStyle=this.debugGridColor[m],v.fillStyle=this.debugGridColor[m],this._setRotations(f),this._viewportFlipped&&this._flip({point:d.position.plus(d.size.divide(2))}),v.strokeRect(d.position.x*e.pixelDensityRatio,d.position.y*e.pixelDensityRatio,d.size.x*e.pixelDensityRatio,d.size.y*e.pixelDensityRatio);var w=(d.position.x+d.size.x/2)*e.pixelDensityRatio,b=(d.position.y+d.size.y/2)*e.pixelDensityRatio;v.translate(w,b);const I=this.viewport.getRotation(!0);v.rotate(Math.PI/180*-I),v.translate(-w,-b),d.x===0&&d.y===0&&(v.fillText("Zoom: "+this.viewport.getZoom(),d.position.x*e.pixelDensityRatio,(d.position.y-30)*e.pixelDensityRatio),v.fillText("Pan: "+this.viewport.getBounds().toString(),d.position.x*e.pixelDensityRatio,(d.position.y-20)*e.pixelDensityRatio)),v.fillText("Level: "+d.level,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+20)*e.pixelDensityRatio),v.fillText("Column: "+d.x,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+30)*e.pixelDensityRatio),v.fillText("Row: "+d.y,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+40)*e.pixelDensityRatio),v.fillText("Order: "+p+" of "+l,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+50)*e.pixelDensityRatio),v.fillText("Size: "+d.size.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+60)*e.pixelDensityRatio),v.fillText("Position: "+d.position.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),f.getRotation(!0)%360!==0&&this._restoreRotationChanges(),v.restore()}_updateImageSmoothingEnabled(d){d.msImageSmoothingEnabled=this._imageSmoothingEnabled,d.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(d){var l=this._getContext(d).canvas;return new e.Point(l.width,l.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(d,l=!1){var p=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:l,saveContext:p}),p=!1),d.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:d.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(d._getRotationPoint(!0),!0),useSketch:l,saveContext:p})}_offsetForRotation(d){var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),p=this._getContext(d.useSketch);p.save(),p.translate(l.x,l.y),p.rotate(Math.PI/180*d.degrees),p.translate(-l.x,-l.y)}_flip(d){d=d||{};var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),p=this._getContext(d.useSketch);p.translate(l.x,0),p.scale(-1,1),p.translate(-l.x,0)}_restoreRotationChanges(d){var l=this._getContext(d);l.restore()}_calculateCanvasSize(){var d=e.pixelDensityRatio,l=this.viewport.getContainerSize();return{x:Math.round(l.x*d),y:Math.round(l.y*d)}}_calculateSketchCanvasSize(){var d=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return d;var l=Math.ceil(Math.sqrt(d.x*d.x+d.y*d.y));return{x:l,y:l}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(h){return h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(h){return o(h)?r:h}function c(h){if(typeof h=="number")return a(h);if(!h||!e.Browser)return r;var d=h[e.Browser.vendor];return o(d)&&(d=h["*"]),a(d)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let c=0;c<o;++c)r.activeTexture(r.TEXTURE0+c),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let c={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},h=this.viewport.flipped?-1:1,d=e.Mat3.makeTranslation(-c.center.x,-c.center.y),l=e.Mat3.makeScaling(2/c.bounds.width*h,-2/c.bounds.height),p=e.Mat3.makeRotation(-c.rotation),f=l.multiply(p).multiply(d);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let m=!1;r.forEach((v,w)=>{if(v.isTainted()){m&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),m=!1);const b=this._getBackupCanvasDrawer();b.draw([v]),this._outputContext.drawImage(b.canvas,0,0)}else{let b=v.getTilesToDraw();if(v.placeholderFillStyle&&v._hasOpaqueTile===!1&&this._drawPlaceholder(v),b.length===0||v.getOpacity()===0)return;let I=b[0],O=v.compositeOperation||this.viewer.compositeOperation||v._clip||v._croppingPolygons||v.debugMode,N=O||v.opacity<1||I.hasTransparency;O&&(m&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),N?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let q=f,ie=v.getRotation(!0);if(ie%360!==0){let F=e.Mat3.makeRotation(-ie*Math.PI/180),A=v.getBoundsNoRotate(!0).getCenter(),V=e.Mat3.makeTranslation(A.x,A.y),ne=e.Mat3.makeTranslation(-A.x,-A.y),ce=V.multiply(F).multiply(ne);q=f.multiply(ce)}let k=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(k<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${k}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let S=new Float32Array(k*12),E=new Array(k),D=new Array(k),L=new Array(k);for(let F=0;F<b.length;F++){let A=b[F].tile,V=F%k,ne=V+1,ce=A.getCanvasContext(),G=ce?this._TextureMap.get(ce.canvas):null;if(G||(this._tileReadyHandler({tile:A,tiledImage:v}),G=ce?this._TextureMap.get(ce.canvas):null),G&&this._getTileData(A,v,G,q,V,S,E,D,L),ne===k||F===b.length-1){for(let J=0;J<=ne;J++)o.activeTexture(o.TEXTURE0+J),o.bindTexture(o.TEXTURE_2D,E[J]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,S,o.DYNAMIC_DRAW),D.forEach((J,$)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[$],!1,J)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(L)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*ne)}}N&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,v.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),m=!0,O&&(this._applyContext2dPipeline(v,b,w),m=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),w===0&&this._raiseTiledImageDrawnEvent(v,b.map(F=>F.tile))}}),m&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const c=this.viewer.viewport.getFlip();c&&this._flip(),this._drawDebugInfo(o,r,c),c&&this._flip()}}_getTileData(r,o,a,c,h,d,l,p,f){let m=a.texture,v=a.position;d.set(v,h*12);let w=this._calculateOverlapFraction(r,o),b=r.positionedBounds.width*w.x,I=r.positionedBounds.height*w.y,O=r.positionedBounds.x+(r.x===0?0:b),N=r.positionedBounds.y+(r.y===0?0:I),q=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:b),ie=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:I),k=q-O,S=ie-N,E=new e.Mat3([k,0,0,0,S,0,O,N,1]);if(r.flipped){let L=e.Mat3.makeTranslation(.5,0),F=e.Mat3.makeTranslation(-.5,0),A=L.multiply(e.Mat3.makeScaling(-1,1)).multiply(F);E=E.multiply(A)}let D=c.multiply(E);f[h]=r.opacity,l[h]=m,p[h]=D.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(m=>`uniform mat3 u_matrix_${m};`).join(`
`),a=()=>[...Array(r).keys()].map(m=>`${m>0?"else ":""}if(int(a_index) == ${m}) { transform_matrix = u_matrix_${m}; }`).join(`
`);const c=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,h=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let d=this._gl,l=this.constructor.initShaderProgram(d,c,h);d.useProgram(l),this._firstPass={shaderProgram:l,aOutputPosition:d.getAttribLocation(l,"a_output_position"),aTexturePosition:d.getAttribLocation(l,"a_texture_position"),aIndex:d.getAttribLocation(l,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(m=>d.getUniformLocation(l,`u_matrix_${m}`)),uImages:d.getUniformLocation(l,"u_images"),uOpacities:d.getUniformLocation(l,"u_opacities"),bufferOutputPosition:d.createBuffer(),bufferTexturePosition:d.createBuffer(),bufferIndex:d.createBuffer()},d.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let p=new Float32Array(r*12);for(let m=0;m<r;++m)p.set(Float32Array.from(this._unitQuad),m*12);d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),d.bufferData(d.ARRAY_BUFFER,p,d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aOutputPosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),d.enableVertexAttribArray(this._firstPass.aTexturePosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferIndex);let f=[...Array(this._glNumTextures).keys()].map(m=>Array(6).fill(m)).flat();d.bufferData(d.ARRAY_BUFFER,new Float32Array(f),d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,c=this.constructor.initShaderProgram(a,r,o);a.useProgram(c),this._secondPass={shaderProgram:c,aOutputPosition:a.getAttribLocation(c,"a_output_position"),aTexturePosition:a.getAttribLocation(c,"a_texture_position"),uMatrix:a.getUniformLocation(c,"u_matrix"),uImage:a.getUniformLocation(c,"u_image"),uOpacityMultiplier:a.getUniformLocation(c,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let h=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,h.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,c){return new Float32Array([r,c,o,c,r,a,r,a,o,c,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let c=o.getCanvasContext(),h=c&&c.canvas;if(!h||e.isCanvasTainted(h)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(h)){let l=this._gl,p=l.createTexture(),f,m=a.source.tileOverlap,v,w;if(o.sourceBounds?(v=Math.min(o.sourceBounds.width,h.width)/h.width,w=Math.min(o.sourceBounds.height,h.height)/h.height):(v=1,w=1),m>0){let I=this._calculateOverlapFraction(o,a),O=(o.x===0?0:I.x)*v,N=(o.y===0?0:I.y)*w,q=(o.isRightMost?1:1-I.x)*v,ie=(o.isBottomMost?1:1-I.y)*w;f=this._makeQuadVertexBuffer(O,q,N,ie)}else v===1&&w===1?f=this._unitQuad:f=this._makeQuadVertexBuffer(0,v,0,w);let b={texture:p,position:f};this._TextureMap.set(h,b),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,p),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,this._textureFilter()),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(c)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,c=r.sourceBounds.width,h=r.sourceBounds.height,d=(r.x===0?0:a)+(r.isRightMost?0:a),l=(r.y===0?0:a)+(r.isBottomMost?0:a),p=a/(c+d),f=a/(h+l);return{x:p,y:f}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(c){e.console.error("Error uploading image data to WebGL",c)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)});this._clippingContext.beginPath(),a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var c=r.length-1;c>=0;c--){var h=r[c].tile;try{this._drawDebugInfoOnTile(h,r.length,c,o,a)}catch(d){e.console.error(d)}}}_drawDebugInfoOnTile(r,o,a,c,h){var d=this.viewer.world.getIndexOfItem(c)%this.debugGridColor.length,l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",l.strokeStyle=this.debugGridColor[d],l.fillStyle=this.debugGridColor[d],this._setRotations(c),h&&this._flip({point:r.position.plus(r.size.divide(2))}),l.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var p=(r.position.x+r.size.x/2)*e.pixelDensityRatio,f=(r.position.y+r.size.y/2)*e.pixelDensityRatio;l.translate(p,f);const m=this.viewport.getRotation(!0);l.rotate(Math.PI/180*-m),l.translate(-p,-f),r.x===0&&r.y===0&&(l.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),l.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),l.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),l.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),l.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),l.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),l.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),l.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),c.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),c=this._outputContext;let h;typeof r.placeholderFillStyle=="function"?h=r.placeholderFillStyle(r,c):h=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),c.fillStyle=h,c.translate(a.x,a.y),c.rotate(Math.PI/180*o.degrees),c.translate(-a.x,-a.y),c.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function c(p,f,m){const v=p.createShader(f);return p.shaderSource(v,m),p.compileShader(v),p.getShaderParameter(v,p.COMPILE_STATUS)?v:(e.console.error(`An error occurred compiling the shaders: ${p.getShaderInfoLog(v)}`),p.deleteShader(v),null)}const h=c(r,r.VERTEX_SHADER,o),d=c(r,r.FRAGMENT_SHADER,a),l=r.createProgram();return r.attachShader(l,h),r.attachShader(l,d),r.linkProgram(l),r.getProgramParameter(l,r.LINK_STATUS)?l:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(l)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,c,h,d,l,p,f;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),c=1/a,h=c/this.getAspectRatio(),d=new e.Rect(n.x-c/2,n.y-h/2,c,h),l=this._pixelFromPoint(this.zoomPoint,d),p=l.minus(o).rotate(-this.getRotation(!0)),f=p.divide(this._containerInnerSize.x*a),r.plus(f)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var c=n.x+n.width,h=r.x+r.width,d,l,p;n.width>r.width?d=this.visibilityRatio*r.width:d=this.visibilityRatio*n.width,l=r.x-c+d,p=h-n.x-d,d>r.width?(n.x+=(l+p)/2,o=!0):p<0?(n.x+=p,o=!0):l>0&&(n.x+=l,o=!0)}if(!this.wrapVertical){var f=n.y+n.height,m=r.y+r.height,v,w,b;n.height>r.height?v=this.visibilityRatio*r.height:v=this.visibilityRatio*n.height,w=r.y-f+v,b=m-n.y-v,v>r.height?(n.y+=(w+b)/2,a=!0):b<0?(n.y+=b,a=!0):w>0&&(n.y+=w,a=!0)}var I=o||a,O=I?this.viewerElementToViewportRectangle(n):i.clone();return O.xConstrained=o,O.yConstrained=a,O.constraintApplied=I,O},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),c=i.getCenter(),h=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();h.getAspectRatio()>=a?h.height=h.width/a:h.width=h.height*a,h.x=c.x-h.width/2,h.y=c.y-h.height/2;var d=1/h.width;if(r)return this.panTo(c,!0),this.zoomTo(d,null,!0),o&&this.applyConstraints(!0),this;var l=this.getCenter(!0),p=this.getZoom(!0);this.panTo(l,!0),this.zoomTo(p,null,!0);var f=this.getBounds(),m=this.getZoom();if(m===0||Math.abs(d/m-1)<1e-8)return this.zoomTo(d,null,!0),this.panTo(c,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(c,!1),d=this._applyZoomConstraints(d),this.zoomTo(d,null,!1);var v=this.getConstrainedBounds();this.panTo(l,!0),this.zoomTo(p,null,!0),this.fitBounds(v)}else{var w=h.rotate(-this.getRotation()),b=w.getTopLeft().times(d).minus(f.getTopLeft().times(m)).divide(d-m);this.zoomTo(d,b,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),c=e.positiveModulo(i,360),h=c-a;h>180?c-=360:h<-180&&(c+=360);var d=a-c;this.degreesSpring.resetTo(i+d),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var c=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),c},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.imageToViewportRectangle(i,n,r,o,!0)}}var d=this.imageToViewportCoordinates(a.x,a.y),l=this._imageToViewportDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.viewportToImageRectangle(i,n,r,o,!0)}}var d=this.viewportToImageCoordinates(a.x,a.y),l=this._viewportToImageDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=a/o*c;return i*h},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=o/a/c;return i*h},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var c=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var h=i.degrees||0;delete i.degrees;var d=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:h,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,c,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(d,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),c=n||r||o||a||this._needsUpdate;if(c||i||!this._fullyLoaded){let h=this._updateLevelsForViewport();this._setFullyLoaded(h)}return this._needsUpdate=!1,c?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,c=(o.y+r%o.y)%o.y,h=this.source.getTileBounds(i,a,c);return this.getFlip()&&(h.x=Math.max(0,1-h.x-h.width)),h.x+=(n-a)/o.x,h.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-c)/o.y),h},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var c=i;c instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.imageToViewportCoordinates(c.getTopLeft(),a),d=this._imageToViewportDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var c=i;i instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.viewportToImageCoordinates(c.getTopLeft(),a),d=this._viewportToImageDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,c=0,h=0,d=1,l=1;if(this._clip&&(a=this._clip.getAspectRatio(),d=this._clip.width/this.source.dimensions.x,l=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(c=this._clip.x/this._clip.height*i.height,h=this._clip.y/this._clip.height*i.height):(c=this._clip.x/this._clip.width*i.width,h=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var p=i.height/l,f=0;o.isHorizontallyCentered?f=(i.width-i.height*a)/2:o.isRight&&(f=i.width-i.height*a),this.setPosition(new e.Point(i.x-c+f,i.y-h),r),this.setHeight(p,r)}else{var m=i.width/d,v=0;o.isVerticallyCentered?v=(i.height-i.width/a)/2:o.isBottom&&(v=i.height-i.width/a),this.setPosition(new e.Point(i.x-c,i.y-h+v),r),this.setWidth(m,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var c in this.tilesMatrix){n=this.source.getNumTiles(c);for(var h in this.tilesMatrix[c]){r=(n.x+h%n.x)%n.x;for(var d in this.tilesMatrix[c][h])if(o=(n.y+d%n.y)%n.y,a=this.tilesMatrix[c][h][d],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var l=this.source.getTileAjaxHeaders(c,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,l)}else a.ajaxHeaders=null}}for(var p=0;p<this._imageLoader.jobQueue.length;p++){var f=this._imageLoader.jobQueue[p];f.loadWithAjax=f.tile.loadWithAjax,f.ajaxHeaders=f.tile.loadWithAjax?f.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),c=e.now();if(this._lastDrawn.forEach(q=>{q.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var h=new Array(r-n+1);for(let q=0,ie=r;ie>=n;ie--,q++)h[q]=ie;for(let q=r+1;q<=this.source.maxLevel;q++){var d=this.tilesMatrix[q]&&this.tilesMatrix[q][0]&&this.tilesMatrix[q][0][0];if(d&&d.isBottomMost&&d.isRightMost&&d.loaded){h.push(q);break}}let l=!1;for(let q=0;q<h.length;q++){let ie=h[q];var p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(ie),!0).x*this._scaleSpring.current.value;if(q===h.length-1||p>=this.minPixelRatio)l=!0;else if(!l)continue;var f=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(ie),!1).x*this._scaleSpring.current.value,m=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,v=this.immediateRender?1:m,w=Math.min(1,(p-.5)/.5),b=v/Math.abs(v-f),I=this._updateLevel(ie,w,b,a,c,o);o=I.bestTiles;var O=I.updatedTiles.filter(k=>k.loaded),N=function(k,S,E){return function(D){return{tile:D,level:k,levelOpacity:S,currentTime:E}}}(ie,w,c);if(this._tilesToDraw[ie]=O.map(N),this._providesCoverage(this.coverage,ie))break}return o&&o.length>0?(o.forEach(function(q){q&&!q.context2D&&this._loadTile(q,c)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function c(d){let l=d.tile;if(l&&l.loaded){let p=r._blendTile(l,l.x,l.y,d.level,d.levelOpacity,n,o);r._isBlending=r._isBlending||p,r._needsDraw=r._needsDraw||p||r._wasBlending}}let h=0;for(let d=0;d<i.length;d++){let l=i[d];c(l),this._providesCoverage(this.coverage,l.level)&&(h=Math.max(h,l.level))}if(h>0)for(let d in this._tilesToDraw)d<h&&delete this._tilesToDraw[d]},_blendTile:function(i,n,r,o,a,c,h){let d=1e3*this.blendTime,l,p;return i.blendStart||(i.blendStart=c),l=c-i.blendStart,p=d?Math.min(1,l/d):1,o===h&&(p=1,l=d),this.alwaysBlend&&(p*=a),i.opacity=p,p===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),l<d},_updateLevel:function(i,n,r,o,a,c){var h=o.getBoundingBox().getTopLeft(),d=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:h,bottomright:d,currenttime:a,best:c}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var l=this._getCornerTiles(i,h,d),p=l.topLeft,f=l.bottomRight,m=this.source.getNumTiles(i),v=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(f.x+=1,this.wrapHorizontal||(f.x=Math.min(f.x,m.x-1)));for(var w=Math.max(0,(f.x-p.x)*(f.y-p.y)),b=new Array(w),I=0,O=p.x;O<=f.x;O++)for(var N=p.y;N<=f.y;N++){var q;if(this.getFlip()){var ie=(m.x+O%m.x)%m.x;q=O+m.x-ie-ie-1}else q=O;if(o.intersection(this.getTileBounds(i,q,N))!==null){var k=this._updateTile(q,N,i,r,v,m,a,c);c=k.bestTiles,b[I]=k.tile,I+=1}}return{bestTiles:c,updatedTiles:b}},_positionTile:function(i,n,r,o,a){var c=i.bounds.getTopLeft();c.x*=this._scaleSpring.current.value,c.y*=this._scaleSpring.current.value,c.x+=this._xSpring.current.value,c.y+=this._ySpring.current.value;var h=i.bounds.getSize();h.x*=this._scaleSpring.current.value,h.y*=this._scaleSpring.current.value,i.positionedBounds.x=c.x,i.positionedBounds.y=c.y,i.positionedBounds.width=h.x,i.positionedBounds.height=h.y;var d=r.pixelFromPointNoRotate(c,!0),l=r.pixelFromPointNoRotate(c,!1),p=r.deltaPixelsFromPointsNoRotate(h,!0),f=r.deltaPixelsFromPointsNoRotate(h,!1),m=l.plus(f.divide(2)),v=o.squaredDistanceTo(m);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(p=p.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(p.x+=.75),i.isBottomMost&&this.wrapVertical&&(p.y+=.75)),i.position=d,i.size=p,i.squaredDistance=v,i.visibility=a},_updateTile:function(i,n,r,o,a,c,h,d){var l=this._getTile(i,n,r,h,c);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:l}),this._setCoverage(this.coverage,r,i,n,!1);var p=l.loaded||l.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,p),!l.exists)return{bestTiles:d,tile:l};if(l.loaded&&l.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(l,this.source.tileOverlap,this.viewport,a,o),!l.loaded)if(l.context2D)this._setTileLoaded(l);else{var f=this._tileCache.getImageRecord(l.cacheKey);f&&this._setTileLoaded(l,f.getData())}return l.loading?this._tilesLoading++:p||(d=this._compareTiles(d,l,this.maxTilesPerFrame)),{bestTiles:d,tile:l}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var c,h,d=1/this.source.aspectRatio;this.wrapVertical?(c=e.positiveModulo(n.y,d),h=e.positiveModulo(r.y,d)):(c=Math.max(0,n.y),h=Math.min(d,r.y));var l=this.source.getTileAtPoint(i,new e.Point(o,c)),p=this.source.getTileAtPoint(i,new e.Point(a,h)),f=this.source.getNumTiles(i);return this.wrapHorizontal&&(l.x+=f.x*Math.floor(n.x),p.x+=f.x*Math.floor(r.x)),this.wrapVertical&&(l.y+=f.y*Math.floor(n.y/d),p.y+=f.y*Math.floor(r.y/d)),{topLeft:l,bottomRight:p}},_getTile:function(i,n,r,o,a){var c,h,d,l,p,f,m,v,w,b,I=this.tilesMatrix,O=this.source;return I[r]||(I[r]={}),I[r][i]||(I[r][i]={}),(!I[r][i][n]||!I[r][i][n].flipped!=!this.flipped)&&(c=(a.x+i%a.x)%a.x,h=(a.y+n%a.y)%a.y,d=this.getTileBounds(r,i,n),l=O.getTileBounds(r,c,h,!0),p=O.tileExists(r,c,h),f=O.getTileUrl(r,c,h),m=O.getTilePostData(r,c,h),this.loadTilesWithAjax?(v=O.getTileAjaxHeaders(r,c,h),e.isPlainObject(this.ajaxHeaders)&&(v=e.extend({},this.ajaxHeaders,v))):v=null,w=O.getContext2D?O.getContext2D(r,c,h):void 0,b=new e.Tile(r,i,n,d,p,f,w,this.loadTilesWithAjax,v,l,m,O.getTileHashKey(r,c,h,f,v,m)),this.getFlip()?c===0&&(b.isRightMost=!0):c===a.x-1&&(b.isRightMost=!0),h===a.y-1&&(b.isBottomMost=!0),b.flipped=this.flipped,I[r][i][n]=b),b=I[r][i][n],b.lastTouchTime=o,b},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,c){r._onTileLoad(i,n,o,a,c)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var c=this,h=function(){var d=c.source,l=d.getClosestLevel();c._setTileLoaded(i,r,l,a)};h()},_setTileLoaded:function(i,n,r,o){var a=0,c=!1,h=this;function d(){return c&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,l}function l(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=h.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||h._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:h}),h.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:h,tileRequest:o}),h._needsDraw=!0)}var p=d();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:d}),c=!0,p()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,c,h,d;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(h in a)if(Object.prototype.hasOwnProperty.call(a,h)){c=a[h];for(d in c)if(Object.prototype.hasOwnProperty.call(c,d)&&!c[d])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,c=this._imagesLoaded[r.tile.cacheKey];if(c||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),c=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),c.addTile(r.tile),r.tile.cacheImageRecord=c,this._imagesLoadedCount>this._maxImageCacheCount){for(var h=null,d=-1,l=null,p,f,m,v,w,b,I=this._tilesLoaded.length-1;I>=0;I--)if(b=this._tilesLoaded[I],p=b.tile,!(p.level<=o||p.beingDrawn)){if(!h){h=p,d=I,l=b;continue}v=p.lastTouchTime,f=h.lastTouchTime,w=p.level,m=h.level,(v<f||v===f&&w>m)&&(h=p,d=I,l=b)}h&&d>=0&&(this._unloadTile(l),a=d)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let c=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var h=this._imagesLoaded[o.cacheKey];h&&(h.removeTile(o),h.getTileCount()||(h.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,c&&(c.canvas.width=0,c.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:c,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,c=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,h=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,d=c+h,l;!i.rows&&a?l=a:l=Math.ceil(this._items.length/o);var p=0,f=0,m,v,w,b,I;this.setAutoRefigureSizes(!1);for(var O=0;O<this._items.length;O++)O&&O%l===0&&(r==="horizontal"?(f+=d,p=0):(p+=d,f=0)),m=this._items[O],v=m.getBounds(),v.width>v.height?w=c:w=c*(v.width/v.height),b=w*(v.height/v.width),I=new e.Point(p+(c-w)/2,f+(c-b)/2),m.setPosition(I,n),m.setWidth(w,n),r==="horizontal"?p+=d:f+=d;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var c=o.getClippedBounds().getBoundingBox(),h=c.x,d=c.y,l=c.x+c.width,p=c.y+c.height,f=1;f<this._items.length;f++)o=this._items[f],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),c=o.getClippedBounds().getBoundingBox(),h=Math.min(h,c.x),d=Math.min(d,c.y),l=Math.max(l,c.x+c.width),p=Math.max(p,c.y+c.height);this._homeBounds=new e.Rect(h,d,l-h,p-d),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(Vc);var id=Vc.exports;const nt=td(id);var hi={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(s){(function(){var t=function(){this.init()};t.prototype={init:function(){var l=this||e;return l._counter=1e3,l._html5AudioPool=[],l.html5PoolSize=10,l._codecs={},l._howls=[],l._muted=!1,l._volume=1,l._canPlayEvent="canplaythrough",l._navigator=typeof window<"u"&&window.navigator?window.navigator:null,l.masterGain=null,l.noAudio=!1,l.usingWebAudio=!0,l.autoSuspend=!0,l.ctx=null,l.autoUnlock=!0,l._setup(),l},volume:function(l){var p=this||e;if(l=parseFloat(l),p.ctx||d(),typeof l<"u"&&l>=0&&l<=1){if(p._volume=l,p._muted)return p;p.usingWebAudio&&p.masterGain.gain.setValueAtTime(l,e.ctx.currentTime);for(var f=0;f<p._howls.length;f++)if(!p._howls[f]._webAudio)for(var m=p._howls[f]._getSoundIds(),v=0;v<m.length;v++){var w=p._howls[f]._soundById(m[v]);w&&w._node&&(w._node.volume=w._volume*l)}return p}return p._volume},mute:function(l){var p=this||e;p.ctx||d(),p._muted=l,p.usingWebAudio&&p.masterGain.gain.setValueAtTime(l?0:p._volume,e.ctx.currentTime);for(var f=0;f<p._howls.length;f++)if(!p._howls[f]._webAudio)for(var m=p._howls[f]._getSoundIds(),v=0;v<m.length;v++){var w=p._howls[f]._soundById(m[v]);w&&w._node&&(w._node.muted=l?!0:w._muted)}return p},stop:function(){for(var l=this||e,p=0;p<l._howls.length;p++)l._howls[p].stop();return l},unload:function(){for(var l=this||e,p=l._howls.length-1;p>=0;p--)l._howls[p].unload();return l.usingWebAudio&&l.ctx&&typeof l.ctx.close<"u"&&(l.ctx.close(),l.ctx=null,d()),l},codecs:function(l){return(this||e)._codecs[l.replace(/^x-/,"")]},_setup:function(){var l=this||e;if(l.state=l.ctx&&l.ctx.state||"suspended",l._autoSuspend(),!l.usingWebAudio)if(typeof Audio<"u")try{var p=new Audio;typeof p.oncanplaythrough>"u"&&(l._canPlayEvent="canplay")}catch{l.noAudio=!0}else l.noAudio=!0;try{var p=new Audio;p.muted&&(l.noAudio=!0)}catch{}return l.noAudio||l._setupCodecs(),l},_setupCodecs:function(){var l=this||e,p=null;try{p=typeof Audio<"u"?new Audio:null}catch{return l}if(!p||typeof p.canPlayType!="function")return l;var f=p.canPlayType("audio/mpeg;").replace(/^no$/,""),m=l._navigator?l._navigator.userAgent:"",v=m.match(/OPR\/(\d+)/g),w=v&&parseInt(v[0].split("/")[1],10)<33,b=m.indexOf("Safari")!==-1&&m.indexOf("Chrome")===-1,I=m.match(/Version\/(.*?) /),O=b&&I&&parseInt(I[1],10)<15;return l._codecs={mp3:!!(!w&&(f||p.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!f,opus:!!p.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!p.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!p.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(p.canPlayType('audio/wav; codecs="1"')||p.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!p.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!p.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(p.canPlayType("audio/x-m4a;")||p.canPlayType("audio/m4a;")||p.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(p.canPlayType("audio/x-m4b;")||p.canPlayType("audio/m4b;")||p.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(p.canPlayType("audio/x-mp4;")||p.canPlayType("audio/mp4;")||p.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!O&&p.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!O&&p.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!p.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(p.canPlayType("audio/x-flac;")||p.canPlayType("audio/flac;")).replace(/^no$/,"")},l},_unlockAudio:function(){var l=this||e;if(!(l._audioUnlocked||!l.ctx)){l._audioUnlocked=!1,l.autoUnlock=!1,!l._mobileUnloaded&&l.ctx.sampleRate!==44100&&(l._mobileUnloaded=!0,l.unload()),l._scratchBuffer=l.ctx.createBuffer(1,1,22050);var p=function(f){for(;l._html5AudioPool.length<l.html5PoolSize;)try{var m=new Audio;m._unlocked=!0,l._releaseHtml5Audio(m)}catch{l.noAudio=!0;break}for(var v=0;v<l._howls.length;v++)if(!l._howls[v]._webAudio)for(var w=l._howls[v]._getSoundIds(),b=0;b<w.length;b++){var I=l._howls[v]._soundById(w[b]);I&&I._node&&!I._node._unlocked&&(I._node._unlocked=!0,I._node.load())}l._autoResume();var O=l.ctx.createBufferSource();O.buffer=l._scratchBuffer,O.connect(l.ctx.destination),typeof O.start>"u"?O.noteOn(0):O.start(0),typeof l.ctx.resume=="function"&&l.ctx.resume(),O.onended=function(){O.disconnect(0),l._audioUnlocked=!0,document.removeEventListener("touchstart",p,!0),document.removeEventListener("touchend",p,!0),document.removeEventListener("click",p,!0),document.removeEventListener("keydown",p,!0);for(var N=0;N<l._howls.length;N++)l._howls[N]._emit("unlock")}};return document.addEventListener("touchstart",p,!0),document.addEventListener("touchend",p,!0),document.addEventListener("click",p,!0),document.addEventListener("keydown",p,!0),l}},_obtainHtml5Audio:function(){var l=this||e;if(l._html5AudioPool.length)return l._html5AudioPool.pop();var p=new Audio().play();return p&&typeof Promise<"u"&&(p instanceof Promise||typeof p.then=="function")&&p.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(l){var p=this||e;return l._unlocked&&p._html5AudioPool.push(l),p},_autoSuspend:function(){var l=this;if(!(!l.autoSuspend||!l.ctx||typeof l.ctx.suspend>"u"||!e.usingWebAudio)){for(var p=0;p<l._howls.length;p++)if(l._howls[p]._webAudio){for(var f=0;f<l._howls[p]._sounds.length;f++)if(!l._howls[p]._sounds[f]._paused)return l}return l._suspendTimer&&clearTimeout(l._suspendTimer),l._suspendTimer=setTimeout(function(){if(l.autoSuspend){l._suspendTimer=null,l.state="suspending";var m=function(){l.state="suspended",l._resumeAfterSuspend&&(delete l._resumeAfterSuspend,l._autoResume())};l.ctx.suspend().then(m,m)}},3e4),l}},_autoResume:function(){var l=this;if(!(!l.ctx||typeof l.ctx.resume>"u"||!e.usingWebAudio))return l.state==="running"&&l.ctx.state!=="interrupted"&&l._suspendTimer?(clearTimeout(l._suspendTimer),l._suspendTimer=null):l.state==="suspended"||l.state==="running"&&l.ctx.state==="interrupted"?(l.ctx.resume().then(function(){l.state="running";for(var p=0;p<l._howls.length;p++)l._howls[p]._emit("resume")}),l._suspendTimer&&(clearTimeout(l._suspendTimer),l._suspendTimer=null)):l.state==="suspending"&&(l._resumeAfterSuspend=!0),l}};var e=new t,i=function(l){var p=this;if(!l.src||l.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}p.init(l)};i.prototype={init:function(l){var p=this;return e.ctx||d(),p._autoplay=l.autoplay||!1,p._format=typeof l.format!="string"?l.format:[l.format],p._html5=l.html5||!1,p._muted=l.mute||!1,p._loop=l.loop||!1,p._pool=l.pool||5,p._preload=typeof l.preload=="boolean"||l.preload==="metadata"?l.preload:!0,p._rate=l.rate||1,p._sprite=l.sprite||{},p._src=typeof l.src!="string"?l.src:[l.src],p._volume=l.volume!==void 0?l.volume:1,p._xhr={method:l.xhr&&l.xhr.method?l.xhr.method:"GET",headers:l.xhr&&l.xhr.headers?l.xhr.headers:null,withCredentials:l.xhr&&l.xhr.withCredentials?l.xhr.withCredentials:!1},p._duration=0,p._state="unloaded",p._sounds=[],p._endTimers={},p._queue=[],p._playLock=!1,p._onend=l.onend?[{fn:l.onend}]:[],p._onfade=l.onfade?[{fn:l.onfade}]:[],p._onload=l.onload?[{fn:l.onload}]:[],p._onloaderror=l.onloaderror?[{fn:l.onloaderror}]:[],p._onplayerror=l.onplayerror?[{fn:l.onplayerror}]:[],p._onpause=l.onpause?[{fn:l.onpause}]:[],p._onplay=l.onplay?[{fn:l.onplay}]:[],p._onstop=l.onstop?[{fn:l.onstop}]:[],p._onmute=l.onmute?[{fn:l.onmute}]:[],p._onvolume=l.onvolume?[{fn:l.onvolume}]:[],p._onrate=l.onrate?[{fn:l.onrate}]:[],p._onseek=l.onseek?[{fn:l.onseek}]:[],p._onunlock=l.onunlock?[{fn:l.onunlock}]:[],p._onresume=[],p._webAudio=e.usingWebAudio&&!p._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(p),p._autoplay&&p._queue.push({event:"play",action:function(){p.play()}}),p._preload&&p._preload!=="none"&&p.load(),p},load:function(){var l=this,p=null;if(e.noAudio){l._emit("loaderror",null,"No audio support.");return}typeof l._src=="string"&&(l._src=[l._src]);for(var f=0;f<l._src.length;f++){var m,v;if(l._format&&l._format[f])m=l._format[f];else{if(v=l._src[f],typeof v!="string"){l._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}m=/^data:audio\/([^;,]+);/i.exec(v),m||(m=/\.([^.]+)$/.exec(v.split("?",1)[0])),m&&(m=m[1].toLowerCase())}if(m||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),m&&e.codecs(m)){p=l._src[f];break}}if(!p){l._emit("loaderror",null,"No codec support for selected audio sources.");return}return l._src=p,l._state="loading",window.location.protocol==="https:"&&p.slice(0,5)==="http:"&&(l._html5=!0,l._webAudio=!1),new n(l),l._webAudio&&o(l),l},play:function(l,p){var f=this,m=null;if(typeof l=="number")m=l,l=null;else{if(typeof l=="string"&&f._state==="loaded"&&!f._sprite[l])return null;if(typeof l>"u"&&(l="__default",!f._playLock)){for(var v=0,w=0;w<f._sounds.length;w++)f._sounds[w]._paused&&!f._sounds[w]._ended&&(v++,m=f._sounds[w]._id);v===1?l=null:m=null}}var b=m?f._soundById(m):f._inactiveSound();if(!b)return null;if(m&&!l&&(l=b._sprite||"__default"),f._state!=="loaded"){b._sprite=l,b._ended=!1;var I=b._id;return f._queue.push({event:"play",action:function(){f.play(I)}}),I}if(m&&!b._paused)return p||f._loadQueue("play"),b._id;f._webAudio&&e._autoResume();var O=Math.max(0,b._seek>0?b._seek:f._sprite[l][0]/1e3),N=Math.max(0,(f._sprite[l][0]+f._sprite[l][1])/1e3-O),q=N*1e3/Math.abs(b._rate),ie=f._sprite[l][0]/1e3,k=(f._sprite[l][0]+f._sprite[l][1])/1e3;b._sprite=l,b._ended=!1;var S=function(){b._paused=!1,b._seek=O,b._start=ie,b._stop=k,b._loop=!!(b._loop||f._sprite[l][2])};if(O>=k){f._ended(b);return}var E=b._node;if(f._webAudio){var D=function(){f._playLock=!1,S(),f._refreshBuffer(b);var V=b._muted||f._muted?0:b._volume;E.gain.setValueAtTime(V,e.ctx.currentTime),b._playStart=e.ctx.currentTime,typeof E.bufferSource.start>"u"?b._loop?E.bufferSource.noteGrainOn(0,O,86400):E.bufferSource.noteGrainOn(0,O,N):b._loop?E.bufferSource.start(0,O,86400):E.bufferSource.start(0,O,N),q!==1/0&&(f._endTimers[b._id]=setTimeout(f._ended.bind(f,b),q)),p||setTimeout(function(){f._emit("play",b._id),f._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?D():(f._playLock=!0,f.once("resume",D),f._clearTimer(b._id))}else{var L=function(){E.currentTime=O,E.muted=b._muted||f._muted||e._muted||E.muted,E.volume=b._volume*e.volume(),E.playbackRate=b._rate;try{var V=E.play();if(V&&typeof Promise<"u"&&(V instanceof Promise||typeof V.then=="function")?(f._playLock=!0,S(),V.then(function(){f._playLock=!1,E._unlocked=!0,p?f._loadQueue():f._emit("play",b._id)}).catch(function(){f._playLock=!1,f._emit("playerror",b._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),b._ended=!0,b._paused=!0})):p||(f._playLock=!1,S(),f._emit("play",b._id)),E.playbackRate=b._rate,E.paused){f._emit("playerror",b._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}l!=="__default"||b._loop?f._endTimers[b._id]=setTimeout(f._ended.bind(f,b),q):(f._endTimers[b._id]=function(){f._ended(b),E.removeEventListener("ended",f._endTimers[b._id],!1)},E.addEventListener("ended",f._endTimers[b._id],!1))}catch(ne){f._emit("playerror",b._id,ne)}};E.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(E.src=f._src,E.load());var F=window&&window.ejecta||!E.readyState&&e._navigator.isCocoonJS;if(E.readyState>=3||F)L();else{f._playLock=!0,f._state="loading";var A=function(){f._state="loaded",L(),E.removeEventListener(e._canPlayEvent,A,!1)};E.addEventListener(e._canPlayEvent,A,!1),f._clearTimer(b._id)}}return b._id},pause:function(l){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"pause",action:function(){p.pause(l)}}),p;for(var f=p._getSoundIds(l),m=0;m<f.length;m++){p._clearTimer(f[m]);var v=p._soundById(f[m]);if(v&&!v._paused&&(v._seek=p.seek(f[m]),v._rateSeek=0,v._paused=!0,p._stopFade(f[m]),v._node))if(p._webAudio){if(!v._node.bufferSource)continue;typeof v._node.bufferSource.stop>"u"?v._node.bufferSource.noteOff(0):v._node.bufferSource.stop(0),p._cleanBuffer(v._node)}else(!isNaN(v._node.duration)||v._node.duration===1/0)&&v._node.pause();arguments[1]||p._emit("pause",v?v._id:null)}return p},stop:function(l,p){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"stop",action:function(){f.stop(l)}}),f;for(var m=f._getSoundIds(l),v=0;v<m.length;v++){f._clearTimer(m[v]);var w=f._soundById(m[v]);w&&(w._seek=w._start||0,w._rateSeek=0,w._paused=!0,w._ended=!0,f._stopFade(m[v]),w._node&&(f._webAudio?w._node.bufferSource&&(typeof w._node.bufferSource.stop>"u"?w._node.bufferSource.noteOff(0):w._node.bufferSource.stop(0),f._cleanBuffer(w._node)):(!isNaN(w._node.duration)||w._node.duration===1/0)&&(w._node.currentTime=w._start||0,w._node.pause(),w._node.duration===1/0&&f._clearSound(w._node))),p||f._emit("stop",w._id))}return f},mute:function(l,p){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"mute",action:function(){f.mute(l,p)}}),f;if(typeof p>"u")if(typeof l=="boolean")f._muted=l;else return f._muted;for(var m=f._getSoundIds(p),v=0;v<m.length;v++){var w=f._soundById(m[v]);w&&(w._muted=l,w._interval&&f._stopFade(w._id),f._webAudio&&w._node?w._node.gain.setValueAtTime(l?0:w._volume,e.ctx.currentTime):w._node&&(w._node.muted=e._muted?!0:l),f._emit("mute",w._id))}return f},volume:function(){var l=this,p=arguments,f,m;if(p.length===0)return l._volume;if(p.length===1||p.length===2&&typeof p[1]>"u"){var v=l._getSoundIds(),w=v.indexOf(p[0]);w>=0?m=parseInt(p[0],10):f=parseFloat(p[0])}else p.length>=2&&(f=parseFloat(p[0]),m=parseInt(p[1],10));var b;if(typeof f<"u"&&f>=0&&f<=1){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"volume",action:function(){l.volume.apply(l,p)}}),l;typeof m>"u"&&(l._volume=f),m=l._getSoundIds(m);for(var I=0;I<m.length;I++)b=l._soundById(m[I]),b&&(b._volume=f,p[2]||l._stopFade(m[I]),l._webAudio&&b._node&&!b._muted?b._node.gain.setValueAtTime(f,e.ctx.currentTime):b._node&&!b._muted&&(b._node.volume=f*e.volume()),l._emit("volume",b._id))}else return b=m?l._soundById(m):l._sounds[0],b?b._volume:0;return l},fade:function(l,p,f,m){var v=this;if(v._state!=="loaded"||v._playLock)return v._queue.push({event:"fade",action:function(){v.fade(l,p,f,m)}}),v;l=Math.min(Math.max(0,parseFloat(l)),1),p=Math.min(Math.max(0,parseFloat(p)),1),f=parseFloat(f),v.volume(l,m);for(var w=v._getSoundIds(m),b=0;b<w.length;b++){var I=v._soundById(w[b]);if(I){if(m||v._stopFade(w[b]),v._webAudio&&!I._muted){var O=e.ctx.currentTime,N=O+f/1e3;I._volume=l,I._node.gain.setValueAtTime(l,O),I._node.gain.linearRampToValueAtTime(p,N)}v._startFadeInterval(I,l,p,f,w[b],typeof m>"u")}}return v},_startFadeInterval:function(l,p,f,m,v,w){var b=this,I=p,O=f-p,N=Math.abs(O/.01),q=Math.max(4,N>0?m/N:m),ie=Date.now();l._fadeTo=f,l._interval=setInterval(function(){var k=(Date.now()-ie)/m;ie=Date.now(),I+=O*k,I=Math.round(I*100)/100,O<0?I=Math.max(f,I):I=Math.min(f,I),b._webAudio?l._volume=I:b.volume(I,l._id,!0),w&&(b._volume=I),(f<p&&I<=f||f>p&&I>=f)&&(clearInterval(l._interval),l._interval=null,l._fadeTo=null,b.volume(f,l._id),b._emit("fade",l._id))},q)},_stopFade:function(l){var p=this,f=p._soundById(l);return f&&f._interval&&(p._webAudio&&f._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(f._interval),f._interval=null,p.volume(f._fadeTo,l),f._fadeTo=null,p._emit("fade",l)),p},loop:function(){var l=this,p=arguments,f,m,v;if(p.length===0)return l._loop;if(p.length===1)if(typeof p[0]=="boolean")f=p[0],l._loop=f;else return v=l._soundById(parseInt(p[0],10)),v?v._loop:!1;else p.length===2&&(f=p[0],m=parseInt(p[1],10));for(var w=l._getSoundIds(m),b=0;b<w.length;b++)v=l._soundById(w[b]),v&&(v._loop=f,l._webAudio&&v._node&&v._node.bufferSource&&(v._node.bufferSource.loop=f,f&&(v._node.bufferSource.loopStart=v._start||0,v._node.bufferSource.loopEnd=v._stop,l.playing(w[b])&&(l.pause(w[b],!0),l.play(w[b],!0)))));return l},rate:function(){var l=this,p=arguments,f,m;if(p.length===0)m=l._sounds[0]._id;else if(p.length===1){var v=l._getSoundIds(),w=v.indexOf(p[0]);w>=0?m=parseInt(p[0],10):f=parseFloat(p[0])}else p.length===2&&(f=parseFloat(p[0]),m=parseInt(p[1],10));var b;if(typeof f=="number"){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"rate",action:function(){l.rate.apply(l,p)}}),l;typeof m>"u"&&(l._rate=f),m=l._getSoundIds(m);for(var I=0;I<m.length;I++)if(b=l._soundById(m[I]),b){l.playing(m[I])&&(b._rateSeek=l.seek(m[I]),b._playStart=l._webAudio?e.ctx.currentTime:b._playStart),b._rate=f,l._webAudio&&b._node&&b._node.bufferSource?b._node.bufferSource.playbackRate.setValueAtTime(f,e.ctx.currentTime):b._node&&(b._node.playbackRate=f);var O=l.seek(m[I]),N=(l._sprite[b._sprite][0]+l._sprite[b._sprite][1])/1e3-O,q=N*1e3/Math.abs(b._rate);(l._endTimers[m[I]]||!b._paused)&&(l._clearTimer(m[I]),l._endTimers[m[I]]=setTimeout(l._ended.bind(l,b),q)),l._emit("rate",b._id)}}else return b=l._soundById(m),b?b._rate:l._rate;return l},seek:function(){var l=this,p=arguments,f,m;if(p.length===0)l._sounds.length&&(m=l._sounds[0]._id);else if(p.length===1){var v=l._getSoundIds(),w=v.indexOf(p[0]);w>=0?m=parseInt(p[0],10):l._sounds.length&&(m=l._sounds[0]._id,f=parseFloat(p[0]))}else p.length===2&&(f=parseFloat(p[0]),m=parseInt(p[1],10));if(typeof m>"u")return 0;if(typeof f=="number"&&(l._state!=="loaded"||l._playLock))return l._queue.push({event:"seek",action:function(){l.seek.apply(l,p)}}),l;var b=l._soundById(m);if(b)if(typeof f=="number"&&f>=0){var I=l.playing(m);I&&l.pause(m,!0),b._seek=f,b._ended=!1,l._clearTimer(m),!l._webAudio&&b._node&&!isNaN(b._node.duration)&&(b._node.currentTime=f);var O=function(){I&&l.play(m,!0),l._emit("seek",m)};if(I&&!l._webAudio){var N=function(){l._playLock?setTimeout(N,0):O()};setTimeout(N,0)}else O()}else if(l._webAudio){var q=l.playing(m)?e.ctx.currentTime-b._playStart:0,ie=b._rateSeek?b._rateSeek-b._seek:0;return b._seek+(ie+q*Math.abs(b._rate))}else return b._node.currentTime;return l},playing:function(l){var p=this;if(typeof l=="number"){var f=p._soundById(l);return f?!f._paused:!1}for(var m=0;m<p._sounds.length;m++)if(!p._sounds[m]._paused)return!0;return!1},duration:function(l){var p=this,f=p._duration,m=p._soundById(l);return m&&(f=p._sprite[m._sprite][1]/1e3),f},state:function(){return this._state},unload:function(){for(var l=this,p=l._sounds,f=0;f<p.length;f++)p[f]._paused||l.stop(p[f]._id),l._webAudio||(l._clearSound(p[f]._node),p[f]._node.removeEventListener("error",p[f]._errorFn,!1),p[f]._node.removeEventListener(e._canPlayEvent,p[f]._loadFn,!1),p[f]._node.removeEventListener("ended",p[f]._endFn,!1),e._releaseHtml5Audio(p[f]._node)),delete p[f]._node,l._clearTimer(p[f]._id);var m=e._howls.indexOf(l);m>=0&&e._howls.splice(m,1);var v=!0;for(f=0;f<e._howls.length;f++)if(e._howls[f]._src===l._src||l._src.indexOf(e._howls[f]._src)>=0){v=!1;break}return r&&v&&delete r[l._src],e.noAudio=!1,l._state="unloaded",l._sounds=[],l=null,null},on:function(l,p,f,m){var v=this,w=v["_on"+l];return typeof p=="function"&&w.push(m?{id:f,fn:p,once:m}:{id:f,fn:p}),v},off:function(l,p,f){var m=this,v=m["_on"+l],w=0;if(typeof p=="number"&&(f=p,p=null),p||f)for(w=0;w<v.length;w++){var b=f===v[w].id;if(p===v[w].fn&&b||!p&&b){v.splice(w,1);break}}else if(l)m["_on"+l]=[];else{var I=Object.keys(m);for(w=0;w<I.length;w++)I[w].indexOf("_on")===0&&Array.isArray(m[I[w]])&&(m[I[w]]=[])}return m},once:function(l,p,f){var m=this;return m.on(l,p,f,1),m},_emit:function(l,p,f){for(var m=this,v=m["_on"+l],w=v.length-1;w>=0;w--)(!v[w].id||v[w].id===p||l==="load")&&(setTimeout((function(b){b.call(this,p,f)}).bind(m,v[w].fn),0),v[w].once&&m.off(l,v[w].fn,v[w].id));return m._loadQueue(l),m},_loadQueue:function(l){var p=this;if(p._queue.length>0){var f=p._queue[0];f.event===l&&(p._queue.shift(),p._loadQueue()),l||f.action()}return p},_ended:function(l){var p=this,f=l._sprite;if(!p._webAudio&&l._node&&!l._node.paused&&!l._node.ended&&l._node.currentTime<l._stop)return setTimeout(p._ended.bind(p,l),100),p;var m=!!(l._loop||p._sprite[f][2]);if(p._emit("end",l._id),!p._webAudio&&m&&p.stop(l._id,!0).play(l._id),p._webAudio&&m){p._emit("play",l._id),l._seek=l._start||0,l._rateSeek=0,l._playStart=e.ctx.currentTime;var v=(l._stop-l._start)*1e3/Math.abs(l._rate);p._endTimers[l._id]=setTimeout(p._ended.bind(p,l),v)}return p._webAudio&&!m&&(l._paused=!0,l._ended=!0,l._seek=l._start||0,l._rateSeek=0,p._clearTimer(l._id),p._cleanBuffer(l._node),e._autoSuspend()),!p._webAudio&&!m&&p.stop(l._id,!0),p},_clearTimer:function(l){var p=this;if(p._endTimers[l]){if(typeof p._endTimers[l]!="function")clearTimeout(p._endTimers[l]);else{var f=p._soundById(l);f&&f._node&&f._node.removeEventListener("ended",p._endTimers[l],!1)}delete p._endTimers[l]}return p},_soundById:function(l){for(var p=this,f=0;f<p._sounds.length;f++)if(l===p._sounds[f]._id)return p._sounds[f];return null},_inactiveSound:function(){var l=this;l._drain();for(var p=0;p<l._sounds.length;p++)if(l._sounds[p]._ended)return l._sounds[p].reset();return new n(l)},_drain:function(){var l=this,p=l._pool,f=0,m=0;if(!(l._sounds.length<p)){for(m=0;m<l._sounds.length;m++)l._sounds[m]._ended&&f++;for(m=l._sounds.length-1;m>=0;m--){if(f<=p)return;l._sounds[m]._ended&&(l._webAudio&&l._sounds[m]._node&&l._sounds[m]._node.disconnect(0),l._sounds.splice(m,1),f--)}}},_getSoundIds:function(l){var p=this;if(typeof l>"u"){for(var f=[],m=0;m<p._sounds.length;m++)f.push(p._sounds[m]._id);return f}else return[l]},_refreshBuffer:function(l){var p=this;return l._node.bufferSource=e.ctx.createBufferSource(),l._node.bufferSource.buffer=r[p._src],l._panner?l._node.bufferSource.connect(l._panner):l._node.bufferSource.connect(l._node),l._node.bufferSource.loop=l._loop,l._loop&&(l._node.bufferSource.loopStart=l._start||0,l._node.bufferSource.loopEnd=l._stop||0),l._node.bufferSource.playbackRate.setValueAtTime(l._rate,e.ctx.currentTime),p},_cleanBuffer:function(l){var p=this,f=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!l.bufferSource)return p;if(e._scratchBuffer&&l.bufferSource&&(l.bufferSource.onended=null,l.bufferSource.disconnect(0),f))try{l.bufferSource.buffer=e._scratchBuffer}catch{}return l.bufferSource=null,p},_clearSound:function(l){var p=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);p||(l.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var n=function(l){this._parent=l,this.init()};n.prototype={init:function(){var l=this,p=l._parent;return l._muted=p._muted,l._loop=p._loop,l._volume=p._volume,l._rate=p._rate,l._seek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,p._sounds.push(l),l.create(),l},create:function(){var l=this,p=l._parent,f=e._muted||l._muted||l._parent._muted?0:l._volume;return p._webAudio?(l._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),l._node.gain.setValueAtTime(f,e.ctx.currentTime),l._node.paused=!0,l._node.connect(e.masterGain)):e.noAudio||(l._node=e._obtainHtml5Audio(),l._errorFn=l._errorListener.bind(l),l._node.addEventListener("error",l._errorFn,!1),l._loadFn=l._loadListener.bind(l),l._node.addEventListener(e._canPlayEvent,l._loadFn,!1),l._endFn=l._endListener.bind(l),l._node.addEventListener("ended",l._endFn,!1),l._node.src=p._src,l._node.preload=p._preload===!0?"auto":p._preload,l._node.volume=f*e.volume(),l._node.load()),l},reset:function(){var l=this,p=l._parent;return l._muted=p._muted,l._loop=p._loop,l._volume=p._volume,l._rate=p._rate,l._seek=0,l._rateSeek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,l},_errorListener:function(){var l=this;l._parent._emit("loaderror",l._id,l._node.error?l._node.error.code:0),l._node.removeEventListener("error",l._errorFn,!1)},_loadListener:function(){var l=this,p=l._parent;p._duration=Math.ceil(l._node.duration*10)/10,Object.keys(p._sprite).length===0&&(p._sprite={__default:[0,p._duration*1e3]}),p._state!=="loaded"&&(p._state="loaded",p._emit("load"),p._loadQueue()),l._node.removeEventListener(e._canPlayEvent,l._loadFn,!1)},_endListener:function(){var l=this,p=l._parent;p._duration===1/0&&(p._duration=Math.ceil(l._node.duration*10)/10,p._sprite.__default[1]===1/0&&(p._sprite.__default[1]=p._duration*1e3),p._ended(l)),l._node.removeEventListener("ended",l._endFn,!1)}};var r={},o=function(l){var p=l._src;if(r[p]){l._duration=r[p].duration,h(l);return}if(/^data:[^;]+;base64,/.test(p)){for(var f=atob(p.split(",")[1]),m=new Uint8Array(f.length),v=0;v<f.length;++v)m[v]=f.charCodeAt(v);c(m.buffer,l)}else{var w=new XMLHttpRequest;w.open(l._xhr.method,p,!0),w.withCredentials=l._xhr.withCredentials,w.responseType="arraybuffer",l._xhr.headers&&Object.keys(l._xhr.headers).forEach(function(b){w.setRequestHeader(b,l._xhr.headers[b])}),w.onload=function(){var b=(w.status+"")[0];if(b!=="0"&&b!=="2"&&b!=="3"){l._emit("loaderror",null,"Failed loading audio file with status: "+w.status+".");return}c(w.response,l)},w.onerror=function(){l._webAudio&&(l._html5=!0,l._webAudio=!1,l._sounds=[],delete r[p],l.load())},a(w)}},a=function(l){try{l.send()}catch{l.onerror()}},c=function(l,p){var f=function(){p._emit("loaderror",null,"Decoding audio data failed.")},m=function(v){v&&p._sounds.length>0?(r[p._src]=v,h(p,v)):f()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(l).then(m).catch(f):e.ctx.decodeAudioData(l,m,f)},h=function(l,p){p&&!l._duration&&(l._duration=p.duration),Object.keys(l._sprite).length===0&&(l._sprite={__default:[0,l._duration*1e3]}),l._state!=="loaded"&&(l._state="loaded",l._emit("load"),l._loadQueue())},d=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var l=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),p=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),f=p?parseInt(p[1],10):null;if(l&&f&&f<9){var m=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!m&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};s.Howler=e,s.Howl=i,typeof Pn<"u"?(Pn.HowlerGlobal=t,Pn.Howler=e,Pn.Howl=i,Pn.Sound=n):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=i,window.Sound=n)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var n=i._howls.length-1;n>=0;n--)i._howls[n].stereo(e);return i},HowlerGlobal.prototype.pos=function(e,i,n){var r=this;if(!r.ctx||!r.ctx.listener)return r;if(i=typeof i!="number"?r._pos[1]:i,n=typeof n!="number"?r._pos[2]:n,typeof e=="number")r._pos=[e,i,n],typeof r.ctx.listener.positionX<"u"?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]);else return r._pos;return r},HowlerGlobal.prototype.orientation=function(e,i,n,r,o,a){var c=this;if(!c.ctx||!c.ctx.listener)return c;var h=c._orientation;if(i=typeof i!="number"?h[1]:i,n=typeof n!="number"?h[2]:n,r=typeof r!="number"?h[3]:r,o=typeof o!="number"?h[4]:o,a=typeof a!="number"?h[5]:a,typeof e=="number")c._orientation=[e,i,n,r,o,a],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(e,i,n,r,o,a);else return h;return c},Howl.prototype.init=function(e){return function(i){var n=this;return n._orientation=i.orientation||[1,0,0],n._stereo=i.stereo||null,n._pos=i.pos||null,n._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},n._onstereo=i.onstereo?[{fn:i.onstereo}]:[],n._onpos=i.onpos?[{fn:i.onpos}]:[],n._onorientation=i.onorientation?[{fn:i.onorientation}]:[],e.call(this,i)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,i){var n=this;if(!n._webAudio)return n;if(n._state!=="loaded")return n._queue.push({event:"stereo",action:function(){n.stereo(e,i)}}),n;var r=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof e=="number")n._stereo=e,n._pos=[e,0,0];else return n._stereo;for(var o=n._getSoundIds(i),a=0;a<o.length;a++){var c=n._soundById(o[a]);if(c)if(typeof e=="number")c._stereo=e,c._pos=[e,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&t(c,r),r==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(e,0,0):c._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),n._emit("stereo",c._id);else return c._stereo}return n},Howl.prototype.pos=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(e,i,n,r)}}),o;if(i=typeof i!="number"?0:i,n=typeof n!="number"?-.5:n,typeof r>"u")if(typeof e=="number")o._pos=[e,i,n];else return o._pos;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._pos=[e,i,n],h._node&&((!h._panner||h._panner.pan)&&t(h,"spatial"),typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setPosition(e,i,n)),o._emit("pos",h._id);else return h._pos}return o},Howl.prototype.orientation=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(e,i,n,r)}}),o;if(i=typeof i!="number"?o._orientation[1]:i,n=typeof n!="number"?o._orientation[2]:n,typeof r>"u")if(typeof e=="number")o._orientation=[e,i,n];else return o._orientation;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._orientation=[e,i,n],h._node&&(h._panner||(h._pos||(h._pos=o._pos||[0,0,-.5]),t(h,"spatial")),typeof h._panner.orientationX<"u"?(h._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setOrientation(e,i,n)),o._emit("orientation",h._id);else return h._orientation}return o},Howl.prototype.pannerAttr=function(){var e=this,i=arguments,n,r,o;if(!e._webAudio)return e;if(i.length===0)return e._pannerAttr;if(i.length===1)if(typeof i[0]=="object")n=i[0],typeof r>"u"&&(n.pannerAttr||(n.pannerAttr={coneInnerAngle:n.coneInnerAngle,coneOuterAngle:n.coneOuterAngle,coneOuterGain:n.coneOuterGain,distanceModel:n.distanceModel,maxDistance:n.maxDistance,refDistance:n.refDistance,rolloffFactor:n.rolloffFactor,panningModel:n.panningModel}),e._pannerAttr={coneInnerAngle:typeof n.pannerAttr.coneInnerAngle<"u"?n.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof n.pannerAttr.coneOuterAngle<"u"?n.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof n.pannerAttr.coneOuterGain<"u"?n.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof n.pannerAttr.distanceModel<"u"?n.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof n.pannerAttr.maxDistance<"u"?n.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof n.pannerAttr.refDistance<"u"?n.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof n.pannerAttr.rolloffFactor<"u"?n.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof n.pannerAttr.panningModel<"u"?n.pannerAttr.panningModel:e._panningModel});else return o=e._soundById(parseInt(i[0],10)),o?o._pannerAttr:e._pannerAttr;else i.length===2&&(n=i[0],r=parseInt(i[1],10));for(var a=e._getSoundIds(r),c=0;c<a.length;c++)if(o=e._soundById(a[c]),o){var h=o._pannerAttr;h={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:h.coneOuterAngle,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:h.coneOuterGain,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:h.distanceModel,maxDistance:typeof n.maxDistance<"u"?n.maxDistance:h.maxDistance,refDistance:typeof n.refDistance<"u"?n.refDistance:h.refDistance,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:h.rolloffFactor,panningModel:typeof n.panningModel<"u"?n.panningModel:h.panningModel};var d=o._panner;d||(o._pos||(o._pos=e._pos||[0,0,-.5]),t(o,"spatial"),d=o._panner),d.coneInnerAngle=h.coneInnerAngle,d.coneOuterAngle=h.coneOuterAngle,d.coneOuterGain=h.coneOuterGain,d.distanceModel=h.distanceModel,d.maxDistance=h.maxDistance,d.refDistance=h.refDistance,d.rolloffFactor=h.rolloffFactor,d.panningModel=h.panningModel}return e},Sound.prototype.init=function(e){return function(){var i=this,n=i._parent;i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,e.call(this),i._stereo?n.stereo(i._stereo):i._pos&&n.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var i=this,n=i._parent;return i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,i._stereo?n.stereo(i._stereo):i._pos?n.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,n._refreshBuffer(i)),e.call(this)}}(Sound.prototype.reset);var t=function(e,i){i=i||"spatial",i==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(hi);class nd{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,hi.Howler.autoUnlock=!0,hi.Howler.html5PoolSize=10,hi.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(hi.Howler.ctx&&hi.Howler.ctx.state==="suspended")try{await hi.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(t){console.error("Failed to resume AudioContext:",t)}}async preloadHotspots(t){const e=t.filter(i=>i.audioUrl).map(i=>({id:i.id,url:i.audioUrl}));this.preloadQueue.push(...e),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:t,url:e}=this.preloadQueue.shift();this.sounds.has(t)||(await this.loadSound(t,e),this.preloadedCount++)}this.isPreloading=!1}async loadSound(t,e){return new Promise(i=>{const n=new Audio;n.addEventListener("error",()=>{console.log(`Audio not found for ${t}, using placeholder`),this.createSound(t,this.placeholderUrl,!0),i()}),n.addEventListener("canplaythrough",()=>{this.createSound(t,e,!1),i()}),n.src=e})}createSound(t,e,i=!1){const n=new hi.Howl({src:[e],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${t} (placeholder: ${i})`)},onend:()=>this.handlePlaybackEnd(t),onloaderror:(r,o)=>{console.error(`Failed to load sound ${t}:`,o),this.onError&&this.onError(t,o)},onplayerror:(r,o)=>{console.error(`Failed to play sound ${t}:`,o),this.onError&&this.onError(t,o)}});this.sounds.set(t,{howl:n,isPlaceholder:i,duration:i?this.placeholderDuration:null})}async play(t){if(await this.resumeContext(),this.currentHotspotId===t&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(t)||(this.state="loading",await this.loadSound(t,`/audio/hotspot_${t}.mp3`));const e=this.sounds.get(t);if(!e){console.error(`No sound found for hotspot: ${t}`);return}const i=e.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,i,t):(this.currentSound&&this.currentSound.stop(),this.currentSound=i,this.currentHotspotId=t,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(t),this.startProgressTracking())}crossfade(t,e,i){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${i}`),this.isCrossfading=!0,this.state="crossfading";const n=this.crossfadeDuration,r=20,o=n/r;let a=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,i),e.volume(0),e.play();const c=setInterval(()=>{a++;const h=a/r;t.volume(this.masterVolume*(1-h)),e.volume(this.masterVolume*h),a>=r&&(clearInterval(c),t.stop(),t.volume(this.masterVolume),this.previousSound=t,this.currentSound=e,this.currentHotspotId=i,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(i),this.startProgressTracking())},o)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(t){if(this.currentSound&&this.currentSound.playing()){const e=this.currentSound.seek()||0,i=this.currentSound.duration(),n=Math.max(0,Math.min(i,e+t));this.currentSound.seek(n),console.log(`Skipped to ${n.toFixed(1)}s`)}}setVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),hi.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,hi.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const t=this.currentSound.seek()||0,e=this.sounds.get(this.currentHotspotId),i=e!=null&&e.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,n=i>0?t/i*100:0;return{current:t,duration:i,percent:n}}seekTo(t){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(t)}seekToPercent(t){if(this.currentSound){const e=this.currentSound.duration(),i=t/100*e;this.seekTo(i)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const t=this.getProgress();this.onProgress(t)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(t){console.log(`Playback ended for hotspot: ${t}`),t===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(t))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(t,e=500){this.crossfadeEnabled=t,this.crossfadeDuration=Math.max(100,Math.min(2e3,e)),console.log(`Crossfade ${t?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(t){const e=this.sounds.get(t);e&&(e.howl.unload(),this.sounds.delete(t),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(t=>{t.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}playTemporalSound(t,e,i=50){(!e||isNaN(e)||!isFinite(e))&&(console.warn(`Invalid frequency for temporal sound: ${e}`),e=1e3),(!i||isNaN(i)||i<=0)&&(i=50),this.resumeContext(),this.uiAudioContext||(this.uiAudioContext=new(window.AudioContext||window.webkitAudioContext));try{const n=this.uiAudioContext,r=n.createOscillator(),o=n.createGain(),a=n.createBiquadFilter();a.type="lowpass",a.frequency.value=Math.min(e*1.5,2e3),r.connect(a),a.connect(o),o.connect(n.destination),r.type="sine",r.frequency.value=e;const c=n.currentTime,h=.01,d=i/1e3,l=e>1500?.05:.08;o.gain.setValueAtTime(0,c),o.gain.linearRampToValueAtTime(l,c+h),o.gain.exponentialRampToValueAtTime(.001,c+d),r.start(c),r.stop(c+d),console.log(`Temporal sound played: ${t} at ${e}Hz for ${i}ms`)}catch(n){console.error("Error playing temporal sound:",n)}}playTemporalTick(t=.5){const i=1200+400*(!isNaN(t)&&isFinite(t)?Math.min(1,Math.max(0,t)):.5);this.playTemporalSound("explore",i,40)}playTemporalBoop(){this.playTemporalSound("preview",600,80)}playTemporalThunk(t=.5){const i=150+100*(1-(!isNaN(t)&&isFinite(t)?Math.min(1,Math.max(0,t)):.5));this.playTemporalSound("activate",i,120)}}class rd{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(t){t.forEach(e=>{e.image_url_1&&this.overlays.set(e.id,{hotspotId:e.id,imageUrls:[e.image_url_1],autoReveal:e.overlay_auto_reveal||!1,displayMode:e.overlay_display_mode||"modal",showButton:e.show_images_button!==!1,access:e.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(t){const e=[];t.forEach(i=>{const n=this.overlays.get(i);n&&!n.isLoaded&&n.imageUrls.forEach(r=>{this.preloadedImages.has(r)||e.push({url:r,hotspotId:i})})}),this.preloadQueue.push(...e),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:t,hotspotId:e}=this.preloadQueue.shift();try{await this.loadImage(t,e)}catch(i){console.error(`Failed to preload image: ${t}`,i)}}this.isPreloading=!1}loadImage(t,e){return new Promise((i,n)=>{const r=new Image;r.onload=()=>{this.preloadedImages.set(t,r);const o=this.overlays.get(e);o&&(o.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(t,e),console.log(`Image loaded: ${t}`),i(r)},r.onerror=o=>{this.onImageError&&this.onImageError(t,e,o),console.error(`Failed to load image: ${t}`),n(o)},r.crossOrigin="anonymous",r.src=t})}shouldAutoReveal(t){const e=this.overlays.get(t);return e?e.autoReveal:!1}shouldShowButton(t){const e=this.overlays.get(t);return e?e.showButton:!0}getOverlay(t){return this.overlays.get(t)}openOverlay(t){const e=this.overlays.get(t);if(!e)return console.warn(`No overlay found for hotspot: ${t}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=t,!e.isLoaded){const i=e.imageUrls[0];this.loadImage(i,t).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(t,e),e}closeOverlay(){if(this.activeOverlay){const t=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(t)}}getImage(t){return this.preloadedImages.get(t)}hasAccess(t,e="free"){const i=this.overlays.get(t);if(!i)return!1;const n={free:0,gated:1,supporter:2},r=n[i.access]||0;return(n[e]||0)>=r}unloadImages(t){t.forEach(e=>{const i=this.overlays.get(e);i&&(i.imageUrls.forEach(n=>{this.preloadedImages.delete(n)}),i.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class sd{constructor(t){bn(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});bn(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const t=performance.memory.usedJSHeapSize/1048576,e=performance.memory.jsHeapSizeLimit/1048576,i=t/e*100;this.metrics.currentUsage=t,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,t);const n=this.state.memoryPressure;if(t>this.config.criticalThreshold||i>80?this.state.memoryPressure="critical":t>this.config.highThreshold||i>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==n)switch(console.log(`Memory pressure changed: ${n} → ${this.state.memoryPressure} (${t.toFixed(0)}MB, ${i.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const t=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==t.tiles&&(this.viewer.maxImageCacheCount=t.tiles,console.log(`Adjusted tile cache limit to ${t.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var e;console.warn("CRITICAL: Emergency memory cleanup");const t=(e=this.viewer.world)==null?void 0:e.getItemAt(0);t&&(t._tileCache&&t._tileCache.clearTilesFor(t),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(t=!1){var r,o;const e=(r=this.viewer.world)==null?void 0:r.getItemAt(0);if(!(e!=null&&e._tileCache))return;const i=e._tileCache,n=((o=i._tilesLoaded)==null?void 0:o.length)||i._imagesLoadedCount||0;if(t||n>this.config.cacheLimits[this.state.memoryPressure].tiles){const a=t?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,c=n-a;c>0&&(console.log(`Removing ${c} tiles from cache (current: ${n})`),i.clearTilesFor(e))}}clearUnusedImages(){const t=document.querySelectorAll("img");let e=0;t.forEach(i=>{!this.isElementVisible(i)&&i.src&&(i.removeAttribute("src"),e++)}),e>0&&console.log(`Cleared ${e} unused images`)}isElementVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const t={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const e=performance.memory.jsHeapSizeLimit/1048576;t.usagePercentage=(this.metrics.currentUsage/e*100).toFixed(1)+"%",t.totalLimit=e.toFixed(0)+"MB"}return t}destroy(){this.stop(),this.viewer=null}}class od{constructor(t={}){this.audioEngine=t.audioEngine||window.audioEngine,this.onPhaseChange=t.onPhaseChange||(()=>{}),this.modeStateManager=t.modeStateManager,this.thresholds={explore:300,preview:500,activate:800},this.state={isHolding:!1,holdStartTime:0,holdTimer:null,currentPhase:null,targetHotspot:null,feedbackGiven:new Set},this.currentPointerX=null,this.currentPointerY=null,this.progressElement=null,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window}startHold(t,e,i){t&&(this.modeStateManager&&(this.modeStateManager.modeStates.temporal.active||this.modeStateManager.modeStates.temporal.phase)&&(console.warn("[TEMPORAL_DEBUG] Cleaning stale temporal state before startHold"),this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null),this.state.isHolding=!0,this.state.holdStartTime=Date.now(),this.state.targetHotspot=t,this.state.feedbackGiven.clear(),this.state.currentPhase=null,this.onPhaseChange&&this.onPhaseChange("initial",t),this.isMobile&&this.createTouchRipple(e,i),this.state.holdTimer&&clearTimeout(this.state.holdTimer),this.scheduleFeedback(),this.showProgressIndicator(e,i),this.currentPointerX=e,this.currentPointerY=i,this.animateProgress())}endHold(){const t=this.state.isHolding?Date.now()-this.state.holdStartTime:0,e=this.state.targetHotspot,i=this.state.currentPhase;return this.state.holdTimer&&(clearTimeout(this.state.holdTimer),this.state.holdTimer=null),this.hideProgressIndicator(),this.state.isHolding=!1,this.state.holdStartTime=0,this.state.currentPhase=null,this.state.targetHotspot=null,this.state.feedbackGiven.clear(),this.cleanupTemporalVisuals(),this.modeStateManager&&this.modeStateManager.setTemporalState(!1,null),{duration:t,hotspot:e,finalPhase:i}}cleanupTemporalVisuals(){const t=["hotspot-temporal-touchDown","hotspot-temporal-explore","hotspot-temporal-preview","hotspot-temporal-activate"];document.querySelectorAll("[data-hotspot-id]").forEach(e=>{t.forEach(i=>{e.classList.remove(i)})}),this.modeStateManager&&this.modeStateManager.setTemporalState(!1,null)}scheduleFeedback(){this.giveFeedback("touchDown"),this.state.holdTimer=setTimeout(()=>{this.state.isHolding&&(this.state.currentPhase="explore",this.giveFeedback("explore"),this.state.holdTimer=setTimeout(()=>{this.state.isHolding&&(this.state.currentPhase="preview",this.giveFeedback("preview"),this.state.holdTimer=setTimeout(()=>{this.state.isHolding&&(this.state.currentPhase="activate",this.giveFeedback("activate"))},this.thresholds.activate-this.thresholds.preview))},this.thresholds.preview-this.thresholds.explore))},this.thresholds.explore)}giveFeedback(t){if(!this.state.isHolding){console.log("[TEMPORAL_DEBUG] Ignoring feedback - not holding");return}this.state.feedbackGiven.has(t)||(this.state.feedbackGiven.add(t),t==="touchDown"&&this.isMobile&&this.playHaptic("touchDown"),this.onPhaseChange(t,this.state.targetHotspot),this.playAudio(t),this.playHaptic(t))}playAudio(t){if(!this.audioEngine)return;const e=this.calculateHotspotSize(this.state.targetHotspot);switch(t){case"touchDown":this.audioEngine.playTemporalSound("touch",2e3,20);break;case"explore":this.audioEngine.playTemporalTick(e);break;case"preview":this.audioEngine.playTemporalBoop();break;case"activate":this.audioEngine.playTemporalThunk(e);break}}playHaptic(t){if(!navigator.vibrate||!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent))return;const e={touchDown:[20,10,20],explore:20,preview:[30,10,30],activate:100};e[t]&&navigator.vibrate(e[t])}calculateHotspotSize(t){if(!t||!t.coordinates)return .5;let e=1/0,i=-1/0,n=1/0,r=-1/0;(t.shape==="multipolygon"?t.coordinates[0]:t.coordinates).forEach(([c,h])=>{e=Math.min(e,c),i=Math.max(i,c),n=Math.min(n,h),r=Math.max(r,h)});const a=(i-e)*(r-n);return Math.min(1,Math.max(0,a/1e4))}createProgressIndicator(){this.progressElement||(this.progressElement=document.createElement("div"),this.progressElement.className="temporal-progress-indicator",this.progressElement.innerHTML=`
            <svg width="64" height="64" style="position: absolute; top: -2px; left: -2px; transform: rotate(-90deg);">
                <circle cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="4"/>
                <circle cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="4"
                        stroke-dasharray="188.5" stroke-dashoffset="188.5" class="progress-ring"/>
            </svg>
        `,document.body.appendChild(this.progressElement))}createTouchRipple(t,e){const i=document.createElement("div");i.className="temporal-touch-ripple",i.style.left=t-20+"px",i.style.top=e-20+"px",document.body.appendChild(i),setTimeout(()=>{i.remove()},600)}showProgressIndicator(t,e){this.progressElement||this.createProgressIndicator(),this.progressElement.style.display="block",this.progressElement.style.left=t+"px",this.progressElement.style.top=e+"px"}hideProgressIndicator(){this.progressElement&&(this.progressElement.style.display="none")}updateProgress(t,e,i){this.progressElement&&(this.currentPointerX=t,this.currentPointerY=e,this.progressElement.style.left=t+"px",this.progressElement.style.top=e+"px")}animateProgress(){if(!this.state.isHolding){this.hideProgressIndicator();return}const t=Date.now()-this.state.holdStartTime,e=this.thresholds.activate+200,i=Math.min(1,t/e);if(this.progressElement){const n=this.progressElement.querySelector(".progress-ring");if(n){const r=188.5-188.5*i;n.style.strokeDashoffset=r}this.currentPointerX!==void 0&&this.currentPointerY!==void 0&&(this.progressElement.style.left=this.currentPointerX+"px",this.progressElement.style.top=this.currentPointerY+"px")}this.state.isHolding&&i<1?requestAnimationFrame(()=>this.animateProgress()):this.hideProgressIndicator()}getCurrentProgress(){if(!this.state.isHolding)return 0;const t=Date.now()-this.state.holdStartTime,e=this.thresholds.activate+200;return Math.min(1,t/e)}updateThreshold(t,e){this.thresholds[t]!==void 0&&(this.thresholds[t]=e)}reset(){this.endHold(),this.progressElement&&(this.progressElement.remove(),this.progressElement=null)}destroy(){this.reset()}}class ad{constructor(){this.modes={direct:{name:"Direct (Classic)",description:"Tap to select and zoom immediately",mobile:!0,desktop:!0},temporal:{name:"Temporal (Hold)",description:"Hold duration determines action",mobile:!0,desktop:!0}};const t=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window;this.currentMode=localStorage.getItem("interactionMode")||(t?"temporal":"direct"),this.modeStates={temporal:{active:!1,phase:null},reveal:{active:!1,timer:null,style:localStorage.getItem("revealStyle")||"invert"}},this.listeners={modeChange:[],stateChange:[]}}getCurrentMode(){return this.currentMode}setMode(t){if(!this.modes[t])return!1;const e=this.currentMode;return this.currentMode=t,localStorage.setItem("interactionMode",t),this.notifyListeners("modeChange",{from:e,to:t}),!0}getModeConfig(t=this.currentMode){return this.modes[t]}setTemporalState(t,e=null){const i=this.modeStates.temporal.active;this.modeStates.temporal.active=t,this.modeStates.temporal.phase=e,console.log("[ModeStateManager] Temporal state changed:",{from:{active:i,phase:this.modeStates.temporal.phase},to:{active:t,phase:e},timestamp:Date.now()}),this.notifyListeners("stateChange",{mode:"temporal",state:this.modeStates.temporal})}isTemporalActive(){return this.currentMode==="temporal"&&this.modeStates.temporal.active}setRevealActive(t){this.modeStates.reveal.active=t,!t&&this.modeStates.reveal.timer&&(clearTimeout(this.modeStates.reveal.timer),this.modeStates.reveal.timer=null),this.notifyListeners("stateChange",{mode:"reveal",state:this.modeStates.reveal})}isRevealActive(){return this.modeStates.reveal.active}setRevealTimer(t){this.modeStates.reveal.timer=t}setRevealStyle(t){this.modeStates.reveal.style=t,localStorage.setItem("revealStyle",t)}getRevealStyle(){return this.modeStates.reveal.style}shouldBlockNormalInteractions(){return this.isTemporalActive()||this.isRevealActive()}on(t,e){this.listeners[t]&&this.listeners[t].push(e)}off(t,e){if(this.listeners[t]){const i=this.listeners[t].indexOf(e);i>-1&&this.listeners[t].splice(i,1)}}notifyListeners(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}reset(){this.modeStates.temporal.active=!1,this.modeStates.temporal.phase=null,this.setRevealActive(!1)}forceTemporalCleanup(){console.log("[ModeStateManager] Force temporal cleanup"),this.modeStates.temporal.active=!1,this.modeStates.temporal.phase=null,this.notifyListeners("stateChange",{mode:"temporal",state:this.modeStates.temporal})}}class ld{constructor(t=25){this.queue=[],this.running=new Set,this.maxConcurrent=t}add(t,e){this.queue.push({element:t,animationCallback:e}),this.process()}async process(){for(;this.running.size<this.maxConcurrent&&this.queue.length>0;){const{element:t,animationCallback:e}=this.queue.shift(),i=t.getAttribute("data-hotspot-id");this.running.add(i),e().then(()=>{this.running.delete(i),this.process()}).catch(()=>{this.running.delete(i),this.process()})}}clear(){this.queue=[],this.running.clear()}clearFinished(){this.running.forEach(t=>{const e=document.querySelector(`[data-hotspot-id="${t}"]`);if(e){const i=e.getElementsByTagName("path");for(let n of i)n.currentAnimation&&n.currentAnimation.playState==="finished"&&(n.currentAnimation=null,this.running.delete(t))}})}}const ri=class ri{constructor(t={}){this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Object.assign(this,{viewer:t.viewer,spatialIndex:t.spatialIndex,onHotspotHover:t.onHotspotHover||(()=>{}),onHotspotClick:t.onHotspotClick||(()=>{}),visibilityCheckInterval:t.visibilityCheckInterval||100,batchSize:t.batchSize||50,renderDebounceTime:t.renderDebounceTime||16,debugMode:t.debugMode||!1}),this.lastViewportBounds=null,this.lastViewportZoom=null,this.significantChangeThreshold=.1,this.overlays=new Map,this.visibleOverlays=new Set,this.hoveredHotspot=null,this.selectedHotspot=null,this.animationQueue=new ld(this.isMobile?ri.MAX_CONCURRENT_ANIMATIONS_MOBILE:ri.MAX_CONCURRENT_ANIMATIONS),this.modeStateManager=new ad,this.modeStateManager.on("modeChange",e=>{console.log(`Mode changed from ${e.from} to ${e.to}`)}),this.temporalHandler=new od({audioEngine:window.audioEngine,modeStateManager:this.modeStateManager,onPhaseChange:(e,i)=>this.handleTemporalPhaseChange(e,i)}),this.colorPalettes={tech:{shadow:"rgba(0, 0, 0, 0.3)",glow:"#00ffff",contrast:"rgba(0, 0, 0, 1)",main:"#ffffff"},enchantedJournal:{shadow:"rgba(47, 79, 79, 0.4)",glow:"#FFD700",glow2:"#DDA0DD",contrast:"rgba(160, 82, 45, 0.8)",main:"#A0522D"},moonlitManuscript:{shadow:"rgba(47, 79, 79, 0.5)",glow:"#87CEEB",glow2:"#4682B4",contrast:"rgba(70, 130, 180, 0.9)",main:"#4682B4"},pureWhiteHigh:{shadow:"rgba(0, 0, 0, 0.4)",glow:"rgba(255, 255, 255, 0.9)",glow2:"rgba(255, 255, 255, 0.7)",contrast:"rgba(255, 255, 255, 1)",main:"#FFFFFF"},pureWhiteBalanced:{shadow:"rgba(0, 0, 0, 0.3)",glow:"rgba(255, 255, 255, 0.8)",glow2:"rgba(255, 255, 255, 0.6)",contrast:"rgba(255, 255, 255, 0.3)",main:"#FFFFFF"},blackOnBlack:{shadow:"rgba(255, 255, 255, 0.1)",glow:"rgba(0, 0, 0, 0.8)",glow2:"rgba(0, 0, 0, 0.6)",contrast:"rgba(255, 255, 255, 0.1)",main:"#000000"}},this.timingEasing="cubic-bezier(0.36, 0.45, 0.63, 0.53)",this.currentPalette="blackOnBlack",this.colorScheme=this.colorPalettes[this.currentPalette],window.hotspotColorScheme=this.colorScheme,window.hotspotPalettes=this.colorPalettes,window.setHotspotPalette=e=>{this.colorPalettes[e]&&(this.currentPalette=e,this.colorScheme=this.colorPalettes[e],window.hotspotColorScheme=this.colorScheme,this.refreshAllHotspotStyles())},window.hotspotColorScheme=this.colorScheme,this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null,this.clickTimeThreshold=300,this.clickDistThreshold=this.isMobile?12:8,this.hotspotAreas=new Map,this.activePointers=new Map,this.primaryPointerId=null,this.lastPointerDownTime=0,this.lastPointerDownPoint=null,this.isPinching=!1,this.isAnimationInProgress=!1,this.pendingVisibilityUpdate=!1,this.animationIndex=0,this.performanceMode=!1,this.animationRegistry=new Set,this.revealMode={active:!1,timer:null,duration:6e3,animations:new Map},this.lastZoom=0,this.initStyles(),this.init()}handleTemporalPhaseChange(t,e){if(!this.temporalHandler.state.isHolding){console.log("[TEMPORAL_DEBUG] Ignoring phase change - not holding");return}console.log(`Temporal phase: ${t} for hotspot ${e==null?void 0:e.id}`),t!==null&&this.modeStateManager.setTemporalState(!0,t);const i=this.overlays.get(e.id);if(!i)return;const n=i.element;if(n.style.opacity="1",n.style.visibility="visible",n.classList.remove("hotspot-temporal-touchDown","hotspot-temporal-explore","hotspot-temporal-preview","hotspot-temporal-activate"),t==="initial"){n.style.opacity="1",n.style.visibility="visible";const r=n.querySelector(".main-path");r&&(r.style.stroke="rgba(255, 255, 255, 0.5)",r.style.strokeWidth="1.5px",r.style.opacity="1",r.style.transition="all 150ms ease-out");return}t==="touchDown"?n.classList.add("hotspot-temporal-touchDown"):t==="explore"?n.classList.add("hotspot-temporal-explore"):t==="preview"?(n.classList.add("hotspot-temporal-preview"),this.selectedHotspot=e,this.onHotspotHover(e)):t==="activate"&&n.classList.add("hotspot-temporal-activate")}normalizePath(t,e){const i=e?t[0]:t;let n="";return i.forEach(([r,o],a)=>{a===0?n+=`M ${Math.round(r)} ${Math.round(o)} `:n+=`L ${Math.round(r)} ${Math.round(o)} `}),n+="Z",n}initStyles(){}optimizeSafariLayers(){if(!this.isSafari)return;let t=1e-4;this.overlays.forEach(e=>{e.element.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(n=>{n.style.transform=`translateZ(${t}px)`,t+=1e-4})})}async init(){if(!this.viewer.world.getItemCount()){this.viewer.addOnceHandler("open",()=>this.init());return}if(!document.getElementById("hotspot-animations-fix")){const r=document.createElement("style");r.id="hotspot-animations-fix",r.textContent=`
        .hotspot-hover path,
        .hotspot-selected path {
            animation-play-state: running !important;
        }
    `,document.head.appendChild(r)}const e=this.viewer.world.getItemAt(0).getContentSize();this.svg=this.createSVG(e);const i=localStorage.getItem("revealStyle")||"invert";this.svg.classList.add(`reveal-style-${i}`);const n=document.createElement("style");n.textContent=`
        @keyframes revealWidth {
            from { width: 0%; }
            to { width: 110%; }
        }
    `,document.head.appendChild(n),this.viewer.addOverlay({element:this.svg,location:new nt.Rect(0,0,1,e.y/e.x),placement:nt.Placement.TOP_LEFT}),this.createMaskDefs(),this.pathDefs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.pathDefs.id="path-definitions",this.svg.insertBefore(this.pathDefs,this.svg.firstChild),this.createClipPathDefs(),this.createSVGFilters(),await this.loadHotspotsInBatches(),this.optimizeForSafari(),this.optimizeSafariLayers(),this.setupMouseTracking(),this.setupDragDetection(),this.setupRevealMode(),this.viewer.addHandler("zoom",()=>{this.currentZoom=this.viewer.viewport.getZoom();const r=this.lastZoom||0;if((r<=8&&this.currentZoom>8||r>8&&this.currentZoom<=8)&&(this.clearAnimationRegistryForZoomChange(),r>8&&this.currentZoom<=8&&this.overlays.forEach(o=>{this.resetStaticTransitions(o.element)})),this.lastZoom=this.currentZoom,this.hoveredHotspot){const o=this.overlays.get(this.hoveredHotspot.id);o&&this.applyStyle(o.element,this.hoveredHotspot.type,"hover")}if(this.selectedHotspot&&this.selectedHotspot!==this.hoveredHotspot){const o=this.overlays.get(this.selectedHotspot.id);o&&this.applyStyle(o.element,this.selectedHotspot.type,"selected")}}),this.startVisibilityTracking(),this.cleanupInterval=setInterval(()=>{this.animationQueue&&this.animationQueue.clearFinished(),this.overlays.forEach(r=>{const o=r.element.getElementsByTagName("path");for(let a of o)a.currentAnimation&&a.currentAnimation.playState==="finished"&&(a.currentAnimation=null)})},5e3),window.nativeHotspotRenderer=this}createSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
               width="${t.x}" height="${t.y}" 
               viewBox="0 0 ${t.x} ${t.y}"
               style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
        </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}async loadHotspotsInBatches(){const t=this.spatialIndex.getAllHotspots(),e=Math.ceil(t.length/this.batchSize);for(let i=0;i<e;i++)t.slice(i*this.batchSize,(i+1)*this.batchSize).forEach(r=>this.createHotspotOverlay(r)),i<e-1&&await new Promise(r=>setTimeout(r,0));console.log(`Loaded ${t.length} hotspots in ${e} batches`)}createGroup(t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return Object.assign(e.style,{cursor:"pointer",pointerEvents:"fill",opacity:this.debugMode?"1":"0",transition:"opacity 0.2s ease-out","-webkit-tap-highlight-color":"transparent",transform:"translateZ(0)","-webkit-transform":"translateZ(0)","will-change":"transform, opacity"}),e.setAttribute("data-hotspot-id",t.id),this.currentPalette.includes("pureWhite")&&(e.style.mixBlendMode="screen"),e}createHotspotWrapper(t){const e=document.createElement("div");return e.className="hotspot-wrapper",e.setAttribute("data-hotspot-wrapper-id",t),this.isSafari&&(e.style.position="absolute",e.style.transform="translateZ(0)",e.style.webkitTransform="translateZ(0)",e.style.willChange="filter",e.style.contain="layout style paint",this.isMobile?e.classList.add("hotspot-wrapper-ios"):e.classList.add("hotspot-wrapper-desktop")),e}createHotspotOverlay(t){const e=this.createGroup(t),i=t.shape==="multipolygon",n=this.normalizePath(t.coordinates,i);if(this.isSafari){const h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("d",n),h.setAttribute("fill","none"),h.setAttribute("stroke",this.colorScheme.glow2||this.colorScheme.glow),h.setAttribute("stroke-width","12"),h.setAttribute("opacity","0"),h.setAttribute("vector-effect","non-scaling-stroke"),h.style.pointerEvents="none",h.classList.add("glow-layer-3"),e.appendChild(h);const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d",n),d.setAttribute("fill","none"),d.setAttribute("stroke",this.colorScheme.glow),d.setAttribute("stroke-width","8"),d.setAttribute("opacity","0"),d.setAttribute("vector-effect","non-scaling-stroke"),d.style.pointerEvents="none",d.classList.add("glow-layer-2"),e.appendChild(d);const l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d",n),l.setAttribute("fill","none"),l.setAttribute("stroke",this.colorScheme.main),l.setAttribute("stroke-width","5"),l.setAttribute("opacity","0"),l.setAttribute("vector-effect","non-scaling-stroke"),l.style.pointerEvents="none",l.classList.add("glow-layer-1"),e.appendChild(l)}const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",n),r.setAttribute("fill","none"),r.setAttribute("stroke","transparent"),r.setAttribute("vector-effect","non-scaling-stroke"),r.style.pointerEvents="fill",r.classList.add("main-path"),e.appendChild(r);const o=r.getTotalLength();if(e.removeChild(r),r.setAttribute("data-real-length",o),this.isSafari){const h=e.querySelector(".glow-layer-1"),d=e.querySelector(".glow-layer-2"),l=e.querySelector(".glow-layer-3");[h,d,l].forEach(p=>{p&&p.setAttribute("data-real-length",o)})}if(i&&t.coordinates.length>1){const h=`mask-${t.id}-${this.maskCounter++}`,d=document.createElementNS("http://www.w3.org/2000/svg","mask");d.setAttribute("id",h);const l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x","0"),l.setAttribute("y","0"),l.setAttribute("width","100%"),l.setAttribute("height","100%"),l.setAttribute("fill","white"),d.appendChild(l),t.coordinates.forEach((p,f)=>{if(f>0){const m=document.createElementNS("http://www.w3.org/2000/svg","path"),v=p.reduce((w,[b,I],O)=>w+(O===0?"M":"L")+`${Math.round(b)},${Math.round(I)}`,"")+"Z";m.setAttribute("d",v),m.setAttribute("fill","black"),m.setAttribute("stroke","black"),m.setAttribute("stroke-width","10"),d.appendChild(m)}}),this.defs.appendChild(d),r.setAttribute("mask",`url(#${h})`)}this.applyStyle(e,t.type,"normal"),e.appendChild(r),this.svg.appendChild(e);const a=this.calculateBounds(t.coordinates),c=this.calculateArea(a);this.overlays.set(t.id,{element:e,hotspot:t,bounds:a,area:c,isVisible:!1}),this.hotspotAreas.set(t.id,c)}setupDragDetection(){this.viewer.addHandler("canvas-drag",()=>{this.isDragging=!0}),this.viewer.addHandler("canvas-drag-end",()=>{this.isDragging=!1})}setupMouseTracking(){this.svg.style.pointerEvents="auto",(this.isMobile||this.isSafari)&&this.svg.addEventListener("click",e=>{if(console.log("SVG click handler for iOS/Safari",{target:e.target.tagName,isMobile:this.isMobile}),e.target.tagName==="path"||e.target.tagName==="g"||e.target.closest("g[data-hotspot-id]"))return;const i=this.viewer.element.getBoundingClientRect(),n=new nt.Point(e.clientX-i.left,e.clientY-i.top),r=this.viewer.viewport.pointFromPixel(n),o=this.viewer.viewport.viewportToImageCoordinates(r),a=this.findSmallestHotspotAtPoint(o);a&&(console.log("iOS/Safari: Found hotspot at SVG click position:",a.id),e.stopPropagation(),e.preventDefault(),this.activateHotspot(a))},!0);const t=this.viewer.container;t.addEventListener("pointerdown",this.handlePointerDown.bind(this)),t.addEventListener("pointermove",this.handlePointerMove.bind(this)),t.addEventListener("pointerup",this.handlePointerUp.bind(this)),t.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.svg.addEventListener("mousemove",e=>{if(this.modeStateManager.getCurrentMode()==="temporal"){this.svg.style.cursor="default";return}const i=this.viewer.element.getBoundingClientRect(),n=new nt.Point(e.clientX-i.left,e.clientY-i.top),r=this.viewer.viewport.pointFromPixel(n),o=this.viewer.viewport.viewportToImageCoordinates(r),a=this.findSmallestHotspotAtPoint(o);if(a!==this.hoveredHotspot){if(console.log("HOVER CHANGE DETECTED!",a==null?void 0:a.id),this.hoveredHotspot){const c=this.overlays.get(this.hoveredHotspot.id);c&&(console.log("Applying normal style to previous"),this.applyStyle(c.element,this.hoveredHotspot.type,this.hoveredHotspot===this.selectedHotspot?"selected":"normal"))}if(this.hoveredHotspot=a,this.onHotspotHover(a),a){const c=this.overlays.get(a.id);c&&(console.log("Applying hover style to new hotspot"),this.applyStyle(c.element,a.type,"hover"))}}this.svg.style.cursor=a?"pointer":"default"}),this.isMobile&&this.svg.addEventListener("touchmove",e=>{if(e.preventDefault(),this.modeStateManager.getCurrentMode()==="temporal")return;const i=e.touches[0],n=this.viewer.element.getBoundingClientRect(),r=new nt.Point(i.clientX-n.left,i.clientY-n.top),o=this.viewer.viewport.pointFromPixel(r),a=this.viewer.viewport.viewportToImageCoordinates(o),c=this.findSmallestHotspotAtPoint(a);if(c!==this.hoveredHotspot){if(console.log("Touch hover change detected:",c==null?void 0:c.id),this.hoveredHotspot){const h=this.overlays.get(this.hoveredHotspot.id);h&&this.applyStyle(h.element,this.hoveredHotspot.type,this.hoveredHotspot===this.selectedHotspot?"selected":"normal")}if(this.hoveredHotspot=c,this.onHotspotHover(c),c){const h=this.overlays.get(c.id);h&&this.applyStyle(h.element,c.type,"hover")}}},{passive:!1})}handlePointerDown(t){this.updatesPaused&&(console.warn("Updates were paused during interaction - forcing resume"),this.resumeUpdates()),console.log("handlePointerDown",{pointerId:t.pointerId,activePointersBefore:this.activePointers.size,currentMode:this.modeStateManager.getCurrentMode()}),this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Date.now()}),this.isMobile&&t.preventDefault(),this.activePointers.size===1&&(this.primaryPointerId=t.pointerId,this.lastPointerDownTime=Date.now(),this.lastPointerDownPoint={x:t.clientX,y:t.clientY},this.modeStateManager.getCurrentMode()==="temporal"&&(this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null,setTimeout(()=>{const e=this.viewer.element.getBoundingClientRect(),i=new nt.Point(t.clientX-e.left,t.clientY-e.top),n=this.viewer.viewport.pointFromPixel(i),r=this.viewer.viewport.viewportToImageCoordinates(n),o=this.findSmallestHotspotAtPoint(r);o&&this.modeStateManager.getCurrentMode()==="temporal"&&this.temporalHandler.startHold(o,t.clientX,t.clientY)},0)))}handlePointerMove(t){if(this.activePointers.has(t.pointerId)){const e=this.activePointers.get(t.pointerId);if(e.x=t.clientX,e.y=t.clientY,this.activePointers.size>=2&&(this.isPinching=!0),this.modeStateManager.getCurrentMode()==="temporal"&&this.temporalHandler.state.isHolding&&t.pointerId===this.primaryPointerId){const i=this.temporalHandler.getCurrentProgress();this.temporalHandler.updateProgress(t.clientX,t.clientY,i)}}}handlePointerUp(t){if(console.log("handlePointerUp start",{pointerId:t.pointerId,hasPointer:this.activePointers.has(t.pointerId),activePointers:this.activePointers.size,currentMode:this.modeStateManager.getCurrentMode()}),!this.activePointers.has(t.pointerId))return;const e=this.activePointers.get(t.pointerId),i=Date.now()-e.startTime,n=Math.sqrt(Math.pow(t.clientX-e.startX,2)+Math.pow(t.clientY-e.startY,2));if(t.pointerId===this.primaryPointerId&&this.activePointers.size===1&&!this.isPinching&&!this.isDragging&&n<this.clickDistThreshold)if(this.modeStateManager.getCurrentMode()==="temporal"){const o=this.temporalHandler.endHold();o.hotspot&&this.handleTemporalRelease(o.duration,o.hotspot)}else i<this.clickTimeThreshold&&(console.log("Direct mode click detected"),this.handleClick(t),this.forceIOSRedraw());else this.modeStateManager.getCurrentMode()==="temporal"&&(this.temporalHandler.endHold(),this.cleanupTemporalVisuals());this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1,this.modeStateManager.setTemporalState(!1),this.temporalHandler.reset())}handleTemporalRelease(t,e){const i=this.temporalHandler.thresholds;console.log("Temporal mode release:",{duration:t,thresholds:i,hotspotId:e.id}),this.cleanupTemporalVisuals(),this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null,t<i.explore?console.log("Temporal: Exploration phase completed"):t>=i.explore&&t<i.activate?console.log("Temporal: Preview/Selection phase completed"):(console.log("Temporal: Activation phase completed"),this.activateHotspot(e)),setTimeout(()=>{this.modeStateManager.setTemporalState(!1,null),console.log("[TEMPORAL_FIX] Final temporal state cleanup")},150)}cleanupTemporalVisuals(){this.overlays.forEach(t=>{t.element.classList.remove("hotspot-temporal-touchDown","hotspot-temporal-explore","hotspot-temporal-preview","hotspot-temporal-activate"),t.element.style.opacity=t.isVisible?"1":"0"}),this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null}handlePointerCancel(t){this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handleClick(t){var a;if(console.log("handleClick called",{isDragging:this.isDragging,isPinching:this.isPinching,activePointers:this.activePointers.size,targetTag:t.target.tagName,targetClass:((a=t.target.className)==null?void 0:a.baseVal)||t.target.className,timestamp:Date.now()}),t.target.closest(".openseadragon-controls"))return;if(this.isMobile&&this.hoveredHotspot){console.log("Using cached hover hotspot for mobile click"),t.stopPropagation(),t.preventDefault(),this.activateHotspot(this.hoveredHotspot);return}const e=this.viewer.element.getBoundingClientRect(),i=new nt.Point(t.clientX-e.left,t.clientY-e.top),n=this.viewer.viewport.pointFromPixel(i),r=this.viewer.viewport.viewportToImageCoordinates(n),o=this.findSmallestHotspotAtPoint(r);o?(t.stopPropagation(),t.preventDefault(),this.activateHotspot(o)):this.selectedHotspot&&(this.deselectHotspot(),this.onHotspotClick&&this.onHotspotClick(null))}activateHotspot(t){console.log("🎯 iOS DEBUG: activateHotspot called:",{hotspotId:t.id,timestamp:Date.now(),isSafari:this.isSafari,isMobile:this.isMobile}),this.selectedHotspot=t,this.selectionTimestamp=Date.now(),this.onHotspotClick(t),this.overlays.forEach((e,i)=>{var r;const n=i===t.id?"selected":i===((r=this.hoveredHotspot)==null?void 0:r.id)?"hover":"normal";i===t.id&&console.log("🎯 iOS DEBUG: Applying selected style to:",i),this.applyStyle(e.element,e.hotspot.type,n)})}deselectHotspot(){console.log("Deselecting hotspot"),this.selectedHotspot=null,this.selectionTimestamp=null,this.overlays.forEach((t,e)=>{var n;const i=e===((n=this.hoveredHotspot)==null?void 0:n.id)?"hover":"normal";this.applyStyle(t.element,t.hotspot.type,i)})}instantDeselect(){var t;if(console.log("Instant deselecting hotspot"),this.selectedHotspot){const e=this.overlays.get(this.selectedHotspot.id);if(e&&e.element){const i=e.element.getElementsByTagName("path");for(let n of i)n.style.filter="none",n.style.stroke="rgba(255, 255, 255, 0)",n.style.strokeWidth="0",n.style.opacity="0",n.style.transition="none",n.style.animation="none";e.element.style.opacity="0",e.element.style.transition="none",e.element.style.animation="none",e.element.style.filter="none"}((t=this.hoveredHotspot)==null?void 0:t.id)===this.selectedHotspot.id&&(this.hoveredHotspot=null)}this.selectedHotspot=null,this.selectionTimestamp=null}findSmallestHotspotAtPoint(t){const e=[];return this.overlays.forEach((i,n)=>{i.isVisible&&this.isPointInHotspot(t,i)&&e.push({hotspot:i.hotspot,area:i.area})}),e.length===0?null:(e.sort((i,n)=>i.area-n.area),e[0].hotspot)}isPointInHotspot(t,e){const i=e.hotspot,n=e.bounds;return t.x<n.minX||t.x>n.maxX||t.y<n.minY||t.y>n.maxY?!1:i.shape==="polygon"?this.pointInPolygon(t.x,t.y,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(r=>this.pointInPolygon(t.x,t.y,r)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}applyStyle(t,e,i){if(this.revealMode.active&&i!=="normal")return;t.getElementsByTagName("path");const n=t.querySelector(".main-path"),r=t.getAttribute("data-hotspot-id"),o=`${r}-${i}`,a=this.animationRegistry||(this.animationRegistry=new Set),c=a.has(o),h=this.viewer.viewport.getZoom(),d=h>8,p=t.getAttribute("data-current-state")!==i,f=this.modeStateManager.getCurrentMode()==="temporal",m=this.modeStateManager.isTemporalActive(),v=f;if((r==="hotspot_audio_only_261"||r==="hotspot_audio_only_248")&&console.log("[TEMPORAL_DEBUG] applyStyle check:",{hotspotId:r,state:i,isTemporalMode:f,isTemporalActive:m,blocked:f&&m&&(i==="hover"||i==="selected")}),f&&m&&(i==="hover"||i==="selected")&&(t.classList.contains("hotspot-temporal-touchDown")||t.classList.contains("hotspot-temporal-explore")||t.classList.contains("hotspot-temporal-preview")||t.classList.contains("hotspot-temporal-activate"))){console.log("[TEMPORAL_DEBUG] Blocking animation due to temporal state:",{hotspotId:r,state:i,isTemporalActive:m});return}const w=i!=="normal"&&p,b=t.getAttribute("data-last-zoom")||"0",I=parseFloat(b)>8&&h<=8;if(t.setAttribute("data-last-zoom",h.toString()),this.animationRegistry&&(I||p)&&this.animationRegistry.delete(o),!(!p&&c&&!I&&!w)){if((i==="hover"||i==="selected")&&d&&!f){console.log("Smart static mode at zoom:",h.toFixed(2)),t.setAttribute("class",`hotspot-${e} hotspot-${i}`),t.setAttribute("data-current-state",i),t.setAttribute("data-animation-active","false"),n&&(n.style.transition="all 0.15s ease-out",n.style.fill="none",n.style.stroke=this.colorScheme.main,n.style.strokeWidth=i==="selected"?"2.5px":"2px",n.style.opacity=i==="selected"?"0.85":"0.7",n.style.strokeDasharray="none",n.style.strokeDashoffset="0",this.isSafari||(n.style.filter=`drop-shadow(0 0 3px ${this.colorScheme.glow})`)),this.isSafari&&t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach((N,q)=>{N.style.transition="opacity 0.15s ease-out",N.style.strokeDasharray="none",N.style.strokeDashoffset="0";const ie=i==="selected"?["0.5","0.3","0.2"]:["0.4","0.2","0.1"];N.style.opacity=ie[q]||"0"}),t.style.opacity="1";return}if(!(!p&&c&&!I&&!w)&&!((i==="hover"||i==="selected")&&t.getAttribute("data-animation-active")==="true")){if(t.setAttribute("class",`hotspot-${e} hotspot-${i}`),t.setAttribute("data-current-state",i),i==="hover"||i==="selected"){if(this.isSafari){const O=t.querySelector(".glow-layer-1"),N=t.querySelector(".glow-layer-2"),q=t.querySelector(".glow-layer-3"),ie=t.getAttribute("data-hotspot-id"),k=this.getAnimationDuration(ie);[{element:n,delay:0,opacity:"1"},{element:O,delay:0,opacity:i==="selected"?"0.7":"0.6"},{element:N,delay:0,opacity:i==="selected"?"0.5":"0.4"},{element:q,delay:0,opacity:i==="selected"?"0.3":"0.2"}].forEach(({element:E,delay:D,opacity:L})=>{if(E){if(E.animate&&!v){const F=E.getTotalLength?E.getTotalLength():parseFloat(E.getAttribute("data-real-length"))||100,A=F*1.2;E.style.strokeDasharray=`${F} ${F}`,E.style.strokeDashoffset=`${A}px`,E.style.opacity="0",E.style.transition="none",E.style.animation="none",E.style.display="none",E.offsetHeight,E.style.display="",E.offsetHeight,E.style.vectorEffect="non-scaling-stroke",E.style.paintOrder="stroke",E.style.transform=`translateZ(${D*.001}px)`,E.style.willChange="stroke-dashoffset, opacity";const V=E.animate([{strokeDashoffset:`${A}px`,opacity:"0",offset:0},{strokeDashoffset:`${F}px`,opacity:L*.3,offset:.1},{strokeDashoffset:"0px",opacity:L,offset:1}],{duration:k*1e3,delay:D,easing:this.timingEasing,fill:"forwards"});t.setAttribute("data-animation-active","true"),a.add(o),E.currentAnimation=V}else E.style.strokeDasharray="none",E.style.strokeDashoffset="0",E.style.opacity=L,E.style.transition="none",E.style.animation="none";i==="selected"?(D===150&&(E.style.filter="blur(1px)"),D===100&&(E.style.filter="blur(2px)"),D===50&&(E.style.filter="blur(3px)")):(D===150&&(E.style.filter="none"),D===100&&(E.style.filter="blur(1px)"),D===50&&(E.style.filter="blur(2px)"))}})}if(n&&!this.isSafari){n.currentAnimation&&(n.currentAnimation.cancel(),n.currentAnimation=null),n.style.animation="none",n.style.strokeDasharray="",n.style.strokeDashoffset="",n.offsetWidth,n.style.fill="none",this.isSafari?(n.style.stroke=this.colorScheme.main,n.style.strokeWidth=i==="selected"?"2.5px":"2px",n.style.filter="none",n.style.opacity="1"):(this.colorScheme.glow2?n.style.filter=`
                    drop-shadow(0 0 4px ${this.colorScheme.shadow})
                    drop-shadow(0 0 3px ${this.colorScheme.glow})
                    drop-shadow(0 0 10px ${this.colorScheme.glow2})
                    drop-shadow(0 0 20px ${this.colorScheme.glow2})
                `:n.style.filter=`
                    drop-shadow(0 0 6px rgba(0, 0, 0, 0.8))
                    drop-shadow(0 0 3px ${this.colorScheme.glow})
                    drop-shadow(0 0 10px ${this.colorScheme.glow})
                `,n.style.stroke=this.colorScheme.main,n.style.strokeWidth=i==="selected"?"2.5px":"2px",n.style.opacity="1");const O=parseFloat(n.getAttribute("data-real-length"))||100;if(n.animate&&!v){n.style.strokeDasharray=O,n.style.strokeDashoffset=O;const N=t.getAttribute("data-hotspot-id");let q=this.getAnimationDuration(N);const k=this.viewer.viewport.getZoom()>2,S=()=>{const E=i==="selected"?"0.85":"0.7";return n.currentAnimation=n.animate([{strokeDashoffset:O,opacity:"0.3",offset:0},{strokeDashoffset:"0",opacity:E,offset:1}],{duration:q*1e3,easing:this.timingEasing,fill:"forwards"}),n.currentAnimation.onfinish=()=>{n.currentAnimation=null},n.currentAnimation.finished};k?this.animationQueue.add(t,S):S(),t.setAttribute("data-animation-active","true"),a.add(o)}else n.style.strokeDasharray="none",n.style.strokeDashoffset="0",n.style.opacity=i==="selected"?"0.85":"0.7"}}else{if(this.animationRegistry){const O=t.getAttribute("data-hotspot-id");this.animationRegistry.delete(`${O}-hover`),this.animationRegistry.delete(`${O}-selected`)}t.setAttribute("data-animation-active","false"),this.isSafari&&t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(N=>{N.style.animation="none",N.currentAnimation&&(N.currentAnimation.cancel(),N.currentAnimation=null),N.offsetWidth;const q=parseFloat(N.getAttribute("data-real-length"))||100;N.style.strokeDasharray=`${q} ${q}`,N.style.strokeDashoffset=q,N.style.transition="opacity 0.2s ease-out",N.style.opacity="0",N.style.filter="none"}),n&&(n.currentAnimation&&(n.currentAnimation.cancel(),n.currentAnimation=null),n.getAnimations().forEach(O=>O.cancel()),n.style.animation="none",n.style.strokeDasharray="",n.style.strokeDashoffset="",n.offsetWidth,n.style.transition="opacity 0.2s ease-out",n.style.fill="none",n.style.stroke="transparent",n.style.strokeWidth="0",n.style.filter="none",n.style.opacity="0")}t.style.opacity=i==="hover"||i==="selected"?"1":"0"}}}resetStaticTransitions(t){const e=t.getElementsByTagName("path");for(let i of e)i.style.transition="none",i.offsetWidth}clearAnimationRegistryForZoomChange(){if(this.animationRegistry){const t=new Set;this.hoveredHotspot&&t.add(`${this.hoveredHotspot.id}-hover`),this.selectedHotspot&&t.add(`${this.selectedHotspot.id}-selected`);const e=[];this.animationRegistry.forEach((i,n)=>{t.has(n)||e.push(n)}),e.forEach(i=>this.animationRegistry.delete(i))}}refreshAllHotspotStyles(){console.log("Refreshing all hotspot styles with palette:",this.currentPalette),this.overlays.forEach((t,e)=>{var i,n;if(t.isVisible){const r=e===((i=this.selectedHotspot)==null?void 0:i.id)?"selected":e===((n=this.hoveredHotspot)==null?void 0:n.id)?"hover":"normal";r!=="normal"&&(this.applyStyle(t.element,t.hotspot.type,"normal"),setTimeout(()=>{this.applyStyle(t.element,t.hotspot.type,r)},50))}}),this.updateFilterColors(),this.updateWrapperStyles()}updateWrapperStyles(){this.isSafari}updateFilterColors(){const t=this.svg.querySelector('#hotspot-glow-selected feFlood[result="innerColor"]'),e=this.svg.querySelector('#hotspot-glow-selected feFlood[result="outerColor"]'),i=this.svg.querySelector('#hotspot-glow-selected feFlood[result="midColor"]'),n=this.svg.querySelector('#hotspot-glow-hover feFlood[result="innerColor"]'),r=this.svg.querySelector('#hotspot-glow-hover feFlood[result="outerColor"]');t&&t.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),e&&e.setAttribute("flood-color",this.colorScheme.glow2||"#4682B4"),i&&i.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),n&&n.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),r&&r.setAttribute("flood-color",this.colorScheme.main||"#4682B4")}calculateBounds(t){let e={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};const i=n=>{n.forEach(([r,o])=>{e.minX=Math.min(e.minX,r),e.minY=Math.min(e.minY,o),e.maxX=Math.max(e.maxX,r),e.maxY=Math.max(e.maxY,o)})};return Array.isArray(t[0])&&typeof t[0][0]=="number"?i(t):t.forEach(i),e}getHotspotBounds(t){const e=this.overlays.get(t.id);return e&&e.bounds?e.bounds:this.calculateBounds(t.coordinates)}calculateArea(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}getAnimationDuration(t){var p,f;const e=this.isMobile?.9:1.2,i=((f=(p=this.viewer)==null?void 0:p.viewport)==null?void 0:f.getZoom())||1,n=1,r=5,o=3,a=1,h=(Math.max(n,Math.min(r,i))-n)/(r-n),d=o-h*(o-a);return e*d}calculateGlowIntensity(){return 1}optimizeForSafari(){/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&this.overlays.forEach(e=>{const i=e.element.getElementsByTagName("path");for(let n of i)n.style.transform="translateZ(0)",n.style.webkitBackfaceVisibility="hidden"})}createSimpleSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
           width="${t.x}" height="${t.y}" 
           viewBox="0 0 ${t.x} ${t.y}"
           style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
    </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}startVisibilityTracking(){let t=null,e=0;this.isMobile;const i=()=>{if(t&&clearTimeout(t),this.isAnimationInProgress||this.viewer.isAnimating()){this.pendingVisibilityUpdate=!0;return}const r=Date.now()-e,o=this.viewer.viewport.getZoom()<5?100:50;if(r<o){t=setTimeout(()=>{i()},o-r);return}t=setTimeout(()=>{e=Date.now(),this.updateVisibility()},this.renderDebounceTime)};this.viewer.addHandler("animation",i),this.viewer.addHandler("animation-finish",()=>{!this.updatesPaused&&!this.isAnimationInProgress&&this.updateVisibility()}),this.isMobile||this.viewer.addHandler("viewport-change",i),this.updateVisibility()}updateVisibility(){var f,m;if(this.updatesPaused||this.isAnimationInProgress){console.log("updateVisibility BLOCKED - animation in progress"),this.pendingVisibilityUpdate=!0;return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.zoomSpring.target.value;if(Math.abs(t-e)>.001){console.log("updateVisibility SKIPPED - viewer is zooming"),this.pendingVisibilityUpdate=!0;return}if(this.viewer.isAnimating()){console.log("updateVisibility SKIPPED - viewer is animating"),this.pendingVisibilityUpdate=!0;return}const n=this.viewer.viewport.getBounds();if(this.lastViewportBounds&&this.lastViewportZoom){const v=Math.abs(n.x-this.lastViewportBounds.x)>this.significantChangeThreshold||Math.abs(n.y-this.lastViewportBounds.y)>this.significantChangeThreshold||Math.abs(n.width-this.lastViewportBounds.width)>this.significantChangeThreshold||Math.abs(n.height-this.lastViewportBounds.height)>this.significantChangeThreshold,w=Math.abs(t-this.lastViewportZoom)>.1;if(!v&&!w)return}this.lastViewportBounds=n,this.lastViewportZoom=t;const r=this.viewer.viewport;if(r.getZoom()<1.5){const v=(f=this.selectedHotspot)==null?void 0:f.id,w=(m=this.hoveredHotspot)==null?void 0:m.id;requestAnimationFrame(()=>{this.overlays.forEach(b=>{const I=b.hotspot.id===v||b.hotspot.id===w;b.element.style.opacity=I?"1":"0",b.isVisible=!0})});return}const a=r.viewportToImageCoordinates(n.getTopLeft()),c=r.viewportToImageCoordinates(n.getBottomRight()),h={minX:a.x,minY:a.y,maxX:c.x,maxY:c.y},d=(h.maxX-h.minX)*.2;h.minX-=d,h.minY-=d,h.maxX+=d,h.maxY+=d;const l=[];let p=0;this.overlays.forEach((v,w)=>{v.bounds.maxX<h.minX||v.bounds.minX>h.maxX||v.bounds.maxY<h.minY||v.bounds.minY>h.maxY?v.isVisible&&(l.push({element:v.element,opacity:"0"}),v.isVisible=!1,this.visibleOverlays.delete(w)):(p++,v.isVisible||(l.push({element:v.element,opacity:"1"}),v.isVisible=!0,this.visibleOverlays.add(w)))}),this.revealMode.active&&this.overlays.forEach(v=>{v.isVisible&&!this.revealMode.animations.has(v.hotspot.id)?this.startBreathingAnimation(v):!v.isVisible&&this.revealMode.animations.has(v.hotspot.id)&&this.stopBreathingAnimation(v)}),l.length>0&&requestAnimationFrame(()=>{l.forEach(v=>{v.element.style.opacity=v.opacity})}),Math.abs(t-this.lastViewportZoom)>.5&&requestAnimationFrame(()=>{this.viewer.world.getItemCount()>0&&this.viewer.updateOverlay(this.svg)}),p>100&&console.log(`Performance note: ${p} hotspots visible`),p>ri.HIGH_HOTSPOT_COUNT_THRESHOLD&&this.animationQueue&&(this.animationQueue.clearFinished(),this.animationQueue.running.size>ri.MAX_CONCURRENT_ANIMATIONS&&(this.animationQueue.clear(),console.log("Animation queue cleared due to high hotspot count"))),this.checkPerformanceMode()}forceIOSRedraw(){this.isMobile&&this.viewer&&this.svg&&(this.svg.style.display="none",this.svg.offsetHeight,this.svg.style.display="",this.viewer.updateOverlay(this.svg))}checkPerformanceMode(){const t=this.visibleOverlays.size;t>ri.HIGH_HOTSPOT_COUNT_THRESHOLD&&!this.performanceMode?(this.performanceMode=!0,this.svg.classList.add("performance-mode"),console.log("Performance mode enabled - simplifying animations")):t<ri.HIGH_HOTSPOT_COUNT_THRESHOLD*.8&&this.performanceMode&&(this.performanceMode=!1,this.svg.classList.remove("performance-mode"))}updateVisibilityLazy(){if(this.updatesPaused){console.log("updateVisibilityLazy SKIPPED - updates are paused");return}console.log("updateVisibilityLazy starting - mobile optimized");const t=this.viewer.viewport;if(t.getZoom(),this.viewer.isAnimating()){console.log("updateVisibilityLazy deferred - still animating"),setTimeout(()=>this.updateVisibilityLazy(),100);return}const e=t.getBounds(),i=t.viewportToImageCoordinates(e.getTopLeft()),n=t.viewportToImageCoordinates(e.getBottomRight()),r={minX:i.x,minY:i.y,maxX:n.x,maxY:n.y},o=(r.maxX-r.minX)*.2;Object.keys(r).forEach(p=>{r[p]+=p.startsWith("min")?-o:o});const a=Array.from(this.overlays.entries());let c=0,h=0;const d=30,l=()=>{const p=performance.now();for(h=0;c<a.length&&h<d&&performance.now()-p<8;){const[f,m]=a[c],v=this.boundsIntersect(m.bounds,r);v!==m.isVisible&&(m.element.style.opacity=v?"1":"0",m.isVisible=v,v?this.visibleOverlays.add(f):this.visibleOverlays.delete(f)),c++,h++}c<a.length?"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:50}):requestAnimationFrame(l):this.viewer.world.getItemCount()>0&&requestAnimationFrame(()=>{this.viewer.updateOverlay(this.svg),console.log("updateVisibilityLazy complete")})};"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:100}):setTimeout(()=>requestAnimationFrame(l),50)}boundsIntersect(t,e){return!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)}createMaskDefs(){this.defs||(this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.svg.insertBefore(this.defs,this.svg.firstChild),this.maskCounter=0)}createClipPathDefs(){this.defs||this.createMaskDefs();const t=document.createElementNS("http://www.w3.org/2000/svg","defs");t.id="clip-path-defs",this.svg.insertBefore(t,this.svg.firstChild),this.clipDefs=t}createSVGFilters(){const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","filter");e.setAttribute("id","hotspot-glow-selected"),e.setAttribute("x","-100%"),e.setAttribute("y","-100%"),e.setAttribute("width","300%"),e.setAttribute("height","300%"),e.setAttribute("filterUnits","objectBoundingBox"),e.setAttribute("primitiveUnits","userSpaceOnUse"),e.setAttribute("color-interpolation-filters","sRGB");const i=document.createElementNS("http://www.w3.org/2000/svg","feMorphology");i.setAttribute("operator","dilate"),i.setAttribute("radius","2"),i.setAttribute("in","SourceAlpha"),i.setAttribute("result","expanded");const n=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");n.setAttribute("in","expanded"),n.setAttribute("stdDeviation","3"),n.setAttribute("result","blur1");const r=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");r.setAttribute("in","expanded"),r.setAttribute("stdDeviation","8"),r.setAttribute("result","blur2");const o=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");o.setAttribute("in","expanded"),o.setAttribute("stdDeviation","15"),o.setAttribute("result","blur3");const a=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");a.setAttribute("in","blur1"),a.setAttribute("result","glow1");const c=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");c.setAttribute("type","linear"),c.setAttribute("slope","0.8"),c.setAttribute("intercept","0"),a.appendChild(c);const h=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");h.setAttribute("in","blur2"),h.setAttribute("result","glow2");const d=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");d.setAttribute("type","linear"),d.setAttribute("slope","0.5"),d.setAttribute("intercept","0"),h.appendChild(d);const l=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");l.setAttribute("in","blur3"),l.setAttribute("result","glow3");const p=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");p.setAttribute("type","linear"),p.setAttribute("slope","0.3"),p.setAttribute("intercept","0"),l.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","feFlood");f.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),f.setAttribute("result","innerColor");const m=document.createElementNS("http://www.w3.org/2000/svg","feFlood");m.setAttribute("flood-color",this.colorScheme.glow2||"#4682B4"),m.setAttribute("result","outerColor");const v=document.createElementNS("http://www.w3.org/2000/svg","feComposite");v.setAttribute("in","innerColor"),v.setAttribute("in2","glow1"),v.setAttribute("operator","in"),v.setAttribute("result","innerGlow");const w=document.createElementNS("http://www.w3.org/2000/svg","feComposite");w.setAttribute("in","outerColor"),w.setAttribute("in2","glow3"),w.setAttribute("operator","in"),w.setAttribute("result","outerGlow");const b=document.createElementNS("http://www.w3.org/2000/svg","feFlood");b.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),b.setAttribute("result","midColor");const I=document.createElementNS("http://www.w3.org/2000/svg","feComposite");I.setAttribute("in","midColor"),I.setAttribute("in2","glow2"),I.setAttribute("operator","in"),I.setAttribute("result","midGlow");const O=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),N=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");N.setAttribute("in","outerGlow");const q=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");q.setAttribute("in","midGlow");const ie=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");ie.setAttribute("in","innerGlow");const k=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");k.setAttribute("in","SourceGraphic"),O.appendChild(N),O.appendChild(q),O.appendChild(ie),O.appendChild(k),e.appendChild(i),e.appendChild(n),e.appendChild(r),e.appendChild(o),e.appendChild(a),e.appendChild(h),e.appendChild(l),e.appendChild(f),e.appendChild(m),e.appendChild(v),e.appendChild(w),e.appendChild(b),e.appendChild(I),e.appendChild(O);const S=document.createElementNS("http://www.w3.org/2000/svg","filter");S.setAttribute("id","hotspot-glow-hover"),S.setAttribute("x","-80%"),S.setAttribute("y","-80%"),S.setAttribute("width","260%"),S.setAttribute("height","260%"),S.setAttribute("filterUnits","objectBoundingBox"),S.setAttribute("primitiveUnits","userSpaceOnUse"),S.setAttribute("color-interpolation-filters","sRGB");const E=document.createElementNS("http://www.w3.org/2000/svg","feMorphology");E.setAttribute("operator","dilate"),E.setAttribute("radius","1"),E.setAttribute("in","SourceAlpha"),E.setAttribute("result","expanded");const D=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");D.setAttribute("in","expanded"),D.setAttribute("stdDeviation","2"),D.setAttribute("result","blur1");const L=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");L.setAttribute("in","expanded"),L.setAttribute("stdDeviation","6"),L.setAttribute("result","blur2");const F=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");F.setAttribute("in","blur1"),F.setAttribute("result","glow1");const A=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");A.setAttribute("type","linear"),A.setAttribute("slope","0.6"),F.appendChild(A);const V=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");V.setAttribute("in","blur2"),V.setAttribute("result","glow2");const ne=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");ne.setAttribute("type","linear"),ne.setAttribute("slope","0.3"),V.appendChild(ne);const ce=document.createElementNS("http://www.w3.org/2000/svg","feFlood");ce.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),ce.setAttribute("result","innerColor");const G=document.createElementNS("http://www.w3.org/2000/svg","feFlood");G.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),G.setAttribute("result","outerColor");const J=document.createElementNS("http://www.w3.org/2000/svg","feComposite");J.setAttribute("in","innerColor"),J.setAttribute("in2","glow1"),J.setAttribute("operator","in"),J.setAttribute("result","innerGlow");const $=document.createElementNS("http://www.w3.org/2000/svg","feComposite");$.setAttribute("in","outerColor"),$.setAttribute("in2","glow2"),$.setAttribute("operator","in"),$.setAttribute("result","outerGlow");const oe=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),Oe=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");Oe.setAttribute("in","outerGlow");const we=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");we.setAttribute("in","innerGlow");const W=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");W.setAttribute("in","SourceGraphic"),oe.appendChild(Oe),oe.appendChild(we),oe.appendChild(W),S.appendChild(E),S.appendChild(D),S.appendChild(L),S.appendChild(F),S.appendChild(V),S.appendChild(ce),S.appendChild(G),S.appendChild(J),S.appendChild($),S.appendChild(oe),t.appendChild(e),t.appendChild(S),this.svg.insertBefore(t,this.svg.firstChild)}zoomToHotspot(t){const e=this.overlays.get(t.id);if(!e)return;const i=e.bounds,n=this.viewer.world.getItemAt(0).getContentSize(),r=new nt.Rect(i.minX/n.x,i.minY/n.y,(i.maxX-i.minX)/n.x,(i.maxY-i.minY)/n.y),o=e.area,a=n.x*n.y,c=o/a,h=c<.01?1:c<.05?.7:c<.1?.5:.3,d=r.width*h,l=r.height*h,p=new nt.Rect(r.x-d,r.y-l,r.width+d*2,r.height+l*2);this.viewer.viewport.fitBounds(p,!1)}getOverlapMetrics(){const t=[],e=Array.from(this.overlays.values());for(let i=0;i<e.length;i++)for(let n=i+1;n<e.length;n++)this.boundsIntersect(e[i].bounds,e[n].bounds)&&t.push({hotspot1:e[i].hotspot.id,hotspot2:e[n].hotspot.id,area1:e[i].area,area2:e[n].area});return{totalOverlaps:t.length,overlaps:t}}setDebugMode(t){this.debugMode=t,this.initStyles(),this.overlays.forEach((e,i)=>{var r,o;const n=i===((r=this.selectedHotspot)==null?void 0:r.id)?"selected":i===((o=this.hoveredHotspot)==null?void 0:o.id)?"hover":"normal";this.applyStyle(e.element,e.hotspot.type,n)})}pauseUpdates(){console.log("pauseUpdates called - blocking all visibility updates"),this.updatesPaused=!0,this.isAnimationInProgress=!0,this.selectedHotspot&&this.overlays.forEach((t,e)=>{var i;e!==this.selectedHotspot.id&&e!==((i=this.hoveredHotspot)==null?void 0:i.id)&&(t.element.style.visibility="hidden")})}resumeUpdates(){console.log("resumeUpdates called - unblocking updates"),this.updatesPaused=!1,this.isAnimationInProgress=!1,this.overlays.forEach(t=>{t.element.style.visibility="visible"}),this.pendingVisibilityUpdate&&(this.pendingVisibilityUpdate=!1,this.isMobile?this.updateVisibilityLazy():this.updateVisibility())}hideOverlay(){console.log("Hiding entire SVG overlay"),this.svg&&(this.svg.style.display="none")}showOverlay(){console.log("Showing SVG overlay"),this.svg&&(this.svg.style.display="")}setupRevealMode(){if(window.updateRevealStyle=t=>{this.svg&&(this.svg.classList.remove("reveal-style-invert","reveal-style-neon"),this.svg.classList.add(`reveal-style-${t}`))},this.isMobile){let t=0,e=null;this.viewer.addHandler("canvas-click",i=>{t++,e&&clearTimeout(e),t>=3?(this.toggleRevealMode(),t=0):e=setTimeout(()=>{t=0},500)})}}toggleRevealMode(){this.modeStateManager.isRevealActive()?this.deactivateRevealMode():this.activateRevealMode()}activateRevealMode(){console.log("Reveal mode activated"),this.modeStateManager.setRevealActive(!0),this.overlays.forEach(e=>{e.isVisible&&this.startBreathingAnimation(e)});const t=setTimeout(()=>{this.deactivateRevealMode()},this.revealMode.duration);this.modeStateManager.setRevealTimer(t)}deactivateRevealMode(){console.log("Reveal mode deactivated"),this.modeStateManager.setRevealActive(!1),this.overlays.forEach(t=>{this.stopBreathingAnimation(t)})}startBreathingAnimation(t){const e=t.element,i=t.hotspot.id;this.revealMode.animations.has(i)||(e.classList.add("hotspot-reveal-breathing"),this.isSafari&&e.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(r=>{r.classList.add("hotspot-reveal-breathing")}),this.revealMode.animations.set(i,!0))}stopBreathingAnimation(t){const e=t.element,i=t.hotspot.id;e.classList.remove("hotspot-reveal-breathing"),this.isSafari&&e.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(r=>{r.classList.remove("hotspot-reveal-breathing")}),this.revealMode.animations.delete(i)}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.mouseTracker&&this.mouseTracker.destroy(),this.viewer.removeAllHandlers("animation"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("animation-update"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeHandler("canvas-drag"),this.viewer.removeHandler("canvas-drag-end"),this.viewer.removeHandler("zoom"),this.svg&&(this.svg.removeEventListener("pointerdown",this.handlePointerDown),this.svg.removeEventListener("pointermove",this.handlePointerMove),this.svg.removeEventListener("pointerup",this.handlePointerUp),this.svg.removeEventListener("pointercancel",this.handlePointerCancel),this.viewer.removeOverlay(this.svg)),this.animationQueue&&(this.animationQueue.clear(),this.animationQueue=null),this.overlays.forEach(e=>{const i=e.element.getElementsByTagName("path");for(let n of i)n.style.animation="none",n.style.transition="none"});const t=document.getElementById("hotspot-animations");t&&t.remove(),this.temporalHandler&&(this.temporalHandler.destroy(),this.temporalHandler=null),this.modeStateManager&&(this.modeStateManager.reset(),this.modeStateManager=null),this.overlays.clear(),this.visibleOverlays.clear(),this.hotspotAreas.clear(),this.pathDefs&&this.pathDefs.remove(),this.viewer=null,window.nativeHotspotRenderer===this&&(window.nativeHotspotRenderer=null)}};bn(ri,"MAX_CONCURRENT_ANIMATIONS",25),bn(ri,"MAX_CONCURRENT_ANIMATIONS_MOBILE",15),bn(ri,"HIGH_HOTSPOT_COUNT_THRESHOLD",100);let bo=ri;class cd{constructor(t){this.viewer=t,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[],this.thresholds={fps:{target:60,good:55,acceptable:45,poor:30,critical:20},frameTime:{target:16.67,warning:20},memory:{warning:250,critical:300}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const t={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(t).forEach(([e,i])=>this.viewer.addHandler(e,i.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(t=>this.viewer.removeAllHandlers(t))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const t=performance.now(),e=t-this.lastTime;this.updateFrameMetrics(e),this.lastTime=t,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(t){if(this.frameTimes.push(t),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),t>0){const e=1e3/t;this.fpsHistory.push(e),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=e,t>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const t=this.viewer.drawer.canvas;t&&(this.metrics.canvasSize=`${t.width}×${t.height}`);const i=this.viewer.viewport.getBounds(),n=this.viewer.world.getHomeBounds(),r=i.width*i.height/(n.width*n.height);this.metrics.viewportCoverage=Math.min(100,r*100).toFixed(1)}updateTileMetrics(){var i,n;const t=this.viewer.world;if(t.getItemCount()===0)return;const e=t.getItemAt(0);if(e){if(this.metrics.visibleTiles=((i=e._tilesToDraw)==null?void 0:i.length)||0,e._tileCache){const r=e._tileCache;this.metrics.cachedTiles=((n=r._tilesLoaded)==null?void 0:n.length)||r._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:t,frameTime:e,memory:i}=this.thresholds,n={fps:Math.min(100,this.metrics.averageFPS/t.target*100)*.5,frameTime:Math.min(100,e.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(n).reduce((r,o)=>r+o,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const t=Date.now();if(t-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:e}=this.thresholds,i=this.metrics.averageFPS,n=this.metrics.performanceScore,r=this.getPerformanceTrend(),o=[{condition:i<e.critical||n<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:i<e.poor||n<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:i<e.good||n<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:i>e.target&&n>90&&(r==="improving"||r==="stable"),action:this.restoreQualitySettings,log:null}];for(const a of o)if(a.condition){a.log&&console[a.log==="CRITICAL"?"error":"warn"](`${a.log} performance: Score ${n}, FPS: ${i}`),a.action.call(this),this.lastOptimization=t;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const t=this.performanceHistory.slice(-10),e=this.performanceHistory.slice(-20,-10),i=this.average(t.map(o=>o.score)),n=this.average(e.map(o=>o.score)),r=i-n;return r>5?"improving":r<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var i;const t=(i=window.performanceConfig)==null?void 0:i.viewer;if(!t)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:n,delta:r,op:o})=>{const a=this.viewer[n],c=t[n];o==="increase"&&a<c?this.viewer[n]=Math.min(c,a+r):o==="decrease"&&a>c&&(this.viewer[n]=Math.max(c,a-r))})}onTileLoaded(t){var e;(e=t.tile)!=null&&e.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+t.tile.loadTime*.1)}onTileLoadFailed(t){console.warn("Tile load failed:",t.tile)}trackLoadTime(t){this.loadTimes.push(t),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const t=this.getPerformanceLevel();return{...this.metrics,performanceLevel:t,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:t,performanceScore:e}=this.metrics,{fps:i}=this.thresholds;return[{name:"excellent",condition:t>=i.target&&e>=90},{name:"good",condition:t>=i.good&&e>=80},{name:"acceptable",condition:t>=i.acceptable&&e>=60},{name:"poor",condition:t>=i.poor&&e>=40},{name:"critical",condition:!0}].find(r=>r.condition).name}getWarnings(){const t=this.metrics,e=this.thresholds;return[{condition:t.averageFPS<e.fps.acceptable,message:`Low FPS: ${t.averageFPS} (target: ${e.fps.target})`},{condition:t.droppedFrames>100,message:`Dropped frames: ${t.droppedFrames}`},{condition:parseFloat(t.frameTime)>e.frameTime.warning,message:`High frame time: ${t.frameTime}ms`},{condition:t.memoryUsage>e.memory.critical,message:`High memory: ${t.memoryUsage}MB`},{condition:t.cachedTiles>2e3,message:`Large cache: ${t.cachedTiles} tiles`},{condition:t.tileLoadTime>300,message:`Slow tile loading: ${Math.round(t.tileLoadTime)}ms`}].filter(n=>n.condition).map(n=>n.message)}getRecommendations(){const t=[],e=this.metrics,i=this.thresholds;return e.averageFPS<i.fps.acceptable&&(e.renderMode==="animating"&&t.push("Reduce animation time for smoother transitions"),e.cachedTiles>1e3&&t.push("Clear tile cache to free memory"),e.visibleTiles>50&&t.push("Zoom in to reduce visible tiles")),e.memoryUsage>i.memory.warning&&t.push("Consider reloading the page to clear memory"),e.tileLoadTime>200&&t.push("Check network connection or reduce concurrent tile loads"),t}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const t=this.getMetrics(),e={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},i=t.currentFPS<55?"#FF9800":"#4CAF50",n=t.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${e[t.performanceLevel]};">
                    ${t.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${i};">
                    ${t.currentFPS.toFixed(0)} (avg: ${t.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${t.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${n};">
                    ${t.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${e[t.performanceLevel]}; font-weight: 500;">
                    ${t.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(t){return t.reduce((e,i)=>e+i,0)/t.length}trimArray(t,e){for(;t.length>e;)t.shift()}}class hd{constructor(t){this.viewer=t,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([e,i])=>this.viewer.addHandler(e,i))}applyInitialOptimizations(){const t=this.viewer.container;t&&Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const t=performance.now(),e=t-this.state.lastFrameTime;if(this.state.lastFrameTime=t,this.viewer.viewport.getZoom()<3&&e>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let t=null,e=!1;this.viewer.addHandler("zoom",()=>{if(!e){if(e=!0,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!1,i.globalAlpha=1}this.viewer.skipTileDrawing=!0}t&&clearTimeout(t),t=setTimeout(()=>{if(e=!1,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!0,i.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),t=null},150)})}handleViewportChange(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const i=Math.abs(t-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+i*.3,this.state.isZooming=i>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const i=Math.sqrt(Math.pow(e.x-this.lastCenter.x,2)+Math.pow(e.y-this.lastCenter.y,2));this.state.isPanning=i>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=t,this.lastCenter=e}applyZoomOptimizations(t){var i,n;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((n=(i=window.performanceConfig)==null?void 0:i.renderOptimization)!=null&&n.zoomOptimizations))){if(t&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&(this.state.lastBlendTime=r.blendTime,r.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!t&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&this.state.lastBlendTime!==null&&(r.blendTime=this.state.lastBlendTime)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(t){var i;this.lastInteraction=Date.now();const e={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(i=e[t])==null||i.call(e)}setRenderMode(t){var i,n;if(this.state.renderMode===t)return;const e=this.state.renderMode;this.state.renderMode=t,t==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):t==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(n=(i=window.performanceConfig)==null?void 0:i.debug)!=null&&n.logPerformance&&console.log(`Render mode: ${e} → ${t}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var n,r;const t=Date.now();if(t-this.lastOptimizationTime<this.config.optimizationCooldown)return;const e=(n=this.viewer.drawer)==null?void 0:n.canvas,i=(r=this.viewer.drawer)==null?void 0:r.context;!e||!i||(Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(i,!0),i.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=t)}removeCanvasOptimizations(){var e;const t=(e=this.viewer.drawer)==null?void 0:e.context;t&&(this.setContextSmoothing(t,!0),t.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(t,e){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(n=>{n in t&&(t[n]=e)})}clearTimers(){Object.entries(this.timers).forEach(([t,e])=>{clearTimeout(e),delete this.timers[t]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(t){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(i=>Object.assign(i.style,t))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(t){Object.assign(this.config,t)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var t,e;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((e=(t=window.performanceConfig)==null?void 0:t.viewer)==null?void 0:e.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(t=>this.viewer.removeAllHandlers(t)),this.removeCanvasOptimizations(),this.viewer=null}}function Bc(s,t,e=0,i=s.length-1,n=ud){for(;i>e;){if(i-e>600){const c=i-e+1,h=t-e+1,d=Math.log(c),l=.5*Math.exp(2*d/3),p=.5*Math.sqrt(d*l*(c-l)/c)*(h-c/2<0?-1:1),f=Math.max(e,Math.floor(t-h*l/c+p)),m=Math.min(i,Math.floor(t+(c-h)*l/c+p));Bc(s,t,f,m,n)}const r=s[t];let o=e,a=i;for(rr(s,e,t),n(s[i],r)>0&&rr(s,e,i);o<a;){for(rr(s,o,a),o++,a--;n(s[o],r)<0;)o++;for(;n(s[a],r)>0;)a--}n(s[e],r)===0?rr(s,e,a):(a++,rr(s,a,i)),a<=t&&(e=a+1),t<=a&&(i=a-1)}}function rr(s,t,e){const i=s[t];s[t]=s[e],s[e]=i}function ud(s,t){return s<t?-1:s>t?1:0}class dd{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const i=[];if(!Jr(t,e))return i;const n=this.toBBox,r=[];for(;e;){for(let o=0;o<e.children.length;o++){const a=e.children[o],c=e.leaf?n(a):a;Jr(t,c)&&(e.leaf?i.push(a):ao(t,c)?this._all(a,i):r.push(a))}e=r.pop()}return i}collides(t){let e=this.data;if(!Jr(t,e))return!1;const i=[];for(;e;){for(let n=0;n<e.children.length;n++){const r=e.children[n],o=e.leaf?this.toBBox(r):r;if(Jr(t,o)){if(e.leaf||ao(t,o))return!0;i.push(r)}}e=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const i=this.data;this.data=e,e=i}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Cn([]),this}remove(t,e){if(!t)return this;let i=this.data;const n=this.toBBox(t),r=[],o=[];let a,c,h;for(;i||r.length;){if(i||(i=r.pop(),c=r[r.length-1],a=o.pop(),h=!0),i.leaf){const d=pd(t,i.children,e);if(d!==-1)return i.children.splice(d,1),r.push(i),this._condense(r),this}!h&&!i.leaf&&ao(i,n)?(r.push(i),o.push(a),a=0,c=i,i=i.children[0]):c?(a++,i=c.children[a],h=!1):i=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,n){const r=i-e+1;let o=this._maxEntries,a;if(r<=o)return a=Cn(t.slice(e,i+1)),En(a,this.toBBox),a;n||(n=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,n-1))),a=Cn([]),a.leaf=!1,a.height=n;const c=Math.ceil(r/o),h=c*Math.ceil(Math.sqrt(o));ol(t,e,i,h,this.compareMinX);for(let d=e;d<=i;d+=h){const l=Math.min(d+h-1,i);ol(t,d,l,c,this.compareMinY);for(let p=d;p<=l;p+=c){const f=Math.min(p+c-1,l);a.children.push(this._build(t,p,f,n-1))}}return En(a,this.toBBox),a}_chooseSubtree(t,e,i,n){for(;n.push(e),!(e.leaf||n.length-1===i);){let r=1/0,o=1/0,a;for(let c=0;c<e.children.length;c++){const h=e.children[c],d=oo(h),l=gd(t,h)-d;l<o?(o=l,r=d<r?d:r,a=h):l===o&&d<r&&(r=d,a=h)}e=a||e.children[0]}return e}_insert(t,e,i){const n=i?t:this.toBBox(t),r=[],o=this._chooseSubtree(n,this.data,e,r);for(o.children.push(t),or(o,n);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(n,r,e)}_split(t,e){const i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);const o=this._chooseSplitIndex(i,r,n),a=Cn(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,En(i,this.toBBox),En(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)}_splitRoot(t,e){this.data=Cn([t,e]),this.data.height=t.height+1,this.data.leaf=!1,En(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let n,r=1/0,o=1/0;for(let a=e;a<=i-e;a++){const c=sr(t,0,a,this.toBBox),h=sr(t,a,i,this.toBBox),d=vd(c,h),l=oo(c)+oo(h);d<r?(r=d,n=a,o=l<o?l:o):d===r&&l<o&&(o=l,n=a)}return n||i-e}_chooseSplitAxis(t,e,i){const n=t.leaf?this.compareMinX:fd,r=t.leaf?this.compareMinY:md,o=this._allDistMargin(t,e,i,n),a=this._allDistMargin(t,e,i,r);o<a&&t.children.sort(n)}_allDistMargin(t,e,i,n){t.children.sort(n);const r=this.toBBox,o=sr(t,0,e,r),a=sr(t,i-e,i,r);let c=Kr(o)+Kr(a);for(let h=e;h<i-e;h++){const d=t.children[h];or(o,t.leaf?r(d):d),c+=Kr(o)}for(let h=i-e-1;h>=e;h--){const d=t.children[h];or(a,t.leaf?r(d):d),c+=Kr(a)}return c}_adjustParentBBoxes(t,e,i){for(let n=i;n>=0;n--)or(e[n],t)}_condense(t){for(let e=t.length-1,i;e>=0;e--)t[e].children.length===0?e>0?(i=t[e-1].children,i.splice(i.indexOf(t[e]),1)):this.clear():En(t[e],this.toBBox)}}function pd(s,t,e){if(!e)return t.indexOf(s);for(let i=0;i<t.length;i++)if(e(s,t[i]))return i;return-1}function En(s,t){sr(s,0,s.children.length,t,s)}function sr(s,t,e,i,n){n||(n=Cn(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let r=t;r<e;r++){const o=s.children[r];or(n,s.leaf?i(o):o)}return n}function or(s,t){return s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY),s}function fd(s,t){return s.minX-t.minX}function md(s,t){return s.minY-t.minY}function oo(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function Kr(s){return s.maxX-s.minX+(s.maxY-s.minY)}function gd(s,t){return(Math.max(t.maxX,s.maxX)-Math.min(t.minX,s.minX))*(Math.max(t.maxY,s.maxY)-Math.min(t.minY,s.minY))}function vd(s,t){const e=Math.max(s.minX,t.minX),i=Math.max(s.minY,t.minY),n=Math.min(s.maxX,t.maxX),r=Math.min(s.maxY,t.maxY);return Math.max(0,n-e)*Math.max(0,r-i)}function ao(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function Jr(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function Cn(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ol(s,t,e,i,n){const r=[t,e];for(;r.length;){if(e=r.pop(),t=r.pop(),e-t<=i)continue;const o=t+Math.ceil((e-t)/i/2)*i;Bc(s,o,t,e,n),r.push(t,o,o,e)}}class yd{constructor(){this.tree=new dd(9),this.hotspots=new Map,this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(t){const e=performance.now();this.tree.clear(),this.hotspots.clear(),this.queryCache.clear();const i=[];t.forEach(r=>{const o=this.calculateBoundingBox(r.coordinates);this.hotspots.set(r.id,{...r,bbox:o}),i.push({minX:o.minX,minY:o.minY,maxX:o.maxX,maxY:o.maxY,id:r.id})}),this.tree.load(i);const n=performance.now()-e;console.log(`Spatial index built in ${n.toFixed(2)}ms for ${i.length} hotspots`)}queryViewport(t,e=1){const i=`${t.minX.toFixed(2)},${t.minY.toFixed(2)},${t.maxX.toFixed(2)},${t.maxY.toFixed(2)},${e.toFixed(2)}`;if(this.queryCache.has(i))return this.queryCache.get(i);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const r=this.tree.search({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY}).map(o=>this.hotspots.get(o.id));return this.queryCache.size<this.cacheSize&&this.queryCache.set(i,r),r}getHotspotAtPoint(t,e){const i=this.tree.search({minX:t,minY:e,maxX:t,maxY:e});for(const n of i){const r=this.hotspots.get(n.id);if(this.isPointInHotspot(t,e,r))return r}return null}calculateBoundingBox(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{for(const c of a)e=Math.min(e,c[0]),i=Math.min(i,c[1]),n=Math.max(n,c[0]),r=Math.max(r,c[1])};if(t.length>0&&typeof t[0][0]=="number")o(t);else for(const a of t)o(a);return{minX:e,minY:i,maxX:n,maxY:r}}isPointInHotspot(t,e,i){return i.shape==="polygon"?this.pointInPolygon(t,e,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(n=>this.pointInPolygon(t,e,n)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}getAllHotspots(){return Array.from(this.hotspots.values())}clear(){this.tree.clear(),this.hotspots.clear(),this.queryCache.clear()}}class wd{constructor(t){this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:15}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(t){if(!t.tile)return;const e=this.getTileKey(t.tile);this.tileAccessTimes.set(e,Date.now())}handleViewportChange(){var i;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0);if(!t||!t._tilesToDraw)return;const e=Date.now();t._tilesToDraw.forEach(n=>{const r=this.getTileKey(n);this.tileAccessTimes.set(r,e)})}getTileKey(t){return`${t.level}_${t.x}_${t.y}`}monitorPerformance(){var i,n;const t=((n=(i=window.performanceMonitor)==null?void 0:i.getMetrics())==null?void 0:n.averageFPS)||60,e=this.state.currentPressure;t<this.config.fpsThresholds.critical?this.state.currentPressure="critical":t<this.config.fpsThresholds.poor?this.state.currentPressure="high":t<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",e!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${e} → ${this.state.currentPressure} (FPS: ${t})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const e={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),e)}performCleanup(){var O;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const e=performance.now(),i=(O=this.viewer.world)==null?void 0:O.getItemAt(0);if(!i||!i._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const r=this.state.currentPressure,o=this.config.maxTileAge[r],a=this.config.cacheThresholds[r],c=this.config.keepDistance[r],h=Date.now(),l=this.viewer.viewport.getBounds(),p={x:l.x-l.width*(c-1)/2,y:l.y-l.height*(c-1)/2,width:l.width*c,height:l.height*c},m=i._tileCache._tilesLoaded||[],v=m.length;if(v===0)return;const w=new Set;i._tilesToDraw&&i._tilesToDraw.forEach(N=>{const q=this.getTileKey(N);w.add(q)});const b=[];if(m.forEach(N=>{const q=this.getTileKey(N);if(w.has(q))return;const ie=this.tileAccessTimes.get(q)||0,k=h-ie;let S=!1;if(k>o&&(S=!0),!S&&r!=="normal"){const E=N.bounds;E&&(!(E.x+E.width<p.x||E.x>p.x+p.width||E.y+E.height<p.y||E.y>p.y+p.height)||(S=!0))}S&&b.push(N)}),v>a){const N=v-a;if(N>b.length){const q=m.filter(k=>{const S=this.getTileKey(k);return!b.includes(k)&&!w.has(S)});q.sort((k,S)=>{const E=this.getTileKey(k),D=this.getTileKey(S),L=this.tileAccessTimes.get(E)||0,F=this.tileAccessTimes.get(D)||0;return L-F});const ie=N-b.length;b.push(...q.slice(0,ie))}}b.length>0&&(b.forEach(N=>{const q=this.getTileKey(N);this.tileAccessTimes.delete(q),N.unload&&N.unload()}),this.state.tilesRemoved+=b.length,this.metrics.totalCleaned+=b.length,console.log(`Cleaned ${b.length} tiles (pressure: ${r}, cache was: ${v}, kept ${w.size} visible)`));const I=performance.now()-e;this.metrics.lastCleanupDuration=I,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+I)/this.metrics.cleanupRuns,this.state.lastCleanup=h,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const e=performance.now(),i=Date.now(),n=3e5,r=[];this.tileAccessTimes.forEach((a,c)=>{i-a>n&&r.push(c)}),r.forEach(a=>this.tileAccessTimes.delete(a)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const o=performance.now()-e;this.state.lastDeepCleanup=i,console.log(`Deep cleanup completed in ${o.toFixed(2)}ms, cleared ${r.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var i,n,r;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0),e=((r=(n=t==null?void 0:t._tileCache)==null?void 0:n._tilesLoaded)==null?void 0:r.length)||0;return{...this.metrics,currentCacheSize:e,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(t){["normal","elevated","high","critical"].includes(t)&&(this.state.currentPressure=t,this.updateCleanupInterval())}pauseCleanup(t=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},t))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class _d{constructor(t){this.viewer=t,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(t){throw console.error("Failed to initialize TileWorkerManager:",t),this.state.lastError=t,t}}async processTile(t,e=2){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tile:t}),this.worker.postMessage({type:"process-tile",requestId:i,data:{tile:this.serializeTile(t),priority:e}}),this.metrics.requestsSent++})}async processBatch(t,e=[]){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Batch processing timeout"))},this.config.requestTimeout*t.length);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tiles:t}),this.worker.postMessage({type:"batch-process",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),priorities:e}}),this.metrics.requestsSent++})}async prioritizeTiles(t,e){if(this.isInitialized||await this.initialize(),t.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const n=t.map(r=>{const o=(r.bounds.minX+r.bounds.maxX)/2,a=(r.bounds.minY+r.bounds.maxY)/2,c=(e.bounds.minX+e.bounds.maxX)/2,h=(e.bounds.minY+e.bounds.maxY)/2,d=Math.sqrt(Math.pow(o-c,2)+Math.pow(a-h,2));return d<.5?0:d<1?1:2});return{tiles:t,priorities:n}}const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),n({tiles:t,priorities:t.map(()=>1)})},50);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:"prioritize",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),viewport:{bounds:e.bounds,zoom:e.zoom}}})})}clearCache(t=!1,e=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:t,maxAge:e}})}async getStats(){if(!this.isInitialized)return this.metrics;const t=this.generateRequestId();return new Promise(e=>{const i=setTimeout(()=>{this.state.pendingRequests.delete(t),e(this.metrics)},1e3);this.state.pendingRequests.set(t,{resolve:e,reject:()=>{},timeout:i}),this.worker.postMessage({type:"get-stats",requestId:t})})}handleWorkerMessage(t){const{type:e,requestId:i,data:n}=t.data;switch(e){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=n.capabilities,this.handleRequestComplete(i,n);break;case"tile-ready":this.handleTileReady(i,n);break;case"tile-error":this.handleTileError(i,n);break;case"batch-complete":this.handleRequestComplete(i,n);break;case"priorities-calculated":this.handleRequestComplete(i,n);break;case"stats":this.handleStatsReceived(i,n);break;case"cache-cleared":console.log("Worker cache cleared:",n);break;default:console.warn("Unknown worker message type:",e)}}handleWorkerError(t){console.error("Worker error:",t),this.state.lastError=t,this.state.pendingRequests.forEach((e,i)=>{clearTimeout(e.timeout),e.reject(t)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n=performance.now()-i.startTime;this.updateMetrics(n,e.cached),i.resolve({...e,processingTime:n})}handleTileError(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),this.metrics.requestsFailed++,i.reject(new Error(e.error)))}handleRequestComplete(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),i.resolve(e))}handleStatsReceived(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n={...this.metrics,worker:e};i.resolve(n)}updateMetrics(t,e){this.metrics.requestsCompleted++,e&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=t,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(t){return{level:t.level,x:t.x,y:t.y,bounds:t.bounds?{minX:t.bounds.x||t.bounds.minX,minY:t.bounds.y||t.bounds.minY,maxX:(t.bounds.x||t.bounds.minX)+(t.bounds.width||0),maxY:(t.bounds.y||t.bounds.minY)+(t.bounds.height||0)}:null,url:t.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(t=>{if(this.state.workerReady){t();return}const e=setInterval(()=>{this.state.workerReady&&(clearInterval(e),t())},100);setTimeout(()=>{clearInterval(e),t()},5e3)})}async sendToWorker(t,e){const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),r(new Error(`Worker request timeout: ${t}`))},5e3);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:t,requestId:i,data:e})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(t=>{clearTimeout(t.timeout),t.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class Td{constructor(t){this.viewer=t,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new _d(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(t){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",t),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const t=this.viewer.viewport,e=t.getBounds(),i={bounds:{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height},zoom:t.getZoom()},n=this.state.tileQueue.slice(0,50),r=await this.workerManager.prioritizeTiles(n,i);r.tiles&&r.priorities&&(r.tiles.forEach((o,a)=>{const c=r.priorities[a],h=this.state.tileQueue.find(d=>d.level===o.level&&d.x===o.x&&d.y===o.y);h&&(h.priority=c)}),this.sortQueue())}catch(t){console.warn("Failed to update worker priorities:",t)}}calculateTilePriority(t,e,i){const n=this.viewer.viewport,r=n.getBounds(),o=n.getCenter(),a=n.getZoom();if(a<2&&this.viewer.source.getTileWidth(t)*a<32)return 999;const c=this.viewer.source.getTileWidth(t),h=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):c,d=(e+.5)*c/this.viewer.source.width,l=(i+.5)*h/this.viewer.source.height,p=Math.sqrt(Math.pow(d-o.x,2)+Math.pow(l-o.y,2)),f={left:e*c/this.viewer.source.width,top:i*h/this.viewer.source.height,right:(e+1)*c/this.viewer.source.width,bottom:(i+1)*h/this.viewer.source.height};return f.right<r.x||f.left>r.x+r.width||f.bottom<r.y||f.top>r.y+r.height?p<r.width*this.config.predictiveRadius?1:2:a<3?Math.abs(d-o.x)+Math.abs(l-o.y)<.2?0:1:0}enqueueTile(t,e,i,n){const r=`${t}_${e}_${i}`;if(this.state.loadingTiles.has(r))return;const o=this.state.tileQueue.findIndex(c=>c.key===r);if(o>=0){n<this.state.tileQueue[o].priority&&(this.state.tileQueue[o].priority=n,this.sortQueue());return}const a={level:t,x:e,y:i,key:r,priority:n,timestamp:Date.now(),bounds:this.calculateTileBounds(t,e,i)};this.state.tileQueue.push(a),this.sortQueue()}calculateTileBounds(t,e,i){const n=this.viewer.source.getTileWidth(t),r=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):n,o=this.viewer.source.width,a=this.viewer.source.height;return{minX:e*n/o,minY:i*r/a,maxX:(e+1)*n/o,maxY:(i+1)*r/a}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const t=this.state.tileQueue.filter(e=>e.priority<=1).slice(0,this.config.workerBatchSize);if(t.length!==0)try{const e=t.map(r=>r.priority),i=performance.now();await this.workerManager.processBatch(t,e);const n=performance.now()-i;this.workerMetrics.tilesProcessedByWorker+=t.length,this.workerMetrics.workerProcessingTime+=n,t.forEach(r=>{const o=this.state.tileQueue.findIndex(a=>a.key===r.key);o>=0&&this.state.tileQueue.splice(o,1)})}catch(e){console.error("Worker batch processing failed:",e),this.workerMetrics.workerErrors++}}processQueue(){var e;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((e=this.viewer.world)!=null&&e.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const i=this.state.tileQueue.shift();Date.now()-i.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(i.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((t,e)=>t.priority!==e.priority?t.priority-e.priority:t.timestamp-e.timestamp)}predictiveLoad(){var p;if(this.shouldSkipPredictiveLoad()||!((p=this.viewer.world)==null?void 0:p.getItemAt(0))||!this.viewer.source)return;const e=this.viewer.viewport,i=e.getBounds(),n={x:i.x-i.width*(this.config.predictiveRadius-1)/2,y:i.y-i.height*(this.config.predictiveRadius-1)/2,width:i.width*this.config.predictiveRadius,height:i.height*this.config.predictiveRadius},r=e.getZoom(),o=Math.max(0,Math.min(Math.floor(Math.log2(r)),this.viewer.source.maxLevel||14)),a=this.viewer.source.getTileWidth(o),c=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(o):a,h=this.viewer.source.width,d=this.viewer.source.height,l={startX:Math.max(0,Math.floor(n.x*h/a)),endX:Math.min(Math.ceil(h/a)-1,Math.ceil((n.x+n.width)*h/a)),startY:Math.max(0,Math.floor(n.y*d/c)),endY:Math.min(Math.ceil(d/c)-1,Math.ceil((n.y+n.height)*d/c))};for(let f=l.startX;f<=l.endX;f++)for(let m=l.startY;m<=l.endY;m++){const v=this.calculateTilePriority(o,f,m);this.enqueueTile(o,f,m,v)}}trackLoadTime(t){this.state.loadTimes.push(t),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((e,i)=>e+i,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(t){this.state.loadingTiles.delete(t)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const t=this.state.averageLoadTime,e=this.config.maxConcurrentLoads;t>500&&e>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`)):t<200&&e<8&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`))}performCleanup(){const t=Date.now();this.state.tileQueue=this.state.tileQueue.filter(e=>t-e.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=t,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const t=document.createElement("canvas");t.width=t.height=1;const e=t.getContext("2d");e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,1,1);try{return t.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const t=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:t}}}let $r=new Map,es=null,lo=null;function bd(s){if(console.log("=== APPLYING OPTIMIZED TILE CASCADE FIX ==="),/Android|iPhone|iPad/i.test(navigator.userAgent)){console.log("TileCascadeFix disabled on mobile for testing");return}if(!s){console.error("OpenSeadragon not provided - cannot apply tile cascade fix");return}const e=s.TiledImage.prototype._getLevelsInterval,i=s.TiledImage.prototype._updateLevels;if(!e){console.error("_getLevelsInterval method not found - cannot apply fix");return}s.TiledImage.prototype._getLevelsInterval=function(){const n=this.viewer.viewport.getZoom();if(es!==null&&Math.abs(n-es)<.01&&$r.has(this))return $r.get(this);const r=e.call(this);if(!r||typeof r.lowestLevel>"u")return r;let o=r;if(n<3){const a=/Android|iPhone|iPad/i.test(navigator.userAgent),c=Math.floor(Math.log2(n*1024/256)),h=Math.max(8,Math.min(12,c+11)),d=a?4:3;o={lowestLevel:Math.max(8,h-Math.floor(d/2)),highestLevel:Math.min(14,h+Math.floor(d/2))},o.highestLevel-o.lowestLevel>d-1&&(o.lowestLevel=o.highestLevel-(d-1))}return $r.set(this,o),es=n,lo&&clearTimeout(lo),lo=setTimeout(()=>{$r.clear(),es=null},100),o},i&&(s.TiledImage.prototype._updateLevels=function(){if(this.viewer.isAnimating())return;const n=i.call(this);if(this.viewer.viewport.getZoom()<3&&this._tilesToDraw){const o=this._getLevelsInterval();this._tilesToDraw=this._tilesToDraw.filter(a=>a.level>=o.lowestLevel&&a.level<=o.highestLevel)}return n}),console.log("=== OPTIMIZED TILE CASCADE FIX APPLIED ===")}class xd{constructor(t){this.viewer=t,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const t=performance.now();return this.cacheEnabled&&this.cachedViewport&&t-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const t=performance.now(),e=this.viewer.viewport,i=e.getBounds(),n=e.viewportToImageCoordinates(i.getTopLeft()),r=e.viewportToImageCoordinates(i.getBottomRight()),o=r.x-n.x,a=r.y-n.y,c=o*this.viewportPadding,h=a*this.viewportPadding,d=this.viewer.world.getItemAt(0),l=d?d.getContentSize():{x:1,y:1},f={bounds:{minX:Math.max(0,n.x-c),minY:Math.max(0,n.y-h),maxX:Math.min(l.x,r.x+c),maxY:Math.min(l.y,r.y+h)},zoom:e.getZoom(!0),center:e.getCenter(!0),rotation:e.getRotation(),containerSize:e.getContainerSize(),imageBounds:{minX:n.x,minY:n.y,maxX:r.x,maxY:r.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=f,this.lastUpdate=performance.now();const m=this.lastUpdate-t;return this.metrics.lastUpdateDuration=m,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+m)/this.metrics.totalUpdates,f}isPointInViewport(t,e,i=!1){const n=this.getCurrentViewport(),r=i?n.bounds:n.imageBounds;return t>=r.minX&&t<=r.maxX&&e>=r.minY&&e<=r.maxY}isBoxInViewport(t,e,i,n,r=!0){const o=this.getCurrentViewport(),a=r?o.bounds:o.imageBounds;return!(i<a.minX||t>a.maxX||n<a.minY||e>a.maxY)}imageToPixel(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(t,e));return this.viewer.viewport.pixelFromPoint(i)}pixelToImage(t,e){const i=this.viewer.viewport.pointFromPixel(new nt.Point(t,e));return this.viewer.viewport.viewportToImageCoordinates(i)}calculatePixelRatio(){const t=this.viewer.viewport,e=t.getContainerSize(),i=t.getBounds(),n=this.viewer.world.getItemAt(0);if(!n)return 1;const r=n.getContentSize(),o=i.width*r.x;return e.x/o}getLevelOfDetail(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getMaxZoom(),i=t/e;return i<.1?0:i<.3?1:i<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const t=this.getCurrentViewport(),e=this.viewer.world.getItemAt(0);if(!e)return 1;const i=e.getContentSize(),n=(t.imageBounds.maxX-t.imageBounds.minX)*(t.imageBounds.maxY-t.imageBounds.minY),r=i.x*i.y;return n/r}getMetrics(){const t=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:t.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const t=this.getCurrentViewport();return{x:t.imageBounds.minX,y:t.imageBounds.minY,width:t.imageBounds.maxX-t.imageBounds.minX,height:t.imageBounds.maxY-t.imageBounds.minY}}setCacheEnabled(t){this.cacheEnabled=t,t||(this.cachedViewport=null)}setCacheTimeout(t){this.cacheTimeout=Math.max(0,t)}setViewportPadding(t){this.viewportPadding=Math.max(0,Math.min(1,t))}destroy(){this.viewer=null,this.cachedViewport=null}}class al{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=50,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}getCachedViewportRect(){const t=performance.now();return(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t),this.cachedViewportRect}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],c=t[(r+1)%n],h=Math.atan2(a[1]-o[1],a[0]-o[0]);let l=Math.atan2(c[1]-a[1],c[0]-a[0])-h;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const p=Math.sqrt(Math.pow(c[0]-a[0],2)+Math.pow(c[1]-a[1],2)),f=Math.abs(l)/(p+1e-10);e+=f,i=Math.max(i,f)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let d=0;d<e;d++){const l=t[(d+1)%e];n+=Math.sqrt(Math.pow(t[d][0]-l[0],2)+Math.pow(t[d][1]-l[1],2))}const o=n/e*3;for(let d=0;d<e;d++)for(let l=0;l<e;l++){if(d===l)continue;Math.sqrt(Math.pow(t[d][0]-t[l][0],2)+Math.pow(t[d][1]-t[l][1],2))<o&&i[d]++}const a=Math.max(...i),c=i.reduce((d,l)=>d+l,0)/e,h=i.reduce((d,l)=>d+Math.pow(l-c,2),0)/e;return{maxDensity:a,avgDensity:c,variance:h,uniformityScore:1-Math.sqrt(h)/(c+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation()):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation()))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getCachedViewportRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const r=this.calculateAdaptivePolygonExpansion(i),o=this.expandPolygon(i,r),a=[];let c=0,h=0;o.forEach(([l,p])=>{const f=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(l,p)),m=this.viewer.viewport.viewportToWindowCoordinates(f);c+=m.x,h+=m.y}),c/=o.length,h/=o.length;let d=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(d=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([l,p])=>{const f=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(l,p)),m=this.viewer.viewport.viewportToWindowCoordinates(f),v=c+(m.x-c)*d,w=h+(m.y-h)*d;a.push(`${v},${w}`)}),a.length>0)if(this.useClipPath){const l=e.width,p=e.height,f=`0,0 ${l},0 ${l},${p} 0,${p} 0,0`,m=a.slice().reverse().join(" "),v=`polygon(${f} ${m})`;this.overlayElement.style.clipPath=v,this.overlayElement.style.webkitClipPath=v}else{const l=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,f=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(l)))}`;this.overlayElement.style.mask=`url("${f}")`,this.overlayElement.style.webkitMask=`url("${f}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,c=o*this.viewer.container.clientHeight,d=Math.max(a,c)*.75;return Math.max(50,Math.min(500,d))}trackFocusReference(){if(!this.state.selectedHotspot)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.8?n=1:i<=.3?n=0:n=(i-.3)/(.8-.3);let r=1;if(this.state.selectedHotspot&&e){const o=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0],a=this.viewer.viewport.viewportToImageCoordinates(e),c={x:a.x,y:a.y};if(this.isPointInPolygon(c,o))r=1;else{const h=this.calculateDistanceToPolygon(c,o),d=this.getHotspotBounds(this.state.selectedHotspot),l=(d.width+d.height)/2,p=h/l,f=.1,m=.3;p<=f?r=1:p>=m?r=0:r=1-(p-f)/(m-f)}}return r<.1?r:Math.min(n,r)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const c=e[o][0],h=e[o][1],d=e[a][0],l=e[a][1];h>n!=l>n&&i<(d-c)*(n-h)/(l-h)+c&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const c=e.x+a*n,h=e.y+a*r;return Math.sqrt(Math.pow(t.x-c,2)+Math.pow(t.y-h,2))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t);this.calculateZunicRosinConvexity(t);const i=this.calculateDiscreteRoughness(t);let n=0;return i.maxCurvature>10&&(n=Math.max(n,.5)),(e.aspectRatio>3||e.aspectRatio<.33)&&(n=Math.max(n,.4)),1+n*.1}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const c=o-n,h=a-r;return[n+c*e,r+h*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class ll{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.85,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.25,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.zoomConfig={fadeStartZoom:2,fadeEndZoom:4,minCoverageRatio:1,enableZoomFade:!1},this.useEllipse=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0},this.tuningParams={circleMultiplier:.22,ellipseMultiplierX:1.2,ellipseMultiplierY:1.15,gradientMultiplier:1.5,pixelRadiusMultiplier:1,adaptivePaddingMultiplier:1.3,offsetX:0,offsetY:0},window.safariTuning=this.tuningParams,this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.zoomUpdateTimeout=null,this.lastUpdateTime=0,this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.lastPositionUpdate=0,this.positionUpdateThrottle=16,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=100,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[c,h]=i,d=n*(a-h)-r*(o-c)+o*h-c*a;if(Math.abs(d)<1e-10)return this.minCircleTrivial([t,e]);const l=(n*n+r*r)*(h-a)+(o*o+a*a)*(r-h)+(c*c+h*h)*(a-r),p=(n*n+r*r)*(o-c)+(o*o+a*a)*(c-n)+(c*c+h*h)*(n-o),f=-l/(2*d),m=-p/(2*d),v=n-f,w=r-m,b=Math.sqrt(v*v+w*w);return{x:f,y:m,r:b}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonArea(t),r=i.width*i.height,o=n/r,a=this.calculateConvexHull(t),c=this.calculatePolygonArea(a),h=n/c;let d=1;return h<.6?d=1.4:o<.7?d=1.3:d=1.2,this.isMobile&&(d*=.8),e*d*this.tuningParams.adaptivePaddingMultiplier}calculateEllipseFromPolygon(t){var h,d;const e=((h=this.state.selectedHotspot)==null?void 0:h.id)||`${t.length}_${JSON.stringify(t.slice(0,3))}`;if(this.ellipseCache.has(e)){const l=this.ellipseCache.get(e);return this.useEllipse=l.useEllipse,l.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=i.width/i.height,r=(Math.max(i.width,i.height)-Math.min(i.width,i.height))/(i.width+i.height);let o=!1;if(n<=1.5&&r<=.3?o=!1:n>2||r>.5?o=!0:o=Math.abs(i.width-i.height)/Math.max(i.width,i.height)>.3,console.log("Shape decision:",{hotspotId:(d=this.state.selectedHotspot)==null?void 0:d.id,aspectRatio:n.toFixed(2),elongationIndex:r.toFixed(2),useEllipse:o}),!o)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const a=1.2,c={radiusX:i.width/2*a*this.tuningParams.ellipseMultiplierX,radiusY:i.height/2*a*this.tuningParams.ellipseMultiplierY,rotation:0,aspectRatio:n,centerX:i.centerX,centerY:i.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:c}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.ellipseCache.clear()},5e3),c}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],c=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const h=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);c*h<0&&e++}}return Math.min(e/(i*.5),1)}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height,o=this.calculateElongationIndex(n);return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,elongationIndex:o,vertexDensity:t.length/i}}calculateElongationIndex(t){const e=Math.max(t.width,t.height),i=Math.min(t.width,t.height);return(e-i)/(e+i)}calculateZoomAwareOpacity(t){if(!this.viewer||!this.zoomConfig.enableZoomFade)return t;const e=this.viewer.viewport.getZoom();if(e<=this.zoomConfig.fadeStartZoom)return t;if(e>=this.zoomConfig.fadeEndZoom)return 0;const i=this.zoomConfig.fadeEndZoom-this.zoomConfig.fadeStartZoom,n=(e-this.zoomConfig.fadeStartZoom)/i,r=1-Math.pow(1-n,2);return t*(1-r)}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement)),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}applyInitialStyles(){const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"block",visibility:"hidden","-webkit-mask-image":this.createGradientMask(50,50,0,0),"mask-image":this.createGradientMask(50,50,0,0),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const l=o.radiusX*n*this.tuningParams.ellipseMultiplierX,p=o.radiusY*n*this.tuningParams.ellipseMultiplierY,m=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(v=>{const w=l*v.position,b=p*v.position,I=(w+b)/2;return`rgba(0,0,0,${v.opacity}) ${I*this.tuningParams.gradientMultiplier}px`}).join(", ");return`radial-gradient(ellipse ${l*this.tuningParams.gradientMultiplier}px ${p*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%, 
        rgba(0,0,0,0) 0px,
        ${m})`}const c=i*n*this.tuningParams.circleMultiplier,d=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(l=>{const p=c+c*this.tuningParams.gradientMultiplier*.8*l.position;return`rgba(0,0,0,${l.opacity}) ${p}px`}).join(", ");return`radial-gradient(circle ${c*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%,
    rgba(0,0,0,0) 0px,
    rgba(0,0,0,0) ${c}px,
    ${d})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&(this.cachedViewportRect=null,this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.zoomUpdateTimeout=setTimeout(()=>{this.checkAutoDeselect()},100))}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&!this.animationFrame&&this.startAnimation()}),this.resizeHandler=()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()},window.addEventListener("resize",this.resizeHandler)}selectHotspot(t){var e,i;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(e=this.state.selectedHotspot)==null?void 0:e.id}),((i=this.state.selectedHotspot)==null?void 0:i.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.overlayElement&&(this.overlayElement.style.display="block",this.overlayElement.style.visibility="visible"),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,setTimeout(()=>{this.trackFocusReference()},800),console.log("Starting animation..."),this.startAnimation()):(console.log("Deselecting hotspot"),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation())}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;if(this.isUpdatingPosition){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,requestAnimationFrame(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()}));return}const t=performance.now();if(t-this.lastPositionUpdate<this.positionUpdateThrottle){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,setTimeout(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()},this.positionUpdateThrottle-(t-this.lastPositionUpdate)));return}this.isUpdatingPosition=!0,this.lastPositionUpdate=t;try{const e=this.state.selectedHotspot,i=this.getPerformanceMode();let n="full",r;if(i==="reduced"){const w=e.shape==="polygon"?e.coordinates:e.coordinates[0],b=this.simplifyPolygon(w,.5),I={...e,coordinates:e.shape==="polygon"?b:[b]};r=this.calculateSpotlightGeometry(I),n="simplified"}else r=this.calculateSpotlightGeometry(e);(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t);const o=this.cachedViewportRect,a=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(r.center.x,r.center.y)),c=this.viewer.viewport.viewportToWindowCoordinates(a);console.log("Coordinate conversion debug:",{imageCenter:r.center,viewportPoint:{x:a.x,y:a.y},windowPoint:{x:c.x,y:c.y},viewerSize:{width:this.viewer.container.clientWidth,height:this.viewer.container.clientHeight}});const h=c.x/o.width*100+this.tuningParams.offsetX,d=c.y/o.height*100+this.tuningParams.offsetY;this.state.targetPosition={x:h,y:d};const l=this.viewer.world.getItemAt(0).getContentSize(),p=r.radius/l.x,f=this.viewer.viewport.getZoom(),m=p*o.width*f,v=this.getHotspotBounds(e);if(v){const w=v.width/l.x*o.width*f,b=v.height/l.y*o.height*f,O=Math.max(w,b)/2*this.zoomConfig.minCoverageRatio;this.state.targetRadius=Math.max(O,m*this.tuningParams.pixelRadiusMultiplier)}else this.state.targetRadius=Math.max(80,Math.min(400,m*this.tuningParams.pixelRadiusMultiplier));if(console.log("Zoom-aware radius:",{currentZoom:f.toFixed(2),targetRadius:this.state.targetRadius.toFixed(0),willFade:f>this.zoomConfig.fadeStartZoom}),r.ellipseData){const w=r.ellipseData.radiusX/l.x*o.width*f,b=r.ellipseData.radiusY/l.y*o.height*f;this.useEllipse||(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:r.ellipseData.rotation}),this.ellipseData.targetRadiusX=w,this.ellipseData.targetRadiusY=b,this.ellipseData.rotation=r.ellipseData.rotation,this.useEllipse=!0}else this.useEllipse&&(this.ellipseData.targetRadiusX=this.state.targetRadius,this.ellipseData.targetRadiusY=this.state.targetRadius),this.useEllipse=!1;console.log("Spotlight position debug:",{hotspotId:e.id,hotspotCenter:r.center,windowPoint:c,viewportRect:{width:o.width,height:o.height},percentages:{x:h,y:d},radius:{geometric:r.radius,inViewport:p,inPixels:m,final:this.state.targetRadius},currentState:{x:this.state.currentPosition.x,y:this.state.currentPosition.y,radius:this.state.currentRadius},ellipseData:this.ellipseData,useEllipse:this.useEllipse,geometryQuality:n}),this.aspectRatio=r.aspectRatio,this.state.isAnimating?this.animationFrame||this.startAnimation():(this.state.currentPosition={...this.state.targetPosition},this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0&&(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY),this.applySpotlightStyles())}finally{this.isUpdatingPosition=!1}}invalidateViewportCache(){this.cachedViewportRect=null,this.viewportRectCacheTime=0}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateEllipseFromPolygon(e);if(n&&this.useEllipse)return{center:{x:n.centerX,y:n.centerY},radius:Math.max(n.radiusX,n.radiusY),aspectRatio:n.aspectRatio,bounds:i,ellipseData:n,useEllipse:!0};{const r=this.calculateMinimumEnclosingCircle(e);r.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),r.r=Math.max(i.width,i.height)/2);const o=this.calculateAdaptivePadding(e,r.r);return{center:{x:r.x,y:r.y},radius:r.r+o,aspectRatio:i.width/i.height,bounds:i,ellipseData:null,useEllipse:!1}}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let h=0,d=o-1;h<o;d=h++){const l=e[h][0],p=e[h][1],f=e[d][0],m=e[d][1],v=l*m-f*p;i+=v,n+=(l+f)*v,r+=(p+m)*v}i*=.5;const a=n/(6*i),c=r/(6*i);if(!isFinite(a)||!isFinite(c)){let h=0,d=0;return e.forEach(([l,p])=>{h+=l,d+=p}),{x:h/e.length,y:d/e.length}}return{x:a,y:c}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||this.isUpdatingPosition)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<2e3)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return console.log("calculateFocusScore: Missing data, returning 1.0"),1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new nt.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y));if(this.useEllipse&&this.ellipseData){const a=this.viewer.world.getItemAt(0).getContentSize();this.viewer.container.getBoundingClientRect(),this.viewer.viewport.getZoom();const c=this.ellipseData.radiusX/a.x,h=this.ellipseData.radiusY/a.y,d=this.calculateEllipseDistance(o.x,o.y,e.x,e.y,c,h,this.ellipseData.rotation),l=.5,p=.2;d<=l?r=1:d>=l+p?r=0:r=1-(d-l)/p}else{const a=e.x-o.x,c=e.y-o.y,h=Math.sqrt(a*a+c*c),d=.01,l=.02;h<=d?r=1:h>=d+l?r=0:r=1-(h-d)/l}}return r<.1?r:i>=.8&&r>.9?1:Math.min(n,r)}calculateEllipseDistance(t,e,i,n,r,o,a){const c=a*Math.PI/180,h=Math.cos(c),d=Math.sin(c),l=i-t,p=n-e,f=l*h+p*d,m=-l*d+p*h;return Math.sqrt(f*f/(r*r)+m*m/(o*o))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,this.overlayElement&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block"),this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity*this.config.maxOpacity,i=this.calculateZoomAwareOpacity(e),n=i-this.state.opacity,r=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(n)>.001?(this.state.opacity+=n*r,this.state.opacity=Math.max(0,Math.min(this.config.maxOpacity,this.state.opacity))):this.state.opacity=i;const o=this.state.targetScale-this.state.scale;Math.abs(o)>.01?this.state.scale+=o*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const a=this.state.targetPosition.x-this.state.currentPosition.x,c=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(a)>.1||Math.abs(c)>.1?(this.state.currentPosition.x+=a*this.config.positionSpeed,this.state.currentPosition.y+=c*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const h=this.state.targetRadius-this.state.currentRadius;if(Math.abs(h)>1?this.state.currentRadius+=h*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const l=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,p=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(l)>1||Math.abs(p)>1?(this.ellipseData.radiusX+=l*this.config.radiusSpeed,this.ellipseData.radiusY+=p*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(n)<=.001&&Math.abs(a)<=.1&&Math.abs(c)<=.1&&Math.abs(h)<=1&&Math.abs(o)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&(this.overlayElement.style.visibility="visible"),this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none"),e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none",this.overlayElement.style.visibility="hidden")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}forceRecalculation(){this.state.selectedHotspot&&(this.ellipseCache.clear(),this.updateSpotlightPosition(),!this.state.isAnimating&&this.applySpotlightStyles())}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.cachedViewportRect=null,this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const c=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=c,t.style.webkitMaskImage=c,o++,requestAnimationFrame(a)}else{const c=performance.now()-r,h=o/c*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${h.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){if(!(!this.state.selectedHotspot||!this.useEllipse)&&window.performanceMonitor){const t=window.performanceMonitor.getMetrics();t.averageFPS<45&&this.useEllipse&&(console.warn("Disabling ellipses due to low FPS:",t.averageFPS),this.useEllipse=!1,this.config.useEllipse=!1,setTimeout(()=>{this.config.useEllipse=!0},1e4))}}}class Oi{static create(t){const e=this.detectBrowser();return console.log("Browser detection:",{isSafari:e.isSafari,isIOS:e.isIOS,isWebKit:e.isWebKit,userAgent:navigator.userAgent}),e.isSafari||e.isIOS?(console.log("Using SafariOverlayManager for WebKit-based browser"),new ll(t)):(console.log("Using CSSOverlayManager (default)"),new al(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r=n&&!i&&/Mac/.test(e),o="WebkitAppearance"in document.documentElement.style&&!window.chrome,a=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:o,isIOSChrome:a,isMacOSSafari:r,isWebKitBased:n||i||a}}static setPreference(t){return t==="css"||t==="safari"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css' or 'safari'.`),!1)}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t){const e=this.getCurrentType();return e==="safari"?(console.log("Creating SafariOverlayManager (forced)"),new ll(t)):e==="css"?(console.log("Creating CSSOverlayManager (forced)"),new al(t)):this.create(t)}}var Ed=j('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),Sd=j('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),Pd=j('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),Cd=j('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),Ad=j('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),Rd=j('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),Id=j('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),Md=j("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),Dd=j('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+←)">'),kd=j('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+→)">'),Od=j("<input type=range class=volume-slider min=0 max=100>"),Fd=j("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+←→: Skip</span><span>M: Mute</span><span>Esc: Minimize"),Ld=j('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),Vd=j("<div>");const cl=()=>Ed(),hl=()=>Sd(),Bd=()=>Pd(),Hd=()=>Cd(),Nd=()=>Ad(),zd=()=>Rd(),Ud=()=>Id();function jd(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=he(!0),[r,o]=he(!1),[a,c]=he(0),[h,d]=he(0),[l,p]=he(0),[f,m]=he(80),[v,w]=he(!1),[b,I]=he(!1),[O,N]=he(!0),[q,ie]=he(!1);nn(()=>{e()&&r()&&i()&&(ie(!0),setTimeout(()=>ie(!1),500))});const k=()=>window.innerWidth<=768;nn(()=>{t&&(t.onProgress=J=>{b()||(c(J.percent),d(J.current),p(J.duration))},t.onPlaybackStart=()=>{o(!0),i()&&O()?(n(!1),N(!1)):i()||N(!1)},t.onPlaybackEnd=()=>{o(!1),c(0),d(0)},t.setVolume(f()/100))}),nn(()=>{const J=$=>{if(e()&&$.target.tagName!=="INPUT")switch($.key){case" ":i()||($.preventDefault(),S());break;case"ArrowLeft":$.shiftKey&&!i()&&($.preventDefault(),D());break;case"ArrowRight":$.shiftKey&&!i()&&($.preventDefault(),E());break;case"m":case"M":i()||L();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",J),an(()=>window.removeEventListener("keydown",J))}),nn(()=>{if(t){const J=t.getState();o(J.isPlaying),w(J.isMuted)}});const S=()=>{!t||!e()||(r()?t.pause():t.resume())},E=()=>{t&&t.skip(15)},D=()=>{t&&t.skip(-15)},L=()=>{if(!t)return;const J=t.toggleMute();w(J)},F=J=>{if(!t)return;const $=J.currentTarget.getBoundingClientRect(),oe=(J.clientX-$.left)/$.width*100;t.seekToPercent(oe),c(oe)},A=J=>{if(!b())return;const $=J.currentTarget.getBoundingClientRect(),oe=Math.max(0,Math.min(100,(J.clientX-$.left)/$.width*100));c(oe)},V=()=>{b()&&t&&(t.seekToPercent(a()),I(!1))},ne=J=>{const $=parseInt(J.target.value);m($),t&&(t.setVolume($/100),$>0&&v()&&(t.toggleMute(),w(!1)))},ce=J=>{if(!J||isNaN(J))return"0:00";const $=Math.floor(J/60),oe=Math.floor(J%60);return`${$}:${oe.toString().padStart(2,"0")}`},G=()=>{const J=e();return J?J.narrationTitle||`Hotspot ${J.id}`:""};return ye(Ne,{get when(){return e()},get children(){var J=Vd();return J.addEventListener("mouseleave",V),J.$$mouseup=V,se(J,ye(Ne,{get when(){return i()},get children(){var $=Md(),oe=$.firstChild,Oe=oe.nextSibling,we=Oe.firstChild;return oe.$$click=()=>{r()?S():n(!1)},se(oe,(()=>{var W=Ct(()=>!!r());return()=>W()?ye(hl,{}):ye(cl,{})})()),se(we,G),je(W=>{var _e=`btn-play-mini ${r()?"playing":""} ${q()?"changing":""}`,ze=r()?"Pause":"Play";return _e!==W.e&&Tt(oe,W.e=_e),ze!==W.t&&Zt(oe,"title",W.t=ze),W},{e:void 0,t:void 0}),$}}),null),se(J,ye(Ne,{get when(){return!i()},get children(){var $=Ld(),oe=$.firstChild,Oe=oe.firstChild,we=Oe.nextSibling,W=oe.nextSibling,_e=W.firstChild,ze=_e.nextSibling,gt=ze.firstChild,Le=gt.firstChild,vt=Le.nextSibling,ht=ze.nextSibling,yt=W.nextSibling,at=yt.firstChild,rt=at.firstChild,ut=at.nextSibling,dt=ut.firstChild;return se(Oe,G),we.$$click=()=>n(!0),se(we,ye(Ud,{})),se(_e,()=>ce(h())),ze.$$mousemove=A,ze.$$mousedown=()=>I(!0),ze.$$click=F,se(ht,()=>ce(l())),se(at,ye(Ne,{get when(){return!k()},get children(){var ge=Dd();return ge.$$click=D,se(ge,ye(Bd,{})),ge}}),rt),rt.$$click=S,se(rt,ye(Ne,{get when(){return!r()},get children(){return ye(cl,{})}}),null),se(rt,ye(Ne,{get when(){return r()},get children(){return ye(hl,{})}}),null),se(at,ye(Ne,{get when(){return!k()},get children(){var ge=kd();return ge.$$click=E,se(ge,ye(Hd,{})),ge}}),null),dt.$$click=L,se(dt,ye(Ne,{get when(){return Ct(()=>!v())()&&f()>0},get children(){return ye(Nd,{})}}),null),se(dt,ye(Ne,{get when(){return v()||f()===0},get children(){return ye(zd,{})}}),null),se(ut,ye(Ne,{get when(){return!k()},get children(){var ge=Od();return ge.$$input=ne,je(()=>Zt(ge,"title",`Volume: ${f()}%`)),je(()=>ge.value=f()),ge}}),null),se($,ye(Ne,{when:!1,get children(){return Fd()}}),null),je(ge=>{var Je=`${a()}%`,y=`${a()}%`,R=`btn-play ${r()?"playing":""}`,B=r()?"Pause (Space)":"Play (Space)",K=v()?"Unmute (M)":"Mute (M)";return Je!==ge.e&&((ge.e=Je)!=null?Le.style.setProperty("width",Je):Le.style.removeProperty("width")),y!==ge.t&&((ge.t=y)!=null?vt.style.setProperty("left",y):vt.style.removeProperty("left")),R!==ge.a&&Tt(rt,ge.a=R),B!==ge.o&&Zt(rt,"title",ge.o=B),K!==ge.i&&Zt(dt,"title",ge.i=K),ge},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),$}}),null),je(()=>Tt(J,`audio-player ${i()?"minimized":""} ${k()?"mobile":"desktop"}`)),J}})}hn(["mouseup","click","mousedown","mousemove","input"]);var qd=j('<div><button><svg class=media-button-icon width=16 height=16 viewBox="0 0 16 16"fill=none><path d="M2 4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4Z"stroke=currentColor stroke-width=1.5></path><circle cx=8 cy=8 r=2.5 stroke=currentColor stroke-width=1.5></circle><path d="M2 11L5 8L7 10L10 7L14 11"stroke=currentColor stroke-width=1.5 stroke-linecap=round stroke-linejoin=round></path></svg><span class=media-button-text>');function Wd(s){const{hotspotId:t,onClick:e,isVisible:i=!0,position:n={x:0,y:0},isMobile:r=!1}=s,[o,a]=he(!1),[c,h]=he(!1),d=()=>"View Image",l=p=>{p.stopPropagation(),h(!0),e&&e(t),setTimeout(()=>h(!1),300)};return ye(Ne,{when:i,get children(){var p=qd(),f=p.firstChild,m=f.firstChild,v=m.nextSibling;return Tt(p,`media-button-container ${r?"mobile":"desktop"}`),f.addEventListener("mouseleave",()=>a(!1)),f.addEventListener("mouseenter",()=>a(!0)),f.$$click=l,se(v,d),je(w=>{var b=`media-button ${o()?"hovered":""} ${c()?"clicked":""}`,I=d();return b!==w.e&&Tt(f,w.e=b),I!==w.t&&Zt(f,"title",w.t=I),w},{e:void 0,t:void 0}),p}})}hn(["click"]);var Gd=j("<h3 class=modal-title>"),Zd=j('<div class=modal-overlay-backdrop><div><button class=modal-close-button title="Close (Esc)"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M18 6L6 18M6 6l12 12"stroke=currentColor stroke-width=2 stroke-linecap=round></path></svg></button><div class=modal-image-container><img class=modal-image loading=lazy>',!0,!1,!1);function Xd(s){const{imageUrl:t,isVisible:e,onClose:i,hotspotTitle:n}=s,r=o=>{o.target===o.currentTarget&&i()};return ye(Ne,{when:e,get children(){var o=Zd(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=h.firstChild;return o.$$click=r,Fc(c,"click",i),se(a,ye(Ne,{when:n,get children(){var l=Gd();return se(l,n),l}}),h),Zt(d,"src",t),Zt(d,"alt",n||"Hotspot image"),je(()=>Tt(a,`modal-overlay-content ${s.isLoading?"loading":""} ${s.hasError?"error":""}`)),o}})}hn(["click"]);function Yd(s){const{imageOverlayManager:t,currentHotspot:e}=s,[i,n]=he(!1),[r,o]=he(null),[a,c]=he("modal"),[h,d]=he(!1),[l,p]=he(!1);let f=null,m=null;Fs(()=>{t&&(f=(w,b)=>{console.log("Opening overlay for:",w);const I=b.imageUrls[0];I&&(o(I),c(b.displayMode||"modal"),d(!0),p(!1),n(!0),t.getImage(I)?d(!1):t.loadImage(I,w).then(()=>d(!1)).catch(()=>{p(!0),d(!1)}))},m=()=>{n(!1),o(null),t.closeOverlay()},t.onOverlayOpen=f,t.onOverlayClose=m,an(()=>{t&&(t.onOverlayOpen=null,t.onOverlayClose=null)}))}),nn(()=>{if(!i())return;document.body.classList.add("modal-open");const w=b=>{b.key==="Escape"&&v()};window.addEventListener("keydown",w),an(()=>{window.removeEventListener("keydown",w),document.body.classList.remove("modal-open")})});const v=()=>{m&&m()};return ye(Ne,{get when(){return Ct(()=>a()==="modal")()&&i()},get children(){return ye(Xd,{get imageUrl(){return r()},isVisible:!0,onClose:v,get hotspotTitle(){var w;return((w=e==null?void 0:e())==null?void 0:w.title)||"Image"},get isLoading(){return h()},get hasError(){return l()}})}})}const Te={viewer:{imageLoaderLimit:4,maxImageCacheCount:2e3,minPixelRatio:.5,minZoomImageRatio:.5,smoothTileEdgesMinZoom:3,alwaysBlend:!0,immediateRender:!1,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:1,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:null,animationTime:.3,springStiffness:6,blendTime:.18,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.2,zoomPerClick:2,minZoomLevel:.5,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:6,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:6,tileRetryMax:1,tileRetryDelay:100,minimumPixelsPerTile:12,compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},hotspots:{batchSize:50,visibilityCheckInterval:100,renderDebounceTime:16,maxVisibleHotspots:100,minZoomForHotspots:3},viewport:{updateDebounce:8},memory:{maxCachedImages:300,criticalMemoryThreshold:200},network:{maxConcurrentRequests:6},mobile:{maxImageCacheCount:50,imageLoaderLimit:2,animationTime:.2,springStiffness:12,immediateRender:!1,blendTime:.1,maxTilesPerFrame:3,minPixelRatio:.5,minZoomImageRatio:.9,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!0,preserveImageSizeOnResize:!1,maxZoomPixelRatio:2},debug:{warnThreshold:{fps:45}}},Qd=()=>{var e;const s=navigator.userAgent.toLowerCase(),t=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(s),isChrome:/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),isFirefox:/firefox|fxios/i.test(s),isEdge:/edge|edg/i.test(s),isIOS:/ipad|iphone|ipod/.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(s),isMac:/mac/.test(t),isWindows:/win/.test(t),isMobile:/android|iphone|ipad|ipod/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((e=navigator.connection)==null?void 0:e.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},Kd=()=>{const s=Qd();return(s.isSafari||s.isIOS)&&(Te.viewer.drawer="canvas",Te.viewer.maxImageCacheCount=200,console.log("Safari/iOS detected - forcing canvas drawer and limiting cache")),s.isAndroid&&(Te.viewer.drawer="canvas",console.log("Android detected - forcing canvas drawer for compatibility")),s.isMobile&&(Object.assign(Te.viewer,{drawer:"canvas",imageLoaderLimit:Te.mobile.imageLoaderLimit,maxImageCacheCount:Te.mobile.maxImageCacheCount,animationTime:Te.mobile.animationTime,springStiffness:Te.mobile.springStiffness,immediateRender:Te.mobile.immediateRender,blendTime:Te.mobile.blendTime,smoothImageZoom:!1,maxTilesPerFrame:Te.mobile.maxTilesPerFrame,visibilityRatio:Te.mobile.visibilityRatio,minPixelRatio:Te.mobile.minPixelRatio,minZoomImageRatio:Te.mobile.minZoomImageRatio,smoothTileEdgesMinZoom:Te.mobile.smoothTileEdgesMinZoom,alwaysBlend:Te.mobile.alwaysBlend,preserveImageSizeOnResize:Te.mobile.preserveImageSizeOnResize,maxZoomPixelRatio:Te.mobile.maxZoomPixelRatio,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),Te.hotspots.batchSize=25,Te.hotspots.maxVisibleHotspots=50,Te.hotspots.renderDebounceTime=32,Te.memory.maxCachedImages=50,console.log("Mobile device detected - applied aggressive performance optimizations")),s.isLowEndDevice&&(Te.viewer.animationTime=.2,Te.viewer.springStiffness=12,Te.viewer.maxImageCacheCount=Math.min(150,Te.viewer.maxImageCacheCount),Te.viewer.imageLoaderLimit=2,Te.viewer.maxTilesPerFrame=2,Te.memory.maxCachedImages=150,Te.network.maxConcurrentRequests=3,Te.hotspots.maxVisibleHotspots=50,Te.viewer.minPixelRatio=.7,console.log("Low-end device detected - reduced resource usage but maintained quality settings")),s.isHighEndDevice&&!s.isMobile&&(Te.viewer.maxImageCacheCount=800,Te.viewer.imageLoaderLimit=8,Te.viewer.maxTilesPerFrame=6,Te.memory.maxCachedImages=500,Te.network.maxConcurrentRequests=8,Te.viewer.minPixelRatio=.4,Te.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - increased resource limits and quality")),s.isHighDPI&&!s.isMobile&&(Te.viewer.minPixelRatio=Math.min(.5,Te.viewer.minPixelRatio),Te.viewer.maxZoomPixelRatio=Math.max(4,s.pixelRatio*2)),(s.connectionType==="slow-2g"||s.connectionType==="2g")&&(Te.viewer.imageLoaderLimit=1,Te.network.maxConcurrentRequests=2,Te.viewer.timeout=12e4,console.log("Slow connection detected - reduced concurrent requests")),s},co=Kd();function Jd(s,t){const e=Te;if(s<20&&s>0)return e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.animationTime=.1,e.viewer.springStiffness=15,e.viewer.immediateRender=!0,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=50,e.viewer.minPixelRatio=.8,console.error("Emergency performance mode activated"),"emergency";if(s<30&&s>0)return e.viewer.imageLoaderLimit=2,e.viewer.maxTilesPerFrame=2,e.viewer.animationTime=.2,e.viewer.springStiffness=12,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=100,e.viewer.minPixelRatio=.7,console.warn("Critical performance mode activated"),"critical";if(s<45&&s>0)return e.viewer.imageLoaderLimit=Math.max(3,e.viewer.imageLoaderLimit-1),e.viewer.maxTilesPerFrame=Math.max(3,e.viewer.maxTilesPerFrame-1),"reduced";if(s>55){const i=co.isHighEndDevice?8:co.isMobile?2:6;return e.viewer.imageLoaderLimit<i&&(e.viewer.imageLoaderLimit=Math.min(i,e.viewer.imageLoaderLimit+1)),e.viewer.maxTilesPerFrame<4&&(e.viewer.maxTilesPerFrame=Math.min(4,e.viewer.maxTilesPerFrame+1)),e.viewer.minPixelRatio=co.isMobile?.8:.5,"normal"}return t>e.memory.criticalMemoryThreshold?(e.viewer.maxImageCacheCount=Math.max(50,Math.floor(e.viewer.maxImageCacheCount*.5)),console.warn(`High memory usage: ${t}MB - Reduced cache to ${e.viewer.maxImageCacheCount}`),"memory-limited"):"normal"}const $d=(s,t,e,i,n=null)=>(i&&(s.animationTime=.2,s.springStiffness=12,s.blendTime=0,s.immediateRender=!0,s.imageLoaderLimit=2,s.maxImageCacheCount=50,s.visibilityRatio=1,s.maxTilesPerFrame=2),{tileSources:n||t,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:e,imageSmoothingEnabled:s.imageSmoothingEnabled,smoothTileEdgesMinZoom:s.smoothTileEdgesMinZoom,alwaysBlend:s.alwaysBlend,placeholderFillStyle:s.placeholderFillStyle,opacity:1,preload:s.preload,compositeOperation:s.compositeOperation,...s.drawer==="webgl"?{webglOptions:s.webglOptions}:{},immediateRender:s.immediateRender,imageLoaderLimit:s.imageLoaderLimit,maxImageCacheCount:s.maxImageCacheCount,timeout:s.timeout,loadTilesWithAjax:s.loadTilesWithAjax,ajaxHeaders:s.ajaxHeaders,visibilityRatio:s.visibilityRatio,minPixelRatio:s.minPixelRatio,defaultZoomLevel:s.defaultZoomLevel,minZoomLevel:s.minZoomLevel,maxZoomPixelRatio:s.maxZoomPixelRatio,constrainDuringPan:s.constrainDuringPan,wrapHorizontal:s.wrapHorizontal,wrapVertical:s.wrapVertical,animationTime:s.animationTime,springStiffness:s.springStiffness,blendTime:s.blendTime,zoomPerScroll:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:s.flickEnabled,flickMinSpeed:s.flickMinSpeed,flickMomentum:s.flickMomentum,pinchToZoom:!0,dragToPan:!0},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:s.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:s.preserveImageSizeOnResize,maxTilesPerFrame:s.maxTilesPerFrame,smoothImageZoom:s.smoothImageZoom,subPixelRendering:!1,minimumPixelsPerTile:s.minimumPixelsPerTile||12}),ep=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream;if(/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||t||e)return console.log("Mobile/Safari detected - forcing canvas drawer for performance"),"canvas";const n=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),r=/firefox|fxios/i.test(s);return n||r?(console.log("Desktop Chrome/Firefox detected - using webgl drawer"),"webgl"):(console.log("Default browser detected - using canvas drawer"),"canvas")},He=()=>{const s=navigator.userAgent.toLowerCase();if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(s))return!0;const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<=768;return e&&i},tp=(s,t,e)=>{let i;if(s.coordinates){let b=1/0,I=1/0,O=-1/0,N=-1/0;(ie=>{Array.isArray(ie[0])&&typeof ie[0][0]=="number"?ie.forEach(([k,S])=>{b=Math.min(b,k),I=Math.min(I,S),O=Math.max(O,k),N=Math.max(N,S)}):ie.forEach(k=>{k.forEach(([S,E])=>{b=Math.min(b,S),I=Math.min(I,E),O=Math.max(O,S),N=Math.max(N,E)})})})(s.coordinates),i={minX:b,minY:I,maxX:O,maxY:N}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new nt.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new nt.Point(i.maxX,i.maxY)),a=o.x-r.x,c=o.y-r.y,h=r.x+a/2,d=r.y+c/2,l=t.viewport.getAspectRatio(),p=a/c,f=e?.85:.8;let m,v;p>l?(m=a/f,v=m/l):(v=c/f,m=v*l);const w=new nt.Rect(h-m/2,d-v/2,m,v);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:h,y:d},dimensions:{width:m,height:v},aspectRatios:{hotspot:p.toFixed(2),viewport:l.toFixed(2)},paddingFactor:f,zoomBounds:w}),w};var ip=j("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>Hovered</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Selected</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Type</span><span class=debug-stat-value>"),np=j("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>FPS</span><span class=debug-stat-value><span style=opacity:0.7;font-size:10px> (avg: <!>)</span></span></div><div class=debug-stat-row><span class=debug-stat-label>Status</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Memory</span><span class=debug-stat-value>MB</span></div><div class=debug-stat-row><span class=debug-stat-label>Frame Time</span><span class=debug-stat-value>ms</span></div><div class=debug-stat-row><span class=debug-stat-label>Zoom</span><span class=debug-stat-value>x"),rp=j("<div class=debug-control><label class=debug-control-label>Animation Speed<span class=debug-control-value>x</span></label><input type=range class=debug-slider min=0.5 max=2.5 step=0.1><p class=debug-control-description>How fast the artwork zooms when you click on elements"),sp=j('<div class=debug-control><label class=debug-control-label>Color Theme<span class=debug-help-icon title="Changes the highlight colors">?</span></label><div class=debug-toggle-group><button type=button>Cyan Tech</button><button type=button>Golden Magic</button><button type=button>Blue Moon</button></div><div class=debug-toggle-group style=margin-top:8px;><button type=button>Pure White</button><button type=button>Soft White</button><button type=button>Dark Mode'),op=j("<div class=debug-control><label class=debug-control-label>Interaction Style</label><div class=debug-toggle-group><div>Instant Click</div><div>Hold & Release</div></div><p class=debug-control-description>"),ap=j("<div class=debug-control><label class=debug-control-label>Activation</label><p class=debug-control-description>Press <strong>H</strong> key (desktop) or <strong>triple-tap</strong> (mobile)"),lp=j("<div class=debug-control><label class=debug-control-label>Visual Style</label><div class=debug-toggle-group><button type=button>Black Outline</button><button type=button>White Pulse"),cp=j("<span class=debug-mobile-compact-fps> FPS"),hp=j("<div class=debug-mobile-compact><div class=debug-mobile-compact-content><span class=debug-mobile-compact-icon>⚙️</span><span class=debug-mobile-compact-label>Debug"),up=j("<div><div><div class=debug-mobile-sheet-handle><div class=debug-mobile-sheet-handle-bar></div></div><div class=debug-mobile-sheet-header><h3 class=debug-mobile-sheet-title><span>⚙️</span>Artwork Controls</h3></div><div></div><div class=debug-mobile-content>"),dp=j("<button><span class=debug-mobile-tab-icon style=font-size:18px;></span><span class=debug-mobile-tab-label>"),pp=j("<span style=margin-left:8px;>Artwork Controls"),fp=j('<button title="Minimize panel"><svg viewBox="0 0 20 20"><rect x=11 y=15 width=14 height=2>'),mp=j("<div class=debug-panel><div class=debug-panel-header><h3 class=debug-panel-title style=margin:0;><span>⚙️"),gp=j("<div><div class=debug-section-header><div class=debug-section-title><span class=debug-section-icon></span><span></span></div><span class=debug-section-chevron>▼</span></div><div class=debug-section-content><div class=debug-section-body>");function vp(s){const[t,e]=he(!1),[i,n]=he({artwork:!0,performance:!1,visual:!1,navigation:!1,reveal:!1}),[r,o]=he({x:null,y:null}),[a,c]=he(!1),[h,d]=he({x:0,y:0,elementX:0,elementY:0}),[l,p]=he(!1),[f,m]=he(0),[v,w]=he(!1),b=()=>{w(!0),setTimeout(()=>{p(!1),w(!1)},300)};let I,O=0,N=0;const q=A=>{O=A.touches[0].clientY,N=0},ie=A=>{if(!l()||!I)return;const ne=A.touches[0].clientY-O;ne>0&&(N=ne,I.style.transform=`translateY(${ne}px)`)},k=()=>{I&&(N>100&&b(),I.style.transform="",N=0)},S=[{id:"artwork",icon:"🔍",title:"Active Element",content:()=>(()=>{var A=ip(),V=A.firstChild,ne=V.firstChild,ce=ne.nextSibling,G=V.nextSibling,J=G.firstChild,$=J.nextSibling,oe=G.nextSibling,Oe=oe.firstChild,we=Oe.nextSibling;return se(ce,()=>{var W;return((W=s.hoveredHotspot())==null?void 0:W.id)||"none"}),se($,()=>{var W;return((W=s.selectedHotspot())==null?void 0:W.id)||"none"}),se(we,()=>{var W,_e;return((W=s.hoveredHotspot())==null?void 0:W.type)||((_e=s.selectedHotspot())==null?void 0:_e.type)||"none"}),A})()},{id:"performance",icon:"📊",title:"Performance",content:()=>(()=>{var A=np(),V=A.firstChild,ne=V.firstChild,ce=ne.nextSibling,G=ce.firstChild,J=G.firstChild,$=J.nextSibling;$.nextSibling;var oe=V.nextSibling,Oe=oe.firstChild,we=Oe.nextSibling,W=oe.nextSibling,_e=W.firstChild,ze=_e.nextSibling,gt=ze.firstChild,Le=W.nextSibling,vt=Le.firstChild,ht=vt.nextSibling,yt=ht.firstChild,at=Le.nextSibling,rt=at.firstChild,ut=rt.nextSibling,dt=ut.firstChild;return se(ce,()=>{var ge,Je;return((Je=(ge=s.performanceMetrics)==null?void 0:ge.currentFPS)==null?void 0:Je.toFixed(0))||"60"},G),se(G,()=>{var ge;return((ge=s.performanceMetrics)==null?void 0:ge.averageFPS)||"60"},$),se(we,()=>{var ge;return((ge=s.performanceMetrics)==null?void 0:ge.performanceLevel)||"excellent"}),se(ze,()=>{var ge,Je;return((Je=(ge=s.performanceMetrics)==null?void 0:ge.memoryUsage)==null?void 0:Je.toFixed(0))||"0"},gt),se(ht,()=>{var ge;return((ge=s.performanceMetrics)==null?void 0:ge.frameTime)||"16.67"},yt),se(ut,()=>{var ge;return((ge=s.performanceMetrics)==null?void 0:ge.zoomLevel)||"1.00"},dt),je(ge=>{var K,re,me,X,Ce;var Je=(((K=s.performanceMetrics)==null?void 0:K.currentFPS)||60)<55?"#FF9800":"#4CAF50",y={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"}[((re=s.performanceMetrics)==null?void 0:re.performanceLevel)||"excellent"],R=(((me=s.performanceMetrics)==null?void 0:me.memoryUsage)||0)>250?"#FF9800":"#4CAF50",B=parseFloat(((X=s.performanceMetrics)==null?void 0:X.frameTime)||16.67)>33?"#F44336":parseFloat(((Ce=s.performanceMetrics)==null?void 0:Ce.frameTime)||16.67)>20?"#FF9800":"#4CAF50";return Je!==ge.e&&((ge.e=Je)!=null?ce.style.setProperty("color",Je):ce.style.removeProperty("color")),y!==ge.t&&((ge.t=y)!=null?we.style.setProperty("color",y):we.style.removeProperty("color")),R!==ge.a&&((ge.a=R)!=null?ze.style.setProperty("color",R):ze.style.removeProperty("color")),B!==ge.o&&((ge.o=B)!=null?ht.style.setProperty("color",B):ht.style.removeProperty("color")),ge},{e:void 0,t:void 0,a:void 0,o:void 0}),A})()},{id:"visual",icon:"🎨",title:"Visual Settings",content:()=>[(()=>{var A=rp(),V=A.firstChild,ne=V.firstChild,ce=ne.nextSibling,G=ce.firstChild,J=V.nextSibling;return se(ce,()=>s.zoomSpeed().toFixed(1),G),J.$$input=$=>s.setZoomSpeed(parseFloat($.target.value)),je(()=>J.value=s.zoomSpeed()),A})(),(()=>{var A=sp(),V=A.firstChild,ne=V.nextSibling,ce=ne.firstChild,G=ce.nextSibling,J=G.nextSibling,$=ne.nextSibling,oe=$.firstChild,Oe=oe.nextSibling,we=Oe.nextSibling;return ce.$$click=()=>{console.log("Setting palette to tech"),s.setPalette("tech")},G.$$click=()=>{console.log("Setting palette to enchantedJournal"),s.setPalette("enchantedJournal")},J.$$click=()=>{console.log("Setting palette to moonlitManuscript"),s.setPalette("moonlitManuscript")},oe.$$click=()=>{console.log("Setting palette to pureWhiteHigh"),s.setPalette("pureWhiteHigh")},Oe.$$click=()=>{console.log("Setting palette to pureWhiteBalanced"),s.setPalette("pureWhiteBalanced")},we.$$click=()=>{console.log("Setting palette to blackOnBlack"),s.setPalette("blackOnBlack")},je(W=>{var _e=`debug-toggle-option ${s.currentPalette()==="tech"?"active":""}`,ze=`debug-toggle-option ${s.currentPalette()==="enchantedJournal"?"active":""}`,gt=`debug-toggle-option ${s.currentPalette()==="moonlitManuscript"?"active":""}`,Le=`debug-toggle-option ${s.currentPalette()==="pureWhiteHigh"?"active":""}`,vt=`debug-toggle-option ${s.currentPalette()==="pureWhiteBalanced"?"active":""}`,ht=`debug-toggle-option ${s.currentPalette()==="blackOnBlack"?"active":""}`;return _e!==W.e&&Tt(ce,W.e=_e),ze!==W.t&&Tt(G,W.t=ze),gt!==W.a&&Tt(J,W.a=gt),Le!==W.o&&Tt(oe,W.o=Le),vt!==W.i&&Tt(Oe,W.i=vt),ht!==W.n&&Tt(we,W.n=ht),W},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),A})()]},{id:"navigation",icon:"🧭",title:"Click Behavior",content:()=>(()=>{var A=op(),V=A.firstChild,ne=V.nextSibling,ce=ne.firstChild,G=ce.nextSibling,J=ne.nextSibling;return ce.$$click=()=>s.setInteractionMode("direct"),G.$$click=()=>s.setInteractionMode("temporal"),se(J,()=>s.interactionMode()==="direct"?"Click/tap to immediately select and zoom":"Hold down to preview, release to activate"),je($=>{var oe=`debug-toggle-option ${s.interactionMode()==="direct"?"active":""}`,Oe=`debug-toggle-option ${s.interactionMode()==="temporal"?"active":""}`;return oe!==$.e&&Tt(ce,$.e=oe),Oe!==$.t&&Tt(G,$.t=Oe),$},{e:void 0,t:void 0}),A})()},{id:"reveal",icon:"👁️",title:"Hotspot Discovery",content:()=>[ap(),(()=>{var A=lp(),V=A.firstChild,ne=V.nextSibling,ce=ne.firstChild,G=ce.nextSibling;return ce.$$click=()=>s.setRevealStyle("invert"),G.$$click=()=>s.setRevealStyle("neon"),je(J=>{var $=`debug-toggle-option ${s.revealStyle()==="invert"?"active":""}`,oe=`debug-toggle-option ${s.revealStyle()==="neon"?"active":""}`;return $!==J.e&&Tt(ce,J.e=$),oe!==J.t&&Tt(G,J.t=oe),J},{e:void 0,t:void 0}),A})()]}];if(He()){const A=[{id:"visual",label:"Visual",icon:"🎨"},{id:"behavior",label:"Behavior",icon:"🎯"},{id:"reveal",label:"Reveal",icon:"👁️"}];return[(()=>{var V=hp(),ne=V.firstChild,ce=ne.firstChild;return ce.nextSibling,V.$$click=()=>p(!0),V.style.setProperty("position","fixed"),V.style.setProperty("bottom","20px"),V.style.setProperty("left","50%"),V.style.setProperty("transform","translateX(-50%)"),V.style.setProperty("zIndex","1000"),se(ne,ye(Ne,{get when(){var G;return(G=s.performanceMetrics)==null?void 0:G.currentFPS},get children(){var G=cp(),J=G.firstChild;return se(G,()=>{var $,oe;return(oe=($=s.performanceMetrics)==null?void 0:$.currentFPS)==null?void 0:oe.toFixed(0)},J),je($=>{var oe;return($=(((oe=s.performanceMetrics)==null?void 0:oe.currentFPS)||60)<45?"#FF9800":"#4CAF50")!=null?G.style.setProperty("color",$):G.style.removeProperty("color")}),G}}),null),je(G=>(G=l()?"none":"flex")!=null?V.style.setProperty("display",G):V.style.removeProperty("display")),V})(),ye(Ne,{get when(){return l()},get children(){var V=up(),ne=V.firstChild,ce=ne.firstChild,G=ce.nextSibling,J=G.firstChild,$=G.nextSibling,oe=$.nextSibling;V.$$click=we=>{we.target===we.currentTarget&&b()},ne.$$pointerdown=we=>we.stopPropagation(),ne.$$click=we=>we.stopPropagation(),ne.$$touchend=k,ne.$$touchmove=ie,ne.$$touchstart=q;var Oe=I;return typeof Oe=="function"?Lc(Oe,ne):I=ne,ne.style.setProperty("position","fixed"),ne.style.setProperty("bottom","0"),ne.style.setProperty("left","0"),ne.style.setProperty("right","0"),ne.style.setProperty("transform","translateY(0)"),ne.style.setProperty("transition","transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"),ne.style.setProperty("willChange","transform"),ne.style.setProperty("minHeight","75vh"),ne.style.setProperty("height","80vh"),ne.style.setProperty("display","flex"),ne.style.setProperty("flexDirection","column"),ce.style.setProperty("padding","8px"),G.style.setProperty("padding","12px 20px"),J.style.setProperty("fontSize","14px"),J.style.setProperty("margin","0"),$.style.setProperty("display","flex"),$.style.setProperty("padding","12px 20px"),$.style.setProperty("gap","20px"),$.style.setProperty("background","rgba(255, 255, 255, 0.02)"),$.style.setProperty("borderBottom","1px solid rgba(255, 255, 255, 0.06)"),$.style.setProperty("justifyContent","center"),$.style.setProperty("alignItems","center"),$.style.setProperty("width","100%"),$.style.setProperty("boxSizing","border-box"),$.style.setProperty("flexShrink","0"),se($,ye(_o,{each:A,children:(we,W)=>(()=>{var _e=dp(),ze=_e.firstChild,gt=ze.nextSibling;return _e.$$click=()=>m(W()),_e.style.setProperty("borderRadius","24px"),_e.style.setProperty("padding","10px 16px"),_e.style.setProperty("display","flex"),_e.style.setProperty("alignItems","center"),_e.style.setProperty("gap","12px"),_e.style.setProperty("fontSize","15px"),_e.style.setProperty("fontWeight","500"),_e.style.setProperty("whiteSpace","nowrap"),_e.style.setProperty("cursor","pointer"),_e.style.setProperty("transition","all 0.3s cubic-bezier(0.4, 0, 0.2, 1)"),_e.style.setProperty("minHeight","40px"),se(ze,()=>we.icon),se(gt,()=>we.label),je(Le=>{var vt=`debug-mobile-tab ${f()===W()?"active":""}`,ht=f()===W()?"rgba(255, 255, 255, 0.12)":"rgba(255, 255, 255, 0.04)",yt=`1px solid ${f()===W()?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.06)"}`,at=f()===W()?"white":"rgba(255, 255, 255, 0.6)",rt=f()===W()?"0 2px 8px rgba(255, 255, 255, 0.1)":"none",ut=f()===W()?"scale(1.02)":"scale(1)";return vt!==Le.e&&Tt(_e,Le.e=vt),ht!==Le.t&&((Le.t=ht)!=null?_e.style.setProperty("background",ht):_e.style.removeProperty("background")),yt!==Le.a&&((Le.a=yt)!=null?_e.style.setProperty("border",yt):_e.style.removeProperty("border")),at!==Le.o&&((Le.o=at)!=null?_e.style.setProperty("color",at):_e.style.removeProperty("color")),rt!==Le.i&&((Le.i=rt)!=null?_e.style.setProperty("boxShadow",rt):_e.style.removeProperty("boxShadow")),ut!==Le.n&&((Le.n=ut)!=null?_e.style.setProperty("transform",ut):_e.style.removeProperty("transform")),Le},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),_e})()})),oe.style.setProperty("flex","1"),oe.style.setProperty("overflowY","auto"),oe.style.setProperty("WebkitOverflowScrolling","touch"),oe.style.setProperty("padding","32px 24px 40px"),oe.style.setProperty("minHeight","300px"),se(oe,ye(Ku,{get children(){return[ye(so,{get when(){return f()===0},get children(){return[Ct(()=>S[2].content())," "]}}),ye(so,{get when(){return f()===1},get children(){return[Ct(()=>S[3].content())," "]}}),ye(so,{get when(){return f()===2},get children(){return[Ct(()=>S[4].content())," "]}})]}})),je(we=>{var W=`debug-mobile-backdrop ${v()?"closing":""}`,_e=`debug-mobile-sheet ${v()?"closing":"expanded"}`;return W!==we.e&&Tt(V,we.e=W),_e!==we.t&&Tt(ne,we.t=_e),we},{e:void 0,t:void 0}),V}})]}const E=A=>{if(!A.target.closest(".debug-panel-header")||t())return;A.preventDefault(),c(!0);const ne=A.currentTarget.getBoundingClientRect();d({x:A.clientX,y:A.clientY,elementX:r().x!==null?r().x:ne.left,elementY:r().y!==null?r().y:ne.top})},D=A=>{if(!a())return;const V=A.clientX-h().x,ne=A.clientY-h().y;o({x:h().elementX+V,y:h().elementY+ne})},L=()=>{c(!1)};Fs(()=>{document.addEventListener("mousemove",D),document.addEventListener("mouseup",L)}),an(()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",L)});const F=A=>{n(V=>({...V,[A]:!V[A]}))};return(()=>{var A=mp(),V=A.firstChild,ne=V.firstChild,ce=ne.firstChild;return A.addEventListener("mouseleave",G=>{t()&&(G.currentTarget.style.background="",G.currentTarget.style.borderColor="")}),A.addEventListener("mouseenter",G=>{t()&&(G.currentTarget.style.background="rgba(30, 30, 30, 0.98)",G.currentTarget.style.borderColor="rgba(255,255,255,0.2)")}),A.$$mousedown=E,V.$$click=()=>{t()&&e(!1)},ce.style.setProperty("display","inline-block"),ce.style.setProperty("transition","transform 0.3s"),se(ne,ye(Ne,{get when(){return!t()},get children(){return pp()}}),null),se(V,ye(Ne,{get when(){return!t()},get children(){var G=fp(),J=G.firstChild;return G.addEventListener("mouseleave",$=>{$.currentTarget.style.background="rgba(255,255,255,0.08)",$.currentTarget.style.borderColor="rgba(255,255,255,0.12)",$.currentTarget.style.color="rgba(255,255,255,0.5)"}),G.addEventListener("mouseenter",$=>{$.currentTarget.style.background="rgba(255,255,255,0.12)",$.currentTarget.style.borderColor="rgba(255,255,255,0.2)",$.currentTarget.style.color="rgba(255,255,255,0.8)"}),G.$$click=$=>{$.stopPropagation(),e(!t())},G.style.setProperty("position","absolute"),G.style.setProperty("top","12px"),G.style.setProperty("right","12px"),G.style.setProperty("background","rgba(255,255,255,0.08)"),G.style.setProperty("border","1px solid rgba(255,255,255,0.12)"),G.style.setProperty("color","rgba(255,255,255,0.5)"),G.style.setProperty("fontSize","14px"),G.style.setProperty("lineHeight","1"),G.style.setProperty("cursor","pointer"),G.style.setProperty("padding","0"),G.style.setProperty("width","28px"),G.style.setProperty("height","28px"),G.style.setProperty("display","flex"),G.style.setProperty("alignItems","center"),G.style.setProperty("justifyContent","center"),G.style.setProperty("borderRadius","8px"),G.style.setProperty("transition","all 0.2s"),J.style.setProperty("width","16px"),J.style.setProperty("height","16px"),J.style.setProperty("fill","currentColor"),G}}),null),se(A,ye(Ne,{get when(){return!t()},get children(){return ye(_o,{each:S,children:G=>(()=>{var J=gp(),$=J.firstChild,oe=$.firstChild,Oe=oe.firstChild,we=Oe.nextSibling,W=$.nextSibling,_e=W.firstChild;return $.$$click=()=>F(G.id),se(Oe,()=>G.icon),se(we,()=>G.title),se(_e,()=>G.content()),je(()=>Tt(J,`debug-section ${i()[G.id]?"expanded":""}`)),J})()})}}),null),je(G=>{var Oe,we,W;var J={...r().x!==null&&!t()?{position:"fixed",left:`${r().x}px`,top:`${r().y}px`,width:((Oe=s.style)==null?void 0:Oe.width)||"320px",maxWidth:((we=s.style)==null?void 0:we.maxWidth)||"320px",zIndex:((W=s.style)==null?void 0:W.zIndex)||1e3}:t()?{position:"fixed",top:"10px",right:"10px",zIndex:1e3,width:"52px",minWidth:"52px",height:"52px",borderRadius:"50%"}:{...s.style},cursor:a()?"grabbing":"default",transition:a()?"none":"all 0.2s"},$={cursor:t()?"pointer":"grab",...t()?{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:0}:{}},oe=t()?"scale(1.3)":"scale(1)";return G.e=ur(A,J,G.e),G.t=ur(V,$,G.t),oe!==G.a&&((G.a=oe)!=null?ce.style.setProperty("transform",oe):ce.style.removeProperty("transform")),G},{e:void 0,t:void 0,a:void 0}),A})()}hn(["input","click","touchstart","touchmove","touchend","pointerdown","mousedown"]);var yp=j('<img class=preview-image alt="Loading preview">'),wp=j("<div class=viewer-loading><p>Loading high-resolution artwork..."),_p=j('<div><div><div style=font-size:12px;color:#FFFFFF;font-weight:600;letter-spacing:0.5px;text-align:center;>SPOTLIGHT FINE-TUNING</div><button>✕</button></div><div class=floating-panel-scrollable><div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Circle Size: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Ellipse X: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Ellipse Y: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Gradient Spread: </label><input type=range max=5.0 step=0.1 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Offset X: <!>%</label><input type=range min=-10 max=10 step=0.5 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Offset Y: <!>%</label><input type=range min=-10 max=10 step=0.5 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><button style="margin-top:16px;padding:10px;font-size:11px;width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Copy Current Values'),Tp=j("<div class=expand-button-container><button class=expand-button><span class=expand-icon>⤢</span><span>Full View"),bp=j("<div class=fullscreen-button-container><button class=fullscreen-button>"),xp=j("<div class=viewer-container><div class=openseadragon-viewer>"),Ep=j('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3">'),Sp=j('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">');let Sn=[];function Pp(s){var It,Xn,Ai,Ri,Vr,Br,wi;let t,e=null,i={};const[n,r]=he(!0),[o,a]=he(null),[c,h]=he(null),[d,l]=he(!1),[p,f]=he(!1),[m,v]=he(!1),[w,b]=he(!1),[I,O]=he(!1),[N,q]=he(!1),[ie,k]=he(null),[S,E]=he(!1),[D,L]=he({x:0,y:0}),[F,A]=he(null),[V,ne]=he({}),[ce,G]=he(parseInt(localStorage.getItem("debugLevel")??"1")),[J,$]=he(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[oe,Oe]=he(((It=window.safariTuning)==null?void 0:It.circleMultiplier)||(He()?.8:1.2)),[we,W]=he(((Xn=window.safariTuning)==null?void 0:Xn.ellipseMultiplierX)||(He()?.8:1.15)),[_e,ze]=he(((Ai=window.safariTuning)==null?void 0:Ai.ellipseMultiplierY)||(He()?.8:1.15)),[gt,Le]=he(((Ri=window.safariTuning)==null?void 0:Ri.gradientMultiplier)||(He()?1:1.5)),[vt,ht]=he(((Vr=window.safariTuning)==null?void 0:Vr.offsetX)||0),[yt,at]=he(((Br=window.safariTuning)==null?void 0:Br.offsetY)||0),[rt,ut]=he(!1),[dt,ge]=he({x:0,y:0}),[Je,y]=he(!1),[R,B]=he({x:0,y:0}),[K,re]=he(0),[me,X]=he(null),[Ce,Be]=he(localStorage.getItem("interactionMode")||(He()?"temporal":"direct")),[ke,ve]=he(null),[Xe,x]=he(localStorage.getItem("revealStyle")||"invert"),T=ee=>{x(ee),localStorage.setItem("revealStyle",ee),window.updateRevealStyle&&window.updateRevealStyle(ee)},[C,M]=he(((wi=window.nativeHotspotRenderer)==null?void 0:wi.currentPalette)||"tech"),[U,te]=he({}),xe=()=>{i.handleKeyPress&&window.removeEventListener("keydown",i.handleKeyPress),Object.values(i).forEach(ee=>{typeof ee=="number"&&clearInterval(ee)}),i.performanceUpdate&&clearInterval(i.performanceUpdate),V().resizeObserver&&t&&V().resizeObserver.disconnect(),Object.values(V()).forEach(ee=>{ee&&typeof ee.destroy=="function"&&ee.destroy()}),e&&e.destroy(),["performanceMonitor","viewer","tileOptimizer"].forEach(ee=>{(window[ee]===V()[ee]||window[ee]===e)&&delete window[ee]})};Fs(async()=>{var Dt,$t,ft,kt,Yt;try{Sn=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${Sn.length} hotspots`)}catch(Qe){console.error("Failed to load hotspots:",Qe),Sn=[]}const ee=new Image;ee.onload=()=>f(!0),ee.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`;const Ee=Te.viewer;`${s.artworkId}${s.artworkId}`;const ue={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${s.artworkId}_1024/${s.artworkId}_files/`,Format:"jpg",Overlap:"2",TileSize:"1024",Size:{Width:"11244",Height:"6543"}},minLevel:8,maxLevel:14},Y=He(),le=ep(),Ae=$d(Ee,ue,le,Y,ue);/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&(Ae.drawer="canvas",Ae.smoothTileEdgesMinZoom=1/0,Ae.immediateRender=!0),e=nt({element:t,...Ae,updatePixelDensityRatio:!1});const be={spatialIndex:new yd,viewportManager:new xd(e),audioEngine:new nd,performanceMonitor:new cd(e),renderOptimizer:new hd(e),tileOptimizer:new Td(e),memoryManager:new sd(e),tileCleanupManager:new wd(e),imageOverlayManager:new rd,overlayManager:Oi.createWithOverride(e)};console.log("Creating overlay manager..."),console.log("Overlay manager type:",(Dt=be.overlayManager)==null?void 0:Dt.constructor.name),console.log("Overlay manager instance:",be.overlayManager),be.tileOptimizer.state.isActive=!1,setTimeout(()=>{be.tileOptimizer.state.isActive=!0},1e3),ne(be),window.performanceMetrics=U,console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!be.overlayManager),console.log("Does it have initialize method?",typeof(($t=be.overlayManager)==null?void 0:$t.initialize)),be.overlayManager.initialize(),console.log("Overlay manager initialized"),console.log("Is initialized flag:",(ft=be.overlayManager)==null?void 0:ft.isInitialized),console.log("Overlay element created?",!!((kt=be.overlayManager)!=null&&kt.overlayElement)),window.overlayManager=be.overlayManager,console.log("Overlay manager set on window:",(Yt=window.overlayManager)==null?void 0:Yt.constructor.name),window.audioEngine=be.audioEngine,be.audioEngine.onPlaybackEnd=Qe=>{console.log(`Finished playing audio for hotspot ${Qe}`)},be.spatialIndex.loadHotspots(Sn),be.imageOverlayManager.loadHotspots(Sn),window.viewer=e,window.performanceMonitor=be.performanceMonitor,window.tileOptimizer=be.tileOptimizer,window.tileCleanupManager=be.tileCleanupManager,be.performanceMonitor.start(),be.memoryManager.start(),be.tileOptimizer.start(),be.tileCleanupManager.start();const lt=setInterval(()=>{if(be.performanceMonitor&&be.performanceMonitor.isMonitoring){const Qe=be.performanceMonitor.getMetrics();te(Qe)}},500);i.performanceUpdate=lt,be.performanceMonitor.disableDebugOverlay(),ci(),ti(),Si(),Pi(),document.addEventListener("fullscreenchange",()=>{b(!!document.fullscreenElement)});const Ye=Qe=>{if(Je()){const wt=Qe.touches?Qe.touches[0].clientX:Qe.clientX,Ht=Qe.touches?Qe.touches[0].clientY:Qe.clientY;ge({x:wt-R().x,y:Ht-R().y})}},pt=Qe=>{Je()&&(Qe.preventDefault(),Ye(Qe))},Bt=()=>{y(!1)};window.addEventListener("mousemove",Ye),window.addEventListener("mouseup",Bt),window.addEventListener("touchmove",pt,{passive:!1}),window.addEventListener("touchend",Bt),an(()=>{window.removeEventListener("mousemove",Ye),window.removeEventListener("mouseup",Bt),window.removeEventListener("touchmove",pt),window.removeEventListener("touchend",Bt)}),an(xe)});const We=()=>{let ee=null,Ee=null,ue="idle",Y=0,le=null;e.addHandler("zoom",Ae=>{const pe=e.viewport.getZoom();if(Y++,le&&clearTimeout(le),!Ee||Math.abs(pe-Ee)>.01){const be=Ee?pe-Ee:0,lt=Math.abs(be);ue==="idle"?(ue="accelerating",ee=performance.now(),e.viewport.centerSpringX.animationTime=.4,e.viewport.centerSpringY.animationTime=.4,e.viewport.zoomSpring.animationTime=.4,e.imageLoader&&Y>3&&(e.imageLoader.jobLimit=Math.max(1,e.imageLoader.jobLimit-1))):ue==="accelerating"&&Y>5&&(ue="cruising",e.viewport.zoomSpring.animationTime=.2,e.imageLoader&&(e.imageLoader.jobLimit=1,lt>.1&&e.imageLoader.clear())),Ee=pe}le=setTimeout(()=>{ue!=="idle"&&(ue="decelerating",e.viewport.centerSpringX.animationTime=.3,e.viewport.centerSpringY.animationTime=.3,e.viewport.zoomSpring.animationTime=.3,e.imageLoader&&(e.imageLoader.jobLimit=3),setTimeout(()=>{ue="idle",Y=0,e.imageLoader&&(e.imageLoader.jobLimit=Te.viewer.imageLoaderLimit),e.forceRedraw(),ee&&(performance.now()-ee,ee=null)},200))},100)})},Pe=()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(ee=>clearTimeout(ee)),window.expandToFullViewTimeouts=[])},Pt=()=>{let ee=1,Ee=null;e.addHandler("zoom",ue=>{const Y=e.viewport.getZoom();ue.speed,Ee&&clearTimeout(Ee);let le=1;Y<2?le=.6:Y<3.5?le=.8:le=1;const Ae=le-ee;if(ee+=Ae*.3,e.drawer){e.drawer.imageSmoothingEnabled=ee>.7;const pe=Math.floor((1-ee)*3);e.skipTileRatio=pe}Ee=setTimeout(()=>{const pe=setInterval(()=>{ee+=.1,ee>=1&&(ee=1,e.drawer.imageSmoothingEnabled=!0,e.skipTileRatio=0,e.forceRedraw(),clearInterval(pe))},50)},200)})},st=ee=>{"requestIdleCallback"in window?requestIdleCallback(ee,{timeout:200}):setTimeout(ee,50)},ti=()=>{const ee={centerX:e.viewport.centerSpringX.springStiffness,centerY:e.viewport.centerSpringY.springStiffness,zoom:e.viewport.zoomSpring.springStiffness};e.addHandler("zoom-click",Ee=>{if(Ee.quick)return;const ue=e.viewport.getZoom(),Y=Ee.zoom,le=Math.abs(Math.log2(Y)-Math.log2(ue)),Ae=Math.min(.8,.3+le*.15);e.viewport.zoomSpring.animationTime=Ae;const pe=Math.max(4,8-le);e.viewport.zoomSpring.springStiffness=pe,setTimeout(()=>{e.viewport.zoomSpring.animationTime=Te.viewer.animationTime,e.viewport.zoomSpring.springStiffness=ee.zoom},Ae*1e3+100)})},ci=()=>{if(e.drawer&&e.drawer.getType&&e.drawer.getType()!=="webgl"){let ue=0;e.addHandler("tile-drawing",Y=>{const le=e.viewport.getZoom();Y.tile;const Ae=Y.tile.size,pe=Y.tile.level,be=e.skipTileRatio||0;if(be>0&&(ue++,ue%(be+1)!==0)){Y.preventDefaultAction=!0;return}if(le<2&&Ae*le<24){Y.preventDefaultAction=!0;return}const lt=Math.floor(Math.log2(le));Math.abs(pe-lt)>2&&e.skipTileRatio>0&&(Y.preventDefaultAction=!0)})}e.addHandler("open",()=>{if(He()){let le=0;const Ae=33;e.addHandler("update-viewport",pe=>{const be=performance.now();if(e.isAnimating()&&be-le<Ae){pe.preventDefaultAction=!0;return}le=be})}e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,He()&&(e.viewport.minZoomLevel=.5,e.viewport.minZoomImageRatio=.3),Pt(),We(),bd(nt),e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,console.log("Viewer ready - initializing systems"),console.log("Using drawer:",e.drawer.getType?e.drawer.getType():"canvas"),l(!0),r(!1);const Y=e.world.getItemAt(0).getBounds();e.viewport.fitBounds(Y,!0),e.viewport.applyConstraints(!0),He()&&setTimeout(()=>{const le=e.world.getItemAt(0);if(le){const Ae=le.getBounds();e.viewport.fitBoundsWithConstraints(Ae,!1)}},100),e.viewport.getHomeBounds(),setTimeout(()=>yi(),100)}),e.addHandler("zoom",()=>{V().tileCleanupManager&&V().tileCleanupManager.setPressure("normal"),I()&&e.imageLoader&&e.imageLoader.clear()}),e.addHandler("pan",()=>{V().tileCleanupManager&&V().tileCleanupManager.setPressure("normal")}),e.addHandler("tile-loaded",ue=>{var Y;if(ue.tile&&V().tileOptimizer){const le=ue.tile.loadTime||((Y=ue.tiledImage)==null?void 0:Y.lastResetTime)||100;V().tileOptimizer.trackLoadTime(le);const Ae=`${ue.tile.level||0}_${ue.tile.x||0}_${ue.tile.y||0}`;V().tileOptimizer.loadingTiles.delete(Ae)}}),e.addHandler("animation",()=>{if(V().performanceMonitor){const ue=V().performanceMonitor.getMetrics();if(ue.averageFPS<Te.debug.warnThreshold.fps){const Y=Jd(ue.averageFPS,ue.memoryUsage);if(V().tileCleanupManager){const le={emergency:"critical",critical:"critical",reduced:"high","memory-limited":"high",normal:"normal"};V().tileCleanupManager.setPressure(le[Y]||"normal")}}}}),e.addHandler("animation-finish",()=>{console.log("animation-finish fired",{isZoomingToHotspot:I(),isExpandingToFullView:N()}),I()&&(console.log("animation-finish: Setting isZoomingToHotspot to false"),O(!1),V().renderer&&(console.log("animation-finish: Calling resumeUpdates"),V().renderer.resumeUpdates(),V().renderer.updateVisibility()),V().renderOptimizer&&V().renderOptimizer.endCinematicZoom())}),e.addHandler("animation-start",ue=>{I()&&V().tileCleanupManager&&V().tileCleanupManager.pauseCleanup(3e3)});const ee=()=>{i.updateTimer&&clearTimeout(i.updateTimer),i.updateTimer=setTimeout(()=>{st(()=>{const{viewportManager:ue,spatialIndex:Y,audioEngine:le}=V();if(!ue||!Y||!le)return;const Ae=ue.getCurrentViewport(),pe=Y.queryViewport(Ae.bounds,Ae.zoom);le.preloadHotspots(pe)})},Te.viewport.updateDebounce)};e.addHandler("viewport-change",ee);let Ee=!1;e.addHandler("animation-start",()=>{He()&&(I()||N())&&(Ee=!0,e.removeHandler("viewport-change",ee))}),e.addHandler("animation-finish",()=>{Ee&&(Ee=!1,e.addHandler("viewport-change",ee),setTimeout(ee,100))}),e.addHandler("canvas-click",ue=>{!ue.preventDefaultAction&&V().renderer&&ue.quick&&V().renderer.selectedHotspot&&(V().renderer.selectedHotspot=null,h(null),V().overlayManager&&V().overlayManager.selectHotspot(null))}),He()&&e.addHandler("canvas-click",ue=>{const Y=e.container.clientWidth,le=e.container.clientHeight,Ae=100,pe=ue.position.x<Ae&&ue.position.y<Ae,be=ue.position.x>Y-Ae&&ue.position.y<Ae,lt=ue.position.x<Ae&&ue.position.y>le-Ae,Ye=ue.position.x>Y-Ae&&ue.position.y>le-Ae;if(pe||be||lt||Ye){const pt=K()+1;if(re(pt),me()&&clearTimeout(me()),pt>=3){const Dt=ce()===0?1:0;G(Dt),localStorage.setItem("debugLevel",Dt.toString()),V().performanceMonitor&&V().performanceMonitor.disableDebugOverlay(),console.log(`Debug mode: ${Dt===1?"ON":"OFF"}`),re(0)}else X(setTimeout(()=>{re(0)},1e3))}})},Si=()=>{const ee={"+":()=>e.viewport.zoomBy(Te.viewer.zoomPerScroll),"=":()=>e.viewport.zoomBy(Te.viewer.zoomPerScroll),"-":()=>e.viewport.zoomBy(1/Te.viewer.zoomPerScroll),_:()=>e.viewport.zoomBy(1/Te.viewer.zoomPerScroll),0:()=>Ci(),f:()=>e.viewport.fitBounds(e.world.getHomeBounds()),F:()=>e.viewport.fitBounds(e.world.getHomeBounds()),c:()=>{if(He())return;const ue=ce()===0?1:0;G(ue),localStorage.setItem("debugLevel",ue.toString()),V().performanceMonitor&&V().performanceMonitor.disableDebugOverlay(),V().renderer&&V().renderer.setDebugMode(ue===1),console.log(`Debug mode: ${ue===1?"ON":"OFF"}`)},h:()=>{V().renderer&&V().renderer.toggleRevealMode()},H:()=>{V().renderer&&V().renderer.toggleRevealMode()}};i.handleKeyPress=Ee=>{const ue=document.activeElement;if(ue&&(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.contentEditable==="true"))return;const Y=ee[Ee.key];Y&&e&&(Ee.preventDefault(),Y(),e.viewport.applyConstraints())},window.addEventListener("keydown",i.handleKeyPress)},Pi=()=>{const ee=new ResizeObserver(Ee=>{if(!(!(e!=null&&e.viewport)||!e.isOpen()))for(let ue of Ee){const{width:Y,height:le}=ue.contentRect;Y>0&&le>0&&requestAnimationFrame(()=>{try{e&&e.viewport&&e.isOpen()&&(e.viewport.resize(),e.viewport.applyConstraints(),e.forceRedraw())}catch(Ae){Ae.message&&!Ae.message.includes("undefined")&&console.warn("Resize error:",Ae)}})}});ee.observe(t),ne(Ee=>({...Ee,resizeObserver:ee}))},yi=()=>{if(!e)return;const ee=new bo({viewer:e,spatialIndex:V().spatialIndex,onHotspotHover:a,onHotspotClick:Ki,visibilityCheckInterval:Te.hotspots.visibilityCheckInterval,batchSize:Te.hotspots.batchSize,renderDebounceTime:Te.hotspots.renderDebounceTime,maxVisibleHotspots:Te.hotspots.maxVisibleHotspots,minZoomForHotspots:Te.hotspots.minZoomForHotspots,debugMode:ce()===2});ve(ee.modeStateManager),ne(Ee=>({...Ee,renderer:ee})),console.log("Using NativeHotspotRenderer for all platforms")},Fr=async ee=>{if(console.log("zoomToHotspot called",{hotspotId:ee.id,isZoomingToHotspot:I(),viewer:!!e}),!e||I()||N()){console.log("zoomToHotspot BLOCKED",{noViewer:!e,isZoomingToHotspot:I(),isExpandingToFullView:N()});return}const Ee=tp(ee,e,He());if(!Ee)return;const ue=He()?2.8:1.8,Y=He()?1.5:ue*J(),le=4/J();let Ae;O(!0),V().overlayManager&&V().overlayManager.startZoomAnimation&&V().overlayManager.startZoomAnimation(),console.log("Starting cinematic zoom to hotspot:",ee.id),Ae=setTimeout(()=>{console.log("Safety timeout: forcing isZoomingToHotspot to false"),O(!1),V().renderer&&V().renderer.resumeUpdates()},Y*1e3+500);const pe={animationTime:e.animationTime,springStiffness:e.springStiffness};if(V().tileCleanupManager&&V().tileCleanupManager.pauseCleanup(Y*1e3+500),e.imageLoader&&e.imageLoader.clear(),V().renderOptimizer&&V().renderOptimizer.startCinematicZoom(),V().performanceMonitor&&He()&&V().performanceMonitor.pauseMonitoring(),V().renderer&&(He()||V().renderer.pauseUpdates(),He()&&V().renderer.hideOverlay()),He()){console.log("DEBUG: Mobile animation with preload");try{let ft;if(e.viewport.getZoomForBounds)ft=e.viewport.getZoomForBounds(Ee);else{const wt=e.viewport.getBounds(),Ht=wt.width/Ee.width,Ii=wt.height/Ee.height;ft=Math.min(Ht,Ii)*e.viewport.getZoom()}const kt=Ee.getCenter();console.log("DEBUG: Mobile animation params",{currentZoom:e.viewport.getZoom(),targetZoom:ft,center:kt});const Yt=e.viewport.getZoom(),Qe=5;if(ft/Yt>Qe){console.log("DEBUG: Large zoom jump detected, using stepped approach");const wt=Yt*Qe;e.viewport.zoomTo(wt,kt,!0),e.forceRedraw(),setTimeout(()=>{e.viewport.panTo(kt),e.viewport.zoomTo(ft);let Ht=0;const Ii=setInterval(()=>{e.forceRedraw(),Ht++,Ht>10&&clearInterval(Ii)},100)},200)}else{e.viewport.centerSpringX.animationTime=Y,e.viewport.centerSpringY.animationTime=Y,e.viewport.zoomSpring.animationTime=Y;const wt=new nt.Point(kt.x,kt.y);e.viewport.panTo(wt),e.viewport.zoomTo(ft);const Ht=setInterval(()=>{e.forceRedraw()},100);setTimeout(()=>{clearInterval(Ht)},Y*1e3+200)}}catch(ft){console.error("Mobile animation error:",ft),e.viewport.fitBounds(Ee,!1)}setTimeout(()=>{v(!0),console.log("Full View button should now be visible on mobile")},Y*1e3+200);return}setTimeout(()=>{v(!0),console.log("Full View button should now be visible")},Y*1e3+200),e.animationTime=Y,e.springStiffness=le,e.viewport.centerSpringX.animationTime=Y,e.viewport.centerSpringY.animationTime=Y,e.viewport.zoomSpring.animationTime=Y,e.viewport.centerSpringX.springStiffness=le,e.viewport.centerSpringY.springStiffness=le,e.viewport.zoomSpring.springStiffness=le,e.viewport.applyConstraints(),console.log("Springs configured with animTime:",Y),V().viewportManager&&V().viewportManager.setCacheEnabled(!1);const be=e.viewport.getBounds();console.log("DEBUG: Manual zoom attempt",{from:be,to:Ee});const lt=e.viewport.getBounds(),Ye=lt.width/Ee.width,pt=lt.height/Ee.height,Bt=Math.min(Ye,pt)*e.viewport.getZoom(),Dt=Ee.getCenter();console.log("Manual zoom calculation:",{currentZoom:e.viewport.getZoom(),targetZoom:Bt,animTime:Y,center:Dt}),e.viewport.panTo(Dt,!1),e.viewport.zoomTo(Bt,null,!1),console.log("DEBUG: Zoom animation started",{currentZoom:e.viewport.getZoom(),targetBounds:Ee,springValues:{centerX:e.viewport.centerSpringX.target.value,centerY:e.viewport.centerSpringY.target.value,zoom:e.viewport.zoomSpring.target.value},animationTime:e.animationTime,isAnimating:e.isAnimating()});const $t=setInterval(()=>{console.log("DEBUG: Animation progress",{isAnimating:e.isAnimating(),currentZoom:e.viewport.getZoom(),zoomSpringCurrent:e.viewport.zoomSpring.current.value,zoomSpringTarget:e.viewport.zoomSpring.target.value})},100);setTimeout(()=>clearInterval($t),2e3),setTimeout(()=>{V().viewportManager&&V().viewportManager.setCacheEnabled(!0)},Y*1e3),setTimeout(()=>{clearTimeout(Ae),console.log("Setting isZoomingToHotspot to false"),O(!1),e.animationTime=pe.animationTime,e.springStiffness=pe.springStiffness,e.viewport.centerSpringX.animationTime=pe.animationTime,e.viewport.centerSpringY.animationTime=pe.animationTime,e.viewport.zoomSpring.animationTime=pe.animationTime,e.viewport.centerSpringX.springStiffness=pe.springStiffness,e.viewport.centerSpringY.springStiffness=pe.springStiffness,e.viewport.zoomSpring.springStiffness=pe.springStiffness,V().renderOptimizer&&V().renderOptimizer.endCinematicZoom(),V().performanceMonitor&&He()&&V().performanceMonitor.resumeMonitoring(),V().overlayManager&&V().overlayManager.endZoomAnimation&&V().overlayManager.endZoomAnimation()},Y*1e3+1e3),setTimeout(()=>{V().renderer&&(console.log("Animation complete - restoring hotspots"),He()?(V().renderer.showOverlay(),setTimeout(()=>{"requestIdleCallback"in window?requestIdleCallback(()=>{V().renderer.resumeUpdates(),V().renderer.updateVisibilityLazy()},{timeout:1e3}):setTimeout(()=>{V().renderer.resumeUpdates(),V().renderer.updateVisibilityLazy()},300)},200)):(V().renderer.resumeUpdates(),setTimeout(()=>{V().renderer.updateVisibility(),e.forceRedraw()},100)))},Y*1e3+300)},Ki=async ee=>{var ue,Y,le,Ae,pe,be,lt,Ye;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:ee?ee.id:"null (deselecting)",isZoomingToHotspot:I(),isExpandingToFullView:N(),timestamp:Date.now()}),console.log("Components available?",!!V()),console.log("OverlayManager available?",!!((ue=V())!=null&&ue.overlayManager)),console.log("OverlayManager type:",(le=(Y=V())==null?void 0:Y.overlayManager)==null?void 0:le.constructor.name),console.log("OverlayManager initialized?",(pe=(Ae=V())==null?void 0:Ae.overlayManager)==null?void 0:pe.isInitialized),!ee){h(null),E(!1),k(null),A(null),V().overlayManager?(console.log("Calling overlayManager.clearSelection()"),V().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(N()&&(console.log("Interrupting Full View animation for hotspot click"),e.viewport.stopAnimation(),Pe(),q(!1),V().renderOptimizer&&V().renderOptimizer.endCinematicZoom(),V().renderer&&(V().renderer.resumeUpdates(),He()&&V().renderer.showOverlay()),await new Promise(pt=>setTimeout(pt,50))),I()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),O(!1)),E(!1),h(ee),k(ee),(be=V())!=null&&be.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(ee==null?void 0:ee.id)||"null"),console.log("Hotspot data being passed:",ee),console.log("OverlayManager method exists?",typeof V().overlayManager.selectHotspot);try{V().overlayManager.selectHotspot(ee),console.log("selectHotspot call completed")}catch(pt){console.error("Error calling selectHotspot:",pt)}console.log("Hotspot data being passed:",{id:ee.id,shape:ee.shape,hasCoordinates:!!ee.coordinates,coordinatesLength:(lt=ee.coordinates)==null?void 0:lt.length}),V().overlayManager.selectHotspot(ee)}else console.error("No overlay manager available in components!"),console.error("Components object:",V());(ee.image_url_1||((Ye=V().imageOverlayManager)==null?void 0:Ye.getOverlay(ee.id)))&&(V().imageOverlayManager.shouldAutoReveal(ee.id)?Zn(ee.id):V().imageOverlayManager.shouldShowButton(ee.id)&&(A(ee),E(!0))),console.log("Zooming to hotspot:",ee.id),await Fr(ee)};window.artworkViewerHandleHotspotClick=Ki;const Zn=ee=>{console.log("Media button clicked for:",ee),E(!1),V().imageOverlayManager&&V().imageOverlayManager.openOverlay(ee)},Ci=()=>{if(console.log("expandToFullView START",{isExpandingToFullView:N(),isZoomingToHotspot:I()}),window.expandToFullViewTimeouts||(window.expandToFullViewTimeouts=[]),!e||N())return;I()&&(console.log("Force resetting isZoomingToHotspot in expandToFullView"),O(!1),V().renderOptimizer&&V().renderOptimizer.endCinematicZoom(),V().renderer&&V().renderer.resumeUpdates()),v(!1),q(!0);const ee=e.world.getItemAt(0);if(!ee){q(!1);return}const Ee=ee.getBounds(),Y=e.viewport.getBounds().getCenter(),le=Ee.getCenter(),Ae=Math.sqrt(Math.pow(le.x-Y.x,2)+Math.pow(le.y-Y.y,2)),pe=Math.min(1.5,Math.max(1.2,Ae*.4+1)),be=Math.max(6,10-Ae*1.5),lt=setTimeout(()=>{console.log("Safety timeout: forcing isExpandingToFullView to false (was:",N(),")"),q(!1)},pe*1e3+500);window.expandToFullViewTimeouts.push(lt);const Ye={animationTime:e.animationTime,springStiffness:e.springStiffness};if(console.log("expandToFullView animation params:",{distance:Ae,animTime:pe,stiffness:be,currentAnimationTime:e.animationTime,currentStiffness:e.springStiffness}),V().tileCleanupManager&&V().tileCleanupManager.pauseCleanup(pe*1e3+500),e.imageLoader&&e.imageLoader.clear(),V().renderOptimizer&&V().renderOptimizer.startCinematicZoom(),V().renderer&&(V().renderer.pauseUpdates(),He()&&V().renderer.hideOverlay()),e.animationTime=pe,e.springStiffness=be,e.viewport.centerSpringX.animationTime=pe,e.viewport.centerSpringY.animationTime=pe,e.viewport.zoomSpring.animationTime=pe,e.viewport.centerSpringX.springStiffness=be,e.viewport.centerSpringY.springStiffness=be,e.viewport.zoomSpring.springStiffness=be*.85,e.viewport.centerSpringX.resetTo(e.viewport.centerSpringX.current.value),e.viewport.centerSpringY.resetTo(e.viewport.centerSpringY.current.value),e.viewport.zoomSpring.resetTo(e.viewport.zoomSpring.current.value),console.log("expandToFullView executing fitBounds"),console.log("Springs after reset:",{centerXTime:e.viewport.centerSpringX.animationTime,zoomTime:e.viewport.zoomSpring.animationTime}),He())e.viewport.fitBounds(Ee,!1);else{const $t=Ee.x+Ee.width/2,ft=Ee.y+Ee.height/2,kt=new nt.Rect($t-Ee.width*1.01/2,ft-Ee.height*1.01/2,Ee.width*1.01,Ee.height*1.01);e.viewport.fitBounds(kt,!1)}console.log("expandToFullView animation started",{actualAnimTime:e.animationTime,actualStiffness:e.springStiffness,timestamp:Date.now()});const pt=setTimeout(()=>{clearTimeout(lt),q(!1),e.animationTime=Ye.animationTime,e.springStiffness=Ye.springStiffness,e.viewport.centerSpringX.animationTime=Ye.animationTime,e.viewport.centerSpringY.animationTime=Ye.animationTime,e.viewport.zoomSpring.animationTime=Ye.animationTime,e.viewport.centerSpringX.springStiffness=Ye.springStiffness,e.viewport.centerSpringY.springStiffness=Ye.springStiffness,e.viewport.zoomSpring.springStiffness=Ye.springStiffness,V().renderOptimizer&&V().renderOptimizer.endCinematicZoom()},pe*1e3+200);window.expandToFullViewTimeouts.push(pt);const Bt=setTimeout(()=>{V().renderer&&(He()&&V().renderer.showOverlay(),setTimeout(()=>{V().renderer.resumeUpdates(),V().renderer.updateVisibility(),e.forceRedraw()},200))},pe*1e3+100);window.expandToFullViewTimeouts.push(Bt)},Lr=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(ee=>{console.log(`Error attempting to enable fullscreen: ${ee.message}`)})};return[(()=>{var ee=xp(),Ee=ee.firstChild;se(ee,ye(Ne,{get when(){return Ct(()=>!!p())()&&!d()},get children(){var Y=yp();return je(()=>Zt(Y,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),Y}}),Ee);var ue=t;return typeof ue=="function"?Lc(ue,Ee):t=Ee,se(ee,ye(Ne,{get when(){return n()},get children(){return wp()}}),null),se(ee,ye(Ne,{get when(){return Ct(()=>!!d())()&&ce()===1},get children(){return ye(vp,{get style(){return{position:"fixed",top:"10px",right:"10px",width:He()?"90%":"320px",maxWidth:"320px",zIndex:1e3}},selectedHotspot:c,hoveredHotspot:o,get totalHotspots(){return Sn.length},get visibleHotspotCount(){var Y,le;return(le=(Y=V().renderer)==null?void 0:Y.visibleOverlays)==null?void 0:le.size},revealStyle:Xe,setRevealStyle:T,get performanceMetrics(){return U()},zoomSpeed:J,setZoomSpeed:$,setDebugLevel:G,currentPalette:C,setPalette:Y=>{window.setHotspotPalette&&(window.setHotspotPalette(Y),M(Y),e.forceRedraw())},interactionMode:Ce,setInteractionMode:Y=>{var le;Be(Y),localStorage.setItem("interactionMode",Y),(le=V().renderer)!=null&&le.modeStateManager&&V().renderer.modeStateManager.setMode(Y)},overlayType:()=>Oi.getCurrentType(),toggleOverlay:()=>{const le=(Oi.getCurrentType()||(Oi.detectBrowser().isWebKitBased?"safari":"css"))==="css"?"safari":"css";Oi.setPreference(le),window.location.reload()},isMobile:()=>He(),showFloatingPanel:rt,setShowFloatingPanel:ut})}}),null),se(ee,ye(Ne,{get when(){return Ct(()=>!!rt())()&&(Oi.getCurrentType()==="safari"||Oi.detectBrowser().isWebKitBased&&!Oi.getCurrentType())},get children(){var Y=_p(),le=Y.firstChild,Ae=le.firstChild,pe=Ae.nextSibling,be=le.nextSibling,lt=be.firstChild,Ye=lt.firstChild;Ye.firstChild;var pt=Ye.nextSibling,Bt=lt.nextSibling,Dt=Bt.firstChild;Dt.firstChild;var $t=Dt.nextSibling,ft=Bt.nextSibling,kt=ft.firstChild;kt.firstChild;var Yt=kt.nextSibling,Qe=ft.nextSibling,wt=Qe.firstChild;wt.firstChild;var Ht=wt.nextSibling,Ii=Qe.nextSibling,fn=Ii.firstChild,Hr=fn.firstChild,Yn=Hr.nextSibling;Yn.nextSibling;var mn=fn.nextSibling,gn=Ii.nextSibling,vn=gn.firstChild,Nr=vn.firstChild,zr=Nr.nextSibling;zr.nextSibling;var Ur=vn.nextSibling,yn=gn.nextSibling;return Y.style.setProperty("position","fixed"),Y.style.setProperty("width","220px"),Y.style.setProperty("background","rgba(20,20,20,0.85)"),Y.style.setProperty("border","1px solid rgba(255,255,255,0.2)"),Y.style.setProperty("borderRadius","12px"),Y.style.setProperty("boxShadow","0 8px 32px rgba(0,0,0,0.6)"),Y.style.setProperty("zIndex","10000"),Y.style.setProperty("userSelect","none"),Y.style.setProperty("backdropFilter","blur(20px)"),Y.style.setProperty("-webkit-backdrop-filter","blur(20px)"),Y.style.setProperty("display","flex"),Y.style.setProperty("flexDirection","column"),Y.style.setProperty("overflowY","auto"),Y.style.setProperty("overflowX","hidden"),le.$$touchstart=Re=>{const et=Re.touches[0];y(!0),B({x:et.clientX-dt().x,y:et.clientY-dt().y})},le.$$mousedown=Re=>{y(!0),B({x:Re.clientX-dt().x,y:Re.clientY-dt().y})},le.style.setProperty("position","relative"),le.style.setProperty("padding","12px 40px 12px 16px"),le.style.setProperty("borderBottom","1px solid rgba(255,255,255,0.1)"),le.style.setProperty("cursor","grab"),le.style.setProperty("background","rgba(255,255,255,0.03)"),le.style.setProperty("borderRadius","12px 12px 0 0"),pe.$$click=()=>ut(!1),pe.addEventListener("mouseleave",Re=>{Re.target.style.background="transparent",Re.target.style.color="rgba(255,255,255,0.5)"}),pe.addEventListener("mouseenter",Re=>{Re.target.style.background="rgba(255,255,255,0.1)",Re.target.style.color="rgba(255,255,255,0.8)"}),pe.style.setProperty("position","absolute"),pe.style.setProperty("top","8px"),pe.style.setProperty("right","8px"),pe.style.setProperty("background","transparent"),pe.style.setProperty("border","none"),pe.style.setProperty("color","rgba(255,255,255,0.5)"),pe.style.setProperty("fontSize","16px"),pe.style.setProperty("cursor","pointer"),pe.style.setProperty("padding","4px"),pe.style.setProperty("width","24px"),pe.style.setProperty("height","24px"),pe.style.setProperty("display","flex"),pe.style.setProperty("alignItems","center"),pe.style.setProperty("justifyContent","center"),pe.style.setProperty("borderRadius","4px"),pe.style.setProperty("transition","all 0.2s"),be.style.setProperty("padding","16px"),be.style.setProperty("overflowY","auto"),be.style.setProperty("overflowX","hidden"),be.style.setProperty("flex","1"),be.style.setProperty("WebkitOverflowScrolling","touch"),be.style.setProperty("scrollbarWidth","thin"),be.style.setProperty("scrollbarColor","rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05)"),se(Ye,()=>oe().toFixed(2),null),pt.$$input=Re=>{const et=parseFloat(Re.target.value);Oe(et),window.safariTuning&&(window.safariTuning.circleMultiplier=et,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},se(Dt,()=>we().toFixed(2),null),$t.$$input=Re=>{const et=parseFloat(Re.target.value);W(et),window.safariTuning&&(window.safariTuning.ellipseMultiplierX=et,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},se(kt,()=>_e().toFixed(2),null),Yt.$$input=Re=>{const et=parseFloat(Re.target.value);ze(et),window.safariTuning&&(window.safariTuning.ellipseMultiplierY=et,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},se(wt,()=>gt().toFixed(2),null),Ht.$$input=Re=>{const et=parseFloat(Re.target.value);Le(et),window.safariTuning&&(window.safariTuning.gradientMultiplier=et,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},se(fn,()=>vt().toFixed(1),Yn),mn.$$input=Re=>{const et=parseFloat(Re.target.value);ht(et),window.safariTuning&&(window.safariTuning.offsetX=et,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},se(vn,()=>yt().toFixed(1),zr),Ur.$$input=Re=>{const et=parseFloat(Re.target.value);at(et),window.safariTuning&&(window.safariTuning.offsetY=et,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},yn.$$click=()=>{console.log("Current tuning values:",window.safariTuning),navigator.clipboard.writeText(JSON.stringify(window.safariTuning,null,2)),alert("Tuning values copied to clipboard!")},yn.addEventListener("mouseleave",Re=>{Re.target.style.background="rgba(255,255,255,0.05)",Re.target.style.borderColor="rgba(255,255,255,0.1)"}),yn.addEventListener("mouseenter",Re=>{Re.target.style.background="rgba(255,255,255,0.1)",Re.target.style.borderColor="rgba(255,255,255,0.2)"}),je(Re=>{var et=`${dt().x}px`,ii=`${dt().y}px`,Qt=Je()?"grabbing":"default",Mi=He()?"80vh":"none",Ji=He()?"0.2":"0.1",Qn=He()?"0.2":"0.5",Ke=He()?"0.2":"0.5",$i=He()?"0.1":"0.3";return et!==Re.e&&((Re.e=et)!=null?Y.style.setProperty("left",et):Y.style.removeProperty("left")),ii!==Re.t&&((Re.t=ii)!=null?Y.style.setProperty("top",ii):Y.style.removeProperty("top")),Qt!==Re.a&&((Re.a=Qt)!=null?Y.style.setProperty("cursor",Qt):Y.style.removeProperty("cursor")),Mi!==Re.o&&((Re.o=Mi)!=null?Y.style.setProperty("maxHeight",Mi):Y.style.removeProperty("maxHeight")),Ji!==Re.i&&Zt(pt,"min",Re.i=Ji),Qn!==Re.n&&Zt($t,"min",Re.n=Qn),Ke!==Re.s&&Zt(Yt,"min",Re.s=Ke),$i!==Re.h&&Zt(Ht,"min",Re.h=$i),Re},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),je(()=>pt.value=oe()),je(()=>$t.value=we()),je(()=>Yt.value=_e()),je(()=>Ht.value=gt()),je(()=>mn.value=vt()),je(()=>Ur.value=yt()),Y}}),null),se(ee,ye(Ne,{get when(){return Ct(()=>!!d())()&&m()},get children(){var Y=Tp(),le=Y.firstChild;return le.$$click=Ci,Y}}),null),se(ee,ye(Ne,{get when(){return Ct(()=>!!d())()&&He()},get children(){var Y=bp(),le=Y.firstChild;return le.$$click=Lr,se(le,(()=>{var Ae=Ct(()=>!!w());return()=>Ae()?Ep():Sp()})()),je(()=>Zt(le,"title",w()?"Exit fullscreen":"Enter fullscreen")),Y}}),null),se(ee,ye(Ne,{get when(){return Ct(()=>!!S())()&&F()},get children(){return ye(Wd,{get hotspotId(){var Y;return(Y=F())==null?void 0:Y.id},onClick:Zn,get position(){return D()},get isMobile(){return He()}})}}),null),se(ee,ye(Ne,{get when(){return Ct(()=>!!d())()&&V().imageOverlayManager},get children(){return ye(Yd,{get imageOverlayManager(){return V().imageOverlayManager},currentHotspot:F})}}),null),ee})(),ye(Ne,{get when(){return Ct(()=>!!d())()&&V().audioEngine},get children(){return ye(jd,{get audioEngine(){return V().audioEngine},currentHotspot:ie})}})]}hn(["mousedown","touchstart","click","input"]);const Cp=()=>{};var ul={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hc=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},Ap=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],c=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(c>>10)),t[i++]=String.fromCharCode(56320+(c&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},Nc={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,c=n+2<s.length,h=c?s[n+2]:0,d=r>>2,l=(r&3)<<4|a>>4;let p=(a&15)<<2|h>>6,f=h&63;c||(f=64,o||(p=64)),i.push(e[d],e[l],e[p],e[f])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(Hc(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):Ap(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const h=n<s.length?e[s.charAt(n)]:64;++n;const l=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||h==null||l==null)throw new Rp;const p=r<<2|a>>4;if(i.push(p),h!==64){const f=a<<4&240|h>>2;if(i.push(f),l!==64){const m=h<<6&192|l;i.push(m)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class Rp extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Ip=function(s){const t=Hc(s);return Nc.encodeByteArray(t,!0)},ws=function(s){return Ip(s).replace(/\./g,"")},Mp=function(s){try{return Nc.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Dp(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const kp=()=>Dp().__FIREBASE_DEFAULTS__,Op=()=>{if(typeof process>"u"||typeof ul>"u")return;const s=ul.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},Fp=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&Mp(s[1]);return t&&JSON.parse(t)},Xo=()=>{try{return Cp()||kp()||Op()||Fp()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},Lp=s=>{var t,e;return(e=(t=Xo())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},Vp=s=>{const t=Lp(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},zc=()=>{var s;return(s=Xo())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bp{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yo(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Hp(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Np(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[ws(JSON.stringify(e)),ws(JSON.stringify(o)),""].join(".")}const dr={};function zp(){const s={prod:[],emulator:[]};for(const t of Object.keys(dr))dr[t]?s.emulator.push(t):s.prod.push(t);return s}function Up(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let dl=!1;function jp(s,t){if(typeof window>"u"||typeof document>"u"||!Yo(window.location.host)||dr[s]===t||dr[s]||dl)return;dr[s]=t;function e(p){return`__firebase__banner__${p}`}const i="__firebase__banner",r=zp().prod.length>0;function o(){const p=document.getElementById(i);p&&p.remove()}function a(p){p.style.display="flex",p.style.background="#7faaf0",p.style.position="fixed",p.style.bottom="5px",p.style.left="5px",p.style.padding=".5em",p.style.borderRadius="5px",p.style.alignItems="center"}function c(p,f){p.setAttribute("width","24"),p.setAttribute("id",f),p.setAttribute("height","24"),p.setAttribute("viewBox","0 0 24 24"),p.setAttribute("fill","none"),p.style.marginLeft="-6px"}function h(){const p=document.createElement("span");return p.style.cursor="pointer",p.style.marginLeft="16px",p.style.fontSize="24px",p.innerHTML=" &times;",p.onclick=()=>{dl=!0,o()},p}function d(p,f){p.setAttribute("id",f),p.innerText="Learn more",p.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",p.setAttribute("target","__blank"),p.style.paddingLeft="5px",p.style.textDecoration="underline"}function l(){const p=Up(i),f=e("text"),m=document.getElementById(f)||document.createElement("span"),v=e("learnmore"),w=document.getElementById(v)||document.createElement("a"),b=e("preprendIcon"),I=document.getElementById(b)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(p.created){const O=p.element;a(O),d(w,v);const N=h();c(I,b),O.append(I,m,w,N),document.body.appendChild(O)}r?(m.innerText="Preview backend disconnected.",I.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(I.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",f)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",l):l()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qp(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Wp(){var s;const t=(s=Xo())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function Gp(){return!Wp()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function Zp(){try{return typeof indexedDB=="object"}catch{return!1}}function Xp(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yp="FirebaseError";class zn extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=Yp,Object.setPrototypeOf(this,zn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Uc.prototype.create)}}class Uc{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?Qp(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new zn(n,a,i)}}function Qp(s,t){return s.replace(Kp,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const Kp=/\{\$([^}]+)}/g;function _s(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if(pl(r)&&pl(o)){if(!_s(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function pl(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gi(s){return s&&s._delegate?s._delegate:s}class yr{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tn="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jp{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new Bp;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(ef(t))try{this.getOrInitializeService({instanceIdentifier:tn})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=tn){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=tn){return this.instances.has(t)}getOptions(t=tn){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:$p(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=tn){return this.component?this.component.multipleInstances?t:tn:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function $p(s){return s===tn?void 0:s}function ef(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tf{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new Jp(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var qe;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(qe||(qe={}));const nf={debug:qe.DEBUG,verbose:qe.VERBOSE,info:qe.INFO,warn:qe.WARN,error:qe.ERROR,silent:qe.SILENT},rf=qe.INFO,sf={[qe.DEBUG]:"log",[qe.VERBOSE]:"log",[qe.INFO]:"info",[qe.WARN]:"warn",[qe.ERROR]:"error"},of=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=sf[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class jc{constructor(t){this.name=t,this._logLevel=rf,this._logHandler=of,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in qe))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?nf[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,qe.DEBUG,...t),this._logHandler(this,qe.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,qe.VERBOSE,...t),this._logHandler(this,qe.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,qe.INFO,...t),this._logHandler(this,qe.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,qe.WARN,...t),this._logHandler(this,qe.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,qe.ERROR,...t),this._logHandler(this,qe.ERROR,...t)}}const af=(s,t)=>t.some(e=>s instanceof e);let fl,ml;function lf(){return fl||(fl=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function cf(){return ml||(ml=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const qc=new WeakMap,xo=new WeakMap,Wc=new WeakMap,ho=new WeakMap,Qo=new WeakMap;function hf(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(Li(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&qc.set(e,s)}).catch(()=>{}),Qo.set(t,s),t}function uf(s){if(xo.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});xo.set(s,t)}let Eo={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return xo.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Wc.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Li(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function df(s){Eo=s(Eo)}function pf(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(uo(this),t,...e);return Wc.set(i,t.sort?t.sort():[t]),Li(i)}:cf().includes(s)?function(...t){return s.apply(uo(this),t),Li(qc.get(this))}:function(...t){return Li(s.apply(uo(this),t))}}function ff(s){return typeof s=="function"?pf(s):(s instanceof IDBTransaction&&uf(s),af(s,lf())?new Proxy(s,Eo):s)}function Li(s){if(s instanceof IDBRequest)return hf(s);if(ho.has(s))return ho.get(s);const t=ff(s);return t!==s&&(ho.set(s,t),Qo.set(t,s)),t}const uo=s=>Qo.get(s);function mf(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=Li(o);return i&&o.addEventListener("upgradeneeded",c=>{i(Li(o.result),c.oldVersion,c.newVersion,Li(o.transaction),c)}),e&&o.addEventListener("blocked",c=>e(c.oldVersion,c.newVersion,c)),a.then(c=>{r&&c.addEventListener("close",()=>r()),n&&c.addEventListener("versionchange",h=>n(h.oldVersion,h.newVersion,h))}).catch(()=>{}),a}const gf=["get","getKey","getAll","getAllKeys","count"],vf=["put","add","delete","clear"],po=new Map;function gl(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(po.get(t))return po.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=vf.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||gf.includes(e)))return;const r=async function(o,...a){const c=this.transaction(o,n?"readwrite":"readonly");let h=c.store;return i&&(h=h.index(a.shift())),(await Promise.all([h[e](...a),n&&c.done]))[0]};return po.set(t,r),r}df(s=>({...s,get:(t,e,i)=>gl(t,e)||s.get(t,e,i),has:(t,e)=>!!gl(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yf{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(wf(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function wf(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const So="@firebase/app",vl="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bi=new jc("@firebase/app"),_f="@firebase/app-compat",Tf="@firebase/analytics-compat",bf="@firebase/analytics",xf="@firebase/app-check-compat",Ef="@firebase/app-check",Sf="@firebase/auth",Pf="@firebase/auth-compat",Cf="@firebase/database",Af="@firebase/data-connect",Rf="@firebase/database-compat",If="@firebase/functions",Mf="@firebase/functions-compat",Df="@firebase/installations",kf="@firebase/installations-compat",Of="@firebase/messaging",Ff="@firebase/messaging-compat",Lf="@firebase/performance",Vf="@firebase/performance-compat",Bf="@firebase/remote-config",Hf="@firebase/remote-config-compat",Nf="@firebase/storage",zf="@firebase/storage-compat",Uf="@firebase/firestore",jf="@firebase/ai",qf="@firebase/firestore-compat",Wf="firebase",Gf="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Po="[DEFAULT]",Zf={[So]:"fire-core",[_f]:"fire-core-compat",[bf]:"fire-analytics",[Tf]:"fire-analytics-compat",[Ef]:"fire-app-check",[xf]:"fire-app-check-compat",[Sf]:"fire-auth",[Pf]:"fire-auth-compat",[Cf]:"fire-rtdb",[Af]:"fire-data-connect",[Rf]:"fire-rtdb-compat",[If]:"fire-fn",[Mf]:"fire-fn-compat",[Df]:"fire-iid",[kf]:"fire-iid-compat",[Of]:"fire-fcm",[Ff]:"fire-fcm-compat",[Lf]:"fire-perf",[Vf]:"fire-perf-compat",[Bf]:"fire-rc",[Hf]:"fire-rc-compat",[Nf]:"fire-gcs",[zf]:"fire-gcs-compat",[Uf]:"fire-fst",[qf]:"fire-fst-compat",[jf]:"fire-vertex","fire-js":"fire-js",[Wf]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ts=new Map,Xf=new Map,Co=new Map;function yl(s,t){try{s.container.addComponent(t)}catch(e){bi.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function bs(s){const t=s.name;if(Co.has(t))return bi.debug(`There were multiple attempts to register component ${t}.`),!1;Co.set(t,s);for(const e of Ts.values())yl(e,s);for(const e of Xf.values())yl(e,s);return!0}function Yf(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function Qf(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Kf={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Vi=new Uc("app","Firebase",Kf);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jf{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new yr("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw Vi.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $f=Gf;function Gc(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:Po,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw Vi.create("bad-app-name",{appName:String(n)});if(e||(e=zc()),!e)throw Vi.create("no-options");const r=Ts.get(n);if(r){if(_s(e,r.options)&&_s(i,r.config))return r;throw Vi.create("duplicate-app",{appName:n})}const o=new tf(n);for(const c of Co.values())o.addComponent(c);const a=new Jf(e,i,o);return Ts.set(n,a),a}function em(s=Po){const t=Ts.get(s);if(!t&&s===Po&&zc())return Gc();if(!t)throw Vi.create("no-app",{appName:s});return t}function Dn(s,t,e){var i;let n=(i=Zf[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),bi.warn(a.join(" "));return}bs(new yr(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tm="firebase-heartbeat-database",im=1,wr="firebase-heartbeat-store";let fo=null;function Zc(){return fo||(fo=mf(tm,im,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(wr)}catch(e){console.warn(e)}}}}).catch(s=>{throw Vi.create("idb-open",{originalErrorMessage:s.message})})),fo}async function nm(s){try{const e=(await Zc()).transaction(wr),i=await e.objectStore(wr).get(Xc(s));return await e.done,i}catch(t){if(t instanceof zn)bi.warn(t.message);else{const e=Vi.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});bi.warn(e.message)}}}async function wl(s,t){try{const i=(await Zc()).transaction(wr,"readwrite");await i.objectStore(wr).put(t,Xc(s)),await i.done}catch(e){if(e instanceof zn)bi.warn(e.message);else{const i=Vi.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});bi.warn(i.message)}}}function Xc(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const rm=1024,sm=30;class om{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new lm(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=_l();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>sm){const o=cm(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){bi.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=_l(),{heartbeatsToSend:i,unsentEntries:n}=am(this._heartbeatsCache.heartbeats),r=ws(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return bi.warn(e),""}}}function _l(){return new Date().toISOString().substring(0,10)}function am(s,t=rm){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),Tl(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),Tl(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class lm{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Zp()?Xp().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await nm(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return wl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return wl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function Tl(s){return ws(JSON.stringify({version:2,heartbeats:s})).length}function cm(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hm(s){bs(new yr("platform-logger",t=>new yf(t),"PRIVATE")),bs(new yr("heartbeat",t=>new om(t),"PRIVATE")),Dn(So,vl,s),Dn(So,vl,"esm2017"),Dn("fire-js","")}hm("");var bl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Bi,Yc;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(k,S){function E(){}E.prototype=S.prototype,k.D=S.prototype,k.prototype=new E,k.prototype.constructor=k,k.C=function(D,L,F){for(var A=Array(arguments.length-2),V=2;V<arguments.length;V++)A[V-2]=arguments[V];return S.prototype[L].apply(D,A)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(k,S,E){E||(E=0);var D=Array(16);if(typeof S=="string")for(var L=0;16>L;++L)D[L]=S.charCodeAt(E++)|S.charCodeAt(E++)<<8|S.charCodeAt(E++)<<16|S.charCodeAt(E++)<<24;else for(L=0;16>L;++L)D[L]=S[E++]|S[E++]<<8|S[E++]<<16|S[E++]<<24;S=k.g[0],E=k.g[1],L=k.g[2];var F=k.g[3],A=S+(F^E&(L^F))+D[0]+3614090360&4294967295;S=E+(A<<7&4294967295|A>>>25),A=F+(L^S&(E^L))+D[1]+3905402710&4294967295,F=S+(A<<12&4294967295|A>>>20),A=L+(E^F&(S^E))+D[2]+606105819&4294967295,L=F+(A<<17&4294967295|A>>>15),A=E+(S^L&(F^S))+D[3]+3250441966&4294967295,E=L+(A<<22&4294967295|A>>>10),A=S+(F^E&(L^F))+D[4]+4118548399&4294967295,S=E+(A<<7&4294967295|A>>>25),A=F+(L^S&(E^L))+D[5]+1200080426&4294967295,F=S+(A<<12&4294967295|A>>>20),A=L+(E^F&(S^E))+D[6]+2821735955&4294967295,L=F+(A<<17&4294967295|A>>>15),A=E+(S^L&(F^S))+D[7]+4249261313&4294967295,E=L+(A<<22&4294967295|A>>>10),A=S+(F^E&(L^F))+D[8]+1770035416&4294967295,S=E+(A<<7&4294967295|A>>>25),A=F+(L^S&(E^L))+D[9]+2336552879&4294967295,F=S+(A<<12&4294967295|A>>>20),A=L+(E^F&(S^E))+D[10]+4294925233&4294967295,L=F+(A<<17&4294967295|A>>>15),A=E+(S^L&(F^S))+D[11]+2304563134&4294967295,E=L+(A<<22&4294967295|A>>>10),A=S+(F^E&(L^F))+D[12]+1804603682&4294967295,S=E+(A<<7&4294967295|A>>>25),A=F+(L^S&(E^L))+D[13]+4254626195&4294967295,F=S+(A<<12&4294967295|A>>>20),A=L+(E^F&(S^E))+D[14]+2792965006&4294967295,L=F+(A<<17&4294967295|A>>>15),A=E+(S^L&(F^S))+D[15]+1236535329&4294967295,E=L+(A<<22&4294967295|A>>>10),A=S+(L^F&(E^L))+D[1]+4129170786&4294967295,S=E+(A<<5&4294967295|A>>>27),A=F+(E^L&(S^E))+D[6]+3225465664&4294967295,F=S+(A<<9&4294967295|A>>>23),A=L+(S^E&(F^S))+D[11]+643717713&4294967295,L=F+(A<<14&4294967295|A>>>18),A=E+(F^S&(L^F))+D[0]+3921069994&4294967295,E=L+(A<<20&4294967295|A>>>12),A=S+(L^F&(E^L))+D[5]+3593408605&4294967295,S=E+(A<<5&4294967295|A>>>27),A=F+(E^L&(S^E))+D[10]+38016083&4294967295,F=S+(A<<9&4294967295|A>>>23),A=L+(S^E&(F^S))+D[15]+3634488961&4294967295,L=F+(A<<14&4294967295|A>>>18),A=E+(F^S&(L^F))+D[4]+3889429448&4294967295,E=L+(A<<20&4294967295|A>>>12),A=S+(L^F&(E^L))+D[9]+568446438&4294967295,S=E+(A<<5&4294967295|A>>>27),A=F+(E^L&(S^E))+D[14]+3275163606&4294967295,F=S+(A<<9&4294967295|A>>>23),A=L+(S^E&(F^S))+D[3]+4107603335&4294967295,L=F+(A<<14&4294967295|A>>>18),A=E+(F^S&(L^F))+D[8]+1163531501&4294967295,E=L+(A<<20&4294967295|A>>>12),A=S+(L^F&(E^L))+D[13]+2850285829&4294967295,S=E+(A<<5&4294967295|A>>>27),A=F+(E^L&(S^E))+D[2]+4243563512&4294967295,F=S+(A<<9&4294967295|A>>>23),A=L+(S^E&(F^S))+D[7]+1735328473&4294967295,L=F+(A<<14&4294967295|A>>>18),A=E+(F^S&(L^F))+D[12]+2368359562&4294967295,E=L+(A<<20&4294967295|A>>>12),A=S+(E^L^F)+D[5]+4294588738&4294967295,S=E+(A<<4&4294967295|A>>>28),A=F+(S^E^L)+D[8]+2272392833&4294967295,F=S+(A<<11&4294967295|A>>>21),A=L+(F^S^E)+D[11]+1839030562&4294967295,L=F+(A<<16&4294967295|A>>>16),A=E+(L^F^S)+D[14]+4259657740&4294967295,E=L+(A<<23&4294967295|A>>>9),A=S+(E^L^F)+D[1]+2763975236&4294967295,S=E+(A<<4&4294967295|A>>>28),A=F+(S^E^L)+D[4]+1272893353&4294967295,F=S+(A<<11&4294967295|A>>>21),A=L+(F^S^E)+D[7]+4139469664&4294967295,L=F+(A<<16&4294967295|A>>>16),A=E+(L^F^S)+D[10]+3200236656&4294967295,E=L+(A<<23&4294967295|A>>>9),A=S+(E^L^F)+D[13]+681279174&4294967295,S=E+(A<<4&4294967295|A>>>28),A=F+(S^E^L)+D[0]+3936430074&4294967295,F=S+(A<<11&4294967295|A>>>21),A=L+(F^S^E)+D[3]+3572445317&4294967295,L=F+(A<<16&4294967295|A>>>16),A=E+(L^F^S)+D[6]+76029189&4294967295,E=L+(A<<23&4294967295|A>>>9),A=S+(E^L^F)+D[9]+3654602809&4294967295,S=E+(A<<4&4294967295|A>>>28),A=F+(S^E^L)+D[12]+3873151461&4294967295,F=S+(A<<11&4294967295|A>>>21),A=L+(F^S^E)+D[15]+530742520&4294967295,L=F+(A<<16&4294967295|A>>>16),A=E+(L^F^S)+D[2]+3299628645&4294967295,E=L+(A<<23&4294967295|A>>>9),A=S+(L^(E|~F))+D[0]+4096336452&4294967295,S=E+(A<<6&4294967295|A>>>26),A=F+(E^(S|~L))+D[7]+1126891415&4294967295,F=S+(A<<10&4294967295|A>>>22),A=L+(S^(F|~E))+D[14]+2878612391&4294967295,L=F+(A<<15&4294967295|A>>>17),A=E+(F^(L|~S))+D[5]+4237533241&4294967295,E=L+(A<<21&4294967295|A>>>11),A=S+(L^(E|~F))+D[12]+1700485571&4294967295,S=E+(A<<6&4294967295|A>>>26),A=F+(E^(S|~L))+D[3]+2399980690&4294967295,F=S+(A<<10&4294967295|A>>>22),A=L+(S^(F|~E))+D[10]+4293915773&4294967295,L=F+(A<<15&4294967295|A>>>17),A=E+(F^(L|~S))+D[1]+2240044497&4294967295,E=L+(A<<21&4294967295|A>>>11),A=S+(L^(E|~F))+D[8]+1873313359&4294967295,S=E+(A<<6&4294967295|A>>>26),A=F+(E^(S|~L))+D[15]+4264355552&4294967295,F=S+(A<<10&4294967295|A>>>22),A=L+(S^(F|~E))+D[6]+2734768916&4294967295,L=F+(A<<15&4294967295|A>>>17),A=E+(F^(L|~S))+D[13]+1309151649&4294967295,E=L+(A<<21&4294967295|A>>>11),A=S+(L^(E|~F))+D[4]+4149444226&4294967295,S=E+(A<<6&4294967295|A>>>26),A=F+(E^(S|~L))+D[11]+3174756917&4294967295,F=S+(A<<10&4294967295|A>>>22),A=L+(S^(F|~E))+D[2]+718787259&4294967295,L=F+(A<<15&4294967295|A>>>17),A=E+(F^(L|~S))+D[9]+3951481745&4294967295,k.g[0]=k.g[0]+S&4294967295,k.g[1]=k.g[1]+(L+(A<<21&4294967295|A>>>11))&4294967295,k.g[2]=k.g[2]+L&4294967295,k.g[3]=k.g[3]+F&4294967295}i.prototype.u=function(k,S){S===void 0&&(S=k.length);for(var E=S-this.blockSize,D=this.B,L=this.h,F=0;F<S;){if(L==0)for(;F<=E;)n(this,k,F),F+=this.blockSize;if(typeof k=="string"){for(;F<S;)if(D[L++]=k.charCodeAt(F++),L==this.blockSize){n(this,D),L=0;break}}else for(;F<S;)if(D[L++]=k[F++],L==this.blockSize){n(this,D),L=0;break}}this.h=L,this.o+=S},i.prototype.v=function(){var k=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);k[0]=128;for(var S=1;S<k.length-8;++S)k[S]=0;var E=8*this.o;for(S=k.length-8;S<k.length;++S)k[S]=E&255,E/=256;for(this.u(k),k=Array(16),S=E=0;4>S;++S)for(var D=0;32>D;D+=8)k[E++]=this.g[S]>>>D&255;return k};function r(k,S){var E=a;return Object.prototype.hasOwnProperty.call(E,k)?E[k]:E[k]=S(k)}function o(k,S){this.h=S;for(var E=[],D=!0,L=k.length-1;0<=L;L--){var F=k[L]|0;D&&F==S||(E[L]=F,D=!1)}this.g=E}var a={};function c(k){return-128<=k&&128>k?r(k,function(S){return new o([S|0],0>S?-1:0)}):new o([k|0],0>k?-1:0)}function h(k){if(isNaN(k)||!isFinite(k))return l;if(0>k)return w(h(-k));for(var S=[],E=1,D=0;k>=E;D++)S[D]=k/E|0,E*=4294967296;return new o(S,0)}function d(k,S){if(k.length==0)throw Error("number format error: empty string");if(S=S||10,2>S||36<S)throw Error("radix out of range: "+S);if(k.charAt(0)=="-")return w(d(k.substring(1),S));if(0<=k.indexOf("-"))throw Error('number format error: interior "-" character');for(var E=h(Math.pow(S,8)),D=l,L=0;L<k.length;L+=8){var F=Math.min(8,k.length-L),A=parseInt(k.substring(L,L+F),S);8>F?(F=h(Math.pow(S,F)),D=D.j(F).add(h(A))):(D=D.j(E),D=D.add(h(A)))}return D}var l=c(0),p=c(1),f=c(16777216);s=o.prototype,s.m=function(){if(v(this))return-w(this).m();for(var k=0,S=1,E=0;E<this.g.length;E++){var D=this.i(E);k+=(0<=D?D:4294967296+D)*S,S*=4294967296}return k},s.toString=function(k){if(k=k||10,2>k||36<k)throw Error("radix out of range: "+k);if(m(this))return"0";if(v(this))return"-"+w(this).toString(k);for(var S=h(Math.pow(k,6)),E=this,D="";;){var L=N(E,S).g;E=b(E,L.j(S));var F=((0<E.g.length?E.g[0]:E.h)>>>0).toString(k);if(E=L,m(E))return F+D;for(;6>F.length;)F="0"+F;D=F+D}},s.i=function(k){return 0>k?0:k<this.g.length?this.g[k]:this.h};function m(k){if(k.h!=0)return!1;for(var S=0;S<k.g.length;S++)if(k.g[S]!=0)return!1;return!0}function v(k){return k.h==-1}s.l=function(k){return k=b(this,k),v(k)?-1:m(k)?0:1};function w(k){for(var S=k.g.length,E=[],D=0;D<S;D++)E[D]=~k.g[D];return new o(E,~k.h).add(p)}s.abs=function(){return v(this)?w(this):this},s.add=function(k){for(var S=Math.max(this.g.length,k.g.length),E=[],D=0,L=0;L<=S;L++){var F=D+(this.i(L)&65535)+(k.i(L)&65535),A=(F>>>16)+(this.i(L)>>>16)+(k.i(L)>>>16);D=A>>>16,F&=65535,A&=65535,E[L]=A<<16|F}return new o(E,E[E.length-1]&-2147483648?-1:0)};function b(k,S){return k.add(w(S))}s.j=function(k){if(m(this)||m(k))return l;if(v(this))return v(k)?w(this).j(w(k)):w(w(this).j(k));if(v(k))return w(this.j(w(k)));if(0>this.l(f)&&0>k.l(f))return h(this.m()*k.m());for(var S=this.g.length+k.g.length,E=[],D=0;D<2*S;D++)E[D]=0;for(D=0;D<this.g.length;D++)for(var L=0;L<k.g.length;L++){var F=this.i(D)>>>16,A=this.i(D)&65535,V=k.i(L)>>>16,ne=k.i(L)&65535;E[2*D+2*L]+=A*ne,I(E,2*D+2*L),E[2*D+2*L+1]+=F*ne,I(E,2*D+2*L+1),E[2*D+2*L+1]+=A*V,I(E,2*D+2*L+1),E[2*D+2*L+2]+=F*V,I(E,2*D+2*L+2)}for(D=0;D<S;D++)E[D]=E[2*D+1]<<16|E[2*D];for(D=S;D<2*S;D++)E[D]=0;return new o(E,0)};function I(k,S){for(;(k[S]&65535)!=k[S];)k[S+1]+=k[S]>>>16,k[S]&=65535,S++}function O(k,S){this.g=k,this.h=S}function N(k,S){if(m(S))throw Error("division by zero");if(m(k))return new O(l,l);if(v(k))return S=N(w(k),S),new O(w(S.g),w(S.h));if(v(S))return S=N(k,w(S)),new O(w(S.g),S.h);if(30<k.g.length){if(v(k)||v(S))throw Error("slowDivide_ only works with positive integers.");for(var E=p,D=S;0>=D.l(k);)E=q(E),D=q(D);var L=ie(E,1),F=ie(D,1);for(D=ie(D,2),E=ie(E,2);!m(D);){var A=F.add(D);0>=A.l(k)&&(L=L.add(E),F=A),D=ie(D,1),E=ie(E,1)}return S=b(k,L.j(S)),new O(L,S)}for(L=l;0<=k.l(S);){for(E=Math.max(1,Math.floor(k.m()/S.m())),D=Math.ceil(Math.log(E)/Math.LN2),D=48>=D?1:Math.pow(2,D-48),F=h(E),A=F.j(S);v(A)||0<A.l(k);)E-=D,F=h(E),A=F.j(S);m(F)&&(F=p),L=L.add(F),k=b(k,A)}return new O(L,k)}s.A=function(k){return N(this,k).h},s.and=function(k){for(var S=Math.max(this.g.length,k.g.length),E=[],D=0;D<S;D++)E[D]=this.i(D)&k.i(D);return new o(E,this.h&k.h)},s.or=function(k){for(var S=Math.max(this.g.length,k.g.length),E=[],D=0;D<S;D++)E[D]=this.i(D)|k.i(D);return new o(E,this.h|k.h)},s.xor=function(k){for(var S=Math.max(this.g.length,k.g.length),E=[],D=0;D<S;D++)E[D]=this.i(D)^k.i(D);return new o(E,this.h^k.h)};function q(k){for(var S=k.g.length+1,E=[],D=0;D<S;D++)E[D]=k.i(D)<<1|k.i(D-1)>>>31;return new o(E,k.h)}function ie(k,S){var E=S>>5;S%=32;for(var D=k.g.length-E,L=[],F=0;F<D;F++)L[F]=0<S?k.i(F+E)>>>S|k.i(F+E+1)<<32-S:k.i(F+E);return new o(L,k.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,Yc=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=h,o.fromString=d,Bi=o}).apply(typeof bl<"u"?bl:typeof self<"u"?self:typeof window<"u"?window:{});var ts=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Qc,ar,Kc,ls,Ao,Jc,$c,eh;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(u,g,_){return u==Array.prototype||u==Object.prototype||(u[g]=_.value),u};function e(u){u=[typeof globalThis=="object"&&globalThis,u,typeof window=="object"&&window,typeof self=="object"&&self,typeof ts=="object"&&ts];for(var g=0;g<u.length;++g){var _=u[g];if(_&&_.Math==Math)return _}throw Error("Cannot find global object")}var i=e(this);function n(u,g){if(g)e:{var _=i;u=u.split(".");for(var P=0;P<u.length-1;P++){var H=u[P];if(!(H in _))break e;_=_[H]}u=u[u.length-1],P=_[u],g=g(P),g!=P&&g!=null&&t(_,u,{configurable:!0,writable:!0,value:g})}}function r(u,g){u instanceof String&&(u+="");var _=0,P=!1,H={next:function(){if(!P&&_<u.length){var z=_++;return{value:g(z,u[z]),done:!1}}return P=!0,{done:!0,value:void 0}}};return H[Symbol.iterator]=function(){return H},H}n("Array.prototype.values",function(u){return u||function(){return r(this,function(g,_){return _})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function c(u){var g=typeof u;return g=g!="object"?g:u?Array.isArray(u)?"array":g:"null",g=="array"||g=="object"&&typeof u.length=="number"}function h(u){var g=typeof u;return g=="object"&&u!=null||g=="function"}function d(u,g,_){return u.call.apply(u.bind,arguments)}function l(u,g,_){if(!u)throw Error();if(2<arguments.length){var P=Array.prototype.slice.call(arguments,2);return function(){var H=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(H,P),u.apply(g,H)}}return function(){return u.apply(g,arguments)}}function p(u,g,_){return p=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:l,p.apply(null,arguments)}function f(u,g){var _=Array.prototype.slice.call(arguments,1);return function(){var P=_.slice();return P.push.apply(P,arguments),u.apply(this,P)}}function m(u,g){function _(){}_.prototype=g.prototype,u.aa=g.prototype,u.prototype=new _,u.prototype.constructor=u,u.Qb=function(P,H,z){for(var ae=Array(arguments.length-2),$e=2;$e<arguments.length;$e++)ae[$e-2]=arguments[$e];return g.prototype[H].apply(P,ae)}}function v(u){const g=u.length;if(0<g){const _=Array(g);for(let P=0;P<g;P++)_[P]=u[P];return _}return[]}function w(u,g){for(let _=1;_<arguments.length;_++){const P=arguments[_];if(c(P)){const H=u.length||0,z=P.length||0;u.length=H+z;for(let ae=0;ae<z;ae++)u[H+ae]=P[ae]}else u.push(P)}}class b{constructor(g,_){this.i=g,this.j=_,this.h=0,this.g=null}get(){let g;return 0<this.h?(this.h--,g=this.g,this.g=g.next,g.next=null):g=this.i(),g}}function I(u){return/^[\s\xa0]*$/.test(u)}function O(){var u=a.navigator;return u&&(u=u.userAgent)?u:""}function N(u){return N[" "](u),u}N[" "]=function(){};var q=O().indexOf("Gecko")!=-1&&!(O().toLowerCase().indexOf("webkit")!=-1&&O().indexOf("Edge")==-1)&&!(O().indexOf("Trident")!=-1||O().indexOf("MSIE")!=-1)&&O().indexOf("Edge")==-1;function ie(u,g,_){for(const P in u)g.call(_,u[P],P,u)}function k(u,g){for(const _ in u)g.call(void 0,u[_],_,u)}function S(u){const g={};for(const _ in u)g[_]=u[_];return g}const E="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function D(u,g){let _,P;for(let H=1;H<arguments.length;H++){P=arguments[H];for(_ in P)u[_]=P[_];for(let z=0;z<E.length;z++)_=E[z],Object.prototype.hasOwnProperty.call(P,_)&&(u[_]=P[_])}}function L(u){var g=1;u=u.split(":");const _=[];for(;0<g&&u.length;)_.push(u.shift()),g--;return u.length&&_.push(u.join(":")),_}function F(u){a.setTimeout(()=>{throw u},0)}function A(){var u=$;let g=null;return u.g&&(g=u.g,u.g=u.g.next,u.g||(u.h=null),g.next=null),g}class V{constructor(){this.h=this.g=null}add(g,_){const P=ne.get();P.set(g,_),this.h?this.h.next=P:this.g=P,this.h=P}}var ne=new b(()=>new ce,u=>u.reset());class ce{constructor(){this.next=this.g=this.h=null}set(g,_){this.h=g,this.g=_,this.next=null}reset(){this.next=this.g=this.h=null}}let G,J=!1,$=new V,oe=()=>{const u=a.Promise.resolve(void 0);G=()=>{u.then(Oe)}};var Oe=()=>{for(var u;u=A();){try{u.h.call(u.g)}catch(_){F(_)}var g=ne;g.j(u),100>g.h&&(g.h++,u.next=g.g,g.g=u)}J=!1};function we(){this.s=this.s,this.C=this.C}we.prototype.s=!1,we.prototype.ma=function(){this.s||(this.s=!0,this.N())},we.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function W(u,g){this.type=u,this.g=this.target=g,this.defaultPrevented=!1}W.prototype.h=function(){this.defaultPrevented=!0};var _e=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var u=!1,g=Object.defineProperty({},"passive",{get:function(){u=!0}});try{const _=()=>{};a.addEventListener("test",_,g),a.removeEventListener("test",_,g)}catch{}return u}();function ze(u,g){if(W.call(this,u?u.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,u){var _=this.type=u.type,P=u.changedTouches&&u.changedTouches.length?u.changedTouches[0]:null;if(this.target=u.target||u.srcElement,this.g=g,g=u.relatedTarget){if(q){e:{try{N(g.nodeName);var H=!0;break e}catch{}H=!1}H||(g=null)}}else _=="mouseover"?g=u.fromElement:_=="mouseout"&&(g=u.toElement);this.relatedTarget=g,P?(this.clientX=P.clientX!==void 0?P.clientX:P.pageX,this.clientY=P.clientY!==void 0?P.clientY:P.pageY,this.screenX=P.screenX||0,this.screenY=P.screenY||0):(this.clientX=u.clientX!==void 0?u.clientX:u.pageX,this.clientY=u.clientY!==void 0?u.clientY:u.pageY,this.screenX=u.screenX||0,this.screenY=u.screenY||0),this.button=u.button,this.key=u.key||"",this.ctrlKey=u.ctrlKey,this.altKey=u.altKey,this.shiftKey=u.shiftKey,this.metaKey=u.metaKey,this.pointerId=u.pointerId||0,this.pointerType=typeof u.pointerType=="string"?u.pointerType:gt[u.pointerType]||"",this.state=u.state,this.i=u,u.defaultPrevented&&ze.aa.h.call(this)}}m(ze,W);var gt={2:"touch",3:"pen",4:"mouse"};ze.prototype.h=function(){ze.aa.h.call(this);var u=this.i;u.preventDefault?u.preventDefault():u.returnValue=!1};var Le="closure_listenable_"+(1e6*Math.random()|0),vt=0;function ht(u,g,_,P,H){this.listener=u,this.proxy=null,this.src=g,this.type=_,this.capture=!!P,this.ha=H,this.key=++vt,this.da=this.fa=!1}function yt(u){u.da=!0,u.listener=null,u.proxy=null,u.src=null,u.ha=null}function at(u){this.src=u,this.g={},this.h=0}at.prototype.add=function(u,g,_,P,H){var z=u.toString();u=this.g[z],u||(u=this.g[z]=[],this.h++);var ae=ut(u,g,P,H);return-1<ae?(g=u[ae],_||(g.fa=!1)):(g=new ht(g,this.src,z,!!P,H),g.fa=_,u.push(g)),g};function rt(u,g){var _=g.type;if(_ in u.g){var P=u.g[_],H=Array.prototype.indexOf.call(P,g,void 0),z;(z=0<=H)&&Array.prototype.splice.call(P,H,1),z&&(yt(g),u.g[_].length==0&&(delete u.g[_],u.h--))}}function ut(u,g,_,P){for(var H=0;H<u.length;++H){var z=u[H];if(!z.da&&z.listener==g&&z.capture==!!_&&z.ha==P)return H}return-1}var dt="closure_lm_"+(1e6*Math.random()|0),ge={};function Je(u,g,_,P,H){if(Array.isArray(g)){for(var z=0;z<g.length;z++)Je(u,g[z],_,P,H);return null}return _=Be(_),u&&u[Le]?u.K(g,_,h(P)?!!P.capture:!1,H):y(u,g,_,!1,P,H)}function y(u,g,_,P,H,z){if(!g)throw Error("Invalid event type");var ae=h(H)?!!H.capture:!!H,$e=X(u);if($e||(u[dt]=$e=new at(u)),_=$e.add(g,_,P,ae,z),_.proxy)return _;if(P=R(),_.proxy=P,P.src=u,P.listener=_,u.addEventListener)_e||(H=ae),H===void 0&&(H=!1),u.addEventListener(g.toString(),P,H);else if(u.attachEvent)u.attachEvent(re(g.toString()),P);else if(u.addListener&&u.removeListener)u.addListener(P);else throw Error("addEventListener and attachEvent are unavailable.");return _}function R(){function u(_){return g.call(u.src,u.listener,_)}const g=me;return u}function B(u,g,_,P,H){if(Array.isArray(g))for(var z=0;z<g.length;z++)B(u,g[z],_,P,H);else P=h(P)?!!P.capture:!!P,_=Be(_),u&&u[Le]?(u=u.i,g=String(g).toString(),g in u.g&&(z=u.g[g],_=ut(z,_,P,H),-1<_&&(yt(z[_]),Array.prototype.splice.call(z,_,1),z.length==0&&(delete u.g[g],u.h--)))):u&&(u=X(u))&&(g=u.g[g.toString()],u=-1,g&&(u=ut(g,_,P,H)),(_=-1<u?g[u]:null)&&K(_))}function K(u){if(typeof u!="number"&&u&&!u.da){var g=u.src;if(g&&g[Le])rt(g.i,u);else{var _=u.type,P=u.proxy;g.removeEventListener?g.removeEventListener(_,P,u.capture):g.detachEvent?g.detachEvent(re(_),P):g.addListener&&g.removeListener&&g.removeListener(P),(_=X(g))?(rt(_,u),_.h==0&&(_.src=null,g[dt]=null)):yt(u)}}}function re(u){return u in ge?ge[u]:ge[u]="on"+u}function me(u,g){if(u.da)u=!0;else{g=new ze(g,this);var _=u.listener,P=u.ha||u.src;u.fa&&K(u),u=_.call(P,g)}return u}function X(u){return u=u[dt],u instanceof at?u:null}var Ce="__closure_events_fn_"+(1e9*Math.random()>>>0);function Be(u){return typeof u=="function"?u:(u[Ce]||(u[Ce]=function(g){return u.handleEvent(g)}),u[Ce])}function ke(){we.call(this),this.i=new at(this),this.M=this,this.F=null}m(ke,we),ke.prototype[Le]=!0,ke.prototype.removeEventListener=function(u,g,_,P){B(this,u,g,_,P)};function ve(u,g){var _,P=u.F;if(P)for(_=[];P;P=P.F)_.push(P);if(u=u.M,P=g.type||g,typeof g=="string")g=new W(g,u);else if(g instanceof W)g.target=g.target||u;else{var H=g;g=new W(P,u),D(g,H)}if(H=!0,_)for(var z=_.length-1;0<=z;z--){var ae=g.g=_[z];H=Xe(ae,P,!0,g)&&H}if(ae=g.g=u,H=Xe(ae,P,!0,g)&&H,H=Xe(ae,P,!1,g)&&H,_)for(z=0;z<_.length;z++)ae=g.g=_[z],H=Xe(ae,P,!1,g)&&H}ke.prototype.N=function(){if(ke.aa.N.call(this),this.i){var u=this.i,g;for(g in u.g){for(var _=u.g[g],P=0;P<_.length;P++)yt(_[P]);delete u.g[g],u.h--}}this.F=null},ke.prototype.K=function(u,g,_,P){return this.i.add(String(u),g,!1,_,P)},ke.prototype.L=function(u,g,_,P){return this.i.add(String(u),g,!0,_,P)};function Xe(u,g,_,P){if(g=u.i.g[String(g)],!g)return!0;g=g.concat();for(var H=!0,z=0;z<g.length;++z){var ae=g[z];if(ae&&!ae.da&&ae.capture==_){var $e=ae.listener,Ot=ae.ha||ae.src;ae.fa&&rt(u.i,ae),H=$e.call(Ot,P)!==!1&&H}}return H&&!P.defaultPrevented}function x(u,g,_){if(typeof u=="function")_&&(u=p(u,_));else if(u&&typeof u.handleEvent=="function")u=p(u.handleEvent,u);else throw Error("Invalid listener argument");return 2147483647<Number(g)?-1:a.setTimeout(u,g||0)}function T(u){u.g=x(()=>{u.g=null,u.i&&(u.i=!1,T(u))},u.l);const g=u.h;u.h=null,u.m.apply(null,g)}class C extends we{constructor(g,_){super(),this.m=g,this.l=_,this.h=null,this.i=!1,this.g=null}j(g){this.h=arguments,this.g?this.i=!0:T(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function M(u){we.call(this),this.h=u,this.g={}}m(M,we);var U=[];function te(u){ie(u.g,function(g,_){this.g.hasOwnProperty(_)&&K(g)},u),u.g={}}M.prototype.N=function(){M.aa.N.call(this),te(this)},M.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var xe=a.JSON.stringify,We=a.JSON.parse,Pe=class{stringify(u){return a.JSON.stringify(u,void 0)}parse(u){return a.JSON.parse(u,void 0)}};function Pt(){}Pt.prototype.h=null;function st(u){return u.h||(u.h=u.i())}function ti(){}var ci={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Si(){W.call(this,"d")}m(Si,W);function Pi(){W.call(this,"c")}m(Pi,W);var yi={},Fr=null;function Ki(){return Fr=Fr||new ke}yi.La="serverreachability";function Zn(u){W.call(this,yi.La,u)}m(Zn,W);function Ci(u){const g=Ki();ve(g,new Zn(g))}yi.STAT_EVENT="statevent";function Lr(u,g){W.call(this,yi.STAT_EVENT,u),this.stat=g}m(Lr,W);function It(u){const g=Ki();ve(g,new Lr(g,u))}yi.Ma="timingevent";function Xn(u,g){W.call(this,yi.Ma,u),this.size=g}m(Xn,W);function Ai(u,g){if(typeof u!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){u()},g)}function Ri(){this.g=!0}Ri.prototype.xa=function(){this.g=!1};function Vr(u,g,_,P,H,z){u.info(function(){if(u.g)if(z)for(var ae="",$e=z.split("&"),Ot=0;Ot<$e.length;Ot++){var Ge=$e[Ot].split("=");if(1<Ge.length){var Nt=Ge[0];Ge=Ge[1];var zt=Nt.split("_");ae=2<=zt.length&&zt[1]=="type"?ae+(Nt+"="+Ge+"&"):ae+(Nt+"=redacted&")}}else ae=null;else ae=z;return"XMLHTTP REQ ("+P+") [attempt "+H+"]: "+g+`
`+_+`
`+ae})}function Br(u,g,_,P,H,z,ae){u.info(function(){return"XMLHTTP RESP ("+P+") [ attempt "+H+"]: "+g+`
`+_+`
`+z+" "+ae})}function wi(u,g,_,P){u.info(function(){return"XMLHTTP TEXT ("+g+"): "+Ee(u,_)+(P?" "+P:"")})}function ee(u,g){u.info(function(){return"TIMEOUT: "+g})}Ri.prototype.info=function(){};function Ee(u,g){if(!u.g)return g;if(!g)return null;try{var _=JSON.parse(g);if(_){for(u=0;u<_.length;u++)if(Array.isArray(_[u])){var P=_[u];if(!(2>P.length)){var H=P[1];if(Array.isArray(H)&&!(1>H.length)){var z=H[0];if(z!="noop"&&z!="stop"&&z!="close")for(var ae=1;ae<H.length;ae++)H[ae]=""}}}}return xe(_)}catch{return g}}var ue={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Y={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},le;function Ae(){}m(Ae,Pt),Ae.prototype.g=function(){return new XMLHttpRequest},Ae.prototype.i=function(){return{}},le=new Ae;function pe(u,g,_,P){this.j=u,this.i=g,this.l=_,this.R=P||1,this.U=new M(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new be}function be(){this.i=null,this.g="",this.h=!1}var lt={},Ye={};function pt(u,g,_){u.L=1,u.v=$i(Qt(g)),u.m=_,u.P=!0,Bt(u,null)}function Bt(u,g){u.F=Date.now(),ft(u),u.A=Qt(u.v);var _=u.A,P=u.R;Array.isArray(P)||(P=[String(P)]),Fa(_.i,"t",P),u.C=0,_=u.j.J,u.h=new be,u.g=$a(u.j,_?g:null,!u.m),0<u.O&&(u.M=new C(p(u.Y,u,u.g),u.O)),g=u.U,_=u.g,P=u.ca;var H="readystatechange";Array.isArray(H)||(H&&(U[0]=H.toString()),H=U);for(var z=0;z<H.length;z++){var ae=Je(_,H[z],P||g.handleEvent,!1,g.h||g);if(!ae)break;g.g[ae.key]=ae}g=u.H?S(u.H):{},u.m?(u.u||(u.u="POST"),g["Content-Type"]="application/x-www-form-urlencoded",u.g.ea(u.A,u.u,u.m,g)):(u.u="GET",u.g.ea(u.A,u.u,null,g)),Ci(),Vr(u.i,u.u,u.A,u.l,u.R,u.m)}pe.prototype.ca=function(u){u=u.target;const g=this.M;g&&_i(u)==3?g.j():this.Y(u)},pe.prototype.Y=function(u){try{if(u==this.g)e:{const zt=_i(this.g);var g=this.g.Ba();const Tn=this.g.Z();if(!(3>zt)&&(zt!=3||this.g&&(this.h.h||this.g.oa()||Ua(this.g)))){this.J||zt!=4||g==7||(g==8||0>=Tn?Ci(3):Ci(2)),Yt(this);var _=this.g.Z();this.X=_;t:if(Dt(this)){var P=Ua(this.g);u="";var H=P.length,z=_i(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){wt(this),Qe(this);var ae="";break t}this.h.i=new a.TextDecoder}for(g=0;g<H;g++)this.h.h=!0,u+=this.h.i.decode(P[g],{stream:!(z&&g==H-1)});P.length=0,this.h.g+=u,this.C=0,ae=this.h.g}else ae=this.g.oa();if(this.o=_==200,Br(this.i,this.u,this.A,this.l,this.R,zt,_),this.o){if(this.T&&!this.K){t:{if(this.g){var $e,Ot=this.g;if(($e=Ot.g?Ot.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!I($e)){var Ge=$e;break t}}Ge=null}if(_=Ge)wi(this.i,this.l,_,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ht(this,_);else{this.o=!1,this.s=3,It(12),wt(this),Qe(this);break e}}if(this.P){_=!0;let ni;for(;!this.J&&this.C<ae.length;)if(ni=$t(this,ae),ni==Ye){zt==4&&(this.s=4,It(14),_=!1),wi(this.i,this.l,null,"[Incomplete Response]");break}else if(ni==lt){this.s=4,It(15),wi(this.i,this.l,ae,"[Invalid Chunk]"),_=!1;break}else wi(this.i,this.l,ni,null),Ht(this,ni);if(Dt(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),zt!=4||ae.length!=0||this.h.h||(this.s=1,It(16),_=!1),this.o=this.o&&_,!_)wi(this.i,this.l,ae,"[Invalid Chunked Response]"),wt(this),Qe(this);else if(0<ae.length&&!this.W){this.W=!0;var Nt=this.j;Nt.g==this&&Nt.ba&&!Nt.M&&(Nt.j.info("Great, no buffering proxy detected. Bytes received: "+ae.length),io(Nt),Nt.M=!0,It(11))}}else wi(this.i,this.l,ae,null),Ht(this,ae);zt==4&&wt(this),this.o&&!this.J&&(zt==4?Ya(this.j,this):(this.o=!1,ft(this)))}else Lu(this.g),_==400&&0<ae.indexOf("Unknown SID")?(this.s=3,It(12)):(this.s=0,It(13)),wt(this),Qe(this)}}}catch{}finally{}};function Dt(u){return u.g?u.u=="GET"&&u.L!=2&&u.j.Ca:!1}function $t(u,g){var _=u.C,P=g.indexOf(`
`,_);return P==-1?Ye:(_=Number(g.substring(_,P)),isNaN(_)?lt:(P+=1,P+_>g.length?Ye:(g=g.slice(P,P+_),u.C=P+_,g)))}pe.prototype.cancel=function(){this.J=!0,wt(this)};function ft(u){u.S=Date.now()+u.I,kt(u,u.I)}function kt(u,g){if(u.B!=null)throw Error("WatchDog timer not null");u.B=Ai(p(u.ba,u),g)}function Yt(u){u.B&&(a.clearTimeout(u.B),u.B=null)}pe.prototype.ba=function(){this.B=null;const u=Date.now();0<=u-this.S?(ee(this.i,this.A),this.L!=2&&(Ci(),It(17)),wt(this),this.s=2,Qe(this)):kt(this,this.S-u)};function Qe(u){u.j.G==0||u.J||Ya(u.j,u)}function wt(u){Yt(u);var g=u.M;g&&typeof g.ma=="function"&&g.ma(),u.M=null,te(u.U),u.g&&(g=u.g,u.g=null,g.abort(),g.ma())}function Ht(u,g){try{var _=u.j;if(_.G!=0&&(_.g==u||mn(_.h,u))){if(!u.K&&mn(_.h,u)&&_.G==3){try{var P=_.Da.g.parse(g)}catch{P=null}if(Array.isArray(P)&&P.length==3){var H=P;if(H[0]==0){e:if(!_.u){if(_.g)if(_.g.F+3e3<u.F)Xr(_),Gr(_);else break e;to(_),It(18)}}else _.za=H[1],0<_.za-_.T&&37500>H[2]&&_.F&&_.v==0&&!_.C&&(_.C=Ai(p(_.Za,_),6e3));if(1>=Yn(_.h)&&_.ca){try{_.ca()}catch{}_.ca=void 0}}else en(_,11)}else if((u.K||_.g==u)&&Xr(_),!I(g))for(H=_.Da.g.parse(g),g=0;g<H.length;g++){let Ge=H[g];if(_.T=Ge[0],Ge=Ge[1],_.G==2)if(Ge[0]=="c"){_.K=Ge[1],_.ia=Ge[2];const Nt=Ge[3];Nt!=null&&(_.la=Nt,_.j.info("VER="+_.la));const zt=Ge[4];zt!=null&&(_.Aa=zt,_.j.info("SVER="+_.Aa));const Tn=Ge[5];Tn!=null&&typeof Tn=="number"&&0<Tn&&(P=1.5*Tn,_.L=P,_.j.info("backChannelRequestTimeoutMs_="+P)),P=_;const ni=u.g;if(ni){const Qr=ni.g?ni.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Qr){var z=P.h;z.g||Qr.indexOf("spdy")==-1&&Qr.indexOf("quic")==-1&&Qr.indexOf("h2")==-1||(z.j=z.l,z.g=new Set,z.h&&(gn(z,z.h),z.h=null))}if(P.D){const no=ni.g?ni.g.getResponseHeader("X-HTTP-Session-Id"):null;no&&(P.ya=no,Ke(P.I,P.D,no))}}_.G=3,_.l&&_.l.ua(),_.ba&&(_.R=Date.now()-u.F,_.j.info("Handshake RTT: "+_.R+"ms")),P=_;var ae=u;if(P.qa=Ja(P,P.J?P.ia:null,P.W),ae.K){vn(P.h,ae);var $e=ae,Ot=P.L;Ot&&($e.I=Ot),$e.B&&(Yt($e),ft($e)),P.g=ae}else Za(P);0<_.i.length&&Zr(_)}else Ge[0]!="stop"&&Ge[0]!="close"||en(_,7);else _.G==3&&(Ge[0]=="stop"||Ge[0]=="close"?Ge[0]=="stop"?en(_,7):eo(_):Ge[0]!="noop"&&_.l&&_.l.ta(Ge),_.v=0)}}Ci(4)}catch{}}var Ii=class{constructor(u,g){this.g=u,this.map=g}};function fn(u){this.l=u||10,a.PerformanceNavigationTiming?(u=a.performance.getEntriesByType("navigation"),u=0<u.length&&(u[0].nextHopProtocol=="hq"||u[0].nextHopProtocol=="h2")):u=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=u?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Hr(u){return u.h?!0:u.g?u.g.size>=u.j:!1}function Yn(u){return u.h?1:u.g?u.g.size:0}function mn(u,g){return u.h?u.h==g:u.g?u.g.has(g):!1}function gn(u,g){u.g?u.g.add(g):u.h=g}function vn(u,g){u.h&&u.h==g?u.h=null:u.g&&u.g.has(g)&&u.g.delete(g)}fn.prototype.cancel=function(){if(this.i=Nr(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const u of this.g.values())u.cancel();this.g.clear()}};function Nr(u){if(u.h!=null)return u.i.concat(u.h.D);if(u.g!=null&&u.g.size!==0){let g=u.i;for(const _ of u.g.values())g=g.concat(_.D);return g}return v(u.i)}function zr(u){if(u.V&&typeof u.V=="function")return u.V();if(typeof Map<"u"&&u instanceof Map||typeof Set<"u"&&u instanceof Set)return Array.from(u.values());if(typeof u=="string")return u.split("");if(c(u)){for(var g=[],_=u.length,P=0;P<_;P++)g.push(u[P]);return g}g=[],_=0;for(P in u)g[_++]=u[P];return g}function Ur(u){if(u.na&&typeof u.na=="function")return u.na();if(!u.V||typeof u.V!="function"){if(typeof Map<"u"&&u instanceof Map)return Array.from(u.keys());if(!(typeof Set<"u"&&u instanceof Set)){if(c(u)||typeof u=="string"){var g=[];u=u.length;for(var _=0;_<u;_++)g.push(_);return g}g=[],_=0;for(const P in u)g[_++]=P;return g}}}function yn(u,g){if(u.forEach&&typeof u.forEach=="function")u.forEach(g,void 0);else if(c(u)||typeof u=="string")Array.prototype.forEach.call(u,g,void 0);else for(var _=Ur(u),P=zr(u),H=P.length,z=0;z<H;z++)g.call(void 0,P[z],_&&_[z],u)}var Re=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function et(u,g){if(u){u=u.split("&");for(var _=0;_<u.length;_++){var P=u[_].indexOf("="),H=null;if(0<=P){var z=u[_].substring(0,P);H=u[_].substring(P+1)}else z=u[_];g(z,H?decodeURIComponent(H.replace(/\+/g," ")):"")}}}function ii(u){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,u instanceof ii){this.h=u.h,Mi(this,u.j),this.o=u.o,this.g=u.g,Ji(this,u.s),this.l=u.l;var g=u.i,_=new $n;_.i=g.i,g.g&&(_.g=new Map(g.g),_.h=g.h),Qn(this,_),this.m=u.m}else u&&(g=String(u).match(Re))?(this.h=!1,Mi(this,g[1]||"",!0),this.o=Kn(g[2]||""),this.g=Kn(g[3]||"",!0),Ji(this,g[4]),this.l=Kn(g[5]||"",!0),Qn(this,g[6]||"",!0),this.m=Kn(g[7]||"")):(this.h=!1,this.i=new $n(null,this.h))}ii.prototype.toString=function(){var u=[],g=this.j;g&&u.push(Jn(g,Da,!0),":");var _=this.g;return(_||g=="file")&&(u.push("//"),(g=this.o)&&u.push(Jn(g,Da,!0),"@"),u.push(encodeURIComponent(String(_)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),_=this.s,_!=null&&u.push(":",String(_))),(_=this.l)&&(this.g&&_.charAt(0)!="/"&&u.push("/"),u.push(Jn(_,_.charAt(0)=="/"?Pu:Su,!0))),(_=this.i.toString())&&u.push("?",_),(_=this.m)&&u.push("#",Jn(_,Au)),u.join("")};function Qt(u){return new ii(u)}function Mi(u,g,_){u.j=_?Kn(g,!0):g,u.j&&(u.j=u.j.replace(/:$/,""))}function Ji(u,g){if(g){if(g=Number(g),isNaN(g)||0>g)throw Error("Bad port number "+g);u.s=g}else u.s=null}function Qn(u,g,_){g instanceof $n?(u.i=g,Ru(u.i,u.h)):(_||(g=Jn(g,Cu)),u.i=new $n(g,u.h))}function Ke(u,g,_){u.i.set(g,_)}function $i(u){return Ke(u,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),u}function Kn(u,g){return u?g?decodeURI(u.replace(/%25/g,"%2525")):decodeURIComponent(u):""}function Jn(u,g,_){return typeof u=="string"?(u=encodeURI(u).replace(g,Eu),_&&(u=u.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),u):null}function Eu(u){return u=u.charCodeAt(0),"%"+(u>>4&15).toString(16)+(u&15).toString(16)}var Da=/[#\/\?@]/g,Su=/[#\?:]/g,Pu=/[#\?]/g,Cu=/[#\?@]/g,Au=/#/g;function $n(u,g){this.h=this.g=null,this.i=u||null,this.j=!!g}function Di(u){u.g||(u.g=new Map,u.h=0,u.i&&et(u.i,function(g,_){u.add(decodeURIComponent(g.replace(/\+/g," ")),_)}))}s=$n.prototype,s.add=function(u,g){Di(this),this.i=null,u=wn(this,u);var _=this.g.get(u);return _||this.g.set(u,_=[]),_.push(g),this.h+=1,this};function ka(u,g){Di(u),g=wn(u,g),u.g.has(g)&&(u.i=null,u.h-=u.g.get(g).length,u.g.delete(g))}function Oa(u,g){return Di(u),g=wn(u,g),u.g.has(g)}s.forEach=function(u,g){Di(this),this.g.forEach(function(_,P){_.forEach(function(H){u.call(g,H,P,this)},this)},this)},s.na=function(){Di(this);const u=Array.from(this.g.values()),g=Array.from(this.g.keys()),_=[];for(let P=0;P<g.length;P++){const H=u[P];for(let z=0;z<H.length;z++)_.push(g[P])}return _},s.V=function(u){Di(this);let g=[];if(typeof u=="string")Oa(this,u)&&(g=g.concat(this.g.get(wn(this,u))));else{u=Array.from(this.g.values());for(let _=0;_<u.length;_++)g=g.concat(u[_])}return g},s.set=function(u,g){return Di(this),this.i=null,u=wn(this,u),Oa(this,u)&&(this.h-=this.g.get(u).length),this.g.set(u,[g]),this.h+=1,this},s.get=function(u,g){return u?(u=this.V(u),0<u.length?String(u[0]):g):g};function Fa(u,g,_){ka(u,g),0<_.length&&(u.i=null,u.g.set(wn(u,g),v(_)),u.h+=_.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const u=[],g=Array.from(this.g.keys());for(var _=0;_<g.length;_++){var P=g[_];const z=encodeURIComponent(String(P)),ae=this.V(P);for(P=0;P<ae.length;P++){var H=z;ae[P]!==""&&(H+="="+encodeURIComponent(String(ae[P]))),u.push(H)}}return this.i=u.join("&")};function wn(u,g){return g=String(g),u.j&&(g=g.toLowerCase()),g}function Ru(u,g){g&&!u.j&&(Di(u),u.i=null,u.g.forEach(function(_,P){var H=P.toLowerCase();P!=H&&(ka(this,P),Fa(this,H,_))},u)),u.j=g}function Iu(u,g){const _=new Ri;if(a.Image){const P=new Image;P.onload=f(ki,_,"TestLoadImage: loaded",!0,g,P),P.onerror=f(ki,_,"TestLoadImage: error",!1,g,P),P.onabort=f(ki,_,"TestLoadImage: abort",!1,g,P),P.ontimeout=f(ki,_,"TestLoadImage: timeout",!1,g,P),a.setTimeout(function(){P.ontimeout&&P.ontimeout()},1e4),P.src=u}else g(!1)}function Mu(u,g){const _=new Ri,P=new AbortController,H=setTimeout(()=>{P.abort(),ki(_,"TestPingServer: timeout",!1,g)},1e4);fetch(u,{signal:P.signal}).then(z=>{clearTimeout(H),z.ok?ki(_,"TestPingServer: ok",!0,g):ki(_,"TestPingServer: server error",!1,g)}).catch(()=>{clearTimeout(H),ki(_,"TestPingServer: error",!1,g)})}function ki(u,g,_,P,H){try{H&&(H.onload=null,H.onerror=null,H.onabort=null,H.ontimeout=null),P(_)}catch{}}function Du(){this.g=new Pe}function ku(u,g,_){const P=_||"";try{yn(u,function(H,z){let ae=H;h(H)&&(ae=xe(H)),g.push(P+z+"="+encodeURIComponent(ae))})}catch(H){throw g.push(P+"type="+encodeURIComponent("_badmap")),H}}function jr(u){this.l=u.Ub||null,this.j=u.eb||!1}m(jr,Pt),jr.prototype.g=function(){return new qr(this.l,this.j)},jr.prototype.i=function(u){return function(){return u}}({});function qr(u,g){ke.call(this),this.D=u,this.o=g,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}m(qr,ke),s=qr.prototype,s.open=function(u,g){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=u,this.A=g,this.readyState=1,tr(this)},s.send=function(u){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const g={headers:this.u,method:this.B,credentials:this.m,cache:void 0};u&&(g.body=u),(this.D||a).fetch(new Request(this.A,g)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,er(this)),this.readyState=0},s.Sa=function(u){if(this.g&&(this.l=u,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=u.headers,this.readyState=2,tr(this)),this.g&&(this.readyState=3,tr(this),this.g)))if(this.responseType==="arraybuffer")u.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in u){if(this.j=u.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;La(this)}else u.text().then(this.Ra.bind(this),this.ga.bind(this))};function La(u){u.j.read().then(u.Pa.bind(u)).catch(u.ga.bind(u))}s.Pa=function(u){if(this.g){if(this.o&&u.value)this.response.push(u.value);else if(!this.o){var g=u.value?u.value:new Uint8Array(0);(g=this.v.decode(g,{stream:!u.done}))&&(this.response=this.responseText+=g)}u.done?er(this):tr(this),this.readyState==3&&La(this)}},s.Ra=function(u){this.g&&(this.response=this.responseText=u,er(this))},s.Qa=function(u){this.g&&(this.response=u,er(this))},s.ga=function(){this.g&&er(this)};function er(u){u.readyState=4,u.l=null,u.j=null,u.v=null,tr(u)}s.setRequestHeader=function(u,g){this.u.append(u,g)},s.getResponseHeader=function(u){return this.h&&this.h.get(u.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const u=[],g=this.h.entries();for(var _=g.next();!_.done;)_=_.value,u.push(_[0]+": "+_[1]),_=g.next();return u.join(`\r
`)};function tr(u){u.onreadystatechange&&u.onreadystatechange.call(u)}Object.defineProperty(qr.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(u){this.m=u?"include":"same-origin"}});function Va(u){let g="";return ie(u,function(_,P){g+=P,g+=":",g+=_,g+=`\r
`}),g}function $s(u,g,_){e:{for(P in _){var P=!1;break e}P=!0}P||(_=Va(_),typeof u=="string"?_!=null&&encodeURIComponent(String(_)):Ke(u,g,_))}function ct(u){ke.call(this),this.headers=new Map,this.o=u||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}m(ct,ke);var Ou=/^https?$/i,Fu=["POST","PUT"];s=ct.prototype,s.Ha=function(u){this.J=u},s.ea=function(u,g,_,P){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+u);g=g?g.toUpperCase():"GET",this.D=u,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():le.g(),this.v=this.o?st(this.o):st(le),this.g.onreadystatechange=p(this.Ea,this);try{this.B=!0,this.g.open(g,String(u),!0),this.B=!1}catch(z){Ba(this,z);return}if(u=_||"",_=new Map(this.headers),P)if(Object.getPrototypeOf(P)===Object.prototype)for(var H in P)_.set(H,P[H]);else if(typeof P.keys=="function"&&typeof P.get=="function")for(const z of P.keys())_.set(z,P.get(z));else throw Error("Unknown input type for opt_headers: "+String(P));P=Array.from(_.keys()).find(z=>z.toLowerCase()=="content-type"),H=a.FormData&&u instanceof a.FormData,!(0<=Array.prototype.indexOf.call(Fu,g,void 0))||P||H||_.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[z,ae]of _)this.g.setRequestHeader(z,ae);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{za(this),this.u=!0,this.g.send(u),this.u=!1}catch(z){Ba(this,z)}};function Ba(u,g){u.h=!1,u.g&&(u.j=!0,u.g.abort(),u.j=!1),u.l=g,u.m=5,Ha(u),Wr(u)}function Ha(u){u.A||(u.A=!0,ve(u,"complete"),ve(u,"error"))}s.abort=function(u){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=u||7,ve(this,"complete"),ve(this,"abort"),Wr(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Wr(this,!0)),ct.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?Na(this):this.bb())},s.bb=function(){Na(this)};function Na(u){if(u.h&&typeof o<"u"&&(!u.v[1]||_i(u)!=4||u.Z()!=2)){if(u.u&&_i(u)==4)x(u.Ea,0,u);else if(ve(u,"readystatechange"),_i(u)==4){u.h=!1;try{const ae=u.Z();e:switch(ae){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var g=!0;break e;default:g=!1}var _;if(!(_=g)){var P;if(P=ae===0){var H=String(u.D).match(Re)[1]||null;!H&&a.self&&a.self.location&&(H=a.self.location.protocol.slice(0,-1)),P=!Ou.test(H?H.toLowerCase():"")}_=P}if(_)ve(u,"complete"),ve(u,"success");else{u.m=6;try{var z=2<_i(u)?u.g.statusText:""}catch{z=""}u.l=z+" ["+u.Z()+"]",Ha(u)}}finally{Wr(u)}}}}function Wr(u,g){if(u.g){za(u);const _=u.g,P=u.v[0]?()=>{}:null;u.g=null,u.v=null,g||ve(u,"ready");try{_.onreadystatechange=P}catch{}}}function za(u){u.I&&(a.clearTimeout(u.I),u.I=null)}s.isActive=function(){return!!this.g};function _i(u){return u.g?u.g.readyState:0}s.Z=function(){try{return 2<_i(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(u){if(this.g){var g=this.g.responseText;return u&&g.indexOf(u)==0&&(g=g.substring(u.length)),We(g)}};function Ua(u){try{if(!u.g)return null;if("response"in u.g)return u.g.response;switch(u.H){case"":case"text":return u.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in u.g)return u.g.mozResponseArrayBuffer}return null}catch{return null}}function Lu(u){const g={};u=(u.g&&2<=_i(u)&&u.g.getAllResponseHeaders()||"").split(`\r
`);for(let P=0;P<u.length;P++){if(I(u[P]))continue;var _=L(u[P]);const H=_[0];if(_=_[1],typeof _!="string")continue;_=_.trim();const z=g[H]||[];g[H]=z,z.push(_)}k(g,function(P){return P.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function ir(u,g,_){return _&&_.internalChannelParams&&_.internalChannelParams[u]||g}function ja(u){this.Aa=0,this.i=[],this.j=new Ri,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=ir("failFast",!1,u),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=ir("baseRetryDelayMs",5e3,u),this.cb=ir("retryDelaySeedMs",1e4,u),this.Wa=ir("forwardChannelMaxRetries",2,u),this.wa=ir("forwardChannelRequestTimeoutMs",2e4,u),this.pa=u&&u.xmlHttpFactory||void 0,this.Xa=u&&u.Tb||void 0,this.Ca=u&&u.useFetchStreams||!1,this.L=void 0,this.J=u&&u.supportsCrossDomainXhr||!1,this.K="",this.h=new fn(u&&u.concurrentRequestLimit),this.Da=new Du,this.P=u&&u.fastHandshake||!1,this.O=u&&u.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=u&&u.Rb||!1,u&&u.xa&&this.j.xa(),u&&u.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&u&&u.detectBufferingProxy||!1,this.ja=void 0,u&&u.longPollingTimeout&&0<u.longPollingTimeout&&(this.ja=u.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=ja.prototype,s.la=8,s.G=1,s.connect=function(u,g,_,P){It(0),this.W=u,this.H=g||{},_&&P!==void 0&&(this.H.OSID=_,this.H.OAID=P),this.F=this.X,this.I=Ja(this,null,this.W),Zr(this)};function eo(u){if(qa(u),u.G==3){var g=u.U++,_=Qt(u.I);if(Ke(_,"SID",u.K),Ke(_,"RID",g),Ke(_,"TYPE","terminate"),nr(u,_),g=new pe(u,u.j,g),g.L=2,g.v=$i(Qt(_)),_=!1,a.navigator&&a.navigator.sendBeacon)try{_=a.navigator.sendBeacon(g.v.toString(),"")}catch{}!_&&a.Image&&(new Image().src=g.v,_=!0),_||(g.g=$a(g.j,null),g.g.ea(g.v)),g.F=Date.now(),ft(g)}Ka(u)}function Gr(u){u.g&&(io(u),u.g.cancel(),u.g=null)}function qa(u){Gr(u),u.u&&(a.clearTimeout(u.u),u.u=null),Xr(u),u.h.cancel(),u.s&&(typeof u.s=="number"&&a.clearTimeout(u.s),u.s=null)}function Zr(u){if(!Hr(u.h)&&!u.s){u.s=!0;var g=u.Ga;G||oe(),J||(G(),J=!0),$.add(g,u),u.B=0}}function Vu(u,g){return Yn(u.h)>=u.h.j-(u.s?1:0)?!1:u.s?(u.i=g.D.concat(u.i),!0):u.G==1||u.G==2||u.B>=(u.Va?0:u.Wa)?!1:(u.s=Ai(p(u.Ga,u,g),Qa(u,u.B)),u.B++,!0)}s.Ga=function(u){if(this.s)if(this.s=null,this.G==1){if(!u){this.U=Math.floor(1e5*Math.random()),u=this.U++;const H=new pe(this,this.j,u);let z=this.o;if(this.S&&(z?(z=S(z),D(z,this.S)):z=this.S),this.m!==null||this.O||(H.H=z,z=null),this.P)e:{for(var g=0,_=0;_<this.i.length;_++){t:{var P=this.i[_];if("__data__"in P.map&&(P=P.map.__data__,typeof P=="string")){P=P.length;break t}P=void 0}if(P===void 0)break;if(g+=P,4096<g){g=_;break e}if(g===4096||_===this.i.length-1){g=_+1;break e}}g=1e3}else g=1e3;g=Ga(this,H,g),_=Qt(this.I),Ke(_,"RID",u),Ke(_,"CVER",22),this.D&&Ke(_,"X-HTTP-Session-Id",this.D),nr(this,_),z&&(this.O?g="headers="+encodeURIComponent(String(Va(z)))+"&"+g:this.m&&$s(_,this.m,z)),gn(this.h,H),this.Ua&&Ke(_,"TYPE","init"),this.P?(Ke(_,"$req",g),Ke(_,"SID","null"),H.T=!0,pt(H,_,null)):pt(H,_,g),this.G=2}}else this.G==3&&(u?Wa(this,u):this.i.length==0||Hr(this.h)||Wa(this))};function Wa(u,g){var _;g?_=g.l:_=u.U++;const P=Qt(u.I);Ke(P,"SID",u.K),Ke(P,"RID",_),Ke(P,"AID",u.T),nr(u,P),u.m&&u.o&&$s(P,u.m,u.o),_=new pe(u,u.j,_,u.B+1),u.m===null&&(_.H=u.o),g&&(u.i=g.D.concat(u.i)),g=Ga(u,_,1e3),_.I=Math.round(.5*u.wa)+Math.round(.5*u.wa*Math.random()),gn(u.h,_),pt(_,P,g)}function nr(u,g){u.H&&ie(u.H,function(_,P){Ke(g,P,_)}),u.l&&yn({},function(_,P){Ke(g,P,_)})}function Ga(u,g,_){_=Math.min(u.i.length,_);var P=u.l?p(u.l.Na,u.l,u):null;e:{var H=u.i;let z=-1;for(;;){const ae=["count="+_];z==-1?0<_?(z=H[0].g,ae.push("ofs="+z)):z=0:ae.push("ofs="+z);let $e=!0;for(let Ot=0;Ot<_;Ot++){let Ge=H[Ot].g;const Nt=H[Ot].map;if(Ge-=z,0>Ge)z=Math.max(0,H[Ot].g-100),$e=!1;else try{ku(Nt,ae,"req"+Ge+"_")}catch{P&&P(Nt)}}if($e){P=ae.join("&");break e}}}return u=u.i.splice(0,_),g.D=u,P}function Za(u){if(!u.g&&!u.u){u.Y=1;var g=u.Fa;G||oe(),J||(G(),J=!0),$.add(g,u),u.v=0}}function to(u){return u.g||u.u||3<=u.v?!1:(u.Y++,u.u=Ai(p(u.Fa,u),Qa(u,u.v)),u.v++,!0)}s.Fa=function(){if(this.u=null,Xa(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var u=2*this.R;this.j.info("BP detection timer enabled: "+u),this.A=Ai(p(this.ab,this),u)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,It(10),Gr(this),Xa(this))};function io(u){u.A!=null&&(a.clearTimeout(u.A),u.A=null)}function Xa(u){u.g=new pe(u,u.j,"rpc",u.Y),u.m===null&&(u.g.H=u.o),u.g.O=0;var g=Qt(u.qa);Ke(g,"RID","rpc"),Ke(g,"SID",u.K),Ke(g,"AID",u.T),Ke(g,"CI",u.F?"0":"1"),!u.F&&u.ja&&Ke(g,"TO",u.ja),Ke(g,"TYPE","xmlhttp"),nr(u,g),u.m&&u.o&&$s(g,u.m,u.o),u.L&&(u.g.I=u.L);var _=u.g;u=u.ia,_.L=1,_.v=$i(Qt(g)),_.m=null,_.P=!0,Bt(_,u)}s.Za=function(){this.C!=null&&(this.C=null,Gr(this),to(this),It(19))};function Xr(u){u.C!=null&&(a.clearTimeout(u.C),u.C=null)}function Ya(u,g){var _=null;if(u.g==g){Xr(u),io(u),u.g=null;var P=2}else if(mn(u.h,g))_=g.D,vn(u.h,g),P=1;else return;if(u.G!=0){if(g.o)if(P==1){_=g.m?g.m.length:0,g=Date.now()-g.F;var H=u.B;P=Ki(),ve(P,new Xn(P,_)),Zr(u)}else Za(u);else if(H=g.s,H==3||H==0&&0<g.X||!(P==1&&Vu(u,g)||P==2&&to(u)))switch(_&&0<_.length&&(g=u.h,g.i=g.i.concat(_)),H){case 1:en(u,5);break;case 4:en(u,10);break;case 3:en(u,6);break;default:en(u,2)}}}function Qa(u,g){let _=u.Ta+Math.floor(Math.random()*u.cb);return u.isActive()||(_*=2),_*g}function en(u,g){if(u.j.info("Error code "+g),g==2){var _=p(u.fb,u),P=u.Xa;const H=!P;P=new ii(P||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||Mi(P,"https"),$i(P),H?Iu(P.toString(),_):Mu(P.toString(),_)}else It(2);u.G=0,u.l&&u.l.sa(g),Ka(u),qa(u)}s.fb=function(u){u?(this.j.info("Successfully pinged google.com"),It(2)):(this.j.info("Failed to ping google.com"),It(1))};function Ka(u){if(u.G=0,u.ka=[],u.l){const g=Nr(u.h);(g.length!=0||u.i.length!=0)&&(w(u.ka,g),w(u.ka,u.i),u.h.i.length=0,v(u.i),u.i.length=0),u.l.ra()}}function Ja(u,g,_){var P=_ instanceof ii?Qt(_):new ii(_);if(P.g!="")g&&(P.g=g+"."+P.g),Ji(P,P.s);else{var H=a.location;P=H.protocol,g=g?g+"."+H.hostname:H.hostname,H=+H.port;var z=new ii(null);P&&Mi(z,P),g&&(z.g=g),H&&Ji(z,H),_&&(z.l=_),P=z}return _=u.D,g=u.ya,_&&g&&Ke(P,_,g),Ke(P,"VER",u.la),nr(u,P),P}function $a(u,g,_){if(g&&!u.J)throw Error("Can't create secondary domain capable XhrIo object.");return g=u.Ca&&!u.pa?new ct(new jr({eb:_})):new ct(u.pa),g.Ha(u.J),g}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function el(){}s=el.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function Yr(){}Yr.prototype.g=function(u,g){return new Kt(u,g)};function Kt(u,g){ke.call(this),this.g=new ja(g),this.l=u,this.h=g&&g.messageUrlParams||null,u=g&&g.messageHeaders||null,g&&g.clientProtocolHeaderRequired&&(u?u["X-Client-Protocol"]="webchannel":u={"X-Client-Protocol":"webchannel"}),this.g.o=u,u=g&&g.initMessageHeaders||null,g&&g.messageContentType&&(u?u["X-WebChannel-Content-Type"]=g.messageContentType:u={"X-WebChannel-Content-Type":g.messageContentType}),g&&g.va&&(u?u["X-WebChannel-Client-Profile"]=g.va:u={"X-WebChannel-Client-Profile":g.va}),this.g.S=u,(u=g&&g.Sb)&&!I(u)&&(this.g.m=u),this.v=g&&g.supportsCrossDomainXhr||!1,this.u=g&&g.sendRawJson||!1,(g=g&&g.httpSessionIdParam)&&!I(g)&&(this.g.D=g,u=this.h,u!==null&&g in u&&(u=this.h,g in u&&delete u[g])),this.j=new _n(this)}m(Kt,ke),Kt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Kt.prototype.close=function(){eo(this.g)},Kt.prototype.o=function(u){var g=this.g;if(typeof u=="string"){var _={};_.__data__=u,u=_}else this.u&&(_={},_.__data__=xe(u),u=_);g.i.push(new Ii(g.Ya++,u)),g.G==3&&Zr(g)},Kt.prototype.N=function(){this.g.l=null,delete this.j,eo(this.g),delete this.g,Kt.aa.N.call(this)};function tl(u){Si.call(this),u.__headers__&&(this.headers=u.__headers__,this.statusCode=u.__status__,delete u.__headers__,delete u.__status__);var g=u.__sm__;if(g){e:{for(const _ in g){u=_;break e}u=void 0}(this.i=u)&&(u=this.i,g=g!==null&&u in g?g[u]:void 0),this.data=g}else this.data=u}m(tl,Si);function il(){Pi.call(this),this.status=1}m(il,Pi);function _n(u){this.g=u}m(_n,el),_n.prototype.ua=function(){ve(this.g,"a")},_n.prototype.ta=function(u){ve(this.g,new tl(u))},_n.prototype.sa=function(u){ve(this.g,new il)},_n.prototype.ra=function(){ve(this.g,"b")},Yr.prototype.createWebChannel=Yr.prototype.g,Kt.prototype.send=Kt.prototype.o,Kt.prototype.open=Kt.prototype.m,Kt.prototype.close=Kt.prototype.close,eh=function(){return new Yr},$c=function(){return Ki()},Jc=yi,Ao={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},ue.NO_ERROR=0,ue.TIMEOUT=8,ue.HTTP_ERROR=6,ls=ue,Y.COMPLETE="complete",Kc=Y,ti.EventType=ci,ci.OPEN="a",ci.CLOSE="b",ci.ERROR="c",ci.MESSAGE="d",ke.prototype.listen=ke.prototype.K,ar=ti,ct.prototype.listenOnce=ct.prototype.L,ct.prototype.getLastError=ct.prototype.Ka,ct.prototype.getLastErrorCode=ct.prototype.Ba,ct.prototype.getStatus=ct.prototype.Z,ct.prototype.getResponseJson=ct.prototype.Oa,ct.prototype.getResponseText=ct.prototype.oa,ct.prototype.send=ct.prototype.ea,ct.prototype.setWithCredentials=ct.prototype.Ha,Qc=ct}).apply(typeof ts<"u"?ts:typeof self<"u"?self:typeof window<"u"?window:{});const xl="@firebase/firestore",El="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jt{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}jt.UNAUTHENTICATED=new jt(null),jt.GOOGLE_CREDENTIALS=new jt("google-credentials-uid"),jt.FIRST_PARTY=new jt("first-party-uid"),jt.MOCK_USER=new jt("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Un="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ln=new jc("@firebase/firestore");function An(){return ln.logLevel}function fe(s,...t){if(ln.logLevel<=qe.DEBUG){const e=t.map(Ko);ln.debug(`Firestore (${Un}): ${s}`,...e)}}function xi(s,...t){if(ln.logLevel<=qe.ERROR){const e=t.map(Ko);ln.error(`Firestore (${Un}): ${s}`,...e)}}function zi(s,...t){if(ln.logLevel<=qe.WARN){const e=t.map(Ko);ln.warn(`Firestore (${Un}): ${s}`,...e)}}function Ko(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ie(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,th(s,i,e)}function th(s,t,e){let i=`FIRESTORE (${Un}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw xi(i),new Error(i)}function Ze(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||th(t,n,i)}function De(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Z={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class de extends zn{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sn{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ih{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class um{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(jt.UNAUTHENTICATED))}shutdown(){}}class dm{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class pm{constructor(t){this.t=t,this.currentUser=jt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){Ze(this.o===void 0,42304);let i=this.i;const n=c=>this.i!==i?(i=this.i,e(c)):Promise.resolve();let r=new sn;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new sn,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const c=r;t.enqueueRetryable(async()=>{await c.promise,await n(this.currentUser)})},a=c=>{fe("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(c=>a(c)),setTimeout(()=>{if(!this.auth){const c=this.t.getImmediate({optional:!0});c?a(c):(fe("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new sn)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(fe("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(Ze(typeof i.accessToken=="string",31837,{l:i}),new ih(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return Ze(t===null||typeof t=="string",2055,{h:t}),new jt(t)}}class fm{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=jt.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class mm{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new fm(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(jt.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Sl{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class gm{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,Qf(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){Ze(this.o===void 0,3512);const i=r=>{r.error!=null&&fe("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,fe("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{fe("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):fe("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new Sl(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(Ze(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new Sl(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vm(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function nh(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jo{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=vm(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function Fe(s,t){return s<t?-1:s>t?1:0}function Ro(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return Fe(i,n);{const r=nh(),o=ym(r.encode(Pl(s,e)),r.encode(Pl(t,e)));return o!==0?o:Fe(i,n)}}e+=i>65535?2:1}return Fe(s.length,t.length)}function Pl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function ym(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return Fe(s[e],t[e]);return Fe(s.length,t.length)}function Fn(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Cl="__name__";class ui{constructor(t,e,i){e===void 0?e=0:e>t.length&&Ie(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&Ie(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return ui.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof ui?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=ui.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return Fe(t.length,e.length)}static compareSegments(t,e){const i=ui.isNumericId(t),n=ui.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?ui.extractNumericId(t).compare(ui.extractNumericId(e)):Ro(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return Bi.fromString(t.substring(4,t.length-2))}}class tt extends ui{construct(t,e,i){return new tt(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new de(Z.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new tt(e)}static emptyPath(){return new tt([])}}const wm=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Lt extends ui{construct(t,e,i){return new Lt(t,e,i)}static isValidIdentifier(t){return wm.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Lt.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===Cl}static keyField(){return new Lt([Cl])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new de(Z.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new de(Z.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const c=t[n+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new de(Z.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=c,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new de(Z.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Lt(e)}static emptyPath(){return new Lt([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Se{constructor(t){this.path=t}static fromPath(t){return new Se(tt.fromString(t))}static fromName(t){return new Se(tt.fromString(t).popFirst(5))}static empty(){return new Se(tt.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&tt.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return tt.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new Se(new tt(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function rh(s,t,e){if(!e)throw new de(Z.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function _m(s,t,e,i){if(t===!0&&i===!0)throw new de(Z.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function Al(s){if(!Se.isDocumentKey(s))throw new de(Z.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function Rl(s){if(Se.isDocumentKey(s))throw new de(Z.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function sh(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function Ls(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":Ie(12329,{type:typeof s})}function Hi(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new de(Z.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=Ls(s);throw new de(Z.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Et(s,t){const e={typeString:s};return t&&(e.value=t),e}function Rr(s,t){if(!sh(s))throw new de(Z.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new de(Z.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Il=-62135596800,Ml=1e6;class it{static now(){return it.fromMillis(Date.now())}static fromDate(t){return it.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*Ml);return new it(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new de(Z.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new de(Z.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<Il)throw new de(Z.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new de(Z.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Ml}_compareTo(t){return this.seconds===t.seconds?Fe(this.nanoseconds,t.nanoseconds):Fe(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:it._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(Rr(t,it._jsonSchema))return new it(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-Il;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}it._jsonSchemaVersion="firestore/timestamp/1.0",it._jsonSchema={type:Et("string",it._jsonSchemaVersion),seconds:Et("number"),nanoseconds:Et("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Me{static fromTimestamp(t){return new Me(t)}static min(){return new Me(new it(0,0))}static max(){return new Me(new it(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _r=-1;function Tm(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=Me.fromTimestamp(i===1e9?new it(e+1,0):new it(e,i));return new Ui(n,Se.empty(),t)}function bm(s){return new Ui(s.readTime,s.key,_r)}class Ui{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new Ui(Me.min(),Se.empty(),_r)}static max(){return new Ui(Me.max(),Se.empty(),_r)}}function xm(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=Se.comparator(s.documentKey,t.documentKey),e!==0?e:Fe(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Em="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Sm{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function jn(s){if(s.code!==Z.FAILED_PRECONDITION||s.message!==Em)throw s;fe("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Q{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ie(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Q((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof Q?e:Q.resolve(e)}catch(e){return Q.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):Q.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):Q.reject(e)}static resolve(t){return new Q((e,i)=>{e(t)})}static reject(t){return new Q((e,i)=>{i(t)})}static waitFor(t){return new Q((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},c=>i(c))}),o=!0,r===n&&e()})}static or(t){let e=Q.resolve(!1);for(const i of t)e=e.next(n=>n?Q.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new Q((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let c=0;c<r;c++){const h=c;e(t[h]).next(d=>{o[h]=d,++a,a===r&&i(o)},d=>n(d))}})}static doWhile(t,e){return new Q((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function Pm(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function qn(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Vs{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}Vs.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $o=-1;function Bs(s){return s==null}function xs(s){return s===0&&1/s==-1/0}function Cm(s){return typeof s=="number"&&Number.isInteger(s)&&!xs(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oh="";function Am(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=Dl(t)),t=Rm(s.get(e),t);return Dl(t)}function Rm(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case oh:e+="";break;default:e+=r}}return e}function Dl(s){return s+oh+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kl(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function Yi(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function ah(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ot{constructor(t,e){this.comparator=t,this.root=e||Ft.EMPTY}insert(t,e){return new ot(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ft.BLACK,null,null))}remove(t){return new ot(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ft.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new is(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new is(this.root,t,this.comparator,!1)}getReverseIterator(){return new is(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new is(this.root,t,this.comparator,!0)}}class is{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Ft{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??Ft.RED,this.left=n??Ft.EMPTY,this.right=r??Ft.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new Ft(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return Ft.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return Ft.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Ft.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Ft.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ie(43730,{key:this.key,value:this.value});if(this.right.isRed())throw Ie(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw Ie(27949);return t+(this.isRed()?0:1)}}Ft.EMPTY=null,Ft.RED=!0,Ft.BLACK=!1;Ft.EMPTY=new class{constructor(){this.size=0}get key(){throw Ie(57766)}get value(){throw Ie(16141)}get color(){throw Ie(16727)}get left(){throw Ie(29726)}get right(){throw Ie(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new Ft(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rt{constructor(t){this.comparator=t,this.data=new ot(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Ol(this.data.getIterator())}getIteratorFrom(t){return new Ol(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof Rt)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new Rt(this.comparator);return e.data=t,e}}class Ol{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jt{constructor(t){this.fields=t,t.sort(Lt.comparator)}static empty(){return new Jt([])}unionWith(t){let e=new Rt(Lt.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new Jt(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Fn(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lh extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Vt{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new lh("Invalid base64 string: "+r):r}}(t);return new Vt(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new Vt(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Fe(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Vt.EMPTY_BYTE_STRING=new Vt("");const Im=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ji(s){if(Ze(!!s,39018),typeof s=="string"){let t=0;const e=Im.exec(s);if(Ze(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:mt(s.seconds),nanos:mt(s.nanos)}}function mt(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function qi(s){return typeof s=="string"?Vt.fromBase64String(s):Vt.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ch="server_timestamp",hh="__type__",uh="__previous_value__",dh="__local_write_time__";function ea(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[hh])===null||e===void 0?void 0:e.stringValue)===ch}function Hs(s){const t=s.mapValue.fields[uh];return ea(t)?Hs(t):t}function Tr(s){const t=ji(s.mapValue.fields[dh].timestampValue);return new it(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mm{constructor(t,e,i,n,r,o,a,c,h,d){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=c,this.useFetchStreams=h,this.isUsingEmulator=d}}const Es="(default)";class br{constructor(t,e){this.projectId=t,this.database=e||Es}static empty(){return new br("","")}get isDefaultDatabase(){return this.database===Es}isEqual(t){return t instanceof br&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ph="__type__",Dm="__max__",ns={mapValue:{}},fh="__vector__",Ss="value";function Wi(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?ea(s)?4:Om(s)?9007199254740991:km(s)?10:11:Ie(28295,{value:s})}function vi(s,t){if(s===t)return!0;const e=Wi(s);if(e!==Wi(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return Tr(s).isEqual(Tr(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=ji(n.timestampValue),a=ji(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return qi(n.bytesValue).isEqual(qi(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return mt(n.geoPointValue.latitude)===mt(r.geoPointValue.latitude)&&mt(n.geoPointValue.longitude)===mt(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return mt(n.integerValue)===mt(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=mt(n.doubleValue),a=mt(r.doubleValue);return o===a?xs(o)===xs(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return Fn(s.arrayValue.values||[],t.arrayValue.values||[],vi);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(kl(o)!==kl(a))return!1;for(const c in o)if(o.hasOwnProperty(c)&&(a[c]===void 0||!vi(o[c],a[c])))return!1;return!0}(s,t);default:return Ie(52216,{left:s})}}function xr(s,t){return(s.values||[]).find(e=>vi(e,t))!==void 0}function Ln(s,t){if(s===t)return 0;const e=Wi(s),i=Wi(t);if(e!==i)return Fe(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return Fe(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=mt(r.integerValue||r.doubleValue),c=mt(o.integerValue||o.doubleValue);return a<c?-1:a>c?1:a===c?0:isNaN(a)?isNaN(c)?0:-1:1}(s,t);case 3:return Fl(s.timestampValue,t.timestampValue);case 4:return Fl(Tr(s),Tr(t));case 5:return Ro(s.stringValue,t.stringValue);case 6:return function(r,o){const a=qi(r),c=qi(o);return a.compareTo(c)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),c=o.split("/");for(let h=0;h<a.length&&h<c.length;h++){const d=Fe(a[h],c[h]);if(d!==0)return d}return Fe(a.length,c.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=Fe(mt(r.latitude),mt(o.latitude));return a!==0?a:Fe(mt(r.longitude),mt(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return Ll(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,c,h,d;const l=r.fields||{},p=o.fields||{},f=(a=l[Ss])===null||a===void 0?void 0:a.arrayValue,m=(c=p[Ss])===null||c===void 0?void 0:c.arrayValue,v=Fe(((h=f==null?void 0:f.values)===null||h===void 0?void 0:h.length)||0,((d=m==null?void 0:m.values)===null||d===void 0?void 0:d.length)||0);return v!==0?v:Ll(f,m)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===ns.mapValue&&o===ns.mapValue)return 0;if(r===ns.mapValue)return 1;if(o===ns.mapValue)return-1;const a=r.fields||{},c=Object.keys(a),h=o.fields||{},d=Object.keys(h);c.sort(),d.sort();for(let l=0;l<c.length&&l<d.length;++l){const p=Ro(c[l],d[l]);if(p!==0)return p;const f=Ln(a[c[l]],h[d[l]]);if(f!==0)return f}return Fe(c.length,d.length)}(s.mapValue,t.mapValue);default:throw Ie(23264,{le:e})}}function Fl(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return Fe(s,t);const e=ji(s),i=ji(t),n=Fe(e.seconds,i.seconds);return n!==0?n:Fe(e.nanos,i.nanos)}function Ll(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=Ln(e[n],i[n]);if(r)return r}return Fe(e.length,i.length)}function Vn(s){return Io(s)}function Io(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=ji(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return qi(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return Se.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=Io(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${Io(e.fields[o])}`;return n+"}"}(s.mapValue):Ie(61005,{value:s})}function cs(s){switch(Wi(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=Hs(s);return t?16+cs(t):16;case 5:return 2*s.stringValue.length;case 6:return qi(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+cs(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return Yi(i.fields,(r,o)=>{n+=r.length+cs(o)}),n}(s.mapValue);default:throw Ie(13486,{value:s})}}function Vl(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function Mo(s){return!!s&&"integerValue"in s}function ta(s){return!!s&&"arrayValue"in s}function Bl(s){return!!s&&"nullValue"in s}function Hl(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function hs(s){return!!s&&"mapValue"in s}function km(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[ph])===null||e===void 0?void 0:e.stringValue)===fh}function pr(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return Yi(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=pr(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=pr(s.arrayValue.values[e]);return t}return Object.assign({},s)}function Om(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===Dm}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xt{constructor(t){this.value=t}static empty(){return new Xt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!hs(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=pr(e)}setAll(t){let e=Lt.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const c=this.getFieldsMap(e);this.applyChanges(c,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=pr(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());hs(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return vi(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];hs(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){Yi(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Xt(pr(this.value))}}function mh(s){const t=[];return Yi(s.fields,(e,i)=>{const n=new Lt([e]);if(hs(i)){const r=mh(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new Jt(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qt{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new qt(t,0,Me.min(),Me.min(),Me.min(),Xt.empty(),0)}static newFoundDocument(t,e,i,n){return new qt(t,1,e,Me.min(),i,n,0)}static newNoDocument(t,e){return new qt(t,2,e,Me.min(),Me.min(),Xt.empty(),0)}static newUnknownDocument(t,e){return new qt(t,3,e,Me.min(),Me.min(),Xt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(Me.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Xt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Xt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Me.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof qt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new qt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ps{constructor(t,e){this.position=t,this.inclusive=e}}function Nl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=Se.comparator(Se.fromName(o.referenceValue),e.key):i=Ln(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function zl(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!vi(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Er{constructor(t,e="asc"){this.field=t,this.dir=e}}function Fm(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gh{}class xt extends gh{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new Vm(t,e,i):e==="array-contains"?new Nm(t,i):e==="in"?new zm(t,i):e==="not-in"?new Um(t,i):e==="array-contains-any"?new jm(t,i):new xt(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new Bm(t,i):new Hm(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(Ln(e,this.value)):e!==null&&Wi(this.value)===Wi(e)&&this.matchesComparison(Ln(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return Ie(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class li extends gh{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new li(t,e)}matches(t){return vh(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function vh(s){return s.op==="and"}function yh(s){return Lm(s)&&vh(s)}function Lm(s){for(const t of s.filters)if(t instanceof li)return!1;return!0}function Do(s){if(s instanceof xt)return s.field.canonicalString()+s.op.toString()+Vn(s.value);if(yh(s))return s.filters.map(t=>Do(t)).join(",");{const t=s.filters.map(e=>Do(e)).join(",");return`${s.op}(${t})`}}function wh(s,t){return s instanceof xt?function(i,n){return n instanceof xt&&i.op===n.op&&i.field.isEqual(n.field)&&vi(i.value,n.value)}(s,t):s instanceof li?function(i,n){return n instanceof li&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&wh(o,n.filters[a]),!0):!1}(s,t):void Ie(19439)}function _h(s){return s instanceof xt?function(e){return`${e.field.canonicalString()} ${e.op} ${Vn(e.value)}`}(s):s instanceof li?function(e){return e.op.toString()+" {"+e.getFilters().map(_h).join(" ,")+"}"}(s):"Filter"}class Vm extends xt{constructor(t,e,i){super(t,e,i),this.key=Se.fromName(i.referenceValue)}matches(t){const e=Se.comparator(t.key,this.key);return this.matchesComparison(e)}}class Bm extends xt{constructor(t,e){super(t,"in",e),this.keys=Th("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class Hm extends xt{constructor(t,e){super(t,"not-in",e),this.keys=Th("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function Th(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>Se.fromName(i.referenceValue))}class Nm extends xt{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return ta(e)&&xr(e.arrayValue,this.value)}}class zm extends xt{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&xr(this.value.arrayValue,e)}}class Um extends xt{constructor(t,e){super(t,"not-in",e)}matches(t){if(xr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!xr(this.value.arrayValue,e)}}class jm extends xt{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!ta(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>xr(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qm{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function Ul(s,t=null,e=[],i=[],n=null,r=null,o=null){return new qm(s,t,e,i,n,r,o)}function ia(s){const t=De(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>Do(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),Bs(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>Vn(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>Vn(i)).join(",")),t.Pe=e}return t.Pe}function na(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!Fm(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!wh(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!zl(s.startAt,t.startAt)&&zl(s.endAt,t.endAt)}function ko(s){return Se.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wn{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=c,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function Wm(s,t,e,i,n,r,o,a){return new Wn(s,t,e,i,n,r,o,a)}function ra(s){return new Wn(s)}function jl(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function bh(s){return s.collectionGroup!==null}function fr(s){const t=De(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new Rt(Lt.comparator);return o.filters.forEach(c=>{c.getFlattenedFilters().forEach(h=>{h.isInequality()&&(a=a.add(h.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new Er(r,i))}),e.has(Lt.keyField().canonicalString())||t.Te.push(new Er(Lt.keyField(),i))}return t.Te}function di(s){const t=De(s);return t.Ie||(t.Ie=Gm(t,fr(s))),t.Ie}function Gm(s,t){if(s.limitType==="F")return Ul(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new Er(n.field,r)});const e=s.endAt?new Ps(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new Ps(s.startAt.position,s.startAt.inclusive):null;return Ul(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function Oo(s,t){const e=s.filters.concat([t]);return new Wn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function Fo(s,t,e){return new Wn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function Ns(s,t){return na(di(s),di(t))&&s.limitType===t.limitType}function xh(s){return`${ia(di(s))}|lt:${s.limitType}`}function Rn(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>_h(n)).join(", ")}]`),Bs(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>Vn(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>Vn(n)).join(",")),`Target(${i})`}(di(s))}; limitType=${s.limitType})`}function zs(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):Se.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of fr(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,c){const h=Nl(o,a,c);return o.inclusive?h<=0:h<0}(i.startAt,fr(i),n)||i.endAt&&!function(o,a,c){const h=Nl(o,a,c);return o.inclusive?h>=0:h>0}(i.endAt,fr(i),n))}(s,t)}function Zm(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function Eh(s){return(t,e)=>{let i=!1;for(const n of fr(s)){const r=Xm(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function Xm(s,t,e){const i=s.field.isKeyField()?Se.comparator(t.key,e.key):function(r,o,a){const c=o.data.field(r),h=a.data.field(r);return c!==null&&h!==null?Ln(c,h):Ie(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return Ie(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class un{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){Yi(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return ah(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ym=new ot(Se.comparator);function Ei(){return Ym}const Sh=new ot(Se.comparator);function lr(...s){let t=Sh;for(const e of s)t=t.insert(e.key,e);return t}function Ph(s){let t=Sh;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function rn(){return mr()}function Ch(){return mr()}function mr(){return new un(s=>s.toString(),(s,t)=>s.isEqual(t))}const Qm=new ot(Se.comparator),Km=new Rt(Se.comparator);function Ve(...s){let t=Km;for(const e of s)t=t.add(e);return t}const Jm=new Rt(Fe);function $m(){return Jm}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sa(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:xs(t)?"-0":t}}function Ah(s){return{integerValue:""+s}}function eg(s,t){return Cm(t)?Ah(t):sa(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Us{constructor(){this._=void 0}}function tg(s,t,e){return s instanceof Cs?function(n,r){const o={fields:{[hh]:{stringValue:ch},[dh]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&ea(r)&&(r=Hs(r)),r&&(o.fields[uh]=r),{mapValue:o}}(e,t):s instanceof Sr?Ih(s,t):s instanceof Pr?Mh(s,t):function(n,r){const o=Rh(n,r),a=ql(o)+ql(n.Ee);return Mo(o)&&Mo(n.Ee)?Ah(a):sa(n.serializer,a)}(s,t)}function ig(s,t,e){return s instanceof Sr?Ih(s,t):s instanceof Pr?Mh(s,t):e}function Rh(s,t){return s instanceof As?function(i){return Mo(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class Cs extends Us{}class Sr extends Us{constructor(t){super(),this.elements=t}}function Ih(s,t){const e=Dh(t);for(const i of s.elements)e.some(n=>vi(n,i))||e.push(i);return{arrayValue:{values:e}}}class Pr extends Us{constructor(t){super(),this.elements=t}}function Mh(s,t){let e=Dh(t);for(const i of s.elements)e=e.filter(n=>!vi(n,i));return{arrayValue:{values:e}}}class As extends Us{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function ql(s){return mt(s.integerValue||s.doubleValue)}function Dh(s){return ta(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function ng(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof Sr&&n instanceof Sr||i instanceof Pr&&n instanceof Pr?Fn(i.elements,n.elements,vi):i instanceof As&&n instanceof As?vi(i.Ee,n.Ee):i instanceof Cs&&n instanceof Cs}(s.transform,t.transform)}class rg{constructor(t,e){this.version=t,this.transformResults=e}}class oi{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new oi}static exists(t){return new oi(void 0,t)}static updateTime(t){return new oi(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function us(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class js{}function kh(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new oa(s.key,oi.none()):new Ir(s.key,s.data,oi.none());{const e=s.data,i=Xt.empty();let n=new Rt(Lt.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new Qi(s.key,i,new Jt(n.toArray()),oi.none())}}function sg(s,t,e){s instanceof Ir?function(n,r,o){const a=n.value.clone(),c=Gl(n.fieldTransforms,r,o.transformResults);a.setAll(c),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof Qi?function(n,r,o){if(!us(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=Gl(n.fieldTransforms,r,o.transformResults),c=r.data;c.setAll(Oh(n)),c.setAll(a),r.convertToFoundDocument(o.version,c).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function gr(s,t,e,i){return s instanceof Ir?function(r,o,a,c){if(!us(r.precondition,o))return a;const h=r.value.clone(),d=Zl(r.fieldTransforms,c,o);return h.setAll(d),o.convertToFoundDocument(o.version,h).setHasLocalMutations(),null}(s,t,e,i):s instanceof Qi?function(r,o,a,c){if(!us(r.precondition,o))return a;const h=Zl(r.fieldTransforms,c,o),d=o.data;return d.setAll(Oh(r)),d.setAll(h),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(l=>l.field))}(s,t,e,i):function(r,o,a){return us(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function og(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=Rh(i.transform,n||null);r!=null&&(e===null&&(e=Xt.empty()),e.set(i.field,r))}return e||null}function Wl(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&Fn(i,n,(r,o)=>ng(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class Ir extends js{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class Qi extends js{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Oh(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function Gl(s,t,e){const i=new Map;Ze(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,ig(o,a,e[n]))}return i}function Zl(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,tg(r,o,t))}return i}class oa extends js{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class ag extends js{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lg{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&sg(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=gr(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=gr(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=Ch();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const c=kh(o,a);c!==null&&i.set(n.key,c),o.isValidDocument()||o.convertToNoDocument(Me.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Ve())}isEqual(t){return this.batchId===t.batchId&&Fn(this.mutations,t.mutations,(e,i)=>Wl(e,i))&&Fn(this.baseMutations,t.baseMutations,(e,i)=>Wl(e,i))}}class aa{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){Ze(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return Qm}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new aa(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cg{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hg{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var _t,Ue;function ug(s){switch(s){case Z.OK:return Ie(64938);case Z.CANCELLED:case Z.UNKNOWN:case Z.DEADLINE_EXCEEDED:case Z.RESOURCE_EXHAUSTED:case Z.INTERNAL:case Z.UNAVAILABLE:case Z.UNAUTHENTICATED:return!1;case Z.INVALID_ARGUMENT:case Z.NOT_FOUND:case Z.ALREADY_EXISTS:case Z.PERMISSION_DENIED:case Z.FAILED_PRECONDITION:case Z.ABORTED:case Z.OUT_OF_RANGE:case Z.UNIMPLEMENTED:case Z.DATA_LOSS:return!0;default:return Ie(15467,{code:s})}}function Fh(s){if(s===void 0)return xi("GRPC error has no .code"),Z.UNKNOWN;switch(s){case _t.OK:return Z.OK;case _t.CANCELLED:return Z.CANCELLED;case _t.UNKNOWN:return Z.UNKNOWN;case _t.DEADLINE_EXCEEDED:return Z.DEADLINE_EXCEEDED;case _t.RESOURCE_EXHAUSTED:return Z.RESOURCE_EXHAUSTED;case _t.INTERNAL:return Z.INTERNAL;case _t.UNAVAILABLE:return Z.UNAVAILABLE;case _t.UNAUTHENTICATED:return Z.UNAUTHENTICATED;case _t.INVALID_ARGUMENT:return Z.INVALID_ARGUMENT;case _t.NOT_FOUND:return Z.NOT_FOUND;case _t.ALREADY_EXISTS:return Z.ALREADY_EXISTS;case _t.PERMISSION_DENIED:return Z.PERMISSION_DENIED;case _t.FAILED_PRECONDITION:return Z.FAILED_PRECONDITION;case _t.ABORTED:return Z.ABORTED;case _t.OUT_OF_RANGE:return Z.OUT_OF_RANGE;case _t.UNIMPLEMENTED:return Z.UNIMPLEMENTED;case _t.DATA_LOSS:return Z.DATA_LOSS;default:return Ie(39323,{code:s})}}(Ue=_t||(_t={}))[Ue.OK=0]="OK",Ue[Ue.CANCELLED=1]="CANCELLED",Ue[Ue.UNKNOWN=2]="UNKNOWN",Ue[Ue.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ue[Ue.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ue[Ue.NOT_FOUND=5]="NOT_FOUND",Ue[Ue.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ue[Ue.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ue[Ue.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ue[Ue.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ue[Ue.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ue[Ue.ABORTED=10]="ABORTED",Ue[Ue.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ue[Ue.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ue[Ue.INTERNAL=13]="INTERNAL",Ue[Ue.UNAVAILABLE=14]="UNAVAILABLE",Ue[Ue.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dg=new Bi([4294967295,4294967295],0);function Xl(s){const t=nh().encode(s),e=new Yc;return e.update(t),new Uint8Array(e.digest())}function Yl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new Bi([e,i],0),new Bi([n,r],0)]}class la{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new cr(`Invalid padding: ${e}`);if(i<0)throw new cr(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new cr(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new cr(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=Bi.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(Bi.fromNumber(i)));return n.compare(dg)===1&&(n=new Bi([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=Xl(t),[i,n]=Yl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new la(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=Xl(t),[i,n]=Yl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class cr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qs{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,Mr.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new qs(Me.min(),n,new ot(Fe),Ei(),Ve())}}class Mr{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new Mr(i,e,Ve(),Ve(),Ve())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ds{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class Lh{constructor(t,e){this.targetId=t,this.De=e}}class Vh{constructor(t,e,i=Vt.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class Ql{constructor(){this.ve=0,this.Ce=Kl(),this.Fe=Vt.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Ve(),e=Ve(),i=Ve();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:Ie(38017,{changeType:r})}}),new Mr(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Kl()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,Ze(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class pg{constructor(t){this.We=t,this.Ge=new Map,this.ze=Ei(),this.je=rs(),this.Je=rs(),this.He=new ot(Fe)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:Ie(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(ko(r))if(i===0){const o=new Se(r.path);this.Xe(e,o,qt.newNoDocument(o,Me.min()))}else Ze(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),c=a?this.ut(a,t,o):1;if(c!==0){this.rt(e);const h=c===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,h)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=qi(i).toUint8Array()}catch(c){if(c instanceof lh)return zi("Decoding the base64 bloom filter in existence filter failed ("+c.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw c}try{a=new la(o,n,r)}catch(c){return zi(c instanceof cr?"BloomFilter error: ":"Applying bloom filter failed: ",c),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&ko(a.target)){const c=new Se(a.target.path);this.Tt(c).has(o)||this.It(o,c)||this.Xe(o,c,qt.newNoDocument(c,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Ve();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(c=>{const h=this.st(c);return!h||h.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new qs(t,e,this.He,this.ze,i);return this.ze=Ei(),this.je=rs(),this.Je=rs(),this.He=new ot(Fe),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new Ql,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new Rt(Fe),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new Rt(Fe),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||fe("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new Ql),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function rs(){return new ot(Se.comparator)}function Kl(){return new ot(Se.comparator)}const fg={asc:"ASCENDING",desc:"DESCENDING"},mg={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},gg={and:"AND",or:"OR"};class vg{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Lo(s,t){return s.useProto3Json||Bs(t)?t:{value:t}}function Rs(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Bh(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function yg(s,t){return Rs(s,t.toTimestamp())}function pi(s){return Ze(!!s,49232),Me.fromTimestamp(function(e){const i=ji(e);return new it(i.seconds,i.nanos)}(s))}function ca(s,t){return Vo(s,t).canonicalString()}function Vo(s,t){const e=function(n){return new tt(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function Hh(s){const t=tt.fromString(s);return Ze(qh(t),10190,{key:t.toString()}),t}function Bo(s,t){return ca(s.databaseId,t.path)}function mo(s,t){const e=Hh(t);if(e.get(1)!==s.databaseId.projectId)throw new de(Z.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new de(Z.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new Se(zh(e))}function Nh(s,t){return ca(s.databaseId,t)}function wg(s){const t=Hh(s);return t.length===4?tt.emptyPath():zh(t)}function Ho(s){return new tt(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function zh(s){return Ze(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Jl(s,t,e){return{name:Bo(s,t),fields:e.value.mapValue.fields}}function _g(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(h){return h==="NO_CHANGE"?0:h==="ADD"?1:h==="REMOVE"?2:h==="CURRENT"?3:h==="RESET"?4:Ie(39313,{state:h})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(h,d){return h.useProto3Json?(Ze(d===void 0||typeof d=="string",58123),Vt.fromBase64String(d||"")):(Ze(d===void 0||d instanceof Buffer||d instanceof Uint8Array,16193),Vt.fromUint8Array(d||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(h){const d=h.code===void 0?Z.UNKNOWN:Fh(h.code);return new de(d,h.message||"")}(o);e=new Vh(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=mo(s,i.document.name),r=pi(i.document.updateTime),o=i.document.createTime?pi(i.document.createTime):Me.min(),a=new Xt({mapValue:{fields:i.document.fields}}),c=qt.newFoundDocument(n,r,o,a),h=i.targetIds||[],d=i.removedTargetIds||[];e=new ds(h,d,c.key,c)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=mo(s,i.document),r=i.readTime?pi(i.readTime):Me.min(),o=qt.newNoDocument(n,r),a=i.removedTargetIds||[];e=new ds([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=mo(s,i.document),r=i.removedTargetIds||[];e=new ds([],r,n,null)}else{if(!("filter"in t))return Ie(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new hg(n,r),a=i.targetId;e=new Lh(a,o)}}return e}function Tg(s,t){let e;if(t instanceof Ir)e={update:Jl(s,t.key,t.value)};else if(t instanceof oa)e={delete:Bo(s,t.key)};else if(t instanceof Qi)e={update:Jl(s,t.key,t.data),updateMask:Ig(t.fieldMask)};else{if(!(t instanceof ag))return Ie(16599,{Rt:t.type});e={verify:Bo(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof Cs)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof Sr)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Pr)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof As)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw Ie(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:yg(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:Ie(27497)}(s,t.precondition)),e}function bg(s,t){return s&&s.length>0?(Ze(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?pi(n.updateTime):pi(r);return o.isEqual(Me.min())&&(o=pi(r)),new rg(o,n.transformResults||[])}(e,t))):[]}function xg(s,t){return{documents:[Nh(s,t.path)]}}function Eg(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=Nh(s,n);const r=function(h){if(h.length!==0)return jh(li.create(h,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(h){if(h.length!==0)return h.map(d=>function(p){return{field:In(p.field),direction:Cg(p.dir)}}(d))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=Lo(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(h){return{before:h.inclusive,values:h.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(h){return{before:!h.inclusive,values:h.position}}(t.endAt)),{Vt:e,parent:n}}function Sg(s){let t=wg(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){Ze(i===1,65062);const d=e.from[0];d.allDescendants?n=d.collectionId:t=t.child(d.collectionId)}let r=[];e.where&&(r=function(l){const p=Uh(l);return p instanceof li&&yh(p)?p.getFilters():[p]}(e.where));let o=[];e.orderBy&&(o=function(l){return l.map(p=>function(m){return new Er(Mn(m.field),function(w){switch(w){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(m.direction))}(p))}(e.orderBy));let a=null;e.limit&&(a=function(l){let p;return p=typeof l=="object"?l.value:l,Bs(p)?null:p}(e.limit));let c=null;e.startAt&&(c=function(l){const p=!!l.before,f=l.values||[];return new Ps(f,p)}(e.startAt));let h=null;return e.endAt&&(h=function(l){const p=!l.before,f=l.values||[];return new Ps(f,p)}(e.endAt)),Wm(t,n,o,r,a,"F",c,h)}function Pg(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Ie(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Uh(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=Mn(e.unaryFilter.field);return xt.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=Mn(e.unaryFilter.field);return xt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Mn(e.unaryFilter.field);return xt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Mn(e.unaryFilter.field);return xt.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return Ie(61313);default:return Ie(60726)}}(s):s.fieldFilter!==void 0?function(e){return xt.create(Mn(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return Ie(58110);default:return Ie(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return li.create(e.compositeFilter.filters.map(i=>Uh(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return Ie(1026)}}(e.compositeFilter.op))}(s):Ie(30097,{filter:s})}function Cg(s){return fg[s]}function Ag(s){return mg[s]}function Rg(s){return gg[s]}function In(s){return{fieldPath:s.canonicalString()}}function Mn(s){return Lt.fromServerFormat(s.fieldPath)}function jh(s){return s instanceof xt?function(e){if(e.op==="=="){if(Hl(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NAN"}};if(Bl(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Hl(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NOT_NAN"}};if(Bl(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:In(e.field),op:Ag(e.op),value:e.value}}}(s):s instanceof li?function(e){const i=e.getFilters().map(n=>jh(n));return i.length===1?i[0]:{compositeFilter:{op:Rg(e.op),filters:i}}}(s):Ie(54877,{filter:s})}function Ig(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function qh(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fi{constructor(t,e,i,n,r=Me.min(),o=Me.min(),a=Vt.EMPTY_BYTE_STRING,c=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=c}withSequenceNumber(t){return new Fi(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new Fi(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new Fi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new Fi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mg{constructor(t){this.gt=t}}function Dg(s){const t=Sg({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?Fo(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kg{constructor(){this.Dn=new Og}addToCollectionParentIndex(t,e){return this.Dn.add(e),Q.resolve()}getCollectionParents(t,e){return Q.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return Q.resolve()}deleteFieldIndex(t,e){return Q.resolve()}deleteAllFieldIndexes(t){return Q.resolve()}createTargetIndexes(t,e){return Q.resolve()}getDocumentsMatchingTarget(t,e){return Q.resolve(null)}getIndexType(t,e){return Q.resolve(0)}getFieldIndexes(t,e){return Q.resolve([])}getNextCollectionGroupToUpdate(t){return Q.resolve(null)}getMinOffset(t,e){return Q.resolve(Ui.min())}getMinOffsetFromCollectionGroup(t,e){return Q.resolve(Ui.min())}updateCollectionGroup(t,e,i){return Q.resolve()}updateIndexEntries(t,e){return Q.resolve()}}class Og{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new Rt(tt.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new Rt(tt.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $l={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Wh=41943040;class Gt{static withCacheSize(t){return new Gt(t,Gt.DEFAULT_COLLECTION_PERCENTILE,Gt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Gt.DEFAULT_COLLECTION_PERCENTILE=10,Gt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Gt.DEFAULT=new Gt(Wh,Gt.DEFAULT_COLLECTION_PERCENTILE,Gt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Gt.DISABLED=new Gt(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bn{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new Bn(0)}static ur(){return new Bn(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ec="LruGarbageCollector",Fg=1048576;function tc([s,t],[e,i]){const n=Fe(s,e);return n===0?Fe(t,i):n}class Lg{constructor(t){this.Tr=t,this.buffer=new Rt(tc),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();tc(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Vg{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){fe(ec,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){qn(e)?fe(ec,"Ignoring IndexedDB error during garbage collection: ",e):await jn(e)}await this.Rr(3e5)})}}class Bg{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return Q.resolve(Vs.ue);const i=new Lg(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(fe("LruGarbageCollector","Garbage collection skipped; disabled"),Q.resolve($l)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(fe("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),$l):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,c,h;const d=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(l=>(l>this.params.maximumSequenceNumbersToCollect?(fe("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${l}`),n=this.params.maximumSequenceNumbersToCollect):n=l,o=Date.now(),this.nthSequenceNumber(t,n))).next(l=>(i=l,a=Date.now(),this.removeTargets(t,i,e))).next(l=>(r=l,c=Date.now(),this.removeOrphanedDocuments(t,i))).next(l=>(h=Date.now(),An()<=qe.DEBUG&&fe("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(c-a)+`ms
	Removed ${l} documents in `+(h-c)+`ms
Total Duration: ${h-d}ms`),Q.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:l})))}}function Hg(s,t){return new Bg(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ng{constructor(){this.changes=new un(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,qt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?Q.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zg{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ug{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&gr(i.mutation,n,Jt.empty(),it.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Ve()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Ve()){const n=rn();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=lr();return r.forEach((a,c)=>{o=o.insert(a,c.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=rn();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Ve()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=Ei();const o=mr(),a=function(){return mr()}();return e.forEach((c,h)=>{const d=i.get(h.key);n.has(h.key)&&(d===void 0||d.mutation instanceof Qi)?r=r.insert(h.key,h):d!==void 0?(o.set(h.key,d.mutation.getFieldMask()),gr(d.mutation,h,d.mutation.getFieldMask(),it.now())):o.set(h.key,Jt.empty())}),this.recalculateAndSaveOverlays(t,r).next(c=>(c.forEach((h,d)=>o.set(h,d)),e.forEach((h,d)=>{var l;return a.set(h,new zg(d,(l=o.get(h))!==null&&l!==void 0?l:null))}),a))}recalculateAndSaveOverlays(t,e){const i=mr();let n=new ot((o,a)=>o-a),r=Ve();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(c=>{const h=e.get(c);if(h===null)return;let d=i.get(c)||Jt.empty();d=a.applyToLocalView(h,d),i.set(c,d);const l=(n.get(a.batchId)||Ve()).add(c);n=n.insert(a.batchId,l)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const c=a.getNext(),h=c.key,d=c.value,l=Ch();d.forEach(p=>{if(!r.has(p)){const f=kh(e.get(p),i.get(p));f!==null&&l.set(p,f),r=r.add(p)}}),o.push(this.documentOverlayCache.saveOverlays(t,h,l))}return Q.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return Se.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):bh(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):Q.resolve(rn());let a=_r,c=r;return o.next(h=>Q.forEach(h,(d,l)=>(a<l.largestBatchId&&(a=l.largestBatchId),r.get(d)?Q.resolve():this.remoteDocumentCache.getEntry(t,d).next(p=>{c=c.insert(d,p)}))).next(()=>this.populateOverlays(t,h,r)).next(()=>this.computeViews(t,c,h,Ve())).next(d=>({batchId:a,changes:Ph(d)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new Se(e)).next(i=>{let n=lr();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=lr();return this.indexManager.getCollectionParents(t,r).next(a=>Q.forEach(a,c=>{const h=function(l,p){return new Wn(p,null,l.explicitOrderBy.slice(),l.filters.slice(),l.limit,l.limitType,l.startAt,l.endAt)}(e,c.child(r));return this.getDocumentsMatchingCollectionQuery(t,h,i,n).next(d=>{d.forEach((l,p)=>{o=o.insert(l,p)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((c,h)=>{const d=h.getKey();o.get(d)===null&&(o=o.insert(d,qt.newInvalidDocument(d)))});let a=lr();return o.forEach((c,h)=>{const d=r.get(c);d!==void 0&&gr(d.mutation,h,Jt.empty(),it.now()),zs(e,h)&&(a=a.insert(c,h))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jg{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return Q.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:pi(n.createTime)}}(e)),Q.resolve()}getNamedQuery(t,e){return Q.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:Dg(n.bundledQuery),readTime:pi(n.readTime)}}(e)),Q.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qg{constructor(){this.overlays=new ot(Se.comparator),this.kr=new Map}getOverlay(t,e){return Q.resolve(this.overlays.get(e))}getOverlays(t,e){const i=rn();return Q.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),Q.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),Q.resolve()}getOverlaysForCollection(t,e,i){const n=rn(),r=e.length+1,o=new Se(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const c=a.getNext().value,h=c.getKey();if(!e.isPrefixOf(h.path))break;h.path.length===r&&c.largestBatchId>i&&n.set(c.getKey(),c)}return Q.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new ot((h,d)=>h-d);const o=this.overlays.getIterator();for(;o.hasNext();){const h=o.getNext().value;if(h.getKey().getCollectionGroup()===e&&h.largestBatchId>i){let d=r.get(h.largestBatchId);d===null&&(d=rn(),r=r.insert(h.largestBatchId,d)),d.set(h.getKey(),h)}}const a=rn(),c=r.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((h,d)=>a.set(h,d)),!(a.size()>=n)););return Q.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new cg(e,i));let r=this.kr.get(e);r===void 0&&(r=Ve(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wg{constructor(){this.sessionToken=Vt.EMPTY_BYTE_STRING}getSessionToken(t){return Q.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,Q.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ha{constructor(){this.qr=new Rt(Mt.Qr),this.$r=new Rt(Mt.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new Mt(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new Mt(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new Se(new tt([])),i=new Mt(e,t),n=new Mt(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new Se(new tt([])),i=new Mt(e,t),n=new Mt(e,t+1);let r=Ve();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new Mt(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class Mt{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return Se.comparator(t.key,e.key)||Fe(t.Hr,e.Hr)}static Ur(t,e){return Fe(t.Hr,e.Hr)||Se.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gg{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new Rt(Mt.Qr)}checkEmpty(t){return Q.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new lg(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new Mt(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return Q.resolve(o)}lookupMutationBatch(t,e){return Q.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return Q.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return Q.resolve(this.mutationQueue.length===0?$o:this.er-1)}getAllMutationBatches(t){return Q.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new Mt(e,0),n=new Mt(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),Q.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new Rt(Fe);return e.forEach(n=>{const r=new Mt(n,0),o=new Mt(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),Q.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;Se.isDocumentKey(r)||(r=r.child(""));const o=new Mt(new Se(r),0);let a=new Rt(Fe);return this.Yr.forEachWhile(c=>{const h=c.key.path;return!!i.isPrefixOf(h)&&(h.length===n&&(a=a.add(c.Hr)),!0)},o),Q.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){Ze(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return Q.forEach(e.mutations,n=>{const r=new Mt(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new Mt(e,0),n=this.Yr.firstAfterOrEqual(i);return Q.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,Q.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zg{constructor(t){this.ni=t,this.docs=function(){return new ot(Se.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return Q.resolve(i?i.document.mutableCopy():qt.newInvalidDocument(e))}getEntries(t,e){let i=Ei();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():qt.newInvalidDocument(n))}),Q.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=Ei();const o=e.path,a=new Se(o.child("__id-9223372036854775808__")),c=this.docs.getIteratorFrom(a);for(;c.hasNext();){const{key:h,value:{document:d}}=c.getNext();if(!o.isPrefixOf(h.path))break;h.path.length>o.length+1||xm(bm(d),i)<=0||(n.has(d.key)||zs(e,d))&&(r=r.insert(d.key,d.mutableCopy()))}return Q.resolve(r)}getAllFromCollectionGroup(t,e,i,n){Ie(9500)}ri(t,e){return Q.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new Xg(this)}getSize(t){return Q.resolve(this.size)}}class Xg extends Ng{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),Q.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yg{constructor(t){this.persistence=t,this.ii=new un(e=>ia(e),na),this.lastRemoteSnapshotVersion=Me.min(),this.highestTargetId=0,this.si=0,this.oi=new ha,this.targetCount=0,this._i=Bn.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),Q.resolve()}getLastRemoteSnapshotVersion(t){return Q.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Q.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),Q.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),Q.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new Bn(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,Q.resolve()}updateTargetData(t,e){return this.hr(e),Q.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,Q.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),Q.waitFor(r).next(()=>n)}getTargetCount(t){return Q.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return Q.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),Q.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),Q.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),Q.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return Q.resolve(i)}containsKey(t,e){return Q.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gh{constructor(t,e){this.ai={},this.overlays={},this.ui=new Vs(0),this.ci=!1,this.ci=!0,this.li=new Wg,this.referenceDelegate=t(this),this.hi=new Yg(this),this.indexManager=new kg,this.remoteDocumentCache=function(n){return new Zg(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new Mg(e),this.Ti=new jg(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new qg,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new Gg(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){fe("MemoryPersistence","Starting transaction:",t);const n=new Qg(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return Q.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class Qg extends Sm{constructor(t){super(),this.currentSequenceNumber=t}}class ua{constructor(t){this.persistence=t,this.Ai=new ha,this.Ri=null}static Vi(t){return new ua(t)}get mi(){if(this.Ri)return this.Ri;throw Ie(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),Q.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),Q.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),Q.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Q.forEach(this.mi,i=>{const n=Se.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,Me.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return Q.or([()=>Q.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class Is{constructor(t,e){this.persistence=t,this.gi=new un(i=>Am(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=Hg(this,e)}static Vi(t,e){return new Is(t,e)}Ii(){}di(t){return Q.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return Q.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?Q.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,Me.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),Q.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),Q.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),Q.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),Q.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=cs(t.data.value)),e}Sr(t,e,i){return Q.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return Q.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class da{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Ve(),n=Ve();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new da(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kg{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jg{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return Gp()?8:Pm(qp())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new Kg;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(An()<=qe.DEBUG&&fe("QueryEngine","SDK will not create cache indexes for query:",Rn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),Q.resolve()):(An()<=qe.DEBUG&&fe("QueryEngine","Query:",Rn(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(An()<=qe.DEBUG&&fe("QueryEngine","The SDK decides to create cache indexes for query:",Rn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,di(e))):Q.resolve())}ps(t,e){if(jl(e))return Q.resolve(null);let i=di(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=Fo(e,null,"F"),i=di(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Ve(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(c=>{const h=this.bs(e,a);return this.Ds(e,h,o,c.readTime)?this.ps(t,Fo(e,null,"F")):this.vs(t,h,e,c)}))})))}ys(t,e,i,n){return jl(e)||n.isEqual(Me.min())?Q.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?Q.resolve(null):(An()<=qe.DEBUG&&fe("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Rn(e)),this.vs(t,o,e,Tm(n,_r)).next(a=>a))})}bs(t,e){let i=new Rt(Eh(t));return e.forEach((n,r)=>{zs(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return An()<=qe.DEBUG&&fe("QueryEngine","Using full collection scan to execute query:",Rn(e)),this.gs.getDocumentsMatchingQuery(t,e,Ui.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pa="LocalStore",$g=3e8;class ev{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new ot(Fe),this.Ms=new un(r=>ia(r),na),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Ug(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function tv(s,t,e,i){return new ev(s,t,e,i)}async function Zh(s,t){const e=De(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let c=Ve();for(const h of n){o.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}for(const h of r){a.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}return e.localDocuments.getDocuments(i,c).next(h=>({Bs:h,removedBatchIds:o,addedBatchIds:a}))})})}function iv(s,t){const e=De(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,c,h,d){const l=h.batch,p=l.keys();let f=Q.resolve();return p.forEach(m=>{f=f.next(()=>d.getEntry(c,m)).next(v=>{const w=h.docVersions.get(m);Ze(w!==null,48541),v.version.compareTo(w)<0&&(l.applyToRemoteDocument(v,h),v.isValidDocument()&&(v.setReadTime(h.commitVersion),d.addEntry(v)))})}),f.next(()=>a.mutationQueue.removeMutationBatch(c,l))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let c=Ve();for(let h=0;h<a.mutationResults.length;++h)a.mutationResults[h].transformResults.length>0&&(c=c.add(a.batch.mutations[h].key));return c}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function Xh(s){const t=De(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function nv(s,t){const e=De(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((d,l)=>{const p=n.get(l);if(!p)return;a.push(e.hi.removeMatchingKeys(r,d.removedDocuments,l).next(()=>e.hi.addMatchingKeys(r,d.addedDocuments,l)));let f=p.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(l)!==null?f=f.withResumeToken(Vt.EMPTY_BYTE_STRING,Me.min()).withLastLimboFreeSnapshotVersion(Me.min()):d.resumeToken.approximateByteSize()>0&&(f=f.withResumeToken(d.resumeToken,i)),n=n.insert(l,f),function(v,w,b){return v.resumeToken.approximateByteSize()===0||w.snapshotVersion.toMicroseconds()-v.snapshotVersion.toMicroseconds()>=$g?!0:b.addedDocuments.size+b.modifiedDocuments.size+b.removedDocuments.size>0}(p,f,d)&&a.push(e.hi.updateTargetData(r,f))});let c=Ei(),h=Ve();if(t.documentUpdates.forEach(d=>{t.resolvedLimboDocuments.has(d)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,d))}),a.push(rv(r,o,t.documentUpdates).next(d=>{c=d.Ls,h=d.ks})),!i.isEqual(Me.min())){const d=e.hi.getLastRemoteSnapshotVersion(r).next(l=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(d)}return Q.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,c,h)).next(()=>c)}).then(r=>(e.Fs=n,r))}function rv(s,t,e){let i=Ve(),n=Ve();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=Ei();return e.forEach((a,c)=>{const h=r.get(a);c.isFoundDocument()!==h.isFoundDocument()&&(n=n.add(a)),c.isNoDocument()&&c.version.isEqual(Me.min())?(t.removeEntry(a,c.readTime),o=o.insert(a,c)):!h.isValidDocument()||c.version.compareTo(h.version)>0||c.version.compareTo(h.version)===0&&h.hasPendingWrites?(t.addEntry(c),o=o.insert(a,c)):fe(pa,"Ignoring outdated watch update for ",a,". Current version:",h.version," Watch version:",c.version)}),{Ls:o,ks:n}})}function sv(s,t){const e=De(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=$o),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function ov(s,t){const e=De(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,Q.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new Fi(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function No(s,t,e){const i=De(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!qn(o))throw o;fe(pa,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function ic(s,t,e){const i=De(s);let n=Me.min(),r=Ve();return i.persistence.runTransaction("Execute query","readwrite",o=>function(c,h,d){const l=De(c),p=l.Ms.get(d);return p!==void 0?Q.resolve(l.Fs.get(p)):l.hi.getTargetData(h,d)}(i,o,di(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(c=>{r=c})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:Me.min(),e?r:Ve())).next(a=>(av(i,Zm(t),a),{documents:a,qs:r})))}function av(s,t,e){let i=s.xs.get(t)||Me.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class nc{constructor(){this.activeTargetIds=$m()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class lv{constructor(){this.Fo=new nc,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new nc,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cv{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const rc="ConnectivityMonitor";class sc{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){fe(rc,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){fe(rc,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ss=null;function zo(){return ss===null?ss=function(){return 268435456+Math.round(2147483648*Math.random())}():ss++,"0x"+ss.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const go="RestConnection",hv={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class uv{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===Es?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=zo(),a=this.Go(t,e.toUriEncodedString());fe(go,`Sending RPC '${t}' ${o}:`,a,i);const c={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(c,n,r);const{host:h}=new URL(a),d=Yo(h);return this.jo(t,a,c,i,d).then(l=>(fe(go,`Received RPC '${t}' ${o}: `,l),l),l=>{throw zi(go,`RPC '${t}' ${o} failed with error: `,l,"url: ",a,"request:",i),l})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Un}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=hv[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dv{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ut="WebChannelConnection";class pv extends uv{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=zo();return new Promise((a,c)=>{const h=new Qc;h.setWithCredentials(!0),h.listenOnce(Kc.COMPLETE,()=>{try{switch(h.getLastErrorCode()){case ls.NO_ERROR:const l=h.getResponseJson();fe(Ut,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(l)),a(l);break;case ls.TIMEOUT:fe(Ut,`RPC '${t}' ${o} timed out`),c(new de(Z.DEADLINE_EXCEEDED,"Request time out"));break;case ls.HTTP_ERROR:const p=h.getStatus();if(fe(Ut,`RPC '${t}' ${o} failed with status:`,p,"response text:",h.getResponseText()),p>0){let f=h.getResponseJson();Array.isArray(f)&&(f=f[0]);const m=f==null?void 0:f.error;if(m&&m.status&&m.message){const v=function(b){const I=b.toLowerCase().replace(/_/g,"-");return Object.values(Z).indexOf(I)>=0?I:Z.UNKNOWN}(m.status);c(new de(v,m.message))}else c(new de(Z.UNKNOWN,"Server responded with status "+h.getStatus()))}else c(new de(Z.UNAVAILABLE,"Connection failed."));break;default:Ie(9055,{c_:t,streamId:o,l_:h.getLastErrorCode(),h_:h.getLastError()})}}finally{fe(Ut,`RPC '${t}' ${o} completed.`)}});const d=JSON.stringify(n);fe(Ut,`RPC '${t}' ${o} sending request:`,n),h.send(e,"POST",d,i,15)})}P_(t,e,i){const n=zo(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=eh(),a=$c(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},h=this.longPollingOptions.timeoutSeconds;h!==void 0&&(c.longPollingTimeout=Math.round(1e3*h)),this.useFetchStreams&&(c.useFetchStreams=!0),this.zo(c.initMessageHeaders,e,i),c.encodeInitMessageHeaders=!0;const d=r.join("");fe(Ut,`Creating RPC '${t}' stream ${n}: ${d}`,c);const l=o.createWebChannel(d,c);this.T_(l);let p=!1,f=!1;const m=new dv({Ho:w=>{f?fe(Ut,`Not sending because RPC '${t}' stream ${n} is closed:`,w):(p||(fe(Ut,`Opening RPC '${t}' stream ${n} transport.`),l.open(),p=!0),fe(Ut,`RPC '${t}' stream ${n} sending:`,w),l.send(w))},Yo:()=>l.close()}),v=(w,b,I)=>{w.listen(b,O=>{try{I(O)}catch(N){setTimeout(()=>{throw N},0)}})};return v(l,ar.EventType.OPEN,()=>{f||(fe(Ut,`RPC '${t}' stream ${n} transport opened.`),m.s_())}),v(l,ar.EventType.CLOSE,()=>{f||(f=!0,fe(Ut,`RPC '${t}' stream ${n} transport closed`),m.__(),this.I_(l))}),v(l,ar.EventType.ERROR,w=>{f||(f=!0,zi(Ut,`RPC '${t}' stream ${n} transport errored. Name:`,w.name,"Message:",w.message),m.__(new de(Z.UNAVAILABLE,"The operation could not be completed")))}),v(l,ar.EventType.MESSAGE,w=>{var b;if(!f){const I=w.data[0];Ze(!!I,16349);const O=I,N=(O==null?void 0:O.error)||((b=O[0])===null||b===void 0?void 0:b.error);if(N){fe(Ut,`RPC '${t}' stream ${n} received error:`,N);const q=N.status;let ie=function(E){const D=_t[E];if(D!==void 0)return Fh(D)}(q),k=N.message;ie===void 0&&(ie=Z.INTERNAL,k="Unknown error status: "+q+" with message "+N.message),f=!0,m.__(new de(ie,k)),l.close()}else fe(Ut,`RPC '${t}' stream ${n} received:`,I),m.a_(I)}}),v(a,Jc.STAT_EVENT,w=>{w.stat===Ao.PROXY?fe(Ut,`RPC '${t}' stream ${n} detected buffering proxy`):w.stat===Ao.NOPROXY&&fe(Ut,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{m.o_()},0),m}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function vo(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ws(s){return new vg(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yh{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&fe("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oc="PersistentStream";class Qh{constructor(t,e,i,n,r,o,a,c){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=c,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new Yh(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===Z.RESOURCE_EXHAUSTED?(xi(e.toString()),xi("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===Z.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new de(Z.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return fe(oc,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(fe(oc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class fv extends Qh{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=_g(this.serializer,t),i=function(r){if(!("targetChange"in r))return Me.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?Me.min():o.readTime?pi(o.readTime):Me.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=Ho(this.serializer),e.addTarget=function(r,o){let a;const c=o.target;if(a=ko(c)?{documents:xg(r,c)}:{query:Eg(r,c).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Bh(r,o.resumeToken);const h=Lo(r,o.expectedCount);h!==null&&(a.expectedCount=h)}else if(o.snapshotVersion.compareTo(Me.min())>0){a.readTime=Rs(r,o.snapshotVersion.toTimestamp());const h=Lo(r,o.expectedCount);h!==null&&(a.expectedCount=h)}return a}(this.serializer,t);const i=Pg(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=Ho(this.serializer),e.removeTarget=t,this.k_(e)}}class mv extends Qh{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return Ze(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,Ze(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){Ze(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=bg(t.writeResults,t.commitTime),i=pi(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=Ho(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>Tg(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gv{}class vv extends gv{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new de(Z.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,Vo(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===Z.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new de(Z.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,Vo(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===Z.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new de(Z.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class yv{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?(xi(e),this._a=!1):fe("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cn="RemoteStore";class wv{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{dn(this)&&(fe(cn,"Restarting streams for network reachability change."),await async function(c){const h=De(c);h.Ia.add(4),await Dr(h),h.Aa.set("Unknown"),h.Ia.delete(4),await Gs(h)}(this))})}),this.Aa=new yv(i,n)}}async function Gs(s){if(dn(s))for(const t of s.da)await t(!0)}async function Dr(s){for(const t of s.da)await t(!1)}function Kh(s,t){const e=De(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),va(e)?ga(e):Gn(e).x_()&&ma(e,t))}function fa(s,t){const e=De(s),i=Gn(e);e.Ta.delete(t),i.x_()&&Jh(e,t),e.Ta.size===0&&(i.x_()?i.B_():dn(e)&&e.Aa.set("Unknown"))}function ma(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Me.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}Gn(s).H_(t)}function Jh(s,t){s.Ra.$e(t),Gn(s).Y_(t)}function ga(s){s.Ra=new pg({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),Gn(s).start(),s.Aa.aa()}function va(s){return dn(s)&&!Gn(s).M_()&&s.Ta.size>0}function dn(s){return De(s).Ia.size===0}function $h(s){s.Ra=void 0}async function _v(s){s.Aa.set("Online")}async function Tv(s){s.Ta.forEach((t,e)=>{ma(s,t)})}async function bv(s,t){$h(s),va(s)?(s.Aa.la(t),ga(s)):s.Aa.set("Unknown")}async function xv(s,t,e){if(s.Aa.set("Online"),t instanceof Vh&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){fe(cn,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await Ms(s,i)}else if(t instanceof ds?s.Ra.Ye(t):t instanceof Lh?s.Ra.it(t):s.Ra.et(t),!e.isEqual(Me.min()))try{const i=await Xh(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((c,h)=>{if(c.resumeToken.approximateByteSize()>0){const d=r.Ta.get(h);d&&r.Ta.set(h,d.withResumeToken(c.resumeToken,o))}}),a.targetMismatches.forEach((c,h)=>{const d=r.Ta.get(c);if(!d)return;r.Ta.set(c,d.withResumeToken(Vt.EMPTY_BYTE_STRING,d.snapshotVersion)),Jh(r,c);const l=new Fi(d.target,c,h,d.sequenceNumber);ma(r,l)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){fe(cn,"Failed to raise snapshot:",i),await Ms(s,i)}}async function Ms(s,t,e){if(!qn(t))throw t;s.Ia.add(1),await Dr(s),s.Aa.set("Offline"),e||(e=()=>Xh(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{fe(cn,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await Gs(s)})}function eu(s,t){return t().catch(e=>Ms(s,e,t))}async function Zs(s){const t=De(s),e=Gi(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:$o;for(;Ev(t);)try{const n=await sv(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,Sv(t,n)}catch(n){await Ms(t,n)}tu(t)&&iu(t)}function Ev(s){return dn(s)&&s.Pa.length<10}function Sv(s,t){s.Pa.push(t);const e=Gi(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function tu(s){return dn(s)&&!Gi(s).M_()&&s.Pa.length>0}function iu(s){Gi(s).start()}async function Pv(s){Gi(s).na()}async function Cv(s){const t=Gi(s);for(const e of s.Pa)t.X_(e.mutations)}async function Av(s,t,e){const i=s.Pa.shift(),n=aa.from(i,t,e);await eu(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await Zs(s)}async function Rv(s,t){t&&Gi(s).Z_&&await async function(i,n){if(function(o){return ug(o)&&o!==Z.ABORTED}(n.code)){const r=i.Pa.shift();Gi(i).N_(),await eu(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await Zs(i)}}(s,t),tu(s)&&iu(s)}async function ac(s,t){const e=De(s);e.asyncQueue.verifyOperationInProgress(),fe(cn,"RemoteStore received new credentials");const i=dn(e);e.Ia.add(3),await Dr(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await Gs(e)}async function Iv(s,t){const e=De(s);t?(e.Ia.delete(2),await Gs(e)):t||(e.Ia.add(2),await Dr(e),e.Aa.set("Unknown"))}function Gn(s){return s.Va||(s.Va=function(e,i,n){const r=De(e);return r.ia(),new fv(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:_v.bind(null,s),e_:Tv.bind(null,s),n_:bv.bind(null,s),J_:xv.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),va(s)?ga(s):s.Aa.set("Unknown")):(await s.Va.stop(),$h(s))})),s.Va}function Gi(s){return s.ma||(s.ma=function(e,i,n){const r=De(e);return r.ia(),new mv(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:Pv.bind(null,s),n_:Rv.bind(null,s),ea:Cv.bind(null,s),ta:Av.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await Zs(s)):(await s.ma.stop(),s.Pa.length>0&&(fe(cn,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ya{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new sn,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new ya(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new de(Z.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function wa(s,t){if(xi("AsyncQueue",`${t}: ${s}`),qn(s))return new de(Z.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kn{static emptySet(t){return new kn(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||Se.comparator(e.key,i.key):(e,i)=>Se.comparator(e.key,i.key),this.keyedMap=lr(),this.sortedSet=new ot(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof kn)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new kn;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lc{constructor(){this.fa=new ot(Se.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):Ie(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class Hn{constructor(t,e,i,n,r,o,a,c,h){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=c,this.hasCachedResults=h}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new Hn(t,e,kn.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ns(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mv{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class Dv{constructor(){this.queries=cc(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=De(e),r=n.queries;n.queries=cc(),r.forEach((o,a)=>{for(const c of a.wa)c.onError(i)})})(this,new de(Z.ABORTED,"Firestore shutting down"))}}function cc(){return new un(s=>xh(s),Ns)}async function kv(s,t){const e=De(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new Mv,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=wa(o,`Initialization of query '${Rn(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&_a(e)}async function Ov(s,t){const e=De(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function Fv(s,t){const e=De(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&_a(e)}function Lv(s,t,e){const i=De(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function _a(s){s.Da.forEach(t=>{t.next()})}var Uo,hc;(hc=Uo||(Uo={})).Fa="default",hc.Cache="cache";class Vv{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new Hn(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=Hn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==Uo.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nu{constructor(t){this.key=t}}class ru{constructor(t){this.key=t}}class Bv{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Ve(),this.mutatedKeys=Ve(),this.Xa=Eh(t),this.eu=new kn(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new lc,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const c=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,h=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((d,l)=>{const p=n.get(d),f=zs(this.query,l)?l:null,m=!!p&&this.mutatedKeys.has(p.key),v=!!f&&(f.hasLocalMutations||this.mutatedKeys.has(f.key)&&f.hasCommittedMutations);let w=!1;p&&f?p.data.isEqual(f.data)?m!==v&&(i.track({type:3,doc:f}),w=!0):this.iu(p,f)||(i.track({type:2,doc:f}),w=!0,(c&&this.Xa(f,c)>0||h&&this.Xa(f,h)<0)&&(a=!0)):!p&&f?(i.track({type:0,doc:f}),w=!0):p&&!f&&(i.track({type:1,doc:p}),w=!0,(c||h)&&(a=!0)),w&&(f?(o=o.add(f),r=v?r.add(d):r.delete(d)):(o=o.delete(d),r=r.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),r=r.delete(d.key),i.track({type:1,doc:d})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((d,l)=>function(f,m){const v=w=>{switch(w){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ie(20277,{At:w})}};return v(f)-v(m)}(d.type,l.type)||this.Xa(d.doc,l.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],c=this.Za.size===0&&this.current&&!n?1:0,h=c!==this.Ya;return this.Ya=c,o.length!==0||h?{snapshot:new Hn(this.query,t.eu,r,o,t.mutatedKeys,c===0,h,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new lc,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Ve(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new ru(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new nu(i))}),e}uu(t){this.Ha=t.qs,this.Za=Ve();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return Hn.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const Ta="SyncEngine";class Hv{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class Nv{constructor(t){this.key=t,this.lu=!1}}class zv{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new un(a=>xh(a),Ns),this.Tu=new Map,this.Iu=new Set,this.du=new ot(Se.comparator),this.Eu=new Map,this.Au=new ha,this.Ru={},this.Vu=new Map,this.mu=Bn.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function Uv(s,t,e=!0){const i=hu(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await su(i,t,e,!0),n}async function jv(s,t){const e=hu(s);await su(e,t,!0,!1)}async function su(s,t,e,i){const n=await ov(s.localStore,di(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await qv(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&Kh(s.remoteStore,n),a}async function qv(s,t,e,i,n){s.gu=(l,p,f)=>async function(v,w,b,I){let O=w.view.nu(b);O.Ds&&(O=await ic(v.localStore,w.query,!1).then(({documents:k})=>w.view.nu(k,O)));const N=I&&I.targetChanges.get(w.targetId),q=I&&I.targetMismatches.get(w.targetId)!=null,ie=w.view.applyChanges(O,v.isPrimaryClient,N,q);return dc(v,w.targetId,ie._u),ie.snapshot}(s,l,p,f);const r=await ic(s.localStore,t,!0),o=new Bv(t,r.qs),a=o.nu(r.documents),c=Mr.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),h=o.applyChanges(a,s.isPrimaryClient,c);dc(s,e,h._u);const d=new Hv(t,e,o);return s.Pu.set(t,d),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),h.snapshot}async function Wv(s,t,e){const i=De(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!Ns(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await No(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&fa(i.remoteStore,n.targetId),jo(i,n.targetId)}).catch(jn)):(jo(i,n.targetId),await No(i.localStore,n.targetId,!0))}async function Gv(s,t){const e=De(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),fa(e.remoteStore,i.targetId))}async function Zv(s,t,e){const i=ey(s);try{const n=await function(o,a){const c=De(o),h=it.now(),d=a.reduce((f,m)=>f.add(m.key),Ve());let l,p;return c.persistence.runTransaction("Locally write mutations","readwrite",f=>{let m=Ei(),v=Ve();return c.Os.getEntries(f,d).next(w=>{m=w,m.forEach((b,I)=>{I.isValidDocument()||(v=v.add(b))})}).next(()=>c.localDocuments.getOverlayedDocuments(f,m)).next(w=>{l=w;const b=[];for(const I of a){const O=og(I,l.get(I.key).overlayedDocument);O!=null&&b.push(new Qi(I.key,O,mh(O.value.mapValue),oi.exists(!0)))}return c.mutationQueue.addMutationBatch(f,h,b,a)}).next(w=>{p=w;const b=w.applyToLocalDocumentSet(l,v);return c.documentOverlayCache.saveOverlays(f,w.batchId,b)})}).then(()=>({batchId:p.batchId,changes:Ph(l)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,c){let h=o.Ru[o.currentUser.toKey()];h||(h=new ot(Fe)),h=h.insert(a,c),o.Ru[o.currentUser.toKey()]=h}(i,n.batchId,e),await kr(i,n.changes),await Zs(i.remoteStore)}catch(n){const r=wa(n,"Failed to persist write");e.reject(r)}}async function ou(s,t){const e=De(s);try{const i=await nv(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(Ze(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?Ze(o.lu,14607):n.removedDocuments.size>0&&(Ze(o.lu,42227),o.lu=!1))}),await kr(e,i,t)}catch(i){await jn(i)}}function uc(s,t,e){const i=De(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const c=De(o);c.onlineState=a;let h=!1;c.queries.forEach((d,l)=>{for(const p of l.wa)p.va(a)&&(h=!0)}),h&&_a(c)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function Xv(s,t,e){const i=De(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new ot(Se.comparator);o=o.insert(r,qt.newNoDocument(r,Me.min()));const a=Ve().add(r),c=new qs(Me.min(),new Map,new ot(Fe),o,a);await ou(i,c),i.du=i.du.remove(r),i.Eu.delete(t),ba(i)}else await No(i.localStore,t,!1).then(()=>jo(i,t,e)).catch(jn)}async function Yv(s,t){const e=De(s),i=t.batch.batchId;try{const n=await iv(e.localStore,t);lu(e,i,null),au(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await kr(e,n)}catch(n){await jn(n)}}async function Qv(s,t,e){const i=De(s);try{const n=await function(o,a){const c=De(o);return c.persistence.runTransaction("Reject batch","readwrite-primary",h=>{let d;return c.mutationQueue.lookupMutationBatch(h,a).next(l=>(Ze(l!==null,37113),d=l.keys(),c.mutationQueue.removeMutationBatch(h,l))).next(()=>c.mutationQueue.performConsistencyCheck(h)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(h,d,a)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(h,d)).next(()=>c.localDocuments.getDocuments(h,d))})}(i.localStore,t);lu(i,t,e),au(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await kr(i,n)}catch(n){await jn(n)}}function au(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function lu(s,t,e){const i=De(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function jo(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||cu(s,i)})}function cu(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&(fa(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),ba(s))}function dc(s,t,e){for(const i of e)i instanceof nu?(s.Au.addReference(i.key,t),Kv(s,i)):i instanceof ru?(fe(Ta,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||cu(s,i.key)):Ie(19791,{yu:i})}function Kv(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(fe(Ta,"New document in limbo: "+e),s.Iu.add(i),ba(s))}function ba(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new Se(tt.fromString(t)),i=s.mu.next();s.Eu.set(i,new Nv(e)),s.du=s.du.insert(e,i),Kh(s.remoteStore,new Fi(di(ra(e.path)),i,"TargetPurposeLimboResolution",Vs.ue))}}async function kr(s,t,e){const i=De(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,c)=>{o.push(i.gu(c,t,e).then(h=>{var d;if((h||e)&&i.isPrimaryClient){const l=h?!h.fromCache:(d=e==null?void 0:e.targetChanges.get(c.targetId))===null||d===void 0?void 0:d.current;i.sharedClientState.updateQueryState(c.targetId,l?"current":"not-current")}if(h){n.push(h);const l=da.Es(c.targetId,h);r.push(l)}}))}),await Promise.all(o),i.hu.J_(n),await async function(c,h){const d=De(c);try{await d.persistence.runTransaction("notifyLocalViewChanges","readwrite",l=>Q.forEach(h,p=>Q.forEach(p.Is,f=>d.persistence.referenceDelegate.addReference(l,p.targetId,f)).next(()=>Q.forEach(p.ds,f=>d.persistence.referenceDelegate.removeReference(l,p.targetId,f)))))}catch(l){if(!qn(l))throw l;fe(pa,"Failed to update sequence numbers: "+l)}for(const l of h){const p=l.targetId;if(!l.fromCache){const f=d.Fs.get(p),m=f.snapshotVersion,v=f.withLastLimboFreeSnapshotVersion(m);d.Fs=d.Fs.insert(p,v)}}}(i.localStore,r))}async function Jv(s,t){const e=De(s);if(!e.currentUser.isEqual(t)){fe(Ta,"User change. New user:",t.toKey());const i=await Zh(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(c=>{c.reject(new de(Z.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await kr(e,i.Bs)}}function $v(s,t){const e=De(s),i=e.Eu.get(t);if(i&&i.lu)return Ve().add(i.key);{let n=Ve();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function hu(s){const t=De(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=ou.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=$v.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Xv.bind(null,t),t.hu.J_=Fv.bind(null,t.eventManager),t.hu.pu=Lv.bind(null,t.eventManager),t}function ey(s){const t=De(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Yv.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Qv.bind(null,t),t}class Ds{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=Ws(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return tv(this.persistence,new Jg,t.initialUser,this.serializer)}Du(t){return new Gh(ua.Vi,this.serializer)}bu(t){return new lv}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}Ds.provider={build:()=>new Ds};class ty extends Ds{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){Ze(this.persistence.referenceDelegate instanceof Is,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new Vg(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?Gt.withCacheSize(this.cacheSizeBytes):Gt.DEFAULT;return new Gh(i=>Is.Vi(i,e),this.serializer)}}class qo{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>uc(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=Jv.bind(null,this.syncEngine),await Iv(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new Dv}()}createDatastore(t){const e=Ws(t.databaseInfo.databaseId),i=function(r){return new pv(r)}(t.databaseInfo);return function(r,o,a,c){return new vv(r,o,a,c)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new wv(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>uc(this.syncEngine,e,0),function(){return sc.C()?new sc:new cv}())}createSyncEngine(t,e){return function(n,r,o,a,c,h,d){const l=new zv(n,r,o,a,c,h);return d&&(l.fu=!0),l}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=De(n);fe(cn,"RemoteStore shutting down."),r.Ia.add(5),await Dr(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}qo.provider={build:()=>new qo};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iy{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):xi("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zi="FirestoreClient";class ny{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=jt.UNAUTHENTICATED,this.clientId=Jo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{fe(Zi,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(fe(Zi,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new sn;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=wa(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function yo(s,t){s.asyncQueue.verifyOperationInProgress(),fe(Zi,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await Zh(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{zi("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{fe("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{zi("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function pc(s,t){s.asyncQueue.verifyOperationInProgress();const e=await ry(s);fe(Zi,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>ac(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>ac(t.remoteStore,n)),s._onlineComponents=t}async function ry(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){fe(Zi,"Using user provided OfflineComponentProvider");try{await yo(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===Z.FAILED_PRECONDITION||n.code===Z.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;zi("Error using user provided cache. Falling back to memory cache: "+e),await yo(s,new Ds)}}else fe(Zi,"Using default OfflineComponentProvider"),await yo(s,new ty(void 0));return s._offlineComponents}async function uu(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(fe(Zi,"Using user provided OnlineComponentProvider"),await pc(s,s._uninitializedComponentsProvider._online)):(fe(Zi,"Using default OnlineComponentProvider"),await pc(s,new qo))),s._onlineComponents}function sy(s){return uu(s).then(t=>t.syncEngine)}async function fc(s){const t=await uu(s),e=t.eventManager;return e.onListen=Uv.bind(null,t.syncEngine),e.onUnlisten=Wv.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=jv.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=Gv.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function du(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mc=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pu="firestore.googleapis.com",gc=!0;class vc{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new de(Z.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=pu,this.ssl=gc}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:gc;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=Wh;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<Fg)throw new de(Z.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}_m("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=du((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new de(Z.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new de(Z.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new de(Z.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Xs{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new vc({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new de(Z.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new de(Z.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new vc(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new um;switch(i.type){case"firstParty":return new mm(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new de(Z.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=mc.get(e);i&&(fe("ComponentProvider","Removing Datastore"),mc.delete(e),i.terminate())}(this),Promise.resolve()}}function oy(s,t,e,i={}){var n;s=Hi(s,Xs);const r=Yo(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),c=`${t}:${e}`;r&&(Hp(`https://${c}`),jp("Firestore",!0)),o.host!==pu&&o.host!==c&&zi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const h=Object.assign(Object.assign({},o),{host:c,ssl:r,emulatorOptions:i});if(!_s(h,a)&&(s._setSettings(h),i.mockUserToken)){let d,l;if(typeof i.mockUserToken=="string")d=i.mockUserToken,l=jt.MOCK_USER;else{d=Np(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const p=i.mockUserToken.sub||i.mockUserToken.user_id;if(!p)throw new de(Z.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new jt(p)}s._authCredentials=new dm(new ih(d,l))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pn{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new pn(this.firestore,t,this._query)}}class St{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Ni(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new St(this.firestore,t,this._key)}toJSON(){return{type:St._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(Rr(e,St._jsonSchema))return new St(t,i||null,new Se(tt.fromString(e.referencePath)))}}St._jsonSchemaVersion="firestore/documentReference/1.0",St._jsonSchema={type:Et("string",St._jsonSchemaVersion),referencePath:Et("string")};class Ni extends pn{constructor(t,e,i){super(t,e,ra(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new St(this.firestore,null,new Se(t))}withConverter(t){return new Ni(this.firestore,t,this._path)}}function yc(s,t,...e){if(s=gi(s),rh("collection","path",t),s instanceof Xs){const i=tt.fromString(t,...e);return Rl(i),new Ni(s,null,i)}{if(!(s instanceof St||s instanceof Ni))throw new de(Z.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(tt.fromString(t,...e));return Rl(i),new Ni(s.firestore,null,i)}}function Wo(s,t,...e){if(s=gi(s),arguments.length===1&&(t=Jo.newId()),rh("doc","path",t),s instanceof Xs){const i=tt.fromString(t,...e);return Al(i),new St(s,null,new Se(i))}{if(!(s instanceof St||s instanceof Ni))throw new de(Z.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(tt.fromString(t,...e));return Al(i),new St(s.firestore,s instanceof Ni?s.converter:null,new Se(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wc="AsyncQueue";class _c{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new Yh(this,"async_queue_retry"),this.oc=()=>{const i=vo();i&&fe(wc,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=vo();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=vo();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new sn;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!qn(t))throw t;fe(wc,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,xi("INTERNAL UNHANDLED ERROR: ",Tc(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=ya.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&Ie(47125,{hc:Tc(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function Tc(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bc(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class Nn extends Xs{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new _c,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new _c(t),this._firestoreClient=void 0,await t}}}function ay(s,t){const e=typeof s=="object"?s:em(),i=typeof s=="string"?s:Es,n=Yf(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=Vp("firestore");r&&oy(n,...r)}return n}function fu(s){if(s._terminated)throw new de(Z.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||ly(s),s._firestoreClient}function ly(s){var t,e,i;const n=s._freezeSettings(),r=function(a,c,h,d){return new Mm(a,c,h,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,du(d.experimentalLongPollingOptions),d.useFetchStreams,d.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new ny(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const c=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(c),_online:c}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ei{constructor(t){this._byteString=t}static fromBase64String(t){try{return new ei(Vt.fromBase64String(t))}catch(e){throw new de(Z.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new ei(Vt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:ei._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(Rr(t,ei._jsonSchema))return ei.fromBase64String(t.bytes)}}ei._jsonSchemaVersion="firestore/bytes/1.0",ei._jsonSchema={type:Et("string",ei._jsonSchemaVersion),bytes:Et("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ys{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new de(Z.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Lt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xa{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fi{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new de(Z.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new de(Z.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return Fe(this._lat,t._lat)||Fe(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:fi._jsonSchemaVersion}}static fromJSON(t){if(Rr(t,fi._jsonSchema))return new fi(t.latitude,t.longitude)}}fi._jsonSchemaVersion="firestore/geoPoint/1.0",fi._jsonSchema={type:Et("string",fi._jsonSchemaVersion),latitude:Et("number"),longitude:Et("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mi{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:mi._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(Rr(t,mi._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new mi(t.vectorValues);throw new de(Z.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}mi._jsonSchemaVersion="firestore/vectorValue/1.0",mi._jsonSchema={type:Et("string",mi._jsonSchemaVersion),vectorValues:Et("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cy=/^__.*__$/;class hy{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new Qi(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ir(t,this.data,e,this.fieldTransforms)}}class mu{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new Qi(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function gu(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ie(40011,{Ec:s})}}class Ea{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new Ea(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return ks(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(gu(this.Ec)&&cy.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class uy{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||Ws(t)}Dc(t,e,i,n=!1){return new Ea({Ec:t,methodName:e,bc:i,path:Lt.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Sa(s){const t=s._freezeSettings(),e=Ws(s._databaseId);return new uy(s._databaseId,!!t.ignoreUndefinedProperties,e)}function dy(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);Pa("Data must be an object, but it was:",o,i);const a=vu(i,o);let c,h;if(r.merge)c=new Jt(o.fieldMask),h=o.fieldTransforms;else if(r.mergeFields){const d=[];for(const l of r.mergeFields){const p=Go(t,l,e);if(!o.contains(p))throw new de(Z.INVALID_ARGUMENT,`Field '${p}' is specified in your field mask but missing from your input data.`);wu(d,p)||d.push(p)}c=new Jt(d),h=o.fieldTransforms.filter(l=>c.covers(l.field))}else c=null,h=o.fieldTransforms;return new hy(new Xt(a),c,h)}class Qs extends xa{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Qs}}function py(s,t,e,i){const n=s.Dc(1,t,e);Pa("Data must be an object, but it was:",n,i);const r=[],o=Xt.empty();Yi(i,(c,h)=>{const d=Ca(t,c,e);h=gi(h);const l=n.gc(d);if(h instanceof Qs)r.push(d);else{const p=Or(h,l);p!=null&&(r.push(d),o.set(d,p))}});const a=new Jt(r);return new mu(o,a,n.fieldTransforms)}function fy(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[Go(t,i,e)],c=[n];if(r.length%2!=0)throw new de(Z.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let p=0;p<r.length;p+=2)a.push(Go(t,r[p])),c.push(r[p+1]);const h=[],d=Xt.empty();for(let p=a.length-1;p>=0;--p)if(!wu(h,a[p])){const f=a[p];let m=c[p];m=gi(m);const v=o.gc(f);if(m instanceof Qs)h.push(f);else{const w=Or(m,v);w!=null&&(h.push(f),d.set(f,w))}}const l=new Jt(h);return new mu(d,l,o.fieldTransforms)}function my(s,t,e,i=!1){return Or(e,s.Dc(i?4:3,t))}function Or(s,t){if(yu(s=gi(s)))return Pa("Unsupported field value:",t,s),vu(s,t);if(s instanceof xa)return function(i,n){if(!gu(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let c=Or(a,n.yc(o));c==null&&(c={nullValue:"NULL_VALUE"}),r.push(c),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=gi(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return eg(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=it.fromDate(i);return{timestampValue:Rs(n.serializer,r)}}if(i instanceof it){const r=new it(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:Rs(n.serializer,r)}}if(i instanceof fi)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof ei)return{bytesValue:Bh(n.serializer,i._byteString)};if(i instanceof St){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ca(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof mi)return function(o,a){return{mapValue:{fields:{[ph]:{stringValue:fh},[Ss]:{arrayValue:{values:o.toArray().map(h=>{if(typeof h!="number")throw a.wc("VectorValues must only contain numeric values.");return sa(a.serializer,h)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${Ls(i)}`)}(s,t)}function vu(s,t){const e={};return ah(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Yi(s,(i,n)=>{const r=Or(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function yu(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof it||s instanceof fi||s instanceof ei||s instanceof St||s instanceof xa||s instanceof mi)}function Pa(s,t,e){if(!yu(e)||!sh(e)){const i=Ls(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function Go(s,t,e){if((t=gi(t))instanceof Ys)return t._internalPath;if(typeof t=="string")return Ca(s,t);throw ks("Field path arguments must be of type string or ",s,!1,void 0,e)}const gy=new RegExp("[~\\*/\\[\\]]");function Ca(s,t,e){if(t.search(gy)>=0)throw ks(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new Ys(...t.split("."))._internalPath}catch{throw ks(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function ks(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(r||o)&&(c+=" (found",r&&(c+=` in field ${i}`),o&&(c+=` in document ${n}`),c+=")"),new de(Z.INVALID_ARGUMENT,a+s+c)}function wu(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _u{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new St(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new vy(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Ks("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class vy extends _u{data(){return super.data()}}function Ks(s,t){return typeof t=="string"?Ca(s,t):t instanceof Ys?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yy(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new de(Z.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Aa{}class Tu extends Aa{}function wy(s,t,...e){let i=[];t instanceof Aa&&i.push(t),i=i.concat(e),function(r){const o=r.filter(c=>c instanceof Ra).length,a=r.filter(c=>c instanceof Js).length;if(o>1||o>0&&a>0)throw new de(Z.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class Js extends Tu{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new Js(t,e,i)}_apply(t){const e=this._parse(t);return bu(t._query,e),new pn(t.firestore,t.converter,Oo(t._query,e))}_parse(t){const e=Sa(t.firestore);return function(r,o,a,c,h,d,l){let p;if(h.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new de(Z.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){Ec(l,d);const m=[];for(const v of l)m.push(xc(c,r,v));p={arrayValue:{values:m}}}else p=xc(c,r,l)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||Ec(l,d),p=my(a,o,l,d==="in"||d==="not-in");return xt.create(h,d,p)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function _y(s,t,e){const i=t,n=Ks("where",s);return Js._create(n,i,e)}class Ra extends Aa{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Ra(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:li.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const c of a)bu(o,c),o=Oo(o,c)}(t._query,e),new pn(t.firestore,t.converter,Oo(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class Ia extends Tu{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new Ia(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new de(Z.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new de(Z.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Er(r,o)}(t._query,this._field,this._direction);return new pn(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new Wn(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function Ty(s,t="asc"){const e=t,i=Ks("orderBy",s);return Ia._create(i,e)}function xc(s,t,e){if(typeof(e=gi(e))=="string"){if(e==="")throw new de(Z.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!bh(t)&&e.indexOf("/")!==-1)throw new de(Z.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(tt.fromString(e));if(!Se.isDocumentKey(i))throw new de(Z.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return Vl(s,new Se(i))}if(e instanceof St)return Vl(s,e._key);throw new de(Z.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ls(e)}.`)}function Ec(s,t){if(!Array.isArray(s)||s.length===0)throw new de(Z.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function bu(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new de(Z.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new de(Z.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class by{convertValue(t,e="none"){switch(Wi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return mt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(qi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw Ie(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return Yi(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[Ss].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>mt(o.doubleValue));return new mi(r)}convertGeoPoint(t){return new fi(mt(t.latitude),mt(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=Hs(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(Tr(t));default:return null}}convertTimestamp(t){const e=ji(t);return new it(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=tt.fromString(t);Ze(qh(i),9688,{name:t});const n=new br(i.get(1),i.get(3)),r=new Se(i.popFirst(5));return n.isEqual(e)||xi(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function xy(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class hr{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class on extends _u{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new ps(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(Ks("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new de(Z.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=on._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}on._jsonSchemaVersion="firestore/documentSnapshot/1.0",on._jsonSchema={type:Et("string",on._jsonSchemaVersion),bundleSource:Et("string","DocumentSnapshot"),bundleName:Et("string"),bundle:Et("string")};class ps extends on{data(t={}){return super.data(t)}}class On{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new hr(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new ps(this._firestore,this._userDataWriter,i.key,i,new hr(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new de(Z.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const c=new ps(n._firestore,n._userDataWriter,a.doc.key,a.doc,new hr(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:c,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const c=new ps(n._firestore,n._userDataWriter,a.doc.key,a.doc,new hr(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let h=-1,d=-1;return a.type!==0&&(h=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),d=o.indexOf(a.doc.key)),{type:Ey(a.type),doc:c,oldIndex:h,newIndex:d}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new de(Z.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=On._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=Jo.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function Ey(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ie(61501,{type:s})}}On._jsonSchemaVersion="firestore/querySnapshot/1.0",On._jsonSchema={type:Et("string",On._jsonSchemaVersion),bundleSource:Et("string","QuerySnapshot"),bundleName:Et("string"),bundle:Et("string")};class xu extends by{constructor(t){super(),this.firestore=t}convertBytes(t){return new ei(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new St(this.firestore,null,e)}}function Sy(s,t,e,...i){s=Hi(s,St);const n=Hi(s.firestore,Nn),r=Sa(n);let o;return o=typeof(t=gi(t))=="string"||t instanceof Ys?fy(r,"updateDoc",s._key,t,e,i):py(r,"updateDoc",s._key,t),Ma(n,[o.toMutation(s._key,oi.exists(!0))])}function Py(s){return Ma(Hi(s.firestore,Nn),[new oa(s._key,oi.none())])}function Cy(s,t){const e=Hi(s.firestore,Nn),i=Wo(s),n=xy(s.converter,t);return Ma(e,[dy(Sa(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,oi.exists(!1))]).then(()=>i)}function Ay(s,...t){var e,i,n;s=gi(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||bc(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(bc(t[o])){const l=t[o];t[o]=(e=l.next)===null||e===void 0?void 0:e.bind(l),t[o+1]=(i=l.error)===null||i===void 0?void 0:i.bind(l),t[o+2]=(n=l.complete)===null||n===void 0?void 0:n.bind(l)}let c,h,d;if(s instanceof St)h=Hi(s.firestore,Nn),d=ra(s._key.path),c={next:l=>{t[o]&&t[o](Ry(h,s,l))},error:t[o+1],complete:t[o+2]};else{const l=Hi(s,pn);h=Hi(l.firestore,Nn),d=l._query;const p=new xu(h);c={next:f=>{t[o]&&t[o](new On(h,p,l,f))},error:t[o+1],complete:t[o+2]},yy(s._query)}return function(p,f,m,v){const w=new iy(v),b=new Vv(f,w,m);return p.asyncQueue.enqueueAndForget(async()=>kv(await fc(p),b)),()=>{w.Ou(),p.asyncQueue.enqueueAndForget(async()=>Ov(await fc(p),b))}}(fu(h),d,a,c)}function Ma(s,t){return function(i,n){const r=new sn;return i.asyncQueue.enqueueAndForget(async()=>Zv(await sy(i),n,r)),r.promise}(fu(s),t)}function Ry(s,t,e){const i=e.docs.get(t._key),n=new xu(s);return new on(s,n,t._key,i,new hr(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){Un=n})($f),bs(new yr("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new Nn(new pm(i.getProvider("auth-internal")),new gm(o,i.getProvider("app-check-internal")),function(h,d){if(!Object.prototype.hasOwnProperty.apply(h.options,["projectId"]))throw new de(Z.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new br(h.options.projectId,d)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),Dn(xl,El,t),Dn(xl,El,"esm2017")})();var Iy="firebase",My="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Dn(Iy,My,"app");const Dy={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},ky=Gc(Dy),os=ay(ky);var Oy=j('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),Fy=j("<div style=margin-bottom:12px;>"),Ly=j('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;">💬 Add feedback'),Vy=j("<div style=margin-top:16px;>"),By=j('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),Hy=j('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),Ny=j('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),zy=j("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;> • </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),Uy=j("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),jy=j('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function Sc({updateId:s,updateTitle:t}){const[e,i]=he([]),[n,r]=he(""),[o,a]=he(null),[c,h]=he(""),[d,l]=he(!1),[p,f]=he(localStorage.getItem("feedbackAuthor")||"Deji"),[m,v]=he(!1),[w,b]=he(!1),[I,O]=he(!1);nn(()=>{const S=wy(yc(os,"feedbacks"),_y("updateId","==",s),Ty("timestamp","desc")),E=Ay(S,D=>{const L=[];D.forEach(F=>{L.push({id:F.id,...F.data()})}),i(L)});return()=>E()});const N=async S=>{if(S.preventDefault(),!!n().trim()){l(!0);try{await Cy(yc(os,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:p(),timestamp:new Date,edited:!1}),r(""),O(!1)}catch(E){console.error("Error adding feedback:",E)}l(!1)}},q=async S=>{if(c().trim())try{await Sy(Wo(os,"feedbacks",S),{text:c(),edited:!0,editedAt:new Date}),a(null),h("")}catch(E){console.error("Error editing feedback:",E)}},ie=async S=>{if(confirm("Delete this feedback?"))try{await Py(Wo(os,"feedbacks",S))}catch(E){console.error("Error deleting feedback:",E)}},k=S=>{if(!S)return"";const E=S.toDate?S.toDate():new Date(S),L=new Date-E,F=Math.floor(L/(1e3*60*60));return F<1?"Just now":F<24?`${F} hour${F>1?"s":""} ago`:F<48?"Yesterday":E.toLocaleDateString()};return(()=>{var S=Vy();return se(S,ye(Ne,{get when(){return e().length>0},get children(){var E=Fy();return se(E,ye(_o,{get each(){return Ct(()=>!!w())()?e():e().slice(0,2)},children:D=>(()=>{var L=Hy();return se(L,ye(Ne,{get when(){return o()===D.id},get fallback(){return[(()=>{var F=Ny();return se(F,()=>D.text),F})(),(()=>{var F=zy(),A=F.firstChild,V=A.firstChild,ne=A.nextSibling,ce=ne.firstChild,G=ce.nextSibling;return se(A,()=>D.author,V),se(A,()=>k(D.timestamp),null),se(A,()=>D.edited&&" (edited)",null),ce.$$click=()=>{a(D.id),h(D.text)},G.$$click=()=>ie(D.id),F})()]},get children(){var F=By(),A=F.firstChild,V=A.nextSibling,ne=V.firstChild,ce=ne.nextSibling;return A.$$input=G=>h(G.target.value),ne.$$click=()=>q(D.id),ce.$$click=()=>{a(null),h("")},je(()=>A.value=c()),F}})),L})()}),null),se(E,ye(Ne,{get when(){return e().length>2},get children(){var D=Oy();return D.$$click=()=>b(!w()),se(D,(()=>{var L=Ct(()=>!!w());return()=>L()?`− Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),D}}),null),E}}),null),se(S,ye(Ne,{get when(){return!I()},get fallback(){return(()=>{var E=jy(),D=E.firstChild,L=D.firstChild,F=L.firstChild,A=F.nextSibling,V=L.nextSibling,ne=D.nextSibling,ce=ne.firstChild,G=ce.nextSibling,J=G.firstChild,$=J.nextSibling;return se(A,p),V.$$click=()=>v(!m()),se(E,ye(Ne,{get when(){return m()},get children(){var oe=Uy(),Oe=oe.firstChild,we=Oe.firstChild,W=we.nextSibling;return we.$$click=()=>{f("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),v(!1)},W.$$click=()=>{f("Deji"),localStorage.setItem("feedbackAuthor","Deji"),v(!1)},je(_e=>{var ze=`background: ${p()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,gt=`background: ${p()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return _e.e=ur(we,ze,_e.e),_e.t=ur(W,gt,_e.t),_e},{e:void 0,t:void 0}),oe}}),ne),ne.addEventListener("submit",N),ce.$$input=oe=>r(oe.target.value),se(J,()=>d()?"Posting...":"Post"),$.$$click=()=>{O(!1),r("")},je(oe=>{var Oe=d(),we=d()||!n().trim(),W=`background: ${d()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${d()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return Oe!==oe.e&&(ce.disabled=oe.e=Oe),we!==oe.t&&(J.disabled=oe.t=we),oe.a=ur(J,W,oe.a),oe},{e:void 0,t:void 0,a:void 0}),je(()=>ce.value=n()),E})()},get children(){var E=Ly();return E.$$click=()=>O(!0),E}}),null),S})()}hn(["click","input"]);var qy=j("<p>The debug controls (press 'C' to open) now work on phones and tablets."),Wy=j("<h4>What's new"),Gy=j("<p><strong>Mobile devices</strong><br>A compact bar at the bottom shows FPS and a settings icon. Tap it to reveal controls that slide up. Swipe down or tap outside to dismiss."),Zy=j("<p><strong>Desktop</strong><br>The panel can now be minimized to a small floating button instead of closing completely."),Xy=j("<p><em>Small quality-of-life improvement, but it makes testing on different devices much more pleasant!"),Yy=j("<p>The experimental touch-hold system I mentioned yesterday is now more reliable. After testing, I found and fixed an issue where hotspots would sometimes stop responding after being activated once."),Qy=j("<h4>What's improved"),Ky=j(`<p>If you enable "Temporal" mode in the debug menu (press 'C'), the hold-to-interact system now works consistently. Hotspots stay visible while you hold them, and each interaction resets cleanly for the next one.`),Jy=j("<h4>Also tweaked"),$y=j("<p>Added white color options to the border palette since you're working with black ink artwork. More importantly, <strong>temporal mode is now the default on mobile devices</strong> - meaning visitors will use the hold-to-interact system instead of direct taps. You can always switch back to standard tap-to-zoom in the debug menu if needed."),ew=j("<p>With ~600 interactive zones hidden throughout your artwork, I've added a way to briefly reveal what's clickable without disrupting the visual experience."),tw=j("<h4>How it works"),iw=j("<p>Press 'H' (desktop) or triple-tap anywhere (mobile) to make all nearby hotspots gently pulse for 6 seconds. The effect uses contrast inversion to ensure visibility on your black ink artwork while staying subtle enough not to break immersion."),nw=j("<h4>Also included: Alternative touch controls"),rw=j(`<p>For mobile users, I've prepared an experimental hold-to-interact system that's currently tucked away in the debug menu. If you're curious, press 'C' to open debug options and switch from "Direct" to "Temporal" interaction. This changes how taps work - but the standard tap-to-zoom remains the default for now.`),sw=j("<p>The reveal helper should make exploration feel less like guesswork and more like discovery. Let me know if the visibility needs adjusting - it's easy to make it bolder or more subtle based on your preference."),ow=j("<p><strong>Safari animations:</strong> Now working! Chrome/Firefox/Edge still have the edge visually, but Safari's functional. Requires Safari 13.1+ (2020 or newer)."),aw=j("<p><strong>Smart zoom behavior:</strong> Following Google Arts & Culture's approach, animations now adapt to zoom level. Below 8x zoom = full animations. Above 8x = quick 150ms transitions only. When you're examining details up close, decorative animations would just distract."),lw=j("<p><strong>Next:</strong> Making the cinematic zoom buttery smooth when clicking hotspots. Also thinking the stroke animation makes sense for desktop, but mobile needs something snappier."),cw=j("<p><em>Personal note: Getting really excited - it's starting to take shape! :D"),hw=j("<p><strong>Current status:</strong> While the hover animations now work on Safari, the visual effect isn't as pronounced as on Chrome/Firefox. I'm quite proud of the result on chrome at the moment. I think it's quite satisfying."),uw=j("<p><strong>Recommendation:</strong> Use Chrome for now to see the intended visual impact. The difference is noticeable - Chrome displays richer glows and better depth."),dw=j("<p><strong>What's next:</strong> Working on Safari-specific optimizations to improve the visual quality without compromising performance."),pw=j("<p><strong>Following up on January 7th:</strong> The Safari issue is fixed! The stroke reveal animation now works properly on Safari desktop where you can actually hover."),fw=j("<p><strong>Next up</strong>: Making the animation more visible and impactful for desktop users, plus exploring touch-friendly animations for mobile devices."),mw=j("<p><strong>Responding to your feedback:</strong> You mentioned the hover effect felt static with just the white border appearing. I've implemented a first animation to bring more life to the interactions."),gw=j(`<p><strong>What's new:</strong> A stroke reveal animation that progressively traces the hotspot outline when you hover. Instead of the border just "popping" into view, it now draws itself smoothly around the shape - like watching someone trace the contour with a pen.`),vw=j("<p><strong>Current settings:</strong><br>• White stroke with subtle shadow for visibility<br>• 1.2 second drawing animation<br>• Works on Chrome, Firefox, and Edge"),yw=j("<p><strong>Needs refinement:</strong> The animation is quite subtle right now - you might have to look closely to see the progressive drawing effect. I'll be adjusting the timing and visibility to make it more noticeable and satisfying."),ww=j("<p><strong>Safari issue discovered:</strong> Just noticed the animation isn't working properly on Safari (There's always something with Safari 🙃). Will fix this tomorrow along with the other refinements."),_w=j("<p><strong>Note:</strong> This is one hover effect I wanted to try first. I'm planning to experiment with additional animations to find what feels best for your artwork. Let me know your thoughts!"),Tw=j("<p><strong>What's improved:</strong> The circular spotlight effect in Apple Mode (Safari/iOS) now adapts much better to different hotspot shapes."),bw=j("<p><strong>What changed:</strong><br>• Spotlights are now tighter and more focused around each hotspot (both mobile and desktop)<br>• Better detection of when to use circles vs ellipses based on hotspot shape"),xw=j("<p><strong>The result:</strong> Whether a hotspot is round, tall, wide, or irregular, the spotlight should now feel more natural and better frame the content the user is exploring."),Ew=j("<p>Try clicking on different shaped hotspots - the spotlight should feel more consistent and purposeful now!"),Sw=j("<p><strong>The issue:</strong> Some complex hotspots still extend outside the spotlight area after yesterday's improvements."),Pw=j("<p><strong>Today's attempt:</strong> Since a single circular spotlight can't perfectly cover irregular shapes, I tried combining multiple circles at different positions to fill in the gaps. Unfortunately, Safari doesn't support this technique - it only displays one spotlight instead of blending them together like other browsers do."),Cw=j("<p><strong>Next:</strong> Fine-tuning the spotlight sizing parameters to better fit each hotspot's unique shape."),Aw=j("<p><strong>What's improved:</strong> The spotlight effect on Safari and iOS devices now much better matches the actual hotspot shapes, especially on desktop Safari!"),Rw=j("<p><strong>Key changes:</strong><br>• Spotlights now use elliptical shapes for elongated hotspots<br>• Tighter, more precise spotlight coverage that follows the hotspot boundaries closely<br>• Better visual consistency between the outline of the hotspot and the darkened area<br>• Desktop Safari shows the most dramatic improvements, mobile iOS continues to be refined"),Iw=j("<p><strong>Still fine-tuning:</strong> Some complex hotspots have small areas that peek slightly outside the spotlight. Mobile Safari needs additional optimization for the same precision as desktop."),Mw=j("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),Dw=j('<p><strong>How it works:</strong><br>• Type your feedback in the text box below any update<br>• Click "Post Feedback" to send<br>• Edit or delete your comments anytime<br>• Everything syncs in real-time between us'),kw=j('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),Ow=j("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),Fw=j("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),Lw=j("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),Vw=j("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),Bw=j("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),Hw=j("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),Nw=j("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),zw=j("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br>• Uses radial gradient masks instead of polygon cutouts<br>• Provides a circular/elliptical spotlight effect around hotspots<br>• Maintains smooth 60 FPS performance on all iOS devices"),Uw=j("<p><strong>What's Different:</strong><br>• <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br>• <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),jw=j("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),qw=j("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),Ww=j("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),Gw=j("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br>• iPhone (Safari & Chrome)<br>• iPad (Safari & Chrome)<br>• Mac (Safari only - Chrome works fine!)"),Zw=j("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),Xw=j("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),Yw=j("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),Qw=j("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),Kw=j("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),Jw=j("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),$w=j(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now 🤷 `),e_=j("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),t_=j(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),i_=j("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),n_=j("<p>Hey Deji! 👋"),r_=j("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),s_=j("<p>I totally relate to your potato mode confession 😅 We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),o_=j("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable – I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),a_=j(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),l_=j("<p>Looking forward to showing you the improvements!<br>- Leonard"),c_=j('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),h_=j(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn>×</button></div><div class=update-section style="background:linear-gradient(135deg, #1a1f2e 0%, #1e2330 100%);border:1px solid rgba(0, 136, 204, 0.3);margin-bottom:20px;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);"><h4 style="color:#0088cc;margin:0 0 16px 0;font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px;"><span style=font-size:20px;>📱</span> Communication Update</h4><p style="color:rgba(255, 255, 255, 0.85);margin:0 0 20px 0;font-size:14px;line-height:1.6;">Our Upwork channel is no longer available. I've reached out via your business contacts and remain fully committed to your project.</p><div style="background:rgba(0, 136, 204, 0.1);padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;"><a href=https://t.me/LeonardCote target=_blank style="display:inline-flex;align-items:center;gap:8px;background:#0088cc;color:white;padding:10px 24px;border-radius:6px;text-decoration:none;font-weight:500;font-size:15px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0, 136, 204, 0.3);"><svg width=16 height=16 viewBox="0 0 24 24"fill=currentColor><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.223-.548.223l.188-2.85 5.18-4.68c.223-.198-.054-.308-.346-.111l-6.4 4.02-2.76-.918c-.6-.187-.612-.6.125-.89l10.782-4.156c.5-.18.94.12.78.88z"></path></svg>Message me on Telegram</a><p style="color:rgba(255, 255, 255, 0.6);margin:12px 0 0 0;font-size:13px;text-align:center;">or email: <a href=mailto:leonard.cote08@gmail.com style=color:#0088cc;text-decoration:none;>leonard.cote08@gmail.com</a></p></div><p style="color:rgba(255, 255, 255, 0.7);margin:0;font-size:13px;line-height:1.5;">The project continues to progress. All updates are posted here.<br><em style=opacity:0.8;>Platform details can be discussed when we connect.</em></p></div><style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style><div class=message-toggle><button class=toggle-btn>`),Pc=j("<div class=update-section><h4> (<!>)"),u_=j("<div class=app-container>"),d_=j("<div class=loading-screen><p>Loading Interactive Art Diary...");function p_({onClose:s}){const[t,e]=he(!1);he(!1);const i=[{id:"debug-panel-jan13",date:"January 13",title:"🎛️ Control Panel Goes Mobile-Friendly",content:[qy(),Wy(),Gy(),Zy(),Xy()]},{id:"temporal-polish-jan12",date:"January 12",title:"📱 Mobile Touch Controls Refined",content:[Yy(),Qy(),Ky(),Jy(),$y()]},{id:"reveal-mode-jan11",date:"January 11",title:"🔍 Easier Mobile Exploration",content:[ew(),tw(),iw(),nw(),rw(),sw()]},{id:"safari-compatibility-jan10",date:"January 10",title:"🍎 Safari Compatibility & Smart Zoom Update",content:[ow(),aw(),lw(),cw()]},{id:"safari-visual-jan9",date:"January 9",title:"Visual Effects - Browser Differences",content:[hw(),uw(),dw()]},{id:"safari-fix-jan8",date:"January 8",title:"✅ Safari Issue Resolved",content:[pw(),fw()]},{id:"hover-animations-jan7",date:"January 7 - night",title:"✨ Hover Animation Update",content:[mw(),gw(),vw(),yw(),ww(),_w()]},{id:"spotlight-refinements-july7",date:"July 7",title:"🍎 Apple Mode Spotlight Improvements",content:[Tw(),bw(),xw(),Ew()]},{id:"spotlight-coverage-july5",date:"July 5",title:"🔍 Working on Complete Hotspot Coverage for Safari/iOS",content:[Sw(),Pw(),Cw()]},{id:"spotlight-improvements-july4",date:"July 4",title:"🎯 Spotlight Effect Improvements for Safari/iOS",content:[Aw(),Rw(),Iw()]},{id:"feedback-system-july3",date:"July 3 - night",title:"💬 New: Direct Feedback System",content:[Mw(),Dw(),kw(),Ow()]},{id:"border-experiment-july3",date:"July 3",title:"🔧 Border Experiment for Apple Mode",content:[Fw(),Lw(),Vw(),Bw(),Hw()]},{id:"safari-solution-july2",date:"July 2",title:"✅ Safari/iOS Spotlight Solution Implemented",content:[Nw(),zw(),Uw(),jw(),qw()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:"🔧 Spotlight Effect - Browser Compatibility",content:[Ww(),Gw(),Zw(),Xw(),Yw(),Qw()]},{id:"zoom-speed-july1",date:"July 1",title:"🎬 Zoom Speed Control & Performance Update",content:[Kw(),Jw(),$w(),e_()]},{id:"performance-june30",date:"June 30",title:"🎯 Performance Breakthrough",content:t_()},{id:"focus-mode-june29",date:"June 29",title:"🔧 New Feature",content:i_()},{id:"personal-june28",date:"June 28",title:"💬 Personal Message",content:[n_(),r_(),s_(),o_(),a_(),l_()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=h_(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=a.nextSibling,l=d.nextSibling,p=l.nextSibling,f=p.firstChild;return Fc(h,"click",s),se(o,()=>n.map(m=>(()=>{var v=Pc(),w=v.firstChild,b=w.firstChild,I=b.nextSibling;return I.nextSibling,se(w,()=>m.title,b),se(w,()=>m.date,I),se(v,()=>m.content,null),se(v,ye(Sc,{get updateId(){return m.id},get updateTitle(){return m.title}}),null),v})()),p),f.$$click=()=>e(!t()),se(f,()=>t()?"− Hide previous updates":"+ Show previous updates"),se(o,ye(Ne,{get when(){return t()},get children(){var m=c_();return m.firstChild,se(m,()=>r.map(v=>(()=>{var w=Pc(),b=w.firstChild,I=b.firstChild,O=I.nextSibling;return O.nextSibling,se(b,()=>v.title,I),se(b,()=>v.date,O),se(w,()=>v.content,null),se(w,ye(Sc,{get updateId(){return v.id},get updateTitle(){return v.title}}),null),w})()),null),m}}),null),o})()}function f_(){const[s,t]=he(!1),[e]=he("zebra"),[i,n]=he(!0),r=()=>{n(!1)};return Fs(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var o=u_();return se(o,(()=>{var a=Ct(()=>!!i());return()=>a()&&ye(p_,{onClose:r})})(),null),se(o,(()=>{var a=Ct(()=>!!s());return()=>a()?ye(Pp,{get artworkId(){return e()}}):d_()})(),null),o})()}hn(["click"]);const m_=document.getElementById("root");$u(()=>ye(f_,{}),m_);
