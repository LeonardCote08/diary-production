const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-BqEPM1GP.js","assets/main-HQhcGBq1.css","assets/TemporalEchoController-BQiadO8m.js"])))=>i.map(i=>d[i]);
var mt=Object.defineProperty;var gt=(h,t,e)=>t in h?mt(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var W=(h,t,e)=>gt(h,typeof t!="symbol"?t+"":t,e);import{O as k,_ as lt,i as q,d as ut}from"./main-BqEPM1GP.js";import{c as pt,o as nt,p as O,a as ft}from"./viewerSetup-DtIrN93t.js";class vt{constructor(t={}){this.audioEngine=t.audioEngine||window.audioEngine,this.onPhaseChange=t.onPhaseChange||(()=>{}),this.modeStateManager=t.modeStateManager,this.thresholds={explore:300,preview:500,activate:800},this.state={isHolding:!1,holdStartTime:0,holdTimer:null,currentPhase:null,targetHotspot:null,feedbackGiven:new Set},this.currentPointerX=null,this.currentPointerY=null,this.progressElement=null,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window}startHold(t,e,i){t&&(this.modeStateManager&&(this.modeStateManager.modeStates.temporal.active||this.modeStateManager.modeStates.temporal.phase)&&(console.warn("[TEMPORAL_DEBUG] Cleaning stale temporal state before startHold"),this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null),this.state.isHolding=!0,this.state.holdStartTime=Date.now(),this.state.targetHotspot=t,this.state.feedbackGiven.clear(),this.state.currentPhase=null,this.onPhaseChange&&this.onPhaseChange("initial",t),this.isMobile&&this.createTouchRipple(e,i),this.state.holdTimer&&clearTimeout(this.state.holdTimer),this.scheduleFeedback(),this.showProgressIndicator(e,i),this.currentPointerX=e,this.currentPointerY=i,this.animateProgress())}endHold(){const t=this.state.isHolding?Date.now()-this.state.holdStartTime:0,e=this.state.targetHotspot,i=this.state.currentPhase;return this.state.holdTimer&&(clearTimeout(this.state.holdTimer),this.state.holdTimer=null),this.hideProgressIndicator(),this.state.isHolding=!1,this.state.holdStartTime=0,this.state.currentPhase=null,this.state.targetHotspot=null,this.state.feedbackGiven.clear(),this.cleanupTemporalVisuals(),this.modeStateManager&&this.modeStateManager.setTemporalState(!1,null),{duration:t,hotspot:e,finalPhase:i}}cleanupTemporalVisuals(){console.log("[TemporalModeHandler] Cleaning up temporal visuals");const t=["hotspot-temporal-touchDown","hotspot-temporal-explore","hotspot-temporal-preview","hotspot-temporal-activate"];document.querySelectorAll("[data-hotspot-id]").forEach(e=>{t.forEach(i=>{e.classList.remove(i)}),e.style.removeProperty("opacity"),e.style.removeProperty("visibility"),e.style.removeProperty("transition")}),this.modeStateManager&&this.modeStateManager.setTemporalState(!1,null)}scheduleFeedback(){this.giveFeedback("touchDown"),this.state.holdTimer=setTimeout(()=>{this.state.isHolding&&(this.state.currentPhase="explore",this.giveFeedback("explore"),this.state.holdTimer=setTimeout(()=>{this.state.isHolding&&(this.state.currentPhase="preview",this.giveFeedback("preview"),this.state.holdTimer=setTimeout(()=>{this.state.isHolding&&(this.state.currentPhase="activate",this.giveFeedback("activate"))},this.thresholds.activate-this.thresholds.preview))},this.thresholds.preview-this.thresholds.explore))},this.thresholds.explore)}giveFeedback(t){if(!this.state.isHolding){console.log("[TEMPORAL_DEBUG] Ignoring feedback - not holding");return}this.state.feedbackGiven.has(t)||(this.state.feedbackGiven.add(t),t==="touchDown"&&this.isMobile&&this.playHaptic("touchDown"),this.onPhaseChange(t,this.state.targetHotspot),this.playAudio(t),this.playHaptic(t))}playAudio(t){if(!this.audioEngine)return;const e=this.calculateHotspotSize(this.state.targetHotspot);switch(t){case"touchDown":this.audioEngine.playTemporalSound("touch",2e3,20);break;case"explore":this.audioEngine.playTemporalTick(e);break;case"preview":this.audioEngine.playTemporalBoop();break;case"activate":this.audioEngine.playTemporalThunk(e);break}}playHaptic(t){if(!navigator.vibrate||!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent))return;const e={touchDown:[20,10,20],explore:20,preview:[30,10,30],activate:100};if(e[t])try{navigator.vibrate(e[t])}catch{}}calculateHotspotSize(t){if(!t||!t.coordinates)return .5;let e=1/0,i=-1/0,s=1/0,o=-1/0;(t.shape==="multipolygon"?t.coordinates[0]:t.coordinates).forEach(([l,r])=>{e=Math.min(e,l),i=Math.max(i,l),s=Math.min(s,r),o=Math.max(o,r)});const n=(i-e)*(o-s);return Math.min(1,Math.max(0,n/1e4))}createProgressIndicator(){this.progressElement||(this.progressElement=document.createElement("div"),this.progressElement.className="temporal-progress-indicator",this.progressElement.innerHTML=`
            <svg width="64" height="64" style="position: absolute; top: -2px; left: -2px; transform: rotate(-90deg);">
                <circle cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="4"/>
                <circle cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="4"
                        stroke-dasharray="188.5" stroke-dashoffset="188.5" class="progress-ring"/>
            </svg>
        `,document.body.appendChild(this.progressElement))}createTouchRipple(t,e){const i=document.createElement("div");i.className="temporal-touch-ripple",i.style.left=t-20+"px",i.style.top=e-20+"px",document.body.appendChild(i),setTimeout(()=>{i.remove()},600)}showProgressIndicator(t,e){this.progressElement||this.createProgressIndicator(),this.progressElement.style.display="block",this.progressElement.style.left=t+"px",this.progressElement.style.top=e+"px"}hideProgressIndicator(){this.progressElement&&(this.progressElement.style.display="none")}updateProgress(t,e,i){this.progressElement&&(this.currentPointerX=t,this.currentPointerY=e,this.progressElement.style.left=t+"px",this.progressElement.style.top=e+"px")}animateProgress(){if(!this.state.isHolding){this.hideProgressIndicator();return}const t=Date.now()-this.state.holdStartTime,e=this.thresholds.activate+200,i=Math.min(1,t/e);if(this.progressElement){const s=this.progressElement.querySelector(".progress-ring");if(s){const o=188.5-188.5*i;s.style.strokeDashoffset=o}this.currentPointerX!==void 0&&this.currentPointerY!==void 0&&(this.progressElement.style.left=this.currentPointerX+"px",this.progressElement.style.top=this.currentPointerY+"px")}this.state.isHolding&&i<1?requestAnimationFrame(()=>this.animateProgress()):this.hideProgressIndicator()}getCurrentProgress(){if(!this.state.isHolding)return 0;const t=Date.now()-this.state.holdStartTime,e=this.thresholds.activate+200;return Math.min(1,t/e)}updateThreshold(t,e){this.thresholds[t]!==void 0&&(this.thresholds[t]=e)}reset(){this.endHold(),this.progressElement&&(this.progressElement.remove(),this.progressElement=null)}destroy(){this.reset()}}class yt{constructor(t={}){this.audioEngine=t.audioEngine||window.audioEngine,this.onStateChange=t.onStateChange||(()=>{}),this.onDiscovery=t.onDiscovery||(()=>{}),this.onActivation=t.onActivation||(()=>{}),this.thresholds={intentionDelay:100,navigation:150,discovery:400,activation:800,earlyVelocityCheck:150,distanceCheck:200},this.velocityThreshold=this.isMobile?5:15,this.frameTime=16.67,this.distanceThresholds={panDetection:this.isMobile?25:8,maxHoldDistance:this.isMobile?35:15},this.state={isHolding:!1,holdStartTime:0,currentPhase:null,targetHotspot:null,initialPosition:{x:0,y:0},lastPosition:{x:0,y:0},velocityHistory:[],feedbackGiven:new Set,timer:null,intentionTimer:null,temporalStarted:!1,earlyVelocityTimer:null,distanceTimer:null},this.hapticIntensities={discovery:.3,activation:1},this.lastFrameTime=0,this.velocityBufferSize=5,this.updateThrottle=this.isMobile?33:16,this.lastUpdateTime=0,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.update=this.update.bind(this),this.calculateVelocity=this.calculateVelocity.bind(this),this.schedulePhases=this.schedulePhases.bind(this),this.startEarlyVelocityMonitoring=this.startEarlyVelocityMonitoring.bind(this),this.startDistanceMonitoring=this.startDistanceMonitoring.bind(this),this.checkPanDetection=this.checkPanDetection.bind(this)}startHold(t,e,i){t&&(console.log("[TemporalHoldEngine] Starting hold detection with intention delay",{hotspotId:t.id,position:{x:e,y:i},intentionDelay:this.thresholds.intentionDelay,timestamp:Date.now()}),this.reset(),this.state.isHolding=!0,this.state.holdStartTime=performance.now(),this.state.targetHotspot=t,this.state.initialPosition={x:e,y:i},this.state.lastPosition={x:e,y:i},this.state.velocityHistory=[],this.state.feedbackGiven.clear(),this.state.currentPhase="intention_delay",this.state.temporalStarted=!1,this.lastFrameTime=performance.now(),this.update(),this.state.intentionTimer=setTimeout(()=>{this.state.isHolding&&(console.log("[TemporalHoldEngine] Intention delay passed - starting temporal detection"),this.state.temporalStarted=!0,this.state.currentPhase="initiated",this.startEarlyVelocityMonitoring(),this.startDistanceMonitoring(),this.schedulePhases(),this.onStateChange("initiated",t,{duration:this.getHoldDuration(),velocity:this.getAverageVelocity(),phase:"initiated"}))},this.thresholds.intentionDelay),this.onStateChange("intention_delay",t,{duration:0,velocity:0,phase:"intention_delay"}))}updatePosition(t,e){if(!this.state.isHolding)return;const i=performance.now();if(this.isMobile&&i-this.lastUpdateTime<this.updateThrottle)return;this.lastUpdateTime=i;const s=i-this.lastFrameTime;if(s>0){const o=this.calculateVelocity(t,e,s);if(this.state.velocityHistory.push(o),this.state.velocityHistory.length>this.velocityBufferSize&&this.state.velocityHistory.shift(),this.checkPanDetection(t,e)){console.log("[TemporalHoldEngine] Pan movement detected, ending hold"),this.endHold("pan_detected");return}if(this.state.temporalStarted){const a=this.getAverageVelocity();if(a>this.velocityThreshold){console.log("[TemporalHoldEngine] Fast movement detected, ending hold",{velocity:a,threshold:this.velocityThreshold}),this.endHold("navigation_detected");return}}this.state.lastPosition={x:t,y:e},this.lastFrameTime=i}}calculateVelocity(t,e,i){const s=t-this.state.lastPosition.x,o=e-this.state.lastPosition.y;return Math.sqrt(s*s+o*o)/i*this.frameTime}getAverageVelocity(){return this.state.velocityHistory.length===0?0:this.state.velocityHistory.reduce((e,i)=>e+i,0)/this.state.velocityHistory.length}startEarlyVelocityMonitoring(){this.state.earlyVelocityTimer=setTimeout(()=>{this.state.isHolding&&console.log("[TemporalHoldEngine] Early velocity monitoring period ended")},this.thresholds.earlyVelocityCheck)}startDistanceMonitoring(){this.state.distanceTimer=setTimeout(()=>{this.state.isHolding&&console.log("[TemporalHoldEngine] Distance monitoring period ended")},this.thresholds.distanceCheck)}checkPanDetection(t,e){if(!this.state.isHolding)return!1;const i=Math.sqrt(Math.pow(t-this.state.initialPosition.x,2)+Math.pow(e-this.state.initialPosition.y,2)),s=this.getHoldDuration();return s<this.thresholds.intentionDelay+this.thresholds.distanceCheck&&i>this.distanceThresholds.panDetection?(console.log("[TemporalHoldEngine] Pan detected - distance exceeded",{distance:i,threshold:this.distanceThresholds.panDetection,elapsed:s}),!0):this.state.temporalStarted&&i>this.distanceThresholds.maxHoldDistance?(console.log("[TemporalHoldEngine] Hold drift exceeded",{distance:i,threshold:this.distanceThresholds.maxHoldDistance}),!0):!1}schedulePhases(){if(!this.state.temporalStarted){console.log("[TemporalHoldEngine] Cannot schedule phases - temporal detection not started");return}this.state.timer&&clearTimeout(this.state.timer);const t=this.thresholds.discovery-this.thresholds.intentionDelay;this.state.timer=setTimeout(()=>{if(!this.state.isHolding||!this.state.temporalStarted)return;this.enterDiscoveryPhase();const e=this.thresholds.activation-this.thresholds.discovery;this.state.timer=setTimeout(()=>{!this.state.isHolding||!this.state.temporalStarted||this.enterActivationPhase()},e)},t)}enterDiscoveryPhase(){!this.state.isHolding||this.state.feedbackGiven.has("discovery")||(console.log("[TemporalHoldEngine] Entering discovery phase"),this.state.currentPhase="discovery",this.state.feedbackGiven.add("discovery"),this.playHaptic("discovery",this.hapticIntensities.discovery),this.playDiscoveryAudio(),this.onDiscovery(this.state.targetHotspot,{duration:this.getHoldDuration(),phase:"discovery",intensity:this.hapticIntensities.discovery}),this.onStateChange("discovery",this.state.targetHotspot,{duration:this.getHoldDuration(),velocity:this.getAverageVelocity(),phase:"discovery"}))}enterActivationPhase(){!this.state.isHolding||this.state.feedbackGiven.has("activation")||(console.log("[TemporalHoldEngine] Entering activation phase"),this.state.currentPhase="activation",this.state.feedbackGiven.add("activation"),this.playHaptic("activation",this.hapticIntensities.activation),this.playActivationAudio(),this.onActivation(this.state.targetHotspot,{duration:this.getHoldDuration(),phase:"activation",finalPosition:this.state.lastPosition}),this.onStateChange("activation",this.state.targetHotspot,{duration:this.getHoldDuration(),velocity:this.getAverageVelocity(),phase:"activation"}),this.endHold("activated"))}endHold(t="released"){if(!this.state.isHolding)return null;const e=this.getHoldDuration(),i=this.state.currentPhase,s=this.state.targetHotspot;return console.log("[TemporalHoldEngine] Ending hold",{reason:t,duration:e,finalPhase:i,hotspotId:s==null?void 0:s.id}),this.state.timer&&(clearTimeout(this.state.timer),this.state.timer=null),this.reset(),this.onStateChange("ended",s,{duration:e,reason:t,finalPhase:i}),{duration:e,hotspot:s,finalPhase:i,reason:t}}update(){this.state.isHolding&&requestAnimationFrame(this.update)}getHoldDuration(){return this.state.isHolding?performance.now()-this.state.holdStartTime:0}playHaptic(t,e){if(!(!this.isMobile||!navigator.vibrate))try{const i={discovery:[Math.round(30*e),10,Math.round(20*e)],activation:[Math.round(100*e)]};i[t]&&navigator.vibrate(i[t])}catch(i){console.debug("[TemporalHoldEngine] Haptic feedback not available:",i.message)}}playDiscoveryAudio(){if(this.audioEngine)try{this.audioEngine.playTemporalSound("discovery",1e3,15)}catch(t){console.debug("[TemporalHoldEngine] Discovery audio not available:",t.message)}}playActivationAudio(){if(this.audioEngine)try{const t=this.calculateHotspotSize(this.state.targetHotspot);this.audioEngine.playTemporalThunk(t)}catch(t){console.debug("[TemporalHoldEngine] Activation audio not available:",t.message)}}calculateHotspotSize(t){if(!t||!t.coordinates)return .5;let e=1/0,i=-1/0,s=1/0,o=-1/0;(t.shape==="multipolygon"?t.coordinates[0]:t.coordinates).forEach(([l,r])=>{e=Math.min(e,l),i=Math.max(i,l),s=Math.min(s,r),o=Math.max(o,r)});const n=(i-e)*(o-s);return Math.min(1,Math.max(0,n/1e4))}isHolding(){return this.state.isHolding}getCurrentPhase(){return{phase:this.state.currentPhase,duration:this.getHoldDuration(),velocity:this.getAverageVelocity(),hotspot:this.state.targetHotspot}}updateThreshold(t,e){this.thresholds.hasOwnProperty(t)&&(this.thresholds[t]=e,console.log(`[TemporalHoldEngine] Updated ${t} threshold to ${e}ms`))}reset(){this.state.timer&&(clearTimeout(this.state.timer),this.state.timer=null),this.state.intentionTimer&&(clearTimeout(this.state.intentionTimer),this.state.intentionTimer=null),this.state.earlyVelocityTimer&&(clearTimeout(this.state.earlyVelocityTimer),this.state.earlyVelocityTimer=null),this.state.distanceTimer&&(clearTimeout(this.state.distanceTimer),this.state.distanceTimer=null),this.state={isHolding:!1,holdStartTime:0,currentPhase:null,targetHotspot:null,initialPosition:{x:0,y:0},lastPosition:{x:0,y:0},velocityHistory:[],feedbackGiven:new Set,timer:null,intentionTimer:null,temporalStarted:!1,earlyVelocityTimer:null,distanceTimer:null}}destroy(){this.reset(),this.onStateChange=null,this.onDiscovery=null,this.onActivation=null,this.audioEngine=null}}class wt{constructor(){this.modes={direct:{name:"Direct (Classic)",description:"Tap to select and zoom immediately",mobile:!0,desktop:!0},temporal:{name:"Temporal (Hold)",description:"Hold duration determines action",mobile:!0,desktop:!0}};const t=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window;this.currentMode=localStorage.getItem("interactionMode")||(t?"temporal":"direct"),this.modeStates={temporal:{active:!1,phase:null},reveal:{active:!1,timer:null,style:localStorage.getItem("revealStyle")||"invert"}},this.listeners={modeChange:[],stateChange:[]}}getCurrentMode(){return this.currentMode}setMode(t){if(!this.modes[t])return!1;const e=this.currentMode;return this.currentMode=t,localStorage.setItem("interactionMode",t),this.notifyListeners("modeChange",{from:e,to:t}),!0}getModeConfig(t=this.currentMode){return this.modes[t]}setTemporalState(t,e=null){const i=this.modeStates.temporal.active;this.modeStates.temporal.active=t,this.modeStates.temporal.phase=e,console.log("[ModeStateManager] Temporal state changed:",{from:{active:i,phase:this.modeStates.temporal.phase},to:{active:t,phase:e},timestamp:Date.now()}),this.notifyListeners("stateChange",{mode:"temporal",state:this.modeStates.temporal})}isTemporalActive(){return this.currentMode==="temporal"&&this.modeStates.temporal.active}setRevealActive(t){this.modeStates.reveal.active=t,!t&&this.modeStates.reveal.timer&&(clearTimeout(this.modeStates.reveal.timer),this.modeStates.reveal.timer=null),this.notifyListeners("stateChange",{mode:"reveal",state:this.modeStates.reveal})}isRevealActive(){return this.modeStates.reveal.active}setRevealTimer(t){this.modeStates.reveal.timer=t}setRevealStyle(t){this.modeStates.reveal.style=t,localStorage.setItem("revealStyle",t)}getRevealStyle(){return this.modeStates.reveal.style}shouldBlockNormalInteractions(){return this.isTemporalActive()||this.isRevealActive()}on(t,e){this.listeners[t]&&this.listeners[t].push(e)}off(t,e){if(this.listeners[t]){const i=this.listeners[t].indexOf(e);i>-1&&this.listeners[t].splice(i,1)}}notifyListeners(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}reset(){this.modeStates.temporal.active=!1,this.modeStates.temporal.phase=null,this.setRevealActive(!1)}forceTemporalCleanup(){console.log("[ModeStateManager] Force temporal cleanup"),this.modeStates.temporal.active=!1,this.modeStates.temporal.phase=null,this.notifyListeners("stateChange",{mode:"temporal",state:this.modeStates.temporal})}}class bt{constructor(t={}){this.viewer=t.viewer,this.spatialIndex=t.spatialIndex,this.debug=t.debug||!1,this.hitCanvas=null,this.hitContext=null,this.debugCanvas=null,this.colorToHotspot=new Map,this.hotspotToColor=new Map,this.nextColorIndex=1,this.stats={totalHotspots:0,renderedHotspots:0,lastRenderTime:0,hitTestCount:0,cacheHits:0},this.isInitialized=!1,this.needsRedraw=!0,this.currentViewport=null,this.hitCache=new Map,this.hitCacheSize=50,this.lastCacheClear=Date.now(),this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),console.log("[HIT_DETECTION] Initializing for platform:",{isMobile:this.isMobile,isSafari:this.isSafari,debug:this.debug})}async initialize(){if(this.isInitialized){console.warn("[HIT_DETECTION] Already initialized");return}if(!this.viewer||!this.spatialIndex)throw new Error("HitDetectionCanvas requires viewer and spatialIndex");const t=performance.now();try{await this.waitForViewer(),this.createCanvasElements(),this.generateColorMapping(),this.setupEventHandlers(),this.scheduleRedraw(),this.isInitialized=!0;const e=performance.now()-t;console.log(`[HIT_DETECTION] Initialized in ${e.toFixed(2)}ms`,{totalHotspots:this.stats.totalHotspots,canvasSize:`${this.hitCanvas.width}x${this.hitCanvas.height}`,isMobile:this.isMobile})}catch(e){throw console.error("[HIT_DETECTION] Initialization failed:",e),e}}waitForViewer(){return new Promise(t=>{this.viewer.isOpen()&&this.viewer.world.getItemCount()>0?t():this.viewer.addOnceHandler("open",()=>{setTimeout(t,100)})})}createCanvasElements(){const e=this.viewer.world.getItemAt(0).getContentSize();let i,s;if(this.isMobile){const a=e.x/e.y;e.x>e.y?(i=Math.min(1024,e.x),s=Math.floor(i/a),s>512&&(s=512,i=Math.floor(s*a))):(s=Math.min(1024,e.y),i=Math.floor(s*a),i>512&&(i=512,s=Math.floor(i/a))),console.log(`[MOBILE_OPTIMIZATION] Canvas reduced for performance: ${i}x${s}`)}else i=Math.min(4096,e.x),s=Math.min(4096,e.y);this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=i,this.hitCanvas.height=s,this.hitCanvas.style.position="absolute",this.hitCanvas.style.top="0",this.hitCanvas.style.left="0",this.hitCanvas.style.width="100%",this.hitCanvas.style.height="100%",this.hitCanvas.style.pointerEvents="none",this.hitCanvas.style.visibility="hidden",this.hitCanvas.style.zIndex="-1000",this.hitContext=this.hitCanvas.getContext("2d",{alpha:!1,willReadFrequently:!0}),this.hitContext.imageSmoothingEnabled=!1,this.hitContext.webkitImageSmoothingEnabled=!1,this.hitContext.mozImageSmoothingEnabled=!1,this.hitContext.msImageSmoothingEnabled=!1,this.debug&&(this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=i,this.debugCanvas.height=s,this.debugCanvas.style.position="absolute",this.debugCanvas.style.top="0",this.debugCanvas.style.left="0",this.debugCanvas.style.width="100%",this.debugCanvas.style.height="100%",this.debugCanvas.style.pointerEvents="none",this.debugCanvas.style.opacity="0.3",this.debugCanvas.style.zIndex="1000",this.debugCanvas.style.mixBlendMode="multiply",this.debugContext=this.debugCanvas.getContext("2d")),this.viewer.addOverlay({element:this.hitCanvas,location:new k.Rect(0,0,1,e.y/e.x),placement:k.Placement.TOP_LEFT}),this.debug&&this.debugCanvas&&this.viewer.addOverlay({element:this.debugCanvas,location:new k.Rect(0,0,1,e.y/e.x),placement:k.Placement.TOP_LEFT}),console.log(`[HIT_DETECTION] Canvas created: ${i}x${s}`,{originalSize:`${e.x}x${e.y}`,mobile:this.isMobile,debug:this.debug})}generateColorMapping(){const t=this.spatialIndex.getAllHotspots(),e=performance.now();this.colorToHotspot.clear(),this.hotspotToColor.clear(),this.nextColorIndex=1;const i=this.indexToColor(0);this.colorToHotspot.set(i,null),t.forEach((a,n)=>{const l=this.nextColorIndex++,r=this.indexToColor(l);this.colorToHotspot.set(r,a),this.hotspotToColor.set(a.id,r),this.debug&&n<10&&console.log(`[HIT_DETECTION] Hotspot ${a.id} → ${r} (index: ${l})`)}),this.stats.totalHotspots=t.length;const s=performance.now()-e;console.log(`[HIT_DETECTION] Generated ${t.length} unique colors in ${s.toFixed(2)}ms`);const o=new Set(this.hotspotToColor.values()).size;o!==t.length&&console.error(`[HIT_DETECTION] Color collision detected! Expected ${t.length}, got ${o}`)}indexToColor(t){const e=(t&16711680)>>16,i=(t&65280)>>8,s=t&255;return`rgb(${e},${i},${s})`}colorToIndex(t,e,i){return t<<16|e<<8|i}setupEventHandlers(){this.viewer.addHandler("animation-finish",()=>{this.scheduleRedraw()});let t=null;this.viewer.addHandler("viewport-change",()=>{t&&clearTimeout(t),t=setTimeout(()=>{this.scheduleRedraw()},this.isMobile?100:50)}),setInterval(()=>{this.clearHitCache()},5e3)}scheduleRedraw(){this.needsRedraw||(this.needsRedraw=!0,requestAnimationFrame(()=>{this.needsRedraw&&this.renderHitCanvas()}))}renderHitCanvas(){if(!this.isInitialized||!this.hitContext)return;const t=performance.now();this.hitContext.fillStyle=this.indexToColor(0),this.hitContext.fillRect(0,0,this.hitCanvas.width,this.hitCanvas.height);const e=this.viewer.viewport.getBounds(),i=this.spatialIndex.queryViewport({minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height}),o=this.viewer.world.getItemAt(0).getContentSize(),a=this.hitCanvas.width/o.x,n=this.hitCanvas.height/o.y;let l=0;i.forEach(r=>{const c=this.hotspotToColor.get(r.id);c&&(this.hitContext.fillStyle=c,this.renderHotspotToCanvas(r,a,n),l++)}),this.debug&&this.debugContext&&this.renderDebugCanvas(i,a,n),this.stats.renderedHotspots=l,this.stats.lastRenderTime=performance.now()-t,this.needsRedraw=!1,console.log(`[HIT_DETECTION] Rendered ${l} hotspots in ${this.stats.lastRenderTime.toFixed(2)}ms`)}renderHotspotToCanvas(t,e,i){t.shape==="polygon"?this.renderPolygon(t.coordinates,e,i):t.shape==="multipolygon"&&t.coordinates.forEach(s=>{this.renderPolygon(s,e,i)})}renderPolygon(t,e,i){t.length!==0&&(this.hitContext.beginPath(),t.forEach((s,o)=>{const a=s[0]*e,n=s[1]*i;o===0?this.hitContext.moveTo(a,n):this.hitContext.lineTo(a,n)}),this.hitContext.closePath(),this.hitContext.fill())}renderDebugCanvas(t,e,i){this.debugContext.clearRect(0,0,this.debugCanvas.width,this.debugCanvas.height),t.forEach((s,o)=>{const a=o*137.508%360;this.debugContext.fillStyle=`hsla(${a}, 70%, 50%, 0.6)`,this.renderHotspotToCanvas(s,e,i)})}hitTest(t,e){if(!this.isInitialized||!this.hitContext)return console.warn("[HIT_DETECTION] Hit test called before initialization"),null;this.stats.hitTestCount++;const i=`${t},${e}`;if(this.hitCache.has(i))return this.stats.cacheHits++,this.hitCache.get(i);try{const s=this.hitCanvas.getBoundingClientRect(),o=(t-s.left)/s.width*this.hitCanvas.width,a=(e-s.top)/s.height*this.hitCanvas.height,n=Math.max(0,Math.min(this.hitCanvas.width-1,Math.floor(o))),l=Math.max(0,Math.min(this.hitCanvas.height-1,Math.floor(a))),r=this.hitContext.getImageData(n,l,1,1),[c,d,m]=r.data,g=`rgb(${c},${d},${m})`,y=this.colorToHotspot.get(g);return this.hitCache.size<this.hitCacheSize&&this.hitCache.set(i,y||null),this.debug&&y&&console.log(`[HIT_DETECTION] Hit test: (${t},${e}) → ${y.id}`,{canvasCoords:[n,l],color:g,pixel:[c,d,m]}),y||null}catch(s){return console.error("[HIT_DETECTION] Hit test error:",s),null}}clearHitCache(){Date.now()-this.lastCacheClear>5e3&&(this.hitCache.clear(),this.lastCacheClear=Date.now())}getStats(){return{...this.stats,cacheSize:this.hitCache.size,cacheHitRatio:this.stats.cacheHits/Math.max(1,this.stats.hitTestCount),isInitialized:this.isInitialized,canvasSize:this.hitCanvas?`${this.hitCanvas.width}x${this.hitCanvas.height}`:"Not created"}}setDebugMode(t){this.debug=t,this.debugCanvas&&(this.debugCanvas.style.display=t?"block":"none"),t&&this.scheduleRedraw(),console.log(`[HIT_DETECTION] Debug mode: ${t?"ON":"OFF"}`)}forceRedraw(){this.needsRedraw=!0,this.renderHitCanvas()}destroy(){this.hitCanvas&&this.viewer.removeOverlay(this.hitCanvas),this.debugCanvas&&this.viewer.removeOverlay(this.debugCanvas),this.colorToHotspot.clear(),this.hotspotToColor.clear(),this.hitCache.clear(),this.isInitialized=!1,console.log("[HIT_DETECTION] Destroyed")}}class St{constructor(t={}){const e=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window;this.config={maxVisibleHotspots:e?{low:0,medium:5,high:10,critical:15}:{low:50,medium:100,high:150,critical:200},zoomThresholds:{low:2,medium:5,high:10},clustering:{enabled:!0,minDistance:50,maxClusterSize:8,zoomThreshold:3},scoring:{typeWeights:{audio_only:1,audio_image:.9,image_only:.7,link_only:.5,mixed:.8},sizeWeight:.3,distanceWeight:.4,interactionWeight:.3,selectedBonus:2,hoveredBonus:1.5},performance:{adaptiveThresholds:!0,fpsThreshold:e?35:45,memoryThreshold:e?150:200,emergencyReduction:.5}},this.lastZoom=0,this.lastViewportCenter=null,this.interactionHistory=new Map,this.clusterCache=new Map,this.lastVisibleSet=new Set,this.performanceMode="normal",this.boundsCache=new Map,this.centerCache=new Map,this.stats={totalHotspots:0,visibleHotspots:0,clusteredHotspots:0,lastUpdateTime:0,averageScore:0},this.isMobile=e}selectVisibleHotspots(t,e,i,s,o){const a=performance.now(),l=e.getBounds().getCenter(),r=this.getLODLevel(i),c=this.getMaxVisibleCount(r,i),d=this.filterViewportCandidates(t,e),m=this.applySpatialClustering(d,i,e),g=this.scoreHotspots(m,l,s,o),y=this.selectTopHotspots(g,c,s,o);return this.updateStats(d.length,y.length,a),d.length>c&&(y.length<d.length*.3||this.stats.lastUpdateTime>20)&&console.log(`[LOD] Reduced ${d.length} → ${y.length} hotspots (zoom: ${i.toFixed(2)})`),y}getLODLevel(t){return t<this.config.zoomThresholds.low?"low":t<this.config.zoomThresholds.medium?"medium":t<this.config.zoomThresholds.high?"high":"critical"}getMaxVisibleCount(t,e){let i=this.config.maxVisibleHotspots[t];if(this.performanceMode==="reduced"?i=Math.floor(i*.75):this.performanceMode==="emergency"&&(i=Math.floor(i*this.config.performance.emergencyReduction)),t==="medium"){const o=Math.min(1,(e-this.config.zoomThresholds.low)/(this.config.zoomThresholds.medium-this.config.zoomThresholds.low));i=Math.floor(this.config.maxVisibleHotspots.low+(this.config.maxVisibleHotspots.medium-this.config.maxVisibleHotspots.low)*o)}const s=this.isMobile?15:25;return Math.max(s,i)}filterViewportCandidates(t,e){const i=e.getBounds(),s=e.viewportToImageCoordinates(i.getTopLeft()),o=e.viewportToImageCoordinates(i.getBottomRight()),a={minX:s.x,minY:s.y,maxX:o.x,maxY:o.y},n=e.getZoom(),l=n<2?.3:n<5?.2:.1,r=(a.maxX-a.minX)*l;return a.minX-=r,a.minY-=r,a.maxX+=r,a.maxY+=r,t.filter(c=>{const d=c.overlay;if(!d||!d.bounds){const m=this.calculateHotspotBounds(c);return!(m.maxX<a.minX||m.minX>a.maxX||m.maxY<a.minY||m.minY>a.maxY)}return!(d.bounds.maxX<a.minX||d.bounds.minX>a.maxX||d.bounds.maxY<a.minY||d.bounds.minY>a.maxY)})}applySpatialClustering(t,e,i){if(!this.config.clustering.enabled||e>this.config.clustering.zoomThreshold)return t;const s=`${e.toFixed(1)}_${t.length}`;if(this.clusterCache.has(s))return this.clusterCache.get(s);const o=[],a=new Set,n=this.config.clustering.minDistance/i.getZoom();for(const l of t){if(a.has(l.id))continue;const r=[l];a.add(l.id);for(const c of t)a.has(c.id)||r.length>=this.config.clustering.maxClusterSize||this.calculateDistance(l,c)<n&&(r.push(c),a.add(c.id));r.length>1?(r.sort((c,d)=>{const m=this.config.scoring.typeWeights[c.type]||.5;return(this.config.scoring.typeWeights[d.type]||.5)-m}),o.push(...r.slice(0,Math.min(2,r.length)))):o.push(l)}return this.clusterCache.size>10&&this.clusterCache.clear(),this.clusterCache.set(s,o),o}scoreHotspots(t,e,i,s){var c;const o=Date.now(),a=Math.max(e.x,e.y),n=i==null?void 0:i.id,l=s==null?void 0:s.id,r=[];for(let d=0;d<t.length;d++){const m=t[d];let g=0;g+=(this.config.scoring.typeWeights[m.type]||.5)*.3,(c=m.overlay)!=null&&c.area&&(g+=Math.min(1,m.overlay.area/1e4)*this.config.scoring.sizeWeight);const y=this.getHotspotCenter(m),v=e.x-y.x,u=e.y-y.y,w=Math.sqrt(v*v+u*u);g+=Math.max(0,1-w/a)*this.config.scoring.distanceWeight;const S=this.interactionHistory.get(m.id);S&&o-S<3e4&&(g+=Math.max(0,1-(o-S)/3e4)*this.config.scoring.interactionWeight),m.id===n?g*=this.config.scoring.selectedBonus:m.id===l&&(g*=this.config.scoring.hoveredBonus),r.push({hotspot:m,score:Math.min(5,g)})}return r}selectTopHotspots(t,e,i,s){const o=new Set;i&&o.add(i.id),s&&o.add(s.id),t.sort((l,r)=>r.score-l.score);const a=[],n=o.size;for(const l of t)if(o.has(l.hotspot.id)&&(a.push(l.hotspot),a.length>=n))break;e-a.length;for(const l of t){if(a.length>=e)break;o.has(l.hotspot.id)||a.push(l.hotspot)}return a}recordInteraction(t){if(this.interactionHistory.set(t,Date.now()),this.interactionHistory.size>50){const e=Date.now()-6e4;for(const[i,s]of this.interactionHistory.entries())s<e&&this.interactionHistory.delete(i)}}updatePerformanceMode(t,e){const i=this.performanceMode;t>0&&t<30?this.performanceMode="emergency":t>0&&t<this.config.performance.fpsThreshold?this.performanceMode="reduced":e>this.config.performance.memoryThreshold?this.performanceMode="reduced":this.performanceMode="normal",this.performanceMode}calculateDistance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}calculateHotspotBounds(t){const e=this.boundsCache.get(t.id);if(e)return e;const i=t.coordinates;if(!i||i.length===0)return{minX:0,minY:0,maxX:0,maxY:0};let s={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};const o=a=>{a.forEach(([n,l])=>{s.minX=Math.min(s.minX,n),s.minY=Math.min(s.minY,l),s.maxX=Math.max(s.maxX,n),s.maxY=Math.max(s.maxY,l)})};return Array.isArray(i[0])&&typeof i[0][0]=="number"?o(i):i.forEach(o),this.boundsCache.set(t.id,s),s}getHotspotCenter(t){const e=this.centerCache.get(t.id);if(e)return e;let i;if(t.overlay&&t.overlay.bounds){const s=t.overlay.bounds;i={x:(s.minX+s.maxX)/2,y:(s.minY+s.maxY)/2}}else{const s=t.coordinates;if(s&&s.length>0){let o=0,a=0,n=0;const l=r=>{for(const[c,d]of r)o+=c,a+=d,n++};typeof s[0][0]=="number"?l(s):s.forEach(l),i={x:o/n,y:a/n}}else i={x:0,y:0}}return this.centerCache.set(t.id,i),i}updateStats(t,e,i){this.stats.totalHotspots=t,this.stats.visibleHotspots=e,this.stats.lastUpdateTime=performance.now()-i;const s=t>0?((t-e)/t*100).toFixed(1):0;t>e&&this.stats.lastUpdateTime>20&&console.log(`[LOD] Slow processing: ${this.stats.lastUpdateTime.toFixed(2)}ms | Reduction: ${s}% | Mode: ${this.performanceMode}`)}getStats(){return{...this.stats,performanceMode:this.performanceMode,cacheSize:this.clusterCache.size,interactionHistorySize:this.interactionHistory.size}}reset(){this.clusterCache.clear(),this.interactionHistory.clear(),this.lastVisibleSet.clear(),this.boundsCache.clear(),this.centerCache.clear(),this.performanceMode="normal"}}function Tt(h,t){const e=t?h[0]:h;let i="";return e.forEach(([s,o],a)=>{a===0?i+=`M ${Math.round(s)} ${Math.round(o)} `:i+=`L ${Math.round(s)} ${Math.round(o)} `}),i+="Z",i}function ht(h){let t={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};const e=i=>{i.forEach(([s,o])=>{t.minX=Math.min(t.minX,s),t.minY=Math.min(t.minY,o),t.maxX=Math.max(t.maxX,s),t.maxY=Math.max(t.maxY,o)})};return Array.isArray(h[0])&&typeof h[0][0]=="number"?e(h):h.forEach(e),t}function Mt(h){return(h.maxX-h.minX)*(h.maxY-h.minY)}function rt(h,t,e){let i=!1;const s=e.length;let o=e[0][0],a=e[0][1];for(let n=1;n<=s;n++){const l=e[n%s][0],r=e[n%s][1];if(t>Math.min(a,r)&&t<=Math.max(a,r)&&h<=Math.max(o,l)&&a!==r){const c=(t-a)*(l-o)/(r-a)+o;(o===l||h<=c)&&(i=!i)}o=l,a=r}return i}class Ct{constructor({colorScheme:t,isMobile:e}){this.colorScheme=t,this.isMobile=e,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isWebKit="WebkitAppearance"in document.documentElement.style&&!window.chrome,this.isSafariOrWebKit=this.isSafari||this.isWebKit,this.config={hoverThrottleDelay:50,maxGlowLayers:3,iosClickDelay:300,gpuAccelerationHints:!0}}get isSafariEnvironment(){return this.isSafari||this.isWebKit}optimizeLayers(t){if(!this.isSafari)return;let e=1e-4;t.forEach(i=>{i.element.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(o=>{o.style.transform=`translateZ(${e}px)`,e+=1e-4})})}forceIOSRedraw(){if(!this.isMobile||!this.isSafariEnvironment)return;const t=document.body,e=t.style.transform;t.style.transform="translateZ(0)",t.offsetHeight,t.style.transform=e}createGlowLayers(t,e,i){if(!this.isSafari)return;if(t.querySelector(".glow-layer-1")){console.log("Glow layers already exist for this group, skipping creation");return}i.main;const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",e),s.setAttribute("fill","none"),s.setAttribute("stroke","rgba(255, 255, 255, 0.2)"),s.setAttribute("stroke-width","30"),s.setAttribute("opacity","0"),s.setAttribute("pathLength","100"),s.setAttribute("data-animated","true"),s.style.pointerEvents="none",s.style.filter="blur(4px)",s.classList.add("glow-layer-5"),t.appendChild(s);const o=document.createElementNS("http://www.w3.org/2000/svg","path");o.setAttribute("d",e),o.setAttribute("fill","none"),o.setAttribute("stroke","rgba(11, 18, 21, 0.4)"),o.setAttribute("stroke-width","25"),o.setAttribute("opacity","0"),o.setAttribute("pathLength","100"),o.setAttribute("data-animated","true"),o.style.pointerEvents="none",o.style.filter="blur(3px)",o.style.transform="translate(2px, 3px)",o.classList.add("glow-layer-4"),t.appendChild(o);const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",e),a.setAttribute("fill","none"),a.setAttribute("stroke","rgba(11, 18, 21, 0.5)"),a.setAttribute("stroke-width","15"),a.setAttribute("opacity","0"),a.setAttribute("pathLength","100"),a.setAttribute("data-animated","true"),a.style.pointerEvents="none",a.style.filter="blur(2px)",a.classList.add("glow-layer-3"),t.appendChild(a);const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",e),n.setAttribute("fill","none"),n.setAttribute("stroke","rgba(11, 18, 21, 0.7)"),n.setAttribute("stroke-width","8"),n.setAttribute("opacity","0"),n.setAttribute("pathLength","100"),n.setAttribute("data-animated","true"),n.style.pointerEvents="none",n.style.filter="blur(1px)",n.classList.add("glow-layer-2"),t.appendChild(n);const l=document.createElementNS("http://www.w3.org/2000/svg","path");return l.setAttribute("d",e),l.setAttribute("fill","none"),l.setAttribute("stroke","#000000"),l.setAttribute("stroke-width","4"),l.setAttribute("opacity","0"),l.setAttribute("pathLength","100"),l.setAttribute("data-animated","true"),l.style.pointerEvents="none",l.style.filter="contrast(1.5)",l.classList.add("glow-layer-1"),t.appendChild(l),{glowPath1:l,glowPath2:n,glowPath3:a,glowPath4:o,glowPath5:s}}setGlowLayerLengths(t,e){const i=t.querySelector(".glow-layer-1"),s=t.querySelector(".glow-layer-2"),o=t.querySelector(".glow-layer-3"),a=t.querySelector(".glow-layer-4"),n=t.querySelector(".glow-layer-5");[i,s,o,a,n].forEach(l=>{l&&(l.setAttribute("data-real-length",e),l.setAttribute("data-animated","true"))})}setupIOSClickHandler(t,e,i){!this.isMobile&&!this.isSafariOrWebKit||t.addEventListener("click",s=>{var l,r,c;if(s.target.tagName==="path"||s.target.tagName==="g"||s.target.closest("g[data-hotspot-id]"))return;const o=(l=window.nativeHotspotRenderer)==null?void 0:l.modeStateManager,a=(r=window.nativeHotspotRenderer)==null?void 0:r.echoController;if(o&&a&&o.getCurrentMode()==="direct"&&((c=a.config)!=null&&c.enabled)){console.log("iOS/Safari: Skipping click - echo mode active");return}const n=e(s);n&&(console.log("iOS/Safari: Found hotspot at SVG click position:",n.id),s.stopPropagation(),s.preventDefault(),i(n))},!0)}createHoverThrottle(){let t=null;return e=>{if(!this.isSafari){e();return}t||(t=setTimeout(()=>{t=null},this.config.hoverThrottleDelay),e())}}optimizePathsForGPU(t){if(!this.isSafari)return;const e=t.element.getElementsByTagName("path");for(let i of e)i.style.transform="translateZ(0)",i.style.webkitBackfaceVisibility="hidden"}stopSafariGlowAnimations(t){t.querySelectorAll("path").forEach(i=>{i.currentAnimation&&(i.currentAnimation.cancel(),i.currentAnimation=null),i.getAnimations&&i.getAnimations().forEach(s=>s.cancel()),i.style.strokeDasharray="0 100",i.style.opacity="0"})}animateSafariGlowLayers(t,e,i,s,o){const a=t.querySelector(".glow-layer-1"),n=t.querySelector(".glow-layer-2"),l=t.querySelector(".glow-layer-3"),r=t.querySelector(".glow-layer-4"),c=t.querySelector(".main-path"),d=t.getAttribute("data-hotspot-id"),g=Math.random()*100;console.log(`[Safari Random Start] Rotating dash animation for ${d}: offset ${g.toFixed(1)}% of path`);const y=s.main==="#000000";[{element:c,delay:0,opacity:"1"},{element:a,delay:0,opacity:e==="selected"?y?"0.9":"1":y?"0.85":"0.95"},{element:n,delay:0,opacity:e==="selected"?y?"0.8":"0.9":y?"0.7":"0.85"},{element:l,delay:0,opacity:e==="selected"?y?"0.6":"0.8":y?"0.5":"0.7"},{element:r,delay:0,opacity:e==="selected"?"0.35":"0.3"}].forEach(({element:u,delay:w,opacity:S})=>{if(u&&u.animate){u.style.removeProperty("opacity"),Object.assign(u.style,{strokeDasharray:"0 100",strokeDashoffset:`-${g}`,opacity:"0",visibility:"visible",transition:"none",animation:"none",paintOrder:"stroke",transform:`translateZ(${w*.001}px)`,willChange:"stroke-dasharray, stroke-dashoffset, opacity"});const f=u.animate([{strokeDasharray:"0 100",strokeDashoffset:`-${g}`,opacity:"0",offset:0},{strokeDasharray:"10 90",strokeDashoffset:`-${g}`,opacity:"0.1",offset:.1},{strokeDasharray:"50 50",strokeDashoffset:`-${g}`,opacity:"0.3",offset:.5},{strokeDasharray:"95 5",strokeDashoffset:`-${g}`,opacity:S,offset:.95},{strokeDasharray:"100 0",strokeDashoffset:`-${g}`,opacity:S,offset:1}],{duration:i*1e3,delay:w,easing:o,fill:"forwards"});u.currentAnimation&&(u.currentAnimation.cancel(),u.currentAnimation=null),u.currentAnimation=f,f.finished.then(()=>{t.setAttribute("data-animation-completed","true"),t.setAttribute("data-animation-active","false")}).catch(()=>{}),e==="selected"?(w===150&&(u.style.filter="blur(1px)"),w===100&&(u.style.filter="blur(2px)"),w===50&&(u.style.filter="blur(3px)")):(w===150&&(u.style.filter="none"),w===100&&(u.style.filter="blur(1px)"),w===50&&(u.style.filter="blur(2px)"))}})}resetSafariGlowLayers(t){const e=t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3, .glow-layer-4"),i=t.querySelector(".main-path");(i?[i,...e]:[...e]).forEach(o=>{var a,n;(n=(a=o.getAnimations)==null?void 0:a.call(o))==null||n.forEach(l=>l.cancel()),o.currentAnimation&&(o.currentAnimation.cancel(),o.currentAnimation=null),o.style.animation="none",o.offsetWidth,Object.assign(o.style,{strokeDasharray:"none",strokeDashoffset:"0",transition:"opacity 0.2s ease-out",filter:"none",visibility:"visible"}),o.style.setProperty("opacity","0","important")})}}class At{constructor(){this.overlays=new Map,this.visibleOverlays=new Set,this.hoveredHotspot=null,this.selectedHotspot=null,this.selectionTimestamp=null,this.hotspotAreas=new Map,this.callbacks={onHoverChange:null,onSelectionChange:null,onVisibilityChange:null}}setCallbacks({onHoverChange:t,onSelectionChange:e,onVisibilityChange:i}){t&&(this.callbacks.onHoverChange=t),e&&(this.callbacks.onSelectionChange=e),i&&(this.callbacks.onVisibilityChange=i)}addOverlay(t,e){this.overlays.set(t,e),e.area!==void 0&&this.hotspotAreas.set(t,e.area)}getOverlay(t){return this.overlays.get(t)}getAllOverlays(){return this.overlays}removeOverlay(t){var e,i;this.overlays.delete(t),this.hotspotAreas.delete(t),this.visibleOverlays.delete(t),((e=this.hoveredHotspot)==null?void 0:e.id)===t&&this.setHoveredHotspot(null),((i=this.selectedHotspot)==null?void 0:i.id)===t&&this.setSelectedHotspot(null)}setOverlayVisibility(t,e){const i=this.overlays.get(t);i&&(i.isVisible=e,e?this.visibleOverlays.add(t):this.visibleOverlays.delete(t),this.callbacks.onVisibilityChange&&this.callbacks.onVisibilityChange(t,e))}batchUpdateVisibility(t){t.forEach(({id:e,isVisible:i})=>{const s=this.overlays.get(e);s&&(s.isVisible=i,i?this.visibleOverlays.add(e):this.visibleOverlays.delete(e))}),this.callbacks.onVisibilityChange&&this.callbacks.onVisibilityChange(null,null,t)}getVisibleCount(){return this.visibleOverlays.size}isOverlayVisible(t){const e=this.overlays.get(t);return e?e.isVisible:!1}setHoveredHotspot(t){const e=this.hoveredHotspot;this.hoveredHotspot=t,this.callbacks.onHoverChange&&this.callbacks.onHoverChange(t,e)}setSelectedHotspot(t){const e=this.selectedHotspot;this.selectedHotspot=t,this.selectionTimestamp=t?Date.now():null,this.callbacks.onSelectionChange&&this.callbacks.onSelectionChange(t,e)}getHoveredHotspot(){return this.hoveredHotspot}getSelectedHotspot(){return this.selectedHotspot}getHotspotArea(t){return this.hotspotAreas.get(t)}findOverlaysInBounds(t){const e=[];return this.overlays.forEach((i,s)=>{i.bounds&&i.bounds.minX<=t.maxX&&i.bounds.maxX>=t.minX&&i.bounds.minY<=t.maxY&&i.bounds.maxY>=t.minY&&e.push(i)}),e}clear(){this.overlays.clear(),this.visibleOverlays.clear(),this.hotspotAreas.clear(),this.hoveredHotspot=null,this.selectedHotspot=null,this.selectionTimestamp=null}getStateSummary(){var t,e;return{totalOverlays:this.overlays.size,visibleOverlays:this.visibleOverlays.size,hoveredId:((t=this.hoveredHotspot)==null?void 0:t.id)||null,selectedId:((e=this.selectedHotspot)==null?void 0:e.id)||null,selectionAge:this.selectionTimestamp?Date.now()-this.selectionTimestamp:null}}}class Ht{constructor(){this.events=new Map}on(t,e){return this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(e),()=>this.off(t,e)}off(t,e){const i=this.events.get(t);i&&(i.delete(e),i.size===0&&this.events.delete(t))}emit(t,e){const i=this.events.get(t);i&&i.forEach(s=>{try{s(e)}catch(o){console.error(`Error in event handler for ${t}:`,o)}})}once(t,e){const i=s=>{this.off(t,i),e(s)};return this.on(t,i)}clear(){this.events.clear()}}class Et{constructor(t={}){this.velocityThreshold=t.velocityThreshold||150,this.dwellThreshold=t.dwellThreshold||100,this.historySize=t.historySize||10,this.history=[],this.lastPosition=null,this.lastTime=null}updatePosition(t,e){const i=performance.now();if(this.lastPosition&&this.lastTime){const s=t-this.lastPosition.x,o=e-this.lastPosition.y,a=i-this.lastTime;if(a>0){const l=Math.sqrt(s*s+o*o)/a*1e3;this.history.push({velocity:l,time:i,position:{x:t,y:e}}),this.history.length>this.historySize&&this.history.shift()}}this.lastPosition={x:t,y:e},this.lastTime=i}calculateVelocity(){if(this.history.length===0)return 0;const t=this.history.slice(-5);return t.reduce((i,s)=>i+s.velocity,0)/t.length}calculateDwellTime(){if(this.history.length===0)return 0;const t=performance.now(),e=this.history[this.history.length-1];return t-e.time}shouldTriggerHover(){const t=this.calculateVelocity(),e=this.calculateDwellTime();return window.DEBUG_ANIMATIONS&&console.log(`[HoverIntent] Velocity: ${t.toFixed(0)} px/s, Dwell: ${e.toFixed(0)}ms, VelThreshold: ${this.velocityThreshold}, DwellThreshold: ${this.dwellThreshold}`),t>this.velocityThreshold?!1:e>this.dwellThreshold}getInteractionMode(){const t=this.calculateVelocity();return t>200?"exploration":t>100?"navigation":"detail"}reset(){this.history=[],this.lastPosition=null,this.lastTime=null}}class Dt extends Ht{constructor(t={}){super(),this.isMobile=t.isMobile||!1,this.isSafari=t.isSafari||!1,this.clickTimeThreshold=t.clickTimeThreshold||300,this.clickDistThreshold=t.clickDistThreshold||(this.isMobile?12:8),this.mobileDragThreshold=t.mobileDragThreshold||15,this.activePointers=new Map,this.primaryPointerId=null,this.isDragging=!1,this.isPinching=!1,this.dragStartTime=0,this.dragStartPoint=null,this.lastEchoTapTime=0,this.hoverThrottleTimer=null,this.baseHoverDelay={exploration:50,navigation:100,detail:150},this.hoverThrottleDelay=this.isSafari?50:0,this.hoverIntentDetector=new Et({velocityThreshold:300,dwellThreshold:50}),this.currentMode="direct",this.temporalState={active:!1,phase:null,hotspot:null},this.eventProcessingPaused=!1,this.frameAlignedEnabled=t.frameAlignedEnabled!==!1&&this.isMobile,this.pendingPointerEvents=[],this.frameScheduled=!1,this.lastFrameTime=0,this.eventTypes={POINTER_DOWN:"pointer:down",POINTER_MOVE:"pointer:move",POINTER_UP:"pointer:up",POINTER_CANCEL:"pointer:cancel",MOUSE_MOVE:"mouse:move",CLICK:"click",TOUCH_START:"touch:start",TOUCH_MOVE:"touch:move",TOUCH_END:"touch:end",DRAG_START:"drag:start",DRAG_MOVE:"drag:move",DRAG_END:"drag:end",HOTSPOT_HOVER:"hotspot:hover",HOTSPOT_SELECT:"hotspot:select",HOTSPOT_DESELECT:"hotspot:deselect",HOTSPOT_ACTIVATE:"hotspot:activate",MODE_CHANGE:"mode:change",TEMPORAL_PHASE:"temporal:phase",TEMPORAL_START:"temporal:start",TEMPORAL_END:"temporal:end",REVEAL_TOGGLE:"reveal:toggle",ECHO_TAP:"echo:tap",ECHO_REVEAL_START:"echo:reveal:start",ECHO_REVEAL_END:"echo:reveal:end",VISIBILITY_CHANGE:"visibility:change",VISIBILITY_UPDATE:"visibility:update",ANIMATION_START:"animation:start",ANIMATION_END:"animation:end",ZOOM_START:"zoom:start",ZOOM_END:"zoom:end"},this.fastPathEnabled=t.fastPathEnabled!==!1,this.fastPathThreshold=t.fastPathThreshold||50,this.fastPathDistanceThreshold=t.fastPathDistanceThreshold||10,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),this.handlePointerCancel=this.handlePointerCancel.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleClick=this.handleClick.bind(this)}isSimpleFastTap(t,e,i){return!this.fastPathEnabled||!this.isMobile?!1:t<this.fastPathThreshold&&e<this.fastPathDistanceThreshold&&i===1&&!this.isPinching&&!this.isDragging}updateHoverDelayForZoom(t){const i=t/10*100;let s,o;i<50?(s="exploration",o=this.baseHoverDelay.exploration):i<200?(s="navigation",o=this.baseHoverDelay.navigation):(s="detail",o=this.baseHoverDelay.detail),this.isSafari&&(o=Math.min(o*1.2,200)),this.hoverThrottleDelay=o,window.DEBUG_ANIMATIONS&&console.log(`[EventCoordinator] Hover delay updated: mode=${s}, delay=${this.hoverThrottleDelay}ms`)}initialize(t,e){this.container=t,this.svg=e,t.addEventListener("pointerdown",this.handlePointerDown),t.addEventListener("pointermove",this.handlePointerMove),t.addEventListener("pointerup",this.handlePointerUp),t.addEventListener("pointercancel",this.handlePointerCancel),e.addEventListener("mousemove",this.handleMouseMove),this.isMobile&&e.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.on(this.eventTypes.ECHO_TAP,()=>{this.lastEchoTapTime=performance.now()})}handlePointerDown(t){this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Date.now()}),this.activePointers.size===1&&(this.primaryPointerId=t.pointerId,this.dragStartTime=Date.now(),this.dragStartPoint={x:t.clientX,y:t.clientY}),this.activePointers.size>=2&&(this.isPinching=!0),this.emit(this.eventTypes.POINTER_DOWN,{pointerId:t.pointerId,isPrimary:t.pointerId===this.primaryPointerId,x:t.clientX,y:t.clientY,activePointers:this.activePointers.size,event:t}),this.isMobile&&t.preventDefault()}handlePointerMove(t){if(!this.activePointers.has(t.pointerId))return;const e=this.activePointers.get(t.pointerId),i=e.x,s=e.y;e.x=t.clientX,e.y=t.clientY;const o=Math.sqrt(Math.pow(t.clientX-e.startX,2)+Math.pow(t.clientY-e.startY,2)),a=this.isMobile?this.mobileDragThreshold:this.clickDistThreshold;!this.isDragging&&o>a&&(this.isDragging=!0,this.emit(this.eventTypes.DRAG_START,{pointerId:t.pointerId,startX:e.startX,startY:e.startY,currentX:t.clientX,currentY:t.clientY})),this.emit(this.eventTypes.POINTER_MOVE,{pointerId:t.pointerId,isPrimary:t.pointerId===this.primaryPointerId,x:t.clientX,y:t.clientY,deltaX:t.clientX-i,deltaY:t.clientY-s,distance:o,isDragging:this.isDragging,isPinching:this.isPinching,event:t}),this.isDragging&&this.emit(this.eventTypes.DRAG_MOVE,{pointerId:t.pointerId,x:t.clientX,y:t.clientY,deltaX:t.clientX-i,deltaY:t.clientY-s})}processPendingPointerEvents(){if(this.pendingPointerEvents.length===0){this.frameScheduled=!1;return}const t=performance.now(),e=16;for(;this.pendingPointerEvents.length>0&&performance.now()-t<e;){const i=this.pendingPointerEvents.shift();this.processPointerEventImmediate(i)}this.pendingPointerEvents.length>0?requestAnimationFrame(()=>this.processPendingPointerEvents()):this.frameScheduled=!1,this.lastFrameTime=performance.now()}handlePointerUp(t){if(this.frameAlignedEnabled&&this.isMobile){this.pendingPointerEvents.push({type:"pointerup",event:t,timestamp:performance.now()}),this.frameScheduled||(this.frameScheduled=!0,requestAnimationFrame(()=>this.processPendingPointerEvents()));return}this.processPointerEventImmediate({type:"pointerup",event:t})}processPointerEventImmediate(t){const e=t.event;if(!this.activePointers.has(e.pointerId))return;const i=this.activePointers.get(e.pointerId),s=Date.now()-i.startTime,o=Math.sqrt(Math.pow(e.clientX-i.startX,2)+Math.pow(e.clientY-i.startY,2));if(this.isSimpleFastTap(s,o,this.activePointers.size)){console.log("[EventCoordinator] Fast-path tap detected - bypassing gesture chain"),this.emit(this.eventTypes.ECHO_TAP,{x:e.clientX,y:e.clientY,timestamp:performance.now()}),this.activePointers.delete(e.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1,this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null);return}const n=e.pointerId===this.primaryPointerId&&this.activePointers.size===1&&!this.isPinching&&!this.isDragging&&o<this.clickDistThreshold&&s<this.clickTimeThreshold;if(this.emit(this.eventTypes.POINTER_UP,{pointerId:e.pointerId,isPrimary:e.pointerId===this.primaryPointerId,x:e.clientX,y:e.clientY,duration:s,distance:o,wasClick:n,wasDrag:this.isDragging,event:e}),n){const l=performance.now();let r=!1;this.lastEchoTapTime&&l-this.lastEchoTapTime<100&&(r=!0,console.log("[EventCoordinator] Suppressing click after quick tap")),r||this.emit(this.eventTypes.CLICK,{x:e.clientX,y:e.clientY,duration:s,event:e}),setTimeout(()=>{this.isDragging&&(console.log("[EventCoordinator] Force resetting stuck drag state after click"),this.isDragging=!1,window.lastKnownMouseX!==void 0&&window.lastKnownMouseY!==void 0&&this.emit(this.eventTypes.MOUSE_MOVE,{x:window.lastKnownMouseX,y:window.lastKnownMouseY,skipAnimation:!1,forceHover:!0}))},50)}this.isDragging&&e.pointerId===this.primaryPointerId&&this.emit(this.eventTypes.DRAG_END,{pointerId:e.pointerId,x:e.clientX,y:e.clientY,duration:s,distance:o}),this.activePointers.delete(e.pointerId),this.activePointers.size===0?(this.primaryPointerId=null,this.isPinching=!1,this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null):n&&(console.log("[EventCoordinator] Resetting drag state after click even with active pointers"),this.isDragging=!1)}handlePointerCancel(t){this.handlePointerUp(t),this.emit(this.eventTypes.POINTER_CANCEL,{pointerId:t.pointerId})}handleMouseMove(t){if(this.isDragging&&this.activePointers.size===0&&(console.warn("[EventCoordinator] Detected stuck drag state with no active pointers, resetting"),this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null),this.isDragging||this.currentMode==="temporal"||(this.hoverIntentDetector.updatePosition(t.clientX,t.clientY),this.hoverIntentDetector.shouldTriggerHover(),this.hoverThrottleTimer))return;const e=this.hoverIntentDetector.getInteractionMode();this.hoverThrottleTimer=setTimeout(()=>{this.hoverThrottleTimer=null},this.hoverThrottleDelay),!this.eventProcessingPaused&&this.emit(this.eventTypes.MOUSE_MOVE,{x:t.clientX,y:t.clientY,target:t.target,event:t,interactionMode:e,skipHover:!1})}handleTouchMove(t){if(this.isDragging||this.currentMode==="temporal")return;t.preventDefault();const e=t.touches[0];this.emit(this.eventTypes.TOUCH_MOVE,{x:e.clientX,y:e.clientY,touches:t.touches.length,event:t})}handleClick(t){t.target.closest(".openseadragon-controls")}setMode(t){const e=this.currentMode;this.currentMode=t,this.emit(this.eventTypes.MODE_CHANGE,{from:e,to:t})}setMode(t){const e=this.currentMode;this.currentMode=t,this.emit(this.eventTypes.MODE_CHANGE,{from:e,to:t}),t!=="temporal"&&this.setTemporalState(!1,null,null)}getMode(){return this.currentMode}setTemporalState(t,e,i){this.temporalState={active:t,phase:e,hotspot:i},e!==null&&this.emit(this.eventTypes.TEMPORAL_PHASE,{phase:e,hotspot:i}),t&&!this.temporalState.active?this.emit(this.eventTypes.TEMPORAL_START,{hotspot:i}):!t&&this.temporalState.active&&this.emit(this.eventTypes.TEMPORAL_END,{hotspot:i})}emitHotspotHover(t,e){this.emit(this.eventTypes.HOTSPOT_HOVER,{hotspot:t,previousHotspot:e})}emitHotspotSelect(t,e){this.emit(this.eventTypes.HOTSPOT_SELECT,{hotspot:t,previousHotspot:e}),!t&&e&&this.emit(this.eventTypes.HOTSPOT_DESELECT,{hotspot:e})}emitHotspotActivate(t){this.emit(this.eventTypes.HOTSPOT_ACTIVATE,{hotspot:t})}pauseEventProcessing(){this.eventProcessingPaused=!0}resumeEventProcessing(){this.eventProcessingPaused=!1}forceReactivateMouseTracking(){console.log("[EventCoordinator] Force reactivating mouse tracking"),this.eventProcessingPaused=!1,this.isDragging=!1,window.lastKnownMouseX!==void 0&&window.lastKnownMouseY!==void 0&&(console.log("[EventCoordinator] Emitting last known mouse position"),this.emit(this.eventTypes.MOUSE_MOVE,{x:window.lastKnownMouseX,y:window.lastKnownMouseY,skipAnimation:!1,forceHover:!0,skipHover:!1}))}getPointerState(){return{activePointers:this.activePointers.size,primaryPointerId:this.primaryPointerId,isDragging:this.isDragging,isPinching:this.isPinching}}isCurrentlyDragging(){return this.isDragging}resetDragState(){this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null}destroy(){this.container&&(this.container.removeEventListener("pointerdown",this.handlePointerDown),this.container.removeEventListener("pointermove",this.handlePointerMove),this.container.removeEventListener("pointerup",this.handlePointerUp),this.container.removeEventListener("pointercancel",this.handlePointerCancel)),this.svg&&(this.svg.removeEventListener("mousemove",this.handleMouseMove),this.isMobile&&this.svg.removeEventListener("touchmove",this.handleTouchMove)),this.clear(),this.hoverThrottleTimer&&(clearTimeout(this.hoverThrottleTimer),this.hoverThrottleTimer=null)}}class Pt{constructor(t={}){this.viewer=t.viewer,this.colorScheme=t.colorScheme,this.isSafari=t.isSafari,this.isMobile=t.isMobile,this.config={zoomThreshold:8,transitionDuration:"0.15s",strokeWidthHover:"3px",strokeWidthSelected:"4px",opacityHover:"1.0",opacitySelected:"1.0"}}shouldActivate(t){return t>this.config.zoomThreshold}applyStaticStyle(t,e,i,s){var n,l;const o=t.getAttribute("data-hotspot-id");console.log(`[StaticRenderer] applyStaticStyle called for ${o}, state=${i}`),t.setAttribute("class",`hotspot-${e} hotspot-${i}`),t.setAttribute("data-current-state",i),t.setAttribute("data-animation-active","false");const a=t.querySelector(".main-path");if(a){const r=window.overlayManager||((n=this.viewer)==null?void 0:n.overlayManager),c=r&&r.constructor.name==="Canvas2DOverlayManager";if(a.style.transition=`all ${this.config.transitionDuration} ease-out`,a.style.fill="none",a.style.stroke=c?"transparent":s.main,a.style.strokeWidth=c?"0":i==="selected"?this.config.strokeWidthSelected:this.config.strokeWidthHover,a.style.opacity=c?"0":i==="selected"?this.config.opacitySelected:this.config.opacityHover,console.log(`[StaticRenderer] Applied styles for ${o}:`,{state:i,stroke:a.style.stroke,strokeWidth:a.style.strokeWidth,opacity:a.style.opacity,isCanvas2D:c,overlayManagerType:((l=r==null?void 0:r.constructor)==null?void 0:l.name)||"none"}),a.style.strokeDasharray="none",a.style.strokeDashoffset="0",t.setAttribute("data-animation-completed","true"),!this.isSafari&&!c){a.style.filter=`
                    blur(0px) 
                    contrast(1.4) 
                    drop-shadow(0 0 4px rgba(11, 18, 21, 0.7))
                    drop-shadow(0 0 10px rgba(11, 18, 21, 0.5))
                    drop-shadow(0 0 18px rgba(255, 255, 255, 0.3))
                    drop-shadow(0 0 30px rgba(255, 255, 255, 0.2))
                    drop-shadow(1px 1px 4px rgba(11, 18, 21, 0.4))
                `;const d=i==="selected"?.5:.4,m=i==="selected"?"20px":"15px";a.style.boxShadow=`
                    0 0 ${m} rgba(11, 18, 21, ${d*2}),
                    0 0 ${m*2} rgba(255, 255, 255, 0.25),
                    0 0 ${m*3} rgba(255, 255, 255, 0.2),
                    0 0 ${m*1.5} rgba(11, 18, 21, ${d*1.5}),
                    inset 0 0 3px rgba(11, 18, 21, 0.15)
                `}else c&&(a.style.filter="none",a.style.boxShadow="none")}this.isSafari&&this.applySafariStaticStyle(t,i),t.style.opacity="1"}applySafariStaticStyle(t,e){t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3, .glow-layer-4, .glow-layer-5").forEach((s,o)=>{s.style.transition=`opacity ${this.config.transitionDuration} ease-out`,s.style.strokeDasharray="none",s.style.strokeDashoffset="0";const a=e==="selected"?["1.0","0.8","0.7","0.6","0.3"]:["1.0","0.7","0.6","0.5","0.25"];s.style.opacity=a[o]||"0"})}resetTransitions(t){const e=t.getElementsByTagName("path");for(let i of e)i.style.transition="none",i.offsetWidth}isExitingStaticMode(t,e){return parseFloat(t.getAttribute("data-last-zoom")||"0")>this.config.zoomThreshold&&e<=this.config.zoomThreshold}updateZoomTracking(t,e){t.setAttribute("data-last-zoom",e.toString())}}class xt{constructor(t={}){this.viewer=t.viewer,this.svg=t.svg,this.isMobile=t.isMobile,this.debugMode=t.debugMode,this.state={active:!1,timer:null,duration:6e3,animations:new Map},this.config={breathingDuration:6e3,minOpacity:.3,maxOpacity:1,pulseScale:1.05,activationKeys:["h","H"],tripleTapThreshold:500},this.tapCount=0,this.lastTapTime=0}setupTriggers(){document.addEventListener("keydown",t=>{this.config.activationKeys.includes(t.key)&&(t.preventDefault(),this.toggle())}),this.svg.addEventListener("pointerdown",t=>{this.isMobile&&this.handleTripleTap(t)})}handleTripleTap(t){const e=Date.now();e-this.lastTapTime<this.config.tripleTapThreshold?(this.tapCount++,this.tapCount>=3&&(t.preventDefault(),this.toggle(),this.tapCount=0)):this.tapCount=1,this.lastTapTime=e}toggle(){this.state.active?this.deactivate():this.activate()}activate(){this.state.active||(console.log("Activating reveal mode"),this.state.active=!0,this.svg.classList.add("reveal-mode-active"),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.stateManager&&window.nativeHotspotRenderer.stateManager.getAllOverlays().forEach(t=>{t.isVisible&&this.startBreathingAnimation(t)}),this.state.timer=setTimeout(()=>{this.deactivate()},this.state.duration))}deactivate(){this.state.active&&(console.log("Deactivating reveal mode"),this.state.active=!1,this.svg.classList.remove("reveal-mode-active"),this.state.timer&&(clearTimeout(this.state.timer),this.state.timer=null),this.state.animations.forEach((t,e)=>{this.stopBreathingAnimation({hotspot:{id:e}})}))}startBreathingAnimation(t){if(this.state.animations.has(t.hotspot.id))return;const e=t.element,i=e.querySelector(".main-path");if(!i)return;const s={element:e,mainPath:i,startTime:Date.now(),animationFrame:null},o=()=>{if(!this.state.active||!this.state.animations.has(t.hotspot.id))return;const n=(Date.now()-s.startTime)%this.config.breathingDuration/this.config.breathingDuration,l=this.config.minOpacity+(this.config.maxOpacity-this.config.minOpacity)*(.5+.5*Math.sin(n*Math.PI*2));e.style.opacity=l;const r=1+(this.config.pulseScale-1)*Math.sin(n*Math.PI*2);e.style.transform=`scale(${r})`,s.animationFrame=requestAnimationFrame(o)};this.state.animations.set(t.hotspot.id,s),o()}stopBreathingAnimation(t){const e=this.state.animations.get(t.hotspot.id);e&&(e.animationFrame&&cancelAnimationFrame(e.animationFrame),e.element.style.opacity="",e.element.style.transform="",this.state.animations.delete(t.hotspot.id))}isActive(){return this.state.active}updateVisibility(t){this.state.active&&t.forEach(e=>{e.isVisible&&!this.state.animations.has(e.hotspot.id)?this.startBreathingAnimation(e):!e.isVisible&&this.state.animations.has(e.hotspot.id)&&this.stopBreathingAnimation(e)})}destroy(){this.deactivate(),this.state.timer&&clearTimeout(this.state.timer),this.state.animations.clear()}}class It{constructor(t={}){this.viewer=t.viewer,this.modeStateManager=t.modeStateManager,this.stateManager=t.stateManager,this.temporalHandler=t.temporalHandler,this.temporalHandler&&(this.temporalHandler.onPhaseChange=(e,i)=>{this.handlePhaseChange(e,i)})}handlePhaseChange(t,e){if(!(this.detectionEngine?this.detectionEngine.isHolding():this.temporalHandler.state.isHolding)){console.log("[TEMPORAL_DEBUG] Ignoring phase change - not holding");return}console.log(`[TemporalRenderer] Phase: ${t} for hotspot ${e==null?void 0:e.id}`),t!==null&&this.modeStateManager.setTemporalState(!0,t);const s=this.stateManager.getOverlay(e.id);if(!s)return;const o=s.element;if(o.style.opacity="1",o.style.visibility="visible",o.classList.remove("hotspot-temporal-touchDown","hotspot-temporal-explore","hotspot-temporal-preview","hotspot-temporal-activate"),t==="initial"||t==="initiated"){o.style.opacity="1",o.style.visibility="visible";const a=o.querySelector(".main-path");a&&(a.style.stroke="rgba(255, 255, 255, 0.5)",a.style.strokeWidth="1.5px",a.style.opacity="1",a.style.transition="all 150ms ease-out");return}if(t==="discovery"){o.classList.add("hotspot-temporal-explore");return}t==="touchDown"?o.classList.add("hotspot-temporal-touchDown"):t==="explore"?o.classList.add("hotspot-temporal-explore"):t==="preview"?(o.classList.add("hotspot-temporal-preview"),this.stateManager.setSelectedHotspot(e)):t==="activate"?o.classList.add("hotspot-temporal-activate"):t==="activation"&&(o.classList.add("hotspot-temporal-activate"),this.stateManager.setSelectedHotspot(e))}handleRelease(t,e,i){const s=this.temporalHandler.thresholds;console.log("Temporal mode release:",{duration:t,thresholds:s,hotspotId:e.id}),this.cleanupVisuals(),this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null,t<s.explore?console.log("Temporal: Exploration phase completed"):t>=s.explore&&t<s.activate?console.log("Temporal: Preview/Selection phase completed"):(console.log("Temporal: Activation phase completed"),i&&i(e)),setTimeout(()=>{this.modeStateManager.setTemporalState(!1,null),console.log("[TEMPORAL_FIX] Final temporal state cleanup")},150)}cleanupVisuals(){console.log("[TemporalRenderer] Starting synchronized cleanup"),this.modeStateManager&&(this.modeStateManager.setTemporalState(!1,null),this.modeStateManager.modeStates.temporal.active=!1,this.modeStateManager.modeStates.temporal.phase=null),this.stateManager&&this.stateManager.getAllOverlays().forEach(t=>{if(t&&t.element){t.element.classList.remove("hotspot-temporal-touchDown","hotspot-temporal-explore","hotspot-temporal-preview","hotspot-temporal-activate"),t.element.style.removeProperty("opacity"),t.element.style.removeProperty("visibility"),t.element.style.removeProperty("transition");const e=t.element.querySelector(".main-path");e&&(e.style.removeProperty("stroke"),e.style.removeProperty("stroke-width"),e.style.removeProperty("opacity"),e.style.removeProperty("filter"),e.style.removeProperty("transition"))}}),this.temporalHandler&&this.temporalHandler.cleanupTemporalVisuals(),console.log("[TemporalRenderer] Synchronized cleanup completed")}isActive(){return this.modeStateManager.getCurrentMode()==="temporal"}shouldDisableStrokeAnimation(){return this.isActive()}destroy(){this.cleanupVisuals(),this.temporalHandler&&(this.temporalHandler.onPhaseChange=null)}}class kt{constructor(t=25){this.queue=[],this.running=new Set;const e=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window;this.maxConcurrent=e?3:t,this.isProcessing=!1,this.immediateExecutionThreshold=e?3:25,e&&console.log(`[MOBILE_OPTIMIZATION] Animation queue limited to ${this.maxConcurrent} concurrent animations`)}add(t,e){const i=t.getAttribute("data-hotspot-id");if(this.running.size<this.immediateExecutionThreshold){console.log(`QUICK WIN #4: Immediate animation execution for hotspot ${i}`),this.executeImmediately(i,e);return}this.queue.push({element:t,animationCallback:e}),this.scheduleProcess()}executeImmediately(t,e){this.running.add(t);try{const i=e();i&&i.then?i.finally(()=>{this.running.delete(t)}):this.running.delete(t)}catch(i){this.running.delete(t),console.warn("QUICK WIN #4: Animation callback error:",i)}}scheduleProcess(){this.isProcessing||(this.isProcessing=!0,requestAnimationFrame(()=>{this.processImmediate(),this.isProcessing=!1}))}processImmediate(){for(;this.running.size<this.maxConcurrent&&this.queue.length>0;){const{element:t,animationCallback:e}=this.queue.shift(),i=t.getAttribute("data-hotspot-id");this.running.add(i);try{const s=e();s&&s.then?s.then(()=>{this.running.delete(i),this.scheduleProcess()}).catch(()=>{this.running.delete(i),this.scheduleProcess()}):setTimeout(()=>{this.running.delete(i),this.scheduleProcess()},0)}catch(s){this.running.delete(i),console.warn("Animation callback error:",s)}}}clear(){this.queue=[],this.running.clear()}clearFinished(){const t=[];this.running.forEach(e=>{const i=document.querySelector(`[data-hotspot-id="${e}"]`);if(!i){t.push(e);return}const s=i.getElementsByTagName("path");for(let o of s)if(o.currentAnimation&&o.currentAnimation.playState==="finished"){o.currentAnimation=null,t.push(e);break}}),t.forEach(e=>this.running.delete(e))}}class Ot{constructor(t={}){this.isMobile=t.isMobile||!1,this.isSafari=t.isSafari||!1,this.animationRegistry=new Set,this.cleanupInterval=null,this.cleanupIntervalTime=t.cleanupIntervalTime||2e3,this.maxRegistrySize=t.maxRegistrySize||1e3}startCleanupCycle(t,e){this.cleanupInterval=setInterval(()=>{t&&t.clearFinished(),e().forEach(s=>{const o=s.element.getElementsByTagName("path");for(let a of o)a.currentAnimation&&a.currentAnimation.playState==="finished"&&(a.currentAnimation=null)}),this.animationRegistry.size>this.maxRegistrySize&&this.pruneRegistry()},this.cleanupIntervalTime)}stopCleanupCycle(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}hasAnimationBeenShown(t){return this.animationRegistry.has(t)}registerAnimation(t){this.animationRegistry.add(t)}clearAnimationEntries(t){this.animationRegistry.delete(`${t}-hover`),this.animationRegistry.delete(`${t}-selected`)}clearAnimationEntry(t){this.animationRegistry.delete(t)}clearAllAnimations(){this.animationRegistry.clear()}clearRegistryExcept(t){const e=[];this.animationRegistry.forEach(i=>{t.has(i)||e.push(i)}),e.forEach(i=>this.animationRegistry.delete(i))}pruneRegistry(){const t=Array.from(this.animationRegistry),e=Math.floor(this.maxRegistrySize/2),i=t.slice(-e);this.animationRegistry.clear(),i.forEach(s=>this.animationRegistry.add(s))}getStats(){return{registrySize:this.animationRegistry.size,maxRegistrySize:this.maxRegistrySize,cleanupActive:this.cleanupInterval!==null}}destroy(){this.stopCleanupCycle(),this.clearAllAnimations()}}class j{constructor(t,e,i=50,s=200){this.createFn=t,this.resetFn=e,this.maxSize=s,this.pool=[],this.inUse=new Set,this.stats={created:0,reused:0,released:0};for(let o=0;o<i;o++)this.pool.push(t()),this.stats.created++}acquire(){let t=this.pool.pop();return t?this.stats.reused++:(t=this.createFn(),this.stats.created++),this.inUse.add(t),t}release(t){if(!this.inUse.has(t)){console.warn("ObjectPool: Attempting to release object not from this pool");return}this.inUse.delete(t),this.resetFn(t),this.pool.length<this.maxSize?(this.pool.push(t),this.stats.released++):console.debug("ObjectPool: Max size reached, allowing GC")}releaseAll(){Array.from(this.inUse).forEach(e=>this.release(e))}clear(){this.pool=[],this.inUse.clear()}getStats(){return{...this.stats,poolSize:this.pool.length,inUseSize:this.inUse.size,totalSize:this.pool.length+this.inUse.size,reuseRate:this.stats.created>0?(this.stats.reused/(this.stats.created+this.stats.reused)*100).toFixed(1)+"%":"0%"}}}const Rt=()=>new j(()=>({element:null,opacity:""}),h=>{h.element=null,h.opacity=""},100,500),zt=()=>new j(()=>({x:0,y:0,width:0,height:0}),h=>{h.x=0,h.y=0,h.width=0,h.height=0},50,200),Lt=()=>new j(()=>({x:0,y:0}),h=>{h.x=0,h.y=0},100,300);class Nt{constructor(t={}){this.viewer=t.viewer,this.isMobile=t.isMobile||!1,this.batchSize=t.batchSize||50,this.renderDebounceTime=t.renderDebounceTime||16,this.visibilityCheckInterval=t.visibilityCheckInterval||100,this.significantChangeThreshold=t.significantChangeThreshold||.1,this.performanceMode=!1,this.highHotspotCountThreshold=t.highHotspotCountThreshold||100,this.lastViewportBounds=null,this.lastViewportZoom=null,this.updateTimer=null,this.lastUpdateTime=0,this.pendingVisibilityUpdate=!1,this.updatesPaused=!1,this.isAnimationInProgress=!1,this.rectPool=zt()}async loadHotspotsInBatches(t,e){const i=Math.ceil(t.length/this.batchSize);for(let s=0;s<i;s++)t.slice(s*this.batchSize,(s+1)*this.batchSize).forEach(a=>e(a)),s<i-1&&await new Promise(a=>setTimeout(a,0));console.log(`Loaded ${t.length} hotspots in ${i} batches`)}hasViewportChangedSignificantly(t,e){if(!this.lastViewportBounds||!this.lastViewportZoom)return!0;const i=Math.abs(t.x-this.lastViewportBounds.x)>this.significantChangeThreshold||Math.abs(t.y-this.lastViewportBounds.y)>this.significantChangeThreshold||Math.abs(t.width-this.lastViewportBounds.width)>this.significantChangeThreshold||Math.abs(t.height-this.lastViewportBounds.height)>this.significantChangeThreshold,s=Math.abs(e-this.lastViewportZoom)>.1;return i||s}updateViewportTracking(t,e){this.lastViewportBounds&&this.lastViewportBounds._pooled&&this.rectPool.release(this.lastViewportBounds);const i=this.rectPool.acquire();i.x=t.x,i.y=t.y,i.width=t.width,i.height=t.height,i._pooled=!0,this.lastViewportBounds=i,this.lastViewportZoom=e}setAnimationInProgress(t){this.isAnimationInProgress=t}isAnimationInProgress(){return this.isAnimationInProgress}scheduleVisibilityUpdate(t){if(this.updateTimer&&clearTimeout(this.updateTimer),this.updatesPaused||this.viewer.isAnimating()){this.pendingVisibilityUpdate=!0;return}const i=Date.now()-this.lastUpdateTime,s=this.viewer.viewport.getZoom()<5?100:50;if(i<s){this.updateTimer=setTimeout(()=>{this.scheduleVisibilityUpdate(t)},s-i);return}this.updateTimer=setTimeout(()=>{this.lastUpdateTime=Date.now(),t()},this.renderDebounceTime)}checkPerformanceMode(t,e){const i=t>this.highHotspotCountThreshold,s=t<this.highHotspotCountThreshold*.8;return i&&!this.performanceMode?(this.performanceMode=!0,e&&e.classList.add("performance-mode"),console.log("Performance mode enabled - simplifying animations")):s&&this.performanceMode&&(this.performanceMode=!1,e&&e.classList.remove("performance-mode"),console.log("Performance mode disabled")),this.performanceMode}shouldQueueAnimations(t,e){return t>2&&e>20}pauseUpdates(){this.updatesPaused=!0,console.log("🔧 RenderOptimizer: Updates paused")}resumeUpdates(){return this.updatesPaused=!1,console.log("🔧 RenderOptimizer: Updates resumed"),this.pendingVisibilityUpdate?(this.pendingVisibilityUpdate=!1,!0):!1}areUpdatesPaused(){return this.updatesPaused}setPendingUpdate(){this.pendingVisibilityUpdate=!0}getStats(){return{performanceMode:this.performanceMode,updatesPaused:this.updatesPaused,pendingUpdate:this.pendingVisibilityUpdate,lastUpdateTime:this.lastUpdateTime}}setupVisibilityTracking(t){this.isMobile;const e=()=>{this.scheduleVisibilityUpdate(t)};this.viewer.addHandler("animation",e),this.viewer.addHandler("animation-finish",()=>{this.updatesPaused||t()}),this.isMobile||this.viewer.addHandler("viewport-change",e),t()}destroy(){this.updateTimer&&(clearTimeout(this.updateTimer),this.updateTimer=null),this.lastViewportBounds&&this.lastViewportBounds._pooled&&(this.rectPool.release(this.lastViewportBounds),this.lastViewportBounds=null),this.rectPool&&this.rectPool.clear()}}class $t{constructor(t){this.viewer=t.viewer,this.spatialIndex=t.spatialIndex,this.stateManager=t.stateManager,this.eventCoordinator=t.eventCoordinator,this.renderOptimizer=t.renderOptimizer,this.memoryManager=t.memoryManager,this.safariCompat=t.safariCompat,this.modeRenderers={static:t.staticRenderer,reveal:t.revealRenderer,temporal:t.temporalRenderer},this.currentMode="normal",this.svg=null,this.defs=null,this.pathDefs=null,this.clipDefs=null,this.maskCounter=0,this.hitDetectionCanvas=null,this.useHitDetectionCanvas=!0,this.lodManager=null,this.debugMode=t.debugMode||!1,this.colorScheme=t.colorScheme,this.isMobile=t.isMobile||!1,this.isSafari=t.isSafari||!1,this.onHotspotClick=t.onHotspotClick||(()=>{}),this.onHotspotHover=t.onHotspotHover||(()=>{}),console.log("[RendererEngine] Initialized with mode renderers:",Object.keys(this.modeRenderers))}async initialize(){if(console.log("[RendererEngine] Starting initialization..."),!this.viewer.world.getItemCount())return new Promise(t=>{this.viewer.addOnceHandler("open",async()=>{await this.initialize(),t()})});await this.createSVGStructure(),this.modeRenderers.reveal&&(this.modeRenderers.reveal.svg=this.svg),this.useHitDetectionCanvas&&await this.initializeHitDetectionCanvas(),this.initializeLODManager(),console.log("[RendererEngine] Initialization complete")}async createSVGStructure(){const e=this.viewer.world.getItemAt(0).getContentSize();this.svg=this.createSVG(e),this.viewer.addOverlay({element:this.svg,location:new k.Rect(0,0,1,e.y/e.x),placement:k.Placement.TOP_LEFT}),this.createMaskDefs(),this.pathDefs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.pathDefs.id="path-definitions",this.svg.insertBefore(this.pathDefs,this.svg.firstChild),this.createClipPathDefs(),this.createSVGFilters(),console.log("[RendererEngine] SVG structure created successfully")}createSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
           width="${t.x}" height="${t.y}" 
           viewBox="0 0 ${t.x} ${t.y}"
           style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
    </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}createMaskDefs(){this.defs||(this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.svg.insertBefore(this.defs,this.svg.firstChild),this.maskCounter=0)}createClipPathDefs(){this.defs||this.createMaskDefs();const t=document.createElementNS("http://www.w3.org/2000/svg","defs");t.id="clip-path-defs",this.svg.insertBefore(t,this.svg.firstChild),this.clipDefs=t}createSVGFilters(){const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","filter");e.setAttribute("id","hotspot-glow-selected"),e.setAttribute("x","-100%"),e.setAttribute("y","-100%"),e.setAttribute("width","300%"),e.setAttribute("height","300%"),e.setAttribute("filterUnits","objectBoundingBox"),e.setAttribute("primitiveUnits","userSpaceOnUse"),e.setAttribute("color-interpolation-filters","sRGB");const i=document.createElementNS("http://www.w3.org/2000/svg","feMorphology");i.setAttribute("operator","dilate"),i.setAttribute("radius","2"),i.setAttribute("in","SourceAlpha"),i.setAttribute("result","expanded");const s=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");s.setAttribute("in","expanded"),s.setAttribute("stdDeviation","3"),s.setAttribute("result","blur1");const o=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");o.setAttribute("in","expanded"),o.setAttribute("stdDeviation","8"),o.setAttribute("result","blur2");const a=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");a.setAttribute("in","expanded"),a.setAttribute("stdDeviation","15"),a.setAttribute("result","blur3");const n=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");n.setAttribute("in","blur1"),n.setAttribute("result","glow1");const l=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");l.setAttribute("type","linear"),l.setAttribute("slope","0.8"),l.setAttribute("intercept","0"),n.appendChild(l);const r=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");r.setAttribute("in","blur2"),r.setAttribute("result","glow2");const c=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");c.setAttribute("type","linear"),c.setAttribute("slope","0.5"),c.setAttribute("intercept","0"),r.appendChild(c);const d=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");d.setAttribute("in","blur3"),d.setAttribute("result","glow3");const m=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");m.setAttribute("type","linear"),m.setAttribute("slope","0.3"),m.setAttribute("intercept","0"),d.appendChild(m);const g=document.createElementNS("http://www.w3.org/2000/svg","feFlood");g.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),g.setAttribute("result","innerColor");const y=document.createElementNS("http://www.w3.org/2000/svg","feFlood");y.setAttribute("flood-color",this.colorScheme.glow2||"#4682B4"),y.setAttribute("result","outerColor");const v=document.createElementNS("http://www.w3.org/2000/svg","feComposite");v.setAttribute("in","innerColor"),v.setAttribute("in2","glow1"),v.setAttribute("operator","in"),v.setAttribute("result","innerGlow");const u=document.createElementNS("http://www.w3.org/2000/svg","feComposite");u.setAttribute("in","outerColor"),u.setAttribute("in2","glow3"),u.setAttribute("operator","in"),u.setAttribute("result","outerGlow");const w=document.createElementNS("http://www.w3.org/2000/svg","feFlood");w.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),w.setAttribute("result","midColor");const S=document.createElementNS("http://www.w3.org/2000/svg","feComposite");S.setAttribute("in","midColor"),S.setAttribute("in2","glow2"),S.setAttribute("operator","in"),S.setAttribute("result","midGlow");const f=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),b=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");b.setAttribute("in","outerGlow");const H=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");H.setAttribute("in","midGlow");const E=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");E.setAttribute("in","innerGlow");const I=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");I.setAttribute("in","SourceGraphic"),f.appendChild(b),f.appendChild(H),f.appendChild(E),f.appendChild(I),e.appendChild(i),e.appendChild(s),e.appendChild(o),e.appendChild(a),e.appendChild(n),e.appendChild(r),e.appendChild(d),e.appendChild(g),e.appendChild(y),e.appendChild(w),e.appendChild(v),e.appendChild(u),e.appendChild(S),e.appendChild(f);const T=document.createElementNS("http://www.w3.org/2000/svg","filter");T.setAttribute("id","hotspot-glow-hover"),T.setAttribute("x","-50%"),T.setAttribute("y","-50%"),T.setAttribute("width","200%"),T.setAttribute("height","200%"),T.setAttribute("filterUnits","objectBoundingBox"),T.setAttribute("primitiveUnits","userSpaceOnUse"),T.setAttribute("color-interpolation-filters","sRGB");const P=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");P.setAttribute("in","SourceAlpha"),P.setAttribute("stdDeviation","6"),P.setAttribute("result","blur");const _=document.createElementNS("http://www.w3.org/2000/svg","feFlood");_.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),_.setAttribute("result","innerColor");const U=document.createElementNS("http://www.w3.org/2000/svg","feFlood");U.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),U.setAttribute("result","outerColor");const A=document.createElementNS("http://www.w3.org/2000/svg","feComposite");A.setAttribute("in","innerColor"),A.setAttribute("in2","blur"),A.setAttribute("operator","in"),A.setAttribute("result","coloredBlur");const x=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),C=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");C.setAttribute("in","coloredBlur");const M=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");M.setAttribute("in","SourceGraphic"),x.appendChild(C),x.appendChild(M),T.appendChild(P),T.appendChild(_),T.appendChild(U),T.appendChild(A),T.appendChild(x),t.appendChild(e),t.appendChild(T),this.svg.insertBefore(t,this.svg.firstChild)}setupOverlay(t){}createHotspotOverlay(t,e){const i=this.createGroup(t),s=t.shape==="multipolygon",o=Tt(t.coordinates,s);this.isSafari&&this.safariCompat.createGlowLayers(i,o,this.colorScheme);const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",o),a.setAttribute("fill","none"),a.setAttribute("stroke","transparent"),a.setAttribute("pathLength","100"),a.style.pointerEvents="fill",a.classList.add("main-path"),i.appendChild(a);const n=a.getTotalLength();if(i.removeChild(a),a.setAttribute("data-real-length",n),a.setAttribute("data-animated","true"),this.isSafari&&this.safariCompat.setGlowLayerLengths(i,n),s&&t.coordinates.length>1){const c=`mask-${t.id}-${this.maskCounter++}`,d=document.createElementNS("http://www.w3.org/2000/svg","mask");d.setAttribute("id",c);const m=document.createElementNS("http://www.w3.org/2000/svg","rect");m.setAttribute("x","0"),m.setAttribute("y","0"),m.setAttribute("width","100%"),m.setAttribute("height","100%"),m.setAttribute("fill","white"),d.appendChild(m),t.coordinates.forEach((g,y)=>{if(y>0){const v=document.createElementNS("http://www.w3.org/2000/svg","path"),u=g.reduce((w,[S,f],b)=>w+(b===0?"M":"L")+`${Math.round(S)},${Math.round(f)}`,"")+"Z";v.setAttribute("d",u),v.setAttribute("fill","black"),v.setAttribute("stroke","black"),v.setAttribute("stroke-width","10"),d.appendChild(v)}}),this.defs.appendChild(d),a.setAttribute("mask",`url(#${c})`)}e&&e(i,t.type,"normal"),i.appendChild(a);const l=ht(t.coordinates),r=Mt(l);return{element:i,bounds:l,area:r}}createGroup(t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return Object.assign(e.style,{cursor:"pointer",pointerEvents:"fill",opacity:this.debugMode?"1":"0",transition:"opacity 0.2s ease-out","-webkit-tap-highlight-color":"transparent",transform:"translateZ(0)","-webkit-transform":"translateZ(0)","will-change":"transform, opacity"}),e.setAttribute("data-hotspot-id",t.id),this.colorScheme&&this.colorScheme.main==="#FFFFFF"&&(e.style.mixBlendMode="screen"),e}createHotspotWrapper(t){const e=document.createElement("div");return e.className="hotspot-wrapper",e.setAttribute("data-hotspot-wrapper-id",t),this.isSafari&&(e.style.position="absolute",e.style.transform="translateZ(0)",e.style.webkitTransform="translateZ(0)",e.style.willChange="filter",e.style.contain="layout style paint",this.isMobile?e.classList.add("hotspot-wrapper-ios"):e.classList.add("hotspot-wrapper-desktop")),e}async initializeHitDetectionCanvas(){try{console.log("[HIT_DETECTION] Initializing canvas-based hit detection..."),this.hitDetectionCanvas=new bt({viewer:this.viewer,spatialIndex:this.spatialIndex,debug:this.debugMode}),await this.hitDetectionCanvas.initialize(),window.hitDetectionCanvas=this.hitDetectionCanvas,console.log("[HIT_DETECTION] Canvas-based hit detection initialized successfully")}catch(t){console.error("[HIT_DETECTION] Failed to initialize hit detection canvas:",t),console.warn("[HIT_DETECTION] Falling back to SVG-based detection"),this.useHitDetectionCanvas=!1}}initializeLODManager(){this.lodManager=new St({maxVisibleHotspots:{low:this.isMobile?30:50,medium:this.isMobile?75:100,high:this.isMobile?100:150,critical:this.isMobile?150:200}}),console.log("[RendererEngine] LOD Manager initialized")}findSmallestHotspotAtPoint(t){if(this.useHitDetectionCanvas&&this.hitDetectionCanvas){const i=this.findHotspotUsingCanvas(t);if(i)return console.log(`[HIT_DETECTION] Canvas hit: ${i.id}`),i}const e=[];return this.stateManager.getAllOverlays().forEach((i,s)=>{this.isPointInHotspot(t,i)&&e.push({hotspot:i.hotspot,area:i.area})}),e.length===0?null:(e.sort((i,s)=>i.area-s.area),e[0].hotspot)}findHotspotUsingCanvas(t){try{const e=this.viewer.viewport.imageToViewportCoordinates(t.x,t.y),i=this.viewer.viewport.viewportToWindowCoordinates(e),s=this.viewer.container.getBoundingClientRect(),o=i.x-s.left,a=i.y-s.top,n=this.hitDetectionCanvas.hitTest(o,a);return n&&this.stateManager.getOverlay(n.id)?n:null}catch(e){return console.warn("[HIT_DETECTION] Canvas hit test failed:",e),null}}isPointInHotspot(t,e){const i=e.hotspot,s=e.bounds;return t.x<s.minX||t.x>s.maxX||t.y<s.minY||t.y>s.maxY?!1:i.shape==="polygon"?rt(t.x,t.y,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(o=>rt(t.x,t.y,o)):!1}render(){this.renderOptimizer.areUpdatesPaused()||this.updateVisibility()}updateVisibility(){}setRenderMode(t){this.modeRenderers[t]&&(console.log(`[RendererEngine] Switching render mode: ${this.currentMode} → ${t}`),this.currentMode=t)}applyColorScheme(t){this.colorScheme=t,Object.values(this.modeRenderers).forEach(e=>{e&&e.setColorScheme&&e.setColorScheme(t)})}pause(){this.renderOptimizer.pauseUpdates(),console.log("[RendererEngine] Rendering paused")}resume(){const t=this.renderOptimizer.resumeUpdates();console.log("[RendererEngine] Rendering resumed"),t&&setTimeout(()=>this.render(),50)}destroy(){console.log("[RendererEngine] Destroying..."),this.hitDetectionCanvas&&typeof this.hitDetectionCanvas.destroy=="function"&&this.hitDetectionCanvas.destroy(),this.svg&&this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svg=null,this.defs=null,this.pathDefs=null,this.clipDefs=null,this.lodManager=null,console.log("[RendererEngine] Destroyed")}}const p=pt("StyleManager");class Vt{constructor(t){this.viewer=t.viewer,this.memoryManager=t.memoryManager,this.staticRenderer=t.staticRenderer,this.safariCompat=t.safariCompat,this.renderOptimizer=t.renderOptimizer,this.stateManager=t.stateManager,this.animationQueue=t.animationQueue,this.revealRenderer=t.revealRenderer,this.temporalRenderer=t.temporalRenderer,this.isSafari=t.isSafari||!1,this.colorScheme=t.colorScheme,this.timingEasing=t.timingEasing,this.currentEasingName=t.currentEasingName,this.getAnimationDuration=t.getAnimationDuration,this.animationsPaused=!1,this.allowHoverDuringSpotlight=!0,p.debug("Initialized")}areAnimationsPaused(){return this.animationsPaused===!0}pauseAllAnimations(){p.debug("⏸️ pauseAllAnimations called, was:",this.animationsPaused),this.animationsPaused=!0}resumeAllAnimations(){p.debug("🎬 resumeAllAnimations called, was:",this.animationsPaused),this.animationsPaused,this.animationsPaused=!1,p.debug("🎬 After setting to false, animationsPaused is now:",this.animationsPaused),this.animationsPaused===!0&&(p.error("❌ CRITICAL: animationsPaused is still true after setting to false!"),this.animationsPaused=!1);const t=document.querySelectorAll('g[data-animation-active="true"]');p.debug(`Clearing ${t.length} stuck animation-active flags`),t.forEach(e=>{const i=e.querySelector(".main-path");(!i||!i.currentAnimation)&&e.setAttribute("data-animation-active","false")}),setTimeout(()=>{this.animationsPaused===!0?p.error("❌ animationsPaused reverted to true after resumeAllAnimations!"):p.debug("✅ Animations successfully resumed (confirmed after delay)")},100)}resetToNormalState(t){if(!t)return;const e=t.getAttribute("data-hotspot-id");t.querySelectorAll("path").forEach(a=>{a.getAnimations&&a.getAnimations().forEach(n=>n.cancel()),a.currentAnimation&&(a.currentAnimation.cancel(),a.currentAnimation=null)});const s=t.querySelector(".main-path"),o=t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3, .glow-layer-4, .glow-layer-5");s&&(s.style.opacity="0",s.style.strokeDasharray="none",s.style.strokeDashoffset="0",s.style.filter="none",s.style.transition="none",s.style.animation="none",s.style.visibility="visible"),o.forEach(a=>{a.style.setProperty("opacity","0","important"),a.style.strokeDasharray="none",a.style.strokeDashoffset="0",a.style.filter="none",a.style.transition="none",a.style.animation="none",a.style.visibility="visible"}),t.setAttribute("class",`hotspot-${t.getAttribute("data-hotspot-type")||"area"} hotspot-normal`),t.setAttribute("data-current-state","normal"),t.setAttribute("data-animation-active","false"),t.setAttribute("data-animation-completed","false"),t.removeAttribute("data-maintain-visual"),t.removeAttribute("data-hover-maintained"),t.removeAttribute("data-hover-preserved"),t.removeAttribute("data-was-selected"),this.memoryManager&&e&&(this.memoryManager.clearAnimationEntry(`${e}_hover`),this.memoryManager.clearAnimationEntry(`${e}_selected`)),t.offsetWidth}setColorScheme(t){this.colorScheme=t}applyStyle(t,e,i,s={}){var b,H,E,I,T,P,_,U;const o=t.getAttribute("data-hotspot-id");if(i==="normal"){this.resetToNormalState(t);return}const a=t.getAttribute("data-current-state"),n=t.getAttribute("data-animation-completed")==="true",l=t.getAttribute("data-animation-active")==="true";if(p.debug("applyStyle called:",{hotspotId:o,state:i,currentState:a,animationCompleted:n,animationActive:l,isAutoDeselecting:(b=window.nativeHotspotRenderer)==null?void 0:b.isAutoDeselecting,caller:((H=new Error().stack.split(`
`)[2])==null?void 0:H.trim())||"unknown"}),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.isAutoDeselecting&&i==="hover"){p.debug("Skipping hover animation during auto-deselect");return}if(this.revealRenderer.isActive()&&i!=="normal")return;if(i==="hover"&&t.getAttribute("data-hover-maintained")==="true"&&a==="hover"){p.debug(`Skipping hover re-animation for maintained hotspot ${o}`);return}t.getElementsByTagName("path");const r=t.querySelector(".main-path"),c=`${o}-${i}`,d=this.memoryManager.hasAnimationBeenShown(c),m=this.viewer.viewport.getZoom(),g=this.areAnimationsPaused()&&i==="hover"&&this.allowHoverDuringSpotlight,y=m>8&&!g;g&&m>8&&p.debug("🎯 Spotlight hover detected - bypassing static mode to allow animation at zoom:",m.toFixed(2));const v=a!==i,u=i!=="normal"&&v;a==="selected"&&i==="hover"&&(p.debug("Transition selected → hover, preserving animation state"),t.setAttribute("data-was-selected","true"));const w=this.temporalRenderer.shouldDisableStrokeAnimation(),S=this.staticRenderer.isExitingStaticMode(t,m);if(this.staticRenderer.updateZoomTracking(t,m),(S||v)&&this.memoryManager.clearAnimationEntry(c),!v&&d&&!S&&!u)return;if((i==="hover"||i==="selected")&&y&&!this.temporalRenderer.isActive()){p.debug("Using static mode at zoom:",m.toFixed(2),"for state:",i,"(spotlight check:",g,")"),this.staticRenderer.applyStaticStyle(t,e,i,this.colorScheme);return}if(i==="hover"||i==="selected"){const A=t.getAttribute("data-animation-active"),x=t.getAttribute("data-animation-completed")==="true";if(i==="selected"&&a==="hover"){if(p.debug(`Transition hover → selected for ${o}, animationActive=${A}, animationCompleted=${x}`),t.setAttribute("data-current-state","selected"),t.setAttribute("data-animation-active","false"),t.setAttribute("data-animation-completed","true"),!this.isSafari&&r){r.currentAnimation&&(r.currentAnimation.cancel(),r.currentAnimation=null),r.style.strokeWidth="4px",r.style.strokeDasharray!=="none"&&(r.style.strokeDasharray="none",r.style.strokeDashoffset="0");return}}else if(i==="selected"){const C=t.getAttribute("data-was-selected")==="true";p.debug(`Direct to selected for ${o}, wasSelected=${C}, animationCompleted=${x}`),(C||x)&&(p.debug(`Preventing animation for selected state (wasSelected=${C}, completed=${x}`),t.setAttribute("data-current-state","selected"),t.removeAttribute("data-was-selected"))}else if(A==="true"&&i===a)return;if(i==="hover"&&t.getAttribute("data-hover-preserved")==="true"){t.removeAttribute("data-hover-preserved");return}if(i==="hover"&&t.getAttribute("data-hover-maintained")==="true"){t.removeAttribute("data-hover-maintained");return}}if(t.setAttribute("class",`hotspot-${e} hotspot-${i}`),t.setAttribute("data-current-state",i),i==="hover"||i==="selected"){const A=window.overlayManager||((E=this.viewer)==null?void 0:E.overlayManager),x=A&&A.constructor.name==="Canvas2DOverlayManager";if(i==="hover"&&x&&t.style.display==="none"&&(t.style.display="",p.debug("Canvas2D detected - restoring display for hotspot in hover state")),this.isSafari&&!w){if(i==="selected"){const C=t.querySelector(".main-path"),M=t.querySelector(".glow-layer-1"),$=t.querySelector(".glow-layer-2"),V=t.querySelector(".glow-layer-3"),Z=t.querySelector(".glow-layer-4"),R=t.querySelector(".glow-layer-5"),D=this.colorScheme.main==="#000000";[{element:C,opacity:"1"},{element:M,opacity:D?"0.9":"1"},{element:$,opacity:D?"0.8":"0.9"},{element:V,opacity:D?"0.6":"0.8"},{element:Z,opacity:"0.35"},{element:R,opacity:"0.2"}].forEach(({element:X,opacity:F})=>{X&&(X.style.strokeDasharray="none",X.style.strokeDashoffset="0",X.style.opacity=F)}),t.setAttribute("data-animation-completed","true"),t.setAttribute("data-animation-active","false")}else if(!(t.getAttribute("data-animation-completed")==="true")){const M=this.getAnimationDuration(o);this.safariCompat.animateSafariGlowLayers(t,i,M,this.colorScheme,this.timingEasing),t.setAttribute("data-animation-active","true")}this.memoryManager.registerAnimation(c)}else if(this.isSafari&&w){const C=t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3"),M=t.querySelector(".main-path"),$={mainPath:"1",layer1:i==="selected"?"0.7":"0.6",layer2:i==="selected"?"0.5":"0.4",layer3:i==="selected"?"0.3":"0.2"};M&&(M.style.opacity=$.mainPath),C.forEach((V,Z)=>{const R=[$.layer1,$.layer2,$.layer3][Z];V&&R&&(V.style.strokeDasharray="none",V.style.strokeDashoffset="0",V.style.opacity=R)})}if(r&&!this.isSafari){r.currentAnimation&&(r.currentAnimation.cancel(),r.currentAnimation=null);const C=window.overlayManager||((I=this.viewer)==null?void 0:I.overlayManager),M=C&&C.constructor.name==="Canvas2DOverlayManager",V={animation:"none",strokeDasharray:i==="hover"?"0 100":"none",strokeDashoffset:"0",fill:"none",stroke:M?"transparent":this.colorScheme.main,strokeWidth:M?"0":i==="selected"?"4px":"3px",opacity:M?"0":"1.0"};if(M&&i==="selected"&&(t.style.display="none",p.debug(`Canvas2D detected - hiding entire SVG group for hotspot ${o}`)),i==="selected"&&p.debug("Initial style config for selected:",V),Object.assign(r.style,V),r.offsetWidth,M)r.style.boxShadow="none";else{const R=i==="selected"?.5:.4,D=i==="selected"?"20px":"15px";r.style.boxShadow=`
                        0 0 ${D} rgba(11, 18, 21, ${R*2}),
                        0 0 ${D*2} rgba(255, 255, 255, 0.25),
                        0 0 ${D*3} rgba(255, 255, 255, 0.2),
                        0 0 ${D*1.5} rgba(11, 18, 21, ${R*1.5}),
                        inset 0 0 3px rgba(11, 18, 21, 0.15)
                    `}if(M)r.style.filter="none";else{const D=m/10*100;D<50?r.style.filter=`
                            blur(0.1px) 
                            contrast(1.5) 
                            drop-shadow(0 0 6px rgba(11, 18, 21, 0.8))
                            drop-shadow(0 0 15px rgba(11, 18, 21, 0.6))
                            drop-shadow(0 0 25px rgba(255, 255, 255, 0.4))
                            drop-shadow(0 0 40px rgba(255, 255, 255, 0.3))
                            drop-shadow(2px 3px 8px rgba(11, 18, 21, 0.5))
                        `:D<200?r.style.filter=`
                            blur(0.05px) 
                            contrast(1.45) 
                            drop-shadow(0 0 5px rgba(11, 18, 21, 0.75))
                            drop-shadow(0 0 12px rgba(11, 18, 21, 0.55))
                            drop-shadow(0 0 20px rgba(255, 255, 255, 0.35))
                            drop-shadow(0 0 35px rgba(255, 255, 255, 0.25))
                            drop-shadow(1px 2px 6px rgba(11, 18, 21, 0.45))
                        `:r.style.filter=`
                            blur(0px) 
                            contrast(1.4) 
                            drop-shadow(0 0 4px rgba(11, 18, 21, 0.7))
                            drop-shadow(0 0 10px rgba(11, 18, 21, 0.5))
                            drop-shadow(0 0 18px rgba(255, 255, 255, 0.3))
                            drop-shadow(0 0 30px rgba(255, 255, 255, 0.2))
                            drop-shadow(1px 1px 4px rgba(11, 18, 21, 0.4))
                        `}const Z=parseFloat(r.getAttribute("data-real-length"))||100;if(r.animate&&!w&&!s.skipAnimation){const R=(T=this.stateManager)==null?void 0:T.getSelectedHotspot(),D=R&&R.id===o,tt=t.getAttribute("data-animation-completed")==="true";p.debug(`Animation check for ${o}:`,{state:i,isCurrentlySelected:D,animationCompleted:tt,currentState:a,skipAnimation:s.skipAnimation,disableStrokeAnimation:w});let X=!1;if(i==="selected")p.debug(`Selected state - showing stroke immediately for ${o}`),p.debug("BLOCKING animation for selected state"),r.style.strokeDasharray="none",r.style.strokeDashoffset="0",r.style.opacity="1.0",r.style.strokeWidth="4px",t.setAttribute("data-animation-completed","true"),t.setAttribute("data-animation-active","false"),t.removeAttribute("data-was-selected"),s.skipAnimation=!0;else if(i==="hover"&&!D){p.debug(`Starting hover animation for ${o} (not in spotlight)`),X=!0,t.setAttribute("data-animation-active","true");const B=this.currentEasingName&&this.currentEasingName.toLowerCase().includes("organic")||this.timingEasing&&this.timingEasing.includes("organic");window.DEBUG_ANIMATIONS&&p.perf("[Micro-Variations] Animation setup check:",{hotspotId:o,isOrganicAnimation:B,currentEasingName:this.currentEasingName,timingEasing:this.timingEasing,pathLength:Z}),r.style.strokeDasharray="0 100",r.style.strokeDashoffset="0",t.removeAttribute("data-animation-completed"),r.offsetWidth,B&&o&&window.DEBUG_ANIMATIONS&&p.perf("[Random Start] Organic animation will use random starting point")}else p.debug(`Skipping animation for ${o} - isCurrentlySelected=${D}, state=${i}`),r.style.strokeDasharray="none",r.style.strokeDashoffset="0",r.style.opacity=M?"0":"1.0",r.style.strokeWidth=i==="selected"?"4px":"3px";let F=this.getAnimationDuration(o);if(window.DEBUG_ANIMATIONS&&p.perf("[DEBUG] Checking for organic animation:",{currentEasingName:this.currentEasingName,timingEasing:this.timingEasing,hotspotId:o,hasOrganic:this.currentEasingName&&this.currentEasingName.toLowerCase().includes("organic")||this.timingEasing&&this.timingEasing.includes("organic")}),(this.currentEasingName&&this.currentEasingName.toLowerCase().includes("organic")||this.timingEasing&&this.timingEasing.includes("organic"))&&o){const B=F;F=nt.applyDurationVariation(F,o);const K=((F-B)/B*100).toFixed(1);window.DEBUG_ANIMATIONS&&p.perf(`[Micro-Variations] ⏱️ Duration variation for ${o}: ${B.toFixed(3)}s → ${F.toFixed(3)}s (${K}%)`)}const et=((_=(P=this.viewer)==null?void 0:P.viewport)==null?void 0:_.getZoom())||1,ct=this.renderOptimizer.shouldQueueAnimations(et,this.stateManager.getVisibleCount()),it=()=>{var at;if(i==="selected"){p.debug("ANIMATION FUNCTION: Blocking animation for selected state");return}p.debug(`ANIMATION FUNCTION: Starting animation for ${o} in ${i} state`);const B=window.overlayManager||((at=this.viewer)==null?void 0:at.overlayManager),K=B&&B.constructor.name==="Canvas2DOverlayManager",st=et/10*100;let z;K?z="0":st<50?z=i==="selected"?"1.0":"0.95":st<200?z=i==="selected"?"1.0":"0.98":z="1.0";let Q=this.timingEasing;if((this.currentEasingName&&this.currentEasingName.toLowerCase().includes("organic")||this.timingEasing&&this.timingEasing.includes("organic"))&&o){const G=this.timingEasing;Q=nt.applyEasingVariation(this.timingEasing,o),window.DEBUG_ANIMATIONS&&p.perf(`[Micro-Variations] 🎨 Easing variation for ${o}:`,{original:G,varied:Q})}const L=100,Y=Math.random()*L;window.DEBUG_ANIMATIONS&&p.perf(`[Random Start] Rotating dash animation for ${o}: starting at ${Y.toFixed(1)}% of path`),r.style.strokeDasharray=`0 ${L}`,r.style.strokeDashoffset="0",r.style.opacity=z,r.offsetWidth,r.currentAnimation=r.animate([{strokeDasharray:`0 ${L}`,strokeDashoffset:`${-Y}`,opacity:z,offset:0},{strokeDasharray:`${L*.1} ${L*.9}`,strokeDashoffset:`${-Y}`,opacity:z,offset:.1},{strokeDasharray:`${L*.5} ${L*.5}`,strokeDashoffset:`${-Y}`,opacity:z,offset:.5},{strokeDasharray:`${L*.95} ${L*.05}`,strokeDashoffset:`${-Y}`,opacity:z,offset:.95},{strokeDasharray:`${L} 0`,strokeDashoffset:`${-Y}`,opacity:z,offset:1}],{duration:F*1e3,easing:Q,fill:"forwards"});const ot=performance.now();return window.DEBUG_ANIMATIONS&&p.perf(`[Animation] Stroke animation STARTED for ${t.getAttribute("data-hotspot-id")} at ${ot.toFixed(0)}ms`),r.currentAnimation.onfinish=()=>{const G=performance.now(),dt=G-ot;window.DEBUG_ANIMATIONS&&p.perf(`[Animation] Stroke animation FINISHED for ${t.getAttribute("data-hotspot-id")} at ${G.toFixed(0)}ms (actual duration: ${dt.toFixed(0)}ms, expected: ${(F*1e3).toFixed(0)}ms`),r.currentAnimation=null,t.setAttribute("data-animation-active","false"),t.setAttribute("data-animation-completed","true"),r.style.strokeDasharray="none",r.style.strokeDashoffset="0",r.style.opacity=z},r.currentAnimation.finished};X?(p.debug(`Animation should be executed for ${o}`),ct?(p.debug(`🎭 Adding animation to queue for hotspot ${o}`),this.animationQueue.add(t,it)):(p.debug(`⚡ QUICK WIN #4: Immediate animation execution for hotspot ${o}`),it()),t.setAttribute("data-animation-active","true"),this.memoryManager.registerAnimation(c)):p.debug(`Animation execution SKIPPED for ${o} - shouldExecuteAnimation=${X}`)}else r.style.strokeDasharray="none",r.style.strokeDashoffset="0",r.style.opacity=M?"0":"1.0",r.style.strokeWidth=M?"0":i==="selected"?"4px":"3px"}}else{this.memoryManager.clearAnimationEntries(o),t.setAttribute("data-animation-active","false"),t.removeAttribute("data-animation-completed");const A=window.overlayManager||((U=this.viewer)==null?void 0:U.overlayManager);A&&A.constructor.name==="Canvas2DOverlayManager"&&t.style.display==="none"&&(t.style.display="",p.debug("Canvas2D detected - restoring display for hotspot in normal state")),this.isSafari&&this.safariCompat.resetSafariGlowLayers(t),r&&(r.currentAnimation&&(r.currentAnimation.cancel(),r.currentAnimation=null),r.getAnimations().forEach(C=>C.cancel()),Object.assign(r.style,{animation:"none",strokeDasharray:"none",strokeDashoffset:"0",transition:"opacity 0.1s ease-out",fill:"none",stroke:"transparent",strokeWidth:"0",filter:"none",opacity:"0",boxShadow:"none"}))}const f=i==="hover"||i==="selected"?"1":"0";i==="selected"&&p.debug("END OF applyStyle for selected:",{strokeWidth:r==null?void 0:r.style.strokeWidth,stroke:r==null?void 0:r.style.stroke,opacity:r==null?void 0:r.style.opacity,strokeDasharray:r==null?void 0:r.style.strokeDasharray,groupOpacity:f}),t.style.opacity=f}destroy(){this.viewer=null,this.memoryManager=null,this.staticRenderer=null,this.safariCompat=null,this.renderOptimizer=null,this.stateManager=null,this.animationQueue=null,this.revealRenderer=null,this.temporalRenderer=null}}class Ft{constructor(){this.activeHotspots=new Map,this.visibleIds=new Set,this.allHotspots=new Map,this.stats={totalHotspots:0,activeHotspots:0,domOperations:0,lastUpdateTime:0}}initialize(t){this.allHotspots.clear(),t.forEach((e,i)=>{this.allHotspots.set(i,{id:i,hotspot:e.hotspot,element:e.element,bounds:e.bounds}),e.element.classList.add("hotspot-hidden"),e.element.style.willChange||(e.element.style.willChange="transform, opacity, visibility")}),this.stats.totalHotspots=this.allHotspots.size}updateActiveSet(t){if(window.temporalEchoController&&window.temporalEchoController.isRevealing){console.log("[ActiveHotspotManager] Skipped - temporal echo active");return}const e=performance.now(),i=new Set(t),s=[],o=[];this.allHotspots.forEach((a,n)=>{const l=i.has(n),r=this.activeHotspots.has(n);l&&!r?s.push(a):!l&&r&&o.push(a)}),s.length>0||o.length>0?requestAnimationFrame(()=>{this.cachedContainer||(this.cachedContainer=document.querySelector(".openseadragon-svg"));const a=this.cachedContainer;a&&(a.style.pointerEvents="none"),o.forEach(n=>{n.element&&typeof n.element.className=="string"?n.element.className=n.element.className.replace("hotspot-visible","").trim()+" hotspot-hidden":n.element&&n.element.classList&&(n.element.classList.remove("hotspot-visible"),n.element.classList.add("hotspot-hidden"))}),s.forEach(n=>{n.element&&typeof n.element.className=="string"?n.element.className=n.element.className.replace("hotspot-hidden","").trim()+" hotspot-visible":n.element&&n.element.classList&&(n.element.classList.remove("hotspot-hidden"),n.element.classList.add("hotspot-visible"))}),o.forEach(n=>this.activeHotspots.delete(n.id)),s.forEach(n=>this.activeHotspots.set(n.id,n)),a&&setTimeout(()=>{a.style.pointerEvents=""},0),this.visibleIds=i,this.stats.activeHotspots=this.activeHotspots.size,this.stats.domOperations=s.length+o.length,this.stats.lastUpdateTime=performance.now()-e,this.stats.lastUpdateTime>50&&console.log(`[ActiveHotspotManager] Slow update: ${this.stats.activeHotspots} active, ${this.stats.domOperations} DOM ops in ${this.stats.lastUpdateTime.toFixed(2)}ms`)}):this.stats.lastUpdateTime=performance.now()-e}getActiveHotspots(){return this.activeHotspots}isActive(t){return this.activeHotspots.has(t)}forceShowHotspots(t,e={}){const i=[],s=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,o=e.maxForceShow||(s?15:50);t.slice(0,o).forEach(n=>{if(!this.activeHotspots.has(n)){const l=this.allHotspots.get(n);l&&i.push(l)}}),i.length>0&&requestAnimationFrame(()=>{i.forEach(n=>{n.element.classList.remove("hotspot-hidden"),n.element.classList.add("hotspot-visible"),this.activeHotspots.set(n.id,n)})}),t.length>o&&console.log(`[ActiveHotspotManager] Limited forced hotspots from ${t.length} to ${o} for performance`)}clearActive(){requestAnimationFrame(()=>{this.activeHotspots.forEach(t=>{t.element.classList.add("hotspot-hidden"),t.element.classList.remove("hotspot-visible")}),this.activeHotspots.clear(),this.visibleIds.clear(),this.stats.activeHotspots=0})}getStats(){return{...this.stats,reductionPercent:((1-this.stats.activeHotspots/this.stats.totalHotspots)*100).toFixed(1)}}}class Bt{constructor(t={}){this.spatialIndex=t.spatialIndex,this.viewer=t.viewer,this.isMobile=t.isMobile||!1,this.lastHitTestResult=null,this.pendingHitTest=null,this.hitTestInProgress=!1,this.hitTestThrottle=this.isMobile?50:16,this.lastHitTestTime=0,this.viewportCache={bounds:null,zoom:null,timestamp:0},this.visibleHotspots=new Map,this.stats={hitTests:0,avgTime:0,cacheHits:0}}updateVisibleHotspots(t){this.visibleHotspots.clear(),t.forEach((e,i)=>{this.visibleHotspots.set(i,{id:i,bounds:e.bounds,hotspot:e.hotspot})})}async performHitTest(t,e=!0){const i=performance.now();if(i-this.lastHitTestTime<this.hitTestThrottle)return this.lastHitTestResult;if(e&&this.lastHitTestResult&&this.pendingHitTest){const s=this.pendingHitTest.point;if(Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))<5)return this.stats.cacheHits++,this.lastHitTestResult}return this.hitTestInProgress?this.lastHitTestResult:(this.hitTestInProgress=!0,this.pendingHitTest={point:t,timestamp:i},new Promise(s=>{const o=()=>{const a=performance.now(),n=this.viewer.viewport.viewerElementToImageCoordinates(t);let l=null,r=1/0;this.visibleHotspots.forEach(d=>{if(d.bounds&&n.x>=d.bounds.minX&&n.x<=d.bounds.maxX&&n.y>=d.bounds.minY&&n.y<=d.bounds.maxY)if(this.isMobile)l=d.hotspot;else{const m=this.getDistanceToHotspot(n,d);m<r&&(r=m,l=d.hotspot)}});const c=performance.now()-a;this.stats.hitTests++,this.stats.avgTime=(this.stats.avgTime*(this.stats.hitTests-1)+c)/this.stats.hitTests,this.lastHitTestResult=l,this.lastHitTestTime=i,this.hitTestInProgress=!1,s(l)};"requestIdleCallback"in window&&!this.isMobile?requestIdleCallback(o,{timeout:50}):setTimeout(o,0)}))}getDistanceToHotspot(t,e){const i=e.bounds,s=(i.minX+i.maxX)/2,o=(i.minY+i.maxY)/2;return Math.sqrt(Math.pow(t.x-s,2)+Math.pow(t.y-o,2))}updateViewportCache(){const t=Date.now();if(t-this.viewportCache.timestamp<100)return this.viewportCache;const e=this.viewer.viewport;return this.viewportCache={bounds:e.getBounds(),zoom:e.getZoom(),timestamp:t},this.viewportCache}clearCache(){this.lastHitTestResult=null,this.pendingHitTest=null,this.viewportCache.timestamp=0}getStats(){return{...this.stats,visibleHotspots:this.visibleHotspots.size,cacheHitRate:(this.stats.cacheHits/Math.max(1,this.stats.hitTests)*100).toFixed(1)+"%"}}}class _t{constructor(t){this.viewer=t,this.isInteracting=!1,this.lastInteractionTime=0,this.frameSkipCount=0,this.maxFrameSkip=2,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent),this.isMobile&&(this.maxFrameSkip=3),this.setupEventListeners()}setupEventListeners(){this.viewer.addHandler("canvas-press",()=>{this.isInteracting=!0,this.lastInteractionTime=performance.now()}),this.viewer.addHandler("canvas-drag",()=>{this.isInteracting=!0,this.lastInteractionTime=performance.now()}),this.viewer.addHandler("canvas-pinch",()=>{this.isInteracting=!0,this.lastInteractionTime=performance.now()}),this.viewer.addHandler("canvas-release",()=>{this.isInteracting=!1,this.frameSkipCount=0}),this.viewer.addHandler("canvas-drag-end",()=>{this.isInteracting=!1,this.frameSkipCount=0}),setInterval(()=>{this.isInteracting&&performance.now()-this.lastInteractionTime>200&&(this.isInteracting=!1,this.frameSkipCount=0)},100)}shouldSkipFrame(){return this.isInteracting?this.frameSkipCount<this.maxFrameSkip?(this.frameSkipCount++,!0):(this.frameSkipCount=0,!1):(this.frameSkipCount=0,!1)}isUserInteracting(){return this.isInteracting}getStats(){return{isInteracting:this.isInteracting,frameSkipCount:this.frameSkipCount,maxFrameSkip:this.maxFrameSkip}}}const N=class N{constructor(t={}){this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isWebKit="WebkitAppearance"in document.documentElement.style&&!window.chrome,this.isSafariOrWebKit=this.isSafari||this.isWebKit,Object.assign(this,{viewer:t.viewer,spatialIndex:t.spatialIndex,onHotspotHover:t.onHotspotHover||(()=>{}),onHotspotClick:t.onHotspotClick||(()=>{}),visibilityCheckInterval:t.visibilityCheckInterval||100,batchSize:t.batchSize||50,renderDebounceTime:t.renderDebounceTime||16,debugMode:t.debugMode||!1}),this.updatePool=Rt(),this.pointPool=Lt(),this.enabled=!0,this.stateManager=new At,this.stateManager.setCallbacks({onHoverChange:(e,i)=>{this.eventCoordinator&&this.eventCoordinator.emitHotspotHover(e,i),this.onHotspotHover&&this.onHotspotHover(e)},onSelectionChange:(e,i)=>{this.eventCoordinator&&this.eventCoordinator.emitHotspotSelect(e,i)}}),this.animationQueue=new kt(this.isMobile?N.MAX_CONCURRENT_ANIMATIONS_MOBILE:N.MAX_CONCURRENT_ANIMATIONS),this.activeHotspotManager=new Ft,this.asyncHitDetector=new Bt({spatialIndex:this.spatialIndex,viewer:this.viewer,isMobile:this.isMobile}),this.interactionThrottler=new _t(this.viewer),this.memoryManager=new Ot({isMobile:this.isMobile,isSafari:this.isSafari,cleanupIntervalTime:2e3}),this.renderOptimizer=new Nt({viewer:this.viewer,isMobile:this.isMobile,batchSize:this.batchSize,renderDebounceTime:this.renderDebounceTime,visibilityCheckInterval:this.visibilityCheckInterval,significantChangeThreshold:.1,highHotspotCountThreshold:N.HIGH_HOTSPOT_COUNT_THRESHOLD}),this.modeStateManager=new wt,this.modeStateManager.on("modeChange",e=>{e.from==="temporal"&&e.to!=="temporal"&&(this.temporalHandler&&this.temporalHandler.endHold(),this.temporalRenderer&&this.temporalRenderer.cleanupVisuals()),this.eventCoordinator&&this.eventCoordinator.setMode(e.to)}),window.modeStateManager=this.modeStateManager,this.temporalRenderer=new It({viewer:this.viewer,modeStateManager:this.modeStateManager,stateManager:this.stateManager,temporalHandler:null}),this.temporalDetectionEngine=new yt({audioEngine:window.audioEngine,onStateChange:(e,i,s)=>{this.modeStateManager&&this.modeStateManager.setTemporalState(e==="discovery"||e==="activation",e==="ended"?null:e)},onDiscovery:(e,i)=>{this.temporalRenderer.handlePhaseChange("discovery",e)},onActivation:(e,i)=>{this.temporalRenderer.handlePhaseChange("activation",e),setTimeout(()=>{this.onHotspotClick&&this.onHotspotClick(e)},50)}}),this.temporalHandler=new vt({audioEngine:window.audioEngine,modeStateManager:this.modeStateManager,onPhaseChange:(e,i)=>{this.temporalRenderer.handlePhaseChange(e,i)}}),this.temporalRenderer.temporalHandler=this.temporalHandler,this.temporalRenderer.detectionEngine=this.temporalDetectionEngine,this.colorPalettes={tech:{shadow:"rgba(0, 0, 0, 0.3)",glow:"#00cccc",contrast:"rgba(0, 0, 0, 1)",main:"#ffffff"},enchantedJournal:{shadow:"rgba(47, 79, 79, 0.4)",glow:"#FFD700",glow2:"#DDA0DD",contrast:"rgba(160, 82, 45, 0.8)",main:"#A0522D"},moonlitManuscript:{shadow:"rgba(47, 79, 79, 0.5)",glow:"#87CEEB",glow2:"#4682B4",contrast:"rgba(70, 130, 180, 0.9)",main:"#4682B4"},pureWhiteHigh:{shadow:"rgba(0, 0, 0, 0.4)",glow:"rgba(255, 255, 255, 0.9)",glow2:"rgba(255, 255, 255, 0.7)",contrast:"rgba(255, 255, 255, 1)",main:"#FFFFFF"},pureWhiteBalanced:{shadow:"rgba(0, 0, 0, 0.3)",glow:"rgba(255, 255, 255, 0.8)",glow2:"rgba(255, 255, 255, 0.6)",contrast:"rgba(255, 255, 255, 0.3)",main:"#FFFFFF"},blackOnBlack:{shadow:"rgba(255, 255, 255, 0.1)",glow:"rgba(0, 0, 0, 0.8)",glow2:"rgba(0, 0, 0, 0.6)",contrast:"rgba(255, 255, 255, 0.2)",main:"#000000"},pigmentLinerNeutral:{shadow:"rgba(11, 18, 21, 0.15)",glow:"rgba(11, 18, 21, 0.85)",glow2:"rgba(11, 18, 21, 0.92)",contrast:"rgba(255, 255, 255, 0.1)",main:"#0B1215"},pigmentLinerWarm:{shadow:"rgba(26, 22, 20, 0.15)",glow:"rgba(26, 22, 20, 0.85)",glow2:"rgba(26, 22, 20, 0.92)",contrast:"rgba(255, 255, 255, 0.1)",main:"#1A1614"},pigmentLinerCool:{shadow:"rgba(16, 21, 32, 0.15)",glow:"rgba(16, 21, 32, 0.85)",glow2:"rgba(16, 21, 32, 0.92)",contrast:"rgba(255, 255, 255, 0.1)",main:"#101520"}},this.currentEasingName="consciousnessOrganic",this.timingEasing="cubic-bezier(0.25, 0.40, 0.40, 0.90)",lt(()=>import("./main-BqEPM1GP.js").then(e=>e.E),__vite__mapDeps([0,1])).then(e=>{this.easingOptions=e.getAllEasingOptions(),console.log("[Easing] Loaded variations:",Object.keys(this.easingOptions)),this.easingOptions[this.currentEasingName]&&(this.timingEasing=this.easingOptions[this.currentEasingName],console.log(`[Easing] Updated to ${this.currentEasingName}: ${this.timingEasing}`),this.styleManager&&(this.styleManager.timingEasing=this.timingEasing,this.styleManager.currentEasingName=this.currentEasingName))}),this.easingOptions={organic:"cubic-bezier(0.15, 0.40, 0.32, 0.88)",organicMeditative:"cubic-bezier(0.18, 0.35, 0.35, 0.90)",organicDynamic:"cubic-bezier(0.22, 0.25, 0.38, 0.85)",consciousnessOrganic:"cubic-bezier(0.25, 0.40, 0.40, 0.90)"},window.hotspotEasing={current:this.currentEasingName,options:Object.keys(this.easingOptions),set:e=>this.easingOptions[e]?(this.currentEasingName=e,this.timingEasing=this.easingOptions[e],console.log(`[Easing] Switched to ${e}: ${this.timingEasing}`),this.styleManager&&(this.styleManager.timingEasing=this.timingEasing,this.styleManager.currentEasingName=this.currentEasingName),this.memoryManager&&this.memoryManager.clearAllAnimations(),document.querySelectorAll('[data-animation-completed="true"], [data-animation-active="true"]').forEach(s=>{s.removeAttribute("data-animation-completed"),s.removeAttribute("data-animation-active")}),window.organicVariations&&window.organicVariations.clearAllVariations(),`Now using ${e} easing`):`Unknown easing: ${e}. Options: ${Object.keys(this.easingOptions).join(", ")}`,test:()=>(console.log("Testing all easing curves. Hover over different hotspots to compare."),Object.keys(this.easingOptions))},this.currentPalette="pigmentLinerNeutral",this.colorScheme=this.colorPalettes[this.currentPalette],console.log("[PigmentLiner] Using authentic pigment liner palette:",this.currentPalette,this.colorScheme),window.hotspotColorScheme=this.colorScheme,window.setPigmentLinerVariant=e=>{const i=["pigmentLinerNeutral","pigmentLinerWarm","pigmentLinerCool"];i.includes(e)?(console.log(`[PigmentLiner] Switching to variant: ${e}`),this.currentPalette=e,this.colorScheme=this.colorPalettes[e],window.hotspotColorScheme=this.colorScheme,this.styleManager&&this.styleManager.setColorScheme(this.colorScheme),this.refreshAllHotspotStyles()):console.log("[PigmentLiner] Available variants:",i)},console.log("[PigmentLiner] Available variants: neutral (default), warm, cool"),console.log('[PigmentLiner] Switch with: window.setPigmentLinerVariant("pigmentLinerWarm") or "pigmentLinerCool"'),this.staticRenderer&&(this.staticRenderer.colorScheme=this.colorScheme),this.safariCompat=new Ct({colorScheme:this.colorScheme,isMobile:this.isMobile}),this.staticRenderer=new Pt({viewer:this.viewer,colorScheme:this.colorScheme,isSafari:this.isSafari,isMobile:this.isMobile}),window.hotspotPalettes=this.colorPalettes,window.setHotspotPalette=e=>{this.colorPalettes[e]&&(this.currentPalette=e,this.colorScheme=this.colorPalettes[e],window.hotspotColorScheme=this.colorScheme,this.styleManager.setColorScheme(this.colorScheme),this.refreshAllHotspotStyles())},this.eventCoordinator=new Dt({isMobile:this.isMobile,isSafari:this.isSafari,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,mobileDragThreshold:this.mobileDragThreshold}),window.eventCoordinator=this.eventCoordinator,this.eventCoordinator.setMode(this.modeStateManager.getCurrentMode()),this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null,this.mobileDragThreshold=this.isMobile?15:8,this.clickTimeThreshold=300,this.clickDistThreshold=this.isMobile?12:8,this.activePointers=new Map,this.primaryPointerId=null,this.lastPointerDownTime=0,this.lastPointerDownPoint=null,this.isPinching=!1,this.revealRenderer=new xt({viewer:this.viewer,svg:null,isMobile:this.isMobile,debugMode:this.debugMode}),this.engine=new $t({viewer:this.viewer,spatialIndex:this.spatialIndex,stateManager:this.stateManager,eventCoordinator:this.eventCoordinator,renderOptimizer:this.renderOptimizer,memoryManager:this.memoryManager,safariCompat:this.safariCompat,staticRenderer:this.staticRenderer,revealRenderer:this.revealRenderer,temporalRenderer:this.temporalRenderer,debugMode:this.debugMode,colorScheme:this.colorScheme,isMobile:this.isMobile,isSafari:this.isSafari,onHotspotClick:this.onHotspotClick,onHotspotHover:this.onHotspotHover}),this.styleManager=new Vt({viewer:this.viewer,memoryManager:this.memoryManager,staticRenderer:this.staticRenderer,safariCompat:this.safariCompat,renderOptimizer:this.renderOptimizer,stateManager:this.stateManager,animationQueue:this.animationQueue,revealRenderer:this.revealRenderer,temporalRenderer:this.temporalRenderer,isSafari:this.isSafari,colorScheme:this.colorScheme,timingEasing:this.timingEasing,currentEasingName:this.currentEasingName,getAnimationDuration:e=>this.getAnimationDuration(e)}),this.initStyles(),t.skipInit||this.init()}initStyles(){}async init(){if(!this.viewer.world.getItemCount()){this.viewer.addOnceHandler("open",()=>this.init());return}if(!document.getElementById("hotspot-animations-fix")){const i=document.createElement("style");i.id="hotspot-animations-fix",i.textContent=`
        .hotspot-hover path,
        .hotspot-selected path {
            animation-play-state: running !important;
        }
    `,document.head.appendChild(i)}if(!document.getElementById("reveal-mode-styles")){const i=document.createElement("style");i.id="reveal-mode-styles",i.textContent=`
        .reveal-mode-active .hotspot-wrapper {
            will-change: opacity, transform;
        }
        
        @keyframes revealPulse {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.3; transform: scale(1); }
        }
    `,document.head.appendChild(i)}if(!document.getElementById("pigment-liner-animations")){const i=document.createElement("style");i.id="pigment-liner-animations",i.textContent=`
        @keyframes organicBreathing {
            0% { 
                opacity: 0.98;
            }
            50% { 
                opacity: 1.0;
            }
            100% { 
                opacity: 0.98;
            }
        }
        
        /* Enhanced organic scintillation for selected states */
        @keyframes inkScintillation {
            0%, 90%, 100% { 
                opacity: 1.0;
            }
            95% { 
                opacity: 1.0;
            }
        }
    `,document.head.appendChild(i)}await this.engine.initialize(),this.svg=this.engine.svg,this.defs=this.engine.defs,this.pathDefs=this.engine.pathDefs,this.maskCounter=this.engine.maskCounter;const t=localStorage.getItem("revealStyle")||"invert";this.svg.classList.add(`reveal-style-${t}`);const e=document.createElement("style");e.textContent=`
    @keyframes revealWidth {
        from { width: 0%; }
        to { width: 110%; }
    }
`,document.head.appendChild(e),await this.renderOptimizer.loadHotspotsInBatches(this.spatialIndex.getAllHotspots(),i=>this.createHotspotOverlay(i)),this.activeHotspotManager.initialize(this.stateManager.getAllOverlays()),this.engine.useHitDetectionCanvas&&await this.engine.initializeHitDetectionCanvas(),this.stateManager.getAllOverlays().forEach(i=>{this.safariCompat.optimizePathsForGPU(i)}),this.safariCompat.optimizeLayers(this.stateManager.getAllOverlays()),this.memoryManager.startCleanupCycle(this.animationQueue,()=>this.stateManager.getAllOverlays()),this.setupMouseTracking(),this.setupDragDetection(),this.setupRevealMode(),this.viewer.addHandler("zoom",()=>{this.currentZoom=this.viewer.viewport.getZoom();const i=this.renderOptimizer.lastViewportZoom||0;(i<=8&&this.currentZoom>8||i>8&&this.currentZoom<=8)&&(this.clearAnimationRegistryForZoomChange(),i>8&&this.currentZoom<=8&&this.stateManager.getAllOverlays().forEach(n=>{this.resetStaticTransitions(n.element)}));const s=this.stateManager.getHoveredHotspot(),o=this.stateManager.getSelectedHotspot(),a=i<=8&&this.currentZoom>8||i>8&&this.currentZoom<=8;if(s){const n=this.stateManager.getOverlay(s.id);if(n){const l=n.element.getAttribute("data-current-state"),r=n.element.getAttribute("data-animation-completed")==="true";(l!=="hover"||a)&&(console.log("[Zoom] Reapplying hover style:",{hotspotId:s.id,currentState:l,animationCompleted:r,crossingThreshold:a,previousZoom:i.toFixed(2),currentZoom:this.currentZoom.toFixed(2)}),this.applyStyle(n.element,s.type,"hover",{skipAnimation:r}))}}if(o&&o!==s){const n=this.stateManager.getOverlay(o.id);if(n){const l=n.element.getAttribute("data-current-state"),r=n.element.getAttribute("data-animation-completed")==="true";(l!=="selected"||a)&&(console.log("[Zoom] Reapplying selected style:",{hotspotId:o.id,currentState:l,animationCompleted:r,crossingThreshold:a,previousZoom:i.toFixed(2),currentZoom:this.currentZoom.toFixed(2)}),this.applyStyle(n.element,o.type,"selected",{skipAnimation:!0}))}}}),this.startVisibilityTracking(),window.nativeHotspotRenderer=this,window.temporalDetectionEngine=this.temporalDetectionEngine}getResetAnimationState(){return()=>this.resetAnimationState()}createHotspotOverlay(t){const e=this.engine.createHotspotOverlay(t,(i,s,o)=>this.applyStyle(i,s,o));this.svg.appendChild(e.element),this.stateManager.addOverlay(t.id,{element:e.element,hotspot:t,bounds:e.bounds,area:e.area,isVisible:!1})}setupDragDetection(){this.viewer.addHandler("canvas-drag",()=>{this.eventCoordinator.isDragging=!0}),this.viewer.addHandler("canvas-drag-end",()=>{this.eventCoordinator.resetDragState()}),this.viewer.addHandler("pan",()=>{this.eventCoordinator.isDragging=!0})}setupMouseTracking(){this.eventCoordinator.initialize(this.viewer.container,this.svg),this.eventCoordinator.on(this.eventCoordinator.eventTypes.MOUSE_MOVE,t=>{if(window.lastKnownMouseX=t.x,window.lastKnownMouseY=t.y,this.eventCoordinator.isCurrentlyDragging()||this.temporalRenderer.isActive()){this.svg.style.cursor="default";return}const e=this.viewer.element.getBoundingClientRect(),i=new k.Point(t.x-e.left,t.y-e.top),s=this.viewer.viewport.pointFromPixel(i),o=this.viewer.viewport.viewportToImageCoordinates(s),a=this.engine.findSmallestHotspotAtPoint(o),n=this.stateManager.getHoveredHotspot();if(!this.isAutoDeselecting){if(t.forceHover&&a&&a===n){const l=this.stateManager.getOverlay(a.id);if(l){const r=l.element;r.setAttribute("data-animation-active","false"),r.removeAttribute("data-animation-completed"),r.removeAttribute("data-hover-preserved");const c=`${a.id}-hover`;this.memoryManager.clearAnimationEntry(c),r.getAttribute("data-current-state")!=="hover"&&this.applyStyle(l.element,a.type,"hover")}}else if(a!==n){if(n){const l=this.stateManager.getOverlay(n.id);l&&(l.element.querySelectorAll("path").forEach(c=>{c.currentAnimation&&(c.currentAnimation.cancel(),c.currentAnimation=null),c.getAnimations&&c.getAnimations().forEach(d=>d.cancel())}),l.element.removeAttribute("data-hover-preserved"),l.element.removeAttribute("data-hover-maintained"),this.isLeavingHover=!0,this.applyStyle(l.element,n.type,n===this.stateManager.getSelectedHotspot()?"selected":"normal"),this.isLeavingHover=!1)}if(this.stateManager.setHoveredHotspot(a),a){const l=this.stateManager.getOverlay(a.id);l&&this.applyStyle(l.element,a.type,"hover")}}this.svg.style.cursor=a?"pointer":"default"}}),this.safariCompat.setupIOSClickHandler(this.svg,t=>{const e=this.viewer.element.getBoundingClientRect(),i=new k.Point(t.clientX-e.left,t.clientY-e.top),s=this.viewer.viewport.pointFromPixel(i),o=this.viewer.viewport.viewportToImageCoordinates(s);return this.engine.findSmallestHotspotAtPoint(o)},t=>this.activateHotspot(t)),this.setupPointerEvents()}setupPointerEvents(){this.eventCoordinator.on(this.eventCoordinator.eventTypes.CLICK,t=>{if(console.log("EventCoordinator CLICK detected",t),t.event.target.closest(".openseadragon-controls"))return;const e=this.viewer.element.getBoundingClientRect(),i=new k.Point(t.x-e.left,t.y-e.top),s=this.viewer.viewport.pointFromPixel(i),o=this.viewer.viewport.viewportToImageCoordinates(s),a=this.engine.findSmallestHotspotAtPoint(o);if(a)if(t.event.stopPropagation(),t.event.preventDefault(),this.isMobile&&window.overlayManager&&window.overlayManager.constructor.name==="Canvas2DOverlayManager"){const l=this.stateManager.getOverlay(a.id);if(l&&l.element&&l.element.getAttribute("data-hotspot-revealed")==="true")console.log("Revealed hotspot clicked, triggering cinematic zoom:",a.id),this.activateHotspot(a);else{console.log("Non-revealed hotspot clicked, triggering echo reveal:",a.id),this.viewer.element.getBoundingClientRect();const c={x:t.event.clientX,y:t.event.clientY,viewportX:t.x,viewportY:t.y};window.temporalEchoController&&window.temporalEchoController.handleQuickTap&&window.temporalEchoController.handleQuickTap(c)}}else this.activateHotspot(a);else this.stateManager.getSelectedHotspot()&&(this.deselectHotspot(),this.onHotspotClick&&this.onHotspotClick(null))}),this.eventCoordinator.on(this.eventCoordinator.eventTypes.DRAG_START,()=>{const t=this.stateManager.getHoveredHotspot();if(t){const e=this.stateManager.getOverlay(t.id);e&&this.applyStyle(e.element,t.type,t===this.stateManager.getSelectedHotspot()?"selected":"normal"),this.stateManager.setHoveredHotspot(null)}})}handleClick(t){var l;if(console.log("handleClick called",{isDragging:this.isDragging,isPinching:this.isPinching,activePointers:this.activePointers.size,targetTag:t.target.tagName,targetClass:((l=t.target.className)==null?void 0:l.baseVal)||t.target.className,timestamp:Date.now()}),t.target.closest(".openseadragon-controls"))return;const e=this.stateManager.getHoveredHotspot();if(this.isMobile&&e){console.log("Using cached hover hotspot for mobile click"),t.stopPropagation(),t.preventDefault(),this.activateHotspot(e);return}const i=this.viewer.element.getBoundingClientRect(),s=new k.Point(t.clientX-i.left,t.clientY-i.top),o=this.viewer.viewport.pointFromPixel(s),a=this.viewer.viewport.viewportToImageCoordinates(o),n=this.engine.findSmallestHotspotAtPoint(a);n?(t.stopPropagation(),t.preventDefault(),this.activateHotspot(n)):this.stateManager.getSelectedHotspot()&&(this.deselectHotspot(),this.onHotspotClick&&this.onHotspotClick(null))}activateHotspot(t){console.log("🎯 iOS DEBUG: activateHotspot called:",{hotspotId:t.id,timestamp:Date.now(),isSafari:this.isSafari,isMobile:this.isMobile}),this.eventCoordinator&&(console.log("🔄 Resetting drag state when activating hotspot"),this.eventCoordinator.resetDragState(),this.eventCoordinator.forceReactivateMouseTracking());const e=this.stateManager.getSelectedHotspot();if(e&&e.id!==t.id){console.log("🔄 Clearing previous selection:",e.id);const s=this.stateManager.getOverlay(e.id);s&&this.applyStyle(s.element,e.type,"normal")}this.stateManager.setSelectedHotspot(t),this.engine.lodManager&&this.engine.lodManager.recordInteraction(t.id);const i=this.stateManager.getOverlay(t.id);i&&(console.log("🎯 Applying selected state BEFORE onHotspotClick for:",t.id),this.applyStyle(i.element,t.type,"selected")),this.onHotspotClick(t),this.stateManager.getAllOverlays().forEach((s,o)=>{var n;if(o===t.id)return;const a=o===((n=this.stateManager.getHoveredHotspot())==null?void 0:n.id)?"hover":"normal";if(o===t.id){const l=this.viewer.viewport.getZoom();console.log("🎯 iOS DEBUG: Applying selected style to:",o),console.log("🎯 Current zoom level:",l.toFixed(2)),console.log("🎯 Is in static mode (>8.0)?",l>8);const r=s.element.getAttribute("data-current-state"),c=s.element.getAttribute("data-animation-completed")==="true";console.log("🎯 Transition to selected:",{currentState:r,animationCompleted:c})}this.applyStyle(s.element,s.hotspot.type,a)})}deselectHotspot(){var e,i;const t=this.stateManager.getSelectedHotspot();console.log("🎯 [DESELECT] deselectHotspot called",{previousSelected:(t==null?void 0:t.id)||"none"}),this.stateManager.setSelectedHotspot(null),this.stateManager.getAllOverlays().forEach((s,o)=>{var n;const a=o===((n=this.stateManager.getHoveredHotspot())==null?void 0:n.id)?"hover":"normal";this.applyStyle(s.element,s.hotspot.type,a)}),console.log("✅ [DESELECT] deselectHotspot complete",{selectedAfter:((e=this.stateManager.getSelectedHotspot())==null?void 0:e.id)||"none",hoveredAfter:((i=this.stateManager.getHoveredHotspot())==null?void 0:i.id)||"none"})}forceCompleteReset(){var s;const t=this.stateManager.getSelectedHotspot();console.log("🔧 [DESELECT] Forcing complete reset",{previousSelected:(t==null?void 0:t.id)||"none",totalHotspots:this.stateManager.getAllOverlays().size}),this.stateManager.setSelectedHotspot(null);let e=0,i=0;this.stateManager.getAllOverlays().forEach((o,a)=>{const n=o.element;if(!n)return;const l=n.querySelector(".main-path"),r=l?window.getComputedStyle(l).opacity:"0";r!=="0"&&r!==0&&i++,this.styleManager?this.styleManager.resetToNormalState(n):this.applyStyle(n,o.hotspot.type,"normal"),n.removeAttribute("data-maintain-visual"),n.removeAttribute("data-hover-maintained"),n.removeAttribute("data-hover-preserved"),n.removeAttribute("data-was-selected"),n.setAttribute("data-animation-active","false"),n.setAttribute("data-animation-completed","false"),n.setAttribute("data-current-state","normal"),e++}),this.memoryManager&&this.stateManager.getAllOverlays().forEach((o,a)=>{this.memoryManager.clearAnimationEntry(`${a}_hover`),this.memoryManager.clearAnimationEntry(`${a}_selected`)}),this.isAutoDeselecting=!1,console.log("✅ [DESELECT] Reset complete",{resetCount:e,visibleBeforeReset:i,selectedAfter:((s=this.stateManager.getSelectedHotspot())==null?void 0:s.id)||"none"})}resetAnimationState(){console.log("🔄 Resetting animation state after cinematic zoom"),this.memoryManager.clearAllAnimations(),this.stateManager.getAllOverlays().forEach(t=>{var i;const e=t.element;if(e){e.setAttribute("data-animation-active","false"),e.removeAttribute("data-current-state"),e.removeAttribute("data-animation-completed");const s=e.getElementsByTagName("path");for(let o of s)o.currentAnimation&&(o.currentAnimation.cancel(),o.currentAnimation=null),(i=o.getAnimations)==null||i.call(o).forEach(a=>a.cancel())}}),this.stateManager.getHoveredHotspot(),this.stateManager.setHoveredHotspot(null),setTimeout(()=>{if(window.lastKnownMouseX!==void 0&&window.lastKnownMouseY!==void 0){console.log("🔄 Re-evaluating mouse position after zoom");const t=this.viewer.element.getBoundingClientRect(),e=new k.Point(window.lastKnownMouseX-t.left,window.lastKnownMouseY-t.top),i=this.viewer.viewport.pointFromPixel(e),s=this.viewer.viewport.viewportToImageCoordinates(i),o=this.engine.findSmallestHotspotAtPoint(s);if(o){console.log("🎯 Found hotspot under cursor:",o.id),this.stateManager.setHoveredHotspot(o);const a=this.stateManager.getOverlay(o.id);a&&(console.log("🎨 Applying hover animation to:",o.id),this.applyStyle(a.element,o.type,"hover"))}}},100),console.log("✅ Animation state reset complete")}instantDeselect(t=!1){const e=this.stateManager.getSelectedHotspot();if(!e)return;if(console.log("🎯 [DESELECT] instantDeselect called",{isFromHoverExit:t,isMobile:this.isMobile,currentSelected:(e==null?void 0:e.id)||"none"}),this.isMobile){console.log("📱 [DESELECT] Mobile detected - resetting selected hotspot");const s=this.stateManager.getOverlay(e.id);if(s&&s.element){const o=s.element.querySelector(".main-path"),a=o?window.getComputedStyle(o).opacity:"N/A";this.styleManager?this.styleManager.resetToNormalState(s.element):this.applyStyle(s.element,e.type,"normal");const n=o?window.getComputedStyle(o).opacity:"N/A";console.log("📊 [DESELECT] Mobile hotspot reset result",{hotspotId:e.id,opacityBefore:a,opacityAfter:n,stateAfter:s.element.getAttribute("data-current-state")})}this.stateManager.setSelectedHotspot(null),this.isAutoDeselecting=!1,console.log("✅ [DESELECT] Mobile deselect complete");return}this.isAutoDeselecting=!0;const i=this.stateManager.getHoveredHotspot();if(this.svg&&this.svg.querySelectorAll("g[data-hotspot-id]").forEach(o=>{const a=o.getAttribute("data-hotspot-id"),n=o.getAttribute("data-current-state");if(e&&a===e.id||i&&a===i.id)return;const l=o.querySelector(".main-path"),r=l&&(l.style.opacity!=="0"&&l.style.opacity!==""||l.style.strokeDasharray==="none"||l.style.strokeDasharray==="100 0"||this.isSafari&&(o.getAttribute("data-animation-completed")==="true"||o.querySelector(".glow-layer-1, .glow-layer-2, .glow-layer-3")!==null));let c=!1;if(this.isSafari?this.isLeavingHover?c=n==="hover"&&a!==this.recentlyAutoDeselected:c=n==="hover"||n==="selected":c=r||n==="hover"||n==="selected",c){console.log(`Resetting hotspot ${a} to normal state (visible=${r}, state=${n})`);const d=this.stateManager.getOverlay(a);d&&d.hotspot&&(this.applyStyle(o,d.hotspot.type,"normal"),this.isSafari&&!this.isLeavingHover&&(o.removeAttribute("data-animation-completed"),o.setAttribute("data-animation-active","false")))}}),e){const s=this.stateManager.getOverlay(e.id);if(s&&s.element){console.log("🔄 Auto-deselecting current hotspot, transitioning to normal state"),this.applyStyle(s.element,e.type,"normal"),s.element.setAttribute("data-animation-active","false");const o=e.id;this.memoryManager.clearAnimationEntry(`${o}-selected`),this.memoryManager.clearAnimationEntry(`${o}-hover`)}}this.stateManager.setSelectedHotspot(null),this.isAutoDeselecting=!1,this.eventCoordinator&&(console.log("🔄 Resetting drag state after auto-deselect"),this.eventCoordinator.resetDragState()),setTimeout(()=>{var s;if(console.log("🔓 Auto-deselect timeout reached, clearing flags"),console.log("  - recentlyAutoDeselected:",this.recentlyAutoDeselected),console.log("  - currentHovered:",(s=this.stateManager.getHoveredHotspot())==null?void 0:s.id),this.recentlyAutoDeselected){const o=this.stateManager.getOverlay(this.recentlyAutoDeselected);o&&o.element&&o.element.removeAttribute("data-maintain-visual")}console.log("Auto-deselect completed, animations can resume")},500)}applyStyle(t,e,i,s={}){const o=t.getAttribute("data-hotspot-id");if(i==="hover"&&o!==this.recentlyAutoDeselected&&this.recentlyAutoDeselected&&(this.recentlyAutoDeselected=null,this._recentlyAutoDeselectedClearTimeout&&(clearTimeout(this._recentlyAutoDeselectedClearTimeout),this._recentlyAutoDeselectedClearTimeout=null)),i==="hover"&&o===this.recentlyAutoDeselected&&!this.isAutoDeselecting){console.log("⛔ Blocking hover animation on recently auto-deselected hotspot:",o),this._recentlyAutoDeselectedClearTimeout||(this._recentlyAutoDeselectedClearTimeout=setTimeout(()=>{console.log("🗳️ Clearing recentlyAutoDeselected flag for:",this.recentlyAutoDeselected),this.recentlyAutoDeselected=null,this._recentlyAutoDeselectedClearTimeout=null},1e3));return}this.styleManager.applyStyle(t,e,i,s)}maintainHoverVisual(t){var i;const e=this.stateManager.getOverlay(t.id);if(e&&e.element){const s=e.element,o=s.querySelector(".main-path");if(console.log("🎨 Maintaining hover visual for hotspot:",t.id),o){o.style.strokeDasharray="none",o.style.strokeDashoffset="0",o.style.opacity="1.0",o.style.stroke=this.styleManager.colorScheme.main,o.style.strokeWidth="3px";const a=window.overlayManager||((i=this.viewer)==null?void 0:i.overlayManager),n=a&&a.constructor.name==="Canvas2DOverlayManager";n||(o.style.filter=`
                        blur(0.05px) 
                        contrast(1.45) 
                        drop-shadow(0 0 5px rgba(11, 18, 21, 0.75))
                        drop-shadow(0 0 12px rgba(11, 18, 21, 0.55))
                        drop-shadow(0 0 20px rgba(255, 255, 255, 0.35))
                        drop-shadow(0 0 35px rgba(255, 255, 255, 0.25))
                        drop-shadow(1px 2px 6px rgba(11, 18, 21, 0.45))
                    `),s.setAttribute("data-current-state","hover"),s.setAttribute("data-hover-maintained","true"),s.setAttribute("data-hover-preserved","true"),s.setAttribute("data-animation-completed","true"),s.setAttribute("data-animation-active","false"),s.style.opacity="1",n||(o.style.boxShadow=`
                        0 0 15px rgba(11, 18, 21, 0.8),
                        0 0 30px rgba(255, 255, 255, 0.25),
                        0 0 45px rgba(255, 255, 255, 0.2),
                        0 0 22.5px rgba(11, 18, 21, 0.6),
                        inset 0 0 3px rgba(11, 18, 21, 0.15)
                    `),this.memoryManager.registerAnimation(`${t.id}-hover`),console.log("🏁 Added hover maintenance flags and registered animation as completed for hotspot:",t.id)}}}resetStaticTransitions(t){this.staticRenderer.resetTransitions(t)}clearAnimationRegistryForZoomChange(){const t=new Set,e=this.stateManager.getHoveredHotspot(),i=this.stateManager.getSelectedHotspot();e&&t.add(`${e.id}-hover`),i&&t.add(`${i.id}-selected`),this.memoryManager.clearRegistryExcept(t)}hideOverlay(){this.svg&&(this.svg.style.opacity="0",this.svg.style.visibility="hidden",this.svg.style.pointerEvents="none")}showOverlay(){this.svg&&(this.svg.style.opacity="1",this.svg.style.visibility="visible",this.svg.style.pointerEvents="auto")}pauseUpdates(){console.log("🔧 NativeHotspotRenderer: pauseUpdates called"),this.renderOptimizer.pauseUpdates()}resumeUpdates(){console.log("🔧 NativeHotspotRenderer: resumeUpdates called");const t=this.renderOptimizer.resumeUpdates();console.log("🔧 NativeHotspotRenderer: Updates resumed after cinematic zoom"),t&&setTimeout(()=>this.updateVisibility(),50),setTimeout(()=>{if(this.viewer&&this.viewer.tracking&&(console.log("🔄 Re-enabling viewer mouse tracking"),this.viewer.setMouseNavEnabled(!0),this.eventCoordinator&&this.eventCoordinator.forceReactivateMouseTracking&&this.eventCoordinator.forceReactivateMouseTracking(),this.svg&&window.lastKnownMouseX!==void 0)){const e=new MouseEvent("mousemove",{view:window,bubbles:!0,cancelable:!0,clientX:window.lastKnownMouseX,clientY:window.lastKnownMouseY});console.log("🔄 Dispatching synthetic mousemove to SVG"),this.svg.dispatchEvent(e)}},200)}refreshAllHotspotStyles(){console.log("Refreshing all hotspot styles with palette:",this.currentPalette),this.stateManager.getAllOverlays().forEach((t,e)=>{if(t.isVisible){const i=this.stateManager.getSelectedHotspot(),s=this.stateManager.getHoveredHotspot(),o=e===(i==null?void 0:i.id)?"selected":e===(s==null?void 0:s.id)?"hover":"normal";o!=="normal"&&(this.applyStyle(t.element,t.hotspot.type,"normal"),setTimeout(()=>{this.applyStyle(t.element,t.hotspot.type,o)},50))}}),this.updateFilterColors(),this.updateWrapperStyles()}updateWrapperStyles(){this.isSafari}updateFilterColors(){const t=this.svg.querySelector('#hotspot-glow-selected feFlood[result="innerColor"]'),e=this.svg.querySelector('#hotspot-glow-selected feFlood[result="outerColor"]'),i=this.svg.querySelector('#hotspot-glow-selected feFlood[result="midColor"]'),s=this.svg.querySelector('#hotspot-glow-hover feFlood[result="innerColor"]'),o=this.svg.querySelector('#hotspot-glow-hover feFlood[result="outerColor"]');t&&t.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),e&&e.setAttribute("flood-color",this.colorScheme.glow2||"#4682B4"),i&&i.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),s&&s.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),o&&o.setAttribute("flood-color",this.colorScheme.main||"#4682B4")}getHotspotBounds(t){const e=this.stateManager.getOverlay(t.id);return e&&e.bounds?e.bounds:ht(t.coordinates)}getAnimationDuration(t){var u,w,S;console.log("[NativeHotspotRenderer] getAnimationDuration called for:",t);const e=this.currentEasingName&&this.currentEasingName.toLowerCase().includes("organic");let i=1;if(t&&this.stateManager){const f=this.stateManager.getOverlay(t);if(f&&f.element){const b=f.element.querySelector("path");if(b)try{const H=b.getTotalLength();i=Math.min(Math.max(H/400,.8),1.5)}catch{}}}const a=(((w=(u=this.viewer)==null?void 0:u.viewport)==null?void 0:w.getZoom())||1)/10*100;let n,l;a<50?(n=e?.8:.6,l="exploration"):a<200?(n=e?1.2:.9,l="navigation"):(n=e?1.8:1.2,l="detail");const r=(f,b,H)=>{const E=Math.max(0,Math.min(1,(H-f)/(b-f)));return E*E*(3-2*E)};let c=1;a>=40&&a<=60?c=1+r(40,60,a)*.2:a>=180&&a<=220&&(c=1+r(180,220,a)*.2);const d=((S=this.stateManager)==null?void 0:S.getVisibleCount())||0,m=Math.max(.7,1-d/200*.3),g=window.animationSpeedMultiplier||1,y=n*c*i*m*g,v=Math.max(.4,Math.min(5,y));return console.log(`[Animation Duration] Mode: ${l}, Zoom: ${a.toFixed(0)}%, Duration: ${(v*1e3).toFixed(0)}ms, Base: ${(n*1e3).toFixed(0)}ms`),v}calculateGlowIntensity(){return 1}optimizeForSafari(){/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&this.stateManager.getAllOverlays().forEach(e=>{const i=e.element.getElementsByTagName("path");for(let s of i)s.style.transform="translateZ(0)",s.style.webkitBackfaceVisibility="hidden"})}startVisibilityTracking(){this.renderOptimizer.setupVisibilityTracking(()=>this.updateVisibility())}updateVisibility(){if(this.renderOptimizer.areUpdatesPaused()){this.renderOptimizer.setPendingUpdate();return}if(this.interactionThrottler&&this.interactionThrottler.shouldSkipFrame()){this.renderOptimizer.setPendingUpdate();return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.zoomSpring.target.value;if(Math.abs(t-e)>.001){this.renderOptimizer.setPendingUpdate();return}if(this.viewer.isAnimating()){this.renderOptimizer.setPendingUpdate();return}const s=this.viewer.viewport.getBounds();if(!this.renderOptimizer.hasViewportChangedSignificantly(s,t))return;this.renderOptimizer.updateViewportTracking(s,t),this.engine.eventCoordinator&&this.engine.eventCoordinator.updateHoverDelayForZoom(t);const o=this.viewer.viewport,a=o.getZoom();if(this.engine.lodManager&&window.performanceMonitor){const f=window.performanceMonitor.currentFPS,b=window.performanceMonitor.memoryUsage||0;this.engine.lodManager.updatePerformanceMode(f,b)}if(a<1.5){const f=this.stateManager.getSelectedHotspot(),b=this.stateManager.getHoveredHotspot(),H=f==null?void 0:f.id,E=b==null?void 0:b.id,I=[];H&&I.push(H),E&&E!==H&&I.push(E),this.activeHotspotManager.updateActiveSet(I);const T=I.map(P=>({id:P,isVisible:!0}));T.length>0&&this.stateManager.batchUpdateVisibility(T);return}const n=Array.from(this.stateManager.getAllOverlays().values()).map(f=>({...f.hotspot,overlay:f})),l=this.stateManager.getSelectedHotspot(),r=!!l;let c;if(r){console.log("🎯 Spotlight mode active - overriding LOD to show nearby hotspots");const f=this.stateManager.getOverlay(l.id);if(f){const b=f.bounds,H=(b.left+b.right)/2,E=(b.top+b.bottom)/2,I=n.filter(T=>{if(T.id===l.id)return!0;const P=T.overlay.bounds,_=(P.left+P.right)/2,U=(P.top+P.bottom)/2,A=_-H,x=U-E,C=Math.sqrt(A*A+x*x),$=2e3/Math.max(1,a);return C<$}).slice(0,50);c=I,console.log(`🎯 Spotlight mode: showing ${I.length} nearby hotspots for hover interaction`)}else c=this.engine.lodManager.selectVisibleHotspots(n,o,a,l,this.stateManager.getHoveredHotspot())}else c=this.engine.lodManager.selectVisibleHotspots(n,o,a,this.stateManager.getSelectedHotspot(),this.stateManager.getHoveredHotspot());console.log(`[NativeHotspotRenderer] Active: ${c.length} | Total: ${n.length} | Zoom: ${a.toFixed(2)} | Spotlight: ${r}`);const d=c.map(f=>f.id);this.activeHotspotManager.updateActiveSet(d);const m=this.activeHotspotManager.getActiveHotspots(),g=[];m.forEach((f,b)=>{g.push({id:b,isVisible:!0})}),g.length>0&&this.stateManager.batchUpdateVisibility(g),this.asyncHitDetector.updateVisibleHotspots(m),this.revealRenderer.isActive()&&this.revealRenderer.updateVisibility(m);const y=m.size;Math.abs(t-this.renderOptimizer.lastViewportZoom)>.5&&requestAnimationFrame(()=>{this.viewer.world.getItemCount()>0&&this.viewer.updateOverlay(this.svg)});const v=this.stateManager.getSelectedHotspot(),u=this.stateManager.getHoveredHotspot(),w=[];v!=null&&v.id&&w.push(v.id),u!=null&&u.id&&u.id!==(v==null?void 0:v.id)&&w.push(u.id),w.length>0&&this.activeHotspotManager.forceShowHotspots(w);const S=Date.now();if(!this._lastStatsLog||S-this._lastStatsLog>2e3){this._lastStatsLog=S;const f=this.activeHotspotManager.getStats();console.log(`[LOD+Active] Active: ${f.activeHotspots} | Total: ${f.totalHotspots} | Zoom: ${t.toFixed(2)} | Visible: ${y}`)}y>N.HIGH_HOTSPOT_COUNT_THRESHOLD&&this.animationQueue&&(this.animationQueue.clearFinished(),this.animationQueue.running.size>N.MAX_CONCURRENT_ANIMATIONS&&(this.animationQueue.clear(),console.log("Animation queue cleared due to high hotspot count"))),this.checkPerformanceMode()}forceIOSRedraw(){this.isMobile&&this.viewer&&this.svg&&(this.svg.style.display="none",this.svg.offsetHeight,this.svg.style.display="",this.viewer.updateOverlay(this.svg))}checkPerformanceMode(){const t=this.stateManager.getVisibleCount();this.renderOptimizer.checkPerformanceMode(t,this.svg)}updateVisibilityLazy(){if(this.renderOptimizer.areUpdatesPaused())return;const t=this.viewer.viewport;if(t.getZoom(),this.viewer.isAnimating()){setTimeout(()=>this.updateVisibilityLazy(),100);return}const e=t.getBounds(),i=t.viewportToImageCoordinates(e.getTopLeft()),s=t.viewportToImageCoordinates(e.getBottomRight()),o={minX:i.x,minY:i.y,maxX:s.x,maxY:s.y},a=(o.maxX-o.minX)*.2;Object.keys(o).forEach(g=>{o[g]+=g.startsWith("min")?-a:a});const n=Array.from(this.stateManager.getAllOverlays().entries());let l=0,r=0;const c=30,d=[],m=()=>{const g=performance.now();for(r=0;l<n.length&&r<c&&performance.now()-g<8;){const[y,v]=n[l],u=this.boundsIntersect(v.bounds,o);u!==v.isVisible&&(v.element.style.opacity=u?"1":"0",d.push({id:y,isVisible:u})),l++,r++}l<n.length?"requestIdleCallback"in window?requestIdleCallback(()=>m(),{timeout:50}):requestAnimationFrame(m):(d.length>0&&this.stateManager.batchUpdateVisibility(d),this.viewer.world.getItemCount()>0&&requestAnimationFrame(()=>{this.viewer.updateOverlay(this.svg)}))};"requestIdleCallback"in window?requestIdleCallback(()=>m(),{timeout:100}):setTimeout(()=>requestAnimationFrame(m),50)}boundsIntersect(t,e){return!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)}setupRevealMode(){this.revealRenderer.setupTriggers()}toggleRevealMode(){this.revealRenderer.isActive()?this.revealRenderer.deactivate():this.revealRenderer.activate()}enable(){this.enabled=!0,console.log("NativeHotspotRenderer enabled"),this.stateManager.getAllOverlays().forEach(t=>{t.element&&(t.element.style.display="")}),this.renderOptimizer&&this.renderOptimizer.resumeUpdates()}disable(){this.enabled=!1,console.log("NativeHotspotRenderer disabled"),this.stateManager.getAllOverlays().forEach(t=>{t.element&&(t.element.style.display="none")}),this.renderOptimizer&&this.renderOptimizer.pauseUpdates()}setVisualSelectedState(t){if(!t)return;console.log("🎨 Setting visual selected state for:",t.id);const e=this.stateManager.getOverlay(t.id);if(!e||!e.element){console.warn("🚨 Cannot set visual state - overlay not found for:",t.id);return}this.styleManager&&this.styleManager.applyStyle(e.element,t.type,"selected"),this.stateManager.setSelectedHotspot(t),console.log("✅ Visual selected state applied for:",t.id)}destroy(){console.log("Destroying NativeHotspotRenderer"),this.animationQueue&&this.animationQueue.clear(),this.revealRenderer&&this.revealRenderer.destroy(),this.temporalRenderer&&this.temporalRenderer.destroy(),this.memoryManager&&this.memoryManager.destroy(),this.renderOptimizer&&this.renderOptimizer.destroy(),this.stateManager.getAllOverlays().forEach(t=>{const e=t.element.getElementsByTagName("path");for(let i of e)i.currentAnimation&&i.currentAnimation.cancel(),i.getAnimations().forEach(s=>s.cancel())}),this.hitDetectionCanvas&&typeof this.hitDetectionCanvas.destroy=="function"&&this.hitDetectionCanvas.destroy(),this.engine&&this.engine.destroy(),this.styleManager&&this.styleManager.destroy(),this.modeStateManager&&this.modeStateManager.destroy(),this.eventCoordinator&&this.eventCoordinator.destroy(),this.stateManager&&this.stateManager.clear(),window.debugNativeRenderer&&delete window.debugNativeRenderer,window.nativeHotspotRenderer===this&&delete window.nativeHotspotRenderer}};W(N,"MAX_CONCURRENT_ANIMATIONS",15),W(N,"MAX_CONCURRENT_ANIMATIONS_MOBILE",8),W(N,"HIGH_HOTSPOT_COUNT_THRESHOLD",100);let J=N;function jt(h,t,e,i,s){h.drawer&&h.drawer.getType&&h.drawer.getType()!=="webgl"&&h.addHandler("tile-drawing",n=>{h.drawer&&h.drawer.context&&(h.drawer.context.imageSmoothingEnabled=!0);const l=h.viewport.getZoom();n.tile;const r=n.tile.size;if(n.tile.level,l<1&&r*l<16){n.preventDefaultAction=!0;return}}),h.addHandler("open",()=>{if(q()){let r=0;const c=33;h.addHandler("update-viewport",d=>{const m=performance.now();if(h.isAnimating()&&m-r<c){d.preventDefaultAction=!0;return}r=m})}h.viewport.minZoomLevel=.8,h.viewport.minZoomImageRatio=.5,q()&&(h.viewport.minZoomLevel=.5,h.viewport.minZoomImageRatio=.3),Xt(h),Yt(h,O),h.viewport.minZoomLevel=.8,h.viewport.minZoomImageRatio=.5,console.log("Viewer ready - initializing systems"),console.log("Using drawer:",h.drawer.getType?h.drawer.getType():"canvas");const l=h.world.getItemAt(0).getBounds();h.viewport.fitBounds(l,!0),h.viewport.applyConstraints(!0),q()&&setTimeout(()=>{const r=h.world.getItemAt(0);if(r){const c=r.getBounds();h.viewport.fitBoundsWithConstraints(c,!1)}},100),setTimeout(()=>qt(h,t,e,i),100)}),h.addHandler("zoom",()=>{e.tileCleanupManager&&e.tileCleanupManager.setPressure("normal"),t.isZoomingToHotspot()&&h.imageLoader&&h.imageLoader.clear()}),h.addHandler("pan",()=>{e.tileCleanupManager&&e.tileCleanupManager.setPressure("normal")}),h.addHandler("tile-loaded",n=>{var l;if(n.tile&&e.tileOptimizer){const r=n.tile.loadTime||((l=n.tiledImage)==null?void 0:l.lastResetTime)||100;e.tileOptimizer.trackLoadTime(r);const c=`${n.tile.level||0}_${n.tile.x||0}_${n.tile.y||0}`;e.tileOptimizer.loadingTiles.delete(c)}}),h.addHandler("animation",()=>{if(e.performanceMonitor){const n=e.performanceMonitor.getMetrics();if(n.averageFPS<O.debug.warnThreshold.fps){const l=ft(n.averageFPS,n.memoryUsage);if(e.tileCleanupManager){const r={emergency:"critical",critical:"critical",reduced:"high","memory-limited":"high",normal:"normal"};e.tileCleanupManager.setPressure(r[l]||"normal")}}}}),h.addHandler("animation-finish",()=>{console.log("animation-finish fired",{isZoomingToHotspot:t.isZoomingToHotspot(),isExpandingToFullView:t.isExpandingToFullView()}),t.isZoomingToHotspot()&&(console.log("animation-finish: Setting isZoomingToHotspot to false"),t.setIsZoomingToHotspot(!1),e.renderer&&(console.log("animation-finish: Calling resumeUpdates"),e.renderer.resumeUpdates(),e.renderer.updateVisibility()),e.renderOptimizer&&e.renderOptimizer.endCinematicZoom(),setTimeout(()=>{window.lastKnownMouseX!==void 0&&e.renderer&&(console.log("Forcing hover re-evaluation after zoom animation"),e.renderer.eventCoordinator&&e.renderer.eventCoordinator.forceReactivateMouseTracking&&e.renderer.eventCoordinator.forceReactivateMouseTracking())},300))}),h.addHandler("animation-start",n=>{t.isZoomingToHotspot()&&e.tileCleanupManager&&e.tileCleanupManager.pauseCleanup(3e3)});const o=()=>{let n;n&&clearTimeout(n),n=setTimeout(()=>{Ut(()=>{const{viewportManager:l,spatialIndex:r,audioEngine:c}=e;if(!l||!r||!c)return;const d=l.getCurrentViewport(),m=r.queryViewport(d.bounds,d.zoom);c.preloadHotspots(m)})},O.viewport.updateDebounce)};h.addHandler("viewport-change",o);let a=!1;h.addHandler("animation-start",()=>{q()&&(t.isZoomingToHotspot()||t.isExpandingToFullView())&&(a=!0,h.removeHandler("viewport-change",o))}),h.addHandler("animation-finish",()=>{a&&(a=!1,h.addHandler("viewport-change",o),setTimeout(o,100))}),h.addHandler("canvas-click",n=>{!n.preventDefaultAction&&e.renderer&&n.quick&&(e.renderer&&e.renderer.stateManager&&(e.renderer.stateManager.getAllOverlays().forEach(l=>{if(l.element){l.element.removeAttribute("data-hover-preserved"),l.element.removeAttribute("data-hover-maintained");const r=l.element.getAttribute("data-current-state"),c=e.renderer.stateManager.getHoveredHotspot(),d=l.element.getAttribute("data-hotspot-id");r==="hover"&&(!c||c.id!==d)&&e.renderer.styleManager&&e.renderer.styleManager.applyStyle(l.element,"standard","normal")}}),e.renderer.isAutoDeselecting&&(e.renderer.isAutoDeselecting=!1),e.renderer.recentlyAutoDeselected&&(console.log("🗑️ Clearing recentlyAutoDeselected on canvas click:",e.renderer.recentlyAutoDeselected),e.renderer.recentlyAutoDeselected=null,e.renderer._recentlyAutoDeselectedClearTimeout&&(clearTimeout(e.renderer._recentlyAutoDeselectedClearTimeout),e.renderer._recentlyAutoDeselectedClearTimeout=null))),e.renderer.selectedHotspot&&(e.renderer.selectedHotspot=null,t.setSelectedHotspot(null),e.overlayManager&&e.overlayManager.selectHotspot(null)))}),q()&&h.addHandler("canvas-click",n=>{const l=h.container.clientWidth,r=h.container.clientHeight,c=100,d=n.position.x<c&&n.position.y<c,m=n.position.x>l-c&&n.position.y<c,g=n.position.x<c&&n.position.y>r-c,y=n.position.x>l-c&&n.position.y>r-c;if(d||m||g||y){const v=t.tapCount()+1;if(t.setTapCount(v),t.tapTimeout()&&clearTimeout(t.tapTimeout()),v>=3){const w=t.debugLevel()===0?1:0;t.setDebugLevel(w),localStorage.setItem("debugLevel",w.toString()),e.performanceMonitor&&e.performanceMonitor.disableDebugOverlay(),console.log(`Debug mode: ${w===1?"ON":"OFF"}`),t.setTapCount(0)}else t.setTapTimeout(setTimeout(()=>{t.setTapCount(0)},1e3))}})}function te(h,t){const e={centerX:h.viewport.centerSpringX.springStiffness,centerY:h.viewport.centerSpringY.springStiffness,zoom:h.viewport.zoomSpring.springStiffness};h.addHandler("zoom-click",i=>{if(i.quick)return;const s=h.viewport.getZoom(),o=i.zoom,a=Math.abs(Math.log2(o)-Math.log2(s)),n=Math.min(.8,.3+a*.15);h.viewport.zoomSpring.animationTime=n;const l=Math.max(4,8-a);h.viewport.zoomSpring.springStiffness=l,setTimeout(()=>{h.viewport.zoomSpring.animationTime=t.viewer.animationTime,h.viewport.zoomSpring.springStiffness=e.zoom},n*1e3+100)})}function ee(h,t,e){const i={"+":()=>h.viewport.zoomBy(O.viewer.zoomPerScroll),"=":()=>h.viewport.zoomBy(O.viewer.zoomPerScroll),"-":()=>h.viewport.zoomBy(1/O.viewer.zoomPerScroll),_:()=>h.viewport.zoomBy(1/O.viewer.zoomPerScroll),0:()=>{var o;(o=window.animations)!=null&&o.expandToFullView&&window.animations.expandToFullView()},f:()=>h.viewport.fitBounds(h.world.getHomeBounds()),F:()=>h.viewport.fitBounds(h.world.getHomeBounds()),c:()=>{if(q())return;const a=t.debugLevel()===0?1:0;t.setDebugLevel(a),localStorage.setItem("debugLevel",a.toString()),e.performanceMonitor&&e.performanceMonitor.disableDebugOverlay(),e.renderer&&e.renderer.setDebugMode(a===1),console.log(`Debug mode: ${a===1?"ON":"OFF"}`)},h:()=>{e.renderer&&e.renderer.toggleRevealMode()},H:()=>{e.renderer&&e.renderer.toggleRevealMode()},e:()=>{e.echoController&&(e.echoController.config.enabled?(e.echoController.disable(),console.log("Temporal Echo mode: OFF")):(e.echoController.enable(),console.log("Temporal Echo mode: ON")))},E:()=>{e.echoController&&(e.echoController.config.enabled?(e.echoController.disable(),console.log("Temporal Echo mode: OFF")):(e.echoController.enable(),console.log("Temporal Echo mode: ON")))}},s=o=>{const a=document.activeElement;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.contentEditable==="true"))return;const n=i[o.key];n&&h&&(o.preventDefault(),n(),h.viewport.applyConstraints())};return window.addEventListener("keydown",s),s}function ie(h,t,e){const i=new ResizeObserver(s=>{if(!(!(t!=null&&t.viewport)||!t.isOpen()))for(let o of s){const{width:a,height:n}=o.contentRect;a>0&&n>0&&requestAnimationFrame(()=>{try{t&&t.viewport&&t.isOpen()&&(t.viewport.resize(),t.viewport.applyConstraints(),t.forceRedraw())}catch(l){l.message&&!l.message.includes("undefined")&&console.warn("Resize error:",l)}})}});i.observe(h),e.setComponents(s=>({...s,resizeObserver:i}))}function Ut(h){"requestIdleCallback"in window?requestIdleCallback(h,{timeout:200}):setTimeout(h,50)}function Xt(h){h.addHandler("zoom",t=>{h.drawer&&h.drawer.context&&(h.drawer.context.imageSmoothingEnabled=!0,h.drawer.imageSmoothingEnabled=!0)}),h.addHandler("pan",()=>{h.drawer&&h.drawer.context&&(h.drawer.context.imageSmoothingEnabled=!0,h.drawer.imageSmoothingEnabled=!0)}),h.addHandler("viewport-change",()=>{h.drawer&&h.drawer.context&&(h.drawer.context.imageSmoothingEnabled=!0,h.drawer.imageSmoothingEnabled=!0)})}function Yt(h,t,e){let i=null,s=null,o="idle",a=0,n=null;h.addHandler("zoom",l=>{const r=h.viewport.getZoom();a++,n&&clearTimeout(n),(!s||Math.abs(r-s)>.01)&&(o==="idle"?(o="accelerating",i=performance.now(),h.viewport.centerSpringX.animationTime=.4,h.viewport.centerSpringY.animationTime=.4,h.viewport.zoomSpring.animationTime=.4,h.imageLoader&&a>3&&(h.imageLoader.jobLimit=Math.max(2,h.imageLoader.jobLimit-1))):o==="accelerating"&&a>5&&(o="cruising",h.viewport.zoomSpring.animationTime=.2,h.imageLoader&&(h.imageLoader.jobLimit=2)),s=r),n=setTimeout(()=>{o!=="idle"&&(o="decelerating",h.viewport.centerSpringX.animationTime=.3,h.viewport.centerSpringY.animationTime=.3,h.viewport.zoomSpring.animationTime=.3,h.imageLoader&&(h.imageLoader.jobLimit=3),setTimeout(()=>{o="idle",a=0,h.imageLoader&&(h.imageLoader.jobLimit=t.viewer.imageLoaderLimit),h.forceRedraw(),i&&(performance.now()-i,i=null)},200))},100)})}async function qt(h,t,e,i,s){if(!h)return;const o={viewer:h,OpenSeadragon:k,spatialIndex:e.spatialIndex,onHotspotHover:t.setHoveredHotspot,onHotspotClick:i,visibilityCheckInterval:O.hotspots.visibilityCheckInterval,batchSize:O.hotspots.batchSize,renderDebounceTime:O.hotspots.renderDebounceTime,maxVisibleHotspots:O.hotspots.maxVisibleHotspots,minZoomForHotspots:O.hotspots.minZoomForHotspots,debugMode:t.debugLevel()===2},a=new J(o);if(window.nativeHotspotRenderer=a,t.setModeStateManager(a.modeStateManager),a.eventCoordinator){const r=(await lt(async()=>{const{default:d}=await import("./TemporalEchoController-BQiadO8m.js");return{default:d}},__vite__mapDeps([2,0,1]))).default,c=new r({viewer:h,eventCoordinator:a.eventCoordinator,hotspotRenderer:a,stateManager:a.stateManager,spatialIndex:e.spatialIndex,enabled:!0});e.echoController=c,a.echoController=c,window.temporalEchoController=c,console.log("[ViewerEventHandlers] Temporal Echo Controller initialized")}const n=ut.createWithOverride(h);n.initialize(),window.overlayManager=n,n.constructor.name==="Canvas2DOverlayManager"&&(console.log("[ViewerEventHandlers] Setting up Canvas2D spotlight callback"),n.onSpotlightCleared=()=>{console.log("📱 [DESELECT] Canvas2D spotlight cleared - triggering deselection"),a&&a.instantDeselect&&a.instantDeselect()});const l=a.onHotspotClick;a.onHotspotClick=r=>{if(l(r),n&&n.selectHotspot){let c={};if(a&&r){const d=a.getAnimationDuration?a.getAnimationDuration(r.id):.8,m=a.timingEasing||"cubic-bezier(0.25, 0.40, 0.40, 0.90)";c={duration:d,timingEasing:m}}n.selectHotspot(r,c)}},window.nativeHotspotRenderer=a,t.setComponents(r=>({...r,renderer:a,overlayManager:n})),console.log("Using NativeHotspotRenderer for hotspot rendering"),console.log(`Using ${n.constructor.name} for overlay effects`)}export{te as setupAdaptiveSprings,ee as setupKeyboardHandler,ie as setupResizeObserver,jt as setupViewerEventHandlers};
