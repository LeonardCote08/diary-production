var Du=Object.defineProperty;var Mu=(s,t,e)=>t in s?Du(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var Is=(s,t,e)=>Mu(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const ku=!1,Ou=(s,t)=>s===t,Fu=Symbol("solid-track"),kr={equals:Ou};let fc=vc;const vi=1,Or=2,pc={owned:null,cleanups:null,context:null,owner:null};var Je=null;let Rs=null,Lu=null,Xe=null,vt=null,Kt=null,$r=0;function Pr(s,t){const e=Xe,i=Je,n=s.length===0,r=t===void 0?i:t,o=n?pc:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>Qt(()=>Bn(o)));Je=o,Xe=null;try{return Yn(a,!0)}finally{Xe=e,Je=i}}function me(s,t){t=t?Object.assign({},kr,t):kr;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),gc(e,n));return[mc.bind(e),i]}function st(s,t,e){const i=vo(s,t,!1,vi);Xn(i)}function Si(s,t,e){fc=Nu;const i=vo(s,t,!1,vi);i.user=!0,Kt?Kt.push(i):Xn(i)}function Dn(s,t,e){e=e?Object.assign({},kr,e):kr;const i=vo(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,Xn(i),mc.bind(i)}function Qt(s){if(Xe===null)return s();const t=Xe;Xe=null;try{return s()}finally{Xe=t}}function go(s){Si(()=>Qt(s))}function Vn(s){return Je===null||(Je.cleanups===null?Je.cleanups=[s]:Je.cleanups.push(s)),s}function mc(){if(this.sources&&this.state)if(this.state===vi)Xn(this);else{const s=vt;vt=null,Yn(()=>Lr(this),!1),vt=s}if(Xe){const s=this.observers?this.observers.length:0;Xe.sources?(Xe.sources.push(this),Xe.sourceSlots.push(s)):(Xe.sources=[this],Xe.sourceSlots=[s]),this.observers?(this.observers.push(Xe),this.observerSlots.push(Xe.sources.length-1)):(this.observers=[Xe],this.observerSlots=[Xe.sources.length-1])}return this.value}function gc(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&Yn(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=Rs&&Rs.running;o&&Rs.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?vt.push(r):Kt.push(r),r.observers&&yc(r)),o||(r.state=vi)}if(vt.length>1e6)throw vt=[],new Error},!1)),t}function Xn(s){if(!s.fn)return;Bn(s);const t=$r;Vu(s,s.value,t)}function Vu(s,t,e){let i;const n=Je,r=Xe;Xe=Je=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=vi,s.owned&&s.owned.forEach(Bn),s.owned=null),s.updatedAt=e+1,wc(o)}finally{Xe=r,Je=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?gc(s,i):s.value=i,s.updatedAt=e)}function vo(s,t,e,i=vi,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:Je,context:Je?Je.context:null,pure:e};return Je===null||Je!==pc&&(Je.owned?Je.owned.push(r):Je.owned=[r]),r}function Fr(s){if(s.state===0)return;if(s.state===Or)return Lr(s);if(s.suspense&&Qt(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<$r);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===vi)Xn(s);else if(s.state===Or){const i=vt;vt=null,Yn(()=>Lr(s,t[0]),!1),vt=i}}function Yn(s,t){if(vt)return s();let e=!1;t||(vt=[]),Kt?e=!0:Kt=[],$r++;try{const i=s();return Bu(e),i}catch(i){e||(Kt=null),vt=null,wc(i)}}function Bu(s){if(vt&&(vc(vt),vt=null),s)return;const t=Kt;Kt=null,t.length&&Yn(()=>fc(t),!1)}function vc(s){for(let t=0;t<s.length;t++)Fr(s[t])}function Nu(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:Fr(i)}for(t=0;t<e;t++)Fr(s[t])}function Lr(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===vi?i!==t&&(!i.updatedAt||i.updatedAt<$r)&&Fr(i):n===Or&&Lr(i,t)}}}function yc(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=Or,e.pure?vt.push(e):Kt.push(e),e.observers&&yc(e))}}function Bn(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)Bn(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)Bn(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function Hu(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function wc(s,t=Je){throw Hu(s)}const zu=Symbol("fallback");function ja(s){for(let t=0;t<s.length;t++)s[t]()}function Uu(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return Vn(()=>ja(r)),()=>{let c=s()||[],h=c.length,d,l;return c[Fu],Qt(()=>{let p,m,v,w,x,R,L,j,G;if(h===0)o!==0&&(ja(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[zu],n[0]=Pr(J=>(r[0]=J,e.fallback())),o=1);else if(o===0){for(n=new Array(h),l=0;l<h;l++)i[l]=c[l],n[l]=Pr(f);o=h}else{for(v=new Array(h),w=new Array(h),a&&(x=new Array(h)),R=0,L=Math.min(o,h);R<L&&i[R]===c[R];R++);for(L=o-1,j=h-1;L>=R&&j>=R&&i[L]===c[j];L--,j--)v[j]=n[L],w[j]=r[L],a&&(x[j]=a[L]);for(p=new Map,m=new Array(j+1),l=j;l>=R;l--)G=c[l],d=p.get(G),m[l]=d===void 0?-1:d,p.set(G,l);for(d=R;d<=L;d++)G=i[d],l=p.get(G),l!==void 0&&l!==-1?(v[l]=n[d],w[l]=r[d],a&&(x[l]=a[d]),l=m[l],p.set(G,l)):r[d]();for(l=R;l<h;l++)l in v?(n[l]=v[l],r[l]=w[l],a&&(a[l]=x[l],a[l](l))):n[l]=Pr(f);n=n.slice(0,o=h),i=c.slice(0)}return n});function f(p){if(r[l]=p,a){const[m,v]=me(l);return a[l]=v,t(c[l],m)}return t(c[l])}}}function fe(s,t){return Qt(()=>s(t||{}))}const ju=s=>`Stale read from <${s}>.`;function qu(s){const t="fallback"in s&&{fallback:()=>s.fallback};return Dn(Uu(()=>s.each,s.children,t||void 0))}function ke(s){const t=s.keyed,e=Dn(()=>s.when,void 0,void 0),i=t?e:Dn(e,void 0,{equals:(n,r)=>!n==!r});return Dn(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?Qt(()=>r(t?n:()=>{if(!Qt(i))throw ju("Show");return e()})):r}return s.fallback},void 0,void 0)}const pt=s=>Dn(()=>s());function Wu(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,c=t[n-1].nextSibling,h=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const d=r<i?a?e[a-1].nextSibling:e[r-a]:c;for(;a<r;)s.insertBefore(e[a++],d)}else if(r===a)for(;o<n;)(!h||!h.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const d=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],d),t[n]=e[r]}else{if(!h){h=new Map;let l=a;for(;l<r;)h.set(e[l],l++)}const d=h.get(t[o]);if(d!=null)if(a<d&&d<r){let l=o,f=1,p;for(;++l<n&&l<r&&!((p=h.get(t[l]))==null||p!==d+f);)f++;if(f>d-a){const m=t[o];for(;a<d;)s.insertBefore(e[a++],m)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const qa="_$DX_DELEGATE";function Gu(s,t,e,i={}){let n;return Pr(r=>{n=r,t===document?s():se(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function ie(s,t,e,i){let n;const r=()=>{const a=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return a.innerHTML=s,e?a.content.firstChild.firstChild:i?a.firstChild:a.content.firstChild},o=t?()=>Qt(()=>document.importNode(n||(n=r()),!0)):()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function rn(s,t=window.document){const e=t[qa]||(t[qa]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,Xu))}}function Nt(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function Zi(s,t){t==null?s.removeAttribute("class"):s.className=t}function _c(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function Ds(s,t,e){if(!t)return e?Nt(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function Zu(s,t,e){return Qt(()=>s(t,e))}function se(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return Vr(s,t,i,e);st(n=>Vr(s,t(),n,e),i)}function Xu(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=c=>Object.defineProperty(s,"target",{configurable:!0,value:c}),o=()=>{const c=t[e];if(c&&!t.disabled){const h=t[`${e}Data`];if(h!==void 0?c.call(t,h,s):c.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const c=s.composedPath();r(c[0]);for(let h=0;h<c.length-2&&(t=c[h],!!o());h++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function Vr(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=Bi(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=Bi(s,e,i);else{if(r==="function")return st(()=>{let a=t();for(;typeof a=="function";)a=a();e=Vr(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],c=e&&Array.isArray(e);if(qs(a,t,e,n))return st(()=>e=Vr(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=Bi(s,e,i),o)return e}else c?e.length===0?Wa(s,a,i):Wu(s,e,a):(e&&Bi(s),Wa(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=Bi(s,e,i,t);Bi(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function qs(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],c=e&&e[s.length],h;if(!(a==null||a===!0||a===!1))if((h=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=qs(s,a,c)||n;else if(h==="function")if(i){for(;typeof a=="function";)a=a();n=qs(s,Array.isArray(a)?a:[a],Array.isArray(c)?c:[c])||n}else s.push(a),n=!0;else{const d=String(a);c&&c.nodeType===3&&c.data===d?s.push(c):s.push(document.createTextNode(d))}}return n}function Wa(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function Bi(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const c=a.parentNode===s;!r&&!o?c?s.replaceChild(n,a):s.insertBefore(n,e):c&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}var zi=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Yu(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Tc={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var c in o)a=c;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,c=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/c}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var c,h,d,l,f,p,m=arguments[0]||{},v=arguments.length,w=!1,x=1;for(typeof m=="boolean"&&(w=m,m=arguments[1]||{},x=2),typeof m!="object"&&!t.isFunction(m)&&(m={}),v===x&&(m=this,--x);x<v;x++)if(c=arguments[x],c!==null||c!==void 0)for(h in c){var R=Object.getOwnPropertyDescriptor(c,h);if(R!==void 0){if(R.get||R.set){Object.defineProperty(m,h,R);continue}l=R.value}else{e.console.warn('Could not copy inherited property "'+h+'".');continue}m!==l&&(w&&l&&(t.isPlainObject(l)||(f=t.isArray(l)))?(d=m[h],f?(f=!1,p=d&&t.isArray(d)?d:[]):p=d&&t.isPlainObject(d)?d:{},m[h]=t.extend(w,p,l)):l!==void 0&&(m[h]=l))}return m};var i=function(){if(typeof navigator!="object")return!1;var c=navigator.userAgent;return typeof c!="string"?!1:c.indexOf("iPhone")!==-1||c.indexOf("iPad")!==-1||c.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(c,h){return function(){var d=arguments;return d===void 0&&(d=[]),h.apply(c,d)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(c){return e._viewers.get(this.getElement(c))},getElement:function(c){return typeof c=="string"&&(c=document.getElementById(c)),c},getElementPosition:function(c){var h=new e.Point,d,l;for(c=e.getElement(c),d=e.getElementStyle(c).position==="fixed",l=a(c,d);l;)h.x+=c.offsetLeft,h.y+=c.offsetTop,d&&(h=h.plus(e.getPageScroll())),c=l,d=e.getElementStyle(c).position==="fixed",l=a(c,d);return h},getElementOffset:function(c){c=e.getElement(c);var h=c&&c.ownerDocument,d,l,f={top:0,left:0};return h?(d=h.documentElement,typeof c.getBoundingClientRect<"u"&&(f=c.getBoundingClientRect()),l=h===h.window?h:h.nodeType===9?h.defaultView||h.parentWindow:!1,new e.Point(f.left+(l.pageXOffset||d.scrollLeft)-(d.clientLeft||0),f.top+(l.pageYOffset||d.scrollTop)-(d.clientTop||0))):new e.Point},getElementSize:function(c){return c=e.getElement(c),new e.Point(c.clientWidth,c.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(c){return c=e.getElement(c),c.currentStyle}:function(c){return c=e.getElement(c),window.getComputedStyle(c,"")},getCssPropertyWithVendorPrefix:function(c){var h={};return e.getCssPropertyWithVendorPrefix=function(d){if(h[d]!==void 0)return h[d];var l=document.createElement("div").style,f=null;if(l[d]!==void 0)f=d;else for(var p=["Webkit","Moz","MS","O","webkit","moz","ms","o"],m=e.capitalizeFirstLetter(d),v=0;v<p.length;v++){var w=p[v]+m;if(l[w]!==void 0){f=w;break}}return h[d]=f,f},e.getCssPropertyWithVendorPrefix(c)},capitalizeFirstLetter:function(c){return c.charAt(0).toUpperCase()+c.slice(1)},positiveModulo:function(c,h){var d=c%h;return d<0&&(d+=h),d},pointInElement:function(c,h){c=e.getElement(c);var d=e.getElementOffset(c),l=e.getElementSize(c);return h.x>=d.x&&h.x<d.x+l.x&&h.y<d.y+l.y&&h.y>=d.y},getMousePosition:function(c){if(typeof c.pageX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.pageX,d.y=h.pageY,d};else if(typeof c.clientX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d.y=h.clientY+document.body.scrollTop+document.documentElement.scrollTop,d};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(c)},getPageScroll:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(h.scrollLeft||h.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(c.scrollLeft||c.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(c){if(typeof window.scrollTo<"u")e.setPageScroll=function(l){window.scrollTo(l.x,l.y)};else{var h=e.getPageScroll();if(h.x===c.x&&h.y===c.y)return;document.body.scrollLeft=c.x,document.body.scrollTop=c.y;var d=e.getPageScroll();if(d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.body.scrollLeft=l.x,document.body.scrollTop=l.y};return}if(document.documentElement.scrollLeft=c.x,document.documentElement.scrollTop=c.y,d=e.getPageScroll(),d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y};return}e.setPageScroll=function(l){}}e.setPageScroll(c)},getWindowSize:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(c.clientWidth||c.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(h.clientWidth||h.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(c){c=e.getElement(c);var h=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(h[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(h[1].style,{display:"table-row"}),e.extend(h[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),h[0].appendChild(h[1]),h[1].appendChild(h[2]),h[2].appendChild(c),h[0]},makeNeutralElement:function(c){var h=document.createElement(c),d=h.style;return d.background="transparent none",d.border="none",d.margin="0px",d.padding="0px",d.position="static",h},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(c){var h=e.makeNeutralElement("img");return h.src=c,h},setElementOpacity:function(c,h,d){var l,f;c=e.getElement(c),d&&!e.Browser.alpha&&(h=Math.round(h)),e.Browser.opacity?c.style.opacity=h<1?h:"":h<1?(l=Math.round(100*h),f="alpha(opacity="+l+")",c.style.filter=f):c.style.filter=""},setElementTouchActionNone:function(c){c=e.getElement(c),typeof c.style.touchAction<"u"?c.style.touchAction="none":typeof c.style.msTouchAction<"u"&&(c.style.msTouchAction="none")},setElementPointerEvents:function(c,h){c=e.getElement(c),typeof c.style<"u"&&typeof c.style.pointerEvents<"u"&&(c.style.pointerEvents=h)},setElementPointerEventsNone:function(c){e.setElementPointerEvents(c,"none")},addClass:function(c,h){c=e.getElement(c),c.className?(" "+c.className+" ").indexOf(" "+h+" ")===-1&&(c.className+=" "+h):c.className=h},indexOf:function(c,h,d){return Array.prototype.indexOf?this.indexOf=function(l,f,p){return l.indexOf(f,p)}:this.indexOf=function(l,f,p){var m,v=p||0,w;if(!l)throw new TypeError;if(w=l.length,w===0||v>=w)return-1;for(v<0&&(v=w-Math.abs(v)),m=v;m<w;m++)if(l[m]===f)return m;return-1},this.indexOf(c,h,d)},removeClass:function(c,h){var d,l=[],f;for(c=e.getElement(c),d=c.className.split(/\s+/),f=0;f<d.length;f++)d[f]&&d[f]!==h&&l.push(d[f]);c.className=l.join(" ")},normalizeEventListenerOptions:function(c){var h;return typeof c<"u"?typeof c=="boolean"?h=e.supportsEventListenerOptions?{capture:c}:c:h=e.supportsEventListenerOptions?c:typeof c.capture<"u"?c.capture:!1:h=e.supportsEventListenerOptions?{capture:!1}:!1,h},addEvent:function(){if(e.supportsAddEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.addEventListener(h,d,l)};if(document.documentElement.attachEvent&&document.attachEvent)return function(c,h,d){c=e.getElement(c),c.attachEvent("on"+h,d)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.removeEventListener(h,d,l)};if(document.documentElement.detachEvent&&document.detachEvent)return function(c,h,d){c=e.getElement(c),c.detachEvent("on"+h,d)};throw new Error("No known event model.")}(),cancelEvent:function(c){c.preventDefault()},eventIsCanceled:function(c){return c.defaultPrevented},stopEvent:function(c){c.stopPropagation()},createCallback:function(c,h){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var d=[],l;for(l=2;l<arguments.length;l++)d.push(arguments[l]);return function(){var f=d.concat([]),p;for(p=0;p<arguments.length;p++)f.push(arguments[p]);return h.apply(c,f)}},getUrlParameter:function(c){var h=o[c];return h||null},getUrlProtocol:function(c){var h=c.match(/^([a-z]+:)\/\//i);return h===null?window.location.protocol:h[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(c,h,d){var l,f,p,m;e.isPlainObject(c)&&(h=c.success,d=c.error,l=c.withCredentials,f=c.headers,p=c.responseType||null,m=c.postData||null,c=c.url);var v=e.getUrlProtocol(c),w=e.createAjaxRequest();if(!e.isFunction(h))throw new Error("makeAjaxRequest requires a success callback");w.onreadystatechange=function(){w.readyState===4&&(w.onreadystatechange=function(){},w.status>=200&&w.status<300||w.status===0&&v!=="http:"&&v!=="https:"?h(w):e.isFunction(d)?d(w):e.console.error("AJAX request returned %d: %s",w.status,c))};var x=m?"POST":"GET";try{if(w.open(x,c,!0),p&&(w.responseType=p),f)for(var R in f)Object.prototype.hasOwnProperty.call(f,R)&&f[R]&&w.setRequestHeader(R,f[R]);l&&(w.withCredentials=!0),w.send(m)}catch(L){e.console.error("%s while making AJAX request: %s",L.name,L.message),w.onreadystatechange=function(){},e.isFunction(d)&&d(w,L)}return w},jsonp:function(c){var h,d=c.url,l=document.head||document.getElementsByTagName("head")[0]||document.documentElement,f=c.callbackName||"openseadragon"+e.now(),p=window[f],m="$1"+f+"$2",v=c.param||"callback",w=c.callback;d=d.replace(/(=)\?(&|$)|\?\?/i,m),d+=(/\?/.test(d)?"&":"?")+v+"="+f,window[f]=function(x){if(p)window[f]=p;else try{delete window[f]}catch{}w&&e.isFunction(w)&&w(x)},h=document.createElement("script"),(c.async!==void 0||c.async!==!1)&&(h.async="async"),c.scriptCharset&&(h.charset=c.scriptCharset),h.src=d,h.onload=h.onreadystatechange=function(x,R){(R||!h.readyState||/loaded|complete/.test(h.readyState))&&(h.onload=h.onreadystatechange=null,l&&h.parentNode&&l.removeChild(h),h=void 0)},l.insertBefore(h,l.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(c){if(window.DOMParser)e.parseXml=function(h){var d=null,l;return l=new DOMParser,d=l.parseFromString(h,"text/xml"),d};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(c)},parseJSON:function(c){return e.parseJSON=window.JSON.parse,e.parseJSON(c)},imageFormatSupported:function(c){return c=c||"",!!r[c.toLowerCase()]},setImageFormatsSupported:function(c){e.extend(r,c)}});var n=function(c){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var c=navigator.appVersion,h=navigator.userAgent,d;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(h.substring(h.indexOf("MSIE")+5,h.indexOf(";",h.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(h.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edge")+5))):h.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edg")+4))):h.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(h.substring(h.indexOf("Firefox")+8))):h.indexOf("Safari")>=0?(e.Browser.vendor=h.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(h.substring(h.substring(0,h.indexOf("Safari")).lastIndexOf("/")+1,h.indexOf("Safari")))):(d=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),d.exec(h)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(c);break}var l=window.location.search.substring(1),f=l.split("&"),p,m,v;for(v=0;v<f.length;v++)if(p=f[v],m=p.indexOf("="),m>0){var w=p.substring(0,m),x=p.substring(m+1);try{o[w]=decodeURIComponent(x)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",w,x)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(c){var h=c.requestAnimationFrame||c.mozRequestAnimationFrame||c.webkitRequestAnimationFrame||c.msRequestAnimationFrame,d=c.cancelAnimationFrame||c.mozCancelAnimationFrame||c.webkitCancelAnimationFrame||c.msCancelAnimationFrame;if(h&&d)e.requestAnimationFrame=function(){return h.apply(c,arguments)},e.cancelAnimationFrame=function(){return d.apply(c,arguments)};else{var l=[],f=[],p=0,m;e.requestAnimationFrame=function(v){return l.push([++p,v]),m||(m=setInterval(function(){if(l.length){var w=e.now(),x=f;for(f=l,l=x;f.length;)f.shift()[1](w)}else clearInterval(m),m=void 0},1e3/50)),p},e.cancelAnimationFrame=function(v){var w,x;for(w=0,x=l.length;w<x;w+=1)if(l[w][0]===v){l.splice(w,1);return}for(w=0,x=f.length;w<x;w+=1)if(f[w][0]===v){f.splice(w,1);return}}}}(window);function a(c,h){return h&&c!==document.body?document.body:c.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(zi,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var c=o[0*3+0],h=o[0*3+1],d=o[0*3+2],l=o[1*3+0],f=o[1*3+1],p=o[1*3+2],m=o[2*3+0],v=o[2*3+1],w=o[2*3+2],x=a[0*3+0],R=a[0*3+1],L=a[0*3+2],j=a[1*3+0],G=a[1*3+1],J=a[1*3+2],M=a[2*3+0],A=a[2*3+1],C=a[2*3+2];return new i([x*c+R*l+L*m,x*h+R*f+L*v,x*d+R*p+L*w,j*c+G*l+J*m,j*h+G*f+J*v,j*d+G*p+J*w,M*c+A*l+C*m,M*h+A*f+C*v,M*d+A*p+C*w])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var c=this;o=o||1;var h=0,d=function(l){return h++,h===o&&c.removeHandler(i,d),n(l)};return this.addHandler(i,d,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var c=a.length,h={handler:n,userData:r||null,priority:o||0};for(a[c]=h;c>0&&a[c-1].priority<a[c].priority;)a[c]=a[c-1],a[c-1]=h,c--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,c=n.length;for(a=0;a<c;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(E){var T=arguments;e.isPlainObject(E)||(E={element:T[0],clickTimeThreshold:T[1],clickDistThreshold:T[2]}),this.hash=Math.random(),this.element=e.getElement(E.element),this.clickTimeThreshold=E.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=E.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=E.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=E.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=E.userData||null,this.stopDelay=E.stopDelay||50,this.preProcessEventHandler=E.preProcessEventHandler||null,this.contextMenuHandler=E.contextMenuHandler||null,this.enterHandler=E.enterHandler||null,this.leaveHandler=E.leaveHandler||null,this.exitHandler=E.exitHandler||null,this.overHandler=E.overHandler||null,this.outHandler=E.outHandler||null,this.pressHandler=E.pressHandler||null,this.nonPrimaryPressHandler=E.nonPrimaryPressHandler||null,this.releaseHandler=E.releaseHandler||null,this.nonPrimaryReleaseHandler=E.nonPrimaryReleaseHandler||null,this.moveHandler=E.moveHandler||null,this.scrollHandler=E.scrollHandler||null,this.clickHandler=E.clickHandler||null,this.dblClickHandler=E.dblClickHandler||null,this.dragHandler=E.dragHandler||null,this.dragEndHandler=E.dragEndHandler||null,this.pinchHandler=E.pinchHandler||null,this.stopHandler=E.stopHandler||null,this.keyDownHandler=E.keyDownHandler||null,this.keyUpHandler=E.keyUpHandler||null,this.keyHandler=E.keyHandler||null,this.focusHandler=E.focusHandler||null,this.blurHandler=E.blurHandler||null;var S=this;i[this.hash]={click:function(I){L(S,I)},dblclick:function(I){j(S,I)},keydown:function(I){G(S,I)},keyup:function(I){J(S,I)},keypress:function(I){M(S,I)},focus:function(I){A(S,I)},blur:function(I){C(S,I)},contextmenu:function(I){k(S,I)},wheel:function(I){F(S,I)},mousewheel:function(I){O(S,I)},DOMMouseScroll:function(I){O(S,I)},MozMousePixelScroll:function(I){O(S,I)},losecapture:function(I){z(S,I)},mouseenter:function(I){te(S,I)},mouseleave:function(I){Ge(S,I)},mouseover:function(I){ze(S,I)},mouseout:function(I){Ct(S,I)},mousedown:function(I){it(S,I)},mouseup:function(I){It(S,I)},mousemove:function(I){lt(S,I)},touchstart:function(I){xe(S,I)},touchend:function(I){Se(S,I)},touchmove:function(I){Me(S,I)},touchcancel:function(I){re(S,I)},gesturestart:function(I){ve(S,I)},gesturechange:function(I){we(S,I)},gotpointercapture:function(I){tt(S,I)},lostpointercapture:function(I){Fe(S,I)},pointerenter:function(I){te(S,I)},pointerleave:function(I){Ge(S,I)},pointerover:function(I){ze(S,I)},pointerout:function(I){Ct(S,I)},pointerdown:function(I){it(S,I)},pointerup:function(I){It(S,I)},pointermove:function(I){lt(S,I)},pointercancel:function(I){yt(S,I)},pointerupcaptured:function(I){Gt(S,I)},pointermovecaptured:function(I){ct(S,I)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),E.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){c(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(E){return E?a(this):c(this),this},getActivePointersListByType:function(E){var T=i[this.hash],S,I=T?T.activePointersLists.length:0,q;for(S=0;S<I;S++)if(T.activePointersLists[S].type===E)return T.activePointersLists[S];return q=new e.MouseTracker.GesturePointList(E),T&&T.activePointersLists.push(q),q},getActivePointerCount:function(){var E=i[this.hash],T,S=E.activePointersLists.length,I=0;for(T=0;T<S;T++)I+=E.activePointersLists[T].getLength();return I},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(E){try{return E.addEventListener&&E.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var E=[],T=0,S=0,I=function(Te,ae){return Te.hash.toString()+ae.type+ae.id.toString()},q=function(){var Te,ae=E.length,_e,Ae,bt=e.now(),Rt,Ft,Lt;for(Rt=bt-S,S=bt,Te=0;Te<ae;Te++)_e=E[Te],Ae=_e.gPoint,Ae.direction=Math.atan2(Ae.currentPos.y-_e.lastPos.y,Ae.currentPos.x-_e.lastPos.x),Ft=_e.lastPos.distanceTo(Ae.currentPos),_e.lastPos=Ae.currentPos,Lt=1e3*Ft/(Rt+1),Ae.speed=.75*Lt+.25*Ae.speed},Q=function(Te,ae){var _e=I(Te,ae);E.push({guid:_e,gPoint:ae,lastPos:ae.currentPos}),E.length===1&&(S=e.now(),T=window.setInterval(q,50))},ce=function(Te,ae){var _e=I(Te,ae),Ae,bt=E.length;for(Ae=0;Ae<bt;Ae++)if(E[Ae].guid===_e){E.splice(Ae,1),bt--,bt===0&&window.clearInterval(T);break}};return{addPoint:Q,removePoint:ce}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var E=document.createElement("div");return e.isFunction(E.setPointerCapture)&&e.isFunction(E.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var E=document.createElement("div");return e.isFunction(E.setCapture)&&e.isFunction(E.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(E){this._gPoints=[],this.type=E,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(E){return this._gPoints.push(E)},removeById:function(E){var T,S=this._gPoints.length;for(T=0;T<S;T++)if(this._gPoints[T].id===E){this._gPoints.splice(T,1);break}return this._gPoints.length},getByIndex:function(E){return E<this._gPoints.length?this._gPoints[E]:null},getById:function(E){var T,S=this._gPoints.length;for(T=0;T<S;T++)if(this._gPoints[T].id===E)return this._gPoints[T];return null},getPrimary:function(E){var T,S=this._gPoints.length;for(T=0;T<S;T++)if(this._gPoints[T].isPrimary)return this._gPoints[T];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(E){var T=i[E.hash],S,I,q,Q,ce,Te=T.activePointersLists.length;for(S=0;S<Te;S++)if(q=T.activePointersLists[S],q.getLength()>0){for(ce=[],Q=q.asArray(),I=0;I<Q.length;I++)ce.push(Q[I]);for(I=0;I<ce.length;I++)ht(E,q,ce[I])}for(S=0;S<Te;S++)T.activePointersLists.pop();T.sentDragEvent=!1}function a(E){var T=i[E.hash],S,I;if(!T.tracking){for(I=0;I<e.MouseTracker.subscribeEvents.length;I++)S=e.MouseTracker.subscribeEvents[I],e.addEvent(E.element,S,T[S],S===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(E),T.tracking=!0}}function c(E){var T=i[E.hash],S,I;if(T.tracking){for(I=0;I<e.MouseTracker.subscribeEvents.length;I++)S=e.MouseTracker.subscribeEvents[I],e.removeEvent(E.element,S,T[S],!1);o(E),T.tracking=!1}}function h(E,T){var S=i[E.hash];if(T==="pointerevent")return{upName:"pointerup",upHandler:S.pointerupcaptured,moveName:"pointermove",moveHandler:S.pointermovecaptured};if(T==="mouse")return{upName:"pointerup",upHandler:S.pointerupcaptured,moveName:"pointermove",moveHandler:S.pointermovecaptured};if(T==="touch")return{upName:"touchend",upHandler:S.touchendcaptured,moveName:"touchmove",moveHandler:S.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function d(E,T){var S;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{E.element.setPointerCapture(T.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else E.element.setCapture(!0);else S=h(E,e.MouseTracker.havePointerEvents?"pointerevent":T.type),n&&r(window.top)&&e.addEvent(window.top,S.upName,S.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,S.upName,S.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,S.moveName,S.moveHandler,!0);V(E,T,!0)}function l(E,T){var S,I,q;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(I=E.getActivePointersListByType(T.type),q=I.getById(T.id),!q||!q.captured)return;try{E.element.releasePointerCapture(T.id)}catch{}}else E.element.releaseCapture();else S=h(E,e.MouseTracker.havePointerEvents?"pointerevent":T.type),n&&r(window.top)&&e.removeEvent(window.top,S.upName,S.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,S.moveName,S.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,S.upName,S.upHandler,!0);V(E,T,!1)}function f(E){return e.MouseTracker.havePointerEvents?E.pointerId:e.MouseTracker.mousePointerId}function p(E){return e.MouseTracker.havePointerEvents&&E.pointerType?E.pointerType:"mouse"}function m(E){return e.MouseTracker.havePointerEvents?E.isPrimary:!0}function v(E){return e.getMousePosition(E)}function w(E,T){return x(v(E),T)}function x(E,T){var S=e.getElementOffset(T);return E.minus(S)}function R(E,T){return new e.Point((E.x+T.x)/2,(E.y+T.y)/2)}function L(E,T){var S={originalEvent:T,eventType:"click",pointerType:"mouse",isEmulated:!1};b(E,S),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(T),S.stopPropagation&&e.stopEvent(T)}function j(E,T){var S={originalEvent:T,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};b(E,S),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(T),S.stopPropagation&&e.stopEvent(T)}function G(E,T){var S=null,I={originalEvent:T,eventType:"keydown",pointerType:"",isEmulated:!1};b(E,I),E.keyDownHandler&&!I.preventGesture&&!I.defaultPrevented&&(S={eventSource:E,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:I.preventDefault||I.defaultPrevented,userData:E.userData},E.keyDownHandler(S)),(S&&S.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function J(E,T){var S=null,I={originalEvent:T,eventType:"keyup",pointerType:"",isEmulated:!1};b(E,I),E.keyUpHandler&&!I.preventGesture&&!I.defaultPrevented&&(S={eventSource:E,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:I.preventDefault||I.defaultPrevented,userData:E.userData},E.keyUpHandler(S)),(S&&S.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function M(E,T){var S=null,I={originalEvent:T,eventType:"keypress",pointerType:"",isEmulated:!1};b(E,I),E.keyHandler&&!I.preventGesture&&!I.defaultPrevented&&(S={eventSource:E,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:I.preventDefault||I.defaultPrevented,userData:E.userData},E.keyHandler(S)),(S&&S.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function A(E,T){var S={originalEvent:T,eventType:"focus",pointerType:"",isEmulated:!1};b(E,S),E.focusHandler&&!S.preventGesture&&E.focusHandler({eventSource:E,originalEvent:T,userData:E.userData})}function C(E,T){var S={originalEvent:T,eventType:"blur",pointerType:"",isEmulated:!1};b(E,S),E.blurHandler&&!S.preventGesture&&E.blurHandler({eventSource:E,originalEvent:T,userData:E.userData})}function k(E,T){var S=null,I={originalEvent:T,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};b(E,I),E.contextMenuHandler&&!I.preventGesture&&!I.defaultPrevented&&(S={eventSource:E,position:x(v(T),E.element),originalEvent:I.originalEvent,preventDefault:I.preventDefault||I.defaultPrevented,userData:E.userData},E.contextMenuHandler(S)),(S&&S.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function F(E,T){D(E,T,T)}function O(E,T){var S={target:T.target||T.srcElement,type:"wheel",shiftKey:T.shiftKey||!1,clientX:T.clientX,clientY:T.clientY,pageX:T.pageX?T.pageX:T.clientX,pageY:T.pageY?T.pageY:T.clientY,deltaMode:T.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?S.deltaY=-T.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:S.deltaY=T.detail,D(E,S,T)}function D(E,T,S){var I=0,q,Q=null;I=T.deltaY?T.deltaY<0?1:-1:0,q={originalEvent:T,eventType:"wheel",pointerType:"mouse",isEmulated:T!==S},b(E,q),E.scrollHandler&&!q.preventGesture&&!q.defaultPrevented&&(Q={eventSource:E,pointerType:"mouse",position:w(T,E.element),scroll:I,shift:T.shiftKey,isTouchEvent:!1,originalEvent:S,preventDefault:q.preventDefault||q.defaultPrevented,userData:E.userData},E.scrollHandler(Q)),q.stopPropagation&&e.stopEvent(S),(Q&&Q.preventDefault||q.preventDefault&&!q.defaultPrevented)&&e.cancelEvent(S)}function z(E,T){var S={id:e.MouseTracker.mousePointerId,type:"mouse"},I={originalEvent:T,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};b(E,I),T.target===E.element&&V(E,S,!1),I.stopPropagation&&e.stopEvent(T)}function xe(E,T){var S,I,q=T.changedTouches.length,Q,ce=E.getActivePointersListByType("touch");S=e.now(),ce.getLength()>T.touches.length-q&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var Te={originalEvent:T,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(b(E,Te),I=0;I<q;I++)Q={id:T.changedTouches[I].identifier,type:"touch",isPrimary:ce.getLength()===0,currentPos:v(T.changedTouches[I]),currentTime:S},B(E,Te,Q),Z(E,Te,Q,0),V(E,Q,!0);Te.preventDefault&&!Te.defaultPrevented&&e.cancelEvent(T),Te.stopPropagation&&e.stopEvent(T)}function Se(E,T){var S,I,q=T.changedTouches.length,Q;S=e.now();var ce={originalEvent:T,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(b(E,ce),I=0;I<q;I++)Q={id:T.changedTouches[I].identifier,type:"touch",currentPos:v(T.changedTouches[I]),currentTime:S},ue(E,ce,Q,0),V(E,Q,!1),H(E,ce,Q);ce.preventDefault&&!ce.defaultPrevented&&e.cancelEvent(T),ce.stopPropagation&&e.stopEvent(T)}function Me(E,T){var S,I,q=T.changedTouches.length,Q;S=e.now();var ce={originalEvent:T,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(b(E,ce),I=0;I<q;I++)Q={id:T.changedTouches[I].identifier,type:"touch",currentPos:v(T.changedTouches[I]),currentTime:S},le(E,ce,Q);ce.preventDefault&&!ce.defaultPrevented&&e.cancelEvent(T),ce.stopPropagation&&e.stopEvent(T)}function re(E,T){var S=T.changedTouches.length,I,q,Q={originalEvent:T,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(b(E,Q),I=0;I<S;I++)q={id:T.changedTouches[I].identifier,type:"touch"},$(E,Q,q);Q.stopPropagation&&e.stopEvent(T)}function ve(E,T){return e.eventIsCanceled(T)||T.preventDefault(),!1}function we(E,T){return e.eventIsCanceled(T)||T.preventDefault(),!1}function tt(E,T){var S={originalEvent:T,eventType:"gotpointercapture",pointerType:p(T),isEmulated:!1};b(E,S),T.target===E.element&&V(E,{id:T.pointerId,type:p(T)},!0),S.stopPropagation&&e.stopEvent(T)}function Fe(E,T){var S={originalEvent:T,eventType:"lostpointercapture",pointerType:p(T),isEmulated:!1};b(E,S),T.target===E.element&&V(E,{id:T.pointerId,type:p(T)},!1),S.stopPropagation&&e.stopEvent(T)}function te(E,T){var S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},I={originalEvent:T,eventType:"pointerenter",pointerType:S.type,isEmulated:!1};b(E,I),B(E,I,S)}function Ge(E,T){var S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},I={originalEvent:T,eventType:"pointerleave",pointerType:S.type,isEmulated:!1};b(E,I),H(E,I,S)}function ze(E,T){var S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},I={originalEvent:T,eventType:"pointerover",pointerType:S.type,isEmulated:!1};b(E,I),Y(E,I,S),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function Ct(E,T){var S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},I={originalEvent:T,eventType:"pointerout",pointerType:S.type,isEmulated:!1};b(E,I),U(E,I,S),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function it(E,T){var S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},I=e.MouseTracker.havePointerEvents&&S.type==="touch",q={originalEvent:T,eventType:"pointerdown",pointerType:S.type,isEmulated:!1};b(E,q),Z(E,q,S,T.button),q.preventDefault&&!q.defaultPrevented&&e.cancelEvent(T),q.stopPropagation&&e.stopEvent(T),q.shouldCapture&&(I?V(E,S,!0):d(E,S))}function It(E,T){Et(E,T)}function Gt(E,T){var S=E.getActivePointersListByType(p(T));S.getById(T.pointerId)&&Et(E,T),e.stopEvent(T)}function Et(E,T){var S;S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()};var I={originalEvent:T,eventType:"pointerup",pointerType:S.type,isEmulated:!1};b(E,I),ue(E,I,S,T.button),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T),I.shouldReleaseCapture&&(T.target===E.element?l(E,S):V(E,S,!1))}function lt(E,T){xt(E,T)}function ct(E,T){var S=E.getActivePointersListByType(p(T));S.getById(T.pointerId)&&xt(E,T),e.stopEvent(T)}function xt(E,T){var S={id:f(T),type:p(T),isPrimary:m(T),currentPos:v(T),currentTime:e.now()},I={originalEvent:T,eventType:"pointermove",pointerType:S.type,isEmulated:!1};b(E,I),le(E,I,S),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(T),I.stopPropagation&&e.stopEvent(T)}function yt(E,T){var S={id:T.pointerId,type:p(T)},I={originalEvent:T,eventType:"pointercancel",pointerType:S.type,isEmulated:!1};b(E,I),$(E,I,S),I.stopPropagation&&e.stopEvent(T)}function Pe(E,T){return T.speed=0,T.direction=0,T.contactPos=T.currentPos,T.contactTime=T.currentTime,T.lastPos=T.currentPos,T.lastTime=T.currentTime,E.add(T)}function ht(E,T,S){var I,q=T.getById(S.id);return q?(q.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),l(E,q)),T.removeContact(),I=T.removeById(S.id)):I=T.getLength(),I}function y(E,T){switch(T.eventType){case"pointermove":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!E.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"pointerdown":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!E.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerup":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!E.hasGestureHandlers,T.stopPropagation=!1;break;case"wheel":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!E.hasScrollHandler,T.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":T.isStoppable=!0,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"click":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!E.clickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"dblclick":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!E.dblClickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:T.isStoppable=!1,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break}}function b(E,T){T.eventSource=E,T.eventPhase=T.originalEvent&&typeof T.originalEvent.eventPhase<"u"?T.originalEvent.eventPhase:0,T.defaultPrevented=e.eventIsCanceled(T.originalEvent),T.shouldCapture=!1,T.shouldReleaseCapture=!1,T.userData=E.userData,y(E,T),E.preProcessEventHandler&&E.preProcessEventHandler(T)}function V(E,T,S){var I=E.getActivePointersListByType(T.type),q=I.getById(T.id);q?S&&!q.captured?(q.captured=!0,I.captureCount++):!S&&q.captured&&(q.captured=!1,I.captureCount--,I.captureCount<0&&(I.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function B(E,T,S){var I=E.getActivePointersListByType(S.type),q;q=I.getById(S.id),q?(q.insideElement=!0,q.lastPos=q.currentPos,q.lastTime=q.currentTime,q.currentPos=S.currentPos,q.currentTime=S.currentTime,S=q):(S.captured=!1,S.insideElementPressed=!1,S.insideElement=!0,Pe(I,S)),E.enterHandler&&E.enterHandler({eventSource:E,pointerType:S.type,position:x(S.currentPos,E.element),buttons:I.buttons,pointers:E.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData})}function H(E,T,S){var I=E.getActivePointersListByType(S.type),q,Q;q=I.getById(S.id),q?(q.captured?(q.insideElement=!1,q.lastPos=q.currentPos,q.lastTime=q.currentTime,q.currentPos=S.currentPos,q.currentTime=S.currentTime):ht(E,I,q),S=q):(S.captured=!1,S.insideElementPressed=!1),(E.leaveHandler||E.exitHandler)&&(Q={eventSource:E,pointerType:S.type,position:S.currentPos&&x(S.currentPos,E.element),buttons:I.buttons,pointers:E.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData},E.leaveHandler&&E.leaveHandler(Q),E.exitHandler&&E.exitHandler(Q))}function Y(E,T,S){var I,q;I=E.getActivePointersListByType(S.type),q=I.getById(S.id),q?S=q:(S.captured=!1,S.insideElementPressed=!1),E.overHandler&&E.overHandler({eventSource:E,pointerType:S.type,position:x(S.currentPos,E.element),buttons:I.buttons,pointers:E.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData})}function U(E,T,S){var I,q;I=E.getActivePointersListByType(S.type),q=I.getById(S.id),q?S=q:(S.captured=!1,S.insideElementPressed=!1),E.outHandler&&E.outHandler({eventSource:E,pointerType:S.type,position:S.currentPos&&x(S.currentPos,E.element),buttons:I.buttons,pointers:E.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData})}function Z(E,T,S,I){var q=i[E.hash],Q=E.getActivePointersListByType(S.type),ce;if(typeof T.originalEvent.buttons<"u"?Q.buttons=T.originalEvent.buttons:I===0?Q.buttons|=1:I===1?Q.buttons|=4:I===2?Q.buttons|=2:I===3?Q.buttons|=8:I===4?Q.buttons|=16:I===5&&(Q.buttons|=32),I!==0){T.shouldCapture=!1,T.shouldReleaseCapture=!1,E.nonPrimaryPressHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,E.nonPrimaryPressHandler({eventSource:E,pointerType:S.type,position:x(S.currentPos,E.element),button:I,buttons:Q.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData}));return}ce=Q.getById(S.id),ce?(ce.insideElementPressed=!0,ce.insideElement=!0,ce.originalTarget=T.originalEvent.target,ce.contactPos=S.currentPos,ce.contactTime=S.currentTime,ce.lastPos=ce.currentPos,ce.lastTime=ce.currentTime,ce.currentPos=S.currentPos,ce.currentTime=S.currentTime,S=ce):(S.captured=!1,S.insideElementPressed=!0,S.insideElement=!0,S.originalTarget=T.originalEvent.target,Pe(Q,S)),Q.addContact(),!T.preventGesture&&!T.defaultPrevented?(T.shouldCapture=!0,T.shouldReleaseCapture=!1,T.preventDefault=!0,(E.dragHandler||E.dragEndHandler||E.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(E,S),Q.contacts===1?E.pressHandler&&!T.preventGesture&&E.pressHandler({eventSource:E,pointerType:S.type,position:x(S.contactPos,E.element),buttons:Q.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData}):Q.contacts===2&&E.pinchHandler&&S.type==="touch"&&(q.pinchGPoints=Q.asArray(),q.lastPinchDist=q.currentPinchDist=q.pinchGPoints[0].currentPos.distanceTo(q.pinchGPoints[1].currentPos),q.lastPinchCenter=q.currentPinchCenter=R(q.pinchGPoints[0].currentPos,q.pinchGPoints[1].currentPos))):(T.shouldCapture=!1,T.shouldReleaseCapture=!1)}function ue(E,T,S,I){var q=i[E.hash],Q=E.getActivePointersListByType(S.type),ce,Te,ae,_e=!1,Ae;if(typeof T.originalEvent.buttons<"u"?Q.buttons=T.originalEvent.buttons:I===0?Q.buttons^=-2:I===1?Q.buttons^=-5:I===2?Q.buttons^=-3:I===3?Q.buttons^=-9:I===4?Q.buttons^=-17:I===5&&(Q.buttons^=-33),T.shouldCapture=!1,I!==0){T.shouldReleaseCapture=!1,E.nonPrimaryReleaseHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,E.nonPrimaryReleaseHandler({eventSource:E,pointerType:S.type,position:x(S.currentPos,E.element),button:I,buttons:Q.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData}));return}ae=Q.getById(S.id),ae?(Q.removeContact(),ae.captured&&(_e=!0),ae.lastPos=ae.currentPos,ae.lastTime=ae.currentTime,ae.currentPos=S.currentPos,ae.currentTime=S.currentTime,ae.insideElement||ht(E,Q,ae),ce=ae.currentPos,Te=ae.currentTime):(S.captured=!1,S.insideElementPressed=!1,S.insideElement=!0,Pe(Q,S),ae=S),!T.preventGesture&&!T.defaultPrevented&&(_e?(T.shouldReleaseCapture=!0,T.preventDefault=!0,(E.dragHandler||E.dragEndHandler||E.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(E,ae),Q.contacts===0?(E.releaseHandler&&ce&&E.releaseHandler({eventSource:E,pointerType:ae.type,position:x(ce,E.element),buttons:Q.buttons,insideElementPressed:ae.insideElementPressed,insideElementReleased:ae.insideElement,isTouchEvent:ae.type==="touch",originalEvent:T.originalEvent,userData:E.userData}),E.dragEndHandler&&q.sentDragEvent&&E.dragEndHandler({eventSource:E,pointerType:ae.type,position:x(ae.currentPos,E.element),speed:ae.speed,direction:ae.direction,shift:T.originalEvent.shiftKey,isTouchEvent:ae.type==="touch",originalEvent:T.originalEvent,userData:E.userData}),q.sentDragEvent=!1,(E.clickHandler||E.dblClickHandler)&&ae.insideElement&&(Ae=Te-ae.contactTime<=E.clickTimeThreshold&&ae.contactPos.distanceTo(ce)<=E.clickDistThreshold,E.clickHandler&&E.clickHandler({eventSource:E,pointerType:ae.type,position:x(ae.currentPos,E.element),quick:Ae,shift:T.originalEvent.shiftKey,isTouchEvent:ae.type==="touch",originalEvent:T.originalEvent,originalTarget:ae.originalTarget,userData:E.userData}),E.dblClickHandler&&Ae&&(Q.clicks++,Q.clicks===1?(q.lastClickPos=ce,q.dblClickTimeOut=setTimeout(function(){Q.clicks=0},E.dblClickTimeThreshold)):Q.clicks===2&&(clearTimeout(q.dblClickTimeOut),Q.clicks=0,q.lastClickPos.distanceTo(ce)<=E.dblClickDistThreshold&&E.dblClickHandler({eventSource:E,pointerType:ae.type,position:x(ae.currentPos,E.element),shift:T.originalEvent.shiftKey,isTouchEvent:ae.type==="touch",originalEvent:T.originalEvent,userData:E.userData}),q.lastClickPos=null)))):Q.contacts===2&&E.pinchHandler&&ae.type==="touch"&&(q.pinchGPoints=Q.asArray(),q.lastPinchDist=q.currentPinchDist=q.pinchGPoints[0].currentPos.distanceTo(q.pinchGPoints[1].currentPos),q.lastPinchCenter=q.currentPinchCenter=R(q.pinchGPoints[0].currentPos,q.pinchGPoints[1].currentPos))):(T.shouldReleaseCapture=!1,E.releaseHandler&&ce&&(E.releaseHandler({eventSource:E,pointerType:ae.type,position:x(ce,E.element),buttons:Q.buttons,insideElementPressed:ae.insideElementPressed,insideElementReleased:ae.insideElement,isTouchEvent:ae.type==="touch",originalEvent:T.originalEvent,userData:E.userData}),T.preventDefault=!0)))}function le(E,T,S){var I=i[E.hash],q=E.getActivePointersListByType(S.type),Q,ce,Te;if(typeof T.originalEvent.buttons<"u"&&(q.buttons=T.originalEvent.buttons),Q=q.getById(S.id),Q)Q.lastPos=Q.currentPos,Q.lastTime=Q.currentTime,Q.currentPos=S.currentPos,Q.currentTime=S.currentTime;else return;T.shouldCapture=!1,T.shouldReleaseCapture=!1,E.stopHandler&&S.type==="mouse"&&(clearTimeout(E.stopTimeOut),E.stopTimeOut=setTimeout(function(){Ee(E,T.originalEvent,S.type)},E.stopDelay)),q.contacts===0?E.moveHandler&&E.moveHandler({eventSource:E,pointerType:S.type,position:x(S.currentPos,E.element),buttons:q.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:E.userData}):q.contacts===1?(E.moveHandler&&(Q=q.asArray()[0],E.moveHandler({eventSource:E,pointerType:Q.type,position:x(Q.currentPos,E.element),buttons:q.buttons,isTouchEvent:Q.type==="touch",originalEvent:T.originalEvent,userData:E.userData})),E.dragHandler&&!T.preventGesture&&!T.defaultPrevented&&(Q=q.asArray()[0],Te=Q.currentPos.minus(Q.lastPos),E.dragHandler({eventSource:E,pointerType:Q.type,position:x(Q.currentPos,E.element),buttons:q.buttons,delta:Te,speed:Q.speed,direction:Q.direction,shift:T.originalEvent.shiftKey,isTouchEvent:Q.type==="touch",originalEvent:T.originalEvent,userData:E.userData}),T.preventDefault=!0,I.sentDragEvent=!0)):q.contacts===2&&(E.moveHandler&&(ce=q.asArray(),E.moveHandler({eventSource:E,pointerType:ce[0].type,position:x(R(ce[0].currentPos,ce[1].currentPos),E.element),buttons:q.buttons,isTouchEvent:ce[0].type==="touch",originalEvent:T.originalEvent,userData:E.userData})),E.pinchHandler&&S.type==="touch"&&!T.preventGesture&&!T.defaultPrevented&&(Te=I.pinchGPoints[0].currentPos.distanceTo(I.pinchGPoints[1].currentPos),Te!==I.currentPinchDist&&(I.lastPinchDist=I.currentPinchDist,I.currentPinchDist=Te,I.lastPinchCenter=I.currentPinchCenter,I.currentPinchCenter=R(I.pinchGPoints[0].currentPos,I.pinchGPoints[1].currentPos),E.pinchHandler({eventSource:E,pointerType:"touch",gesturePoints:I.pinchGPoints,lastCenter:x(I.lastPinchCenter,E.element),center:x(I.currentPinchCenter,E.element),lastDistance:I.lastPinchDist,distance:I.currentPinchDist,shift:T.originalEvent.shiftKey,originalEvent:T.originalEvent,userData:E.userData}),T.preventDefault=!0)))}function $(E,T,S){var I=E.getActivePointersListByType(S.type),q;q=I.getById(S.id),q&&ht(E,I,q)}function Ee(E,T,S){E.stopHandler&&E.stopHandler({eventSource:E,pointerType:S,position:w(T,E.element),buttons:E.getActivePointersListByType(S).buttons,isTouchEvent:S==="touch",originalEvent:T,userData:E.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(y){var b=arguments,V=this,B;e.isPlainObject(y)||(y={id:b[0],xmlPath:b.length>1?b[1]:void 0,prefixUrl:b.length>2?b[2]:void 0,controls:b.length>3?b[3]:void 0,overlays:b.length>4?b[4]:void 0}),y.config&&(e.extend(!0,y,y.config),delete y.config);let H=["useCanvas"];if(y.drawerOptions=Object.assign({},H.reduce((U,Z)=>(U[Z]=y[Z],delete y[Z],U),{}),y.drawerOptions),e.extend(!0,this,{id:y.id,hash:y.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,y),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(U){var Z=e.getString("Errors.OpenFailed",U.eventSource,U.message);V._showMessage(Z)}),e.ControlDock.call(this,y),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(U){U.width="100%",U.height="100%",U.overflow="hidden",U.position="absolute",U.top="0px",U.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),y.tabIndex!==""&&(this.canvas.tabIndex=y.tabIndex===void 0?0:y.tabIndex),this.container.className="openseadragon-container",function(U){U.width="100%",U.height="100%",U.position="relative",U.overflow="hidden",U.left="0px",U.top="0px",U.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,w),keyDownHandler:e.delegate(this,x),keyHandler:e.delegate(this,R),clickHandler:e.delegate(this,L),dblClickHandler:e.delegate(this,j),dragHandler:e.delegate(this,G),dragEndHandler:e.delegate(this,J),enterHandler:e.delegate(this,M),leaveHandler:e.delegate(this,A),pressHandler:e.delegate(this,C),releaseHandler:e.delegate(this,k),nonPrimaryPressHandler:e.delegate(this,F),nonPrimaryReleaseHandler:e.delegate(this,O),scrollHandler:e.delegate(this,Se),pinchHandler:e.delegate(this,D),focusHandler:e.delegate(this,z),blurHandler:e.delegate(this,xe)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,Me),leaveHandler:e.delegate(this,re)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[V.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(U){V.source=V.world.getItemAt(0).source,i[V.hash].forceRedraw=!0,V._updateRequestId||(V._updateRequestId=h(V,ve))}),this.world.addHandler("remove-item",function(U){V.world.getItemCount()?V.source=V.world.getItemAt(0).source:V.source=null,i[V.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(U){V.viewport&&V.viewport._setContentBounds(V.world.getHomeBounds(),V.world.getContentFactor())}),this.world.addHandler("item-index-change",function(U){V.source=V.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:y.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let Y=Array.isArray(this.drawer)?this.drawer:[this.drawer];Y.length===0&&(Y=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const U of Y)if(this.requestDrawer(U,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(B=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(B,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(B=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(B,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),B=0;B<this.customControls.length;B++)this.addControl(this.customControls[B].id,{anchor:this.customControls[B].anchor});e.requestAnimationFrame(function(){l(V)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(y){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(y)},openTileSource:function(y){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(y)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(y,b){var V=this;if(this.close(),!y)return this;if(this.sequenceMode&&e.isArray(y))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof b<"u"&&!isNaN(b)&&(this.initialPage=b),this.tileSources=y,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(y)||(y=[y]),!y.length)return this;this._opening=!0;for(var B=y.length,H=0,Y=0,U,Z=function(){if(H+Y===B)if(H){(V._firstOpen||!V.preserveViewport)&&(V.viewport.goHome(!0),V.viewport.update()),V._firstOpen=!1;var $=y[0];if($.tileSource&&($=$.tileSource),V.overlays&&!V.preserveOverlays)for(var Ee=0;Ee<V.overlays.length;Ee++)V.currentOverlays[Ee]=a(V,V.overlays[Ee]);V._drawOverlays(),V._opening=!1,V.raiseEvent("open",{source:$})}else V._opening=!1,V.raiseEvent("open-failed",U)},ue=function($){(!e.isPlainObject($)||!$.tileSource)&&($={tileSource:$}),$.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete $.index),$.collectionImmediately===void 0&&($.collectionImmediately=!0);var Ee=$.success;$.success=function(T){if(H++,$.tileSource.overlays)for(var S=0;S<$.tileSource.overlays.length;S++)V.addOverlay($.tileSource.overlays[S]);Ee&&Ee(T),Z()};var E=$.error;$.error=function(T){Y++,U||(U=T),E&&E(T),Z()},V.addTiledImage($)},le=0;le<y.length;le++)ue(y[le]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(y,b){const V={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};b=e.extend(!0,V,b);const B=b.mainDrawer,H=b.redrawImmediately,Y=b.drawerOptions,U=this.drawer;let Z=null;if(y&&y.prototype instanceof e.DrawerBase?(Z=y,y="custom"):typeof y=="string"&&(Z=e.determineDrawer(y)),Z||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),Z&&Z.isSupported()){U&&B&&U.destroy();const ue=new Z({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:Y||this.drawerOptions[y]});return B&&(this.drawer=ue,H&&this.forceRedraw()),ue}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(y){return this.innerTracker.setTracking(y),this.outerTracker.setTracking(y),this.raiseEvent("mouse-enabled",{enabled:y}),this},areControlsEnabled:function(){var y=this.controls.length,b;for(b=0;b<this.controls.length;b++)y=y&&this.controls[b].isVisible();return y},setControlsEnabled:function(y){return y?p(this):l(this),this.raiseEvent("controls-enabled",{enabled:y}),this},setDebugMode:function(y){for(var b=0;b<this.world.getItemCount();b++)this.world.getItemAt(b).debugMode=y;this.debugMode=y,this.forceRedraw()},setAjaxHeaders:function(y,b){if(y===null&&(y={}),!e.isPlainObject(y)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(b===void 0&&(b=!0),this.ajaxHeaders=y,b){for(var V=0;V<this.world.getItemCount();V++)this.world.getItemAt(V)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var B in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[B].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(y){this.buttonGroup.addButton(y)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(y){var b=document.body,V=b.style,B=document.documentElement.style,H=this,Y,U;if(y===this.isFullPage())return this;var Z={fullPage:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",Z),Z.preventDefaultAction)return this;if(y&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=V.margin,this.docMargin=B.margin,V.margin="0",B.margin="0",this.bodyPadding=V.padding,this.docPadding=B.padding,V.padding="0",B.padding="0",this.bodyWidth=V.width,this.docWidth=B.width,V.width="100%",B.width="100%",this.bodyHeight=V.height,this.docHeight=B.height,V.height="100%",B.height="100%",this.bodyDisplay=V.display,V.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,Y=b.childNodes.length,U=0;U<Y;U++)this.previousBody.push(b.childNodes[0]),b.removeChild(b.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,b.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),b.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,Me)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,V.margin=this.bodyMargin,B.margin=this.docMargin,V.padding=this.bodyPadding,B.padding=this.docPadding,V.width=this.bodyWidth,B.width=this.docWidth,V.height=this.bodyHeight,B.height=this.docHeight,V.display=this.bodyDisplay,b.removeChild(this.element),Y=this.previousBody.length,U=0;U<Y;U++)b.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(b.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var ue=0,le=function(){e.setPageScroll(H.pageScroll);var $=e.getPageScroll();ue++,ue<10&&($.x!==H.pageScroll.x||$.y!==H.pageScroll.y)&&e.requestAnimationFrame(le)};e.requestAnimationFrame(le),i[this.hash].fullPage=!1,e.delegate(this,re)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:y}),this},setFullScreen:function(y){var b=this;if(!e.supportsFullScreen)return this.setFullPage(y);if(e.isFullScreen()===y)return this;var V={fullScreen:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",V),V.preventDefaultAction)return this;if(y){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var B=function(){var H=e.isFullScreen();H||(e.removeEvent(document,e.fullScreenEventName,B),e.removeEvent(document,e.fullScreenErrorEventName,B),b.setFullPage(!1),b.isFullPage()&&(b.element.style.width=b.fullPageStyleWidth,b.element.style.height=b.fullPageStyleHeight)),b.navigator&&b.viewport&&setTimeout(function(){b.navigator.update(b.viewport)}),b.raiseEvent("full-screen",{fullScreen:H})};e.addEvent(document,e.fullScreenEventName,B),e.addEvent(document,e.fullScreenErrorEventName,B),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(y){return this.container.style.visibility=y?"":"hidden",this.raiseEvent("visible",{visible:y}),this},addTiledImage:function(y){e.console.assert(y,"[Viewer.addTiledImage] options is required"),e.console.assert(y.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!y.replace||y.index>-1&&y.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var b=this;y.replace&&(y.replaceItem=b.world.getItemAt(y.index)),this._hideMessage(),y.placeholderFillStyle===void 0&&(y.placeholderFillStyle=this.placeholderFillStyle),y.opacity===void 0&&(y.opacity=this.opacity),y.preload===void 0&&(y.preload=this.preload),y.compositeOperation===void 0&&(y.compositeOperation=this.compositeOperation),y.crossOriginPolicy===void 0&&(y.crossOriginPolicy=y.tileSource.crossOriginPolicy!==void 0?y.tileSource.crossOriginPolicy:this.crossOriginPolicy),y.ajaxWithCredentials===void 0&&(y.ajaxWithCredentials=this.ajaxWithCredentials),y.loadTilesWithAjax===void 0&&(y.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(y.ajaxHeaders)||(y.ajaxHeaders={});var V={options:y};function B(U){for(var Z=0;Z<b._loadQueue.length;Z++)if(b._loadQueue[Z]===V){b._loadQueue.splice(Z,1);break}b._loadQueue.length===0&&H(V),b.raiseEvent("add-item-failed",U),y.error&&y.error(U)}function H(U){b.collectionMode&&(b.world.arrange({immediately:U.options.collectionImmediately,rows:b.collectionRows,columns:b.collectionColumns,layout:b.collectionLayout,tileSize:b.collectionTileSize,tileMargin:b.collectionTileMargin}),b.world.setAutoRefigureSizes(!0))}if(e.isArray(y.tileSource)){setTimeout(function(){B({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:y.tileSource,options:y})});return}this._loadQueue.push(V);function Y(){for(var U,Z,ue;b._loadQueue.length&&(U=b._loadQueue[0],!!U.tileSource);){if(b._loadQueue.splice(0,1),U.options.replace){var le=b.world.getIndexOfItem(U.options.replaceItem);le!==-1&&(U.options.index=le),b.world.removeItem(U.options.replaceItem)}Z=new e.TiledImage({viewer:b,source:U.tileSource,viewport:b.viewport,drawer:b.drawer,tileCache:b.tileCache,imageLoader:b.imageLoader,x:U.options.x,y:U.options.y,width:U.options.width,height:U.options.height,fitBounds:U.options.fitBounds,fitBoundsPlacement:U.options.fitBoundsPlacement,clip:U.options.clip,placeholderFillStyle:U.options.placeholderFillStyle,opacity:U.options.opacity,preload:U.options.preload,degrees:U.options.degrees,flipped:U.options.flipped,compositeOperation:U.options.compositeOperation,springStiffness:b.springStiffness,animationTime:b.animationTime,minZoomImageRatio:b.minZoomImageRatio,wrapHorizontal:b.wrapHorizontal,wrapVertical:b.wrapVertical,maxTilesPerFrame:b.maxTilesPerFrame,immediateRender:b.immediateRender,blendTime:b.blendTime,alwaysBlend:b.alwaysBlend,minPixelRatio:b.minPixelRatio,smoothTileEdgesMinZoom:b.smoothTileEdgesMinZoom,iOSDevice:b.iOSDevice,crossOriginPolicy:U.options.crossOriginPolicy,ajaxWithCredentials:U.options.ajaxWithCredentials,loadTilesWithAjax:U.options.loadTilesWithAjax,ajaxHeaders:U.options.ajaxHeaders,debugMode:b.debugMode,subPixelRoundingForTransparency:b.subPixelRoundingForTransparency}),b.collectionMode&&b.world.setAutoRefigureSizes(!1),b.navigator&&(ue=e.extend({},U.options,{replace:!1,originalTiledImage:Z,tileSource:U.tileSource}),b.navigator.addTiledImage(ue)),b.world.addItem(Z,{index:U.options.index}),b._loadQueue.length===0&&H(U),b.world.getItemCount()===1&&!b.preserveViewport&&b.viewport.goHome(!0),U.options.success&&U.options.success({item:Z})}}o(this,y.tileSource,y,function(U){V.tileSource=U,Y()},function(U){U.options=y,B(U),Y()})},addSimpleImage:function(y){e.console.assert(y,"[Viewer.addSimpleImage] options is required"),e.console.assert(y.url,"[Viewer.addSimpleImage] options.url is required");var b=e.extend({},y,{tileSource:{type:"image",url:y.url}});delete b.url,this.addTiledImage(b)},addLayer:function(y){var b=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var V=e.extend({},y,{success:function(B){b.raiseEvent("add-layer",{options:y,drawer:B.item})},error:function(B){b.raiseEvent("add-layer-failed",B)}});return this.addTiledImage(V),this},getLayerAtLevel:function(y){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(y)},getLevelOfLayer:function(y){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(y)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(y,b){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(y,b)},removeLayer:function(y){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(y)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var y=e.delegate(this,m),b=e.delegate(this,v),V=e.delegate(this,this.goToNextPage),B=e.delegate(this,this.goToPreviousPage),H=this.navImages,Y=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(Y=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:te(this.prefixUrl,H.previous.REST),srcGroup:te(this.prefixUrl,H.previous.GROUP),srcHover:te(this.prefixUrl,H.previous.HOVER),srcDown:te(this.prefixUrl,H.previous.DOWN),onRelease:B,onFocus:y,onBlur:b}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:te(this.prefixUrl,H.next.REST),srcGroup:te(this.prefixUrl,H.next.GROUP),srcHover:te(this.prefixUrl,H.next.HOVER),srcDown:te(this.prefixUrl,H.next.DOWN),onRelease:V,onFocus:y,onBlur:b}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),Y&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var y=e.delegate(this,Ge),b=e.delegate(this,Ct),V=e.delegate(this,Gt),B=e.delegate(this,ze),H=e.delegate(this,Et),Y=e.delegate(this,ct),U=e.delegate(this,xt),Z=e.delegate(this,yt),ue=e.delegate(this,Pe),le=e.delegate(this,ht),$=e.delegate(this,m),Ee=e.delegate(this,v),E=this.navImages,T=[],S=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(S=!1),this.showZoomControl&&(T.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:te(this.prefixUrl,E.zoomIn.REST),srcGroup:te(this.prefixUrl,E.zoomIn.GROUP),srcHover:te(this.prefixUrl,E.zoomIn.HOVER),srcDown:te(this.prefixUrl,E.zoomIn.DOWN),onPress:y,onRelease:b,onClick:V,onEnter:y,onExit:b,onFocus:$,onBlur:Ee})),T.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:te(this.prefixUrl,E.zoomOut.REST),srcGroup:te(this.prefixUrl,E.zoomOut.GROUP),srcHover:te(this.prefixUrl,E.zoomOut.HOVER),srcDown:te(this.prefixUrl,E.zoomOut.DOWN),onPress:B,onRelease:b,onClick:H,onEnter:B,onExit:b,onFocus:$,onBlur:Ee}))),this.showHomeControl&&T.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:te(this.prefixUrl,E.home.REST),srcGroup:te(this.prefixUrl,E.home.GROUP),srcHover:te(this.prefixUrl,E.home.HOVER),srcDown:te(this.prefixUrl,E.home.DOWN),onRelease:Y,onFocus:$,onBlur:Ee})),this.showFullPageControl&&T.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:te(this.prefixUrl,E.fullpage.REST),srcGroup:te(this.prefixUrl,E.fullpage.GROUP),srcHover:te(this.prefixUrl,E.fullpage.HOVER),srcDown:te(this.prefixUrl,E.fullpage.DOWN),onRelease:U,onFocus:$,onBlur:Ee})),this.showRotationControl&&(T.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:te(this.prefixUrl,E.rotateleft.REST),srcGroup:te(this.prefixUrl,E.rotateleft.GROUP),srcHover:te(this.prefixUrl,E.rotateleft.HOVER),srcDown:te(this.prefixUrl,E.rotateleft.DOWN),onRelease:Z,onFocus:$,onBlur:Ee})),T.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:te(this.prefixUrl,E.rotateright.REST),srcGroup:te(this.prefixUrl,E.rotateright.GROUP),srcHover:te(this.prefixUrl,E.rotateright.HOVER),srcDown:te(this.prefixUrl,E.rotateright.DOWN),onRelease:ue,onFocus:$,onBlur:Ee}))),this.showFlipControl&&T.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:te(this.prefixUrl,E.flip.REST),srcGroup:te(this.prefixUrl,E.flip.GROUP),srcHover:te(this.prefixUrl,E.flip.HOVER),srcDown:te(this.prefixUrl,E.flip.DOWN),onRelease:le,onFocus:$,onBlur:Ee})),S?(this.buttonGroup=new e.ButtonGroup({buttons:T,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,lt)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=T),this},currentPage:function(){return this._sequenceIndex},goToPage:function(y){return this.tileSources&&y>=0&&y<this.tileSources.length&&(this._sequenceIndex=y,this._updateSequenceButtons(y),this.open(this.tileSources[y]),this.referenceStrip&&this.referenceStrip.setFocus(y),this.raiseEvent("page",{page:y})),this},addOverlay:function(y,b,V,B){var H;if(e.isPlainObject(y)?H=y:H={element:y,location:b,placement:V,onDraw:B},y=e.getElement(H.element),c(this.currentOverlays,y)>=0)return this;var Y=a(this,H);return this.currentOverlays.push(Y),Y.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:y,location:H.location,placement:H.placement}),this},updateOverlay:function(y,b,V){var B;return y=e.getElement(y),B=c(this.currentOverlays,y),B>=0&&(this.currentOverlays[B].update(b,V),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:y,location:b,placement:V})),this},removeOverlay:function(y){var b;return y=e.getElement(y),b=c(this.currentOverlays,y),b>=0&&(this.currentOverlays[b].destroy(),this.currentOverlays.splice(b,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:y})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(y){var b;return y=e.getElement(y),b=c(this.currentOverlays,y),b>=0?this.currentOverlays[b]:null},_updateSequenceButtons:function(y){this.nextButton&&(!this.tileSources||this.tileSources.length-1===y?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(y>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(y){this._hideMessage();var b=e.makeNeutralElement("div");b.appendChild(document.createTextNode(y)),this.messageDiv=e.makeCenteredNode(b),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var y=this.messageDiv;y&&(y.parentNode.removeChild(y),delete this.messageDiv)},gestureSettingsByDeviceType:function(y){switch(y){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var y,b=this.currentOverlays.length;for(y=0;y<b;y++)this.currentOverlays[y].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var y=e.pixelDensityRatio,b=e.getCurrentPixelDensityRatio();y!==b&&(e.pixelDensityRatio=b,this.forceResize())},goToPreviousPage:function(){var y=this._sequenceIndex-1;this.navPrevNextWrap&&y<0&&(y+=this.tileSources.length),this.goToPage(y)},goToNextPage:function(){var y=this._sequenceIndex+1;this.navPrevNextWrap&&y>=this.tileSources.length&&(y=0),this.goToPage(y)},isAnimating:function(){return i[this.hash].animating}});function r(y){return y=e.getElement(y),new e.Point(y.clientWidth===0?1:y.clientWidth,y.clientHeight===0?1:y.clientHeight)}function o(y,b,V,B,H){var Y=y;if(e.type(b)==="string"){if(b.match(/^\s*<.*>\s*$/))b=e.parseXml(b);else if(b.match(/^\s*[{[].*[}\]]\s*$/))try{var U=e.parseJSON(b);b=U}catch{}}function Z(ue,le){ue.ready?B(ue):(ue.addHandler("ready",function(){B(ue)}),ue.addHandler("open-failed",function($){H({message:$.message,source:le})}))}setTimeout(function(){if(e.type(b)==="string")b=new e.TileSource({url:b,crossOriginPolicy:V.crossOriginPolicy!==void 0?V.crossOriginPolicy:y.crossOriginPolicy,ajaxWithCredentials:y.ajaxWithCredentials,ajaxHeaders:V.ajaxHeaders?V.ajaxHeaders:y.ajaxHeaders,splitHashDataForPost:y.splitHashDataForPost,success:function(Ee){B(Ee.tileSource)}}),b.addHandler("open-failed",function(Ee){H(Ee)});else if(e.isPlainObject(b)||b.nodeType)if(b.crossOriginPolicy===void 0&&(V.crossOriginPolicy!==void 0||y.crossOriginPolicy!==void 0)&&(b.crossOriginPolicy=V.crossOriginPolicy!==void 0?V.crossOriginPolicy:y.crossOriginPolicy),b.ajaxWithCredentials===void 0&&(b.ajaxWithCredentials=y.ajaxWithCredentials),e.isFunction(b.getTileUrl)){var ue=new e.TileSource(b);ue.getTileUrl=b.getTileUrl,B(ue)}else{var le=e.TileSource.determineType(Y,b);if(!le){H({message:"Unable to load TileSource",source:b});return}var $=le.prototype.configure.apply(Y,[b]);Z(new le($),b)}else Z(b,b)})}function a(y,b){if(b instanceof e.Overlay)return b;var V=null;if(b.element)V=e.getElement(b.element);else{var B=b.id?b.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);V=e.getElement(b.id),V||(V=document.createElement("a"),V.href="#/overlay/"+B),V.id=B,e.addClass(V,b.className?b.className:"openseadragon-overlay")}var H=b.location,Y=b.width,U=b.height;if(!H){var Z=b.x,ue=b.y;if(b.px!==void 0){var le=y.viewport.imageToViewportRectangle(new e.Rect(b.px,b.py,Y||0,U||0));Z=le.x,ue=le.y,Y=Y!==void 0?le.width:void 0,U=U!==void 0?le.height:void 0}H=new e.Point(Z,ue)}var $=b.placement;return $&&e.type($)==="string"&&($=e.Placement[b.placement.toUpperCase()]),new e.Overlay({element:V,location:H,placement:$,onDraw:b.onDraw,checkResize:b.checkResize,width:Y,height:U,rotationMode:b.rotationMode})}function c(y,b){var V;for(V=y.length-1;V>=0;V--)if(y[V].element===b)return V;return-1}function h(y,b){return e.requestAnimationFrame(function(){b(y)})}function d(y){e.requestAnimationFrame(function(){f(y)})}function l(y){y.autoHideControls&&(y.controlsShouldFade=!0,y.controlsFadeBeginTime=e.now()+y.controlsFadeDelay,window.setTimeout(function(){d(y)},y.controlsFadeDelay))}function f(y){var b,V,B,H;if(y.controlsShouldFade){for(b=e.now(),V=b-y.controlsFadeBeginTime,B=1-V/y.controlsFadeLength,B=Math.min(1,B),B=Math.max(0,B),H=y.controls.length-1;H>=0;H--)y.controls[H].autoFade&&y.controls[H].setOpacity(B);B>0&&d(y)}}function p(y){var b;for(y.controlsShouldFade=!1,b=y.controls.length-1;b>=0;b--)y.controls[b].setOpacity(1)}function m(){p(this)}function v(){l(this)}function w(y){var b={tracker:y.eventSource,position:y.position,originalEvent:y.originalEvent,preventDefault:y.preventDefault};this.raiseEvent("canvas-contextmenu",b),y.preventDefault=b.preventDefault}function x(y){var b={originalEvent:y.originalEvent,preventDefaultAction:!1,preventVerticalPan:y.preventVerticalPan||!this.panVertical,preventHorizontalPan:y.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",b),!b.preventDefaultAction&&!y.ctrl&&!y.alt&&!y.meta)switch(y.keyCode){case 38:b.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 40:b.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 37:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 39:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 87:b.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 83:b.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 65:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 68:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 82:y.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),y.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:y.preventDefault=!1;break}else y.preventDefault=!1}function R(y){var b={originalEvent:y.originalEvent};this.raiseEvent("canvas-key-press",b)}function L(y){var b,V=document.activeElement===this.canvas;V||this.canvas.focus(),this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x);var B={tracker:y.eventSource,position:y.position,quick:y.quick,shift:y.shift,originalEvent:y.originalEvent,originalTarget:y.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",B),!B.preventDefaultAction&&this.viewport&&y.quick&&(b=this.gestureSettingsByDeviceType(y.pointerType),b.clickToZoom===!0&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,b.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()),b.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function j(y){var b,V={tracker:y.eventSource,position:y.position,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",V),!V.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(y.pointerType),b.dblClickToZoom&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,b.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()))}function G(y){var b,V={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,delta:y.delta,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",V),b=this.gestureSettingsByDeviceType(y.pointerType),!V.preventDefaultAction&&this.viewport){if(b.dblClickDragToZoom&&i[this.hash].draggingToZoom){var B=Math.pow(this.zoomPerDblClickDrag,y.delta.y/50);this.viewport.zoomBy(B)}else if(b.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(y.delta.x=0),this.panVertical||(y.delta.y=0),this.viewport.flipped&&(y.delta.x=-y.delta.x),this.constrainDuringPan){var H=this.viewport.deltaPointsFromPixels(y.delta.negate());this.viewport.centerSpringX.target.value+=H.x,this.viewport.centerSpringY.target.value+=H.y;var Y=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=H.x,this.viewport.centerSpringY.target.value-=H.y,Y.xConstrained&&(y.delta.x=0),Y.yConstrained&&(y.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(y.delta.negate()),b.flickEnabled&&!this.constrainDuringPan)}}}function J(y){var b,V={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",V),b=this.gestureSettingsByDeviceType(y.pointerType),!V.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&b.dragToPan&&b.flickEnabled&&y.speed>=b.flickMinSpeed){var B=0;this.panHorizontal&&(B=b.flickMomentum*y.speed*Math.cos(y.direction));var H=0;this.panVertical&&(H=b.flickMomentum*y.speed*Math.sin(y.direction));var Y=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),U=this.viewport.pointFromPixel(new e.Point(Y.x-B,Y.y-H));this.viewport.panTo(U,!1)}this.viewport.applyConstraints()}b.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function M(y){this.raiseEvent("canvas-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function A(y){this.raiseEvent("canvas-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function C(y){var b;if(this.raiseEvent("canvas-press",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent}),b=this.gestureSettingsByDeviceType(y.pointerType),b.dblClickDragToZoom){var V=i[this.hash].lastClickTime,B=e.now();if(V===null)return;B-V<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function k(y){this.raiseEvent("canvas-release",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent})}function F(y){this.raiseEvent("canvas-nonprimary-press",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function O(y){this.raiseEvent("canvas-nonprimary-release",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function D(y){var b,V,B,H,Y={tracker:y.eventSource,pointerType:y.pointerType,gesturePoints:y.gesturePoints,lastCenter:y.lastCenter,center:y.center,lastDistance:y.lastDistance,distance:y.distance,shift:y.shift,originalEvent:y.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",Y),this.viewport&&(b=this.gestureSettingsByDeviceType(y.pointerType),b.pinchToZoom&&(!Y.preventDefaultPanAction||!Y.preventDefaultZoomAction)&&(V=this.viewport.pointFromPixel(y.center,!0),b.zoomToRefPoint&&!Y.preventDefaultPanAction&&(B=this.viewport.pointFromPixel(y.lastCenter,!0),H=B.minus(V),this.panHorizontal||(H.x=0),this.panVertical||(H.y=0),this.viewport.panBy(H,!0)),Y.preventDefaultZoomAction||this.viewport.zoomBy(y.distance/y.lastDistance,V,!0),this.viewport.applyConstraints()),b.pinchRotate&&!Y.preventDefaultRotateAction)){var U=Math.atan2(y.gesturePoints[0].currentPos.y-y.gesturePoints[1].currentPos.y,y.gesturePoints[0].currentPos.x-y.gesturePoints[1].currentPos.x),Z=Math.atan2(y.gesturePoints[0].lastPos.y-y.gesturePoints[1].lastPos.y,y.gesturePoints[0].lastPos.x-y.gesturePoints[1].lastPos.x);V=this.viewport.pointFromPixel(y.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(U-Z)*(180/Math.PI),V,!0)}}function z(y){this.raiseEvent("canvas-focus",{tracker:y.eventSource,originalEvent:y.originalEvent})}function xe(y){this.raiseEvent("canvas-blur",{tracker:y.eventSource,originalEvent:y.originalEvent})}function Se(y){var b,V,B,H,Y;H=e.now(),Y=H-this._lastScrollTime,Y>this.minScrollDeltaTime?(this._lastScrollTime=H,b={tracker:y.eventSource,position:y.position,scroll:y.scroll,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",b),!b.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x),V=this.gestureSettingsByDeviceType(y.pointerType),V.scrollToZoom&&(B=Math.pow(this.zoomPerScroll,y.scroll),this.viewport.zoomBy(B,V.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints())),y.preventDefault=b.preventDefault):y.preventDefault=!0}function Me(y){i[this.hash].mouseInside=!0,p(this),this.raiseEvent("container-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function re(y){y.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||l(this)),this.raiseEvent("container-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function ve(y){tt(y),y.isOpen()?y._updateRequestId=h(y,ve):y._updateRequestId=!1}function we(y,b){var V=y.viewport,B=V.getZoom(),H=V.getCenter();V.resize(b,y.preserveImageSizeOnResize),V.panTo(H,!0);var Y;if(y.preserveImageSizeOnResize)Y=i[y.hash].prevContainerSize.x/b.x;else{var U=new e.Point(0,0),Z=new e.Point(i[y.hash].prevContainerSize.x,i[y.hash].prevContainerSize.y).distanceTo(U),ue=new e.Point(b.x,b.y).distanceTo(U);Y=ue/Z*i[y.hash].prevContainerSize.x/b.x}V.zoomTo(B*Y,null,!0),i[y.hash].prevContainerSize=b,i[y.hash].forceRedraw=!0,i[y.hash].needsResize=!1,i[y.hash].forceResize=!1}function tt(y){if(!(y._opening||!i[y.hash])){if(y.autoResize||i[y.hash].forceResize){var b;if(y._autoResizePolling){b=r(y.container);var V=i[y.hash].prevContainerSize;b.equals(V)||(i[y.hash].needsResize=!0)}i[y.hash].needsResize&&we(y,b||r(y.container))}var B=y.viewport.update(),H=y.world.update(B)||B;B&&y.raiseEvent("viewport-change"),y.referenceStrip&&(H=y.referenceStrip.update(y.viewport)||H);var Y=i[y.hash].animating;!Y&&H&&(y.raiseEvent("animation-start"),p(y));var U=Y&&!H;U&&(i[y.hash].animating=!1),(H||U||i[y.hash].forceRedraw||y.world.needsDraw())&&(Fe(y),y._drawOverlays(),y.navigator&&y.navigator.update(y.viewport),i[y.hash].forceRedraw=!1,H&&y.raiseEvent("animation")),U&&(y.raiseEvent("animation-finish"),i[y.hash].mouseInside||l(y)),i[y.hash].animating=H}}function Fe(y){y.imageLoader.clear(),y.world.draw(),y.raiseEvent("update-viewport",{})}function te(y,b){return y?y+b:b}function Ge(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,it(this)}function ze(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,it(this)}function Ct(){i[this.hash].zooming=!1}function it(y){e.requestAnimationFrame(e.delegate(y,It))}function It(){var y,b,V;i[this.hash].zooming&&this.viewport&&(y=e.now(),b=y-i[this.hash].lastZoomTime,V=Math.pow(i[this.hash].zoomFactor,b/1e3),this.viewport.zoomBy(V),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=y,it(this))}function Gt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function Et(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function lt(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function ct(){this.viewport&&this.viewport.goHome()}function xt(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function yt(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y+=this.rotationIncrement:y-=this.rotationIncrement,this.viewport.setRotation(y)}}function Pe(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y-=this.rotationIncrement:y+=this.rotationIncrement,this.viewport.setRotation(y)}}function ht(){this.viewport.toggleFlip()}e.determineDrawer=function(y){for(let b in t){const V=t[b],B=V.prototype;if(B&&B instanceof t.DrawerBase&&e.isFunction(B.getType)&&B.getType.call(V)===y)return V}return null}}(t),function(e){e.Navigator=function(h){var d=h.viewer,l=this,f,p;h.element||h.id?(h.element?(h.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),h.element.id?h.id=h.element.id:h.id="navigator-"+e.now(),this.element=h.element):this.element=document.getElementById(h.id),h.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(h.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),h.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:h.autoFade},h.position&&(h.position==="BOTTOM_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:h.position==="BOTTOM_LEFT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:h.position==="TOP_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:h.position==="TOP_LEFT"?h.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:h.position==="ABSOLUTE"&&(h.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,h.controlOptions.top=h.top,h.controlOptions.left=h.left,h.controlOptions.height=h.height,h.controlOptions.width=h.width))),this.element.id=h.id,this.element.className+=" navigator",h=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},h,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:h.animationTime,autoResize:!1,minZoomImageRatio:1,background:h.background,opacity:h.opacity,borderColor:h.borderColor,displayRegionColor:h.displayRegionColor}),h.minPixelRatio=this.minPixelRatio=d.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),h.controlOptions.anchor!==e.ControlAnchor.NONE&&function(w,x){w.margin="0px",w.border=x+"px solid "+h.borderColor,w.padding="0px",w.background=h.background,w.opacity=h.opacity,w.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(w,x){w.position="relative",w.top="0px",w.left="0px",w.fontSize="0px",w.overflow="hidden",w.border=x+"px solid "+h.displayRegionColor,w.margin="0px",w.padding="0px",w.background="transparent",w.float="left",w.cssFloat="left",w.zIndex=999999999,w.cursor="default",w.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),d.addControl(this.element,h.controlOptions),this._resizeWithViewer=h.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&h.controlOptions.anchor!==e.ControlAnchor.NONE,h.width&&h.height?(this.setWidth(h.width),this.setHeight(h.height)):this._resizeWithViewer&&(f=e.getElementSize(d.element),this.element.style.height=Math.round(f.y*h.sizeRatio)+"px",this.element.style.width=Math.round(f.x*h.sizeRatio)+"px",this.oldViewerSize=f,p=e.getElementSize(this.element),this.elementArea=p.x*p.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[h]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function m(w,x){a(l.displayRegionContainer,w),a(l.displayRegion,-w),l.viewport.setRotation(w,x)}if(h.navigatorRotate){var v=h.viewer.viewport?h.viewer.viewport.getRotation():h.viewer.degrees||0;m(v,!0),h.viewer.addHandler("rotate",function(w){m(w.degrees,w.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(w){w.eventType==="wheel"&&(w.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){l.viewport&&l.viewport.goHome(!0)}),d.world.addHandler("item-index-change",function(w){window.setTimeout(function(){var x=l.world.getItemAt(w.previousIndex);l.world.setItemIndex(x,w.newIndex)},1)}),d.world.addHandler("remove-item",function(w){var x=w.item,R=l._getMatchingItem(x);R&&l.world.removeItem(R)}),this.update(d.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var h=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);h.equals(this.oldContainerSize)||(this.viewport.resize(h,!0),this.viewport.goHome(!0),this.oldContainerSize=h,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(h){this.width=h,this.element.style.width=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(h){this.height=h,this.element.style.height=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(h){return this.viewport.setFlip(h),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(h){c(this.canvas,h),c(this.element,h)},update:function(h){var d,l,f,p,m,v;if(h||(h=this.viewer.viewport),d=e.getElementSize(this.viewer.element),this._resizeWithViewer&&d.x&&d.y&&!d.equals(this.oldViewerSize)&&(this.oldViewerSize=d,this.maintainSizeRatio||!this.elementArea?(l=d.x*this.sizeRatio,f=d.y*this.sizeRatio):(l=Math.sqrt(this.elementArea*(d.x/d.y)),f=this.elementArea/l),this.element.style.width=Math.round(l)+"px",this.element.style.height=Math.round(f)+"px",this.elementArea||(this.elementArea=l*f),this.updateSize()),h&&this.viewport){if(p=h.getBoundsNoRotate(!0),m=this.viewport.pixelFromPointNoRotate(p.getTopLeft(),!1),v=this.viewport.pixelFromPointNoRotate(p.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var w=h.getRotation(!0);a(this.displayRegion,-w)}var x=this.displayRegion.style;x.display=this.world.getItemCount()?"block":"none",x.top=m.y.toFixed(2)+"px",x.left=m.x.toFixed(2)+"px";var R=v.x-m.x,L=v.y-m.y;x.width=Math.round(Math.max(R,0))+"px",x.height=Math.round(Math.max(L,0))+"px"}},addTiledImage:function(h){var d=this,l=h.originalTiledImage;delete h.original;var f=e.extend({},h,{success:function(p){var m=p.item;m._originalForNavigator=l,d._matchBounds(m,l,!0),d._matchOpacity(m,l),d._matchCompositeOperation(m,l);function v(){d._matchBounds(m,l)}function w(){d._matchOpacity(m,l)}function x(){d._matchCompositeOperation(m,l)}l.addHandler("bounds-change",v),l.addHandler("clip-change",v),l.addHandler("opacity-change",w),l.addHandler("composite-operation-change",x)}});return e.Viewer.prototype.addTiledImage.apply(this,[f])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(h){for(var d=this.world.getItemCount(),l,f=0;f<d;f++)if(l=this.world.getItemAt(f),l._originalForNavigator===h)return l;return null},_matchBounds:function(h,d,l){var f=d.getBoundsNoRotate();h.setPosition(f.getTopLeft(),l),h.setWidth(f.width,l),h.setRotation(d.getRotation(),l),h.setClip(d.getClip()),h.setFlip(d.getFlip())},_matchOpacity:function(h,d){h.setOpacity(d.opacity)},_matchCompositeOperation:function(h,d){h.setCompositeOperation(d.compositeOperation)}});function i(h){var d={tracker:h.eventSource,position:h.position,quick:h.quick,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",d),!d.preventDefaultAction&&h.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(h.position.x=this.viewport.getContainerSize().x-h.position.x);var l=this.viewport.pointFromPixel(h.position);this.panVertical?this.panHorizontal||(l.x=this.viewer.viewport.getCenter(!0).x):l.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(l),this.viewer.viewport.applyConstraints()}}function n(h){var d={tracker:h.eventSource,position:h.position,delta:h.delta,speed:h.speed,direction:h.direction,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",d),!d.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(h.delta.x=0),this.panVertical||(h.delta.y=0),this.viewer.viewport.flipped&&(h.delta.x=-h.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(h.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(h){h.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(h){var d={tracker:h.eventSource,position:h.position,scroll:h.scroll,shift:h.shift,originalEvent:h.originalEvent,preventDefault:h.preventDefault};this.viewer.raiseEvent("navigator-scroll",d),h.preventDefault=d.preventDefault}function a(h,d){c(h,"rotate("+d+"deg)")}function c(h,d){h.style.webkitTransform=d,h.style.mozTransform=d,h.style.msTransform=d,h.style.oTransform=d,h.style.transform=d}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,c=i,h;for(h=0;h<r.length-1;h++)c=c[r[h]]||{};return o=c[r[h]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(d){var l=parseInt(d.match(/\d+/),10)+1;return l<a.length?a[l]:""})},setString:function(n,r){var o=n.split("."),a=i,c;for(c=0;c<o.length-1;c++)a[o[c]]||(a[o[c]]={}),a=a[o[c]];a[o[c]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var c=i*Math.PI/180;r=Math.cos(c),o=Math.sin(c)}var h=r*(this.x-n.x)-o*(this.y-n.y)+n.x,d=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(h,d)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,c,h){var d=this,l=arguments,f,p;if(e.isPlainObject(n)?f=n:f={width:l[0],height:l[1],tileSize:l[2],tileOverlap:l[3],minLevel:l[4],maxLevel:l[5]},e.EventSource.call(this),e.extend(!0,this,f),!this.success){for(p=0;p<arguments.length;p++)if(e.isFunction(arguments[p])){this.success=arguments[p];break}}this.success&&this.addHandler("ready",function(m){d.success(m)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=f.width&&f.height?f.width/f.height:1,this.dimensions=new e.Point(f.width,f.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=f.tileOverlap?f.tileOverlap:0,this.minLevel=f.minLevel?f.minLevel:0,this.maxLevel=f.maxLevel!==void 0&&f.maxLevel!==null?f.maxLevel:f.width&&f.height?Math.ceil(Math.log(Math.max(f.width,f.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),c=r.x*a,h=r.y*a,d=Math.floor(c/this.getTileWidth(n)),l=Math.floor(h/this.getTileHeight(n));r.x>=1&&(d=this.getNumTiles(n).x-1);var f=1e-15;return r.y>=1/this.aspectRatio-f&&(l=this.getNumTiles(n).y-1),new e.Point(d,l)},getTileBounds:function(n,r,o,a){var c=this.dimensions.times(this.getLevelScale(n)),h=this.getTileWidth(n),d=this.getTileHeight(n),l=r===0?0:h*r-this.tileOverlap,f=o===0?0:d*o-this.tileOverlap,p=h+(r===0?1:2)*this.tileOverlap,m=d+(o===0?1:2)*this.tileOverlap,v=1/c.x;return p=Math.min(p,c.x-l),m=Math.min(m,c.y-f),a?new e.Rect(0,0,p,m):new e.Rect(l*v,f*v,p*v,m*v)},getImageInfo:function(n){var r=this,o,a,c,h,d,l,f;n&&(d=n.split("/"),l=d[d.length-1],f=l.lastIndexOf("."),f>-1&&(d[d.length-1]=l.slice(0,f)));var p=null;if(this.splitHashDataForPost){var m=n.indexOf("#");m!==-1&&(p=n.substring(m+1),n=n.substr(0,m))}a=function(v){typeof v=="string"&&(v=e.parseXml(v));var w=e.TileSource.determineType(r,v,n);if(!w){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}h=w.prototype.configure.apply(r,[v,n,p]),h.ajaxWithCredentials===void 0&&(h.ajaxWithCredentials=r.ajaxWithCredentials),c=new w(h),r.ready=!0,r.raiseEvent("ready",{tileSource:c})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:p,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(v){var w=i(v);a(w)},error:function(v,w){var x;try{x="HTTP "+v.status+" attempting to load TileSource: "+n}catch{var R;typeof w>"u"||!w.toString?R="Unknown error":R=w.toString(),x=R+" attempting to load TileSource: "+n}e.console.error(x),r.raiseEvent("open-failed",{message:x,source:n,postData:p})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,c,h){function d(l){return c?l+"+"+JSON.stringify(c):l}return d(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(c){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(c?null:o,r.request,c)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(c){var h;try{h=new window.Blob([c.response])}catch(f){var d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(f.name==="TypeError"&&d){var l=new d;l.append(c.response),h=l.getBlob()}}h.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(h)},error:function(c){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,c;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{c=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{c=n.responseText}else if(r.match(/\s*[{[].*/))try{c=e.parseJSON(r)}catch{c=r}else c=r;return c}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,c,h,d,l,f,p){var m,v,w,x;if(e.isPlainObject(r)?x=r:x={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=x.tilesUrl,this.fileFormat=x.fileFormat,this.displayRects=x.displayRects,this.displayRects)for(m=this.displayRects.length-1;m>=0;m--)for(v=this.displayRects[m],w=v.minLevel;w<=v.maxLevel;w++)this._levelRects[w]||(this._levelRects[w]=[]),this._levelRects[w].push(v);e.TileSource.apply(this,[x])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var c;return e.isPlainObject(r)?c=n(this,r):c=i(this,r),o&&!c.tilesUrl&&(c.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?c.queryParams=o.match(/\?.*/):c.queryParams=""),c},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var c=this._levelRects[r],h,d,l,f,p,m,v;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!c||!c.length)return!0;for(v=c.length-1;v>=0;v--)if(h=c[v],!(r<h.minLevel||r>h.maxLevel)&&(d=this.getLevelScale(r),l=h.x*d,f=h.y*d,p=l+h.width*d,m=f+h.height*d,l=Math.floor(l/this._tileWidth),f=Math.floor(f/this._tileWidth),p=Math.ceil(p/this._tileWidth),m=Math.ceil(m/this._tileWidth),l<=o&&o<p&&f<=a&&a<m))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,c=a.localName||a.tagName,h=o.documentElement.namespaceURI,d=null,l=[],f,p,m,v,w;if(c==="Image")try{if(v=a.getElementsByTagName("Size")[0],v===void 0&&(v=a.getElementsByTagNameNS(h,"Size")[0]),d={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(v.getAttribute("Height"),10),Width:parseInt(v.getAttribute("Width"),10)}}},!e.imageFormatSupported(d.Image.Format))throw new Error(e.getString("Errors.ImageFormat",d.Image.Format.toUpperCase()));for(f=a.getElementsByTagName("DisplayRect"),f===void 0&&(f=a.getElementsByTagNameNS(h,"DisplayRect")[0]),w=0;w<f.length;w++)p=f[w],m=p.getElementsByTagName("Rect")[0],m===void 0&&(m=p.getElementsByTagNameNS(h,"Rect")[0]),l.push({Rect:{X:parseInt(m.getAttribute("X"),10),Y:parseInt(m.getAttribute("Y"),10),Width:parseInt(m.getAttribute("Width"),10),Height:parseInt(m.getAttribute("Height"),10),MinLevel:parseInt(p.getAttribute("MinLevel"),10),MaxLevel:parseInt(p.getAttribute("MaxLevel"),10)}});return l.length&&(d.Image.DisplayRect=l),n(r,d)}catch(L){throw L instanceof Error?L:new Error(e.getString("Errors.Dzi"))}else{if(c==="Collection")throw new Error(e.getString("Errors.Dzc"));if(c==="Error"){var x=a.getElementsByTagName("Message")[0],R=x.firstChild.nodeValue;throw new Error(R)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,c=a.Url,h=a.Format,d=a.Size,l=a.DisplayRect||[],f=parseInt(d.Width,10),p=parseInt(d.Height,10),m=parseInt(a.TileSize,10),v=parseInt(a.Overlap,10),w=[],x,R;for(R=0;R<l.length;R++)x=l[R].Rect,w.push(new e.DisplayRect(parseInt(x.X,10),parseInt(x.Y,10),parseInt(x.Width,10),parseInt(x.Height,10),parseInt(x.MinLevel,10),parseInt(x.MaxLevel,10)));return e.extend(!0,{width:f,height:p,tileSize:m,tileOverlap:v,minLevel:null,maxLevel:null,tilesUrl:c,fileFormat:h,displayRects:w},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var c=0;c<this.tiles.length;c++)for(var h=0;h<this.tiles[c].scaleFactors.length;h++){var d=this.tiles[c].scaleFactors[h];this.scale_factors.push(d),a.tileSizePerScaleFactor[d]={width:this.tiles[c].width,height:this.tiles[c].height||this.tiles[c].width}}}else if(i(a)){for(var l=Math.min(this.height,this.width),f=[256,512,1024],p=[],m=0;m<f.length;m++)f[m]<=l&&p.push(f[m]);p.length>0?a.tileSize=Math.max.apply(null,p):a.tileSize=l}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var v=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(v)*Math.LOG2E)}if(this.sizes){var w=this.sizes.length;(w===a.maxLevel||w===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((x,R)=>x.width-R.width),w===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,c){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,c,h){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=c.replace("/info.json",""),a.version=1;else{var l=a["@context"];if(Array.isArray(l)){for(var f=0;f<l.length;f++)if(typeof l[f]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(l[f])||l[f]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){l=l[f];break}}switch(l){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var p=0;p<a.preferredFormats.length;p++)if(t.imageFormatSupported(a.preferredFormats[p])){a.tileFormat=a.preferredFormats[p];break}}return a}else{var d=r(a);return d["@context"]="http://iiif.io/api/image/1.0/context.json",d["@id"]=c.replace("/info.xml",""),d.version=1,d}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var c=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(c=this.levels[a].width/this.levels[this.maxLevel].width),c}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var c=this.getLevelScale(a);return c?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var h=this.levelSizes[a],d=Math.ceil(h.width/this.getTileWidth(a)),l=Math.ceil(h.height/this.getTileHeight(a));return new e.Point(d,l)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,c){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var h=c.x>=0&&c.x<=1&&c.y>=0&&c.y<=1/this.aspectRatio;e.console.assert(h,"[TileSource.getTileAtPoint] must be called with a valid point.");var d=this.levelSizes[a].width,l=c.x*d,f=c.y*d,p=Math.floor(l/this.getTileWidth(a)),m=Math.floor(f/this.getTileHeight(a));c.x>=1&&(p=this.getNumTiles(a).x-1);var v=1e-15;return c.y>=1/this.aspectRatio-v&&(m=this.getNumTiles(a).y-1),new e.Point(p,m)}return e.TileSource.prototype.getTileAtPoint.call(this,a,c)},getTileUrl:function(a,c,h){if(this.emulateLegacyImagePyramid){var d=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(d=this.levels[a].url),d}var l="0",f=Math.pow(.5,this.maxLevel-a),p,m,v,w,x,R,L,j,G,J,M,A,C,k,F,O;return this.levelSizes?(p=this.levelSizes[a].width,m=this.levelSizes[a].height):(p=Math.ceil(this.width*f),m=Math.ceil(this.height*f)),v=this.getTileWidth(a),w=this.getTileHeight(a),x=Math.round(v/f),R=Math.round(w/f),this.version===1?F="native."+this.tileFormat:F="default."+this.tileFormat,p<v&&m<w?(this.version===2&&p===this.width?A="full":this.version===3&&p===this.width&&m===this.height?A="max":this.version===3?A=p+","+m:A=p+",",L="full"):(j=c*x,G=h*R,J=Math.min(x,this.width-j),M=Math.min(R,this.height-G),c===0&&h===0&&J===this.width&&M===this.height?L="full":L=[j,G,J,M].join(","),C=Math.min(v,p-c*v),k=Math.min(w,m-h*w),this.version===2&&C===this.width?A="full":this.version===3&&C===this.width&&k===this.height?A="max":this.version===3?A=C+","+k:A=C+","),O=[this._id,L,A,l,F].join("/"),O},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var c=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],h=Array.isArray(a.profile)?a.profile[0]:a.profile,d=c.indexOf(h)!==-1,l=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(l=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(l=a.extraFeatures.indexOf("sizeByWh")!==-1),!d||l}function n(a){for(var c=[],h=0;h<a.sizes.length;h++)c.push({url:a._id+"/full/"+a.sizes[h].width+","+(a.version===3?a.sizes[h].height:"")+"/0/default."+a.tileFormat,width:a.sizes[h].width,height:a.sizes[h].height});return c.sort(function(d,l){return d.width-l.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null;if(h==="info")try{return d={},o(c,d),d}catch(l){throw l instanceof Error?l:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,c,h){var d,l;if(a.nodeType===3&&h)l=a.nodeValue.trim(),l.match(/^\d*$/)&&(l=Number(l)),c[h]?(e.isArray(c[h])||(c[h]=[c[h]]),c[h].push(l)):c[h]=l;else if(a.nodeType===1)for(d=0;d<a.childNodes.length;d++)o(a.childNodes[d],c,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!c.width||!c.height)&&(c.width=65572864,c.height=65572864),c.tileSize||(c.tileSize=256,c.tileOverlap=0),c.tilesUrl||(c.tilesUrl="http://tile.openstreetmap.org/"),c.minLevel=8,e.TileSource.apply(this,[c])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var h=Math.ceil(c.width/256)*256,d=Math.ceil(c.height/256)*256,l;h>d?l=h/256:l=d/256,c.maxLevel=Math.ceil(Math.log(l)/Math.log(2))-1,c.tileSize=256,c.width=h,c.height=d,e.TileSource.apply(this,[c])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},c=0;c<i;c++)a=this.gridSize[c],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,c,h;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(c=a.levels[a.levels.length-1].width,h=a.levels[a.levels.length-1].height):(c=0,h=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:c,height:h,tileSize:Math.max(h,c),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,c){var h;return e.isPlainObject(o)?h=r(this,o):h=n(this,o),h},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,c){var h=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(h=this.levels[o].url),h}});function i(o){var a=[],c,h;for(h=0;h<o.length;h++)c=o[h],c.height&&c.width&&c.url?a.push({url:c.url,width:Number(c.width),height:Number(c.height)}):e.console.error("Unsupported image format: %s",c.url?c.url:"<no URL>");return a.sort(function(d,l){return d.height-l.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null,l=[],f,p;if(h==="image")try{for(d={type:c.getAttribute("type"),levels:[]},l=c.getElementsByTagName("level"),p=0;p<l.length;p++)f=l[p],d.levels.push({url:f.getAttribute("url"),width:parseInt(f.getAttribute("width"),10),height:parseInt(f.getAttribute("height"),10)});return r(o,d)}catch(m){throw m instanceof Error?m:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(h==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(h==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+h)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var c=document.createElement("canvas"),h=c.getContext("2d");c.width=n,c.height=r,h.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:h,width:n,height:r}),o=c,a=h}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(h){var d=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},h),this.element=h.element||e.makeNeutralElement("div"),h.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(l){l.insideElementPressed?(a(d,e.ButtonState.DOWN),d.raiseEvent("enter",{originalEvent:l.originalEvent})):l.buttonDownAny||a(d,e.ButtonState.HOVER)},focusHandler:function(l){d.tracker.enterHandler(l),d.raiseEvent("focus",{originalEvent:l.originalEvent})},leaveHandler:function(l){c(d,e.ButtonState.GROUP),l.insideElementPressed&&d.raiseEvent("exit",{originalEvent:l.originalEvent})},blurHandler:function(l){d.tracker.leaveHandler(l),d.raiseEvent("blur",{originalEvent:l.originalEvent})},pressHandler:function(l){a(d,e.ButtonState.DOWN),d.raiseEvent("press",{originalEvent:l.originalEvent})},releaseHandler:function(l){l.insideElementPressed&&l.insideElementReleased?(c(d,e.ButtonState.HOVER),d.raiseEvent("release",{originalEvent:l.originalEvent})):l.insideElementPressed?c(d,e.ButtonState.GROUP):a(d,e.ButtonState.HOVER)},clickHandler:function(l){l.quick&&d.raiseEvent("click",{originalEvent:l.originalEvent})},keyHandler:function(l){l.keyCode===13?(d.raiseEvent("click",{originalEvent:l.originalEvent}),d.raiseEvent("release",{originalEvent:l.originalEvent}),l.preventDefault=!0):l.preventDefault=!1}}),c(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){c(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(h){e.requestAnimationFrame(function(){n(h)})}function n(h){var d,l,f;h.shouldFade&&(d=e.now(),l=d-h.fadeBeginTime,f=1-l/h.fadeLength,f=Math.min(1,f),f=Math.max(0,f),h.imgGroup&&e.setElementOpacity(h.imgGroup,f,!0),f>0&&i(h))}function r(h){h.shouldFade=!0,h.fadeBeginTime=e.now()+h.fadeDelay,window.setTimeout(function(){i(h)},h.fadeDelay)}function o(h){h.shouldFade=!1,h.imgGroup&&e.setElementOpacity(h.imgGroup,1,!0)}function a(h,d){h.element.disabled||(d>=e.ButtonState.GROUP&&h.currentState===e.ButtonState.REST&&(o(h),h.currentState=e.ButtonState.GROUP),d>=e.ButtonState.HOVER&&h.currentState===e.ButtonState.GROUP&&(h.imgHover&&(h.imgHover.style.visibility=""),h.currentState=e.ButtonState.HOVER),d>=e.ButtonState.DOWN&&h.currentState===e.ButtonState.HOVER&&(h.imgDown&&(h.imgDown.style.visibility=""),h.currentState=e.ButtonState.DOWN))}function c(h,d){h.element.disabled||(d<=e.ButtonState.HOVER&&h.currentState===e.ButtonState.DOWN&&(h.imgDown&&(h.imgDown.style.visibility="hidden"),h.currentState=e.ButtonState.HOVER),d<=e.ButtonState.GROUP&&h.currentState===e.ButtonState.HOVER&&(h.imgHover&&(h.imgHover.style.visibility="hidden"),h.currentState=e.ButtonState.GROUP),d<=e.ButtonState.REST&&h.currentState===e.ButtonState.GROUP&&(r(h),h.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var c;for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupEnter()},leaveHandler:function(a){var c;if(!a.insideElementPressed)for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var c,h;this.degrees>=270?(c=this.getTopRight(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=270):this.degrees>=180?(c=this.getBottomRight(),this.x=c.x,this.y=c.y,this.degrees-=180):this.degrees>=90&&(c=this.getBottomLeft(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),c=n.minus(i),h=Math.atan(c.y/c.x);return c.x<0?h+=Math.PI:c.y<0&&(h+=2*Math.PI),new e.Rect(i.x,i.y,o,a,h/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),c=Math.max(n.x+n.width,r.x+r.width),h=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,c-o,h-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var c=this.getBottomLeft();i.containsPoint(c,n)&&r.push(c);var h=this.getBottomRight();i.containsPoint(h,n)&&r.push(h);var d=i.getTopLeft();this.containsPoint(d,n)&&r.push(d);var l=i.getTopRight();this.containsPoint(l,n)&&r.push(l);var f=i.getBottomLeft();this.containsPoint(f,n)&&r.push(f);var p=i.getBottomRight();this.containsPoint(p,n)&&r.push(p);for(var m=this._getSegments(),v=i._getSegments(),w=0;w<m.length;w++)for(var x=m[w],R=0;R<v.length;R++){var L=v[R],j=G(x[0],x[1],L[0],L[1]);j&&r.push(j)}function G(O,D,z,xe){var Se=D.minus(O),Me=xe.minus(z),re=-Me.x*Se.y+Se.x*Me.y;if(re===0)return null;var ve=(Se.x*(O.y-z.y)-Se.y*(O.x-z.x))/re,we=(Me.x*(O.y-z.y)-Me.y*(O.x-z.x))/re;return-n<=ve&&ve<=1-n&&-n<=we&&we<=1-n?new e.Point(O.x+we*Se.x,O.y+we*Se.y):null}if(r.length===0)return null;for(var J=r[0].x,M=r[0].x,A=r[0].y,C=r[0].y,k=1;k<r.length;k++){var F=r[k];F.x<J&&(J=F.x),F.x>M&&(M=F.x),F.y<A&&(A=F.y),F.y>C&&(C=F.y)}return new e.Rect(J,A,M-J,C-A)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(h){var d=1e-15;return Math.abs(h)<d?0:h});var c=Math.atan(a.y/a.x);return a.x<0?c+=Math.PI:a.y<0&&(c+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,c/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),c=Math.max(i.x,n.x,r.x,o.x),h=Math.min(i.y,n.y,r.y,o.y),d=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,h,c-a,d-h)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),c=o.minus(r),h=a.minus(r);return(i.x-r.x)*c.x+(i.y-r.y)*c.y>=-n&&(i.x-o.x)*c.x+(i.y-o.y)*c.y<=n&&(i.x-r.x)*h.x+(i.y-r.y)*h.y>=-n&&(i.x-a.x)*h.x+(i.y-a.y)*h.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(f){var p=this,m=f.viewer,v=e.getElementSize(m.element),w,x,R;for(f.id||(f.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=f.id,this.element.className="referencestrip"),f=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},f,{element:this.element}),e.extend(this,f),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,x=this.element.style,x.marginTop="0px",x.marginRight="0px",x.marginBottom="0px",x.marginLeft="0px",x.left="0px",x.bottom="0px",x.border="0px",x.background="#000",x.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=m,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,c),leaveHandler:e.delegate(this,h),keyDownHandler:e.delegate(this,d),keyHandler:e.delegate(this,l),preProcessEventHandler:function(L){L.eventType==="wheel"&&(L.preventDefault=!0)}}),f.width&&f.height?(this.element.style.width=f.width+"px",this.element.style.height=f.height+"px",m.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):f.scroll==="horizontal"?(this.element.style.width=v.x*f.sizeRatio*m.tileSources.length+12*m.tileSources.length+"px",this.element.style.height=v.y*f.sizeRatio+"px",m.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=v.y*f.sizeRatio*m.tileSources.length+12*m.tileSources.length+"px",this.element.style.width=v.x*f.sizeRatio+"px",m.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=v.x*this.sizeRatio+8,this.panelHeight=v.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},R=0;R<m.tileSources.length;R++)w=e.makeNeutralElement("div"),w.id=this.element.id+"-"+R,w.style.width=p.panelWidth+"px",w.style.height=p.panelHeight+"px",w.style.display="inline",w.style.float="left",w.style.cssFloat="left",w.style.padding="2px",e.setElementTouchActionNone(w),e.setElementPointerEventsNone(w),this.element.appendChild(w),w.activePanel=!1,this.panels.push(w);a(this,this.scroll==="vertical"?v.y:v.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(f){var p=this.element.querySelector("#"+this.element.id+"-"+f),m=e.getElementSize(this.viewer.canvas),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),x=-Number(this.element.style.marginLeft.replace("px","")),R=-Number(this.element.style.marginTop.replace("px","")),L;this.currentSelected!==p&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=p,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(L=Number(f)*(this.panelWidth+3),L>x+m.x-this.panelWidth?(L=Math.min(L,v-m.x),this.element.style.marginLeft=-L+"px",a(this,m.x,-L)):L<x&&(L=Math.max(0,L-m.x/2),this.element.style.marginLeft=-L+"px",a(this,m.x,-L))):(L=Number(f)*(this.panelHeight+3),L>R+m.y-this.panelHeight?(L=Math.min(L,w-m.y),this.element.style.marginTop=-L+"px",a(this,m.y,-L)):L<R&&(L=Math.max(0,L-m.y/2),this.element.style.marginTop=-L+"px",a(this,m.y,-L))),this.currentPage=f,c.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var f in this.miniViewers)this.miniViewers[f].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(f){if(f.quick){var p;this.scroll==="horizontal"?p=Math.floor(f.position.x/(this.panelWidth+4)):p=Math.floor(f.position.y/this.panelHeight),this.viewer.goToPage(p)}this.element.focus()}function r(f){if(this.dragging=!0,this.element){var p=Number(this.element.style.marginLeft.replace("px","")),m=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-f.delta.x>0?p>-(v-x.x)&&(this.element.style.marginLeft=p+f.delta.x*2+"px",a(this,x.x,p+f.delta.x*2)):-f.delta.x<0&&p<0&&(this.element.style.marginLeft=p+f.delta.x*2+"px",a(this,x.x,p+f.delta.x*2)):-f.delta.y>0?m>-(w-x.y)&&(this.element.style.marginTop=m+f.delta.y*2+"px",a(this,x.y,m+f.delta.y*2)):-f.delta.y<0&&m<0&&(this.element.style.marginTop=m+f.delta.y*2+"px",a(this,x.y,m+f.delta.y*2))}}function o(f){if(this.element){var p=Number(this.element.style.marginLeft.replace("px","")),m=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?f.scroll>0?p>-(v-x.x)&&(this.element.style.marginLeft=p-f.scroll*60+"px",a(this,x.x,p-f.scroll*60)):f.scroll<0&&p<0&&(this.element.style.marginLeft=p-f.scroll*60+"px",a(this,x.x,p-f.scroll*60)):f.scroll<0?m>x.y-w&&(this.element.style.marginTop=m+f.scroll*60+"px",a(this,x.y,m+f.scroll*60)):f.scroll>0&&m<0&&(this.element.style.marginTop=m+f.scroll*60+"px",a(this,x.y,m+f.scroll*60)),f.preventDefault=!0}}function a(f,p,m){var v,w,x,R,L,j;for(f.scroll==="horizontal"?v=f.panelWidth:v=f.panelHeight,w=Math.ceil(p/v)+5,x=Math.ceil((Math.abs(m)+p)/v)+1,w=x-w,w=w<0?0:w,L=w;L<x&&L<f.panels.length;L++)if(j=f.panels[L],!j.activePanel){var G,J=f.viewer.tileSources[L];J.referenceStripThumbnailUrl?G={type:"image",url:J.referenceStripThumbnailUrl}:G=J,R=new e.Viewer({id:j.id,tileSources:[G],element:j,navigatorSizeRatio:f.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:f.viewer.loadTilesWithAjax,ajaxHeaders:f.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(R.canvas),e.setElementPointerEventsNone(R.container),R.innerTracker.setTracking(!1),R.outerTracker.setTracking(!1),f.miniViewers[j.id]=R,j.activePanel=!0}}function c(f){var p=f.eventSource.element;this.scroll==="horizontal"?p.style.marginBottom="0px":p.style.marginLeft="0px"}function h(f){var p=f.eventSource.element;this.scroll==="horizontal"?p.style.marginBottom="-"+e.getElementSize(p).y/2+"px":p.style.marginLeft="-"+e.getElementSize(p).x/2+"px"}function d(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}function l(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,c){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=c},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(d){i(o,d,n.callback)},c={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},h=new e.ImageJob(c);!this.jobLimit||this.jobsInProgress<this.jobLimit?(h.start(),this.jobsInProgress++):this.jobQueue.push(h)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,c,h,d,l,f,p,m){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=f,this.exists=a,this._url=c,this.postData=p,this.context2D=h,this.loadWithAjax=d,this.ajaxHeaders=l,m===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),m=e.TileSource.prototype.getTileHashKey(i,n,r,c,l,p)),this.cacheKey=m,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(c){return c%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,c=this.size=o.size,h="";n.overlayPreserveContentDirection&&(h=n.flipped?" scaleX(-1)":" scaleX(1)");var d=n.flipped?-o.rotate:o.rotate,l=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,c,this.element);else{var f=this.style,p=this.element.style;p.display="block",f.left=a.x+"px",f.top=a.y+"px",this.width!==null&&(p.width=c.x+"px"),this.height!==null&&(p.height=c.y+"px");var m=e.getCssPropertyWithVendorPrefix("transformOrigin"),v=e.getCssPropertyWithVendorPrefix("transform");m&&v&&(d&&!n.flipped?(p[v]="",f[m]=this._getTransformOrigin(),f[v]="rotate("+d+"deg)"):!d&&n.flipped?(p[v]=h,f[m]=this._getTransformOrigin(),f[v]=l):d&&n.flipped?(p[v]=h,f[m]=this._getTransformOrigin(),f[v]="rotate("+d+"deg)"+l):(p[v]="",f[m]="",f[v]="")),f.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),c=this._getBoundingBox(a,i.getRotation(!0));n=c.getTopLeft(),r=c.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(c){c.opacity!==0&&a._drawTiles(c)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(d=>d.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var c=a.length-1;c>=0;c--){var h=a[c];this._drawTile(h),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:h})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var c=o.getImage();if(!c)return;o.element=e.makeNeutralElement("div"),o.imgElement=c.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(d){super(d),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let d=e.makeNeutralElement("canvas"),l=this._calculateCanvasSize();return d.width=l.x,d.height=l.y,d}draw(d){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const l of d)l.opacity!==0&&this._drawTiles(l)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(d){return!0}setImageSmoothingEnabled(d){this._imageSmoothingEnabled=!!d,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(d){var l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.strokeStyle=this.debugGridColor[0],l.fillStyle=this.debugGridColor[0],l.strokeRect(d.x*e.pixelDensityRatio,d.y*e.pixelDensityRatio,d.width*e.pixelDensityRatio,d.height*e.pixelDensityRatio),l.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(d,l,f,p){this.viewer.raiseEvent("tile-drawing",{tiledImage:d,context:l,tile:f,rendered:p})}_prepareNewFrame(){var d=this._calculateCanvasSize();if((this.canvas.width!==d.x||this.canvas.height!==d.y)&&(this.canvas.width=d.x,this.canvas.height=d.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var l=this._calculateSketchCanvasSize();this.sketchCanvas.width=l.x,this.sketchCanvas.height=l.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(d,l){var f=this._getContext(d);if(l)f.clearRect(l.x,l.y,l.width,l.height);else{var p=f.canvas;f.clearRect(0,0,p.width,p.height)}}_drawTiles(d){var l=d.getTilesToDraw().map(O=>O.tile);if(!(d.opacity===0||l.length===0&&!d.placeholderFillStyle)){var f=l[0],p;f&&(p=d.opacity<1||d.compositeOperation&&d.compositeOperation!=="source-over"||!d._isBottomItem()&&d.source.hasTransparency(f.context2D,f.getUrl(),f.ajaxHeaders,f.postData));var m,v,w=this.viewport.getZoom(!0),x=d.viewportToImageZoom(w);l.length>1&&x>d.smoothTileEdgesMinZoom&&!d.iOSDevice&&d.getRotation(!0)%360===0&&(p=!0,m=f.getScaleForEdgeSmoothing(),v=f.getTranslationForEdgeSmoothing(m,this._getCanvasSize(!1),this._getCanvasSize(!0)));var R;p&&(m||(R=this.viewport.viewportToViewerElementRectangle(d.getClippedBounds(!0)).getIntegerBoundingBox(),R=R.times(e.pixelDensityRatio)),this._clear(!0,R)),m||this._setRotations(d,p);var L=!1;if(d._clip){this._saveContext(p);var j=d.imageToViewportRectangle(d._clip,!0);j=j.rotate(-d.getRotation(!0),d._getRotationPoint(!0));var G=this.viewportToDrawerRectangle(j);m&&(G=G.times(m)),v&&(G=G.translate(v)),this._setClip(G,p),L=!0}if(d._croppingPolygons){var J=this;L||this._saveContext(p);try{var M=d._croppingPolygons.map(function(O){return O.map(function(D){var z=d.imageToViewportCoordinates(D.x,D.y,!0).rotate(-d.getRotation(!0),d._getRotationPoint(!0)),xe=J.viewportCoordToDrawerCoord(z);return m&&(xe=xe.times(m)),v&&(xe=xe.plus(v)),xe})});this._clipWithPolygons(M,p)}catch(O){e.console.error(O)}L=!0}if(d._hasOpaqueTile=!1,d.placeholderFillStyle&&d._hasOpaqueTile===!1){let O=this.viewportToDrawerRectangle(d.getBoundsNoRotate(!0));m&&(O=O.times(m)),v&&(O=O.translate(v));let D=null;typeof d.placeholderFillStyle=="function"?D=d.placeholderFillStyle(d,this.context):D=d.placeholderFillStyle,this._drawRectangle(O,D,p)}var A=c(d.subPixelRoundingForTransparency),C=!1;if(A===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)C=!0;else if(A===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var k=this.viewer&&this.viewer.isAnimating();C=!k}for(var F=0;F<l.length;F++)f=l[F],this._drawTile(f,d,p,m,v,C,d.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:d,tile:f});L&&this._restoreContext(p),m||(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(p),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(p)),p&&(m&&this._setRotations(d),this.blendSketch({opacity:d.opacity,scale:m,translate:v,compositeOperation:d.compositeOperation,bounds:R}),m&&(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(d,l),this._raiseTiledImageDrawnEvent(d,l)}}_drawDebugInfo(d,l){if(d.debugMode)for(var f=l.length-1;f>=0;f--){var p=l[f];try{this._drawDebugInfoOnTile(p,l.length,f,d)}catch(m){e.console.error(m)}}}_clipWithPolygons(d,l){var f=this._getContext(l);f.beginPath();for(const p of d)for(const[m,v]of p.entries())f[m===0?"moveTo":"lineTo"](v.x,v.y);f.clip()}_drawTile(d,l,f,p,m,v,w){e.console.assert(d,"[Drawer._drawTile] tile is required"),e.console.assert(l,"[Drawer._drawTile] drawingHandler is required");var x=this._getContext(f);p=p||1,this._drawTileToCanvas(d,x,l,p,m,v,w)}_drawTileToCanvas(d,l,f,p,m,v,w){var x=d.position.times(e.pixelDensityRatio),R=d.size.times(e.pixelDensityRatio),L;if(!d.context2D&&!d.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",d.toString());return}if(L=d.getCanvasContext(),!d.loaded||!L){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",d.toString());return}l.save(),typeof p=="number"&&p!==1&&(x=x.times(p),R=R.times(p)),m instanceof e.Point&&(x=x.plus(m)),l.globalAlpha===1&&d.hasTransparency&&(v&&(x.x=Math.round(x.x),x.y=Math.round(x.y),R.x=Math.round(R.x),R.y=Math.round(R.y)),l.clearRect(x.x,x.y,R.x,R.y)),this._raiseTileDrawingEvent(f,l,d,L);var j,G;d.sourceBounds?(j=Math.min(d.sourceBounds.width,L.canvas.width),G=Math.min(d.sourceBounds.height,L.canvas.height)):(j=L.canvas.width,G=L.canvas.height),l.translate(x.x+R.x/2,0),d.flipped&&l.scale(-1,1),l.drawImage(L.canvas,0,0,j,G,-R.x/2,x.y,R.x,R.y),l.restore()}_getContext(d){var l=this.context;if(d){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var f=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=f.x,this.sketchCanvas.height=f.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var p=this;this.viewer.addHandler("rotate",function m(){if(p.viewport.getRotation()!==0){p.viewer.removeHandler("rotate",m);var v=p._calculateSketchCanvasSize();p.sketchCanvas.width=v.x,p.sketchCanvas.height=v.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}l=this.sketchContext}return l}_saveContext(d){this._getContext(d).save()}_restoreContext(d){this._getContext(d).restore()}_setClip(d,l){var f=this._getContext(l);f.beginPath(),f.rect(d.x,d.y,d.width,d.height),f.clip()}_drawRectangle(d,l,f){var p=this._getContext(f);p.save(),p.fillStyle=l,p.fillRect(d.x,d.y,d.width,d.height),p.restore()}blendSketch(d,l,f,p){var m=d;e.isPlainObject(m)||(m={opacity:d,scale:l,translate:f,compositeOperation:p}),d=m.opacity,p=m.compositeOperation;var v=m.bounds;if(this.context.save(),this.context.globalAlpha=d,p&&(this.context.globalCompositeOperation=p),v)v.x<0&&(v.width+=v.x,v.x=0),v.x+v.width>this.canvas.width&&(v.width=this.canvas.width-v.x),v.y<0&&(v.height+=v.y,v.y=0),v.y+v.height>this.canvas.height&&(v.height=this.canvas.height-v.y),this.context.drawImage(this.sketchCanvas,v.x,v.y,v.width,v.height,v.x,v.y,v.width,v.height);else{l=m.scale||1,f=m.translate;var w=f instanceof e.Point?f:new e.Point(0,0),x=0,R=0;if(f){var L=this.sketchCanvas.width-this.canvas.width,j=this.sketchCanvas.height-this.canvas.height;x=Math.round(L/2),R=Math.round(j/2)}this.context.drawImage(this.sketchCanvas,w.x-x*l,w.y-R*l,(this.canvas.width+2*x)*l,(this.canvas.height+2*R)*l,-x,-R,this.canvas.width+2*x,this.canvas.height+2*R)}this.context.restore()}_drawDebugInfoOnTile(d,l,f,p){var m=this.viewer.world.getIndexOfItem(p)%this.debugGridColor.length,v=this.context;v.save(),v.lineWidth=2*e.pixelDensityRatio,v.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",v.strokeStyle=this.debugGridColor[m],v.fillStyle=this.debugGridColor[m],this._setRotations(p),this._viewportFlipped&&this._flip({point:d.position.plus(d.size.divide(2))}),v.strokeRect(d.position.x*e.pixelDensityRatio,d.position.y*e.pixelDensityRatio,d.size.x*e.pixelDensityRatio,d.size.y*e.pixelDensityRatio);var w=(d.position.x+d.size.x/2)*e.pixelDensityRatio,x=(d.position.y+d.size.y/2)*e.pixelDensityRatio;v.translate(w,x);const R=this.viewport.getRotation(!0);v.rotate(Math.PI/180*-R),v.translate(-w,-x),d.x===0&&d.y===0&&(v.fillText("Zoom: "+this.viewport.getZoom(),d.position.x*e.pixelDensityRatio,(d.position.y-30)*e.pixelDensityRatio),v.fillText("Pan: "+this.viewport.getBounds().toString(),d.position.x*e.pixelDensityRatio,(d.position.y-20)*e.pixelDensityRatio)),v.fillText("Level: "+d.level,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+20)*e.pixelDensityRatio),v.fillText("Column: "+d.x,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+30)*e.pixelDensityRatio),v.fillText("Row: "+d.y,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+40)*e.pixelDensityRatio),v.fillText("Order: "+f+" of "+l,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+50)*e.pixelDensityRatio),v.fillText("Size: "+d.size.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+60)*e.pixelDensityRatio),v.fillText("Position: "+d.position.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),p.getRotation(!0)%360!==0&&this._restoreRotationChanges(),v.restore()}_updateImageSmoothingEnabled(d){d.msImageSmoothingEnabled=this._imageSmoothingEnabled,d.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(d){var l=this._getContext(d).canvas;return new e.Point(l.width,l.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(d,l=!1){var f=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:l,saveContext:f}),f=!1),d.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:d.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(d._getRotationPoint(!0),!0),useSketch:l,saveContext:f})}_offsetForRotation(d){var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(d.useSketch);f.save(),f.translate(l.x,l.y),f.rotate(Math.PI/180*d.degrees),f.translate(-l.x,-l.y)}_flip(d){d=d||{};var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(d.useSketch);f.translate(l.x,0),f.scale(-1,1),f.translate(-l.x,0)}_restoreRotationChanges(d){var l=this._getContext(d);l.restore()}_calculateCanvasSize(){var d=e.pixelDensityRatio,l=this.viewport.getContainerSize();return{x:Math.round(l.x*d),y:Math.round(l.y*d)}}_calculateSketchCanvasSize(){var d=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return d;var l=Math.ceil(Math.sqrt(d.x*d.x+d.y*d.y));return{x:l,y:l}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(h){return h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(h){return o(h)?r:h}function c(h){if(typeof h=="number")return a(h);if(!h||!e.Browser)return r;var d=h[e.Browser.vendor];return o(d)&&(d=h["*"]),a(d)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let c=0;c<o;++c)r.activeTexture(r.TEXTURE0+c),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let c={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},h=this.viewport.flipped?-1:1,d=e.Mat3.makeTranslation(-c.center.x,-c.center.y),l=e.Mat3.makeScaling(2/c.bounds.width*h,-2/c.bounds.height),f=e.Mat3.makeRotation(-c.rotation),p=l.multiply(f).multiply(d);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let m=!1;r.forEach((v,w)=>{if(v.isTainted()){m&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),m=!1);const x=this._getBackupCanvasDrawer();x.draw([v]),this._outputContext.drawImage(x.canvas,0,0)}else{let x=v.getTilesToDraw();if(v.placeholderFillStyle&&v._hasOpaqueTile===!1&&this._drawPlaceholder(v),x.length===0||v.getOpacity()===0)return;let R=x[0],L=v.compositeOperation||this.viewer.compositeOperation||v._clip||v._croppingPolygons||v.debugMode,j=L||v.opacity<1||R.hasTransparency;L&&(m&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),j?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let G=p,J=v.getRotation(!0);if(J%360!==0){let O=e.Mat3.makeRotation(-J*Math.PI/180),D=v.getBoundsNoRotate(!0).getCenter(),z=e.Mat3.makeTranslation(D.x,D.y),xe=e.Mat3.makeTranslation(-D.x,-D.y),Se=z.multiply(O).multiply(xe);G=p.multiply(Se)}let M=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(M<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${M}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let A=new Float32Array(M*12),C=new Array(M),k=new Array(M),F=new Array(M);for(let O=0;O<x.length;O++){let D=x[O].tile,z=O%M,xe=z+1,Se=D.getCanvasContext(),Me=Se?this._TextureMap.get(Se.canvas):null;if(Me||(this._tileReadyHandler({tile:D,tiledImage:v}),Me=Se?this._TextureMap.get(Se.canvas):null),Me&&this._getTileData(D,v,Me,G,z,A,C,k,F),xe===M||O===x.length-1){for(let re=0;re<=xe;re++)o.activeTexture(o.TEXTURE0+re),o.bindTexture(o.TEXTURE_2D,C[re]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,A,o.DYNAMIC_DRAW),k.forEach((re,ve)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[ve],!1,re)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(F)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*xe)}}j&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,v.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),m=!0,L&&(this._applyContext2dPipeline(v,x,w),m=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),w===0&&this._raiseTiledImageDrawnEvent(v,x.map(O=>O.tile))}}),m&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const c=this.viewer.viewport.getFlip();c&&this._flip(),this._drawDebugInfo(o,r,c),c&&this._flip()}}_getTileData(r,o,a,c,h,d,l,f,p){let m=a.texture,v=a.position;d.set(v,h*12);let w=this._calculateOverlapFraction(r,o),x=r.positionedBounds.width*w.x,R=r.positionedBounds.height*w.y,L=r.positionedBounds.x+(r.x===0?0:x),j=r.positionedBounds.y+(r.y===0?0:R),G=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:x),J=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:R),M=G-L,A=J-j,C=new e.Mat3([M,0,0,0,A,0,L,j,1]);if(r.flipped){let F=e.Mat3.makeTranslation(.5,0),O=e.Mat3.makeTranslation(-.5,0),D=F.multiply(e.Mat3.makeScaling(-1,1)).multiply(O);C=C.multiply(D)}let k=c.multiply(C);p[h]=r.opacity,l[h]=m,f[h]=k.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(m=>`uniform mat3 u_matrix_${m};`).join(`
`),a=()=>[...Array(r).keys()].map(m=>`${m>0?"else ":""}if(int(a_index) == ${m}) { transform_matrix = u_matrix_${m}; }`).join(`
`);const c=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,h=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let d=this._gl,l=this.constructor.initShaderProgram(d,c,h);d.useProgram(l),this._firstPass={shaderProgram:l,aOutputPosition:d.getAttribLocation(l,"a_output_position"),aTexturePosition:d.getAttribLocation(l,"a_texture_position"),aIndex:d.getAttribLocation(l,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(m=>d.getUniformLocation(l,`u_matrix_${m}`)),uImages:d.getUniformLocation(l,"u_images"),uOpacities:d.getUniformLocation(l,"u_opacities"),bufferOutputPosition:d.createBuffer(),bufferTexturePosition:d.createBuffer(),bufferIndex:d.createBuffer()},d.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let f=new Float32Array(r*12);for(let m=0;m<r;++m)f.set(Float32Array.from(this._unitQuad),m*12);d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),d.bufferData(d.ARRAY_BUFFER,f,d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aOutputPosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),d.enableVertexAttribArray(this._firstPass.aTexturePosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferIndex);let p=[...Array(this._glNumTextures).keys()].map(m=>Array(6).fill(m)).flat();d.bufferData(d.ARRAY_BUFFER,new Float32Array(p),d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,c=this.constructor.initShaderProgram(a,r,o);a.useProgram(c),this._secondPass={shaderProgram:c,aOutputPosition:a.getAttribLocation(c,"a_output_position"),aTexturePosition:a.getAttribLocation(c,"a_texture_position"),uMatrix:a.getUniformLocation(c,"u_matrix"),uImage:a.getUniformLocation(c,"u_image"),uOpacityMultiplier:a.getUniformLocation(c,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let h=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,h.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,c){return new Float32Array([r,c,o,c,r,a,r,a,o,c,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let c=o.getCanvasContext(),h=c&&c.canvas;if(!h||e.isCanvasTainted(h)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(h)){let l=this._gl,f=l.createTexture(),p,m=a.source.tileOverlap,v,w;if(o.sourceBounds?(v=Math.min(o.sourceBounds.width,h.width)/h.width,w=Math.min(o.sourceBounds.height,h.height)/h.height):(v=1,w=1),m>0){let R=this._calculateOverlapFraction(o,a),L=(o.x===0?0:R.x)*v,j=(o.y===0?0:R.y)*w,G=(o.isRightMost?1:1-R.x)*v,J=(o.isBottomMost?1:1-R.y)*w;p=this._makeQuadVertexBuffer(L,G,j,J)}else v===1&&w===1?p=this._unitQuad:p=this._makeQuadVertexBuffer(0,v,0,w);let x={texture:f,position:p};this._TextureMap.set(h,x),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,f),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,this._textureFilter()),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(c)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,c=r.sourceBounds.width,h=r.sourceBounds.height,d=(r.x===0?0:a)+(r.isRightMost?0:a),l=(r.y===0?0:a)+(r.isBottomMost?0:a),f=a/(c+d),p=a/(h+l);return{x:f,y:p}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(c){e.console.error("Error uploading image data to WebGL",c)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)});this._clippingContext.beginPath(),a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var c=r.length-1;c>=0;c--){var h=r[c].tile;try{this._drawDebugInfoOnTile(h,r.length,c,o,a)}catch(d){e.console.error(d)}}}_drawDebugInfoOnTile(r,o,a,c,h){var d=this.viewer.world.getIndexOfItem(c)%this.debugGridColor.length,l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",l.strokeStyle=this.debugGridColor[d],l.fillStyle=this.debugGridColor[d],this._setRotations(c),h&&this._flip({point:r.position.plus(r.size.divide(2))}),l.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var f=(r.position.x+r.size.x/2)*e.pixelDensityRatio,p=(r.position.y+r.size.y/2)*e.pixelDensityRatio;l.translate(f,p);const m=this.viewport.getRotation(!0);l.rotate(Math.PI/180*-m),l.translate(-f,-p),r.x===0&&r.y===0&&(l.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),l.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),l.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),l.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),l.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),l.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),l.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),l.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),c.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),c=this._outputContext;let h;typeof r.placeholderFillStyle=="function"?h=r.placeholderFillStyle(r,c):h=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),c.fillStyle=h,c.translate(a.x,a.y),c.rotate(Math.PI/180*o.degrees),c.translate(-a.x,-a.y),c.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function c(f,p,m){const v=f.createShader(p);return f.shaderSource(v,m),f.compileShader(v),f.getShaderParameter(v,f.COMPILE_STATUS)?v:(e.console.error(`An error occurred compiling the shaders: ${f.getShaderInfoLog(v)}`),f.deleteShader(v),null)}const h=c(r,r.VERTEX_SHADER,o),d=c(r,r.FRAGMENT_SHADER,a),l=r.createProgram();return r.attachShader(l,h),r.attachShader(l,d),r.linkProgram(l),r.getProgramParameter(l,r.LINK_STATUS)?l:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(l)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,c,h,d,l,f,p;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),c=1/a,h=c/this.getAspectRatio(),d=new e.Rect(n.x-c/2,n.y-h/2,c,h),l=this._pixelFromPoint(this.zoomPoint,d),f=l.minus(o).rotate(-this.getRotation(!0)),p=f.divide(this._containerInnerSize.x*a),r.plus(p)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var c=n.x+n.width,h=r.x+r.width,d,l,f;n.width>r.width?d=this.visibilityRatio*r.width:d=this.visibilityRatio*n.width,l=r.x-c+d,f=h-n.x-d,d>r.width?(n.x+=(l+f)/2,o=!0):f<0?(n.x+=f,o=!0):l>0&&(n.x+=l,o=!0)}if(!this.wrapVertical){var p=n.y+n.height,m=r.y+r.height,v,w,x;n.height>r.height?v=this.visibilityRatio*r.height:v=this.visibilityRatio*n.height,w=r.y-p+v,x=m-n.y-v,v>r.height?(n.y+=(w+x)/2,a=!0):x<0?(n.y+=x,a=!0):w>0&&(n.y+=w,a=!0)}var R=o||a,L=R?this.viewerElementToViewportRectangle(n):i.clone();return L.xConstrained=o,L.yConstrained=a,L.constraintApplied=R,L},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),c=i.getCenter(),h=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();h.getAspectRatio()>=a?h.height=h.width/a:h.width=h.height*a,h.x=c.x-h.width/2,h.y=c.y-h.height/2;var d=1/h.width;if(r)return this.panTo(c,!0),this.zoomTo(d,null,!0),o&&this.applyConstraints(!0),this;var l=this.getCenter(!0),f=this.getZoom(!0);this.panTo(l,!0),this.zoomTo(f,null,!0);var p=this.getBounds(),m=this.getZoom();if(m===0||Math.abs(d/m-1)<1e-8)return this.zoomTo(d,null,!0),this.panTo(c,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(c,!1),d=this._applyZoomConstraints(d),this.zoomTo(d,null,!1);var v=this.getConstrainedBounds();this.panTo(l,!0),this.zoomTo(f,null,!0),this.fitBounds(v)}else{var w=h.rotate(-this.getRotation()),x=w.getTopLeft().times(d).minus(p.getTopLeft().times(m)).divide(d-m);this.zoomTo(d,x,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),c=e.positiveModulo(i,360),h=c-a;h>180?c-=360:h<-180&&(c+=360);var d=a-c;this.degreesSpring.resetTo(i+d),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var c=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),c},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.imageToViewportRectangle(i,n,r,o,!0)}}var d=this.imageToViewportCoordinates(a.x,a.y),l=this._imageToViewportDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.viewportToImageRectangle(i,n,r,o,!0)}}var d=this.viewportToImageCoordinates(a.x,a.y),l=this._viewportToImageDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=a/o*c;return i*h},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=o/a/c;return i*h},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var c=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var h=i.degrees||0;delete i.degrees;var d=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:h,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,c,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(d,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),c=n||r||o||a||this._needsUpdate;if(c||i||!this._fullyLoaded){let h=this._updateLevelsForViewport();this._setFullyLoaded(h)}return this._needsUpdate=!1,c?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,c=(o.y+r%o.y)%o.y,h=this.source.getTileBounds(i,a,c);return this.getFlip()&&(h.x=Math.max(0,1-h.x-h.width)),h.x+=(n-a)/o.x,h.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-c)/o.y),h},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var c=i;c instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.imageToViewportCoordinates(c.getTopLeft(),a),d=this._imageToViewportDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var c=i;i instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.viewportToImageCoordinates(c.getTopLeft(),a),d=this._viewportToImageDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,c=0,h=0,d=1,l=1;if(this._clip&&(a=this._clip.getAspectRatio(),d=this._clip.width/this.source.dimensions.x,l=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(c=this._clip.x/this._clip.height*i.height,h=this._clip.y/this._clip.height*i.height):(c=this._clip.x/this._clip.width*i.width,h=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var f=i.height/l,p=0;o.isHorizontallyCentered?p=(i.width-i.height*a)/2:o.isRight&&(p=i.width-i.height*a),this.setPosition(new e.Point(i.x-c+p,i.y-h),r),this.setHeight(f,r)}else{var m=i.width/d,v=0;o.isVerticallyCentered?v=(i.height-i.width/a)/2:o.isBottom&&(v=i.height-i.width/a),this.setPosition(new e.Point(i.x-c,i.y-h+v),r),this.setWidth(m,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var c in this.tilesMatrix){n=this.source.getNumTiles(c);for(var h in this.tilesMatrix[c]){r=(n.x+h%n.x)%n.x;for(var d in this.tilesMatrix[c][h])if(o=(n.y+d%n.y)%n.y,a=this.tilesMatrix[c][h][d],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var l=this.source.getTileAjaxHeaders(c,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,l)}else a.ajaxHeaders=null}}for(var f=0;f<this._imageLoader.jobQueue.length;f++){var p=this._imageLoader.jobQueue[f];p.loadWithAjax=p.tile.loadWithAjax,p.ajaxHeaders=p.tile.loadWithAjax?p.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),c=e.now();if(this._lastDrawn.forEach(G=>{G.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var h=new Array(r-n+1);for(let G=0,J=r;J>=n;J--,G++)h[G]=J;for(let G=r+1;G<=this.source.maxLevel;G++){var d=this.tilesMatrix[G]&&this.tilesMatrix[G][0]&&this.tilesMatrix[G][0][0];if(d&&d.isBottomMost&&d.isRightMost&&d.loaded){h.push(G);break}}let l=!1;for(let G=0;G<h.length;G++){let J=h[G];var f=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!0).x*this._scaleSpring.current.value;if(G===h.length-1||f>=this.minPixelRatio)l=!0;else if(!l)continue;var p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!1).x*this._scaleSpring.current.value,m=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,v=this.immediateRender?1:m,w=Math.min(1,(f-.5)/.5),x=v/Math.abs(v-p),R=this._updateLevel(J,w,x,a,c,o);o=R.bestTiles;var L=R.updatedTiles.filter(M=>M.loaded),j=function(M,A,C){return function(k){return{tile:k,level:M,levelOpacity:A,currentTime:C}}}(J,w,c);if(this._tilesToDraw[J]=L.map(j),this._providesCoverage(this.coverage,J))break}return o&&o.length>0?(o.forEach(function(G){G&&!G.context2D&&this._loadTile(G,c)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function c(d){let l=d.tile;if(l&&l.loaded){let f=r._blendTile(l,l.x,l.y,d.level,d.levelOpacity,n,o);r._isBlending=r._isBlending||f,r._needsDraw=r._needsDraw||f||r._wasBlending}}let h=0;for(let d=0;d<i.length;d++){let l=i[d];c(l),this._providesCoverage(this.coverage,l.level)&&(h=Math.max(h,l.level))}if(h>0)for(let d in this._tilesToDraw)d<h&&delete this._tilesToDraw[d]},_blendTile:function(i,n,r,o,a,c,h){let d=1e3*this.blendTime,l,f;return i.blendStart||(i.blendStart=c),l=c-i.blendStart,f=d?Math.min(1,l/d):1,o===h&&(f=1,l=d),this.alwaysBlend&&(f*=a),i.opacity=f,f===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),l<d},_updateLevel:function(i,n,r,o,a,c){var h=o.getBoundingBox().getTopLeft(),d=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:h,bottomright:d,currenttime:a,best:c}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var l=this._getCornerTiles(i,h,d),f=l.topLeft,p=l.bottomRight,m=this.source.getNumTiles(i),v=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(p.x+=1,this.wrapHorizontal||(p.x=Math.min(p.x,m.x-1)));for(var w=Math.max(0,(p.x-f.x)*(p.y-f.y)),x=new Array(w),R=0,L=f.x;L<=p.x;L++)for(var j=f.y;j<=p.y;j++){var G;if(this.getFlip()){var J=(m.x+L%m.x)%m.x;G=L+m.x-J-J-1}else G=L;if(o.intersection(this.getTileBounds(i,G,j))!==null){var M=this._updateTile(G,j,i,r,v,m,a,c);c=M.bestTiles,x[R]=M.tile,R+=1}}return{bestTiles:c,updatedTiles:x}},_positionTile:function(i,n,r,o,a){var c=i.bounds.getTopLeft();c.x*=this._scaleSpring.current.value,c.y*=this._scaleSpring.current.value,c.x+=this._xSpring.current.value,c.y+=this._ySpring.current.value;var h=i.bounds.getSize();h.x*=this._scaleSpring.current.value,h.y*=this._scaleSpring.current.value,i.positionedBounds.x=c.x,i.positionedBounds.y=c.y,i.positionedBounds.width=h.x,i.positionedBounds.height=h.y;var d=r.pixelFromPointNoRotate(c,!0),l=r.pixelFromPointNoRotate(c,!1),f=r.deltaPixelsFromPointsNoRotate(h,!0),p=r.deltaPixelsFromPointsNoRotate(h,!1),m=l.plus(p.divide(2)),v=o.squaredDistanceTo(m);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(f=f.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(f.x+=.75),i.isBottomMost&&this.wrapVertical&&(f.y+=.75)),i.position=d,i.size=f,i.squaredDistance=v,i.visibility=a},_updateTile:function(i,n,r,o,a,c,h,d){var l=this._getTile(i,n,r,h,c);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:l}),this._setCoverage(this.coverage,r,i,n,!1);var f=l.loaded||l.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,f),!l.exists)return{bestTiles:d,tile:l};if(l.loaded&&l.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(l,this.source.tileOverlap,this.viewport,a,o),!l.loaded)if(l.context2D)this._setTileLoaded(l);else{var p=this._tileCache.getImageRecord(l.cacheKey);p&&this._setTileLoaded(l,p.getData())}return l.loading?this._tilesLoading++:f||(d=this._compareTiles(d,l,this.maxTilesPerFrame)),{bestTiles:d,tile:l}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var c,h,d=1/this.source.aspectRatio;this.wrapVertical?(c=e.positiveModulo(n.y,d),h=e.positiveModulo(r.y,d)):(c=Math.max(0,n.y),h=Math.min(d,r.y));var l=this.source.getTileAtPoint(i,new e.Point(o,c)),f=this.source.getTileAtPoint(i,new e.Point(a,h)),p=this.source.getNumTiles(i);return this.wrapHorizontal&&(l.x+=p.x*Math.floor(n.x),f.x+=p.x*Math.floor(r.x)),this.wrapVertical&&(l.y+=p.y*Math.floor(n.y/d),f.y+=p.y*Math.floor(r.y/d)),{topLeft:l,bottomRight:f}},_getTile:function(i,n,r,o,a){var c,h,d,l,f,p,m,v,w,x,R=this.tilesMatrix,L=this.source;return R[r]||(R[r]={}),R[r][i]||(R[r][i]={}),(!R[r][i][n]||!R[r][i][n].flipped!=!this.flipped)&&(c=(a.x+i%a.x)%a.x,h=(a.y+n%a.y)%a.y,d=this.getTileBounds(r,i,n),l=L.getTileBounds(r,c,h,!0),f=L.tileExists(r,c,h),p=L.getTileUrl(r,c,h),m=L.getTilePostData(r,c,h),this.loadTilesWithAjax?(v=L.getTileAjaxHeaders(r,c,h),e.isPlainObject(this.ajaxHeaders)&&(v=e.extend({},this.ajaxHeaders,v))):v=null,w=L.getContext2D?L.getContext2D(r,c,h):void 0,x=new e.Tile(r,i,n,d,f,p,w,this.loadTilesWithAjax,v,l,m,L.getTileHashKey(r,c,h,p,v,m)),this.getFlip()?c===0&&(x.isRightMost=!0):c===a.x-1&&(x.isRightMost=!0),h===a.y-1&&(x.isBottomMost=!0),x.flipped=this.flipped,R[r][i][n]=x),x=R[r][i][n],x.lastTouchTime=o,x},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,c){r._onTileLoad(i,n,o,a,c)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var c=this,h=function(){var d=c.source,l=d.getClosestLevel();c._setTileLoaded(i,r,l,a)};h()},_setTileLoaded:function(i,n,r,o){var a=0,c=!1,h=this;function d(){return c&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,l}function l(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=h.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||h._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:h}),h.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:h,tileRequest:o}),h._needsDraw=!0)}var f=d();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:d}),c=!0,f()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,c,h,d;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(h in a)if(Object.prototype.hasOwnProperty.call(a,h)){c=a[h];for(d in c)if(Object.prototype.hasOwnProperty.call(c,d)&&!c[d])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,c=this._imagesLoaded[r.tile.cacheKey];if(c||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),c=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),c.addTile(r.tile),r.tile.cacheImageRecord=c,this._imagesLoadedCount>this._maxImageCacheCount){for(var h=null,d=-1,l=null,f,p,m,v,w,x,R=this._tilesLoaded.length-1;R>=0;R--)if(x=this._tilesLoaded[R],f=x.tile,!(f.level<=o||f.beingDrawn)){if(!h){h=f,d=R,l=x;continue}v=f.lastTouchTime,p=h.lastTouchTime,w=f.level,m=h.level,(v<p||v===p&&w>m)&&(h=f,d=R,l=x)}h&&d>=0&&(this._unloadTile(l),a=d)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let c=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var h=this._imagesLoaded[o.cacheKey];h&&(h.removeTile(o),h.getTileCount()||(h.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,c&&(c.canvas.width=0,c.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:c,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,c=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,h=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,d=c+h,l;!i.rows&&a?l=a:l=Math.ceil(this._items.length/o);var f=0,p=0,m,v,w,x,R;this.setAutoRefigureSizes(!1);for(var L=0;L<this._items.length;L++)L&&L%l===0&&(r==="horizontal"?(p+=d,f=0):(f+=d,p=0)),m=this._items[L],v=m.getBounds(),v.width>v.height?w=c:w=c*(v.width/v.height),x=w*(v.height/v.width),R=new e.Point(f+(c-w)/2,p+(c-x)/2),m.setPosition(R,n),m.setWidth(w,n),r==="horizontal"?f+=d:p+=d;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var c=o.getClippedBounds().getBoundingBox(),h=c.x,d=c.y,l=c.x+c.width,f=c.y+c.height,p=1;p<this._items.length;p++)o=this._items[p],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),c=o.getClippedBounds().getBoundingBox(),h=Math.min(h,c.x),d=Math.min(d,c.y),l=Math.max(l,c.x+c.width),f=Math.max(f,c.y+c.height);this._homeBounds=new e.Rect(h,d,l-h,f-d),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(Tc);var Ku=Tc.exports;const Ue=Yu(Ku);var Vt={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(s){(function(){var t=function(){this.init()};t.prototype={init:function(){var l=this||e;return l._counter=1e3,l._html5AudioPool=[],l.html5PoolSize=10,l._codecs={},l._howls=[],l._muted=!1,l._volume=1,l._canPlayEvent="canplaythrough",l._navigator=typeof window<"u"&&window.navigator?window.navigator:null,l.masterGain=null,l.noAudio=!1,l.usingWebAudio=!0,l.autoSuspend=!0,l.ctx=null,l.autoUnlock=!0,l._setup(),l},volume:function(l){var f=this||e;if(l=parseFloat(l),f.ctx||d(),typeof l<"u"&&l>=0&&l<=1){if(f._volume=l,f._muted)return f;f.usingWebAudio&&f.masterGain.gain.setValueAtTime(l,e.ctx.currentTime);for(var p=0;p<f._howls.length;p++)if(!f._howls[p]._webAudio)for(var m=f._howls[p]._getSoundIds(),v=0;v<m.length;v++){var w=f._howls[p]._soundById(m[v]);w&&w._node&&(w._node.volume=w._volume*l)}return f}return f._volume},mute:function(l){var f=this||e;f.ctx||d(),f._muted=l,f.usingWebAudio&&f.masterGain.gain.setValueAtTime(l?0:f._volume,e.ctx.currentTime);for(var p=0;p<f._howls.length;p++)if(!f._howls[p]._webAudio)for(var m=f._howls[p]._getSoundIds(),v=0;v<m.length;v++){var w=f._howls[p]._soundById(m[v]);w&&w._node&&(w._node.muted=l?!0:w._muted)}return f},stop:function(){for(var l=this||e,f=0;f<l._howls.length;f++)l._howls[f].stop();return l},unload:function(){for(var l=this||e,f=l._howls.length-1;f>=0;f--)l._howls[f].unload();return l.usingWebAudio&&l.ctx&&typeof l.ctx.close<"u"&&(l.ctx.close(),l.ctx=null,d()),l},codecs:function(l){return(this||e)._codecs[l.replace(/^x-/,"")]},_setup:function(){var l=this||e;if(l.state=l.ctx&&l.ctx.state||"suspended",l._autoSuspend(),!l.usingWebAudio)if(typeof Audio<"u")try{var f=new Audio;typeof f.oncanplaythrough>"u"&&(l._canPlayEvent="canplay")}catch{l.noAudio=!0}else l.noAudio=!0;try{var f=new Audio;f.muted&&(l.noAudio=!0)}catch{}return l.noAudio||l._setupCodecs(),l},_setupCodecs:function(){var l=this||e,f=null;try{f=typeof Audio<"u"?new Audio:null}catch{return l}if(!f||typeof f.canPlayType!="function")return l;var p=f.canPlayType("audio/mpeg;").replace(/^no$/,""),m=l._navigator?l._navigator.userAgent:"",v=m.match(/OPR\/(\d+)/g),w=v&&parseInt(v[0].split("/")[1],10)<33,x=m.indexOf("Safari")!==-1&&m.indexOf("Chrome")===-1,R=m.match(/Version\/(.*?) /),L=x&&R&&parseInt(R[1],10)<15;return l._codecs={mp3:!!(!w&&(p||f.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!p,opus:!!f.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(f.canPlayType('audio/wav; codecs="1"')||f.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!f.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!f.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(f.canPlayType("audio/x-m4a;")||f.canPlayType("audio/m4a;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(f.canPlayType("audio/x-m4b;")||f.canPlayType("audio/m4b;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(f.canPlayType("audio/x-mp4;")||f.canPlayType("audio/mp4;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!L&&f.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!L&&f.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!f.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(f.canPlayType("audio/x-flac;")||f.canPlayType("audio/flac;")).replace(/^no$/,"")},l},_unlockAudio:function(){var l=this||e;if(!(l._audioUnlocked||!l.ctx)){l._audioUnlocked=!1,l.autoUnlock=!1,!l._mobileUnloaded&&l.ctx.sampleRate!==44100&&(l._mobileUnloaded=!0,l.unload()),l._scratchBuffer=l.ctx.createBuffer(1,1,22050);var f=function(p){for(;l._html5AudioPool.length<l.html5PoolSize;)try{var m=new Audio;m._unlocked=!0,l._releaseHtml5Audio(m)}catch{l.noAudio=!0;break}for(var v=0;v<l._howls.length;v++)if(!l._howls[v]._webAudio)for(var w=l._howls[v]._getSoundIds(),x=0;x<w.length;x++){var R=l._howls[v]._soundById(w[x]);R&&R._node&&!R._node._unlocked&&(R._node._unlocked=!0,R._node.load())}l._autoResume();var L=l.ctx.createBufferSource();L.buffer=l._scratchBuffer,L.connect(l.ctx.destination),typeof L.start>"u"?L.noteOn(0):L.start(0),typeof l.ctx.resume=="function"&&l.ctx.resume(),L.onended=function(){L.disconnect(0),l._audioUnlocked=!0,document.removeEventListener("touchstart",f,!0),document.removeEventListener("touchend",f,!0),document.removeEventListener("click",f,!0),document.removeEventListener("keydown",f,!0);for(var j=0;j<l._howls.length;j++)l._howls[j]._emit("unlock")}};return document.addEventListener("touchstart",f,!0),document.addEventListener("touchend",f,!0),document.addEventListener("click",f,!0),document.addEventListener("keydown",f,!0),l}},_obtainHtml5Audio:function(){var l=this||e;if(l._html5AudioPool.length)return l._html5AudioPool.pop();var f=new Audio().play();return f&&typeof Promise<"u"&&(f instanceof Promise||typeof f.then=="function")&&f.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(l){var f=this||e;return l._unlocked&&f._html5AudioPool.push(l),f},_autoSuspend:function(){var l=this;if(!(!l.autoSuspend||!l.ctx||typeof l.ctx.suspend>"u"||!e.usingWebAudio)){for(var f=0;f<l._howls.length;f++)if(l._howls[f]._webAudio){for(var p=0;p<l._howls[f]._sounds.length;p++)if(!l._howls[f]._sounds[p]._paused)return l}return l._suspendTimer&&clearTimeout(l._suspendTimer),l._suspendTimer=setTimeout(function(){if(l.autoSuspend){l._suspendTimer=null,l.state="suspending";var m=function(){l.state="suspended",l._resumeAfterSuspend&&(delete l._resumeAfterSuspend,l._autoResume())};l.ctx.suspend().then(m,m)}},3e4),l}},_autoResume:function(){var l=this;if(!(!l.ctx||typeof l.ctx.resume>"u"||!e.usingWebAudio))return l.state==="running"&&l.ctx.state!=="interrupted"&&l._suspendTimer?(clearTimeout(l._suspendTimer),l._suspendTimer=null):l.state==="suspended"||l.state==="running"&&l.ctx.state==="interrupted"?(l.ctx.resume().then(function(){l.state="running";for(var f=0;f<l._howls.length;f++)l._howls[f]._emit("resume")}),l._suspendTimer&&(clearTimeout(l._suspendTimer),l._suspendTimer=null)):l.state==="suspending"&&(l._resumeAfterSuspend=!0),l}};var e=new t,i=function(l){var f=this;if(!l.src||l.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}f.init(l)};i.prototype={init:function(l){var f=this;return e.ctx||d(),f._autoplay=l.autoplay||!1,f._format=typeof l.format!="string"?l.format:[l.format],f._html5=l.html5||!1,f._muted=l.mute||!1,f._loop=l.loop||!1,f._pool=l.pool||5,f._preload=typeof l.preload=="boolean"||l.preload==="metadata"?l.preload:!0,f._rate=l.rate||1,f._sprite=l.sprite||{},f._src=typeof l.src!="string"?l.src:[l.src],f._volume=l.volume!==void 0?l.volume:1,f._xhr={method:l.xhr&&l.xhr.method?l.xhr.method:"GET",headers:l.xhr&&l.xhr.headers?l.xhr.headers:null,withCredentials:l.xhr&&l.xhr.withCredentials?l.xhr.withCredentials:!1},f._duration=0,f._state="unloaded",f._sounds=[],f._endTimers={},f._queue=[],f._playLock=!1,f._onend=l.onend?[{fn:l.onend}]:[],f._onfade=l.onfade?[{fn:l.onfade}]:[],f._onload=l.onload?[{fn:l.onload}]:[],f._onloaderror=l.onloaderror?[{fn:l.onloaderror}]:[],f._onplayerror=l.onplayerror?[{fn:l.onplayerror}]:[],f._onpause=l.onpause?[{fn:l.onpause}]:[],f._onplay=l.onplay?[{fn:l.onplay}]:[],f._onstop=l.onstop?[{fn:l.onstop}]:[],f._onmute=l.onmute?[{fn:l.onmute}]:[],f._onvolume=l.onvolume?[{fn:l.onvolume}]:[],f._onrate=l.onrate?[{fn:l.onrate}]:[],f._onseek=l.onseek?[{fn:l.onseek}]:[],f._onunlock=l.onunlock?[{fn:l.onunlock}]:[],f._onresume=[],f._webAudio=e.usingWebAudio&&!f._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(f),f._autoplay&&f._queue.push({event:"play",action:function(){f.play()}}),f._preload&&f._preload!=="none"&&f.load(),f},load:function(){var l=this,f=null;if(e.noAudio){l._emit("loaderror",null,"No audio support.");return}typeof l._src=="string"&&(l._src=[l._src]);for(var p=0;p<l._src.length;p++){var m,v;if(l._format&&l._format[p])m=l._format[p];else{if(v=l._src[p],typeof v!="string"){l._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}m=/^data:audio\/([^;,]+);/i.exec(v),m||(m=/\.([^.]+)$/.exec(v.split("?",1)[0])),m&&(m=m[1].toLowerCase())}if(m||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),m&&e.codecs(m)){f=l._src[p];break}}if(!f){l._emit("loaderror",null,"No codec support for selected audio sources.");return}return l._src=f,l._state="loading",window.location.protocol==="https:"&&f.slice(0,5)==="http:"&&(l._html5=!0,l._webAudio=!1),new n(l),l._webAudio&&o(l),l},play:function(l,f){var p=this,m=null;if(typeof l=="number")m=l,l=null;else{if(typeof l=="string"&&p._state==="loaded"&&!p._sprite[l])return null;if(typeof l>"u"&&(l="__default",!p._playLock)){for(var v=0,w=0;w<p._sounds.length;w++)p._sounds[w]._paused&&!p._sounds[w]._ended&&(v++,m=p._sounds[w]._id);v===1?l=null:m=null}}var x=m?p._soundById(m):p._inactiveSound();if(!x)return null;if(m&&!l&&(l=x._sprite||"__default"),p._state!=="loaded"){x._sprite=l,x._ended=!1;var R=x._id;return p._queue.push({event:"play",action:function(){p.play(R)}}),R}if(m&&!x._paused)return f||p._loadQueue("play"),x._id;p._webAudio&&e._autoResume();var L=Math.max(0,x._seek>0?x._seek:p._sprite[l][0]/1e3),j=Math.max(0,(p._sprite[l][0]+p._sprite[l][1])/1e3-L),G=j*1e3/Math.abs(x._rate),J=p._sprite[l][0]/1e3,M=(p._sprite[l][0]+p._sprite[l][1])/1e3;x._sprite=l,x._ended=!1;var A=function(){x._paused=!1,x._seek=L,x._start=J,x._stop=M,x._loop=!!(x._loop||p._sprite[l][2])};if(L>=M){p._ended(x);return}var C=x._node;if(p._webAudio){var k=function(){p._playLock=!1,A(),p._refreshBuffer(x);var z=x._muted||p._muted?0:x._volume;C.gain.setValueAtTime(z,e.ctx.currentTime),x._playStart=e.ctx.currentTime,typeof C.bufferSource.start>"u"?x._loop?C.bufferSource.noteGrainOn(0,L,86400):C.bufferSource.noteGrainOn(0,L,j):x._loop?C.bufferSource.start(0,L,86400):C.bufferSource.start(0,L,j),G!==1/0&&(p._endTimers[x._id]=setTimeout(p._ended.bind(p,x),G)),f||setTimeout(function(){p._emit("play",x._id),p._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?k():(p._playLock=!0,p.once("resume",k),p._clearTimer(x._id))}else{var F=function(){C.currentTime=L,C.muted=x._muted||p._muted||e._muted||C.muted,C.volume=x._volume*e.volume(),C.playbackRate=x._rate;try{var z=C.play();if(z&&typeof Promise<"u"&&(z instanceof Promise||typeof z.then=="function")?(p._playLock=!0,A(),z.then(function(){p._playLock=!1,C._unlocked=!0,f?p._loadQueue():p._emit("play",x._id)}).catch(function(){p._playLock=!1,p._emit("playerror",x._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),x._ended=!0,x._paused=!0})):f||(p._playLock=!1,A(),p._emit("play",x._id)),C.playbackRate=x._rate,C.paused){p._emit("playerror",x._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}l!=="__default"||x._loop?p._endTimers[x._id]=setTimeout(p._ended.bind(p,x),G):(p._endTimers[x._id]=function(){p._ended(x),C.removeEventListener("ended",p._endTimers[x._id],!1)},C.addEventListener("ended",p._endTimers[x._id],!1))}catch(xe){p._emit("playerror",x._id,xe)}};C.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(C.src=p._src,C.load());var O=window&&window.ejecta||!C.readyState&&e._navigator.isCocoonJS;if(C.readyState>=3||O)F();else{p._playLock=!0,p._state="loading";var D=function(){p._state="loaded",F(),C.removeEventListener(e._canPlayEvent,D,!1)};C.addEventListener(e._canPlayEvent,D,!1),p._clearTimer(x._id)}}return x._id},pause:function(l){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"pause",action:function(){f.pause(l)}}),f;for(var p=f._getSoundIds(l),m=0;m<p.length;m++){f._clearTimer(p[m]);var v=f._soundById(p[m]);if(v&&!v._paused&&(v._seek=f.seek(p[m]),v._rateSeek=0,v._paused=!0,f._stopFade(p[m]),v._node))if(f._webAudio){if(!v._node.bufferSource)continue;typeof v._node.bufferSource.stop>"u"?v._node.bufferSource.noteOff(0):v._node.bufferSource.stop(0),f._cleanBuffer(v._node)}else(!isNaN(v._node.duration)||v._node.duration===1/0)&&v._node.pause();arguments[1]||f._emit("pause",v?v._id:null)}return f},stop:function(l,f){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"stop",action:function(){p.stop(l)}}),p;for(var m=p._getSoundIds(l),v=0;v<m.length;v++){p._clearTimer(m[v]);var w=p._soundById(m[v]);w&&(w._seek=w._start||0,w._rateSeek=0,w._paused=!0,w._ended=!0,p._stopFade(m[v]),w._node&&(p._webAudio?w._node.bufferSource&&(typeof w._node.bufferSource.stop>"u"?w._node.bufferSource.noteOff(0):w._node.bufferSource.stop(0),p._cleanBuffer(w._node)):(!isNaN(w._node.duration)||w._node.duration===1/0)&&(w._node.currentTime=w._start||0,w._node.pause(),w._node.duration===1/0&&p._clearSound(w._node))),f||p._emit("stop",w._id))}return p},mute:function(l,f){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"mute",action:function(){p.mute(l,f)}}),p;if(typeof f>"u")if(typeof l=="boolean")p._muted=l;else return p._muted;for(var m=p._getSoundIds(f),v=0;v<m.length;v++){var w=p._soundById(m[v]);w&&(w._muted=l,w._interval&&p._stopFade(w._id),p._webAudio&&w._node?w._node.gain.setValueAtTime(l?0:w._volume,e.ctx.currentTime):w._node&&(w._node.muted=e._muted?!0:l),p._emit("mute",w._id))}return p},volume:function(){var l=this,f=arguments,p,m;if(f.length===0)return l._volume;if(f.length===1||f.length===2&&typeof f[1]>"u"){var v=l._getSoundIds(),w=v.indexOf(f[0]);w>=0?m=parseInt(f[0],10):p=parseFloat(f[0])}else f.length>=2&&(p=parseFloat(f[0]),m=parseInt(f[1],10));var x;if(typeof p<"u"&&p>=0&&p<=1){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"volume",action:function(){l.volume.apply(l,f)}}),l;typeof m>"u"&&(l._volume=p),m=l._getSoundIds(m);for(var R=0;R<m.length;R++)x=l._soundById(m[R]),x&&(x._volume=p,f[2]||l._stopFade(m[R]),l._webAudio&&x._node&&!x._muted?x._node.gain.setValueAtTime(p,e.ctx.currentTime):x._node&&!x._muted&&(x._node.volume=p*e.volume()),l._emit("volume",x._id))}else return x=m?l._soundById(m):l._sounds[0],x?x._volume:0;return l},fade:function(l,f,p,m){var v=this;if(v._state!=="loaded"||v._playLock)return v._queue.push({event:"fade",action:function(){v.fade(l,f,p,m)}}),v;l=Math.min(Math.max(0,parseFloat(l)),1),f=Math.min(Math.max(0,parseFloat(f)),1),p=parseFloat(p),v.volume(l,m);for(var w=v._getSoundIds(m),x=0;x<w.length;x++){var R=v._soundById(w[x]);if(R){if(m||v._stopFade(w[x]),v._webAudio&&!R._muted){var L=e.ctx.currentTime,j=L+p/1e3;R._volume=l,R._node.gain.setValueAtTime(l,L),R._node.gain.linearRampToValueAtTime(f,j)}v._startFadeInterval(R,l,f,p,w[x],typeof m>"u")}}return v},_startFadeInterval:function(l,f,p,m,v,w){var x=this,R=f,L=p-f,j=Math.abs(L/.01),G=Math.max(4,j>0?m/j:m),J=Date.now();l._fadeTo=p,l._interval=setInterval(function(){var M=(Date.now()-J)/m;J=Date.now(),R+=L*M,R=Math.round(R*100)/100,L<0?R=Math.max(p,R):R=Math.min(p,R),x._webAudio?l._volume=R:x.volume(R,l._id,!0),w&&(x._volume=R),(p<f&&R<=p||p>f&&R>=p)&&(clearInterval(l._interval),l._interval=null,l._fadeTo=null,x.volume(p,l._id),x._emit("fade",l._id))},G)},_stopFade:function(l){var f=this,p=f._soundById(l);return p&&p._interval&&(f._webAudio&&p._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(p._interval),p._interval=null,f.volume(p._fadeTo,l),p._fadeTo=null,f._emit("fade",l)),f},loop:function(){var l=this,f=arguments,p,m,v;if(f.length===0)return l._loop;if(f.length===1)if(typeof f[0]=="boolean")p=f[0],l._loop=p;else return v=l._soundById(parseInt(f[0],10)),v?v._loop:!1;else f.length===2&&(p=f[0],m=parseInt(f[1],10));for(var w=l._getSoundIds(m),x=0;x<w.length;x++)v=l._soundById(w[x]),v&&(v._loop=p,l._webAudio&&v._node&&v._node.bufferSource&&(v._node.bufferSource.loop=p,p&&(v._node.bufferSource.loopStart=v._start||0,v._node.bufferSource.loopEnd=v._stop,l.playing(w[x])&&(l.pause(w[x],!0),l.play(w[x],!0)))));return l},rate:function(){var l=this,f=arguments,p,m;if(f.length===0)m=l._sounds[0]._id;else if(f.length===1){var v=l._getSoundIds(),w=v.indexOf(f[0]);w>=0?m=parseInt(f[0],10):p=parseFloat(f[0])}else f.length===2&&(p=parseFloat(f[0]),m=parseInt(f[1],10));var x;if(typeof p=="number"){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"rate",action:function(){l.rate.apply(l,f)}}),l;typeof m>"u"&&(l._rate=p),m=l._getSoundIds(m);for(var R=0;R<m.length;R++)if(x=l._soundById(m[R]),x){l.playing(m[R])&&(x._rateSeek=l.seek(m[R]),x._playStart=l._webAudio?e.ctx.currentTime:x._playStart),x._rate=p,l._webAudio&&x._node&&x._node.bufferSource?x._node.bufferSource.playbackRate.setValueAtTime(p,e.ctx.currentTime):x._node&&(x._node.playbackRate=p);var L=l.seek(m[R]),j=(l._sprite[x._sprite][0]+l._sprite[x._sprite][1])/1e3-L,G=j*1e3/Math.abs(x._rate);(l._endTimers[m[R]]||!x._paused)&&(l._clearTimer(m[R]),l._endTimers[m[R]]=setTimeout(l._ended.bind(l,x),G)),l._emit("rate",x._id)}}else return x=l._soundById(m),x?x._rate:l._rate;return l},seek:function(){var l=this,f=arguments,p,m;if(f.length===0)l._sounds.length&&(m=l._sounds[0]._id);else if(f.length===1){var v=l._getSoundIds(),w=v.indexOf(f[0]);w>=0?m=parseInt(f[0],10):l._sounds.length&&(m=l._sounds[0]._id,p=parseFloat(f[0]))}else f.length===2&&(p=parseFloat(f[0]),m=parseInt(f[1],10));if(typeof m>"u")return 0;if(typeof p=="number"&&(l._state!=="loaded"||l._playLock))return l._queue.push({event:"seek",action:function(){l.seek.apply(l,f)}}),l;var x=l._soundById(m);if(x)if(typeof p=="number"&&p>=0){var R=l.playing(m);R&&l.pause(m,!0),x._seek=p,x._ended=!1,l._clearTimer(m),!l._webAudio&&x._node&&!isNaN(x._node.duration)&&(x._node.currentTime=p);var L=function(){R&&l.play(m,!0),l._emit("seek",m)};if(R&&!l._webAudio){var j=function(){l._playLock?setTimeout(j,0):L()};setTimeout(j,0)}else L()}else if(l._webAudio){var G=l.playing(m)?e.ctx.currentTime-x._playStart:0,J=x._rateSeek?x._rateSeek-x._seek:0;return x._seek+(J+G*Math.abs(x._rate))}else return x._node.currentTime;return l},playing:function(l){var f=this;if(typeof l=="number"){var p=f._soundById(l);return p?!p._paused:!1}for(var m=0;m<f._sounds.length;m++)if(!f._sounds[m]._paused)return!0;return!1},duration:function(l){var f=this,p=f._duration,m=f._soundById(l);return m&&(p=f._sprite[m._sprite][1]/1e3),p},state:function(){return this._state},unload:function(){for(var l=this,f=l._sounds,p=0;p<f.length;p++)f[p]._paused||l.stop(f[p]._id),l._webAudio||(l._clearSound(f[p]._node),f[p]._node.removeEventListener("error",f[p]._errorFn,!1),f[p]._node.removeEventListener(e._canPlayEvent,f[p]._loadFn,!1),f[p]._node.removeEventListener("ended",f[p]._endFn,!1),e._releaseHtml5Audio(f[p]._node)),delete f[p]._node,l._clearTimer(f[p]._id);var m=e._howls.indexOf(l);m>=0&&e._howls.splice(m,1);var v=!0;for(p=0;p<e._howls.length;p++)if(e._howls[p]._src===l._src||l._src.indexOf(e._howls[p]._src)>=0){v=!1;break}return r&&v&&delete r[l._src],e.noAudio=!1,l._state="unloaded",l._sounds=[],l=null,null},on:function(l,f,p,m){var v=this,w=v["_on"+l];return typeof f=="function"&&w.push(m?{id:p,fn:f,once:m}:{id:p,fn:f}),v},off:function(l,f,p){var m=this,v=m["_on"+l],w=0;if(typeof f=="number"&&(p=f,f=null),f||p)for(w=0;w<v.length;w++){var x=p===v[w].id;if(f===v[w].fn&&x||!f&&x){v.splice(w,1);break}}else if(l)m["_on"+l]=[];else{var R=Object.keys(m);for(w=0;w<R.length;w++)R[w].indexOf("_on")===0&&Array.isArray(m[R[w]])&&(m[R[w]]=[])}return m},once:function(l,f,p){var m=this;return m.on(l,f,p,1),m},_emit:function(l,f,p){for(var m=this,v=m["_on"+l],w=v.length-1;w>=0;w--)(!v[w].id||v[w].id===f||l==="load")&&(setTimeout((function(x){x.call(this,f,p)}).bind(m,v[w].fn),0),v[w].once&&m.off(l,v[w].fn,v[w].id));return m._loadQueue(l),m},_loadQueue:function(l){var f=this;if(f._queue.length>0){var p=f._queue[0];p.event===l&&(f._queue.shift(),f._loadQueue()),l||p.action()}return f},_ended:function(l){var f=this,p=l._sprite;if(!f._webAudio&&l._node&&!l._node.paused&&!l._node.ended&&l._node.currentTime<l._stop)return setTimeout(f._ended.bind(f,l),100),f;var m=!!(l._loop||f._sprite[p][2]);if(f._emit("end",l._id),!f._webAudio&&m&&f.stop(l._id,!0).play(l._id),f._webAudio&&m){f._emit("play",l._id),l._seek=l._start||0,l._rateSeek=0,l._playStart=e.ctx.currentTime;var v=(l._stop-l._start)*1e3/Math.abs(l._rate);f._endTimers[l._id]=setTimeout(f._ended.bind(f,l),v)}return f._webAudio&&!m&&(l._paused=!0,l._ended=!0,l._seek=l._start||0,l._rateSeek=0,f._clearTimer(l._id),f._cleanBuffer(l._node),e._autoSuspend()),!f._webAudio&&!m&&f.stop(l._id,!0),f},_clearTimer:function(l){var f=this;if(f._endTimers[l]){if(typeof f._endTimers[l]!="function")clearTimeout(f._endTimers[l]);else{var p=f._soundById(l);p&&p._node&&p._node.removeEventListener("ended",f._endTimers[l],!1)}delete f._endTimers[l]}return f},_soundById:function(l){for(var f=this,p=0;p<f._sounds.length;p++)if(l===f._sounds[p]._id)return f._sounds[p];return null},_inactiveSound:function(){var l=this;l._drain();for(var f=0;f<l._sounds.length;f++)if(l._sounds[f]._ended)return l._sounds[f].reset();return new n(l)},_drain:function(){var l=this,f=l._pool,p=0,m=0;if(!(l._sounds.length<f)){for(m=0;m<l._sounds.length;m++)l._sounds[m]._ended&&p++;for(m=l._sounds.length-1;m>=0;m--){if(p<=f)return;l._sounds[m]._ended&&(l._webAudio&&l._sounds[m]._node&&l._sounds[m]._node.disconnect(0),l._sounds.splice(m,1),p--)}}},_getSoundIds:function(l){var f=this;if(typeof l>"u"){for(var p=[],m=0;m<f._sounds.length;m++)p.push(f._sounds[m]._id);return p}else return[l]},_refreshBuffer:function(l){var f=this;return l._node.bufferSource=e.ctx.createBufferSource(),l._node.bufferSource.buffer=r[f._src],l._panner?l._node.bufferSource.connect(l._panner):l._node.bufferSource.connect(l._node),l._node.bufferSource.loop=l._loop,l._loop&&(l._node.bufferSource.loopStart=l._start||0,l._node.bufferSource.loopEnd=l._stop||0),l._node.bufferSource.playbackRate.setValueAtTime(l._rate,e.ctx.currentTime),f},_cleanBuffer:function(l){var f=this,p=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!l.bufferSource)return f;if(e._scratchBuffer&&l.bufferSource&&(l.bufferSource.onended=null,l.bufferSource.disconnect(0),p))try{l.bufferSource.buffer=e._scratchBuffer}catch{}return l.bufferSource=null,f},_clearSound:function(l){var f=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);f||(l.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var n=function(l){this._parent=l,this.init()};n.prototype={init:function(){var l=this,f=l._parent;return l._muted=f._muted,l._loop=f._loop,l._volume=f._volume,l._rate=f._rate,l._seek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,f._sounds.push(l),l.create(),l},create:function(){var l=this,f=l._parent,p=e._muted||l._muted||l._parent._muted?0:l._volume;return f._webAudio?(l._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),l._node.gain.setValueAtTime(p,e.ctx.currentTime),l._node.paused=!0,l._node.connect(e.masterGain)):e.noAudio||(l._node=e._obtainHtml5Audio(),l._errorFn=l._errorListener.bind(l),l._node.addEventListener("error",l._errorFn,!1),l._loadFn=l._loadListener.bind(l),l._node.addEventListener(e._canPlayEvent,l._loadFn,!1),l._endFn=l._endListener.bind(l),l._node.addEventListener("ended",l._endFn,!1),l._node.src=f._src,l._node.preload=f._preload===!0?"auto":f._preload,l._node.volume=p*e.volume(),l._node.load()),l},reset:function(){var l=this,f=l._parent;return l._muted=f._muted,l._loop=f._loop,l._volume=f._volume,l._rate=f._rate,l._seek=0,l._rateSeek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,l},_errorListener:function(){var l=this;l._parent._emit("loaderror",l._id,l._node.error?l._node.error.code:0),l._node.removeEventListener("error",l._errorFn,!1)},_loadListener:function(){var l=this,f=l._parent;f._duration=Math.ceil(l._node.duration*10)/10,Object.keys(f._sprite).length===0&&(f._sprite={__default:[0,f._duration*1e3]}),f._state!=="loaded"&&(f._state="loaded",f._emit("load"),f._loadQueue()),l._node.removeEventListener(e._canPlayEvent,l._loadFn,!1)},_endListener:function(){var l=this,f=l._parent;f._duration===1/0&&(f._duration=Math.ceil(l._node.duration*10)/10,f._sprite.__default[1]===1/0&&(f._sprite.__default[1]=f._duration*1e3),f._ended(l)),l._node.removeEventListener("ended",l._endFn,!1)}};var r={},o=function(l){var f=l._src;if(r[f]){l._duration=r[f].duration,h(l);return}if(/^data:[^;]+;base64,/.test(f)){for(var p=atob(f.split(",")[1]),m=new Uint8Array(p.length),v=0;v<p.length;++v)m[v]=p.charCodeAt(v);c(m.buffer,l)}else{var w=new XMLHttpRequest;w.open(l._xhr.method,f,!0),w.withCredentials=l._xhr.withCredentials,w.responseType="arraybuffer",l._xhr.headers&&Object.keys(l._xhr.headers).forEach(function(x){w.setRequestHeader(x,l._xhr.headers[x])}),w.onload=function(){var x=(w.status+"")[0];if(x!=="0"&&x!=="2"&&x!=="3"){l._emit("loaderror",null,"Failed loading audio file with status: "+w.status+".");return}c(w.response,l)},w.onerror=function(){l._webAudio&&(l._html5=!0,l._webAudio=!1,l._sounds=[],delete r[f],l.load())},a(w)}},a=function(l){try{l.send()}catch{l.onerror()}},c=function(l,f){var p=function(){f._emit("loaderror",null,"Decoding audio data failed.")},m=function(v){v&&f._sounds.length>0?(r[f._src]=v,h(f,v)):p()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(l).then(m).catch(p):e.ctx.decodeAudioData(l,m,p)},h=function(l,f){f&&!l._duration&&(l._duration=f.duration),Object.keys(l._sprite).length===0&&(l._sprite={__default:[0,l._duration*1e3]}),l._state!=="loaded"&&(l._state="loaded",l._emit("load"),l._loadQueue())},d=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var l=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),f=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),p=f?parseInt(f[1],10):null;if(l&&p&&p<9){var m=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!m&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};s.Howler=e,s.Howl=i,typeof zi<"u"?(zi.HowlerGlobal=t,zi.Howler=e,zi.Howl=i,zi.Sound=n):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=i,window.Sound=n)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var n=i._howls.length-1;n>=0;n--)i._howls[n].stereo(e);return i},HowlerGlobal.prototype.pos=function(e,i,n){var r=this;if(!r.ctx||!r.ctx.listener)return r;if(i=typeof i!="number"?r._pos[1]:i,n=typeof n!="number"?r._pos[2]:n,typeof e=="number")r._pos=[e,i,n],typeof r.ctx.listener.positionX<"u"?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]);else return r._pos;return r},HowlerGlobal.prototype.orientation=function(e,i,n,r,o,a){var c=this;if(!c.ctx||!c.ctx.listener)return c;var h=c._orientation;if(i=typeof i!="number"?h[1]:i,n=typeof n!="number"?h[2]:n,r=typeof r!="number"?h[3]:r,o=typeof o!="number"?h[4]:o,a=typeof a!="number"?h[5]:a,typeof e=="number")c._orientation=[e,i,n,r,o,a],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(e,i,n,r,o,a);else return h;return c},Howl.prototype.init=function(e){return function(i){var n=this;return n._orientation=i.orientation||[1,0,0],n._stereo=i.stereo||null,n._pos=i.pos||null,n._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},n._onstereo=i.onstereo?[{fn:i.onstereo}]:[],n._onpos=i.onpos?[{fn:i.onpos}]:[],n._onorientation=i.onorientation?[{fn:i.onorientation}]:[],e.call(this,i)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,i){var n=this;if(!n._webAudio)return n;if(n._state!=="loaded")return n._queue.push({event:"stereo",action:function(){n.stereo(e,i)}}),n;var r=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof e=="number")n._stereo=e,n._pos=[e,0,0];else return n._stereo;for(var o=n._getSoundIds(i),a=0;a<o.length;a++){var c=n._soundById(o[a]);if(c)if(typeof e=="number")c._stereo=e,c._pos=[e,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&t(c,r),r==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(e,0,0):c._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),n._emit("stereo",c._id);else return c._stereo}return n},Howl.prototype.pos=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(e,i,n,r)}}),o;if(i=typeof i!="number"?0:i,n=typeof n!="number"?-.5:n,typeof r>"u")if(typeof e=="number")o._pos=[e,i,n];else return o._pos;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._pos=[e,i,n],h._node&&((!h._panner||h._panner.pan)&&t(h,"spatial"),typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setPosition(e,i,n)),o._emit("pos",h._id);else return h._pos}return o},Howl.prototype.orientation=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(e,i,n,r)}}),o;if(i=typeof i!="number"?o._orientation[1]:i,n=typeof n!="number"?o._orientation[2]:n,typeof r>"u")if(typeof e=="number")o._orientation=[e,i,n];else return o._orientation;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._orientation=[e,i,n],h._node&&(h._panner||(h._pos||(h._pos=o._pos||[0,0,-.5]),t(h,"spatial")),typeof h._panner.orientationX<"u"?(h._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setOrientation(e,i,n)),o._emit("orientation",h._id);else return h._orientation}return o},Howl.prototype.pannerAttr=function(){var e=this,i=arguments,n,r,o;if(!e._webAudio)return e;if(i.length===0)return e._pannerAttr;if(i.length===1)if(typeof i[0]=="object")n=i[0],typeof r>"u"&&(n.pannerAttr||(n.pannerAttr={coneInnerAngle:n.coneInnerAngle,coneOuterAngle:n.coneOuterAngle,coneOuterGain:n.coneOuterGain,distanceModel:n.distanceModel,maxDistance:n.maxDistance,refDistance:n.refDistance,rolloffFactor:n.rolloffFactor,panningModel:n.panningModel}),e._pannerAttr={coneInnerAngle:typeof n.pannerAttr.coneInnerAngle<"u"?n.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof n.pannerAttr.coneOuterAngle<"u"?n.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof n.pannerAttr.coneOuterGain<"u"?n.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof n.pannerAttr.distanceModel<"u"?n.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof n.pannerAttr.maxDistance<"u"?n.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof n.pannerAttr.refDistance<"u"?n.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof n.pannerAttr.rolloffFactor<"u"?n.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof n.pannerAttr.panningModel<"u"?n.pannerAttr.panningModel:e._panningModel});else return o=e._soundById(parseInt(i[0],10)),o?o._pannerAttr:e._pannerAttr;else i.length===2&&(n=i[0],r=parseInt(i[1],10));for(var a=e._getSoundIds(r),c=0;c<a.length;c++)if(o=e._soundById(a[c]),o){var h=o._pannerAttr;h={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:h.coneOuterAngle,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:h.coneOuterGain,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:h.distanceModel,maxDistance:typeof n.maxDistance<"u"?n.maxDistance:h.maxDistance,refDistance:typeof n.refDistance<"u"?n.refDistance:h.refDistance,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:h.rolloffFactor,panningModel:typeof n.panningModel<"u"?n.panningModel:h.panningModel};var d=o._panner;d||(o._pos||(o._pos=e._pos||[0,0,-.5]),t(o,"spatial"),d=o._panner),d.coneInnerAngle=h.coneInnerAngle,d.coneOuterAngle=h.coneOuterAngle,d.coneOuterGain=h.coneOuterGain,d.distanceModel=h.distanceModel,d.maxDistance=h.maxDistance,d.refDistance=h.refDistance,d.rolloffFactor=h.rolloffFactor,d.panningModel=h.panningModel}return e},Sound.prototype.init=function(e){return function(){var i=this,n=i._parent;i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,e.call(this),i._stereo?n.stereo(i._stereo):i._pos&&n.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var i=this,n=i._parent;return i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,i._stereo?n.stereo(i._stereo):i._pos?n.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,n._refreshBuffer(i)),e.call(this)}}(Sound.prototype.reset);var t=function(e,i){i=i||"spatial",i==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(Vt);class Qu{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,Vt.Howler.autoUnlock=!0,Vt.Howler.html5PoolSize=10,Vt.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(Vt.Howler.ctx&&Vt.Howler.ctx.state==="suspended")try{await Vt.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(t){console.error("Failed to resume AudioContext:",t)}}async preloadHotspots(t){const e=t.filter(i=>i.audioUrl).map(i=>({id:i.id,url:i.audioUrl}));this.preloadQueue.push(...e),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:t,url:e}=this.preloadQueue.shift();this.sounds.has(t)||(await this.loadSound(t,e),this.preloadedCount++)}this.isPreloading=!1}async loadSound(t,e){return new Promise(i=>{const n=new Audio;n.addEventListener("error",()=>{console.log(`Audio not found for ${t}, using placeholder`),this.createSound(t,this.placeholderUrl,!0),i()}),n.addEventListener("canplaythrough",()=>{this.createSound(t,e,!1),i()}),n.src=e})}createSound(t,e,i=!1){const n=new Vt.Howl({src:[e],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${t} (placeholder: ${i})`)},onend:()=>this.handlePlaybackEnd(t),onloaderror:(r,o)=>{console.error(`Failed to load sound ${t}:`,o),this.onError&&this.onError(t,o)},onplayerror:(r,o)=>{console.error(`Failed to play sound ${t}:`,o),this.onError&&this.onError(t,o)}});this.sounds.set(t,{howl:n,isPlaceholder:i,duration:i?this.placeholderDuration:null})}async play(t){if(await this.resumeContext(),this.currentHotspotId===t&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(t)||(this.state="loading",await this.loadSound(t,`/audio/hotspot_${t}.mp3`));const e=this.sounds.get(t);if(!e){console.error(`No sound found for hotspot: ${t}`);return}const i=e.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,i,t):(this.currentSound&&this.currentSound.stop(),this.currentSound=i,this.currentHotspotId=t,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(t),this.startProgressTracking())}crossfade(t,e,i){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${i}`),this.isCrossfading=!0,this.state="crossfading";const n=this.crossfadeDuration,r=20,o=n/r;let a=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,i),e.volume(0),e.play();const c=setInterval(()=>{a++;const h=a/r;t.volume(this.masterVolume*(1-h)),e.volume(this.masterVolume*h),a>=r&&(clearInterval(c),t.stop(),t.volume(this.masterVolume),this.previousSound=t,this.currentSound=e,this.currentHotspotId=i,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(i),this.startProgressTracking())},o)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(t){if(this.currentSound&&this.currentSound.playing()){const e=this.currentSound.seek()||0,i=this.currentSound.duration(),n=Math.max(0,Math.min(i,e+t));this.currentSound.seek(n),console.log(`Skipped to ${n.toFixed(1)}s`)}}setVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),Vt.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,Vt.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const t=this.currentSound.seek()||0,e=this.sounds.get(this.currentHotspotId),i=e!=null&&e.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,n=i>0?t/i*100:0;return{current:t,duration:i,percent:n}}seekTo(t){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(t)}seekToPercent(t){if(this.currentSound){const e=this.currentSound.duration(),i=t/100*e;this.seekTo(i)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const t=this.getProgress();this.onProgress(t)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(t){console.log(`Playback ended for hotspot: ${t}`),t===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(t))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(t,e=500){this.crossfadeEnabled=t,this.crossfadeDuration=Math.max(100,Math.min(2e3,e)),console.log(`Crossfade ${t?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(t){const e=this.sounds.get(t);e&&(e.howl.unload(),this.sounds.delete(t),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(t=>{t.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}}class Ju{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(t){t.forEach(e=>{e.image_url_1&&this.overlays.set(e.id,{hotspotId:e.id,imageUrls:[e.image_url_1],autoReveal:e.overlay_auto_reveal||!1,displayMode:e.overlay_display_mode||"modal",showButton:e.show_images_button!==!1,access:e.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(t){const e=[];t.forEach(i=>{const n=this.overlays.get(i);n&&!n.isLoaded&&n.imageUrls.forEach(r=>{this.preloadedImages.has(r)||e.push({url:r,hotspotId:i})})}),this.preloadQueue.push(...e),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:t,hotspotId:e}=this.preloadQueue.shift();try{await this.loadImage(t,e)}catch(i){console.error(`Failed to preload image: ${t}`,i)}}this.isPreloading=!1}loadImage(t,e){return new Promise((i,n)=>{const r=new Image;r.onload=()=>{this.preloadedImages.set(t,r);const o=this.overlays.get(e);o&&(o.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(t,e),console.log(`Image loaded: ${t}`),i(r)},r.onerror=o=>{this.onImageError&&this.onImageError(t,e,o),console.error(`Failed to load image: ${t}`),n(o)},r.crossOrigin="anonymous",r.src=t})}shouldAutoReveal(t){const e=this.overlays.get(t);return e?e.autoReveal:!1}shouldShowButton(t){const e=this.overlays.get(t);return e?e.showButton:!0}getOverlay(t){return this.overlays.get(t)}openOverlay(t){const e=this.overlays.get(t);if(!e)return console.warn(`No overlay found for hotspot: ${t}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=t,!e.isLoaded){const i=e.imageUrls[0];this.loadImage(i,t).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(t,e),e}closeOverlay(){if(this.activeOverlay){const t=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(t)}}getImage(t){return this.preloadedImages.get(t)}hasAccess(t,e="free"){const i=this.overlays.get(t);if(!i)return!1;const n={free:0,gated:1,supporter:2},r=n[i.access]||0;return(n[e]||0)>=r}unloadImages(t){t.forEach(e=>{const i=this.overlays.get(e);i&&(i.imageUrls.forEach(n=>{this.preloadedImages.delete(n)}),i.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class $u{constructor(t){Is(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});Is(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const t=performance.memory.usedJSHeapSize/1048576,e=performance.memory.jsHeapSizeLimit/1048576,i=t/e*100;this.metrics.currentUsage=t,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,t);const n=this.state.memoryPressure;if(t>this.config.criticalThreshold||i>80?this.state.memoryPressure="critical":t>this.config.highThreshold||i>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==n)switch(console.log(`Memory pressure changed: ${n}  ${this.state.memoryPressure} (${t.toFixed(0)}MB, ${i.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const t=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==t.tiles&&(this.viewer.maxImageCacheCount=t.tiles,console.log(`Adjusted tile cache limit to ${t.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var e;console.warn("CRITICAL: Emergency memory cleanup");const t=(e=this.viewer.world)==null?void 0:e.getItemAt(0);t&&(t._tileCache&&t._tileCache.clearTilesFor(t),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(t=!1){var r,o;const e=(r=this.viewer.world)==null?void 0:r.getItemAt(0);if(!(e!=null&&e._tileCache))return;const i=e._tileCache,n=((o=i._tilesLoaded)==null?void 0:o.length)||i._imagesLoadedCount||0;if(t||n>this.config.cacheLimits[this.state.memoryPressure].tiles){const a=t?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,c=n-a;c>0&&(console.log(`Removing ${c} tiles from cache (current: ${n})`),i.clearTilesFor(e))}}clearUnusedImages(){const t=document.querySelectorAll("img");let e=0;t.forEach(i=>{!this.isElementVisible(i)&&i.src&&(i.removeAttribute("src"),e++)}),e>0&&console.log(`Cleared ${e} unused images`)}isElementVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const t={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const e=performance.memory.jsHeapSizeLimit/1048576;t.usagePercentage=(this.metrics.currentUsage/e*100).toFixed(1)+"%",t.totalLimit=e.toFixed(0)+"MB"}return t}destroy(){this.stop(),this.viewer=null}}class ed{constructor(t={}){Object.assign(this,{viewer:t.viewer,spatialIndex:t.spatialIndex,onHotspotHover:t.onHotspotHover||(()=>{}),onHotspotClick:t.onHotspotClick||(()=>{}),visibilityCheckInterval:t.visibilityCheckInterval||100,batchSize:t.batchSize||50,renderDebounceTime:t.renderDebounceTime||16,debugMode:t.debugMode||!1}),this.lastViewportBounds=null,this.lastViewportZoom=null,this.significantChangeThreshold=.1,this.overlays=new Map,this.visibleOverlays=new Set,this.hoveredHotspot=null,this.selectedHotspot=null,this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.clickTimeThreshold=300,this.clickDistThreshold=this.isMobile?12:8,this.hotspotAreas=new Map,this.activePointers=new Map,this.primaryPointerId=null,this.lastPointerDownTime=0,this.lastPointerDownPoint=null,this.isPinching=!1,this.isAnimationInProgress=!1,this.pendingVisibilityUpdate=!1,this.initStyles(),this.init()}initStyles(){const t={strokeWidth:.5,hoverStrokeWidth:1,selectedStrokeWidth:1.5},e={audio_only:{fill:[0,203,244],stroke:"#00cbf4"},audio_link:{fill:[73,243,0],stroke:"#49f300"},audio_image:{fill:[255,5,247],stroke:"#ff05f7"},audio_image_link:{fill:[255,93,0],stroke:"#ff5d00"},audio_sound:{fill:[255,176,0],stroke:"#ffb000"}};this.styles={},this.debugMode?Object.entries(e).forEach(([i])=>{this.styles[i]={...t,stroke:"rgba(255, 255, 255, 0)",fill:"rgba(0, 0, 0, 0)",hoverFill:"rgba(0, 0, 0, 0)",hoverStroke:"rgba(255, 255, 255, 0.8)",selectedFill:"rgba(0, 0, 0, 0)",selectedStroke:"rgba(255, 255, 255, 1)"}}):Object.entries(e).forEach(([i])=>{this.styles[i]={...t,stroke:"rgba(255, 255, 255, 0)",fill:"rgba(0, 0, 0, 0)",hoverFill:"rgba(0, 0, 0, 0)",hoverStroke:"rgba(255, 255, 255, 0.8)",selectedFill:"rgba(0, 0, 0, 0)",selectedStroke:"rgba(255, 255, 255, 1)"}})}async init(){if(!this.viewer.world.getItemCount()){this.viewer.addOnceHandler("open",()=>this.init());return}const e=this.viewer.world.getItemAt(0).getContentSize();this.svg=this.createSVG(e),this.viewer.addOverlay({element:this.svg,location:new Ue.Rect(0,0,1,e.y/e.x),placement:Ue.Placement.TOP_LEFT}),await this.loadHotspotsInBatches(),this.setupMouseTracking(),this.setupDragDetection(),this.viewer.addHandler("zoom",()=>{if(this.hoveredHotspot){const i=this.overlays.get(this.hoveredHotspot.id);i&&this.applyStyle(i.element,this.hoveredHotspot.type,"hover")}if(this.selectedHotspot&&this.selectedHotspot!==this.hoveredHotspot){const i=this.overlays.get(this.selectedHotspot.id);i&&this.applyStyle(i.element,this.selectedHotspot.type,"selected")}}),this.startVisibilityTracking(),window.nativeHotspotRenderer=this}createSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
               width="${t.x}" height="${t.y}" 
               viewBox="0 0 ${t.x} ${t.y}"
               style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
        </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}async loadHotspotsInBatches(){const t=this.spatialIndex.getAllHotspots(),e=Math.ceil(t.length/this.batchSize);for(let i=0;i<e;i++)t.slice(i*this.batchSize,(i+1)*this.batchSize).forEach(r=>this.createHotspotOverlay(r)),i<e-1&&await new Promise(r=>setTimeout(r,0));console.log(`Loaded ${t.length} hotspots in ${e} batches`)}createHotspotOverlay(t){const e=this.createGroup(t);(t.shape==="polygon"?[this.createPath(t.coordinates)]:t.coordinates.map(o=>this.createPath(o))).forEach(o=>e.appendChild(o)),this.applyStyle(e,t.type,"normal"),this.svg.appendChild(e);const n=this.calculateBounds(t.coordinates),r=this.calculateArea(n);this.overlays.set(t.id,{element:e,hotspot:t,bounds:n,area:r,isVisible:!1}),this.hotspotAreas.set(t.id,r)}createGroup(t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return Object.assign(e.style,{cursor:"pointer",pointerEvents:"fill",opacity:this.debugMode?"1":"0",transition:"opacity 0.2s ease-out","-webkit-tap-highlight-color":"transparent"}),e.setAttribute("data-hotspot-id",t.id),e}createPath(t){const e=document.createElementNS("http://www.w3.org/2000/svg","path"),i=t.reduce((n,[r,o],a)=>n+(a===0?"M":"L")+`${Math.round(r)},${Math.round(o)}`,"")+"Z";return e.setAttribute("d",i),e.setAttribute("vector-effect","non-scaling-stroke"),e.style.pointerEvents="fill",e}setupDragDetection(){this.viewer.addHandler("canvas-drag",()=>{this.isDragging=!0}),this.viewer.addHandler("canvas-drag-end",()=>{this.isDragging=!1})}setupMouseTracking(){this.svg.style.pointerEvents="auto";const t=this.viewer.container;t.addEventListener("pointerdown",this.handlePointerDown.bind(this)),t.addEventListener("pointermove",this.handlePointerMove.bind(this)),t.addEventListener("pointerup",this.handlePointerUp.bind(this)),t.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.svg.addEventListener("mousemove",e=>{const i=this.viewer.element.getBoundingClientRect(),n=new Ue.Point(e.clientX-i.left,e.clientY-i.top),r=this.viewer.viewport.pointFromPixel(n),o=this.viewer.viewport.viewportToImageCoordinates(r),a=this.findSmallestHotspotAtPoint(o);if(a!==this.hoveredHotspot){if(this.hoveredHotspot){const c=this.overlays.get(this.hoveredHotspot.id);c&&this.applyStyle(c.element,this.hoveredHotspot.type,this.hoveredHotspot===this.selectedHotspot?"selected":"normal")}if(this.hoveredHotspot=a,this.onHotspotHover(a),a){const c=this.overlays.get(a.id);c&&this.applyStyle(c.element,a.type,"hover")}}this.svg.style.cursor=a?"pointer":"default"})}handlePointerDown(t){this.updatesPaused&&(console.warn("Updates were paused during interaction - forcing resume"),this.resumeUpdates()),console.log("handlePointerDown",{pointerId:t.pointerId,activePointersBefore:this.activePointers.size}),this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Date.now()}),this.isMobile&&t.preventDefault(),this.activePointers.size===1&&(this.primaryPointerId=t.pointerId,this.lastPointerDownTime=Date.now(),this.lastPointerDownPoint={x:t.clientX,y:t.clientY})}handlePointerMove(t){if(this.activePointers.has(t.pointerId)){const e=this.activePointers.get(t.pointerId);e.x=t.clientX,e.y=t.clientY,this.activePointers.size>=2&&(this.isPinching=!0)}}handlePointerUp(t){if(console.log("handlePointerUp start",{pointerId:t.pointerId,hasPointer:this.activePointers.has(t.pointerId),activePointers:this.activePointers.size}),!this.activePointers.has(t.pointerId))return;const e=this.activePointers.get(t.pointerId),i=Date.now()-e.startTime,n=Math.sqrt(Math.pow(t.clientX-e.startX,2)+Math.pow(t.clientY-e.startY,2));console.log("handlePointerUp checks",{isPrimary:t.pointerId===this.primaryPointerId,primaryPointerId:this.primaryPointerId,activePointers:this.activePointers.size,isPinching:this.isPinching,isDragging:this.isDragging,duration:i,clickTimeThreshold:this.clickTimeThreshold,distance:n,clickDistThreshold:this.clickDistThreshold}),t.pointerId===this.primaryPointerId&&this.activePointers.size===1&&!this.isPinching&&!this.isDragging&&i<this.clickTimeThreshold&&n<this.clickDistThreshold?(console.log("Conditions passed, calling handleClick"),this.handleClick(t)):console.log("Click conditions NOT met"),this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handlePointerCancel(t){this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handleClick(t){if(console.log("handleClick called",{isDragging:this.isDragging,isPinching:this.isPinching,activePointers:this.activePointers.size,timestamp:Date.now()}),t.target.closest(".openseadragon-controls"))return;if(this.isMobile&&this.hoveredHotspot){console.log("Using cached hover hotspot for mobile click"),t.stopPropagation(),t.preventDefault(),this.activateHotspot(this.hoveredHotspot);return}const e=this.viewer.element.getBoundingClientRect(),i=new Ue.Point(t.clientX-e.left,t.clientY-e.top),n=this.viewer.viewport.pointFromPixel(i),r=this.viewer.viewport.viewportToImageCoordinates(n),o=this.findSmallestHotspotAtPoint(r);o?(t.stopPropagation(),t.preventDefault(),this.activateHotspot(o)):this.selectedHotspot&&(this.deselectHotspot(),this.onHotspotClick&&this.onHotspotClick(null))}activateHotspot(t){console.log("Activating hotspot:",t.id,Date.now()),this.selectedHotspot=t,this.selectionTimestamp=Date.now(),this.onHotspotClick(t),this.overlays.forEach((e,i)=>{var r;const n=i===t.id?"selected":i===((r=this.hoveredHotspot)==null?void 0:r.id)?"hover":"normal";this.applyStyle(e.element,e.hotspot.type,n)})}deselectHotspot(){console.log("Deselecting hotspot"),this.selectedHotspot=null,this.selectionTimestamp=null,this.overlays.forEach((t,e)=>{var n;const i=e===((n=this.hoveredHotspot)==null?void 0:n.id)?"hover":"normal";this.applyStyle(t.element,t.hotspot.type,i)})}instantDeselect(){var t;if(console.log("Instant deselecting hotspot"),this.selectedHotspot){const e=this.overlays.get(this.selectedHotspot.id);if(e&&e.element){const i=e.element.getElementsByTagName("path");for(let n of i)n.style.filter="none",n.style.stroke="rgba(255, 255, 255, 0)",n.style.strokeWidth="0",n.style.opacity="0",n.style.transition="none",n.style.animation="none";e.element.style.opacity="0",e.element.style.transition="none",e.element.style.animation="none",e.element.style.filter="none"}((t=this.hoveredHotspot)==null?void 0:t.id)===this.selectedHotspot.id&&(this.hoveredHotspot=null)}this.selectedHotspot=null,this.selectionTimestamp=null}findSmallestHotspotAtPoint(t){const e=[];return this.overlays.forEach((i,n)=>{i.isVisible&&this.isPointInHotspot(t,i)&&e.push({hotspot:i.hotspot,area:i.area})}),e.length===0?null:(e.sort((i,n)=>i.area-n.area),e[0].hotspot)}isPointInHotspot(t,e){const i=e.hotspot,n=e.bounds;return t.x<n.minX||t.x>n.maxX||t.y<n.minY||t.y>n.maxY?!1:i.shape==="polygon"?this.pointInPolygon(t.x,t.y,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(r=>this.pointInPolygon(t.x,t.y,r)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}applyStyle(t,e,i){const n=this.styles[e]||this.styles.audio_only,r=t.getElementsByTagName("path"),o=this.calculateGlowIntensity();t.setAttribute("class",`hotspot-${e} hotspot-${i}`);for(let a of r)if(this.debugMode)Object.assign(a.style,{fill:n[`${i}Fill`]||n.fill,stroke:n.stroke,strokeWidth:n[`${i}StrokeWidth`]+"px"||n.strokeWidth+"px",filter:i==="hover"?`drop-shadow(0 0 8px ${n.stroke})`:"",opacity:"1"});else{const c=i==="hover",h=i==="selected";let d=0;if((c||h)&&(o>.7?d=1.5:o>.5?d=1:d=.5),Object.assign(a.style,{fill:n[`${i}Fill`]||n.fill,stroke:c||h?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0)",strokeWidth:d+"px",strokeOpacity:o,transition:"all 0.2s ease",filter:"none",opacity:c||h?"1":"0"}),(c||h)&&o>.3){const l=Math.max(1,3*o),f=o*.3;a.style.filter=`drop-shadow(0 0 ${l}px rgba(255, 255, 255, ${f}))`}}this.debugMode?t.style.opacity="1":(t.style.opacity=i==="hover"||i==="selected"?"1":"0",i==="hover"&&o>.5?t.style.animation="hotspotPulse 1.5s ease-in-out infinite":t.style.animation="")}calculateBounds(t){let e={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};const i=n=>{n.forEach(([r,o])=>{e.minX=Math.min(e.minX,r),e.minY=Math.min(e.minY,o),e.maxX=Math.max(e.maxX,r),e.maxY=Math.max(e.maxY,o)})};return Array.isArray(t[0])&&typeof t[0][0]=="number"?i(t):t.forEach(i),e}calculateArea(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}calculateGlowIntensity(){if(!this.viewer||!this.viewer.viewport)return 1;const t=this.viewer.viewport.getZoom(),e=1,i=10;if(t<=e)return 1;if(t>=i)return .3;const n=(t-e)/(i-e);return .3+(1-Math.pow(n,.5))*.7}createSimpleSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
           width="${t.x}" height="${t.y}" 
           viewBox="0 0 ${t.x} ${t.y}"
           style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
    </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}startVisibilityTracking(){let t=null,e=0;this.isMobile;const i=()=>{if(t&&clearTimeout(t),this.isAnimationInProgress||this.viewer.isAnimating()){this.pendingVisibilityUpdate=!0;return}const r=Date.now()-e,o=this.viewer.viewport.getZoom()<5?100:50;if(r<o){t=setTimeout(()=>{i()},o-r);return}t=setTimeout(()=>{e=Date.now(),this.updateVisibility()},this.renderDebounceTime)};this.viewer.addHandler("animation",i),this.viewer.addHandler("animation-finish",()=>{!this.updatesPaused&&!this.isAnimationInProgress&&this.updateVisibility()}),this.isMobile||this.viewer.addHandler("viewport-change",i),this.updateVisibility()}updateVisibility(){var p,m;if(this.updatesPaused||this.isAnimationInProgress){console.log("updateVisibility BLOCKED - animation in progress"),this.pendingVisibilityUpdate=!0;return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.zoomSpring.target.value;if(Math.abs(t-e)>.001){console.log("updateVisibility SKIPPED - viewer is zooming"),this.pendingVisibilityUpdate=!0;return}if(this.viewer.isAnimating()){console.log("updateVisibility SKIPPED - viewer is animating"),this.pendingVisibilityUpdate=!0;return}const n=this.viewer.viewport.getBounds();if(this.lastViewportBounds&&this.lastViewportZoom){const v=Math.abs(n.x-this.lastViewportBounds.x)>this.significantChangeThreshold||Math.abs(n.y-this.lastViewportBounds.y)>this.significantChangeThreshold||Math.abs(n.width-this.lastViewportBounds.width)>this.significantChangeThreshold||Math.abs(n.height-this.lastViewportBounds.height)>this.significantChangeThreshold,w=Math.abs(t-this.lastViewportZoom)>.1;if(!v&&!w)return}this.lastViewportBounds=n,this.lastViewportZoom=t;const r=this.viewer.viewport;if(r.getZoom()<1.5){const v=(p=this.selectedHotspot)==null?void 0:p.id,w=(m=this.hoveredHotspot)==null?void 0:m.id;requestAnimationFrame(()=>{this.overlays.forEach(x=>{const R=x.hotspot.id===v||x.hotspot.id===w;x.element.style.opacity=R?"1":"0",x.isVisible=!0})});return}const a=r.viewportToImageCoordinates(n.getTopLeft()),c=r.viewportToImageCoordinates(n.getBottomRight()),h={minX:a.x,minY:a.y,maxX:c.x,maxY:c.y},d=(h.maxX-h.minX)*.2;h.minX-=d,h.minY-=d,h.maxX+=d,h.maxY+=d;const l=[];let f=0;this.overlays.forEach((v,w)=>{v.bounds.maxX<h.minX||v.bounds.minX>h.maxX||v.bounds.maxY<h.minY||v.bounds.minY>h.maxY?v.isVisible&&(l.push({element:v.element,opacity:"0"}),v.isVisible=!1,this.visibleOverlays.delete(w)):(f++,v.isVisible||(l.push({element:v.element,opacity:"1"}),v.isVisible=!0,this.visibleOverlays.add(w)))}),l.length>0&&requestAnimationFrame(()=>{l.forEach(v=>{v.element.style.opacity=v.opacity})}),Math.abs(t-this.lastViewportZoom)>.5&&requestAnimationFrame(()=>{this.viewer.world.getItemCount()>0&&this.viewer.updateOverlay(this.svg)}),f>100&&console.log(`Performance note: ${f} hotspots visible`)}updateVisibilityLazy(){if(this.updatesPaused){console.log("updateVisibilityLazy SKIPPED - updates are paused");return}console.log("updateVisibilityLazy starting - mobile optimized");const t=this.viewer.viewport;if(t.getZoom(),this.viewer.isAnimating()){console.log("updateVisibilityLazy deferred - still animating"),setTimeout(()=>this.updateVisibilityLazy(),100);return}const e=t.getBounds(),i=t.viewportToImageCoordinates(e.getTopLeft()),n=t.viewportToImageCoordinates(e.getBottomRight()),r={minX:i.x,minY:i.y,maxX:n.x,maxY:n.y},o=(r.maxX-r.minX)*.2;Object.keys(r).forEach(f=>{r[f]+=f.startsWith("min")?-o:o});const a=Array.from(this.overlays.entries());let c=0,h=0;const d=30,l=()=>{const f=performance.now();for(h=0;c<a.length&&h<d&&performance.now()-f<8;){const[p,m]=a[c],v=this.boundsIntersect(m.bounds,r);v!==m.isVisible&&(m.element.style.opacity=v?"1":"0",m.isVisible=v,v?this.visibleOverlays.add(p):this.visibleOverlays.delete(p)),c++,h++}c<a.length?"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:50}):requestAnimationFrame(l):this.viewer.world.getItemCount()>0&&requestAnimationFrame(()=>{this.viewer.updateOverlay(this.svg),console.log("updateVisibilityLazy complete")})};"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:100}):setTimeout(()=>requestAnimationFrame(l),50)}boundsIntersect(t,e){return!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)}zoomToHotspot(t){const e=this.overlays.get(t.id);if(!e)return;const i=e.bounds,n=this.viewer.world.getItemAt(0).getContentSize(),r=new Ue.Rect(i.minX/n.x,i.minY/n.y,(i.maxX-i.minX)/n.x,(i.maxY-i.minY)/n.y),o=e.area,a=n.x*n.y,c=o/a,h=c<.01?1:c<.05?.7:c<.1?.5:.3,d=r.width*h,l=r.height*h,f=new Ue.Rect(r.x-d,r.y-l,r.width+d*2,r.height+l*2);this.viewer.viewport.fitBounds(f,!1)}getOverlapMetrics(){const t=[],e=Array.from(this.overlays.values());for(let i=0;i<e.length;i++)for(let n=i+1;n<e.length;n++)this.boundsIntersect(e[i].bounds,e[n].bounds)&&t.push({hotspot1:e[i].hotspot.id,hotspot2:e[n].hotspot.id,area1:e[i].area,area2:e[n].area});return{totalOverlaps:t.length,overlaps:t}}setDebugMode(t){this.debugMode=t,this.initStyles(),this.overlays.forEach((e,i)=>{var r,o;const n=i===((r=this.selectedHotspot)==null?void 0:r.id)?"selected":i===((o=this.hoveredHotspot)==null?void 0:o.id)?"hover":"normal";this.applyStyle(e.element,e.hotspot.type,n)})}pauseUpdates(){console.log("pauseUpdates called - blocking all visibility updates"),this.updatesPaused=!0,this.isAnimationInProgress=!0,this.selectedHotspot&&this.overlays.forEach((t,e)=>{var i;e!==this.selectedHotspot.id&&e!==((i=this.hoveredHotspot)==null?void 0:i.id)&&(t.element.style.visibility="hidden")})}resumeUpdates(){console.log("resumeUpdates called - unblocking updates"),this.updatesPaused=!1,this.isAnimationInProgress=!1,this.overlays.forEach(t=>{t.element.style.visibility="visible"}),this.pendingVisibilityUpdate&&(this.pendingVisibilityUpdate=!1,this.isMobile?this.updateVisibilityLazy():this.updateVisibility())}hideOverlay(){console.log("Hiding entire SVG overlay"),this.svg&&(this.svg.style.display="none")}showOverlay(){console.log("Showing SVG overlay"),this.svg&&(this.svg.style.display="")}destroy(){this.mouseTracker&&this.mouseTracker.destroy(),this.viewer.removeAllHandlers("animation"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("animation-update"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeHandler("canvas-drag"),this.viewer.removeHandler("canvas-drag-end"),this.viewer.removeHandler("zoom"),this.svg&&(this.svg.removeEventListener("pointerdown",this.handlePointerDown),this.svg.removeEventListener("pointermove",this.handlePointerMove),this.svg.removeEventListener("pointerup",this.handlePointerUp),this.svg.removeEventListener("pointercancel",this.handlePointerCancel),this.viewer.removeOverlay(this.svg)),this.overlays.clear(),this.visibleOverlays.clear(),this.hotspotAreas.clear(),this.viewer=null,window.nativeHotspotRenderer===this&&(window.nativeHotspotRenderer=null)}}class td{constructor(t){this.viewer=t,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[],this.thresholds={fps:{target:60,good:55,acceptable:45,poor:30,critical:20},frameTime:{target:16.67,warning:20},memory:{warning:250,critical:300}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const t={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(t).forEach(([e,i])=>this.viewer.addHandler(e,i.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(t=>this.viewer.removeAllHandlers(t))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const t=performance.now(),e=t-this.lastTime;this.updateFrameMetrics(e),this.lastTime=t,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(t){if(this.frameTimes.push(t),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),t>0){const e=1e3/t;this.fpsHistory.push(e),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=e,t>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const t=this.viewer.drawer.canvas;t&&(this.metrics.canvasSize=`${t.width}${t.height}`);const i=this.viewer.viewport.getBounds(),n=this.viewer.world.getHomeBounds(),r=i.width*i.height/(n.width*n.height);this.metrics.viewportCoverage=Math.min(100,r*100).toFixed(1)}updateTileMetrics(){var i,n;const t=this.viewer.world;if(t.getItemCount()===0)return;const e=t.getItemAt(0);if(e){if(this.metrics.visibleTiles=((i=e._tilesToDraw)==null?void 0:i.length)||0,e._tileCache){const r=e._tileCache;this.metrics.cachedTiles=((n=r._tilesLoaded)==null?void 0:n.length)||r._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:t,frameTime:e,memory:i}=this.thresholds,n={fps:Math.min(100,this.metrics.averageFPS/t.target*100)*.5,frameTime:Math.min(100,e.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(n).reduce((r,o)=>r+o,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const t=Date.now();if(t-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:e}=this.thresholds,i=this.metrics.averageFPS,n=this.metrics.performanceScore,r=this.getPerformanceTrend(),o=[{condition:i<e.critical||n<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:i<e.poor||n<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:i<e.good||n<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:i>e.target&&n>90&&(r==="improving"||r==="stable"),action:this.restoreQualitySettings,log:null}];for(const a of o)if(a.condition){a.log&&console[a.log==="CRITICAL"?"error":"warn"](`${a.log} performance: Score ${n}, FPS: ${i}`),a.action.call(this),this.lastOptimization=t;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const t=this.performanceHistory.slice(-10),e=this.performanceHistory.slice(-20,-10),i=this.average(t.map(o=>o.score)),n=this.average(e.map(o=>o.score)),r=i-n;return r>5?"improving":r<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var i;const t=(i=window.performanceConfig)==null?void 0:i.viewer;if(!t)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:n,delta:r,op:o})=>{const a=this.viewer[n],c=t[n];o==="increase"&&a<c?this.viewer[n]=Math.min(c,a+r):o==="decrease"&&a>c&&(this.viewer[n]=Math.max(c,a-r))})}onTileLoaded(t){var e;(e=t.tile)!=null&&e.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+t.tile.loadTime*.1)}onTileLoadFailed(t){console.warn("Tile load failed:",t.tile)}trackLoadTime(t){this.loadTimes.push(t),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const t=this.getPerformanceLevel();return{...this.metrics,performanceLevel:t,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:t,performanceScore:e}=this.metrics,{fps:i}=this.thresholds;return[{name:"excellent",condition:t>=i.target&&e>=90},{name:"good",condition:t>=i.good&&e>=80},{name:"acceptable",condition:t>=i.acceptable&&e>=60},{name:"poor",condition:t>=i.poor&&e>=40},{name:"critical",condition:!0}].find(r=>r.condition).name}getWarnings(){const t=this.metrics,e=this.thresholds;return[{condition:t.averageFPS<e.fps.acceptable,message:`Low FPS: ${t.averageFPS} (target: ${e.fps.target})`},{condition:t.droppedFrames>100,message:`Dropped frames: ${t.droppedFrames}`},{condition:parseFloat(t.frameTime)>e.frameTime.warning,message:`High frame time: ${t.frameTime}ms`},{condition:t.memoryUsage>e.memory.critical,message:`High memory: ${t.memoryUsage}MB`},{condition:t.cachedTiles>2e3,message:`Large cache: ${t.cachedTiles} tiles`},{condition:t.tileLoadTime>300,message:`Slow tile loading: ${Math.round(t.tileLoadTime)}ms`}].filter(n=>n.condition).map(n=>n.message)}getRecommendations(){const t=[],e=this.metrics,i=this.thresholds;return e.averageFPS<i.fps.acceptable&&(e.renderMode==="animating"&&t.push("Reduce animation time for smoother transitions"),e.cachedTiles>1e3&&t.push("Clear tile cache to free memory"),e.visibleTiles>50&&t.push("Zoom in to reduce visible tiles")),e.memoryUsage>i.memory.warning&&t.push("Consider reloading the page to clear memory"),e.tileLoadTime>200&&t.push("Check network connection or reduce concurrent tile loads"),t}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const t=this.getMetrics(),e={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},i=t.currentFPS<55?"#FF9800":"#4CAF50",n=t.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${e[t.performanceLevel]};">
                    ${t.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${i};">
                    ${t.currentFPS.toFixed(0)} (avg: ${t.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${t.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${n};">
                    ${t.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${e[t.performanceLevel]}; font-weight: 500;">
                    ${t.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(t){return t.reduce((e,i)=>e+i,0)/t.length}trimArray(t,e){for(;t.length>e;)t.shift()}}class id{constructor(t){this.viewer=t,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([e,i])=>this.viewer.addHandler(e,i))}applyInitialOptimizations(){const t=this.viewer.container;t&&Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const t=performance.now(),e=t-this.state.lastFrameTime;if(this.state.lastFrameTime=t,this.viewer.viewport.getZoom()<3&&e>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let t=null,e=!1;this.viewer.addHandler("zoom",()=>{if(!e){if(e=!0,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!1,i.globalAlpha=1}this.viewer.skipTileDrawing=!0}t&&clearTimeout(t),t=setTimeout(()=>{if(e=!1,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!0,i.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),t=null},150)})}handleViewportChange(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const i=Math.abs(t-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+i*.3,this.state.isZooming=i>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const i=Math.sqrt(Math.pow(e.x-this.lastCenter.x,2)+Math.pow(e.y-this.lastCenter.y,2));this.state.isPanning=i>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=t,this.lastCenter=e}applyZoomOptimizations(t){var i,n;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((n=(i=window.performanceConfig)==null?void 0:i.renderOptimization)!=null&&n.zoomOptimizations))){if(t&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&(this.state.lastBlendTime=r.blendTime,r.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!t&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&this.state.lastBlendTime!==null&&(r.blendTime=this.state.lastBlendTime)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(t){var i;this.lastInteraction=Date.now();const e={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(i=e[t])==null||i.call(e)}setRenderMode(t){var i,n;if(this.state.renderMode===t)return;const e=this.state.renderMode;this.state.renderMode=t,t==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):t==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(n=(i=window.performanceConfig)==null?void 0:i.debug)!=null&&n.logPerformance&&console.log(`Render mode: ${e}  ${t}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var n,r;const t=Date.now();if(t-this.lastOptimizationTime<this.config.optimizationCooldown)return;const e=(n=this.viewer.drawer)==null?void 0:n.canvas,i=(r=this.viewer.drawer)==null?void 0:r.context;!e||!i||(Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(i,!0),i.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=t)}removeCanvasOptimizations(){var e;const t=(e=this.viewer.drawer)==null?void 0:e.context;t&&(this.setContextSmoothing(t,!0),t.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(t,e){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(n=>{n in t&&(t[n]=e)})}clearTimers(){Object.entries(this.timers).forEach(([t,e])=>{clearTimeout(e),delete this.timers[t]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(t){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(i=>Object.assign(i.style,t))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(t){Object.assign(this.config,t)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var t,e;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((e=(t=window.performanceConfig)==null?void 0:t.viewer)==null?void 0:e.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(t=>this.viewer.removeAllHandlers(t)),this.removeCanvasOptimizations(),this.viewer=null}}function Ec(s,t,e=0,i=s.length-1,n=nd){for(;i>e;){if(i-e>600){const c=i-e+1,h=t-e+1,d=Math.log(c),l=.5*Math.exp(2*d/3),f=.5*Math.sqrt(d*l*(c-l)/c)*(h-c/2<0?-1:1),p=Math.max(e,Math.floor(t-h*l/c+f)),m=Math.min(i,Math.floor(t+(c-h)*l/c+f));Ec(s,t,p,m,n)}const r=s[t];let o=e,a=i;for(bn(s,e,t),n(s[i],r)>0&&bn(s,e,i);o<a;){for(bn(s,o,a),o++,a--;n(s[o],r)<0;)o++;for(;n(s[a],r)>0;)a--}n(s[e],r)===0?bn(s,e,a):(a++,bn(s,a,i)),a<=t&&(e=a+1),t<=a&&(i=a-1)}}function bn(s,t,e){const i=s[t];s[t]=s[e],s[e]=i}function nd(s,t){return s<t?-1:s>t?1:0}class rd{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const i=[];if(!vr(t,e))return i;const n=this.toBBox,r=[];for(;e;){for(let o=0;o<e.children.length;o++){const a=e.children[o],c=e.leaf?n(a):a;vr(t,c)&&(e.leaf?i.push(a):ks(t,c)?this._all(a,i):r.push(a))}e=r.pop()}return i}collides(t){let e=this.data;if(!vr(t,e))return!1;const i=[];for(;e;){for(let n=0;n<e.children.length;n++){const r=e.children[n],o=e.leaf?this.toBBox(r):r;if(vr(t,o)){if(e.leaf||ks(t,o))return!0;i.push(r)}}e=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const i=this.data;this.data=e,e=i}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Ui([]),this}remove(t,e){if(!t)return this;let i=this.data;const n=this.toBBox(t),r=[],o=[];let a,c,h;for(;i||r.length;){if(i||(i=r.pop(),c=r[r.length-1],a=o.pop(),h=!0),i.leaf){const d=sd(t,i.children,e);if(d!==-1)return i.children.splice(d,1),r.push(i),this._condense(r),this}!h&&!i.leaf&&ks(i,n)?(r.push(i),o.push(a),a=0,c=i,i=i.children[0]):c?(a++,i=c.children[a],h=!1):i=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,n){const r=i-e+1;let o=this._maxEntries,a;if(r<=o)return a=Ui(t.slice(e,i+1)),Ni(a,this.toBBox),a;n||(n=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,n-1))),a=Ui([]),a.leaf=!1,a.height=n;const c=Math.ceil(r/o),h=c*Math.ceil(Math.sqrt(o));Ga(t,e,i,h,this.compareMinX);for(let d=e;d<=i;d+=h){const l=Math.min(d+h-1,i);Ga(t,d,l,c,this.compareMinY);for(let f=d;f<=l;f+=c){const p=Math.min(f+c-1,l);a.children.push(this._build(t,f,p,n-1))}}return Ni(a,this.toBBox),a}_chooseSubtree(t,e,i,n){for(;n.push(e),!(e.leaf||n.length-1===i);){let r=1/0,o=1/0,a;for(let c=0;c<e.children.length;c++){const h=e.children[c],d=Ms(h),l=ld(t,h)-d;l<o?(o=l,r=d<r?d:r,a=h):l===o&&d<r&&(r=d,a=h)}e=a||e.children[0]}return e}_insert(t,e,i){const n=i?t:this.toBBox(t),r=[],o=this._chooseSubtree(n,this.data,e,r);for(o.children.push(t),Pn(o,n);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(n,r,e)}_split(t,e){const i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);const o=this._chooseSplitIndex(i,r,n),a=Ui(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,Ni(i,this.toBBox),Ni(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)}_splitRoot(t,e){this.data=Ui([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Ni(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let n,r=1/0,o=1/0;for(let a=e;a<=i-e;a++){const c=Sn(t,0,a,this.toBBox),h=Sn(t,a,i,this.toBBox),d=cd(c,h),l=Ms(c)+Ms(h);d<r?(r=d,n=a,o=l<o?l:o):d===r&&l<o&&(o=l,n=a)}return n||i-e}_chooseSplitAxis(t,e,i){const n=t.leaf?this.compareMinX:od,r=t.leaf?this.compareMinY:ad,o=this._allDistMargin(t,e,i,n),a=this._allDistMargin(t,e,i,r);o<a&&t.children.sort(n)}_allDistMargin(t,e,i,n){t.children.sort(n);const r=this.toBBox,o=Sn(t,0,e,r),a=Sn(t,i-e,i,r);let c=gr(o)+gr(a);for(let h=e;h<i-e;h++){const d=t.children[h];Pn(o,t.leaf?r(d):d),c+=gr(o)}for(let h=i-e-1;h>=e;h--){const d=t.children[h];Pn(a,t.leaf?r(d):d),c+=gr(a)}return c}_adjustParentBBoxes(t,e,i){for(let n=i;n>=0;n--)Pn(e[n],t)}_condense(t){for(let e=t.length-1,i;e>=0;e--)t[e].children.length===0?e>0?(i=t[e-1].children,i.splice(i.indexOf(t[e]),1)):this.clear():Ni(t[e],this.toBBox)}}function sd(s,t,e){if(!e)return t.indexOf(s);for(let i=0;i<t.length;i++)if(e(s,t[i]))return i;return-1}function Ni(s,t){Sn(s,0,s.children.length,t,s)}function Sn(s,t,e,i,n){n||(n=Ui(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let r=t;r<e;r++){const o=s.children[r];Pn(n,s.leaf?i(o):o)}return n}function Pn(s,t){return s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY),s}function od(s,t){return s.minX-t.minX}function ad(s,t){return s.minY-t.minY}function Ms(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function gr(s){return s.maxX-s.minX+(s.maxY-s.minY)}function ld(s,t){return(Math.max(t.maxX,s.maxX)-Math.min(t.minX,s.minX))*(Math.max(t.maxY,s.maxY)-Math.min(t.minY,s.minY))}function cd(s,t){const e=Math.max(s.minX,t.minX),i=Math.max(s.minY,t.minY),n=Math.min(s.maxX,t.maxX),r=Math.min(s.maxY,t.maxY);return Math.max(0,n-e)*Math.max(0,r-i)}function ks(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function vr(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function Ui(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Ga(s,t,e,i,n){const r=[t,e];for(;r.length;){if(e=r.pop(),t=r.pop(),e-t<=i)continue;const o=t+Math.ceil((e-t)/i/2)*i;Ec(s,o,t,e,n),r.push(t,o,o,e)}}class hd{constructor(){this.tree=new rd(9),this.hotspots=new Map,this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(t){const e=performance.now();this.tree.clear(),this.hotspots.clear(),this.queryCache.clear();const i=[];t.forEach(r=>{const o=this.calculateBoundingBox(r.coordinates);this.hotspots.set(r.id,{...r,bbox:o}),i.push({minX:o.minX,minY:o.minY,maxX:o.maxX,maxY:o.maxY,id:r.id})}),this.tree.load(i);const n=performance.now()-e;console.log(`Spatial index built in ${n.toFixed(2)}ms for ${i.length} hotspots`)}queryViewport(t,e=1){const i=`${t.minX.toFixed(2)},${t.minY.toFixed(2)},${t.maxX.toFixed(2)},${t.maxY.toFixed(2)},${e.toFixed(2)}`;if(this.queryCache.has(i))return this.queryCache.get(i);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const r=this.tree.search({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY}).map(o=>this.hotspots.get(o.id));return this.queryCache.size<this.cacheSize&&this.queryCache.set(i,r),r}getHotspotAtPoint(t,e){const i=this.tree.search({minX:t,minY:e,maxX:t,maxY:e});for(const n of i){const r=this.hotspots.get(n.id);if(this.isPointInHotspot(t,e,r))return r}return null}calculateBoundingBox(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{for(const c of a)e=Math.min(e,c[0]),i=Math.min(i,c[1]),n=Math.max(n,c[0]),r=Math.max(r,c[1])};if(t.length>0&&typeof t[0][0]=="number")o(t);else for(const a of t)o(a);return{minX:e,minY:i,maxX:n,maxY:r}}isPointInHotspot(t,e,i){return i.shape==="polygon"?this.pointInPolygon(t,e,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(n=>this.pointInPolygon(t,e,n)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}getAllHotspots(){return Array.from(this.hotspots.values())}clear(){this.tree.clear(),this.hotspots.clear(),this.queryCache.clear()}}class ud{constructor(t){this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:15}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(t){if(!t.tile)return;const e=this.getTileKey(t.tile);this.tileAccessTimes.set(e,Date.now())}handleViewportChange(){var i;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0);if(!t||!t._tilesToDraw)return;const e=Date.now();t._tilesToDraw.forEach(n=>{const r=this.getTileKey(n);this.tileAccessTimes.set(r,e)})}getTileKey(t){return`${t.level}_${t.x}_${t.y}`}monitorPerformance(){var i,n;const t=((n=(i=window.performanceMonitor)==null?void 0:i.getMetrics())==null?void 0:n.averageFPS)||60,e=this.state.currentPressure;t<this.config.fpsThresholds.critical?this.state.currentPressure="critical":t<this.config.fpsThresholds.poor?this.state.currentPressure="high":t<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",e!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${e}  ${this.state.currentPressure} (FPS: ${t})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const e={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),e)}performCleanup(){var L;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const e=performance.now(),i=(L=this.viewer.world)==null?void 0:L.getItemAt(0);if(!i||!i._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const r=this.state.currentPressure,o=this.config.maxTileAge[r],a=this.config.cacheThresholds[r],c=this.config.keepDistance[r],h=Date.now(),l=this.viewer.viewport.getBounds(),f={x:l.x-l.width*(c-1)/2,y:l.y-l.height*(c-1)/2,width:l.width*c,height:l.height*c},m=i._tileCache._tilesLoaded||[],v=m.length;if(v===0)return;const w=new Set;i._tilesToDraw&&i._tilesToDraw.forEach(j=>{const G=this.getTileKey(j);w.add(G)});const x=[];if(m.forEach(j=>{const G=this.getTileKey(j);if(w.has(G))return;const J=this.tileAccessTimes.get(G)||0,M=h-J;let A=!1;if(M>o&&(A=!0),!A&&r!=="normal"){const C=j.bounds;C&&(!(C.x+C.width<f.x||C.x>f.x+f.width||C.y+C.height<f.y||C.y>f.y+f.height)||(A=!0))}A&&x.push(j)}),v>a){const j=v-a;if(j>x.length){const G=m.filter(M=>{const A=this.getTileKey(M);return!x.includes(M)&&!w.has(A)});G.sort((M,A)=>{const C=this.getTileKey(M),k=this.getTileKey(A),F=this.tileAccessTimes.get(C)||0,O=this.tileAccessTimes.get(k)||0;return F-O});const J=j-x.length;x.push(...G.slice(0,J))}}x.length>0&&(x.forEach(j=>{const G=this.getTileKey(j);this.tileAccessTimes.delete(G),j.unload&&j.unload()}),this.state.tilesRemoved+=x.length,this.metrics.totalCleaned+=x.length,console.log(`Cleaned ${x.length} tiles (pressure: ${r}, cache was: ${v}, kept ${w.size} visible)`));const R=performance.now()-e;this.metrics.lastCleanupDuration=R,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+R)/this.metrics.cleanupRuns,this.state.lastCleanup=h,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const e=performance.now(),i=Date.now(),n=3e5,r=[];this.tileAccessTimes.forEach((a,c)=>{i-a>n&&r.push(c)}),r.forEach(a=>this.tileAccessTimes.delete(a)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const o=performance.now()-e;this.state.lastDeepCleanup=i,console.log(`Deep cleanup completed in ${o.toFixed(2)}ms, cleared ${r.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var i,n,r;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0),e=((r=(n=t==null?void 0:t._tileCache)==null?void 0:n._tilesLoaded)==null?void 0:r.length)||0;return{...this.metrics,currentCacheSize:e,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(t){["normal","elevated","high","critical"].includes(t)&&(this.state.currentPressure=t,this.updateCleanupInterval())}pauseCleanup(t=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},t))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class dd{constructor(t){this.viewer=t,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(t){throw console.error("Failed to initialize TileWorkerManager:",t),this.state.lastError=t,t}}async processTile(t,e=2){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tile:t}),this.worker.postMessage({type:"process-tile",requestId:i,data:{tile:this.serializeTile(t),priority:e}}),this.metrics.requestsSent++})}async processBatch(t,e=[]){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Batch processing timeout"))},this.config.requestTimeout*t.length);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tiles:t}),this.worker.postMessage({type:"batch-process",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),priorities:e}}),this.metrics.requestsSent++})}async prioritizeTiles(t,e){if(this.isInitialized||await this.initialize(),t.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const n=t.map(r=>{const o=(r.bounds.minX+r.bounds.maxX)/2,a=(r.bounds.minY+r.bounds.maxY)/2,c=(e.bounds.minX+e.bounds.maxX)/2,h=(e.bounds.minY+e.bounds.maxY)/2,d=Math.sqrt(Math.pow(o-c,2)+Math.pow(a-h,2));return d<.5?0:d<1?1:2});return{tiles:t,priorities:n}}const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),n({tiles:t,priorities:t.map(()=>1)})},50);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:"prioritize",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),viewport:{bounds:e.bounds,zoom:e.zoom}}})})}clearCache(t=!1,e=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:t,maxAge:e}})}async getStats(){if(!this.isInitialized)return this.metrics;const t=this.generateRequestId();return new Promise(e=>{const i=setTimeout(()=>{this.state.pendingRequests.delete(t),e(this.metrics)},1e3);this.state.pendingRequests.set(t,{resolve:e,reject:()=>{},timeout:i}),this.worker.postMessage({type:"get-stats",requestId:t})})}handleWorkerMessage(t){const{type:e,requestId:i,data:n}=t.data;switch(e){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=n.capabilities,this.handleRequestComplete(i,n);break;case"tile-ready":this.handleTileReady(i,n);break;case"tile-error":this.handleTileError(i,n);break;case"batch-complete":this.handleRequestComplete(i,n);break;case"priorities-calculated":this.handleRequestComplete(i,n);break;case"stats":this.handleStatsReceived(i,n);break;case"cache-cleared":console.log("Worker cache cleared:",n);break;default:console.warn("Unknown worker message type:",e)}}handleWorkerError(t){console.error("Worker error:",t),this.state.lastError=t,this.state.pendingRequests.forEach((e,i)=>{clearTimeout(e.timeout),e.reject(t)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n=performance.now()-i.startTime;this.updateMetrics(n,e.cached),i.resolve({...e,processingTime:n})}handleTileError(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),this.metrics.requestsFailed++,i.reject(new Error(e.error)))}handleRequestComplete(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),i.resolve(e))}handleStatsReceived(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n={...this.metrics,worker:e};i.resolve(n)}updateMetrics(t,e){this.metrics.requestsCompleted++,e&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=t,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(t){return{level:t.level,x:t.x,y:t.y,bounds:t.bounds?{minX:t.bounds.x||t.bounds.minX,minY:t.bounds.y||t.bounds.minY,maxX:(t.bounds.x||t.bounds.minX)+(t.bounds.width||0),maxY:(t.bounds.y||t.bounds.minY)+(t.bounds.height||0)}:null,url:t.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(t=>{if(this.state.workerReady){t();return}const e=setInterval(()=>{this.state.workerReady&&(clearInterval(e),t())},100);setTimeout(()=>{clearInterval(e),t()},5e3)})}async sendToWorker(t,e){const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),r(new Error(`Worker request timeout: ${t}`))},5e3);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:t,requestId:i,data:e})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(t=>{clearTimeout(t.timeout),t.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class fd{constructor(t){this.viewer=t,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new dd(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(t){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",t),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const t=this.viewer.viewport,e=t.getBounds(),i={bounds:{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height},zoom:t.getZoom()},n=this.state.tileQueue.slice(0,50),r=await this.workerManager.prioritizeTiles(n,i);r.tiles&&r.priorities&&(r.tiles.forEach((o,a)=>{const c=r.priorities[a],h=this.state.tileQueue.find(d=>d.level===o.level&&d.x===o.x&&d.y===o.y);h&&(h.priority=c)}),this.sortQueue())}catch(t){console.warn("Failed to update worker priorities:",t)}}calculateTilePriority(t,e,i){const n=this.viewer.viewport,r=n.getBounds(),o=n.getCenter(),a=n.getZoom();if(a<2&&this.viewer.source.getTileWidth(t)*a<32)return 999;const c=this.viewer.source.getTileWidth(t),h=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):c,d=(e+.5)*c/this.viewer.source.width,l=(i+.5)*h/this.viewer.source.height,f=Math.sqrt(Math.pow(d-o.x,2)+Math.pow(l-o.y,2)),p={left:e*c/this.viewer.source.width,top:i*h/this.viewer.source.height,right:(e+1)*c/this.viewer.source.width,bottom:(i+1)*h/this.viewer.source.height};return p.right<r.x||p.left>r.x+r.width||p.bottom<r.y||p.top>r.y+r.height?f<r.width*this.config.predictiveRadius?1:2:a<3?Math.abs(d-o.x)+Math.abs(l-o.y)<.2?0:1:0}enqueueTile(t,e,i,n){const r=`${t}_${e}_${i}`;if(this.state.loadingTiles.has(r))return;const o=this.state.tileQueue.findIndex(c=>c.key===r);if(o>=0){n<this.state.tileQueue[o].priority&&(this.state.tileQueue[o].priority=n,this.sortQueue());return}const a={level:t,x:e,y:i,key:r,priority:n,timestamp:Date.now(),bounds:this.calculateTileBounds(t,e,i)};this.state.tileQueue.push(a),this.sortQueue()}calculateTileBounds(t,e,i){const n=this.viewer.source.getTileWidth(t),r=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):n,o=this.viewer.source.width,a=this.viewer.source.height;return{minX:e*n/o,minY:i*r/a,maxX:(e+1)*n/o,maxY:(i+1)*r/a}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const t=this.state.tileQueue.filter(e=>e.priority<=1).slice(0,this.config.workerBatchSize);if(t.length!==0)try{const e=t.map(r=>r.priority),i=performance.now();await this.workerManager.processBatch(t,e);const n=performance.now()-i;this.workerMetrics.tilesProcessedByWorker+=t.length,this.workerMetrics.workerProcessingTime+=n,t.forEach(r=>{const o=this.state.tileQueue.findIndex(a=>a.key===r.key);o>=0&&this.state.tileQueue.splice(o,1)})}catch(e){console.error("Worker batch processing failed:",e),this.workerMetrics.workerErrors++}}processQueue(){var e;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((e=this.viewer.world)!=null&&e.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const i=this.state.tileQueue.shift();Date.now()-i.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(i.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((t,e)=>t.priority!==e.priority?t.priority-e.priority:t.timestamp-e.timestamp)}predictiveLoad(){var f;if(this.shouldSkipPredictiveLoad()||!((f=this.viewer.world)==null?void 0:f.getItemAt(0))||!this.viewer.source)return;const e=this.viewer.viewport,i=e.getBounds(),n={x:i.x-i.width*(this.config.predictiveRadius-1)/2,y:i.y-i.height*(this.config.predictiveRadius-1)/2,width:i.width*this.config.predictiveRadius,height:i.height*this.config.predictiveRadius},r=e.getZoom(),o=Math.max(0,Math.min(Math.floor(Math.log2(r)),this.viewer.source.maxLevel||14)),a=this.viewer.source.getTileWidth(o),c=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(o):a,h=this.viewer.source.width,d=this.viewer.source.height,l={startX:Math.max(0,Math.floor(n.x*h/a)),endX:Math.min(Math.ceil(h/a)-1,Math.ceil((n.x+n.width)*h/a)),startY:Math.max(0,Math.floor(n.y*d/c)),endY:Math.min(Math.ceil(d/c)-1,Math.ceil((n.y+n.height)*d/c))};for(let p=l.startX;p<=l.endX;p++)for(let m=l.startY;m<=l.endY;m++){const v=this.calculateTilePriority(o,p,m);this.enqueueTile(o,p,m,v)}}trackLoadTime(t){this.state.loadTimes.push(t),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((e,i)=>e+i,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(t){this.state.loadingTiles.delete(t)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const t=this.state.averageLoadTime,e=this.config.maxConcurrentLoads;t>500&&e>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`)):t<200&&e<8&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`))}performCleanup(){const t=Date.now();this.state.tileQueue=this.state.tileQueue.filter(e=>t-e.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=t,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const t=document.createElement("canvas");t.width=t.height=1;const e=t.getContext("2d");e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,1,1);try{return t.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const t=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:t}}}let yr=new Map,wr=null,Os=null;function pd(s){if(console.log("=== APPLYING OPTIMIZED TILE CASCADE FIX ==="),/Android|iPhone|iPad/i.test(navigator.userAgent)){console.log("TileCascadeFix disabled on mobile for testing");return}if(!s){console.error("OpenSeadragon not provided - cannot apply tile cascade fix");return}const e=s.TiledImage.prototype._getLevelsInterval,i=s.TiledImage.prototype._updateLevels;if(!e){console.error("_getLevelsInterval method not found - cannot apply fix");return}s.TiledImage.prototype._getLevelsInterval=function(){const n=this.viewer.viewport.getZoom();if(wr!==null&&Math.abs(n-wr)<.01&&yr.has(this))return yr.get(this);const r=e.call(this);if(!r||typeof r.lowestLevel>"u")return r;let o=r;if(n<3){const a=/Android|iPhone|iPad/i.test(navigator.userAgent),c=Math.floor(Math.log2(n*1024/256)),h=Math.max(8,Math.min(12,c+11)),d=a?4:3;o={lowestLevel:Math.max(8,h-Math.floor(d/2)),highestLevel:Math.min(14,h+Math.floor(d/2))},o.highestLevel-o.lowestLevel>d-1&&(o.lowestLevel=o.highestLevel-(d-1))}return yr.set(this,o),wr=n,Os&&clearTimeout(Os),Os=setTimeout(()=>{yr.clear(),wr=null},100),o},i&&(s.TiledImage.prototype._updateLevels=function(){if(this.viewer.isAnimating())return;const n=i.call(this);if(this.viewer.viewport.getZoom()<3&&this._tilesToDraw){const o=this._getLevelsInterval();this._tilesToDraw=this._tilesToDraw.filter(a=>a.level>=o.lowestLevel&&a.level<=o.highestLevel)}return n}),console.log("=== OPTIMIZED TILE CASCADE FIX APPLIED ===")}class md{constructor(t){this.viewer=t,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const t=performance.now();return this.cacheEnabled&&this.cachedViewport&&t-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const t=performance.now(),e=this.viewer.viewport,i=e.getBounds(),n=e.viewportToImageCoordinates(i.getTopLeft()),r=e.viewportToImageCoordinates(i.getBottomRight()),o=r.x-n.x,a=r.y-n.y,c=o*this.viewportPadding,h=a*this.viewportPadding,d=this.viewer.world.getItemAt(0),l=d?d.getContentSize():{x:1,y:1},p={bounds:{minX:Math.max(0,n.x-c),minY:Math.max(0,n.y-h),maxX:Math.min(l.x,r.x+c),maxY:Math.min(l.y,r.y+h)},zoom:e.getZoom(!0),center:e.getCenter(!0),rotation:e.getRotation(),containerSize:e.getContainerSize(),imageBounds:{minX:n.x,minY:n.y,maxX:r.x,maxY:r.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=p,this.lastUpdate=performance.now();const m=this.lastUpdate-t;return this.metrics.lastUpdateDuration=m,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+m)/this.metrics.totalUpdates,p}isPointInViewport(t,e,i=!1){const n=this.getCurrentViewport(),r=i?n.bounds:n.imageBounds;return t>=r.minX&&t<=r.maxX&&e>=r.minY&&e<=r.maxY}isBoxInViewport(t,e,i,n,r=!0){const o=this.getCurrentViewport(),a=r?o.bounds:o.imageBounds;return!(i<a.minX||t>a.maxX||n<a.minY||e>a.maxY)}imageToPixel(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(t,e));return this.viewer.viewport.pixelFromPoint(i)}pixelToImage(t,e){const i=this.viewer.viewport.pointFromPixel(new Ue.Point(t,e));return this.viewer.viewport.viewportToImageCoordinates(i)}calculatePixelRatio(){const t=this.viewer.viewport,e=t.getContainerSize(),i=t.getBounds(),n=this.viewer.world.getItemAt(0);if(!n)return 1;const r=n.getContentSize(),o=i.width*r.x;return e.x/o}getLevelOfDetail(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getMaxZoom(),i=t/e;return i<.1?0:i<.3?1:i<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const t=this.getCurrentViewport(),e=this.viewer.world.getItemAt(0);if(!e)return 1;const i=e.getContentSize(),n=(t.imageBounds.maxX-t.imageBounds.minX)*(t.imageBounds.maxY-t.imageBounds.minY),r=i.x*i.y;return n/r}getMetrics(){const t=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:t.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const t=this.getCurrentViewport();return{x:t.imageBounds.minX,y:t.imageBounds.minY,width:t.imageBounds.maxX-t.imageBounds.minX,height:t.imageBounds.maxY-t.imageBounds.minY}}setCacheEnabled(t){this.cacheEnabled=t,t||(this.cachedViewport=null)}setCacheTimeout(t){this.cacheTimeout=Math.max(0,t)}setViewportPadding(t){this.viewportPadding=Math.max(0,Math.min(1,t))}destroy(){this.viewer=null,this.cachedViewport=null}}class Za{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],c=t[(r+1)%n],h=Math.atan2(a[1]-o[1],a[0]-o[0]);let l=Math.atan2(c[1]-a[1],c[0]-a[0])-h;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const f=Math.sqrt(Math.pow(c[0]-a[0],2)+Math.pow(c[1]-a[1],2)),p=Math.abs(l)/(f+1e-10);e+=p,i=Math.max(i,p)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let d=0;d<e;d++){const l=t[(d+1)%e];n+=Math.sqrt(Math.pow(t[d][0]-l[0],2)+Math.pow(t[d][1]-l[1],2))}const o=n/e*3;for(let d=0;d<e;d++)for(let l=0;l<e;l++){if(d===l)continue;Math.sqrt(Math.pow(t[d][0]-t[l][0],2)+Math.pow(t[d][1]-t[l][1],2))<o&&i[d]++}const a=Math.max(...i),c=i.reduce((d,l)=>d+l,0)/e,h=i.reduce((d,l)=>d+Math.pow(l-c,2),0)/e;return{maxDensity:a,avgDensity:c,variance:h,uniformityScore:1-Math.sqrt(h)/(c+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation()):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation()))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.viewer.container.getBoundingClientRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const r=this.calculateAdaptivePolygonExpansion(i),o=this.expandPolygon(i,r),a=[];let c=0,h=0;o.forEach(([l,f])=>{const p=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(l,f)),m=this.viewer.viewport.viewportToWindowCoordinates(p);c+=m.x,h+=m.y}),c/=o.length,h/=o.length;let d=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(d=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([l,f])=>{const p=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(l,f)),m=this.viewer.viewport.viewportToWindowCoordinates(p),v=c+(m.x-c)*d,w=h+(m.y-h)*d;a.push(`${v},${w}`)}),a.length>0)if(this.useClipPath){const l=e.width,f=e.height,p=`0,0 ${l},0 ${l},${f} 0,${f} 0,0`,m=a.slice().reverse().join(" "),v=`polygon(${p} ${m})`;this.overlayElement.style.clipPath=v,this.overlayElement.style.webkitClipPath=v}else{const l=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,p=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(l)))}`;this.overlayElement.style.mask=`url("${p}")`,this.overlayElement.style.webkitMask=`url("${p}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,c=o*this.viewer.container.clientHeight,d=Math.max(a,c)*.75;return Math.max(50,Math.min(500,d))}trackFocusReference(){if(!this.state.selectedHotspot)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y)),a=e.x-o.x,c=e.y-o.y,h=Math.sqrt(a*a+c*c),d=.01,l=.02;h<=d?r=1:h>=d+l?r=0:r=1-(h-d)/l}return r<.1?r:Math.min(n,r)}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t),i=this.calculateZunicRosinConvexity(t),n=this.calculateDiscreteRoughness(t),r=this.analyzeVertexDensity(t),o={fillEfficiency:.25,convexity:.2,roughness:.2,density:.15,aspectRatio:.1,compactness:.1},a={fillEfficiency:1-e.fillEfficiency,convexity:1-i,roughness:n.roughnessScore,density:1-r.uniformityScore,aspectRatio:Math.min(1,Math.abs(Math.log(e.aspectRatio))/2),compactness:1-e.compactness};a.fillEfficiency=Math.pow(a.fillEfficiency,1.5),a.roughness=Math.pow(a.roughness,1.2);let c=0;for(const[d,l]of Object.entries(o))c+=a[d]*l;n.maxCurvature>10&&(c=Math.max(c,.8)),(e.aspectRatio>3||e.aspectRatio<.33)&&(c=Math.max(c,.7));const h=1+c*.4;return this.lastExpansionMetrics={scores:a,compositeScore:c,expansionFactor:h,metrics:{convexity:i,roughness:n,density:r}},h}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const c=o-n,h=a-r;return[n+c*e,r+h*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class Xa{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.85,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.25,baseRadius:50,updateThrottle:16,enableTransitions:!0,transitionDuration:300,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.borderColors={"electric-yellow":{r:255,g:255,b:0},"vibrant-orange":{r:255,g:124,b:0},"pure-red":{r:255,g:0,b:0},"soft-cyan":{r:0,g:200,b:255},"muted-blue":{r:0,g:123,b:255},"warm-gray":{r:180,g:180,b:180}},this.borderConfig={color:"soft-cyan",opacity:.6,strokeWidth:2,blurAmount:2},this.useEllipse=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0},this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.lastUpdateTime=0,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[c,h]=i,d=n*(a-h)-r*(o-c)+o*h-c*a;if(Math.abs(d)<1e-10)return this.minCircleTrivial([t,e]);const l=(n*n+r*r)*(h-a)+(o*o+a*a)*(r-h)+(c*c+h*h)*(a-r),f=(n*n+r*r)*(o-c)+(o*o+a*a)*(c-n)+(c*c+h*h)*(n-o),p=-l/(2*d),m=-f/(2*d),v=n-p,w=r-m,x=Math.sqrt(v*v+w*w);return{x:p,y:m,r:x}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){return this.calculateAdvancedAdaptivePadding(t,e)}calculateEllipseFromPolygon(t){var j;const e=t.length+"_"+t[0][0]+"_"+t[0][1];if(this.ellipseCache.has(e)){const G=this.ellipseCache.get(e);return this.useEllipse=G.useEllipse,G.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonMetrics(t),r=i.width/i.height,o=this.calculateDiscreteRoughness(t),a=this.analyzeVertexDensity(t),c=(r>1.1||r<.91)&&(o.roughnessScore<.85||r>1.5||r<.67);if(console.log("Ellipse calculation:",{hotspotId:(j=this.state.selectedHotspot)==null?void 0:j.id,aspectRatio:r,roughnessScore:o.roughnessScore,useEllipse:c}),!c)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const h=this.calculateOrientedBoundingBox(t);let d=1.25,l=1.25;const f=h.angle*Math.PI/180,p=Math.cos(f),m=Math.sin(f);let v=0,w=0;t.forEach(([G,J])=>{const M=G-h.centerX,A=J-h.centerY,C=M*p+A*m,k=-M*m+A*p;v+=C*C,w+=k*k}),v/=t.length,w/=t.length;const x=Math.sqrt(v),R=Math.sqrt(w);if(d*=1+Math.min(.2,x/(h.width/2)),l*=1+Math.min(.2,R/(h.height/2)),n.fillEfficiency<.6&&(d*=1.1,l*=1.1),a.uniformityScore<.5){const G=1+.25*(1-a.uniformityScore);d*=G,l*=G}d=Math.max(d,1.3),l=Math.max(l,1.3);const L={radiusX:h.width/2*d,radiusY:h.height/2*l,rotation:h.angle,aspectRatio:r,centerX:h.centerX,centerY:h.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:L}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.ellipseCache.clear()},5e3),L}calculateOrientedBoundingBox(t){const e=t.length;let i=0,n=0;t.forEach(([L,j])=>{i+=L,n+=j});const r=i/e,o=n/e;let a=0,c=0,h=0;t.forEach(([L,j])=>{const G=L-r,J=j-o;a+=G*G,c+=J*J,h+=G*J}),a/=e,c/=e,h/=e;const d=a+c,l=a*c-h*h,f=Math.sqrt(Math.max(0,d*d-4*l)),p=(d+f)/2;let m=0;Math.abs(h)>1e-10&&(m=Math.atan2(p-a,h));let v=1/0,w=-1/0,x=1/0,R=-1/0;return t.forEach(([L,j])=>{const G=L-r,J=j-o,M=G*Math.cos(m)+J*Math.sin(m),A=-G*Math.sin(m)+J*Math.cos(m);v=Math.min(v,M),w=Math.max(w,M),x=Math.min(x,A),R=Math.max(R,A)}),{centerX:r,centerY:o,width:w-v,height:R-x,angle:m*180/Math.PI}}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],c=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const h=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);c*h<0&&e++}}return Math.min(e/(i*.5),1)}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],c=t[(r+1)%n],h=Math.atan2(a[1]-o[1],a[0]-o[0]);let l=Math.atan2(c[1]-a[1],c[0]-a[0])-h;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const f=Math.sqrt(Math.pow(c[0]-a[0],2)+Math.pow(c[1]-a[1],2)),p=Math.abs(l)/(f+1e-10);e+=p,i=Math.max(i,p)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let d=0;d<e;d++){const l=t[(d+1)%e];n+=Math.sqrt(Math.pow(t[d][0]-l[0],2)+Math.pow(t[d][1]-l[1],2))}const o=n/e*3;for(let d=0;d<e;d++)for(let l=0;l<e;l++){if(d===l)continue;Math.sqrt(Math.pow(t[d][0]-t[l][0],2)+Math.pow(t[d][1]-t[l][1],2))<o&&i[d]++}const a=Math.max(...i),c=i.reduce((d,l)=>d+l,0)/e,h=i.reduce((d,l)=>d+Math.pow(l-c,2),0)/e;return{maxDensity:a,avgDensity:c,variance:h,uniformityScore:1-Math.sqrt(h)/(c+1)}}calculateAdvancedAdaptivePadding(t,e){const i=this.calculatePolygonMetrics(t),n=this.calculateZunicRosinConvexity(t),r=this.calculateDiscreteRoughness(t),o=this.analyzeVertexDensity(t),a={fillEfficiency:.25,convexity:.2,roughness:.2,density:.15,aspectRatio:.1,compactness:.1},c={fillEfficiency:1-i.fillEfficiency,convexity:1-n,roughness:r.roughnessScore,density:1-o.uniformityScore,aspectRatio:Math.min(1,Math.abs(Math.log(i.aspectRatio))/2),compactness:1-i.compactness};c.fillEfficiency=Math.pow(c.fillEfficiency,1.5),c.roughness=Math.pow(c.roughness,1.2);let h=0;for(const[f,p]of Object.entries(a))h+=c[f]*p;r.maxCurvature>10&&(h=Math.max(h,.8)),(i.aspectRatio>3||i.aspectRatio<.33)&&(h=Math.max(h,.7));const d=1+h*.2,l=e*Math.min(d,1.3);return this.lastPaddingMetrics={scores:c,compositeScore:h,paddingMultiplier:d,finalPadding:l,metrics:{convexity:n,roughness:r,density:o}},l}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement)),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}updateBorderConfig(t){this.borderConfig={...this.borderConfig,...t},this.state.selectedHotspot&&this.hotspotHighlight&&this.highlightHotspotShape(this.state.selectedHotspot)}applyInitialStyles(){const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"none","-webkit-mask-image":this.createGradientMask(50,50,100,1),"mask-image":this.createGradientMask(50,50,100,1),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const d=o.radiusX*n,l=o.radiusY*n,p=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(m=>{const v=d*m.position,w=l*m.position,x=(v+w)/2;return`rgba(0,0,0,${m.opacity}) ${x}px`}).join(", ");return`radial-gradient(ellipse ${d}px ${l}px at ${t}% ${e}%, 
                rgba(0,0,0,0) 0px,
                ${p})`}const a=i*n,h=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(d=>{const l=a+a*.8*d.position;return`rgba(0,0,0,${d.opacity}) ${l}px`}).join(", ");return`radial-gradient(circle ${a*1.5}px at ${t}% ${e}%, 
            rgba(0,0,0,0) 0px,
            rgba(0,0,0,0) ${a}px,
            ${h})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e,i;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(e=this.state.selectedHotspot)==null?void 0:e.id}),((i=this.state.selectedHotspot)==null?void 0:i.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.highlightHotspotShape(t),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),setTimeout(()=>{this.trackFocusReference()},800),console.log("Starting animation..."),this.startAnimation()):(console.log("Deselecting hotspot"),this.highlightHotspotShape(null),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation())}highlightHotspotShape(t){if(this.hotspotHighlight&&(this.hotspotHighlight.remove(),this.hotspotHighlight=null),!t)return;const e=this.borderConfig.color,i=this.borderColors[e]||this.borderColors["soft-cyan"],n=this.borderConfig.opacity,r=this.borderConfig.strokeWidth,o=this.borderConfig.blurAmount,a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 999;
    `;const d=`M ${(t.shape==="polygon"?t.coordinates:t.coordinates[0]).map(([m,v])=>{const w=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(m,v)),x=this.viewer.viewport.viewportToWindowCoordinates(w);return`${x.x},${x.y}`}).join(" L ")} Z`,l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d",d),l.style.cssText=`
        fill: none;
        stroke: rgba(255, 255, 255, ${n*.3});
        stroke-width: ${r*2}px;
        filter: blur(${o*3}px);
    `,a.appendChild(l);const f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("d",d),f.style.cssText=`
        fill: none;
        stroke: rgba(${i.r}, ${i.g}, ${i.b}, ${n});
        stroke-width: ${r*1.25}px;
        filter: blur(${o}px);
    `,a.appendChild(f);const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",d),p.style.cssText=`
        fill: none;
        stroke: rgba(${i.r}, ${i.g}, ${i.b}, ${Math.min(1,n*1.3)});
        stroke-width: ${r*.6}px;
        opacity: 0.9;
    `,a.appendChild(p),this.viewer.container.appendChild(a),this.hotspotHighlight=a}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getPerformanceMode();let i="full",n;if(e==="reduced"){const m=t.shape==="polygon"?t.coordinates:t.coordinates[0],v=this.simplifyPolygon(m,.5),w={...t,coordinates:t.shape==="polygon"?v:[v]};n=this.calculateSpotlightGeometry(w),i="simplified"}else n=this.calculateSpotlightGeometry(t);const r=this.viewer.container.getBoundingClientRect(),o=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(n.center.x,n.center.y)),a=this.viewer.viewport.viewportToWindowCoordinates(o);console.log("Coordinate conversion debug:",{imageCenter:n.center,viewportPoint:{x:o.x,y:o.y},windowPoint:{x:a.x,y:a.y},viewerSize:{width:this.viewer.container.clientWidth,height:this.viewer.container.clientHeight}});const c=a.x/r.width*100,h=a.y/r.height*100;this.state.targetPosition={x:c,y:h};const d=this.viewer.world.getItemAt(0).getContentSize(),l=n.radius/d.x,f=this.viewer.viewport.getZoom(),p=l*r.width*f;if(this.state.targetRadius=Math.max(80,Math.min(300,p)),n.ellipseData){const m=n.ellipseData.radiusX/d.x*r.width*f,v=n.ellipseData.radiusY/d.y*r.height*f;this.useEllipse||(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:n.ellipseData.rotation}),this.ellipseData.targetRadiusX=m,this.ellipseData.targetRadiusY=v,this.ellipseData.rotation=n.ellipseData.rotation,this.useEllipse=!0}else this.useEllipse&&(this.ellipseData.targetRadiusX=this.state.targetRadius,this.ellipseData.targetRadiusY=this.state.targetRadius),this.useEllipse=!1;console.log("Spotlight position debug:",{hotspotId:t.id,hotspotCenter:n.center,windowPoint:a,viewportRect:{width:r.width,height:r.height},percentages:{x:c,y:h},radius:{geometric:n.radius,inViewport:l,inPixels:p,final:this.state.targetRadius},currentState:{x:this.state.currentPosition.x,y:this.state.currentPosition.y,radius:this.state.currentRadius},ellipseData:this.ellipseData,useEllipse:this.useEllipse,geometryQuality:i}),this.aspectRatio=n.aspectRatio,this.state.isAnimating||this.applySpotlightStyles(),this.hotspotHighlight&&this.state.selectedHotspot&&this.highlightHotspotShape(this.state.selectedHotspot)}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateMinimumEnclosingCircle(e);console.log("Welzl circle calculation:",{hotspotId:t.id,coordsCount:e.length,calculatedRadius:n.r,bounds:i,boundsMaxDimension:Math.max(i.width,i.height)}),n.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),n.r=Math.max(i.width,i.height)/2);const r=this.calculateAdaptivePadding(e,n.r),o=i.width/i.height;let a=null;return(o>1.5||o<.67)&&(a=this.calculateEllipseFromPolygon(e)),{center:{x:n.x,y:n.y},radius:n.r+r,aspectRatio:o,bounds:i,ellipseData:a,useEllipse:this.useEllipse}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let h=0,d=o-1;h<o;d=h++){const l=e[h][0],f=e[h][1],p=e[d][0],m=e[d][1],v=l*m-p*f;i+=v,n+=(l+p)*v,r+=(f+m)*v}i*=.5;const a=n/(6*i),c=r/(6*i);if(!isFinite(a)||!isFinite(c)){let h=0,d=0;return e.forEach(([l,f])=>{h+=l,d+=f}),{x:h/e.length,y:d/e.length}}return{x:a,y:c}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<2e3)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return console.log("calculateFocusScore: Missing data, returning 1.0"),1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new Ue.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y)),a=e.x-o.x,c=e.y-o.y,h=Math.sqrt(a*a+c*c),d=.01,l=.02;h<=d?r=1:h>=d+l?r=0:r=1-(h-d)/l}return r<.1?r:Math.min(n,r)}autoDeselect(){console.log("Auto-deselecting hotspot"),this.hotspotHighlight&&(this.hotspotHighlight.remove(),this.hotspotHighlight=null),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?(this.state.opacity+=e*i,this.state.opacity=Math.max(0,Math.min(1,this.state.opacity))):this.state.opacity=this.state.targetOpacity;const n=this.state.targetScale-this.state.scale;Math.abs(n)>.01?this.state.scale+=n*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const r=this.state.targetPosition.x-this.state.currentPosition.x,o=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(r)>.1||Math.abs(o)>.1?(this.state.currentPosition.x+=r*this.config.positionSpeed,this.state.currentPosition.y+=o*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const a=this.state.targetRadius-this.state.currentRadius;if(Math.abs(a)>1?this.state.currentRadius+=a*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const h=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,d=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(h)>1||Math.abs(d)>1?(this.ellipseData.radiusX+=h*this.config.radiusSpeed,this.ellipseData.radiusY+=d*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(r)<=.1&&Math.abs(o)<=.1&&Math.abs(a)<=1&&Math.abs(n)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}destroy(){this.hotspotHighlight&&this.hotspotHighlight.remove(),this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const c=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=c,t.style.webkitMaskImage=c,o++,requestAnimationFrame(a)}else{const c=performance.now()-r,h=o/c*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${h.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){if(!(!this.state.selectedHotspot||!this.useEllipse)&&window.performanceMonitor){const t=window.performanceMonitor.getMetrics();t.averageFPS<45&&this.useEllipse&&(console.warn("Disabling ellipses due to low FPS:",t.averageFPS),this.useEllipse=!1,this.config.useEllipse=!1,setTimeout(()=>{this.config.useEllipse=!0},1e4))}}}class Mt{static create(t){const e=this.detectBrowser();return console.log("Browser detection:",{isSafari:e.isSafari,isIOS:e.isIOS,isWebKit:e.isWebKit,userAgent:navigator.userAgent}),e.isSafari||e.isIOS?(console.log("Using SafariOverlayManager for WebKit-based browser"),new Xa(t)):(console.log("Using CSSOverlayManager (default)"),new Za(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r="WebkitAppearance"in document.documentElement.style&&!window.chrome,o=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:r,isIOSChrome:o,isWebKitBased:n||i||o}}static setPreference(t){return t==="css"||t==="safari"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css' or 'safari'.`),!1)}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t){const e=this.getCurrentType();return e==="safari"?(console.log("Creating SafariOverlayManager (forced)"),new Xa(t)):e==="css"?(console.log("Creating CSSOverlayManager (forced)"),new Za(t)):this.create(t)}}var gd=ie('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),vd=ie('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),yd=ie('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),wd=ie('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),_d=ie('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),Td=ie('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),Ed=ie('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),xd=ie("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),bd=ie('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+)">'),Sd=ie('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+)">'),Pd=ie("<input type=range class=volume-slider min=0 max=100>"),Cd=ie("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+: Skip</span><span>M: Mute</span><span>Esc: Minimize"),Ad=ie('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),Id=ie("<div>");const Ya=()=>gd(),Ka=()=>vd(),Rd=()=>yd(),Dd=()=>wd(),Md=()=>_d(),kd=()=>Td(),Od=()=>Ed();function Fd(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=me(!0),[r,o]=me(!1),[a,c]=me(0),[h,d]=me(0),[l,f]=me(0),[p,m]=me(80),[v,w]=me(!1),[x,R]=me(!1),[L,j]=me(!0),[G,J]=me(!1);Si(()=>{e()&&r()&&i()&&(J(!0),setTimeout(()=>J(!1),500))});const M=()=>window.innerWidth<=768;Si(()=>{t&&(t.onProgress=re=>{x()||(c(re.percent),d(re.current),f(re.duration))},t.onPlaybackStart=()=>{o(!0),i()&&L()?(n(!1),j(!1)):i()||j(!1)},t.onPlaybackEnd=()=>{o(!1),c(0),d(0)},t.setVolume(p()/100))}),Si(()=>{const re=ve=>{if(e()&&ve.target.tagName!=="INPUT")switch(ve.key){case" ":i()||(ve.preventDefault(),A());break;case"ArrowLeft":ve.shiftKey&&!i()&&(ve.preventDefault(),k());break;case"ArrowRight":ve.shiftKey&&!i()&&(ve.preventDefault(),C());break;case"m":case"M":i()||F();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",re),Vn(()=>window.removeEventListener("keydown",re))}),Si(()=>{if(t){const re=t.getState();o(re.isPlaying),w(re.isMuted)}});const A=()=>{!t||!e()||(r()?t.pause():t.resume())},C=()=>{t&&t.skip(15)},k=()=>{t&&t.skip(-15)},F=()=>{if(!t)return;const re=t.toggleMute();w(re)},O=re=>{if(!t)return;const ve=re.currentTarget.getBoundingClientRect(),we=(re.clientX-ve.left)/ve.width*100;t.seekToPercent(we),c(we)},D=re=>{if(!x())return;const ve=re.currentTarget.getBoundingClientRect(),we=Math.max(0,Math.min(100,(re.clientX-ve.left)/ve.width*100));c(we)},z=()=>{x()&&t&&(t.seekToPercent(a()),R(!1))},xe=re=>{const ve=parseInt(re.target.value);m(ve),t&&(t.setVolume(ve/100),ve>0&&v()&&(t.toggleMute(),w(!1)))},Se=re=>{if(!re||isNaN(re))return"0:00";const ve=Math.floor(re/60),we=Math.floor(re%60);return`${ve}:${we.toString().padStart(2,"0")}`},Me=()=>{const re=e();return re?re.narrationTitle||`Hotspot ${re.id}`:""};return fe(ke,{get when(){return e()},get children(){var re=Id();return re.addEventListener("mouseleave",z),re.$$mouseup=z,se(re,fe(ke,{get when(){return i()},get children(){var ve=xd(),we=ve.firstChild,tt=we.nextSibling,Fe=tt.firstChild;return we.$$click=()=>{r()?A():n(!1)},se(we,(()=>{var te=pt(()=>!!r());return()=>te()?fe(Ka,{}):fe(Ya,{})})()),se(Fe,Me),st(te=>{var Ge=`btn-play-mini ${r()?"playing":""} ${G()?"changing":""}`,ze=r()?"Pause":"Play";return Ge!==te.e&&Zi(we,te.e=Ge),ze!==te.t&&Nt(we,"title",te.t=ze),te},{e:void 0,t:void 0}),ve}}),null),se(re,fe(ke,{get when(){return!i()},get children(){var ve=Ad(),we=ve.firstChild,tt=we.firstChild,Fe=tt.nextSibling,te=we.nextSibling,Ge=te.firstChild,ze=Ge.nextSibling,Ct=ze.firstChild,it=Ct.firstChild,It=it.nextSibling,Gt=ze.nextSibling,Et=te.nextSibling,lt=Et.firstChild,ct=lt.firstChild,xt=lt.nextSibling,yt=xt.firstChild;return se(tt,Me),Fe.$$click=()=>n(!0),se(Fe,fe(Od,{})),se(Ge,()=>Se(h())),ze.$$mousemove=D,ze.$$mousedown=()=>R(!0),ze.$$click=O,se(Gt,()=>Se(l())),se(lt,fe(ke,{get when(){return!M()},get children(){var Pe=bd();return Pe.$$click=k,se(Pe,fe(Rd,{})),Pe}}),ct),ct.$$click=A,se(ct,fe(ke,{get when(){return!r()},get children(){return fe(Ya,{})}}),null),se(ct,fe(ke,{get when(){return r()},get children(){return fe(Ka,{})}}),null),se(lt,fe(ke,{get when(){return!M()},get children(){var Pe=Sd();return Pe.$$click=C,se(Pe,fe(Dd,{})),Pe}}),null),yt.$$click=F,se(yt,fe(ke,{get when(){return pt(()=>!v())()&&p()>0},get children(){return fe(Md,{})}}),null),se(yt,fe(ke,{get when(){return v()||p()===0},get children(){return fe(kd,{})}}),null),se(xt,fe(ke,{get when(){return!M()},get children(){var Pe=Pd();return Pe.$$input=xe,st(()=>Nt(Pe,"title",`Volume: ${p()}%`)),st(()=>Pe.value=p()),Pe}}),null),se(ve,fe(ke,{when:!1,get children(){return Cd()}}),null),st(Pe=>{var ht=`${a()}%`,y=`${a()}%`,b=`btn-play ${r()?"playing":""}`,V=r()?"Pause (Space)":"Play (Space)",B=v()?"Unmute (M)":"Mute (M)";return ht!==Pe.e&&((Pe.e=ht)!=null?it.style.setProperty("width",ht):it.style.removeProperty("width")),y!==Pe.t&&((Pe.t=y)!=null?It.style.setProperty("left",y):It.style.removeProperty("left")),b!==Pe.a&&Zi(ct,Pe.a=b),V!==Pe.o&&Nt(ct,"title",Pe.o=V),B!==Pe.i&&Nt(yt,"title",Pe.i=B),Pe},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ve}}),null),st(()=>Zi(re,`audio-player ${i()?"minimized":""} ${M()?"mobile":"desktop"}`)),re}})}rn(["mouseup","click","mousedown","mousemove","input"]);var Ld=ie('<div><button><svg class=media-button-icon width=16 height=16 viewBox="0 0 16 16"fill=none><path d="M2 4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4Z"stroke=currentColor stroke-width=1.5></path><circle cx=8 cy=8 r=2.5 stroke=currentColor stroke-width=1.5></circle><path d="M2 11L5 8L7 10L10 7L14 11"stroke=currentColor stroke-width=1.5 stroke-linecap=round stroke-linejoin=round></path></svg><span class=media-button-text>');function Vd(s){const{hotspotId:t,onClick:e,isVisible:i=!0,position:n={x:0,y:0},isMobile:r=!1}=s,[o,a]=me(!1),[c,h]=me(!1),d=()=>"View Image",l=f=>{f.stopPropagation(),h(!0),e&&e(t),setTimeout(()=>h(!1),300)};return fe(ke,{when:i,get children(){var f=Ld(),p=f.firstChild,m=p.firstChild,v=m.nextSibling;return Zi(f,`media-button-container ${r?"mobile":"desktop"}`),p.addEventListener("mouseleave",()=>a(!1)),p.addEventListener("mouseenter",()=>a(!0)),p.$$click=l,se(v,d),st(w=>{var x=`media-button ${o()?"hovered":""} ${c()?"clicked":""}`,R=d();return x!==w.e&&Zi(p,w.e=x),R!==w.t&&Nt(p,"title",w.t=R),w},{e:void 0,t:void 0}),f}})}rn(["click"]);var Bd=ie("<h3 class=modal-title>"),Nd=ie('<div class=modal-overlay-backdrop><div><button class=modal-close-button title="Close (Esc)"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M18 6L6 18M6 6l12 12"stroke=currentColor stroke-width=2 stroke-linecap=round></path></svg></button><div class=modal-image-container><img class=modal-image loading=lazy>',!0,!1,!1);function Hd(s){const{imageUrl:t,isVisible:e,onClose:i,hotspotTitle:n}=s,r=o=>{o.target===o.currentTarget&&i()};return fe(ke,{when:e,get children(){var o=Nd(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=h.firstChild;return o.$$click=r,_c(c,"click",i),se(a,fe(ke,{when:n,get children(){var l=Bd();return se(l,n),l}}),h),Nt(d,"src",t),Nt(d,"alt",n||"Hotspot image"),st(()=>Zi(a,`modal-overlay-content ${s.isLoading?"loading":""} ${s.hasError?"error":""}`)),o}})}rn(["click"]);function zd(s){const{imageOverlayManager:t,currentHotspot:e}=s,[i,n]=me(!1),[r,o]=me(null),[a,c]=me("modal"),[h,d]=me(!1),[l,f]=me(!1);let p=null,m=null;go(()=>{t&&(p=(w,x)=>{console.log("Opening overlay for:",w);const R=x.imageUrls[0];R&&(o(R),c(x.displayMode||"modal"),d(!0),f(!1),n(!0),t.getImage(R)?d(!1):t.loadImage(R,w).then(()=>d(!1)).catch(()=>{f(!0),d(!1)}))},m=()=>{n(!1),o(null),t.closeOverlay()},t.onOverlayOpen=p,t.onOverlayClose=m,Vn(()=>{t&&(t.onOverlayOpen=null,t.onOverlayClose=null)}))}),Si(()=>{if(!i())return;document.body.classList.add("modal-open");const w=x=>{x.key==="Escape"&&v()};window.addEventListener("keydown",w),Vn(()=>{window.removeEventListener("keydown",w),document.body.classList.remove("modal-open")})});const v=()=>{m&&m()};return fe(ke,{get when(){return pt(()=>a()==="modal")()&&i()},get children(){return fe(Hd,{get imageUrl(){return r()},isVisible:!0,onClose:v,get hotspotTitle(){var w;return((w=e==null?void 0:e())==null?void 0:w.title)||"Image"},get isLoading(){return h()},get hasError(){return l()}})}})}const he={viewer:{imageLoaderLimit:4,maxImageCacheCount:2e3,minPixelRatio:.5,minZoomImageRatio:.5,smoothTileEdgesMinZoom:3,alwaysBlend:!0,immediateRender:!1,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:1,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:null,animationTime:.3,springStiffness:6,blendTime:.18,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.2,zoomPerClick:2,minZoomLevel:.5,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:6,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:6,tileRetryMax:1,tileRetryDelay:100,minimumPixelsPerTile:12,compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},hotspots:{batchSize:50,visibilityCheckInterval:100,renderDebounceTime:16,maxVisibleHotspots:100,minZoomForHotspots:3},viewport:{updateDebounce:8},memory:{maxCachedImages:300,criticalMemoryThreshold:200},network:{maxConcurrentRequests:6},mobile:{maxImageCacheCount:50,imageLoaderLimit:2,animationTime:.2,springStiffness:12,immediateRender:!1,blendTime:.1,maxTilesPerFrame:3,minPixelRatio:.5,minZoomImageRatio:.9,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!0,preserveImageSizeOnResize:!1,maxZoomPixelRatio:2},debug:{warnThreshold:{fps:45}}},Ud=()=>{var e;const s=navigator.userAgent.toLowerCase(),t=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(s),isChrome:/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),isFirefox:/firefox|fxios/i.test(s),isEdge:/edge|edg/i.test(s),isIOS:/ipad|iphone|ipod/.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(s),isMac:/mac/.test(t),isWindows:/win/.test(t),isMobile:/android|iphone|ipad|ipod/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((e=navigator.connection)==null?void 0:e.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},jd=()=>{const s=Ud();return(s.isSafari||s.isIOS)&&(he.viewer.drawer="canvas",he.viewer.maxImageCacheCount=200,console.log("Safari/iOS detected - forcing canvas drawer and limiting cache")),s.isAndroid&&(he.viewer.drawer="canvas",console.log("Android detected - forcing canvas drawer for compatibility")),s.isMobile&&(Object.assign(he.viewer,{drawer:"canvas",imageLoaderLimit:he.mobile.imageLoaderLimit,maxImageCacheCount:he.mobile.maxImageCacheCount,animationTime:he.mobile.animationTime,springStiffness:he.mobile.springStiffness,immediateRender:he.mobile.immediateRender,blendTime:he.mobile.blendTime,smoothImageZoom:!1,maxTilesPerFrame:he.mobile.maxTilesPerFrame,visibilityRatio:he.mobile.visibilityRatio,minPixelRatio:he.mobile.minPixelRatio,minZoomImageRatio:he.mobile.minZoomImageRatio,smoothTileEdgesMinZoom:he.mobile.smoothTileEdgesMinZoom,alwaysBlend:he.mobile.alwaysBlend,preserveImageSizeOnResize:he.mobile.preserveImageSizeOnResize,maxZoomPixelRatio:he.mobile.maxZoomPixelRatio,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),he.hotspots.batchSize=25,he.hotspots.maxVisibleHotspots=50,he.hotspots.renderDebounceTime=32,he.memory.maxCachedImages=50,console.log("Mobile device detected - applied aggressive performance optimizations")),s.isLowEndDevice&&(he.viewer.animationTime=.2,he.viewer.springStiffness=12,he.viewer.maxImageCacheCount=Math.min(150,he.viewer.maxImageCacheCount),he.viewer.imageLoaderLimit=2,he.viewer.maxTilesPerFrame=2,he.memory.maxCachedImages=150,he.network.maxConcurrentRequests=3,he.hotspots.maxVisibleHotspots=50,he.viewer.minPixelRatio=.7,console.log("Low-end device detected - reduced resource usage but maintained quality settings")),s.isHighEndDevice&&!s.isMobile&&(he.viewer.maxImageCacheCount=800,he.viewer.imageLoaderLimit=8,he.viewer.maxTilesPerFrame=6,he.memory.maxCachedImages=500,he.network.maxConcurrentRequests=8,he.viewer.minPixelRatio=.4,he.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - increased resource limits and quality")),s.isHighDPI&&!s.isMobile&&(he.viewer.minPixelRatio=Math.min(.5,he.viewer.minPixelRatio),he.viewer.maxZoomPixelRatio=Math.max(4,s.pixelRatio*2)),(s.connectionType==="slow-2g"||s.connectionType==="2g")&&(he.viewer.imageLoaderLimit=1,he.network.maxConcurrentRequests=2,he.viewer.timeout=12e4,console.log("Slow connection detected - reduced concurrent requests")),s},Fs=jd();function qd(s,t){const e=he;if(s<20&&s>0)return e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.animationTime=.1,e.viewer.springStiffness=15,e.viewer.immediateRender=!0,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=50,e.viewer.minPixelRatio=.8,console.error("Emergency performance mode activated"),"emergency";if(s<30&&s>0)return e.viewer.imageLoaderLimit=2,e.viewer.maxTilesPerFrame=2,e.viewer.animationTime=.2,e.viewer.springStiffness=12,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=100,e.viewer.minPixelRatio=.7,console.warn("Critical performance mode activated"),"critical";if(s<45&&s>0)return e.viewer.imageLoaderLimit=Math.max(3,e.viewer.imageLoaderLimit-1),e.viewer.maxTilesPerFrame=Math.max(3,e.viewer.maxTilesPerFrame-1),"reduced";if(s>55){const i=Fs.isHighEndDevice?8:Fs.isMobile?2:6;return e.viewer.imageLoaderLimit<i&&(e.viewer.imageLoaderLimit=Math.min(i,e.viewer.imageLoaderLimit+1)),e.viewer.maxTilesPerFrame<4&&(e.viewer.maxTilesPerFrame=Math.min(4,e.viewer.maxTilesPerFrame+1)),e.viewer.minPixelRatio=Fs.isMobile?.8:.5,"normal"}return t>e.memory.criticalMemoryThreshold?(e.viewer.maxImageCacheCount=Math.max(50,Math.floor(e.viewer.maxImageCacheCount*.5)),console.warn(`High memory usage: ${t}MB - Reduced cache to ${e.viewer.maxImageCacheCount}`),"memory-limited"):"normal"}const Wd=(s,t,e,i,n=null)=>(i&&(s.animationTime=.2,s.springStiffness=12,s.blendTime=0,s.immediateRender=!0,s.imageLoaderLimit=2,s.maxImageCacheCount=50,s.visibilityRatio=1,s.maxTilesPerFrame=2),{tileSources:n||t,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:e,imageSmoothingEnabled:s.imageSmoothingEnabled,smoothTileEdgesMinZoom:s.smoothTileEdgesMinZoom,alwaysBlend:s.alwaysBlend,placeholderFillStyle:s.placeholderFillStyle,opacity:1,preload:s.preload,compositeOperation:s.compositeOperation,...s.drawer==="webgl"?{webglOptions:s.webglOptions}:{},immediateRender:s.immediateRender,imageLoaderLimit:s.imageLoaderLimit,maxImageCacheCount:s.maxImageCacheCount,timeout:s.timeout,loadTilesWithAjax:s.loadTilesWithAjax,ajaxHeaders:s.ajaxHeaders,visibilityRatio:s.visibilityRatio,minPixelRatio:s.minPixelRatio,defaultZoomLevel:s.defaultZoomLevel,minZoomLevel:s.minZoomLevel,maxZoomPixelRatio:s.maxZoomPixelRatio,constrainDuringPan:s.constrainDuringPan,wrapHorizontal:s.wrapHorizontal,wrapVertical:s.wrapVertical,animationTime:s.animationTime,springStiffness:s.springStiffness,blendTime:s.blendTime,zoomPerScroll:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:s.flickEnabled,flickMinSpeed:s.flickMinSpeed,flickMomentum:s.flickMomentum,pinchToZoom:!0,dragToPan:!0},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:s.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:s.preserveImageSizeOnResize,maxTilesPerFrame:s.maxTilesPerFrame,smoothImageZoom:s.smoothImageZoom,subPixelRendering:!1,minimumPixelsPerTile:s.minimumPixelsPerTile||12}),Gd=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream;if(/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||t||e)return console.log("Mobile/Safari detected - forcing canvas drawer for performance"),"canvas";const n=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),r=/firefox|fxios/i.test(s);return n||r?(console.log("Desktop Chrome/Firefox detected - using webgl drawer"),"webgl"):(console.log("Default browser detected - using canvas drawer"),"canvas")},Ne=()=>{const s=navigator.userAgent.toLowerCase();if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(s))return!0;const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<=768;return e&&i},Zd=(s,t,e)=>{let i;if(s.coordinates){let x=1/0,R=1/0,L=-1/0,j=-1/0;(J=>{Array.isArray(J[0])&&typeof J[0][0]=="number"?J.forEach(([M,A])=>{x=Math.min(x,M),R=Math.min(R,A),L=Math.max(L,M),j=Math.max(j,A)}):J.forEach(M=>{M.forEach(([A,C])=>{x=Math.min(x,A),R=Math.min(R,C),L=Math.max(L,A),j=Math.max(j,C)})})})(s.coordinates),i={minX:x,minY:R,maxX:L,maxY:j}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new Ue.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new Ue.Point(i.maxX,i.maxY)),a=o.x-r.x,c=o.y-r.y,h=r.x+a/2,d=r.y+c/2,l=t.viewport.getAspectRatio(),f=a/c,p=e?.85:.8;let m,v;f>l?(m=a/p,v=m/l):(v=c/p,m=v*l);const w=new Ue.Rect(h-m/2,d-v/2,m,v);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:h,y:d},dimensions:{width:m,height:v},aspectRatios:{hotspot:f.toFixed(2),viewport:l.toFixed(2)},paddingFactor:p,zoomBounds:w}),w};var Xd=ie('<img class=preview-image alt="Loading preview">'),Yd=ie("<div class=viewer-loading><p>Loading high-resolution artwork..."),Kd=ie('<div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2);"><div style=font-size:11px;margin-bottom:5px;>Border Style: <strong></strong></div><button style="width:100%;padding:6px;font-size:11px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:3px;cursor:pointer;color:white;">Next Border Style </button><div style=font-size:10px;opacity:0.7;margin-top:5px;>Click to cycle through <!> styles'),Qd=ie('<div class=debug-info><div>Hovered: </div><div>Selected: </div><div>Type: </div><div>Total hotspots: </div><div>Drawer: </div><div class=zoom-speed-control><label>Hotspot Zoom Speed: <!>x</label><input type=range min=0.5 max=2.5 step=0.1 style=width:100%;margin-top:5px;><div style=font-size:10px;opacity:0.7;margin-top:2px;>Hotspot zoom: <!>s</div></div><div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2);"><div>Overlay Mode: </div><button style="margin-top:5px;padding:4px 8px;font-size:11px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:3px;cursor:pointer;">Switch to '),Jd=ie("<div class=expand-button-container><button class=expand-button><span class=expand-icon></span><span>Full View"),$d=ie("<div class=fullscreen-button-container><button class=fullscreen-button>"),ef=ie("<div class=viewer-container><div class=openseadragon-viewer>"),tf=ie('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3">'),nf=ie('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">');let Hi=[];function rf(s){let t,e=null,i={};const[n,r]=me(!0),[o,a]=me(null),[c,h]=me(null),[d,l]=me(!1),[f,p]=me(!1),[m,v]=me(!1),[w,x]=me(!1),[R,L]=me(!1),[j,G]=me(!1),[J,M]=me(null),[A,C]=me(!1),[k,F]=me({x:0,y:0}),[O,D]=me(null),[z,xe]=me({}),[Se,Me]=me(parseInt(localStorage.getItem("debugLevel")??(Ne()?"0":"1"))),[re,ve]=me(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[we,tt]=me(0),Fe=[{name:"Electric Yellow",color:"electric-yellow",opacity:.6,strokeWidth:2,blurAmount:3},{name:"Vibrant Orange",color:"vibrant-orange",opacity:.5,strokeWidth:2.5,blurAmount:2},{name:"Pure Red",color:"pure-red",opacity:.4,strokeWidth:2,blurAmount:2},{name:"Soft Cyan",color:"soft-cyan",opacity:.35,strokeWidth:2,blurAmount:2},{name:"Muted Blue",color:"muted-blue",opacity:.4,strokeWidth:1.5,blurAmount:2},{name:"Warm Gray",color:"warm-gray",opacity:.5,strokeWidth:1.5,blurAmount:1}],te=()=>{i.handleKeyPress&&window.removeEventListener("keydown",i.handleKeyPress),Object.values(i).forEach(b=>{typeof b=="number"&&clearInterval(b)}),z().resizeObserver&&t&&z().resizeObserver.disconnect(),Object.values(z()).forEach(b=>{b&&typeof b.destroy=="function"&&b.destroy()}),e&&e.destroy(),["performanceMonitor","viewer","tileOptimizer"].forEach(b=>{(window[b]===z()[b]||window[b]===e)&&delete window[b]})};go(async()=>{var ue,le,$,Ee,E;try{Hi=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${Hi.length} hotspots`)}catch(T){console.error("Failed to load hotspots:",T),Hi=[]}const b=new Image;b.onload=()=>p(!0),b.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`;const V=he.viewer;`${s.artworkId}${s.artworkId}`;const B={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${s.artworkId}_1024/${s.artworkId}_files/`,Format:"jpg",Overlap:"2",TileSize:"1024",Size:{Width:"11244",Height:"6543"}},minLevel:8,maxLevel:14},H=Ne(),Y=Gd(),U=Wd(V,B,Y,H,B);e=Ue({element:t,...U,updatePixelDensityRatio:!1});const Z={spatialIndex:new hd,viewportManager:new md(e),audioEngine:new Qu,performanceMonitor:new td(e),renderOptimizer:new id(e),tileOptimizer:new fd(e),memoryManager:new $u(e),tileCleanupManager:new ud(e),imageOverlayManager:new Ju,overlayManager:Mt.createWithOverride(e)};console.log("Creating overlay manager..."),console.log("Overlay manager type:",(ue=Z.overlayManager)==null?void 0:ue.constructor.name),console.log("Overlay manager instance:",Z.overlayManager),Z.tileOptimizer.state.isActive=!1,setTimeout(()=>{Z.tileOptimizer.state.isActive=!0},1e3),xe(Z),console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!Z.overlayManager),console.log("Does it have initialize method?",typeof((le=Z.overlayManager)==null?void 0:le.initialize)),Z.overlayManager.initialize(),console.log("Overlay manager initialized"),console.log("Is initialized flag:",($=Z.overlayManager)==null?void 0:$.isInitialized),console.log("Overlay element created?",!!((Ee=Z.overlayManager)!=null&&Ee.overlayElement)),window.overlayManager=Z.overlayManager,console.log("Overlay manager set on window:",(E=window.overlayManager)==null?void 0:E.constructor.name),window.audioEngine=Z.audioEngine,Z.audioEngine.onPlaybackEnd=T=>{console.log(`Finished playing audio for hotspot ${T}`)},Z.spatialIndex.loadHotspots(Hi),Z.imageOverlayManager.loadHotspots(Hi),window.viewer=e,window.performanceMonitor=Z.performanceMonitor,window.tileOptimizer=Z.tileOptimizer,window.tileCleanupManager=Z.tileCleanupManager,Z.performanceMonitor.start(),Z.memoryManager.start(),Z.tileOptimizer.start(),Z.tileCleanupManager.start(),Se()>=1&&Z.performanceMonitor.enableDebugOverlay(),Gt(),It(),Et(),lt(),document.addEventListener("fullscreenchange",()=>{x(!!document.fullscreenElement)}),Vn(te)});const Ge=()=>{let b=null,V=null,B="idle",H=0,Y=null;e.addHandler("zoom",U=>{const Z=e.viewport.getZoom();if(H++,Y&&clearTimeout(Y),!V||Math.abs(Z-V)>.01){const ue=V?Z-V:0,le=Math.abs(ue);B==="idle"?(B="accelerating",b=performance.now(),e.viewport.centerSpringX.animationTime=.4,e.viewport.centerSpringY.animationTime=.4,e.viewport.zoomSpring.animationTime=.4,e.imageLoader&&H>3&&(e.imageLoader.jobLimit=Math.max(1,e.imageLoader.jobLimit-1))):B==="accelerating"&&H>5&&(B="cruising",e.viewport.zoomSpring.animationTime=.2,e.imageLoader&&(e.imageLoader.jobLimit=1,le>.1&&e.imageLoader.clear())),V=Z}Y=setTimeout(()=>{B!=="idle"&&(B="decelerating",e.viewport.centerSpringX.animationTime=.3,e.viewport.centerSpringY.animationTime=.3,e.viewport.zoomSpring.animationTime=.3,e.imageLoader&&(e.imageLoader.jobLimit=3),setTimeout(()=>{B="idle",H=0,e.imageLoader&&(e.imageLoader.jobLimit=he.viewer.imageLoaderLimit),e.forceRedraw(),b&&(performance.now()-b,b=null)},200))},100)})},ze=()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(b=>clearTimeout(b)),window.expandToFullViewTimeouts=[])},Ct=()=>{let b=1,V=null;e.addHandler("zoom",B=>{const H=e.viewport.getZoom();B.speed,V&&clearTimeout(V);let Y=1;H<2?Y=.6:H<3.5?Y=.8:Y=1;const U=Y-b;if(b+=U*.3,e.drawer){e.drawer.imageSmoothingEnabled=b>.7;const Z=Math.floor((1-b)*3);e.skipTileRatio=Z}V=setTimeout(()=>{const Z=setInterval(()=>{b+=.1,b>=1&&(b=1,e.drawer.imageSmoothingEnabled=!0,e.skipTileRatio=0,e.forceRedraw(),clearInterval(Z))},50)},200)})},it=b=>{"requestIdleCallback"in window?requestIdleCallback(b,{timeout:200}):setTimeout(b,50)},It=()=>{const b={centerX:e.viewport.centerSpringX.springStiffness,centerY:e.viewport.centerSpringY.springStiffness,zoom:e.viewport.zoomSpring.springStiffness};e.addHandler("zoom-click",V=>{if(V.quick)return;const B=e.viewport.getZoom(),H=V.zoom,Y=Math.abs(Math.log2(H)-Math.log2(B)),U=Math.min(.8,.3+Y*.15);e.viewport.zoomSpring.animationTime=U;const Z=Math.max(4,8-Y);e.viewport.zoomSpring.springStiffness=Z,setTimeout(()=>{e.viewport.zoomSpring.animationTime=he.viewer.animationTime,e.viewport.zoomSpring.springStiffness=b.zoom},U*1e3+100)})},Gt=()=>{if(e.drawer&&e.drawer.getType&&e.drawer.getType()!=="webgl"){let B=0;e.addHandler("tile-drawing",H=>{const Y=e.viewport.getZoom();H.tile;const U=H.tile.size,Z=H.tile.level,ue=e.skipTileRatio||0;if(ue>0&&(B++,B%(ue+1)!==0)){H.preventDefaultAction=!0;return}if(Y<2&&U*Y<24){H.preventDefaultAction=!0;return}const le=Math.floor(Math.log2(Y));Math.abs(Z-le)>2&&e.skipTileRatio>0&&(H.preventDefaultAction=!0)})}e.addHandler("open",()=>{if(Ne()){let Y=0;const U=33;e.addHandler("update-viewport",Z=>{const ue=performance.now();if(e.isAnimating()&&ue-Y<U){Z.preventDefaultAction=!0;return}Y=ue})}e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,Ne()&&(e.viewport.minZoomLevel=.5,e.viewport.minZoomImageRatio=.3),Ct(),Ge(),pd(Ue),e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,console.log("Viewer ready - initializing systems"),console.log("Using drawer:",e.drawer.getType?e.drawer.getType():"canvas"),l(!0),r(!1);const H=e.world.getItemAt(0).getBounds();e.viewport.fitBounds(H,!0),e.viewport.applyConstraints(!0),Ne()&&setTimeout(()=>{const Y=e.world.getItemAt(0);if(Y){const U=Y.getBounds();e.viewport.fitBoundsWithConstraints(U,!1)}},100),e.viewport.getHomeBounds(),setTimeout(()=>ct(),100)}),e.addHandler("zoom",()=>{z().tileCleanupManager&&z().tileCleanupManager.setPressure("normal"),R()&&e.imageLoader&&e.imageLoader.clear()}),e.addHandler("pan",()=>{z().tileCleanupManager&&z().tileCleanupManager.setPressure("normal")}),e.addHandler("tile-loaded",B=>{var H;if(B.tile&&z().tileOptimizer){const Y=B.tile.loadTime||((H=B.tiledImage)==null?void 0:H.lastResetTime)||100;z().tileOptimizer.trackLoadTime(Y);const U=`${B.tile.level||0}_${B.tile.x||0}_${B.tile.y||0}`;z().tileOptimizer.loadingTiles.delete(U)}}),e.addHandler("animation",()=>{if(z().performanceMonitor){const B=z().performanceMonitor.getMetrics();if(B.averageFPS<he.debug.warnThreshold.fps){const H=qd(B.averageFPS,B.memoryUsage);if(z().tileCleanupManager){const Y={emergency:"critical",critical:"critical",reduced:"high","memory-limited":"high",normal:"normal"};z().tileCleanupManager.setPressure(Y[H]||"normal")}}}}),e.addHandler("animation-finish",()=>{console.log("animation-finish fired",{isZoomingToHotspot:R(),isExpandingToFullView:j()}),R()&&(console.log("animation-finish: Setting isZoomingToHotspot to false"),L(!1),z().renderer&&(console.log("animation-finish: Calling resumeUpdates"),z().renderer.resumeUpdates(),z().renderer.updateVisibility()),z().renderOptimizer&&z().renderOptimizer.endCinematicZoom())}),e.addHandler("animation-start",B=>{R()&&z().tileCleanupManager&&z().tileCleanupManager.pauseCleanup(3e3)});const b=()=>{i.updateTimer&&clearTimeout(i.updateTimer),i.updateTimer=setTimeout(()=>{it(()=>{const{viewportManager:B,spatialIndex:H,audioEngine:Y}=z();if(!B||!H||!Y)return;const U=B.getCurrentViewport(),Z=H.queryViewport(U.bounds,U.zoom);Y.preloadHotspots(Z)})},he.viewport.updateDebounce)};e.addHandler("viewport-change",b);let V=!1;e.addHandler("animation-start",()=>{Ne()&&(R()||j())&&(V=!0,e.removeHandler("viewport-change",b))}),e.addHandler("animation-finish",()=>{V&&(V=!1,e.addHandler("viewport-change",b),setTimeout(b,100))}),e.addHandler("canvas-click",B=>{!B.preventDefaultAction&&z().renderer&&B.quick&&z().renderer.selectedHotspot&&(z().renderer.selectedHotspot=null,h(null),z().overlayManager&&z().overlayManager.selectHotspot(null))})},Et=()=>{const b={"+":()=>e.viewport.zoomBy(he.viewer.zoomPerScroll),"=":()=>e.viewport.zoomBy(he.viewer.zoomPerScroll),"-":()=>e.viewport.zoomBy(1/he.viewer.zoomPerScroll),_:()=>e.viewport.zoomBy(1/he.viewer.zoomPerScroll),0:()=>ht(),f:()=>e.viewport.fitBounds(e.world.getHomeBounds()),F:()=>e.viewport.fitBounds(e.world.getHomeBounds()),c:()=>{if(Ne())return;const B=Se()===0?1:0;Me(B),localStorage.setItem("debugLevel",B.toString()),z().performanceMonitor&&(B===1?z().performanceMonitor.enableDebugOverlay():z().performanceMonitor.disableDebugOverlay()),z().renderer&&z().renderer.setDebugMode(B===1),console.log(`Debug mode: ${B===1?"ON":"OFF"}`)}};i.handleKeyPress=V=>{const B=document.activeElement;if(B&&(B.tagName==="INPUT"||B.tagName==="TEXTAREA"||B.contentEditable==="true"))return;const H=b[V.key];H&&e&&(V.preventDefault(),H(),e.viewport.applyConstraints())},window.addEventListener("keydown",i.handleKeyPress)},lt=()=>{const b=new ResizeObserver(V=>{if(!(!(e!=null&&e.viewport)||!e.isOpen()))for(let B of V){const{width:H,height:Y}=B.contentRect;H>0&&Y>0&&requestAnimationFrame(()=>{try{e&&e.viewport&&e.isOpen()&&(e.viewport.resize(),e.viewport.applyConstraints(),e.forceRedraw())}catch(U){U.message&&!U.message.includes("undefined")&&console.warn("Resize error:",U)}})}});b.observe(t),xe(V=>({...V,resizeObserver:b}))},ct=()=>{if(!e)return;const b=new ed({viewer:e,spatialIndex:z().spatialIndex,onHotspotHover:a,onHotspotClick:yt,visibilityCheckInterval:he.hotspots.visibilityCheckInterval,batchSize:he.hotspots.batchSize,renderDebounceTime:he.hotspots.renderDebounceTime,maxVisibleHotspots:he.hotspots.maxVisibleHotspots,minZoomForHotspots:he.hotspots.minZoomForHotspots,debugMode:Se()===2});xe(V=>({...V,renderer:b})),console.log("Using NativeHotspotRenderer for all platforms")},xt=async b=>{if(console.log("zoomToHotspot called",{hotspotId:b.id,isZoomingToHotspot:R(),viewer:!!e}),!e||R()||j()){console.log("zoomToHotspot BLOCKED",{noViewer:!e,isZoomingToHotspot:R(),isExpandingToFullView:j()});return}const V=Zd(b,e,Ne());if(!V)return;const B=Ne()?2.8:1.8,H=Ne()?1.5:B*re(),Y=4/re();let U;L(!0),console.log("Starting cinematic zoom to hotspot:",b.id),U=setTimeout(()=>{console.log("Safety timeout: forcing isZoomingToHotspot to false"),L(!1),z().renderer&&z().renderer.resumeUpdates()},H*1e3+500);const Z={animationTime:e.animationTime,springStiffness:e.springStiffness};if(z().tileCleanupManager&&z().tileCleanupManager.pauseCleanup(H*1e3+500),e.imageLoader&&e.imageLoader.clear(),z().renderOptimizer&&z().renderOptimizer.startCinematicZoom(),z().performanceMonitor&&Ne()&&z().performanceMonitor.pauseMonitoring(),z().renderer&&(Ne()||z().renderer.pauseUpdates(),Ne()&&z().renderer.hideOverlay()),Ne()){console.log("DEBUG: Mobile animation with preload");try{let I;if(e.viewport.getZoomForBounds)I=e.viewport.getZoomForBounds(V);else{const Te=e.viewport.getBounds(),ae=Te.width/V.width,_e=Te.height/V.height;I=Math.min(ae,_e)*e.viewport.getZoom()}const q=V.getCenter();console.log("DEBUG: Mobile animation params",{currentZoom:e.viewport.getZoom(),targetZoom:I,center:q});const Q=e.viewport.getZoom(),ce=5;if(I/Q>ce){console.log("DEBUG: Large zoom jump detected, using stepped approach");const Te=Q*ce;e.viewport.zoomTo(Te,q,!0),e.forceRedraw(),setTimeout(()=>{e.viewport.panTo(q),e.viewport.zoomTo(I);let ae=0;const _e=setInterval(()=>{e.forceRedraw(),ae++,ae>10&&clearInterval(_e)},100)},200)}else{e.viewport.centerSpringX.animationTime=H,e.viewport.centerSpringY.animationTime=H,e.viewport.zoomSpring.animationTime=H;const Te=new Ue.Point(q.x,q.y);e.viewport.panTo(Te),e.viewport.zoomTo(I);const ae=setInterval(()=>{e.forceRedraw()},100);setTimeout(()=>{clearInterval(ae)},H*1e3+200)}}catch(I){console.error("Mobile animation error:",I),e.viewport.fitBounds(V,!1)}setTimeout(()=>{v(!0),console.log("Full View button should now be visible on mobile")},H*1e3+200);return}e.animationTime=H,e.springStiffness=Y,e.viewport.centerSpringX.animationTime=H,e.viewport.centerSpringY.animationTime=H,e.viewport.zoomSpring.animationTime=H,e.viewport.centerSpringX.springStiffness=Y,e.viewport.centerSpringY.springStiffness=Y,e.viewport.zoomSpring.springStiffness=Y,e.viewport.applyConstraints(),console.log("Springs configured with animTime:",H),z().viewportManager&&z().viewportManager.setCacheEnabled(!1);const ue=e.viewport.getBounds();console.log("DEBUG: Manual zoom attempt",{from:ue,to:V});const le=e.viewport.getBounds(),$=le.width/V.width,Ee=le.height/V.height,E=Math.min($,Ee)*e.viewport.getZoom(),T=V.getCenter();console.log("Manual zoom calculation:",{currentZoom:e.viewport.getZoom(),targetZoom:E,animTime:H,center:T}),e.viewport.panTo(T,!1),e.viewport.zoomTo(E,null,!1),console.log("DEBUG: Zoom animation started",{currentZoom:e.viewport.getZoom(),targetBounds:V,springValues:{centerX:e.viewport.centerSpringX.target.value,centerY:e.viewport.centerSpringY.target.value,zoom:e.viewport.zoomSpring.target.value},animationTime:e.animationTime,isAnimating:e.isAnimating()});const S=setInterval(()=>{console.log("DEBUG: Animation progress",{isAnimating:e.isAnimating(),currentZoom:e.viewport.getZoom(),zoomSpringCurrent:e.viewport.zoomSpring.current.value,zoomSpringTarget:e.viewport.zoomSpring.target.value})},100);setTimeout(()=>clearInterval(S),2e3),setTimeout(()=>{z().viewportManager&&z().viewportManager.setCacheEnabled(!0)},H*1e3),setTimeout(()=>{clearTimeout(U),console.log("Setting isZoomingToHotspot to false"),L(!1),e.animationTime=Z.animationTime,e.springStiffness=Z.springStiffness,e.viewport.centerSpringX.animationTime=Z.animationTime,e.viewport.centerSpringY.animationTime=Z.animationTime,e.viewport.zoomSpring.animationTime=Z.animationTime,e.viewport.centerSpringX.springStiffness=Z.springStiffness,e.viewport.centerSpringY.springStiffness=Z.springStiffness,e.viewport.zoomSpring.springStiffness=Z.springStiffness,z().renderOptimizer&&z().renderOptimizer.endCinematicZoom(),z().performanceMonitor&&Ne()&&z().performanceMonitor.resumeMonitoring()},H*1e3+1e3),setTimeout(()=>{z().renderer&&(console.log("Animation complete - restoring hotspots"),Ne()?(z().renderer.showOverlay(),setTimeout(()=>{"requestIdleCallback"in window?requestIdleCallback(()=>{z().renderer.resumeUpdates(),z().renderer.updateVisibilityLazy()},{timeout:1e3}):setTimeout(()=>{z().renderer.resumeUpdates(),z().renderer.updateVisibilityLazy()},300)},200)):(z().renderer.resumeUpdates(),setTimeout(()=>{z().renderer.updateVisibility(),e.forceRedraw()},100)))},H*1e3+300)},yt=async b=>{var B,H,Y,U,Z,ue,le,$;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:b?b.id:"null (deselecting)",isZoomingToHotspot:R(),isExpandingToFullView:j(),timestamp:Date.now()}),console.log("Components available?",!!z()),console.log("OverlayManager available?",!!((B=z())!=null&&B.overlayManager)),console.log("OverlayManager type:",(Y=(H=z())==null?void 0:H.overlayManager)==null?void 0:Y.constructor.name),console.log("OverlayManager initialized?",(Z=(U=z())==null?void 0:U.overlayManager)==null?void 0:Z.isInitialized),!b){h(null),C(!1),M(null),D(null),z().overlayManager?(console.log("Calling overlayManager.clearSelection()"),z().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(j()&&(console.log("Interrupting Full View animation for hotspot click"),e.viewport.stopAnimation(),ze(),G(!1),z().renderOptimizer&&z().renderOptimizer.endCinematicZoom(),z().renderer&&(z().renderer.resumeUpdates(),Ne()&&z().renderer.showOverlay()),await new Promise(Ee=>setTimeout(Ee,50))),R()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),L(!1)),C(!1),h(b),M(b),(ue=z())!=null&&ue.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(b==null?void 0:b.id)||"null"),console.log("Hotspot data being passed:",b),console.log("OverlayManager method exists?",typeof z().overlayManager.selectHotspot);try{z().overlayManager.selectHotspot(b),console.log("selectHotspot call completed")}catch(Ee){console.error("Error calling selectHotspot:",Ee)}console.log("Hotspot data being passed:",{id:b.id,shape:b.shape,hasCoordinates:!!b.coordinates,coordinatesLength:(le=b.coordinates)==null?void 0:le.length}),z().overlayManager.selectHotspot(b)}else console.error("No overlay manager available in components!"),console.error("Components object:",z());(b.image_url_1||(($=z().imageOverlayManager)==null?void 0:$.getOverlay(b.id)))&&(z().imageOverlayManager.shouldAutoReveal(b.id)?Pe(b.id):z().imageOverlayManager.shouldShowButton(b.id)&&(D(b),C(!0))),console.log("Zooming to hotspot:",b.id),await xt(b)};window.artworkViewerHandleHotspotClick=yt;const Pe=b=>{console.log("Media button clicked for:",b),C(!1),z().imageOverlayManager&&z().imageOverlayManager.openOverlay(b)},ht=()=>{if(console.log("expandToFullView START",{isExpandingToFullView:j(),isZoomingToHotspot:R()}),window.expandToFullViewTimeouts||(window.expandToFullViewTimeouts=[]),!e||j())return;if(R()&&(console.log("Force resetting isZoomingToHotspot in expandToFullView"),L(!1),z().renderOptimizer&&z().renderOptimizer.endCinematicZoom(),z().renderer&&z().renderer.resumeUpdates()),v(!1),G(!0),Ne()){const T=document.querySelector(".expand-button-container");T&&(T.style.display="none")}const b=e.world.getItemAt(0);if(!b){G(!1);return}const V=b.getBounds(),H=e.viewport.getBounds().getCenter(),Y=V.getCenter(),U=Math.sqrt(Math.pow(Y.x-H.x,2)+Math.pow(Y.y-H.y,2)),Z=Math.min(1.5,Math.max(1.2,U*.4+1)),ue=Math.max(6,10-U*1.5),le=setTimeout(()=>{console.log("Safety timeout: forcing isExpandingToFullView to false (was:",j(),")"),G(!1)},Z*1e3+500);window.expandToFullViewTimeouts.push(le);const $={animationTime:e.animationTime,springStiffness:e.springStiffness};if(console.log("expandToFullView animation params:",{distance:U,animTime:Z,stiffness:ue,currentAnimationTime:e.animationTime,currentStiffness:e.springStiffness}),z().tileCleanupManager&&z().tileCleanupManager.pauseCleanup(Z*1e3+500),e.imageLoader&&e.imageLoader.clear(),z().renderOptimizer&&z().renderOptimizer.startCinematicZoom(),z().renderer&&(z().renderer.pauseUpdates(),Ne()&&z().renderer.hideOverlay()),e.animationTime=Z,e.springStiffness=ue,e.viewport.centerSpringX.animationTime=Z,e.viewport.centerSpringY.animationTime=Z,e.viewport.zoomSpring.animationTime=Z,e.viewport.centerSpringX.springStiffness=ue,e.viewport.centerSpringY.springStiffness=ue,e.viewport.zoomSpring.springStiffness=ue*.85,e.viewport.centerSpringX.resetTo(e.viewport.centerSpringX.current.value),e.viewport.centerSpringY.resetTo(e.viewport.centerSpringY.current.value),e.viewport.zoomSpring.resetTo(e.viewport.zoomSpring.current.value),console.log("expandToFullView executing fitBounds"),console.log("Springs after reset:",{centerXTime:e.viewport.centerSpringX.animationTime,zoomTime:e.viewport.zoomSpring.animationTime}),Ne())e.viewport.fitBounds(V,!1);else{const S=V.x+V.width/2,I=V.y+V.height/2,q=new Ue.Rect(S-V.width*1.01/2,I-V.height*1.01/2,V.width*1.01,V.height*1.01);e.viewport.fitBounds(q,!1)}console.log("expandToFullView animation started",{actualAnimTime:e.animationTime,actualStiffness:e.springStiffness,timestamp:Date.now()});const Ee=setTimeout(()=>{clearTimeout(le),G(!1),e.animationTime=$.animationTime,e.springStiffness=$.springStiffness,e.viewport.centerSpringX.animationTime=$.animationTime,e.viewport.centerSpringY.animationTime=$.animationTime,e.viewport.zoomSpring.animationTime=$.animationTime,e.viewport.centerSpringX.springStiffness=$.springStiffness,e.viewport.centerSpringY.springStiffness=$.springStiffness,e.viewport.zoomSpring.springStiffness=$.springStiffness,z().renderOptimizer&&z().renderOptimizer.endCinematicZoom()},Z*1e3+200);window.expandToFullViewTimeouts.push(Ee);const E=setTimeout(()=>{z().renderer&&(Ne()&&z().renderer.showOverlay(),setTimeout(()=>{z().renderer.resumeUpdates(),z().renderer.updateVisibility(),e.forceRedraw()},200))},Z*1e3+100);window.expandToFullViewTimeouts.push(E)},y=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(b=>{console.log(`Error attempting to enable fullscreen: ${b.message}`)})};return[(()=>{var b=ef(),V=b.firstChild;se(b,fe(ke,{get when(){return pt(()=>!!f())()&&!d()},get children(){var H=Xd();return st(()=>Nt(H,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),H}}),V);var B=t;return typeof B=="function"?Zu(B,V):t=V,se(b,fe(ke,{get when(){return n()},get children(){return Yd()}}),null),se(b,fe(ke,{get when(){return pt(()=>!!d())()&&Se()===1},get children(){var H=Qd(),Y=H.firstChild;Y.firstChild;var U=Y.nextSibling;U.firstChild;var Z=U.nextSibling;Z.firstChild;var ue=Z.nextSibling;ue.firstChild;var le=ue.nextSibling;le.firstChild;var $=le.nextSibling,Ee=$.firstChild,E=Ee.firstChild,T=E.nextSibling;T.nextSibling;var S=Ee.nextSibling,I=S.nextSibling,q=I.firstChild,Q=q.nextSibling;Q.nextSibling;var ce=$.nextSibling,Te=ce.firstChild;Te.firstChild;var ae=Te.nextSibling;return ae.firstChild,se(Y,()=>{var _e;return((_e=o())==null?void 0:_e.id)||"none"},null),se(U,()=>{var _e;return((_e=c())==null?void 0:_e.id)||"none"},null),se(Z,()=>{var _e;return((_e=o())==null?void 0:_e.type)||"none"},null),se(ue,()=>Hi.length,null),se(le,(()=>{var _e=pt(()=>{var Ae;return!!((Ae=e==null?void 0:e.drawer)!=null&&Ae.getType)});return()=>_e()?e.drawer.getType():"canvas"})(),null),se(Ee,()=>re().toFixed(1),T),S.$$input=_e=>{const Ae=parseFloat(_e.target.value);ve(Ae),localStorage.setItem("zoomSpeedMultiplier",Ae.toString())},se(I,()=>((Ne()?2.8:1.8)*re()).toFixed(1),Q),se(Te,()=>{const _e=Mt.getCurrentType(),Ae=Mt.detectBrowser(),bt=!!_e;return`${_e==="safari"||!_e&&(Ae.isSafari||Ae.isIOS)?"Apple Mode":"Standard Mode"} ${bt?"[Manual]":"[Auto]"}`},null),ae.$$click=()=>{const Ae=(Mt.getCurrentType()||(Mt.detectBrowser().isWebKitBased?"safari":"css"))==="css"?"safari":"css";Mt.setPreference(Ae),window.location.reload()},se(ae,()=>(Mt.getCurrentType()||(Mt.detectBrowser().isWebKitBased?"safari":"css"))==="css"?"Apple Mode":"Standard Mode",null),se(H,fe(ke,{get when(){return Mt.getCurrentType()==="safari"||Mt.detectBrowser().isWebKitBased&&!Mt.getCurrentType()},get children(){var _e=Kd(),Ae=_e.firstChild,bt=Ae.firstChild,Rt=bt.nextSibling,Ft=Ae.nextSibling,Lt=Ft.nextSibling,Zt=Lt.firstChild,un=Zt.nextSibling;return un.nextSibling,se(Rt,()=>Fe[we()].name),Ft.$$click=()=>{var dn;const _i=(we()+1)%Fe.length;tt(_i),(dn=z().overlayManager)!=null&&dn.updateBorderConfig&&z().overlayManager.updateBorderConfig(Fe[_i])},se(Lt,()=>Fe.length,un),_e}}),null),st(()=>S.value=re()),H}}),null),se(b,fe(ke,{get when(){return pt(()=>!!(d()&&m()))()&&Ne()},get children(){var H=Jd(),Y=H.firstChild;return Y.$$click=ht,H}}),null),se(b,fe(ke,{get when(){return pt(()=>!!d())()&&Ne()},get children(){var H=$d(),Y=H.firstChild;return Y.$$click=y,se(Y,(()=>{var U=pt(()=>!!w());return()=>U()?tf():nf()})()),st(()=>Nt(Y,"title",w()?"Exit fullscreen":"Enter fullscreen")),H}}),null),se(b,fe(ke,{get when(){return pt(()=>!!A())()&&O()},get children(){return fe(Vd,{get hotspotId(){var H;return(H=O())==null?void 0:H.id},onClick:Pe,get position(){return k()},get isMobile(){return Ne()}})}}),null),se(b,fe(ke,{get when(){return pt(()=>!!d())()&&z().imageOverlayManager},get children(){return fe(zd,{get imageOverlayManager(){return z().imageOverlayManager},currentHotspot:O})}}),null),b})(),fe(ke,{get when(){return pt(()=>!!d())()&&z().audioEngine},get children(){return fe(Fd,{get audioEngine(){return z().audioEngine},currentHotspot:J})}})]}rn(["input","click"]);const sf=()=>{};var Qa={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xc=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},of=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],c=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(c>>10)),t[i++]=String.fromCharCode(56320+(c&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},bc={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,c=n+2<s.length,h=c?s[n+2]:0,d=r>>2,l=(r&3)<<4|a>>4;let f=(a&15)<<2|h>>6,p=h&63;c||(p=64,o||(f=64)),i.push(e[d],e[l],e[f],e[p])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(xc(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):of(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const h=n<s.length?e[s.charAt(n)]:64;++n;const l=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||h==null||l==null)throw new af;const f=r<<2|a>>4;if(i.push(f),h!==64){const p=a<<4&240|h>>2;if(i.push(p),l!==64){const m=h<<6&192|l;i.push(m)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class af extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const lf=function(s){const t=xc(s);return bc.encodeByteArray(t,!0)},Br=function(s){return lf(s).replace(/\./g,"")},cf=function(s){try{return bc.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hf(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const uf=()=>hf().__FIREBASE_DEFAULTS__,df=()=>{if(typeof process>"u"||typeof Qa>"u")return;const s=Qa.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},ff=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&cf(s[1]);return t&&JSON.parse(t)},yo=()=>{try{return sf()||uf()||df()||ff()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},pf=s=>{var t,e;return(e=(t=yo())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},mf=s=>{const t=pf(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},Sc=()=>{var s;return(s=yo())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gf{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wo(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function vf(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yf(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[Br(JSON.stringify(e)),Br(JSON.stringify(o)),""].join(".")}const Mn={};function wf(){const s={prod:[],emulator:[]};for(const t of Object.keys(Mn))Mn[t]?s.emulator.push(t):s.prod.push(t);return s}function _f(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let Ja=!1;function Tf(s,t){if(typeof window>"u"||typeof document>"u"||!wo(window.location.host)||Mn[s]===t||Mn[s]||Ja)return;Mn[s]=t;function e(f){return`__firebase__banner__${f}`}const i="__firebase__banner",r=wf().prod.length>0;function o(){const f=document.getElementById(i);f&&f.remove()}function a(f){f.style.display="flex",f.style.background="#7faaf0",f.style.position="fixed",f.style.bottom="5px",f.style.left="5px",f.style.padding=".5em",f.style.borderRadius="5px",f.style.alignItems="center"}function c(f,p){f.setAttribute("width","24"),f.setAttribute("id",p),f.setAttribute("height","24"),f.setAttribute("viewBox","0 0 24 24"),f.setAttribute("fill","none"),f.style.marginLeft="-6px"}function h(){const f=document.createElement("span");return f.style.cursor="pointer",f.style.marginLeft="16px",f.style.fontSize="24px",f.innerHTML=" &times;",f.onclick=()=>{Ja=!0,o()},f}function d(f,p){f.setAttribute("id",p),f.innerText="Learn more",f.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",f.setAttribute("target","__blank"),f.style.paddingLeft="5px",f.style.textDecoration="underline"}function l(){const f=_f(i),p=e("text"),m=document.getElementById(p)||document.createElement("span"),v=e("learnmore"),w=document.getElementById(v)||document.createElement("a"),x=e("preprendIcon"),R=document.getElementById(x)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(f.created){const L=f.element;a(L),d(w,v);const j=h();c(R,x),L.append(R,m,w,j),document.body.appendChild(L)}r?(m.innerText="Preview backend disconnected.",R.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(R.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",l):l()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ef(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function xf(){var s;const t=(s=yo())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function bf(){return!xf()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function Sf(){try{return typeof indexedDB=="object"}catch{return!1}}function Pf(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Cf="FirebaseError";class sn extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=Cf,Object.setPrototypeOf(this,sn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Pc.prototype.create)}}class Pc{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?Af(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new sn(n,a,i)}}function Af(s,t){return s.replace(If,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const If=/\{\$([^}]+)}/g;function Nr(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if($a(r)&&$a(o)){if(!Nr(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function $a(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qt(s){return s&&s._delegate?s._delegate:s}class Nn{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bi="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rf{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new gf;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(Mf(t))try{this.getOrInitializeService({instanceIdentifier:bi})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=bi){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=bi){return this.instances.has(t)}getOptions(t=bi){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:Df(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=bi){return this.component?this.component.multipleInstances?t:bi:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Df(s){return s===bi?void 0:s}function Mf(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kf{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new Rf(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Re;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(Re||(Re={}));const Of={debug:Re.DEBUG,verbose:Re.VERBOSE,info:Re.INFO,warn:Re.WARN,error:Re.ERROR,silent:Re.SILENT},Ff=Re.INFO,Lf={[Re.DEBUG]:"log",[Re.VERBOSE]:"log",[Re.INFO]:"info",[Re.WARN]:"warn",[Re.ERROR]:"error"},Vf=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=Lf[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class Cc{constructor(t){this.name=t,this._logLevel=Ff,this._logHandler=Vf,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Re))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?Of[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Re.DEBUG,...t),this._logHandler(this,Re.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Re.VERBOSE,...t),this._logHandler(this,Re.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Re.INFO,...t),this._logHandler(this,Re.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Re.WARN,...t),this._logHandler(this,Re.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Re.ERROR,...t),this._logHandler(this,Re.ERROR,...t)}}const Bf=(s,t)=>t.some(e=>s instanceof e);let el,tl;function Nf(){return el||(el=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Hf(){return tl||(tl=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Ac=new WeakMap,Ws=new WeakMap,Ic=new WeakMap,Ls=new WeakMap,_o=new WeakMap;function zf(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(si(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Ac.set(e,s)}).catch(()=>{}),_o.set(t,s),t}function Uf(s){if(Ws.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});Ws.set(s,t)}let Gs={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return Ws.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Ic.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return si(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function jf(s){Gs=s(Gs)}function qf(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(Vs(this),t,...e);return Ic.set(i,t.sort?t.sort():[t]),si(i)}:Hf().includes(s)?function(...t){return s.apply(Vs(this),t),si(Ac.get(this))}:function(...t){return si(s.apply(Vs(this),t))}}function Wf(s){return typeof s=="function"?qf(s):(s instanceof IDBTransaction&&Uf(s),Bf(s,Nf())?new Proxy(s,Gs):s)}function si(s){if(s instanceof IDBRequest)return zf(s);if(Ls.has(s))return Ls.get(s);const t=Wf(s);return t!==s&&(Ls.set(s,t),_o.set(t,s)),t}const Vs=s=>_o.get(s);function Gf(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=si(o);return i&&o.addEventListener("upgradeneeded",c=>{i(si(o.result),c.oldVersion,c.newVersion,si(o.transaction),c)}),e&&o.addEventListener("blocked",c=>e(c.oldVersion,c.newVersion,c)),a.then(c=>{r&&c.addEventListener("close",()=>r()),n&&c.addEventListener("versionchange",h=>n(h.oldVersion,h.newVersion,h))}).catch(()=>{}),a}const Zf=["get","getKey","getAll","getAllKeys","count"],Xf=["put","add","delete","clear"],Bs=new Map;function il(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(Bs.get(t))return Bs.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=Xf.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||Zf.includes(e)))return;const r=async function(o,...a){const c=this.transaction(o,n?"readwrite":"readonly");let h=c.store;return i&&(h=h.index(a.shift())),(await Promise.all([h[e](...a),n&&c.done]))[0]};return Bs.set(t,r),r}jf(s=>({...s,get:(t,e,i)=>il(t,e)||s.get(t,e,i),has:(t,e)=>!!il(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yf{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(Kf(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function Kf(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const Zs="@firebase/app",nl="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Jt=new Cc("@firebase/app"),Qf="@firebase/app-compat",Jf="@firebase/analytics-compat",$f="@firebase/analytics",ep="@firebase/app-check-compat",tp="@firebase/app-check",ip="@firebase/auth",np="@firebase/auth-compat",rp="@firebase/database",sp="@firebase/data-connect",op="@firebase/database-compat",ap="@firebase/functions",lp="@firebase/functions-compat",cp="@firebase/installations",hp="@firebase/installations-compat",up="@firebase/messaging",dp="@firebase/messaging-compat",fp="@firebase/performance",pp="@firebase/performance-compat",mp="@firebase/remote-config",gp="@firebase/remote-config-compat",vp="@firebase/storage",yp="@firebase/storage-compat",wp="@firebase/firestore",_p="@firebase/ai",Tp="@firebase/firestore-compat",Ep="firebase",xp="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Xs="[DEFAULT]",bp={[Zs]:"fire-core",[Qf]:"fire-core-compat",[$f]:"fire-analytics",[Jf]:"fire-analytics-compat",[tp]:"fire-app-check",[ep]:"fire-app-check-compat",[ip]:"fire-auth",[np]:"fire-auth-compat",[rp]:"fire-rtdb",[sp]:"fire-data-connect",[op]:"fire-rtdb-compat",[ap]:"fire-fn",[lp]:"fire-fn-compat",[cp]:"fire-iid",[hp]:"fire-iid-compat",[up]:"fire-fcm",[dp]:"fire-fcm-compat",[fp]:"fire-perf",[pp]:"fire-perf-compat",[mp]:"fire-rc",[gp]:"fire-rc-compat",[vp]:"fire-gcs",[yp]:"fire-gcs-compat",[wp]:"fire-fst",[Tp]:"fire-fst-compat",[_p]:"fire-vertex","fire-js":"fire-js",[Ep]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hr=new Map,Sp=new Map,Ys=new Map;function rl(s,t){try{s.container.addComponent(t)}catch(e){Jt.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function zr(s){const t=s.name;if(Ys.has(t))return Jt.debug(`There were multiple attempts to register component ${t}.`),!1;Ys.set(t,s);for(const e of Hr.values())rl(e,s);for(const e of Sp.values())rl(e,s);return!0}function Pp(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function Cp(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ap={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},oi=new Pc("app","Firebase",Ap);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ip{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new Nn("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw oi.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Rp=xp;function Rc(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:Xs,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw oi.create("bad-app-name",{appName:String(n)});if(e||(e=Sc()),!e)throw oi.create("no-options");const r=Hr.get(n);if(r){if(Nr(e,r.options)&&Nr(i,r.config))return r;throw oi.create("duplicate-app",{appName:n})}const o=new kf(n);for(const c of Ys.values())o.addComponent(c);const a=new Ip(e,i,o);return Hr.set(n,a),a}function Dp(s=Xs){const t=Hr.get(s);if(!t&&s===Xs&&Sc())return Rc();if(!t)throw oi.create("no-app",{appName:s});return t}function Xi(s,t,e){var i;let n=(i=bp[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),Jt.warn(a.join(" "));return}zr(new Nn(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mp="firebase-heartbeat-database",kp=1,Hn="firebase-heartbeat-store";let Ns=null;function Dc(){return Ns||(Ns=Gf(Mp,kp,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(Hn)}catch(e){console.warn(e)}}}}).catch(s=>{throw oi.create("idb-open",{originalErrorMessage:s.message})})),Ns}async function Op(s){try{const e=(await Dc()).transaction(Hn),i=await e.objectStore(Hn).get(Mc(s));return await e.done,i}catch(t){if(t instanceof sn)Jt.warn(t.message);else{const e=oi.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});Jt.warn(e.message)}}}async function sl(s,t){try{const i=(await Dc()).transaction(Hn,"readwrite");await i.objectStore(Hn).put(t,Mc(s)),await i.done}catch(e){if(e instanceof sn)Jt.warn(e.message);else{const i=oi.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});Jt.warn(i.message)}}}function Mc(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fp=1024,Lp=30;class Vp{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new Np(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=ol();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>Lp){const o=Hp(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){Jt.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=ol(),{heartbeatsToSend:i,unsentEntries:n}=Bp(this._heartbeatsCache.heartbeats),r=Br(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return Jt.warn(e),""}}}function ol(){return new Date().toISOString().substring(0,10)}function Bp(s,t=Fp){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),al(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),al(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class Np{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Sf()?Pf().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await Op(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return sl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return sl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function al(s){return Br(JSON.stringify({version:2,heartbeats:s})).length}function Hp(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zp(s){zr(new Nn("platform-logger",t=>new Yf(t),"PRIVATE")),zr(new Nn("heartbeat",t=>new Vp(t),"PRIVATE")),Xi(Zs,nl,s),Xi(Zs,nl,"esm2017"),Xi("fire-js","")}zp("");var ll=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var ai,kc;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(M,A){function C(){}C.prototype=A.prototype,M.D=A.prototype,M.prototype=new C,M.prototype.constructor=M,M.C=function(k,F,O){for(var D=Array(arguments.length-2),z=2;z<arguments.length;z++)D[z-2]=arguments[z];return A.prototype[F].apply(k,D)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(M,A,C){C||(C=0);var k=Array(16);if(typeof A=="string")for(var F=0;16>F;++F)k[F]=A.charCodeAt(C++)|A.charCodeAt(C++)<<8|A.charCodeAt(C++)<<16|A.charCodeAt(C++)<<24;else for(F=0;16>F;++F)k[F]=A[C++]|A[C++]<<8|A[C++]<<16|A[C++]<<24;A=M.g[0],C=M.g[1],F=M.g[2];var O=M.g[3],D=A+(O^C&(F^O))+k[0]+3614090360&4294967295;A=C+(D<<7&4294967295|D>>>25),D=O+(F^A&(C^F))+k[1]+3905402710&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(C^O&(A^C))+k[2]+606105819&4294967295,F=O+(D<<17&4294967295|D>>>15),D=C+(A^F&(O^A))+k[3]+3250441966&4294967295,C=F+(D<<22&4294967295|D>>>10),D=A+(O^C&(F^O))+k[4]+4118548399&4294967295,A=C+(D<<7&4294967295|D>>>25),D=O+(F^A&(C^F))+k[5]+1200080426&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(C^O&(A^C))+k[6]+2821735955&4294967295,F=O+(D<<17&4294967295|D>>>15),D=C+(A^F&(O^A))+k[7]+4249261313&4294967295,C=F+(D<<22&4294967295|D>>>10),D=A+(O^C&(F^O))+k[8]+1770035416&4294967295,A=C+(D<<7&4294967295|D>>>25),D=O+(F^A&(C^F))+k[9]+2336552879&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(C^O&(A^C))+k[10]+4294925233&4294967295,F=O+(D<<17&4294967295|D>>>15),D=C+(A^F&(O^A))+k[11]+2304563134&4294967295,C=F+(D<<22&4294967295|D>>>10),D=A+(O^C&(F^O))+k[12]+1804603682&4294967295,A=C+(D<<7&4294967295|D>>>25),D=O+(F^A&(C^F))+k[13]+4254626195&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(C^O&(A^C))+k[14]+2792965006&4294967295,F=O+(D<<17&4294967295|D>>>15),D=C+(A^F&(O^A))+k[15]+1236535329&4294967295,C=F+(D<<22&4294967295|D>>>10),D=A+(F^O&(C^F))+k[1]+4129170786&4294967295,A=C+(D<<5&4294967295|D>>>27),D=O+(C^F&(A^C))+k[6]+3225465664&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^C&(O^A))+k[11]+643717713&4294967295,F=O+(D<<14&4294967295|D>>>18),D=C+(O^A&(F^O))+k[0]+3921069994&4294967295,C=F+(D<<20&4294967295|D>>>12),D=A+(F^O&(C^F))+k[5]+3593408605&4294967295,A=C+(D<<5&4294967295|D>>>27),D=O+(C^F&(A^C))+k[10]+38016083&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^C&(O^A))+k[15]+3634488961&4294967295,F=O+(D<<14&4294967295|D>>>18),D=C+(O^A&(F^O))+k[4]+3889429448&4294967295,C=F+(D<<20&4294967295|D>>>12),D=A+(F^O&(C^F))+k[9]+568446438&4294967295,A=C+(D<<5&4294967295|D>>>27),D=O+(C^F&(A^C))+k[14]+3275163606&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^C&(O^A))+k[3]+4107603335&4294967295,F=O+(D<<14&4294967295|D>>>18),D=C+(O^A&(F^O))+k[8]+1163531501&4294967295,C=F+(D<<20&4294967295|D>>>12),D=A+(F^O&(C^F))+k[13]+2850285829&4294967295,A=C+(D<<5&4294967295|D>>>27),D=O+(C^F&(A^C))+k[2]+4243563512&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^C&(O^A))+k[7]+1735328473&4294967295,F=O+(D<<14&4294967295|D>>>18),D=C+(O^A&(F^O))+k[12]+2368359562&4294967295,C=F+(D<<20&4294967295|D>>>12),D=A+(C^F^O)+k[5]+4294588738&4294967295,A=C+(D<<4&4294967295|D>>>28),D=O+(A^C^F)+k[8]+2272392833&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^C)+k[11]+1839030562&4294967295,F=O+(D<<16&4294967295|D>>>16),D=C+(F^O^A)+k[14]+4259657740&4294967295,C=F+(D<<23&4294967295|D>>>9),D=A+(C^F^O)+k[1]+2763975236&4294967295,A=C+(D<<4&4294967295|D>>>28),D=O+(A^C^F)+k[4]+1272893353&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^C)+k[7]+4139469664&4294967295,F=O+(D<<16&4294967295|D>>>16),D=C+(F^O^A)+k[10]+3200236656&4294967295,C=F+(D<<23&4294967295|D>>>9),D=A+(C^F^O)+k[13]+681279174&4294967295,A=C+(D<<4&4294967295|D>>>28),D=O+(A^C^F)+k[0]+3936430074&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^C)+k[3]+3572445317&4294967295,F=O+(D<<16&4294967295|D>>>16),D=C+(F^O^A)+k[6]+76029189&4294967295,C=F+(D<<23&4294967295|D>>>9),D=A+(C^F^O)+k[9]+3654602809&4294967295,A=C+(D<<4&4294967295|D>>>28),D=O+(A^C^F)+k[12]+3873151461&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^C)+k[15]+530742520&4294967295,F=O+(D<<16&4294967295|D>>>16),D=C+(F^O^A)+k[2]+3299628645&4294967295,C=F+(D<<23&4294967295|D>>>9),D=A+(F^(C|~O))+k[0]+4096336452&4294967295,A=C+(D<<6&4294967295|D>>>26),D=O+(C^(A|~F))+k[7]+1126891415&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~C))+k[14]+2878612391&4294967295,F=O+(D<<15&4294967295|D>>>17),D=C+(O^(F|~A))+k[5]+4237533241&4294967295,C=F+(D<<21&4294967295|D>>>11),D=A+(F^(C|~O))+k[12]+1700485571&4294967295,A=C+(D<<6&4294967295|D>>>26),D=O+(C^(A|~F))+k[3]+2399980690&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~C))+k[10]+4293915773&4294967295,F=O+(D<<15&4294967295|D>>>17),D=C+(O^(F|~A))+k[1]+2240044497&4294967295,C=F+(D<<21&4294967295|D>>>11),D=A+(F^(C|~O))+k[8]+1873313359&4294967295,A=C+(D<<6&4294967295|D>>>26),D=O+(C^(A|~F))+k[15]+4264355552&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~C))+k[6]+2734768916&4294967295,F=O+(D<<15&4294967295|D>>>17),D=C+(O^(F|~A))+k[13]+1309151649&4294967295,C=F+(D<<21&4294967295|D>>>11),D=A+(F^(C|~O))+k[4]+4149444226&4294967295,A=C+(D<<6&4294967295|D>>>26),D=O+(C^(A|~F))+k[11]+3174756917&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~C))+k[2]+718787259&4294967295,F=O+(D<<15&4294967295|D>>>17),D=C+(O^(F|~A))+k[9]+3951481745&4294967295,M.g[0]=M.g[0]+A&4294967295,M.g[1]=M.g[1]+(F+(D<<21&4294967295|D>>>11))&4294967295,M.g[2]=M.g[2]+F&4294967295,M.g[3]=M.g[3]+O&4294967295}i.prototype.u=function(M,A){A===void 0&&(A=M.length);for(var C=A-this.blockSize,k=this.B,F=this.h,O=0;O<A;){if(F==0)for(;O<=C;)n(this,M,O),O+=this.blockSize;if(typeof M=="string"){for(;O<A;)if(k[F++]=M.charCodeAt(O++),F==this.blockSize){n(this,k),F=0;break}}else for(;O<A;)if(k[F++]=M[O++],F==this.blockSize){n(this,k),F=0;break}}this.h=F,this.o+=A},i.prototype.v=function(){var M=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);M[0]=128;for(var A=1;A<M.length-8;++A)M[A]=0;var C=8*this.o;for(A=M.length-8;A<M.length;++A)M[A]=C&255,C/=256;for(this.u(M),M=Array(16),A=C=0;4>A;++A)for(var k=0;32>k;k+=8)M[C++]=this.g[A]>>>k&255;return M};function r(M,A){var C=a;return Object.prototype.hasOwnProperty.call(C,M)?C[M]:C[M]=A(M)}function o(M,A){this.h=A;for(var C=[],k=!0,F=M.length-1;0<=F;F--){var O=M[F]|0;k&&O==A||(C[F]=O,k=!1)}this.g=C}var a={};function c(M){return-128<=M&&128>M?r(M,function(A){return new o([A|0],0>A?-1:0)}):new o([M|0],0>M?-1:0)}function h(M){if(isNaN(M)||!isFinite(M))return l;if(0>M)return w(h(-M));for(var A=[],C=1,k=0;M>=C;k++)A[k]=M/C|0,C*=4294967296;return new o(A,0)}function d(M,A){if(M.length==0)throw Error("number format error: empty string");if(A=A||10,2>A||36<A)throw Error("radix out of range: "+A);if(M.charAt(0)=="-")return w(d(M.substring(1),A));if(0<=M.indexOf("-"))throw Error('number format error: interior "-" character');for(var C=h(Math.pow(A,8)),k=l,F=0;F<M.length;F+=8){var O=Math.min(8,M.length-F),D=parseInt(M.substring(F,F+O),A);8>O?(O=h(Math.pow(A,O)),k=k.j(O).add(h(D))):(k=k.j(C),k=k.add(h(D)))}return k}var l=c(0),f=c(1),p=c(16777216);s=o.prototype,s.m=function(){if(v(this))return-w(this).m();for(var M=0,A=1,C=0;C<this.g.length;C++){var k=this.i(C);M+=(0<=k?k:4294967296+k)*A,A*=4294967296}return M},s.toString=function(M){if(M=M||10,2>M||36<M)throw Error("radix out of range: "+M);if(m(this))return"0";if(v(this))return"-"+w(this).toString(M);for(var A=h(Math.pow(M,6)),C=this,k="";;){var F=j(C,A).g;C=x(C,F.j(A));var O=((0<C.g.length?C.g[0]:C.h)>>>0).toString(M);if(C=F,m(C))return O+k;for(;6>O.length;)O="0"+O;k=O+k}},s.i=function(M){return 0>M?0:M<this.g.length?this.g[M]:this.h};function m(M){if(M.h!=0)return!1;for(var A=0;A<M.g.length;A++)if(M.g[A]!=0)return!1;return!0}function v(M){return M.h==-1}s.l=function(M){return M=x(this,M),v(M)?-1:m(M)?0:1};function w(M){for(var A=M.g.length,C=[],k=0;k<A;k++)C[k]=~M.g[k];return new o(C,~M.h).add(f)}s.abs=function(){return v(this)?w(this):this},s.add=function(M){for(var A=Math.max(this.g.length,M.g.length),C=[],k=0,F=0;F<=A;F++){var O=k+(this.i(F)&65535)+(M.i(F)&65535),D=(O>>>16)+(this.i(F)>>>16)+(M.i(F)>>>16);k=D>>>16,O&=65535,D&=65535,C[F]=D<<16|O}return new o(C,C[C.length-1]&-2147483648?-1:0)};function x(M,A){return M.add(w(A))}s.j=function(M){if(m(this)||m(M))return l;if(v(this))return v(M)?w(this).j(w(M)):w(w(this).j(M));if(v(M))return w(this.j(w(M)));if(0>this.l(p)&&0>M.l(p))return h(this.m()*M.m());for(var A=this.g.length+M.g.length,C=[],k=0;k<2*A;k++)C[k]=0;for(k=0;k<this.g.length;k++)for(var F=0;F<M.g.length;F++){var O=this.i(k)>>>16,D=this.i(k)&65535,z=M.i(F)>>>16,xe=M.i(F)&65535;C[2*k+2*F]+=D*xe,R(C,2*k+2*F),C[2*k+2*F+1]+=O*xe,R(C,2*k+2*F+1),C[2*k+2*F+1]+=D*z,R(C,2*k+2*F+1),C[2*k+2*F+2]+=O*z,R(C,2*k+2*F+2)}for(k=0;k<A;k++)C[k]=C[2*k+1]<<16|C[2*k];for(k=A;k<2*A;k++)C[k]=0;return new o(C,0)};function R(M,A){for(;(M[A]&65535)!=M[A];)M[A+1]+=M[A]>>>16,M[A]&=65535,A++}function L(M,A){this.g=M,this.h=A}function j(M,A){if(m(A))throw Error("division by zero");if(m(M))return new L(l,l);if(v(M))return A=j(w(M),A),new L(w(A.g),w(A.h));if(v(A))return A=j(M,w(A)),new L(w(A.g),A.h);if(30<M.g.length){if(v(M)||v(A))throw Error("slowDivide_ only works with positive integers.");for(var C=f,k=A;0>=k.l(M);)C=G(C),k=G(k);var F=J(C,1),O=J(k,1);for(k=J(k,2),C=J(C,2);!m(k);){var D=O.add(k);0>=D.l(M)&&(F=F.add(C),O=D),k=J(k,1),C=J(C,1)}return A=x(M,F.j(A)),new L(F,A)}for(F=l;0<=M.l(A);){for(C=Math.max(1,Math.floor(M.m()/A.m())),k=Math.ceil(Math.log(C)/Math.LN2),k=48>=k?1:Math.pow(2,k-48),O=h(C),D=O.j(A);v(D)||0<D.l(M);)C-=k,O=h(C),D=O.j(A);m(O)&&(O=f),F=F.add(O),M=x(M,D)}return new L(F,M)}s.A=function(M){return j(this,M).h},s.and=function(M){for(var A=Math.max(this.g.length,M.g.length),C=[],k=0;k<A;k++)C[k]=this.i(k)&M.i(k);return new o(C,this.h&M.h)},s.or=function(M){for(var A=Math.max(this.g.length,M.g.length),C=[],k=0;k<A;k++)C[k]=this.i(k)|M.i(k);return new o(C,this.h|M.h)},s.xor=function(M){for(var A=Math.max(this.g.length,M.g.length),C=[],k=0;k<A;k++)C[k]=this.i(k)^M.i(k);return new o(C,this.h^M.h)};function G(M){for(var A=M.g.length+1,C=[],k=0;k<A;k++)C[k]=M.i(k)<<1|M.i(k-1)>>>31;return new o(C,M.h)}function J(M,A){var C=A>>5;A%=32;for(var k=M.g.length-C,F=[],O=0;O<k;O++)F[O]=0<A?M.i(O+C)>>>A|M.i(O+C+1)<<32-A:M.i(O+C);return new o(F,M.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,kc=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=h,o.fromString=d,ai=o}).apply(typeof ll<"u"?ll:typeof self<"u"?self:typeof window<"u"?window:{});var _r=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Oc,Cn,Fc,Cr,Ks,Lc,Vc,Bc;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(u,g,_){return u==Array.prototype||u==Object.prototype||(u[g]=_.value),u};function e(u){u=[typeof globalThis=="object"&&globalThis,u,typeof window=="object"&&window,typeof self=="object"&&self,typeof _r=="object"&&_r];for(var g=0;g<u.length;++g){var _=u[g];if(_&&_.Math==Math)return _}throw Error("Cannot find global object")}var i=e(this);function n(u,g){if(g)e:{var _=i;u=u.split(".");for(var P=0;P<u.length-1;P++){var N=u[P];if(!(N in _))break e;_=_[N]}u=u[u.length-1],P=_[u],g=g(P),g!=P&&g!=null&&t(_,u,{configurable:!0,writable:!0,value:g})}}function r(u,g){u instanceof String&&(u+="");var _=0,P=!1,N={next:function(){if(!P&&_<u.length){var W=_++;return{value:g(W,u[W]),done:!1}}return P=!0,{done:!0,value:void 0}}};return N[Symbol.iterator]=function(){return N},N}n("Array.prototype.values",function(u){return u||function(){return r(this,function(g,_){return _})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function c(u){var g=typeof u;return g=g!="object"?g:u?Array.isArray(u)?"array":g:"null",g=="array"||g=="object"&&typeof u.length=="number"}function h(u){var g=typeof u;return g=="object"&&u!=null||g=="function"}function d(u,g,_){return u.call.apply(u.bind,arguments)}function l(u,g,_){if(!u)throw Error();if(2<arguments.length){var P=Array.prototype.slice.call(arguments,2);return function(){var N=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(N,P),u.apply(g,N)}}return function(){return u.apply(g,arguments)}}function f(u,g,_){return f=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:l,f.apply(null,arguments)}function p(u,g){var _=Array.prototype.slice.call(arguments,1);return function(){var P=_.slice();return P.push.apply(P,arguments),u.apply(this,P)}}function m(u,g){function _(){}_.prototype=g.prototype,u.aa=g.prototype,u.prototype=new _,u.prototype.constructor=u,u.Qb=function(P,N,W){for(var ee=Array(arguments.length-2),Le=2;Le<arguments.length;Le++)ee[Le-2]=arguments[Le];return g.prototype[N].apply(P,ee)}}function v(u){const g=u.length;if(0<g){const _=Array(g);for(let P=0;P<g;P++)_[P]=u[P];return _}return[]}function w(u,g){for(let _=1;_<arguments.length;_++){const P=arguments[_];if(c(P)){const N=u.length||0,W=P.length||0;u.length=N+W;for(let ee=0;ee<W;ee++)u[N+ee]=P[ee]}else u.push(P)}}class x{constructor(g,_){this.i=g,this.j=_,this.h=0,this.g=null}get(){let g;return 0<this.h?(this.h--,g=this.g,this.g=g.next,g.next=null):g=this.i(),g}}function R(u){return/^[\s\xa0]*$/.test(u)}function L(){var u=a.navigator;return u&&(u=u.userAgent)?u:""}function j(u){return j[" "](u),u}j[" "]=function(){};var G=L().indexOf("Gecko")!=-1&&!(L().toLowerCase().indexOf("webkit")!=-1&&L().indexOf("Edge")==-1)&&!(L().indexOf("Trident")!=-1||L().indexOf("MSIE")!=-1)&&L().indexOf("Edge")==-1;function J(u,g,_){for(const P in u)g.call(_,u[P],P,u)}function M(u,g){for(const _ in u)g.call(void 0,u[_],_,u)}function A(u){const g={};for(const _ in u)g[_]=u[_];return g}const C="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function k(u,g){let _,P;for(let N=1;N<arguments.length;N++){P=arguments[N];for(_ in P)u[_]=P[_];for(let W=0;W<C.length;W++)_=C[W],Object.prototype.hasOwnProperty.call(P,_)&&(u[_]=P[_])}}function F(u){var g=1;u=u.split(":");const _=[];for(;0<g&&u.length;)_.push(u.shift()),g--;return u.length&&_.push(u.join(":")),_}function O(u){a.setTimeout(()=>{throw u},0)}function D(){var u=ve;let g=null;return u.g&&(g=u.g,u.g=u.g.next,u.g||(u.h=null),g.next=null),g}class z{constructor(){this.h=this.g=null}add(g,_){const P=xe.get();P.set(g,_),this.h?this.h.next=P:this.g=P,this.h=P}}var xe=new x(()=>new Se,u=>u.reset());class Se{constructor(){this.next=this.g=this.h=null}set(g,_){this.h=g,this.g=_,this.next=null}reset(){this.next=this.g=this.h=null}}let Me,re=!1,ve=new z,we=()=>{const u=a.Promise.resolve(void 0);Me=()=>{u.then(tt)}};var tt=()=>{for(var u;u=D();){try{u.h.call(u.g)}catch(_){O(_)}var g=xe;g.j(u),100>g.h&&(g.h++,u.next=g.g,g.g=u)}re=!1};function Fe(){this.s=this.s,this.C=this.C}Fe.prototype.s=!1,Fe.prototype.ma=function(){this.s||(this.s=!0,this.N())},Fe.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function te(u,g){this.type=u,this.g=this.target=g,this.defaultPrevented=!1}te.prototype.h=function(){this.defaultPrevented=!0};var Ge=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var u=!1,g=Object.defineProperty({},"passive",{get:function(){u=!0}});try{const _=()=>{};a.addEventListener("test",_,g),a.removeEventListener("test",_,g)}catch{}return u}();function ze(u,g){if(te.call(this,u?u.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,u){var _=this.type=u.type,P=u.changedTouches&&u.changedTouches.length?u.changedTouches[0]:null;if(this.target=u.target||u.srcElement,this.g=g,g=u.relatedTarget){if(G){e:{try{j(g.nodeName);var N=!0;break e}catch{}N=!1}N||(g=null)}}else _=="mouseover"?g=u.fromElement:_=="mouseout"&&(g=u.toElement);this.relatedTarget=g,P?(this.clientX=P.clientX!==void 0?P.clientX:P.pageX,this.clientY=P.clientY!==void 0?P.clientY:P.pageY,this.screenX=P.screenX||0,this.screenY=P.screenY||0):(this.clientX=u.clientX!==void 0?u.clientX:u.pageX,this.clientY=u.clientY!==void 0?u.clientY:u.pageY,this.screenX=u.screenX||0,this.screenY=u.screenY||0),this.button=u.button,this.key=u.key||"",this.ctrlKey=u.ctrlKey,this.altKey=u.altKey,this.shiftKey=u.shiftKey,this.metaKey=u.metaKey,this.pointerId=u.pointerId||0,this.pointerType=typeof u.pointerType=="string"?u.pointerType:Ct[u.pointerType]||"",this.state=u.state,this.i=u,u.defaultPrevented&&ze.aa.h.call(this)}}m(ze,te);var Ct={2:"touch",3:"pen",4:"mouse"};ze.prototype.h=function(){ze.aa.h.call(this);var u=this.i;u.preventDefault?u.preventDefault():u.returnValue=!1};var it="closure_listenable_"+(1e6*Math.random()|0),It=0;function Gt(u,g,_,P,N){this.listener=u,this.proxy=null,this.src=g,this.type=_,this.capture=!!P,this.ha=N,this.key=++It,this.da=this.fa=!1}function Et(u){u.da=!0,u.listener=null,u.proxy=null,u.src=null,u.ha=null}function lt(u){this.src=u,this.g={},this.h=0}lt.prototype.add=function(u,g,_,P,N){var W=u.toString();u=this.g[W],u||(u=this.g[W]=[],this.h++);var ee=xt(u,g,P,N);return-1<ee?(g=u[ee],_||(g.fa=!1)):(g=new Gt(g,this.src,W,!!P,N),g.fa=_,u.push(g)),g};function ct(u,g){var _=g.type;if(_ in u.g){var P=u.g[_],N=Array.prototype.indexOf.call(P,g,void 0),W;(W=0<=N)&&Array.prototype.splice.call(P,N,1),W&&(Et(g),u.g[_].length==0&&(delete u.g[_],u.h--))}}function xt(u,g,_,P){for(var N=0;N<u.length;++N){var W=u[N];if(!W.da&&W.listener==g&&W.capture==!!_&&W.ha==P)return N}return-1}var yt="closure_lm_"+(1e6*Math.random()|0),Pe={};function ht(u,g,_,P,N){if(Array.isArray(g)){for(var W=0;W<g.length;W++)ht(u,g[W],_,P,N);return null}return _=ue(_),u&&u[it]?u.K(g,_,h(P)?!!P.capture:!1,N):y(u,g,_,!1,P,N)}function y(u,g,_,P,N,W){if(!g)throw Error("Invalid event type");var ee=h(N)?!!N.capture:!!N,Le=U(u);if(Le||(u[yt]=Le=new lt(u)),_=Le.add(g,_,P,ee,W),_.proxy)return _;if(P=b(),_.proxy=P,P.src=u,P.listener=_,u.addEventListener)Ge||(N=ee),N===void 0&&(N=!1),u.addEventListener(g.toString(),P,N);else if(u.attachEvent)u.attachEvent(H(g.toString()),P);else if(u.addListener&&u.removeListener)u.addListener(P);else throw Error("addEventListener and attachEvent are unavailable.");return _}function b(){function u(_){return g.call(u.src,u.listener,_)}const g=Y;return u}function V(u,g,_,P,N){if(Array.isArray(g))for(var W=0;W<g.length;W++)V(u,g[W],_,P,N);else P=h(P)?!!P.capture:!!P,_=ue(_),u&&u[it]?(u=u.i,g=String(g).toString(),g in u.g&&(W=u.g[g],_=xt(W,_,P,N),-1<_&&(Et(W[_]),Array.prototype.splice.call(W,_,1),W.length==0&&(delete u.g[g],u.h--)))):u&&(u=U(u))&&(g=u.g[g.toString()],u=-1,g&&(u=xt(g,_,P,N)),(_=-1<u?g[u]:null)&&B(_))}function B(u){if(typeof u!="number"&&u&&!u.da){var g=u.src;if(g&&g[it])ct(g.i,u);else{var _=u.type,P=u.proxy;g.removeEventListener?g.removeEventListener(_,P,u.capture):g.detachEvent?g.detachEvent(H(_),P):g.addListener&&g.removeListener&&g.removeListener(P),(_=U(g))?(ct(_,u),_.h==0&&(_.src=null,g[yt]=null)):Et(u)}}}function H(u){return u in Pe?Pe[u]:Pe[u]="on"+u}function Y(u,g){if(u.da)u=!0;else{g=new ze(g,this);var _=u.listener,P=u.ha||u.src;u.fa&&B(u),u=_.call(P,g)}return u}function U(u){return u=u[yt],u instanceof lt?u:null}var Z="__closure_events_fn_"+(1e9*Math.random()>>>0);function ue(u){return typeof u=="function"?u:(u[Z]||(u[Z]=function(g){return u.handleEvent(g)}),u[Z])}function le(){Fe.call(this),this.i=new lt(this),this.M=this,this.F=null}m(le,Fe),le.prototype[it]=!0,le.prototype.removeEventListener=function(u,g,_,P){V(this,u,g,_,P)};function $(u,g){var _,P=u.F;if(P)for(_=[];P;P=P.F)_.push(P);if(u=u.M,P=g.type||g,typeof g=="string")g=new te(g,u);else if(g instanceof te)g.target=g.target||u;else{var N=g;g=new te(P,u),k(g,N)}if(N=!0,_)for(var W=_.length-1;0<=W;W--){var ee=g.g=_[W];N=Ee(ee,P,!0,g)&&N}if(ee=g.g=u,N=Ee(ee,P,!0,g)&&N,N=Ee(ee,P,!1,g)&&N,_)for(W=0;W<_.length;W++)ee=g.g=_[W],N=Ee(ee,P,!1,g)&&N}le.prototype.N=function(){if(le.aa.N.call(this),this.i){var u=this.i,g;for(g in u.g){for(var _=u.g[g],P=0;P<_.length;P++)Et(_[P]);delete u.g[g],u.h--}}this.F=null},le.prototype.K=function(u,g,_,P){return this.i.add(String(u),g,!1,_,P)},le.prototype.L=function(u,g,_,P){return this.i.add(String(u),g,!0,_,P)};function Ee(u,g,_,P){if(g=u.i.g[String(g)],!g)return!0;g=g.concat();for(var N=!0,W=0;W<g.length;++W){var ee=g[W];if(ee&&!ee.da&&ee.capture==_){var Le=ee.listener,nt=ee.ha||ee.src;ee.fa&&ct(u.i,ee),N=Le.call(nt,P)!==!1&&N}}return N&&!P.defaultPrevented}function E(u,g,_){if(typeof u=="function")_&&(u=f(u,_));else if(u&&typeof u.handleEvent=="function")u=f(u.handleEvent,u);else throw Error("Invalid listener argument");return 2147483647<Number(g)?-1:a.setTimeout(u,g||0)}function T(u){u.g=E(()=>{u.g=null,u.i&&(u.i=!1,T(u))},u.l);const g=u.h;u.h=null,u.m.apply(null,g)}class S extends Fe{constructor(g,_){super(),this.m=g,this.l=_,this.h=null,this.i=!1,this.g=null}j(g){this.h=arguments,this.g?this.i=!0:T(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function I(u){Fe.call(this),this.h=u,this.g={}}m(I,Fe);var q=[];function Q(u){J(u.g,function(g,_){this.g.hasOwnProperty(_)&&B(g)},u),u.g={}}I.prototype.N=function(){I.aa.N.call(this),Q(this)},I.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var ce=a.JSON.stringify,Te=a.JSON.parse,ae=class{stringify(u){return a.JSON.stringify(u,void 0)}parse(u){return a.JSON.parse(u,void 0)}};function _e(){}_e.prototype.h=null;function Ae(u){return u.h||(u.h=u.i())}function bt(){}var Rt={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Ft(){te.call(this,"d")}m(Ft,te);function Lt(){te.call(this,"c")}m(Lt,te);var Zt={},un=null;function _i(){return un=un||new le}Zt.La="serverreachability";function dn(u){te.call(this,Zt.La,u)}m(dn,te);function fn(u){const g=_i();$(g,new dn(g))}Zt.STAT_EVENT="statevent";function ia(u,g){te.call(this,Zt.STAT_EVENT,u),this.stat=g}m(ia,te);function wt(u){const g=_i();$(g,new ia(g,u))}Zt.Ma="timingevent";function na(u,g){te.call(this,Zt.Ma,u),this.size=g}m(na,te);function pn(u,g){if(typeof u!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){u()},g)}function mn(){this.g=!0}mn.prototype.xa=function(){this.g=!1};function lu(u,g,_,P,N,W){u.info(function(){if(u.g)if(W)for(var ee="",Le=W.split("&"),nt=0;nt<Le.length;nt++){var De=Le[nt].split("=");if(1<De.length){var ut=De[0];De=De[1];var dt=ut.split("_");ee=2<=dt.length&&dt[1]=="type"?ee+(ut+"="+De+"&"):ee+(ut+"=redacted&")}}else ee=null;else ee=W;return"XMLHTTP REQ ("+P+") [attempt "+N+"]: "+g+`
`+_+`
`+ee})}function cu(u,g,_,P,N,W,ee){u.info(function(){return"XMLHTTP RESP ("+P+") [ attempt "+N+"]: "+g+`
`+_+`
`+W+" "+ee})}function Oi(u,g,_,P){u.info(function(){return"XMLHTTP TEXT ("+g+"): "+uu(u,_)+(P?" "+P:"")})}function hu(u,g){u.info(function(){return"TIMEOUT: "+g})}mn.prototype.info=function(){};function uu(u,g){if(!u.g)return g;if(!g)return null;try{var _=JSON.parse(g);if(_){for(u=0;u<_.length;u++)if(Array.isArray(_[u])){var P=_[u];if(!(2>P.length)){var N=P[1];if(Array.isArray(N)&&!(1>N.length)){var W=N[0];if(W!="noop"&&W!="stop"&&W!="close")for(var ee=1;ee<N.length;ee++)N[ee]=""}}}}return ce(_)}catch{return g}}var ir={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},ra={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},vs;function nr(){}m(nr,_e),nr.prototype.g=function(){return new XMLHttpRequest},nr.prototype.i=function(){return{}},vs=new nr;function ti(u,g,_,P){this.j=u,this.i=g,this.l=_,this.R=P||1,this.U=new I(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new sa}function sa(){this.i=null,this.g="",this.h=!1}var oa={},ys={};function ws(u,g,_){u.L=1,u.v=ar(Xt(g)),u.m=_,u.P=!0,aa(u,null)}function aa(u,g){u.F=Date.now(),rr(u),u.A=Xt(u.v);var _=u.A,P=u.R;Array.isArray(P)||(P=[String(P)]),Ta(_.i,"t",P),u.C=0,_=u.j.J,u.h=new sa,u.g=Na(u.j,_?g:null,!u.m),0<u.O&&(u.M=new S(f(u.Y,u,u.g),u.O)),g=u.U,_=u.g,P=u.ca;var N="readystatechange";Array.isArray(N)||(N&&(q[0]=N.toString()),N=q);for(var W=0;W<N.length;W++){var ee=ht(_,N[W],P||g.handleEvent,!1,g.h||g);if(!ee)break;g.g[ee.key]=ee}g=u.H?A(u.H):{},u.m?(u.u||(u.u="POST"),g["Content-Type"]="application/x-www-form-urlencoded",u.g.ea(u.A,u.u,u.m,g)):(u.u="GET",u.g.ea(u.A,u.u,null,g)),fn(),lu(u.i,u.u,u.A,u.l,u.R,u.m)}ti.prototype.ca=function(u){u=u.target;const g=this.M;g&&Yt(u)==3?g.j():this.Y(u)},ti.prototype.Y=function(u){try{if(u==this.g)e:{const dt=Yt(this.g);var g=this.g.Ba();const Vi=this.g.Z();if(!(3>dt)&&(dt!=3||this.g&&(this.h.h||this.g.oa()||Aa(this.g)))){this.J||dt!=4||g==7||(g==8||0>=Vi?fn(3):fn(2)),_s(this);var _=this.g.Z();this.X=_;t:if(la(this)){var P=Aa(this.g);u="";var N=P.length,W=Yt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Ti(this),gn(this);var ee="";break t}this.h.i=new a.TextDecoder}for(g=0;g<N;g++)this.h.h=!0,u+=this.h.i.decode(P[g],{stream:!(W&&g==N-1)});P.length=0,this.h.g+=u,this.C=0,ee=this.h.g}else ee=this.g.oa();if(this.o=_==200,cu(this.i,this.u,this.A,this.l,this.R,dt,_),this.o){if(this.T&&!this.K){t:{if(this.g){var Le,nt=this.g;if((Le=nt.g?nt.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!R(Le)){var De=Le;break t}}De=null}if(_=De)Oi(this.i,this.l,_,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ts(this,_);else{this.o=!1,this.s=3,wt(12),Ti(this),gn(this);break e}}if(this.P){_=!0;let Dt;for(;!this.J&&this.C<ee.length;)if(Dt=du(this,ee),Dt==ys){dt==4&&(this.s=4,wt(14),_=!1),Oi(this.i,this.l,null,"[Incomplete Response]");break}else if(Dt==oa){this.s=4,wt(15),Oi(this.i,this.l,ee,"[Invalid Chunk]"),_=!1;break}else Oi(this.i,this.l,Dt,null),Ts(this,Dt);if(la(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),dt!=4||ee.length!=0||this.h.h||(this.s=1,wt(16),_=!1),this.o=this.o&&_,!_)Oi(this.i,this.l,ee,"[Invalid Chunked Response]"),Ti(this),gn(this);else if(0<ee.length&&!this.W){this.W=!0;var ut=this.j;ut.g==this&&ut.ba&&!ut.M&&(ut.j.info("Great, no buffering proxy detected. Bytes received: "+ee.length),Cs(ut),ut.M=!0,wt(11))}}else Oi(this.i,this.l,ee,null),Ts(this,ee);dt==4&&Ti(this),this.o&&!this.J&&(dt==4?Fa(this.j,this):(this.o=!1,rr(this)))}else Iu(this.g),_==400&&0<ee.indexOf("Unknown SID")?(this.s=3,wt(12)):(this.s=0,wt(13)),Ti(this),gn(this)}}}catch{}finally{}};function la(u){return u.g?u.u=="GET"&&u.L!=2&&u.j.Ca:!1}function du(u,g){var _=u.C,P=g.indexOf(`
`,_);return P==-1?ys:(_=Number(g.substring(_,P)),isNaN(_)?oa:(P+=1,P+_>g.length?ys:(g=g.slice(P,P+_),u.C=P+_,g)))}ti.prototype.cancel=function(){this.J=!0,Ti(this)};function rr(u){u.S=Date.now()+u.I,ca(u,u.I)}function ca(u,g){if(u.B!=null)throw Error("WatchDog timer not null");u.B=pn(f(u.ba,u),g)}function _s(u){u.B&&(a.clearTimeout(u.B),u.B=null)}ti.prototype.ba=function(){this.B=null;const u=Date.now();0<=u-this.S?(hu(this.i,this.A),this.L!=2&&(fn(),wt(17)),Ti(this),this.s=2,gn(this)):ca(this,this.S-u)};function gn(u){u.j.G==0||u.J||Fa(u.j,u)}function Ti(u){_s(u);var g=u.M;g&&typeof g.ma=="function"&&g.ma(),u.M=null,Q(u.U),u.g&&(g=u.g,u.g=null,g.abort(),g.ma())}function Ts(u,g){try{var _=u.j;if(_.G!=0&&(_.g==u||Es(_.h,u))){if(!u.K&&Es(_.h,u)&&_.G==3){try{var P=_.Da.g.parse(g)}catch{P=null}if(Array.isArray(P)&&P.length==3){var N=P;if(N[0]==0){e:if(!_.u){if(_.g)if(_.g.F+3e3<u.F)fr(_),ur(_);else break e;Ps(_),wt(18)}}else _.za=N[1],0<_.za-_.T&&37500>N[2]&&_.F&&_.v==0&&!_.C&&(_.C=pn(f(_.Za,_),6e3));if(1>=da(_.h)&&_.ca){try{_.ca()}catch{}_.ca=void 0}}else xi(_,11)}else if((u.K||_.g==u)&&fr(_),!R(g))for(N=_.Da.g.parse(g),g=0;g<N.length;g++){let De=N[g];if(_.T=De[0],De=De[1],_.G==2)if(De[0]=="c"){_.K=De[1],_.ia=De[2];const ut=De[3];ut!=null&&(_.la=ut,_.j.info("VER="+_.la));const dt=De[4];dt!=null&&(_.Aa=dt,_.j.info("SVER="+_.Aa));const Vi=De[5];Vi!=null&&typeof Vi=="number"&&0<Vi&&(P=1.5*Vi,_.L=P,_.j.info("backChannelRequestTimeoutMs_="+P)),P=_;const Dt=u.g;if(Dt){const mr=Dt.g?Dt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(mr){var W=P.h;W.g||mr.indexOf("spdy")==-1&&mr.indexOf("quic")==-1&&mr.indexOf("h2")==-1||(W.j=W.l,W.g=new Set,W.h&&(xs(W,W.h),W.h=null))}if(P.D){const As=Dt.g?Dt.g.getResponseHeader("X-HTTP-Session-Id"):null;As&&(P.ya=As,Be(P.I,P.D,As))}}_.G=3,_.l&&_.l.ua(),_.ba&&(_.R=Date.now()-u.F,_.j.info("Handshake RTT: "+_.R+"ms")),P=_;var ee=u;if(P.qa=Ba(P,P.J?P.ia:null,P.W),ee.K){fa(P.h,ee);var Le=ee,nt=P.L;nt&&(Le.I=nt),Le.B&&(_s(Le),rr(Le)),P.g=ee}else ka(P);0<_.i.length&&dr(_)}else De[0]!="stop"&&De[0]!="close"||xi(_,7);else _.G==3&&(De[0]=="stop"||De[0]=="close"?De[0]=="stop"?xi(_,7):Ss(_):De[0]!="noop"&&_.l&&_.l.ta(De),_.v=0)}}fn(4)}catch{}}var fu=class{constructor(u,g){this.g=u,this.map=g}};function ha(u){this.l=u||10,a.PerformanceNavigationTiming?(u=a.performance.getEntriesByType("navigation"),u=0<u.length&&(u[0].nextHopProtocol=="hq"||u[0].nextHopProtocol=="h2")):u=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=u?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function ua(u){return u.h?!0:u.g?u.g.size>=u.j:!1}function da(u){return u.h?1:u.g?u.g.size:0}function Es(u,g){return u.h?u.h==g:u.g?u.g.has(g):!1}function xs(u,g){u.g?u.g.add(g):u.h=g}function fa(u,g){u.h&&u.h==g?u.h=null:u.g&&u.g.has(g)&&u.g.delete(g)}ha.prototype.cancel=function(){if(this.i=pa(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const u of this.g.values())u.cancel();this.g.clear()}};function pa(u){if(u.h!=null)return u.i.concat(u.h.D);if(u.g!=null&&u.g.size!==0){let g=u.i;for(const _ of u.g.values())g=g.concat(_.D);return g}return v(u.i)}function pu(u){if(u.V&&typeof u.V=="function")return u.V();if(typeof Map<"u"&&u instanceof Map||typeof Set<"u"&&u instanceof Set)return Array.from(u.values());if(typeof u=="string")return u.split("");if(c(u)){for(var g=[],_=u.length,P=0;P<_;P++)g.push(u[P]);return g}g=[],_=0;for(P in u)g[_++]=u[P];return g}function mu(u){if(u.na&&typeof u.na=="function")return u.na();if(!u.V||typeof u.V!="function"){if(typeof Map<"u"&&u instanceof Map)return Array.from(u.keys());if(!(typeof Set<"u"&&u instanceof Set)){if(c(u)||typeof u=="string"){var g=[];u=u.length;for(var _=0;_<u;_++)g.push(_);return g}g=[],_=0;for(const P in u)g[_++]=P;return g}}}function ma(u,g){if(u.forEach&&typeof u.forEach=="function")u.forEach(g,void 0);else if(c(u)||typeof u=="string")Array.prototype.forEach.call(u,g,void 0);else for(var _=mu(u),P=pu(u),N=P.length,W=0;W<N;W++)g.call(void 0,P[W],_&&_[W],u)}var ga=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function gu(u,g){if(u){u=u.split("&");for(var _=0;_<u.length;_++){var P=u[_].indexOf("="),N=null;if(0<=P){var W=u[_].substring(0,P);N=u[_].substring(P+1)}else W=u[_];g(W,N?decodeURIComponent(N.replace(/\+/g," ")):"")}}}function Ei(u){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,u instanceof Ei){this.h=u.h,sr(this,u.j),this.o=u.o,this.g=u.g,or(this,u.s),this.l=u.l;var g=u.i,_=new wn;_.i=g.i,g.g&&(_.g=new Map(g.g),_.h=g.h),va(this,_),this.m=u.m}else u&&(g=String(u).match(ga))?(this.h=!1,sr(this,g[1]||"",!0),this.o=vn(g[2]||""),this.g=vn(g[3]||"",!0),or(this,g[4]),this.l=vn(g[5]||"",!0),va(this,g[6]||"",!0),this.m=vn(g[7]||"")):(this.h=!1,this.i=new wn(null,this.h))}Ei.prototype.toString=function(){var u=[],g=this.j;g&&u.push(yn(g,ya,!0),":");var _=this.g;return(_||g=="file")&&(u.push("//"),(g=this.o)&&u.push(yn(g,ya,!0),"@"),u.push(encodeURIComponent(String(_)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),_=this.s,_!=null&&u.push(":",String(_))),(_=this.l)&&(this.g&&_.charAt(0)!="/"&&u.push("/"),u.push(yn(_,_.charAt(0)=="/"?wu:yu,!0))),(_=this.i.toString())&&u.push("?",_),(_=this.m)&&u.push("#",yn(_,Tu)),u.join("")};function Xt(u){return new Ei(u)}function sr(u,g,_){u.j=_?vn(g,!0):g,u.j&&(u.j=u.j.replace(/:$/,""))}function or(u,g){if(g){if(g=Number(g),isNaN(g)||0>g)throw Error("Bad port number "+g);u.s=g}else u.s=null}function va(u,g,_){g instanceof wn?(u.i=g,Eu(u.i,u.h)):(_||(g=yn(g,_u)),u.i=new wn(g,u.h))}function Be(u,g,_){u.i.set(g,_)}function ar(u){return Be(u,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),u}function vn(u,g){return u?g?decodeURI(u.replace(/%25/g,"%2525")):decodeURIComponent(u):""}function yn(u,g,_){return typeof u=="string"?(u=encodeURI(u).replace(g,vu),_&&(u=u.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),u):null}function vu(u){return u=u.charCodeAt(0),"%"+(u>>4&15).toString(16)+(u&15).toString(16)}var ya=/[#\/\?@]/g,yu=/[#\?:]/g,wu=/[#\?]/g,_u=/[#\?@]/g,Tu=/#/g;function wn(u,g){this.h=this.g=null,this.i=u||null,this.j=!!g}function ii(u){u.g||(u.g=new Map,u.h=0,u.i&&gu(u.i,function(g,_){u.add(decodeURIComponent(g.replace(/\+/g," ")),_)}))}s=wn.prototype,s.add=function(u,g){ii(this),this.i=null,u=Fi(this,u);var _=this.g.get(u);return _||this.g.set(u,_=[]),_.push(g),this.h+=1,this};function wa(u,g){ii(u),g=Fi(u,g),u.g.has(g)&&(u.i=null,u.h-=u.g.get(g).length,u.g.delete(g))}function _a(u,g){return ii(u),g=Fi(u,g),u.g.has(g)}s.forEach=function(u,g){ii(this),this.g.forEach(function(_,P){_.forEach(function(N){u.call(g,N,P,this)},this)},this)},s.na=function(){ii(this);const u=Array.from(this.g.values()),g=Array.from(this.g.keys()),_=[];for(let P=0;P<g.length;P++){const N=u[P];for(let W=0;W<N.length;W++)_.push(g[P])}return _},s.V=function(u){ii(this);let g=[];if(typeof u=="string")_a(this,u)&&(g=g.concat(this.g.get(Fi(this,u))));else{u=Array.from(this.g.values());for(let _=0;_<u.length;_++)g=g.concat(u[_])}return g},s.set=function(u,g){return ii(this),this.i=null,u=Fi(this,u),_a(this,u)&&(this.h-=this.g.get(u).length),this.g.set(u,[g]),this.h+=1,this},s.get=function(u,g){return u?(u=this.V(u),0<u.length?String(u[0]):g):g};function Ta(u,g,_){wa(u,g),0<_.length&&(u.i=null,u.g.set(Fi(u,g),v(_)),u.h+=_.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const u=[],g=Array.from(this.g.keys());for(var _=0;_<g.length;_++){var P=g[_];const W=encodeURIComponent(String(P)),ee=this.V(P);for(P=0;P<ee.length;P++){var N=W;ee[P]!==""&&(N+="="+encodeURIComponent(String(ee[P]))),u.push(N)}}return this.i=u.join("&")};function Fi(u,g){return g=String(g),u.j&&(g=g.toLowerCase()),g}function Eu(u,g){g&&!u.j&&(ii(u),u.i=null,u.g.forEach(function(_,P){var N=P.toLowerCase();P!=N&&(wa(this,P),Ta(this,N,_))},u)),u.j=g}function xu(u,g){const _=new mn;if(a.Image){const P=new Image;P.onload=p(ni,_,"TestLoadImage: loaded",!0,g,P),P.onerror=p(ni,_,"TestLoadImage: error",!1,g,P),P.onabort=p(ni,_,"TestLoadImage: abort",!1,g,P),P.ontimeout=p(ni,_,"TestLoadImage: timeout",!1,g,P),a.setTimeout(function(){P.ontimeout&&P.ontimeout()},1e4),P.src=u}else g(!1)}function bu(u,g){const _=new mn,P=new AbortController,N=setTimeout(()=>{P.abort(),ni(_,"TestPingServer: timeout",!1,g)},1e4);fetch(u,{signal:P.signal}).then(W=>{clearTimeout(N),W.ok?ni(_,"TestPingServer: ok",!0,g):ni(_,"TestPingServer: server error",!1,g)}).catch(()=>{clearTimeout(N),ni(_,"TestPingServer: error",!1,g)})}function ni(u,g,_,P,N){try{N&&(N.onload=null,N.onerror=null,N.onabort=null,N.ontimeout=null),P(_)}catch{}}function Su(){this.g=new ae}function Pu(u,g,_){const P=_||"";try{ma(u,function(N,W){let ee=N;h(N)&&(ee=ce(N)),g.push(P+W+"="+encodeURIComponent(ee))})}catch(N){throw g.push(P+"type="+encodeURIComponent("_badmap")),N}}function lr(u){this.l=u.Ub||null,this.j=u.eb||!1}m(lr,_e),lr.prototype.g=function(){return new cr(this.l,this.j)},lr.prototype.i=function(u){return function(){return u}}({});function cr(u,g){le.call(this),this.D=u,this.o=g,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}m(cr,le),s=cr.prototype,s.open=function(u,g){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=u,this.A=g,this.readyState=1,Tn(this)},s.send=function(u){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const g={headers:this.u,method:this.B,credentials:this.m,cache:void 0};u&&(g.body=u),(this.D||a).fetch(new Request(this.A,g)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,_n(this)),this.readyState=0},s.Sa=function(u){if(this.g&&(this.l=u,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=u.headers,this.readyState=2,Tn(this)),this.g&&(this.readyState=3,Tn(this),this.g)))if(this.responseType==="arraybuffer")u.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in u){if(this.j=u.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Ea(this)}else u.text().then(this.Ra.bind(this),this.ga.bind(this))};function Ea(u){u.j.read().then(u.Pa.bind(u)).catch(u.ga.bind(u))}s.Pa=function(u){if(this.g){if(this.o&&u.value)this.response.push(u.value);else if(!this.o){var g=u.value?u.value:new Uint8Array(0);(g=this.v.decode(g,{stream:!u.done}))&&(this.response=this.responseText+=g)}u.done?_n(this):Tn(this),this.readyState==3&&Ea(this)}},s.Ra=function(u){this.g&&(this.response=this.responseText=u,_n(this))},s.Qa=function(u){this.g&&(this.response=u,_n(this))},s.ga=function(){this.g&&_n(this)};function _n(u){u.readyState=4,u.l=null,u.j=null,u.v=null,Tn(u)}s.setRequestHeader=function(u,g){this.u.append(u,g)},s.getResponseHeader=function(u){return this.h&&this.h.get(u.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const u=[],g=this.h.entries();for(var _=g.next();!_.done;)_=_.value,u.push(_[0]+": "+_[1]),_=g.next();return u.join(`\r
`)};function Tn(u){u.onreadystatechange&&u.onreadystatechange.call(u)}Object.defineProperty(cr.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(u){this.m=u?"include":"same-origin"}});function xa(u){let g="";return J(u,function(_,P){g+=P,g+=":",g+=_,g+=`\r
`}),g}function bs(u,g,_){e:{for(P in _){var P=!1;break e}P=!0}P||(_=xa(_),typeof u=="string"?_!=null&&encodeURIComponent(String(_)):Be(u,g,_))}function qe(u){le.call(this),this.headers=new Map,this.o=u||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}m(qe,le);var Cu=/^https?$/i,Au=["POST","PUT"];s=qe.prototype,s.Ha=function(u){this.J=u},s.ea=function(u,g,_,P){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+u);g=g?g.toUpperCase():"GET",this.D=u,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():vs.g(),this.v=this.o?Ae(this.o):Ae(vs),this.g.onreadystatechange=f(this.Ea,this);try{this.B=!0,this.g.open(g,String(u),!0),this.B=!1}catch(W){ba(this,W);return}if(u=_||"",_=new Map(this.headers),P)if(Object.getPrototypeOf(P)===Object.prototype)for(var N in P)_.set(N,P[N]);else if(typeof P.keys=="function"&&typeof P.get=="function")for(const W of P.keys())_.set(W,P.get(W));else throw Error("Unknown input type for opt_headers: "+String(P));P=Array.from(_.keys()).find(W=>W.toLowerCase()=="content-type"),N=a.FormData&&u instanceof a.FormData,!(0<=Array.prototype.indexOf.call(Au,g,void 0))||P||N||_.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[W,ee]of _)this.g.setRequestHeader(W,ee);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Ca(this),this.u=!0,this.g.send(u),this.u=!1}catch(W){ba(this,W)}};function ba(u,g){u.h=!1,u.g&&(u.j=!0,u.g.abort(),u.j=!1),u.l=g,u.m=5,Sa(u),hr(u)}function Sa(u){u.A||(u.A=!0,$(u,"complete"),$(u,"error"))}s.abort=function(u){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=u||7,$(this,"complete"),$(this,"abort"),hr(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),hr(this,!0)),qe.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?Pa(this):this.bb())},s.bb=function(){Pa(this)};function Pa(u){if(u.h&&typeof o<"u"&&(!u.v[1]||Yt(u)!=4||u.Z()!=2)){if(u.u&&Yt(u)==4)E(u.Ea,0,u);else if($(u,"readystatechange"),Yt(u)==4){u.h=!1;try{const ee=u.Z();e:switch(ee){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var g=!0;break e;default:g=!1}var _;if(!(_=g)){var P;if(P=ee===0){var N=String(u.D).match(ga)[1]||null;!N&&a.self&&a.self.location&&(N=a.self.location.protocol.slice(0,-1)),P=!Cu.test(N?N.toLowerCase():"")}_=P}if(_)$(u,"complete"),$(u,"success");else{u.m=6;try{var W=2<Yt(u)?u.g.statusText:""}catch{W=""}u.l=W+" ["+u.Z()+"]",Sa(u)}}finally{hr(u)}}}}function hr(u,g){if(u.g){Ca(u);const _=u.g,P=u.v[0]?()=>{}:null;u.g=null,u.v=null,g||$(u,"ready");try{_.onreadystatechange=P}catch{}}}function Ca(u){u.I&&(a.clearTimeout(u.I),u.I=null)}s.isActive=function(){return!!this.g};function Yt(u){return u.g?u.g.readyState:0}s.Z=function(){try{return 2<Yt(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(u){if(this.g){var g=this.g.responseText;return u&&g.indexOf(u)==0&&(g=g.substring(u.length)),Te(g)}};function Aa(u){try{if(!u.g)return null;if("response"in u.g)return u.g.response;switch(u.H){case"":case"text":return u.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in u.g)return u.g.mozResponseArrayBuffer}return null}catch{return null}}function Iu(u){const g={};u=(u.g&&2<=Yt(u)&&u.g.getAllResponseHeaders()||"").split(`\r
`);for(let P=0;P<u.length;P++){if(R(u[P]))continue;var _=F(u[P]);const N=_[0];if(_=_[1],typeof _!="string")continue;_=_.trim();const W=g[N]||[];g[N]=W,W.push(_)}M(g,function(P){return P.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function En(u,g,_){return _&&_.internalChannelParams&&_.internalChannelParams[u]||g}function Ia(u){this.Aa=0,this.i=[],this.j=new mn,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=En("failFast",!1,u),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=En("baseRetryDelayMs",5e3,u),this.cb=En("retryDelaySeedMs",1e4,u),this.Wa=En("forwardChannelMaxRetries",2,u),this.wa=En("forwardChannelRequestTimeoutMs",2e4,u),this.pa=u&&u.xmlHttpFactory||void 0,this.Xa=u&&u.Tb||void 0,this.Ca=u&&u.useFetchStreams||!1,this.L=void 0,this.J=u&&u.supportsCrossDomainXhr||!1,this.K="",this.h=new ha(u&&u.concurrentRequestLimit),this.Da=new Su,this.P=u&&u.fastHandshake||!1,this.O=u&&u.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=u&&u.Rb||!1,u&&u.xa&&this.j.xa(),u&&u.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&u&&u.detectBufferingProxy||!1,this.ja=void 0,u&&u.longPollingTimeout&&0<u.longPollingTimeout&&(this.ja=u.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=Ia.prototype,s.la=8,s.G=1,s.connect=function(u,g,_,P){wt(0),this.W=u,this.H=g||{},_&&P!==void 0&&(this.H.OSID=_,this.H.OAID=P),this.F=this.X,this.I=Ba(this,null,this.W),dr(this)};function Ss(u){if(Ra(u),u.G==3){var g=u.U++,_=Xt(u.I);if(Be(_,"SID",u.K),Be(_,"RID",g),Be(_,"TYPE","terminate"),xn(u,_),g=new ti(u,u.j,g),g.L=2,g.v=ar(Xt(_)),_=!1,a.navigator&&a.navigator.sendBeacon)try{_=a.navigator.sendBeacon(g.v.toString(),"")}catch{}!_&&a.Image&&(new Image().src=g.v,_=!0),_||(g.g=Na(g.j,null),g.g.ea(g.v)),g.F=Date.now(),rr(g)}Va(u)}function ur(u){u.g&&(Cs(u),u.g.cancel(),u.g=null)}function Ra(u){ur(u),u.u&&(a.clearTimeout(u.u),u.u=null),fr(u),u.h.cancel(),u.s&&(typeof u.s=="number"&&a.clearTimeout(u.s),u.s=null)}function dr(u){if(!ua(u.h)&&!u.s){u.s=!0;var g=u.Ga;Me||we(),re||(Me(),re=!0),ve.add(g,u),u.B=0}}function Ru(u,g){return da(u.h)>=u.h.j-(u.s?1:0)?!1:u.s?(u.i=g.D.concat(u.i),!0):u.G==1||u.G==2||u.B>=(u.Va?0:u.Wa)?!1:(u.s=pn(f(u.Ga,u,g),La(u,u.B)),u.B++,!0)}s.Ga=function(u){if(this.s)if(this.s=null,this.G==1){if(!u){this.U=Math.floor(1e5*Math.random()),u=this.U++;const N=new ti(this,this.j,u);let W=this.o;if(this.S&&(W?(W=A(W),k(W,this.S)):W=this.S),this.m!==null||this.O||(N.H=W,W=null),this.P)e:{for(var g=0,_=0;_<this.i.length;_++){t:{var P=this.i[_];if("__data__"in P.map&&(P=P.map.__data__,typeof P=="string")){P=P.length;break t}P=void 0}if(P===void 0)break;if(g+=P,4096<g){g=_;break e}if(g===4096||_===this.i.length-1){g=_+1;break e}}g=1e3}else g=1e3;g=Ma(this,N,g),_=Xt(this.I),Be(_,"RID",u),Be(_,"CVER",22),this.D&&Be(_,"X-HTTP-Session-Id",this.D),xn(this,_),W&&(this.O?g="headers="+encodeURIComponent(String(xa(W)))+"&"+g:this.m&&bs(_,this.m,W)),xs(this.h,N),this.Ua&&Be(_,"TYPE","init"),this.P?(Be(_,"$req",g),Be(_,"SID","null"),N.T=!0,ws(N,_,null)):ws(N,_,g),this.G=2}}else this.G==3&&(u?Da(this,u):this.i.length==0||ua(this.h)||Da(this))};function Da(u,g){var _;g?_=g.l:_=u.U++;const P=Xt(u.I);Be(P,"SID",u.K),Be(P,"RID",_),Be(P,"AID",u.T),xn(u,P),u.m&&u.o&&bs(P,u.m,u.o),_=new ti(u,u.j,_,u.B+1),u.m===null&&(_.H=u.o),g&&(u.i=g.D.concat(u.i)),g=Ma(u,_,1e3),_.I=Math.round(.5*u.wa)+Math.round(.5*u.wa*Math.random()),xs(u.h,_),ws(_,P,g)}function xn(u,g){u.H&&J(u.H,function(_,P){Be(g,P,_)}),u.l&&ma({},function(_,P){Be(g,P,_)})}function Ma(u,g,_){_=Math.min(u.i.length,_);var P=u.l?f(u.l.Na,u.l,u):null;e:{var N=u.i;let W=-1;for(;;){const ee=["count="+_];W==-1?0<_?(W=N[0].g,ee.push("ofs="+W)):W=0:ee.push("ofs="+W);let Le=!0;for(let nt=0;nt<_;nt++){let De=N[nt].g;const ut=N[nt].map;if(De-=W,0>De)W=Math.max(0,N[nt].g-100),Le=!1;else try{Pu(ut,ee,"req"+De+"_")}catch{P&&P(ut)}}if(Le){P=ee.join("&");break e}}}return u=u.i.splice(0,_),g.D=u,P}function ka(u){if(!u.g&&!u.u){u.Y=1;var g=u.Fa;Me||we(),re||(Me(),re=!0),ve.add(g,u),u.v=0}}function Ps(u){return u.g||u.u||3<=u.v?!1:(u.Y++,u.u=pn(f(u.Fa,u),La(u,u.v)),u.v++,!0)}s.Fa=function(){if(this.u=null,Oa(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var u=2*this.R;this.j.info("BP detection timer enabled: "+u),this.A=pn(f(this.ab,this),u)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,wt(10),ur(this),Oa(this))};function Cs(u){u.A!=null&&(a.clearTimeout(u.A),u.A=null)}function Oa(u){u.g=new ti(u,u.j,"rpc",u.Y),u.m===null&&(u.g.H=u.o),u.g.O=0;var g=Xt(u.qa);Be(g,"RID","rpc"),Be(g,"SID",u.K),Be(g,"AID",u.T),Be(g,"CI",u.F?"0":"1"),!u.F&&u.ja&&Be(g,"TO",u.ja),Be(g,"TYPE","xmlhttp"),xn(u,g),u.m&&u.o&&bs(g,u.m,u.o),u.L&&(u.g.I=u.L);var _=u.g;u=u.ia,_.L=1,_.v=ar(Xt(g)),_.m=null,_.P=!0,aa(_,u)}s.Za=function(){this.C!=null&&(this.C=null,ur(this),Ps(this),wt(19))};function fr(u){u.C!=null&&(a.clearTimeout(u.C),u.C=null)}function Fa(u,g){var _=null;if(u.g==g){fr(u),Cs(u),u.g=null;var P=2}else if(Es(u.h,g))_=g.D,fa(u.h,g),P=1;else return;if(u.G!=0){if(g.o)if(P==1){_=g.m?g.m.length:0,g=Date.now()-g.F;var N=u.B;P=_i(),$(P,new na(P,_)),dr(u)}else ka(u);else if(N=g.s,N==3||N==0&&0<g.X||!(P==1&&Ru(u,g)||P==2&&Ps(u)))switch(_&&0<_.length&&(g=u.h,g.i=g.i.concat(_)),N){case 1:xi(u,5);break;case 4:xi(u,10);break;case 3:xi(u,6);break;default:xi(u,2)}}}function La(u,g){let _=u.Ta+Math.floor(Math.random()*u.cb);return u.isActive()||(_*=2),_*g}function xi(u,g){if(u.j.info("Error code "+g),g==2){var _=f(u.fb,u),P=u.Xa;const N=!P;P=new Ei(P||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||sr(P,"https"),ar(P),N?xu(P.toString(),_):bu(P.toString(),_)}else wt(2);u.G=0,u.l&&u.l.sa(g),Va(u),Ra(u)}s.fb=function(u){u?(this.j.info("Successfully pinged google.com"),wt(2)):(this.j.info("Failed to ping google.com"),wt(1))};function Va(u){if(u.G=0,u.ka=[],u.l){const g=pa(u.h);(g.length!=0||u.i.length!=0)&&(w(u.ka,g),w(u.ka,u.i),u.h.i.length=0,v(u.i),u.i.length=0),u.l.ra()}}function Ba(u,g,_){var P=_ instanceof Ei?Xt(_):new Ei(_);if(P.g!="")g&&(P.g=g+"."+P.g),or(P,P.s);else{var N=a.location;P=N.protocol,g=g?g+"."+N.hostname:N.hostname,N=+N.port;var W=new Ei(null);P&&sr(W,P),g&&(W.g=g),N&&or(W,N),_&&(W.l=_),P=W}return _=u.D,g=u.ya,_&&g&&Be(P,_,g),Be(P,"VER",u.la),xn(u,P),P}function Na(u,g,_){if(g&&!u.J)throw Error("Can't create secondary domain capable XhrIo object.");return g=u.Ca&&!u.pa?new qe(new lr({eb:_})):new qe(u.pa),g.Ha(u.J),g}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function Ha(){}s=Ha.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function pr(){}pr.prototype.g=function(u,g){return new St(u,g)};function St(u,g){le.call(this),this.g=new Ia(g),this.l=u,this.h=g&&g.messageUrlParams||null,u=g&&g.messageHeaders||null,g&&g.clientProtocolHeaderRequired&&(u?u["X-Client-Protocol"]="webchannel":u={"X-Client-Protocol":"webchannel"}),this.g.o=u,u=g&&g.initMessageHeaders||null,g&&g.messageContentType&&(u?u["X-WebChannel-Content-Type"]=g.messageContentType:u={"X-WebChannel-Content-Type":g.messageContentType}),g&&g.va&&(u?u["X-WebChannel-Client-Profile"]=g.va:u={"X-WebChannel-Client-Profile":g.va}),this.g.S=u,(u=g&&g.Sb)&&!R(u)&&(this.g.m=u),this.v=g&&g.supportsCrossDomainXhr||!1,this.u=g&&g.sendRawJson||!1,(g=g&&g.httpSessionIdParam)&&!R(g)&&(this.g.D=g,u=this.h,u!==null&&g in u&&(u=this.h,g in u&&delete u[g])),this.j=new Li(this)}m(St,le),St.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},St.prototype.close=function(){Ss(this.g)},St.prototype.o=function(u){var g=this.g;if(typeof u=="string"){var _={};_.__data__=u,u=_}else this.u&&(_={},_.__data__=ce(u),u=_);g.i.push(new fu(g.Ya++,u)),g.G==3&&dr(g)},St.prototype.N=function(){this.g.l=null,delete this.j,Ss(this.g),delete this.g,St.aa.N.call(this)};function za(u){Ft.call(this),u.__headers__&&(this.headers=u.__headers__,this.statusCode=u.__status__,delete u.__headers__,delete u.__status__);var g=u.__sm__;if(g){e:{for(const _ in g){u=_;break e}u=void 0}(this.i=u)&&(u=this.i,g=g!==null&&u in g?g[u]:void 0),this.data=g}else this.data=u}m(za,Ft);function Ua(){Lt.call(this),this.status=1}m(Ua,Lt);function Li(u){this.g=u}m(Li,Ha),Li.prototype.ua=function(){$(this.g,"a")},Li.prototype.ta=function(u){$(this.g,new za(u))},Li.prototype.sa=function(u){$(this.g,new Ua)},Li.prototype.ra=function(){$(this.g,"b")},pr.prototype.createWebChannel=pr.prototype.g,St.prototype.send=St.prototype.o,St.prototype.open=St.prototype.m,St.prototype.close=St.prototype.close,Bc=function(){return new pr},Vc=function(){return _i()},Lc=Zt,Ks={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},ir.NO_ERROR=0,ir.TIMEOUT=8,ir.HTTP_ERROR=6,Cr=ir,ra.COMPLETE="complete",Fc=ra,bt.EventType=Rt,Rt.OPEN="a",Rt.CLOSE="b",Rt.ERROR="c",Rt.MESSAGE="d",le.prototype.listen=le.prototype.K,Cn=bt,qe.prototype.listenOnce=qe.prototype.L,qe.prototype.getLastError=qe.prototype.Ka,qe.prototype.getLastErrorCode=qe.prototype.Ba,qe.prototype.getStatus=qe.prototype.Z,qe.prototype.getResponseJson=qe.prototype.Oa,qe.prototype.getResponseText=qe.prototype.oa,qe.prototype.send=qe.prototype.ea,qe.prototype.setWithCredentials=qe.prototype.Ha,Oc=qe}).apply(typeof _r<"u"?_r:typeof self<"u"?self:typeof window<"u"?window:{});const cl="@firebase/firestore",hl="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mt{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}mt.UNAUTHENTICATED=new mt(null),mt.GOOGLE_CREDENTIALS=new mt("google-credentials-uid"),mt.FIRST_PARTY=new mt("first-party-uid"),mt.MOCK_USER=new mt("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let on="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ii=new Cc("@firebase/firestore");function ji(){return Ii.logLevel}function oe(s,...t){if(Ii.logLevel<=Re.DEBUG){const e=t.map(To);Ii.debug(`Firestore (${on}): ${s}`,...e)}}function $t(s,...t){if(Ii.logLevel<=Re.ERROR){const e=t.map(To);Ii.error(`Firestore (${on}): ${s}`,...e)}}function hi(s,...t){if(Ii.logLevel<=Re.WARN){const e=t.map(To);Ii.warn(`Firestore (${on}): ${s}`,...e)}}function To(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function pe(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,Nc(s,i,e)}function Nc(s,t,e){let i=`FIRESTORE (${on}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw $t(i),new Error(i)}function Oe(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||Nc(t,n,i)}function ye(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const X={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class ne extends sn{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ci{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hc{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Up{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(mt.UNAUTHENTICATED))}shutdown(){}}class jp{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class qp{constructor(t){this.t=t,this.currentUser=mt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){Oe(this.o===void 0,42304);let i=this.i;const n=c=>this.i!==i?(i=this.i,e(c)):Promise.resolve();let r=new Ci;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Ci,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const c=r;t.enqueueRetryable(async()=>{await c.promise,await n(this.currentUser)})},a=c=>{oe("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(c=>a(c)),setTimeout(()=>{if(!this.auth){const c=this.t.getImmediate({optional:!0});c?a(c):(oe("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Ci)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(oe("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(Oe(typeof i.accessToken=="string",31837,{l:i}),new Hc(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return Oe(t===null||typeof t=="string",2055,{h:t}),new mt(t)}}class Wp{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=mt.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Gp{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new Wp(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(mt.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class ul{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Zp{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,Cp(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){Oe(this.o===void 0,3512);const i=r=>{r.error!=null&&oe("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,oe("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{oe("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):oe("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new ul(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(Oe(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new ul(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Xp(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zc(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Eo{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=Xp(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function be(s,t){return s<t?-1:s>t?1:0}function Qs(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return be(i,n);{const r=zc(),o=Yp(r.encode(dl(s,e)),r.encode(dl(t,e)));return o!==0?o:be(i,n)}}e+=i>65535?2:1}return be(s.length,t.length)}function dl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function Yp(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return be(s[e],t[e]);return be(s.length,t.length)}function Qi(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fl="__name__";class Bt{constructor(t,e,i){e===void 0?e=0:e>t.length&&pe(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&pe(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return Bt.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Bt?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=Bt.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return be(t.length,e.length)}static compareSegments(t,e){const i=Bt.isNumericId(t),n=Bt.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?Bt.extractNumericId(t).compare(Bt.extractNumericId(e)):Qs(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return ai.fromString(t.substring(4,t.length-2))}}class Ve extends Bt{construct(t,e,i){return new Ve(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new ne(X.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new Ve(e)}static emptyPath(){return new Ve([])}}const Kp=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ot extends Bt{construct(t,e,i){return new ot(t,e,i)}static isValidIdentifier(t){return Kp.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ot.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===fl}static keyField(){return new ot([fl])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new ne(X.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new ne(X.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const c=t[n+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new ne(X.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=c,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new ne(X.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new ot(e)}static emptyPath(){return new ot([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class de{constructor(t){this.path=t}static fromPath(t){return new de(Ve.fromString(t))}static fromName(t){return new de(Ve.fromString(t).popFirst(5))}static empty(){return new de(Ve.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Ve.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Ve.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new de(new Ve(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Uc(s,t,e){if(!e)throw new ne(X.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function Qp(s,t,e,i){if(t===!0&&i===!0)throw new ne(X.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function pl(s){if(!de.isDocumentKey(s))throw new ne(X.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function ml(s){if(de.isDocumentKey(s))throw new ne(X.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function jc(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function es(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":pe(12329,{type:typeof s})}function li(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new ne(X.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=es(s);throw new ne(X.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ke(s,t){const e={typeString:s};return t&&(e.value=t),e}function Kn(s,t){if(!jc(s))throw new ne(X.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new ne(X.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gl=-62135596800,vl=1e6;class He{static now(){return He.fromMillis(Date.now())}static fromDate(t){return He.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*vl);return new He(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new ne(X.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new ne(X.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<gl)throw new ne(X.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new ne(X.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/vl}_compareTo(t){return this.seconds===t.seconds?be(this.nanoseconds,t.nanoseconds):be(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:He._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(Kn(t,He._jsonSchema))return new He(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-gl;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}He._jsonSchemaVersion="firestore/timestamp/1.0",He._jsonSchema={type:Ke("string",He._jsonSchemaVersion),seconds:Ke("number"),nanoseconds:Ke("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ge{static fromTimestamp(t){return new ge(t)}static min(){return new ge(new He(0,0))}static max(){return new ge(new He(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zn=-1;function Jp(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=ge.fromTimestamp(i===1e9?new He(e+1,0):new He(e,i));return new ui(n,de.empty(),t)}function $p(s){return new ui(s.readTime,s.key,zn)}class ui{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new ui(ge.min(),de.empty(),zn)}static max(){return new ui(ge.max(),de.empty(),zn)}}function em(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=de.comparator(s.documentKey,t.documentKey),e!==0?e:be(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tm="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class im{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function an(s){if(s.code!==X.FAILED_PRECONDITION||s.message!==tm)throw s;oe("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class K{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&pe(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new K((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof K?e:K.resolve(e)}catch(e){return K.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):K.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):K.reject(e)}static resolve(t){return new K((e,i)=>{e(t)})}static reject(t){return new K((e,i)=>{i(t)})}static waitFor(t){return new K((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},c=>i(c))}),o=!0,r===n&&e()})}static or(t){let e=K.resolve(!1);for(const i of t)e=e.next(n=>n?K.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new K((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let c=0;c<r;c++){const h=c;e(t[h]).next(d=>{o[h]=d,++a,a===r&&i(o)},d=>n(d))}})}static doWhile(t,e){return new K((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function nm(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function ln(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ts{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}ts.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xo=-1;function is(s){return s==null}function Ur(s){return s===0&&1/s==-1/0}function rm(s){return typeof s=="number"&&Number.isInteger(s)&&!Ur(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const qc="";function sm(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=yl(t)),t=om(s.get(e),t);return yl(t)}function om(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case qc:e+="";break;default:e+=r}}return e}function yl(s){return s+qc+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wl(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function yi(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function Wc(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class je{constructor(t,e){this.comparator=t,this.root=e||rt.EMPTY}insert(t,e){return new je(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,rt.BLACK,null,null))}remove(t){return new je(this.comparator,this.root.remove(t,this.comparator).copy(null,null,rt.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Tr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Tr(this.root,t,this.comparator,!1)}getReverseIterator(){return new Tr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Tr(this.root,t,this.comparator,!0)}}class Tr{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class rt{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??rt.RED,this.left=n??rt.EMPTY,this.right=r??rt.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new rt(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return rt.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return rt.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,rt.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,rt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw pe(43730,{key:this.key,value:this.value});if(this.right.isRed())throw pe(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw pe(27949);return t+(this.isRed()?0:1)}}rt.EMPTY=null,rt.RED=!0,rt.BLACK=!1;rt.EMPTY=new class{constructor(){this.size=0}get key(){throw pe(57766)}get value(){throw pe(16141)}get color(){throw pe(16727)}get left(){throw pe(29726)}get right(){throw pe(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new rt(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $e{constructor(t){this.comparator=t,this.data=new je(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new _l(this.data.getIterator())}getIteratorFrom(t){return new _l(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof $e)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new $e(this.comparator);return e.data=t,e}}class _l{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pt{constructor(t){this.fields=t,t.sort(ot.comparator)}static empty(){return new Pt([])}unionWith(t){let e=new $e(ot.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new Pt(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Qi(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gc extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class at{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new Gc("Invalid base64 string: "+r):r}}(t);return new at(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new at(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return be(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}at.EMPTY_BYTE_STRING=new at("");const am=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function di(s){if(Oe(!!s,39018),typeof s=="string"){let t=0;const e=am.exec(s);if(Oe(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:We(s.seconds),nanos:We(s.nanos)}}function We(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function fi(s){return typeof s=="string"?at.fromBase64String(s):at.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zc="server_timestamp",Xc="__type__",Yc="__previous_value__",Kc="__local_write_time__";function bo(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[Xc])===null||e===void 0?void 0:e.stringValue)===Zc}function ns(s){const t=s.mapValue.fields[Yc];return bo(t)?ns(t):t}function Un(s){const t=di(s.mapValue.fields[Kc].timestampValue);return new He(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lm{constructor(t,e,i,n,r,o,a,c,h,d){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=c,this.useFetchStreams=h,this.isUsingEmulator=d}}const jr="(default)";class jn{constructor(t,e){this.projectId=t,this.database=e||jr}static empty(){return new jn("","")}get isDefaultDatabase(){return this.database===jr}isEqual(t){return t instanceof jn&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qc="__type__",cm="__max__",Er={mapValue:{}},Jc="__vector__",qr="value";function pi(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?bo(s)?4:um(s)?9007199254740991:hm(s)?10:11:pe(28295,{value:s})}function Wt(s,t){if(s===t)return!0;const e=pi(s);if(e!==pi(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return Un(s).isEqual(Un(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=di(n.timestampValue),a=di(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return fi(n.bytesValue).isEqual(fi(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return We(n.geoPointValue.latitude)===We(r.geoPointValue.latitude)&&We(n.geoPointValue.longitude)===We(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return We(n.integerValue)===We(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=We(n.doubleValue),a=We(r.doubleValue);return o===a?Ur(o)===Ur(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return Qi(s.arrayValue.values||[],t.arrayValue.values||[],Wt);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(wl(o)!==wl(a))return!1;for(const c in o)if(o.hasOwnProperty(c)&&(a[c]===void 0||!Wt(o[c],a[c])))return!1;return!0}(s,t);default:return pe(52216,{left:s})}}function qn(s,t){return(s.values||[]).find(e=>Wt(e,t))!==void 0}function Ji(s,t){if(s===t)return 0;const e=pi(s),i=pi(t);if(e!==i)return be(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return be(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=We(r.integerValue||r.doubleValue),c=We(o.integerValue||o.doubleValue);return a<c?-1:a>c?1:a===c?0:isNaN(a)?isNaN(c)?0:-1:1}(s,t);case 3:return Tl(s.timestampValue,t.timestampValue);case 4:return Tl(Un(s),Un(t));case 5:return Qs(s.stringValue,t.stringValue);case 6:return function(r,o){const a=fi(r),c=fi(o);return a.compareTo(c)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),c=o.split("/");for(let h=0;h<a.length&&h<c.length;h++){const d=be(a[h],c[h]);if(d!==0)return d}return be(a.length,c.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=be(We(r.latitude),We(o.latitude));return a!==0?a:be(We(r.longitude),We(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return El(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,c,h,d;const l=r.fields||{},f=o.fields||{},p=(a=l[qr])===null||a===void 0?void 0:a.arrayValue,m=(c=f[qr])===null||c===void 0?void 0:c.arrayValue,v=be(((h=p==null?void 0:p.values)===null||h===void 0?void 0:h.length)||0,((d=m==null?void 0:m.values)===null||d===void 0?void 0:d.length)||0);return v!==0?v:El(p,m)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===Er.mapValue&&o===Er.mapValue)return 0;if(r===Er.mapValue)return 1;if(o===Er.mapValue)return-1;const a=r.fields||{},c=Object.keys(a),h=o.fields||{},d=Object.keys(h);c.sort(),d.sort();for(let l=0;l<c.length&&l<d.length;++l){const f=Qs(c[l],d[l]);if(f!==0)return f;const p=Ji(a[c[l]],h[d[l]]);if(p!==0)return p}return be(c.length,d.length)}(s.mapValue,t.mapValue);default:throw pe(23264,{le:e})}}function Tl(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return be(s,t);const e=di(s),i=di(t),n=be(e.seconds,i.seconds);return n!==0?n:be(e.nanos,i.nanos)}function El(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=Ji(e[n],i[n]);if(r)return r}return be(e.length,i.length)}function $i(s){return Js(s)}function Js(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=di(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return fi(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return de.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=Js(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${Js(e.fields[o])}`;return n+"}"}(s.mapValue):pe(61005,{value:s})}function Ar(s){switch(pi(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=ns(s);return t?16+Ar(t):16;case 5:return 2*s.stringValue.length;case 6:return fi(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+Ar(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return yi(i.fields,(r,o)=>{n+=r.length+Ar(o)}),n}(s.mapValue);default:throw pe(13486,{value:s})}}function xl(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function $s(s){return!!s&&"integerValue"in s}function So(s){return!!s&&"arrayValue"in s}function bl(s){return!!s&&"nullValue"in s}function Sl(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function Ir(s){return!!s&&"mapValue"in s}function hm(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[Qc])===null||e===void 0?void 0:e.stringValue)===Jc}function kn(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return yi(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=kn(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=kn(s.arrayValue.values[e]);return t}return Object.assign({},s)}function um(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===cm}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tt{constructor(t){this.value=t}static empty(){return new Tt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!Ir(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=kn(e)}setAll(t){let e=ot.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const c=this.getFieldsMap(e);this.applyChanges(c,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=kn(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());Ir(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Wt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];Ir(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){yi(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Tt(kn(this.value))}}function $c(s){const t=[];return yi(s.fields,(e,i)=>{const n=new ot([e]);if(Ir(i)){const r=$c(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new Pt(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gt{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new gt(t,0,ge.min(),ge.min(),ge.min(),Tt.empty(),0)}static newFoundDocument(t,e,i,n){return new gt(t,1,e,ge.min(),i,n,0)}static newNoDocument(t,e){return new gt(t,2,e,ge.min(),ge.min(),Tt.empty(),0)}static newUnknownDocument(t,e){return new gt(t,3,e,ge.min(),ge.min(),Tt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(ge.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Tt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Tt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ge.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof gt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new gt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wr{constructor(t,e){this.position=t,this.inclusive=e}}function Pl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=de.comparator(de.fromName(o.referenceValue),e.key):i=Ji(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function Cl(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!Wt(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wn{constructor(t,e="asc"){this.field=t,this.dir=e}}function dm(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eh{}class Ye extends eh{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new pm(t,e,i):e==="array-contains"?new vm(t,i):e==="in"?new ym(t,i):e==="not-in"?new wm(t,i):e==="array-contains-any"?new _m(t,i):new Ye(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new mm(t,i):new gm(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(Ji(e,this.value)):e!==null&&pi(this.value)===pi(e)&&this.matchesComparison(Ji(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return pe(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Ot extends eh{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new Ot(t,e)}matches(t){return th(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function th(s){return s.op==="and"}function ih(s){return fm(s)&&th(s)}function fm(s){for(const t of s.filters)if(t instanceof Ot)return!1;return!0}function eo(s){if(s instanceof Ye)return s.field.canonicalString()+s.op.toString()+$i(s.value);if(ih(s))return s.filters.map(t=>eo(t)).join(",");{const t=s.filters.map(e=>eo(e)).join(",");return`${s.op}(${t})`}}function nh(s,t){return s instanceof Ye?function(i,n){return n instanceof Ye&&i.op===n.op&&i.field.isEqual(n.field)&&Wt(i.value,n.value)}(s,t):s instanceof Ot?function(i,n){return n instanceof Ot&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&nh(o,n.filters[a]),!0):!1}(s,t):void pe(19439)}function rh(s){return s instanceof Ye?function(e){return`${e.field.canonicalString()} ${e.op} ${$i(e.value)}`}(s):s instanceof Ot?function(e){return e.op.toString()+" {"+e.getFilters().map(rh).join(" ,")+"}"}(s):"Filter"}class pm extends Ye{constructor(t,e,i){super(t,e,i),this.key=de.fromName(i.referenceValue)}matches(t){const e=de.comparator(t.key,this.key);return this.matchesComparison(e)}}class mm extends Ye{constructor(t,e){super(t,"in",e),this.keys=sh("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class gm extends Ye{constructor(t,e){super(t,"not-in",e),this.keys=sh("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function sh(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>de.fromName(i.referenceValue))}class vm extends Ye{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return So(e)&&qn(e.arrayValue,this.value)}}class ym extends Ye{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&qn(this.value.arrayValue,e)}}class wm extends Ye{constructor(t,e){super(t,"not-in",e)}matches(t){if(qn(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!qn(this.value.arrayValue,e)}}class _m extends Ye{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!So(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>qn(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tm{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function Al(s,t=null,e=[],i=[],n=null,r=null,o=null){return new Tm(s,t,e,i,n,r,o)}function Po(s){const t=ye(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>eo(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),is(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>$i(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>$i(i)).join(",")),t.Pe=e}return t.Pe}function Co(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!dm(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!nh(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!Cl(s.startAt,t.startAt)&&Cl(s.endAt,t.endAt)}function to(s){return de.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cn{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=c,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function Em(s,t,e,i,n,r,o,a){return new cn(s,t,e,i,n,r,o,a)}function Ao(s){return new cn(s)}function Il(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function oh(s){return s.collectionGroup!==null}function On(s){const t=ye(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new $e(ot.comparator);return o.filters.forEach(c=>{c.getFlattenedFilters().forEach(h=>{h.isInequality()&&(a=a.add(h.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new Wn(r,i))}),e.has(ot.keyField().canonicalString())||t.Te.push(new Wn(ot.keyField(),i))}return t.Te}function Ht(s){const t=ye(s);return t.Ie||(t.Ie=xm(t,On(s))),t.Ie}function xm(s,t){if(s.limitType==="F")return Al(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new Wn(n.field,r)});const e=s.endAt?new Wr(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new Wr(s.startAt.position,s.startAt.inclusive):null;return Al(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function io(s,t){const e=s.filters.concat([t]);return new cn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function no(s,t,e){return new cn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function rs(s,t){return Co(Ht(s),Ht(t))&&s.limitType===t.limitType}function ah(s){return`${Po(Ht(s))}|lt:${s.limitType}`}function qi(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>rh(n)).join(", ")}]`),is(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>$i(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>$i(n)).join(",")),`Target(${i})`}(Ht(s))}; limitType=${s.limitType})`}function ss(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):de.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of On(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,c){const h=Pl(o,a,c);return o.inclusive?h<=0:h<0}(i.startAt,On(i),n)||i.endAt&&!function(o,a,c){const h=Pl(o,a,c);return o.inclusive?h>=0:h>0}(i.endAt,On(i),n))}(s,t)}function bm(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function lh(s){return(t,e)=>{let i=!1;for(const n of On(s)){const r=Sm(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function Sm(s,t,e){const i=s.field.isKeyField()?de.comparator(t.key,e.key):function(r,o,a){const c=o.data.field(r),h=a.data.field(r);return c!==null&&h!==null?Ji(c,h):pe(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return pe(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Di{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){yi(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return Wc(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pm=new je(de.comparator);function ei(){return Pm}const ch=new je(de.comparator);function An(...s){let t=ch;for(const e of s)t=t.insert(e.key,e);return t}function hh(s){let t=ch;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function Pi(){return Fn()}function uh(){return Fn()}function Fn(){return new Di(s=>s.toString(),(s,t)=>s.isEqual(t))}const Cm=new je(de.comparator),Am=new $e(de.comparator);function Ce(...s){let t=Am;for(const e of s)t=t.add(e);return t}const Im=new $e(be);function Rm(){return Im}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Io(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ur(t)?"-0":t}}function dh(s){return{integerValue:""+s}}function Dm(s,t){return rm(t)?dh(t):Io(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class os{constructor(){this._=void 0}}function Mm(s,t,e){return s instanceof Gr?function(n,r){const o={fields:{[Xc]:{stringValue:Zc},[Kc]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&bo(r)&&(r=ns(r)),r&&(o.fields[Yc]=r),{mapValue:o}}(e,t):s instanceof Gn?ph(s,t):s instanceof Zn?mh(s,t):function(n,r){const o=fh(n,r),a=Rl(o)+Rl(n.Ee);return $s(o)&&$s(n.Ee)?dh(a):Io(n.serializer,a)}(s,t)}function km(s,t,e){return s instanceof Gn?ph(s,t):s instanceof Zn?mh(s,t):e}function fh(s,t){return s instanceof Zr?function(i){return $s(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class Gr extends os{}class Gn extends os{constructor(t){super(),this.elements=t}}function ph(s,t){const e=gh(t);for(const i of s.elements)e.some(n=>Wt(n,i))||e.push(i);return{arrayValue:{values:e}}}class Zn extends os{constructor(t){super(),this.elements=t}}function mh(s,t){let e=gh(t);for(const i of s.elements)e=e.filter(n=>!Wt(n,i));return{arrayValue:{values:e}}}class Zr extends os{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function Rl(s){return We(s.integerValue||s.doubleValue)}function gh(s){return So(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function Om(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof Gn&&n instanceof Gn||i instanceof Zn&&n instanceof Zn?Qi(i.elements,n.elements,Wt):i instanceof Zr&&n instanceof Zr?Wt(i.Ee,n.Ee):i instanceof Gr&&n instanceof Gr}(s.transform,t.transform)}class Fm{constructor(t,e){this.version=t,this.transformResults=e}}class kt{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new kt}static exists(t){return new kt(void 0,t)}static updateTime(t){return new kt(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Rr(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class as{}function vh(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new Ro(s.key,kt.none()):new Qn(s.key,s.data,kt.none());{const e=s.data,i=Tt.empty();let n=new $e(ot.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new wi(s.key,i,new Pt(n.toArray()),kt.none())}}function Lm(s,t,e){s instanceof Qn?function(n,r,o){const a=n.value.clone(),c=Ml(n.fieldTransforms,r,o.transformResults);a.setAll(c),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof wi?function(n,r,o){if(!Rr(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=Ml(n.fieldTransforms,r,o.transformResults),c=r.data;c.setAll(yh(n)),c.setAll(a),r.convertToFoundDocument(o.version,c).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function Ln(s,t,e,i){return s instanceof Qn?function(r,o,a,c){if(!Rr(r.precondition,o))return a;const h=r.value.clone(),d=kl(r.fieldTransforms,c,o);return h.setAll(d),o.convertToFoundDocument(o.version,h).setHasLocalMutations(),null}(s,t,e,i):s instanceof wi?function(r,o,a,c){if(!Rr(r.precondition,o))return a;const h=kl(r.fieldTransforms,c,o),d=o.data;return d.setAll(yh(r)),d.setAll(h),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(l=>l.field))}(s,t,e,i):function(r,o,a){return Rr(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function Vm(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=fh(i.transform,n||null);r!=null&&(e===null&&(e=Tt.empty()),e.set(i.field,r))}return e||null}function Dl(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&Qi(i,n,(r,o)=>Om(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class Qn extends as{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class wi extends as{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function yh(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function Ml(s,t,e){const i=new Map;Oe(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,km(o,a,e[n]))}return i}function kl(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,Mm(r,o,t))}return i}class Ro extends as{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Bm extends as{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nm{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&Lm(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=Ln(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=Ln(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=uh();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const c=vh(o,a);c!==null&&i.set(n.key,c),o.isValidDocument()||o.convertToNoDocument(ge.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Ce())}isEqual(t){return this.batchId===t.batchId&&Qi(this.mutations,t.mutations,(e,i)=>Dl(e,i))&&Qi(this.baseMutations,t.baseMutations,(e,i)=>Dl(e,i))}}class Do{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){Oe(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return Cm}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new Do(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hm{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zm{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ze,Ie;function Um(s){switch(s){case X.OK:return pe(64938);case X.CANCELLED:case X.UNKNOWN:case X.DEADLINE_EXCEEDED:case X.RESOURCE_EXHAUSTED:case X.INTERNAL:case X.UNAVAILABLE:case X.UNAUTHENTICATED:return!1;case X.INVALID_ARGUMENT:case X.NOT_FOUND:case X.ALREADY_EXISTS:case X.PERMISSION_DENIED:case X.FAILED_PRECONDITION:case X.ABORTED:case X.OUT_OF_RANGE:case X.UNIMPLEMENTED:case X.DATA_LOSS:return!0;default:return pe(15467,{code:s})}}function wh(s){if(s===void 0)return $t("GRPC error has no .code"),X.UNKNOWN;switch(s){case Ze.OK:return X.OK;case Ze.CANCELLED:return X.CANCELLED;case Ze.UNKNOWN:return X.UNKNOWN;case Ze.DEADLINE_EXCEEDED:return X.DEADLINE_EXCEEDED;case Ze.RESOURCE_EXHAUSTED:return X.RESOURCE_EXHAUSTED;case Ze.INTERNAL:return X.INTERNAL;case Ze.UNAVAILABLE:return X.UNAVAILABLE;case Ze.UNAUTHENTICATED:return X.UNAUTHENTICATED;case Ze.INVALID_ARGUMENT:return X.INVALID_ARGUMENT;case Ze.NOT_FOUND:return X.NOT_FOUND;case Ze.ALREADY_EXISTS:return X.ALREADY_EXISTS;case Ze.PERMISSION_DENIED:return X.PERMISSION_DENIED;case Ze.FAILED_PRECONDITION:return X.FAILED_PRECONDITION;case Ze.ABORTED:return X.ABORTED;case Ze.OUT_OF_RANGE:return X.OUT_OF_RANGE;case Ze.UNIMPLEMENTED:return X.UNIMPLEMENTED;case Ze.DATA_LOSS:return X.DATA_LOSS;default:return pe(39323,{code:s})}}(Ie=Ze||(Ze={}))[Ie.OK=0]="OK",Ie[Ie.CANCELLED=1]="CANCELLED",Ie[Ie.UNKNOWN=2]="UNKNOWN",Ie[Ie.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ie[Ie.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ie[Ie.NOT_FOUND=5]="NOT_FOUND",Ie[Ie.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ie[Ie.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ie[Ie.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ie[Ie.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ie[Ie.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ie[Ie.ABORTED=10]="ABORTED",Ie[Ie.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ie[Ie.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ie[Ie.INTERNAL=13]="INTERNAL",Ie[Ie.UNAVAILABLE=14]="UNAVAILABLE",Ie[Ie.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const jm=new ai([4294967295,4294967295],0);function Ol(s){const t=zc().encode(s),e=new kc;return e.update(t),new Uint8Array(e.digest())}function Fl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new ai([e,i],0),new ai([n,r],0)]}class Mo{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new In(`Invalid padding: ${e}`);if(i<0)throw new In(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new In(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new In(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=ai.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(ai.fromNumber(i)));return n.compare(jm)===1&&(n=new ai([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=Ol(t),[i,n]=Fl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new Mo(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=Ol(t),[i,n]=Fl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class In extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ls{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,Jn.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new ls(ge.min(),n,new je(be),ei(),Ce())}}class Jn{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new Jn(i,e,Ce(),Ce(),Ce())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dr{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class _h{constructor(t,e){this.targetId=t,this.De=e}}class Th{constructor(t,e,i=at.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class Ll{constructor(){this.ve=0,this.Ce=Vl(),this.Fe=at.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Ce(),e=Ce(),i=Ce();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:pe(38017,{changeType:r})}}),new Jn(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Vl()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,Oe(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class qm{constructor(t){this.We=t,this.Ge=new Map,this.ze=ei(),this.je=xr(),this.Je=xr(),this.He=new je(be)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:pe(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(to(r))if(i===0){const o=new de(r.path);this.Xe(e,o,gt.newNoDocument(o,ge.min()))}else Oe(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),c=a?this.ut(a,t,o):1;if(c!==0){this.rt(e);const h=c===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,h)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=fi(i).toUint8Array()}catch(c){if(c instanceof Gc)return hi("Decoding the base64 bloom filter in existence filter failed ("+c.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw c}try{a=new Mo(o,n,r)}catch(c){return hi(c instanceof In?"BloomFilter error: ":"Applying bloom filter failed: ",c),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&to(a.target)){const c=new de(a.target.path);this.Tt(c).has(o)||this.It(o,c)||this.Xe(o,c,gt.newNoDocument(c,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Ce();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(c=>{const h=this.st(c);return!h||h.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new ls(t,e,this.He,this.ze,i);return this.ze=ei(),this.je=xr(),this.Je=xr(),this.He=new je(be),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new Ll,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new $e(be),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new $e(be),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||oe("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new Ll),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function xr(){return new je(de.comparator)}function Vl(){return new je(de.comparator)}const Wm={asc:"ASCENDING",desc:"DESCENDING"},Gm={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Zm={and:"AND",or:"OR"};class Xm{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function ro(s,t){return s.useProto3Json||is(t)?t:{value:t}}function Xr(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Eh(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function Ym(s,t){return Xr(s,t.toTimestamp())}function zt(s){return Oe(!!s,49232),ge.fromTimestamp(function(e){const i=di(e);return new He(i.seconds,i.nanos)}(s))}function ko(s,t){return so(s,t).canonicalString()}function so(s,t){const e=function(n){return new Ve(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function xh(s){const t=Ve.fromString(s);return Oe(Ah(t),10190,{key:t.toString()}),t}function oo(s,t){return ko(s.databaseId,t.path)}function Hs(s,t){const e=xh(t);if(e.get(1)!==s.databaseId.projectId)throw new ne(X.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new ne(X.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new de(Sh(e))}function bh(s,t){return ko(s.databaseId,t)}function Km(s){const t=xh(s);return t.length===4?Ve.emptyPath():Sh(t)}function ao(s){return new Ve(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function Sh(s){return Oe(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Bl(s,t,e){return{name:oo(s,t),fields:e.value.mapValue.fields}}function Qm(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(h){return h==="NO_CHANGE"?0:h==="ADD"?1:h==="REMOVE"?2:h==="CURRENT"?3:h==="RESET"?4:pe(39313,{state:h})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(h,d){return h.useProto3Json?(Oe(d===void 0||typeof d=="string",58123),at.fromBase64String(d||"")):(Oe(d===void 0||d instanceof Buffer||d instanceof Uint8Array,16193),at.fromUint8Array(d||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(h){const d=h.code===void 0?X.UNKNOWN:wh(h.code);return new ne(d,h.message||"")}(o);e=new Th(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=Hs(s,i.document.name),r=zt(i.document.updateTime),o=i.document.createTime?zt(i.document.createTime):ge.min(),a=new Tt({mapValue:{fields:i.document.fields}}),c=gt.newFoundDocument(n,r,o,a),h=i.targetIds||[],d=i.removedTargetIds||[];e=new Dr(h,d,c.key,c)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=Hs(s,i.document),r=i.readTime?zt(i.readTime):ge.min(),o=gt.newNoDocument(n,r),a=i.removedTargetIds||[];e=new Dr([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=Hs(s,i.document),r=i.removedTargetIds||[];e=new Dr([],r,n,null)}else{if(!("filter"in t))return pe(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new zm(n,r),a=i.targetId;e=new _h(a,o)}}return e}function Jm(s,t){let e;if(t instanceof Qn)e={update:Bl(s,t.key,t.value)};else if(t instanceof Ro)e={delete:oo(s,t.key)};else if(t instanceof wi)e={update:Bl(s,t.key,t.data),updateMask:ag(t.fieldMask)};else{if(!(t instanceof Bm))return pe(16599,{Rt:t.type});e={verify:oo(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof Gr)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof Gn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Zn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof Zr)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw pe(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:Ym(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:pe(27497)}(s,t.precondition)),e}function $m(s,t){return s&&s.length>0?(Oe(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?zt(n.updateTime):zt(r);return o.isEqual(ge.min())&&(o=zt(r)),new Fm(o,n.transformResults||[])}(e,t))):[]}function eg(s,t){return{documents:[bh(s,t.path)]}}function tg(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=bh(s,n);const r=function(h){if(h.length!==0)return Ch(Ot.create(h,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(h){if(h.length!==0)return h.map(d=>function(f){return{field:Wi(f.field),direction:rg(f.dir)}}(d))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=ro(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(h){return{before:h.inclusive,values:h.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(h){return{before:!h.inclusive,values:h.position}}(t.endAt)),{Vt:e,parent:n}}function ig(s){let t=Km(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){Oe(i===1,65062);const d=e.from[0];d.allDescendants?n=d.collectionId:t=t.child(d.collectionId)}let r=[];e.where&&(r=function(l){const f=Ph(l);return f instanceof Ot&&ih(f)?f.getFilters():[f]}(e.where));let o=[];e.orderBy&&(o=function(l){return l.map(f=>function(m){return new Wn(Gi(m.field),function(w){switch(w){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(m.direction))}(f))}(e.orderBy));let a=null;e.limit&&(a=function(l){let f;return f=typeof l=="object"?l.value:l,is(f)?null:f}(e.limit));let c=null;e.startAt&&(c=function(l){const f=!!l.before,p=l.values||[];return new Wr(p,f)}(e.startAt));let h=null;return e.endAt&&(h=function(l){const f=!l.before,p=l.values||[];return new Wr(p,f)}(e.endAt)),Em(t,n,o,r,a,"F",c,h)}function ng(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return pe(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Ph(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=Gi(e.unaryFilter.field);return Ye.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=Gi(e.unaryFilter.field);return Ye.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Gi(e.unaryFilter.field);return Ye.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Gi(e.unaryFilter.field);return Ye.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return pe(61313);default:return pe(60726)}}(s):s.fieldFilter!==void 0?function(e){return Ye.create(Gi(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return pe(58110);default:return pe(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return Ot.create(e.compositeFilter.filters.map(i=>Ph(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return pe(1026)}}(e.compositeFilter.op))}(s):pe(30097,{filter:s})}function rg(s){return Wm[s]}function sg(s){return Gm[s]}function og(s){return Zm[s]}function Wi(s){return{fieldPath:s.canonicalString()}}function Gi(s){return ot.fromServerFormat(s.fieldPath)}function Ch(s){return s instanceof Ye?function(e){if(e.op==="=="){if(Sl(e.value))return{unaryFilter:{field:Wi(e.field),op:"IS_NAN"}};if(bl(e.value))return{unaryFilter:{field:Wi(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Sl(e.value))return{unaryFilter:{field:Wi(e.field),op:"IS_NOT_NAN"}};if(bl(e.value))return{unaryFilter:{field:Wi(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Wi(e.field),op:sg(e.op),value:e.value}}}(s):s instanceof Ot?function(e){const i=e.getFilters().map(n=>Ch(n));return i.length===1?i[0]:{compositeFilter:{op:og(e.op),filters:i}}}(s):pe(54877,{filter:s})}function ag(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Ah(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ri{constructor(t,e,i,n,r=ge.min(),o=ge.min(),a=at.EMPTY_BYTE_STRING,c=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=c}withSequenceNumber(t){return new ri(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new ri(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new ri(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new ri(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lg{constructor(t){this.gt=t}}function cg(s){const t=ig({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?no(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hg{constructor(){this.Dn=new ug}addToCollectionParentIndex(t,e){return this.Dn.add(e),K.resolve()}getCollectionParents(t,e){return K.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return K.resolve()}deleteFieldIndex(t,e){return K.resolve()}deleteAllFieldIndexes(t){return K.resolve()}createTargetIndexes(t,e){return K.resolve()}getDocumentsMatchingTarget(t,e){return K.resolve(null)}getIndexType(t,e){return K.resolve(0)}getFieldIndexes(t,e){return K.resolve([])}getNextCollectionGroupToUpdate(t){return K.resolve(null)}getMinOffset(t,e){return K.resolve(ui.min())}getMinOffsetFromCollectionGroup(t,e){return K.resolve(ui.min())}updateCollectionGroup(t,e,i){return K.resolve()}updateIndexEntries(t,e){return K.resolve()}}class ug{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new $e(Ve.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new $e(Ve.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Nl={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Ih=41943040;class _t{static withCacheSize(t){return new _t(t,_t.DEFAULT_COLLECTION_PERCENTILE,_t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */_t.DEFAULT_COLLECTION_PERCENTILE=10,_t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,_t.DEFAULT=new _t(Ih,_t.DEFAULT_COLLECTION_PERCENTILE,_t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),_t.DISABLED=new _t(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class en{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new en(0)}static ur(){return new en(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hl="LruGarbageCollector",dg=1048576;function zl([s,t],[e,i]){const n=be(s,e);return n===0?be(t,i):n}class fg{constructor(t){this.Tr=t,this.buffer=new $e(zl),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();zl(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class pg{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){oe(Hl,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ln(e)?oe(Hl,"Ignoring IndexedDB error during garbage collection: ",e):await an(e)}await this.Rr(3e5)})}}class mg{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return K.resolve(ts.ue);const i=new fg(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(oe("LruGarbageCollector","Garbage collection skipped; disabled"),K.resolve(Nl)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(oe("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Nl):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,c,h;const d=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(l=>(l>this.params.maximumSequenceNumbersToCollect?(oe("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${l}`),n=this.params.maximumSequenceNumbersToCollect):n=l,o=Date.now(),this.nthSequenceNumber(t,n))).next(l=>(i=l,a=Date.now(),this.removeTargets(t,i,e))).next(l=>(r=l,c=Date.now(),this.removeOrphanedDocuments(t,i))).next(l=>(h=Date.now(),ji()<=Re.DEBUG&&oe("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(c-a)+`ms
	Removed ${l} documents in `+(h-c)+`ms
Total Duration: ${h-d}ms`),K.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:l})))}}function gg(s,t){return new mg(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vg{constructor(){this.changes=new Di(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,gt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?K.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yg{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wg{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&Ln(i.mutation,n,Pt.empty(),He.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Ce()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Ce()){const n=Pi();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=An();return r.forEach((a,c)=>{o=o.insert(a,c.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=Pi();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Ce()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=ei();const o=Fn(),a=function(){return Fn()}();return e.forEach((c,h)=>{const d=i.get(h.key);n.has(h.key)&&(d===void 0||d.mutation instanceof wi)?r=r.insert(h.key,h):d!==void 0?(o.set(h.key,d.mutation.getFieldMask()),Ln(d.mutation,h,d.mutation.getFieldMask(),He.now())):o.set(h.key,Pt.empty())}),this.recalculateAndSaveOverlays(t,r).next(c=>(c.forEach((h,d)=>o.set(h,d)),e.forEach((h,d)=>{var l;return a.set(h,new yg(d,(l=o.get(h))!==null&&l!==void 0?l:null))}),a))}recalculateAndSaveOverlays(t,e){const i=Fn();let n=new je((o,a)=>o-a),r=Ce();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(c=>{const h=e.get(c);if(h===null)return;let d=i.get(c)||Pt.empty();d=a.applyToLocalView(h,d),i.set(c,d);const l=(n.get(a.batchId)||Ce()).add(c);n=n.insert(a.batchId,l)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const c=a.getNext(),h=c.key,d=c.value,l=uh();d.forEach(f=>{if(!r.has(f)){const p=vh(e.get(f),i.get(f));p!==null&&l.set(f,p),r=r.add(f)}}),o.push(this.documentOverlayCache.saveOverlays(t,h,l))}return K.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return de.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):oh(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):K.resolve(Pi());let a=zn,c=r;return o.next(h=>K.forEach(h,(d,l)=>(a<l.largestBatchId&&(a=l.largestBatchId),r.get(d)?K.resolve():this.remoteDocumentCache.getEntry(t,d).next(f=>{c=c.insert(d,f)}))).next(()=>this.populateOverlays(t,h,r)).next(()=>this.computeViews(t,c,h,Ce())).next(d=>({batchId:a,changes:hh(d)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new de(e)).next(i=>{let n=An();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=An();return this.indexManager.getCollectionParents(t,r).next(a=>K.forEach(a,c=>{const h=function(l,f){return new cn(f,null,l.explicitOrderBy.slice(),l.filters.slice(),l.limit,l.limitType,l.startAt,l.endAt)}(e,c.child(r));return this.getDocumentsMatchingCollectionQuery(t,h,i,n).next(d=>{d.forEach((l,f)=>{o=o.insert(l,f)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((c,h)=>{const d=h.getKey();o.get(d)===null&&(o=o.insert(d,gt.newInvalidDocument(d)))});let a=An();return o.forEach((c,h)=>{const d=r.get(c);d!==void 0&&Ln(d.mutation,h,Pt.empty(),He.now()),ss(e,h)&&(a=a.insert(c,h))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _g{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return K.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:zt(n.createTime)}}(e)),K.resolve()}getNamedQuery(t,e){return K.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:cg(n.bundledQuery),readTime:zt(n.readTime)}}(e)),K.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tg{constructor(){this.overlays=new je(de.comparator),this.kr=new Map}getOverlay(t,e){return K.resolve(this.overlays.get(e))}getOverlays(t,e){const i=Pi();return K.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),K.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),K.resolve()}getOverlaysForCollection(t,e,i){const n=Pi(),r=e.length+1,o=new de(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const c=a.getNext().value,h=c.getKey();if(!e.isPrefixOf(h.path))break;h.path.length===r&&c.largestBatchId>i&&n.set(c.getKey(),c)}return K.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new je((h,d)=>h-d);const o=this.overlays.getIterator();for(;o.hasNext();){const h=o.getNext().value;if(h.getKey().getCollectionGroup()===e&&h.largestBatchId>i){let d=r.get(h.largestBatchId);d===null&&(d=Pi(),r=r.insert(h.largestBatchId,d)),d.set(h.getKey(),h)}}const a=Pi(),c=r.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((h,d)=>a.set(h,d)),!(a.size()>=n)););return K.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new Hm(e,i));let r=this.kr.get(e);r===void 0&&(r=Ce(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Eg{constructor(){this.sessionToken=at.EMPTY_BYTE_STRING}getSessionToken(t){return K.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,K.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Oo{constructor(){this.qr=new $e(et.Qr),this.$r=new $e(et.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new et(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new et(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new de(new Ve([])),i=new et(e,t),n=new et(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new de(new Ve([])),i=new et(e,t),n=new et(e,t+1);let r=Ce();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new et(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class et{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return de.comparator(t.key,e.key)||be(t.Hr,e.Hr)}static Ur(t,e){return be(t.Hr,e.Hr)||de.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xg{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new $e(et.Qr)}checkEmpty(t){return K.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new Nm(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new et(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return K.resolve(o)}lookupMutationBatch(t,e){return K.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return K.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return K.resolve(this.mutationQueue.length===0?xo:this.er-1)}getAllMutationBatches(t){return K.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new et(e,0),n=new et(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),K.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new $e(be);return e.forEach(n=>{const r=new et(n,0),o=new et(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),K.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;de.isDocumentKey(r)||(r=r.child(""));const o=new et(new de(r),0);let a=new $e(be);return this.Yr.forEachWhile(c=>{const h=c.key.path;return!!i.isPrefixOf(h)&&(h.length===n&&(a=a.add(c.Hr)),!0)},o),K.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){Oe(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return K.forEach(e.mutations,n=>{const r=new et(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new et(e,0),n=this.Yr.firstAfterOrEqual(i);return K.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,K.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bg{constructor(t){this.ni=t,this.docs=function(){return new je(de.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return K.resolve(i?i.document.mutableCopy():gt.newInvalidDocument(e))}getEntries(t,e){let i=ei();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():gt.newInvalidDocument(n))}),K.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=ei();const o=e.path,a=new de(o.child("__id-9223372036854775808__")),c=this.docs.getIteratorFrom(a);for(;c.hasNext();){const{key:h,value:{document:d}}=c.getNext();if(!o.isPrefixOf(h.path))break;h.path.length>o.length+1||em($p(d),i)<=0||(n.has(d.key)||ss(e,d))&&(r=r.insert(d.key,d.mutableCopy()))}return K.resolve(r)}getAllFromCollectionGroup(t,e,i,n){pe(9500)}ri(t,e){return K.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new Sg(this)}getSize(t){return K.resolve(this.size)}}class Sg extends vg{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),K.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pg{constructor(t){this.persistence=t,this.ii=new Di(e=>Po(e),Co),this.lastRemoteSnapshotVersion=ge.min(),this.highestTargetId=0,this.si=0,this.oi=new Oo,this.targetCount=0,this._i=en.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),K.resolve()}getLastRemoteSnapshotVersion(t){return K.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return K.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),K.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),K.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new en(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,K.resolve()}updateTargetData(t,e){return this.hr(e),K.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,K.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),K.waitFor(r).next(()=>n)}getTargetCount(t){return K.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return K.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),K.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),K.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),K.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return K.resolve(i)}containsKey(t,e){return K.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rh{constructor(t,e){this.ai={},this.overlays={},this.ui=new ts(0),this.ci=!1,this.ci=!0,this.li=new Eg,this.referenceDelegate=t(this),this.hi=new Pg(this),this.indexManager=new hg,this.remoteDocumentCache=function(n){return new bg(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new lg(e),this.Ti=new _g(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Tg,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new xg(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){oe("MemoryPersistence","Starting transaction:",t);const n=new Cg(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return K.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class Cg extends im{constructor(t){super(),this.currentSequenceNumber=t}}class Fo{constructor(t){this.persistence=t,this.Ai=new Oo,this.Ri=null}static Vi(t){return new Fo(t)}get mi(){if(this.Ri)return this.Ri;throw pe(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),K.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),K.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),K.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return K.forEach(this.mi,i=>{const n=de.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,ge.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return K.or([()=>K.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class Yr{constructor(t,e){this.persistence=t,this.gi=new Di(i=>sm(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=gg(this,e)}static Vi(t,e){return new Yr(t,e)}Ii(){}di(t){return K.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return K.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?K.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,ge.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),K.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),K.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),K.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),K.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=Ar(t.data.value)),e}Sr(t,e,i){return K.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return K.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lo{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Ce(),n=Ce();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new Lo(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ag{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ig{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return bf()?8:nm(Ef())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new Ag;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(ji()<=Re.DEBUG&&oe("QueryEngine","SDK will not create cache indexes for query:",qi(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),K.resolve()):(ji()<=Re.DEBUG&&oe("QueryEngine","Query:",qi(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(ji()<=Re.DEBUG&&oe("QueryEngine","The SDK decides to create cache indexes for query:",qi(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Ht(e))):K.resolve())}ps(t,e){if(Il(e))return K.resolve(null);let i=Ht(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=no(e,null,"F"),i=Ht(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Ce(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(c=>{const h=this.bs(e,a);return this.Ds(e,h,o,c.readTime)?this.ps(t,no(e,null,"F")):this.vs(t,h,e,c)}))})))}ys(t,e,i,n){return Il(e)||n.isEqual(ge.min())?K.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?K.resolve(null):(ji()<=Re.DEBUG&&oe("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),qi(e)),this.vs(t,o,e,Jp(n,zn)).next(a=>a))})}bs(t,e){let i=new $e(lh(t));return e.forEach((n,r)=>{ss(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return ji()<=Re.DEBUG&&oe("QueryEngine","Using full collection scan to execute query:",qi(e)),this.gs.getDocumentsMatchingQuery(t,e,ui.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vo="LocalStore",Rg=3e8;class Dg{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new je(be),this.Ms=new Di(r=>Po(r),Co),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new wg(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function Mg(s,t,e,i){return new Dg(s,t,e,i)}async function Dh(s,t){const e=ye(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let c=Ce();for(const h of n){o.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}for(const h of r){a.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}return e.localDocuments.getDocuments(i,c).next(h=>({Bs:h,removedBatchIds:o,addedBatchIds:a}))})})}function kg(s,t){const e=ye(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,c,h,d){const l=h.batch,f=l.keys();let p=K.resolve();return f.forEach(m=>{p=p.next(()=>d.getEntry(c,m)).next(v=>{const w=h.docVersions.get(m);Oe(w!==null,48541),v.version.compareTo(w)<0&&(l.applyToRemoteDocument(v,h),v.isValidDocument()&&(v.setReadTime(h.commitVersion),d.addEntry(v)))})}),p.next(()=>a.mutationQueue.removeMutationBatch(c,l))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let c=Ce();for(let h=0;h<a.mutationResults.length;++h)a.mutationResults[h].transformResults.length>0&&(c=c.add(a.batch.mutations[h].key));return c}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function Mh(s){const t=ye(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function Og(s,t){const e=ye(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((d,l)=>{const f=n.get(l);if(!f)return;a.push(e.hi.removeMatchingKeys(r,d.removedDocuments,l).next(()=>e.hi.addMatchingKeys(r,d.addedDocuments,l)));let p=f.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(l)!==null?p=p.withResumeToken(at.EMPTY_BYTE_STRING,ge.min()).withLastLimboFreeSnapshotVersion(ge.min()):d.resumeToken.approximateByteSize()>0&&(p=p.withResumeToken(d.resumeToken,i)),n=n.insert(l,p),function(v,w,x){return v.resumeToken.approximateByteSize()===0||w.snapshotVersion.toMicroseconds()-v.snapshotVersion.toMicroseconds()>=Rg?!0:x.addedDocuments.size+x.modifiedDocuments.size+x.removedDocuments.size>0}(f,p,d)&&a.push(e.hi.updateTargetData(r,p))});let c=ei(),h=Ce();if(t.documentUpdates.forEach(d=>{t.resolvedLimboDocuments.has(d)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,d))}),a.push(Fg(r,o,t.documentUpdates).next(d=>{c=d.Ls,h=d.ks})),!i.isEqual(ge.min())){const d=e.hi.getLastRemoteSnapshotVersion(r).next(l=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(d)}return K.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,c,h)).next(()=>c)}).then(r=>(e.Fs=n,r))}function Fg(s,t,e){let i=Ce(),n=Ce();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=ei();return e.forEach((a,c)=>{const h=r.get(a);c.isFoundDocument()!==h.isFoundDocument()&&(n=n.add(a)),c.isNoDocument()&&c.version.isEqual(ge.min())?(t.removeEntry(a,c.readTime),o=o.insert(a,c)):!h.isValidDocument()||c.version.compareTo(h.version)>0||c.version.compareTo(h.version)===0&&h.hasPendingWrites?(t.addEntry(c),o=o.insert(a,c)):oe(Vo,"Ignoring outdated watch update for ",a,". Current version:",h.version," Watch version:",c.version)}),{Ls:o,ks:n}})}function Lg(s,t){const e=ye(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=xo),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function Vg(s,t){const e=ye(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,K.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new ri(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function lo(s,t,e){const i=ye(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!ln(o))throw o;oe(Vo,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function Ul(s,t,e){const i=ye(s);let n=ge.min(),r=Ce();return i.persistence.runTransaction("Execute query","readwrite",o=>function(c,h,d){const l=ye(c),f=l.Ms.get(d);return f!==void 0?K.resolve(l.Fs.get(f)):l.hi.getTargetData(h,d)}(i,o,Ht(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(c=>{r=c})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:ge.min(),e?r:Ce())).next(a=>(Bg(i,bm(t),a),{documents:a,qs:r})))}function Bg(s,t,e){let i=s.xs.get(t)||ge.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class jl{constructor(){this.activeTargetIds=Rm()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Ng{constructor(){this.Fo=new jl,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new jl,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hg{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ql="ConnectivityMonitor";class Wl{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){oe(ql,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){oe(ql,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let br=null;function co(){return br===null?br=function(){return 268435456+Math.round(2147483648*Math.random())}():br++,"0x"+br.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zs="RestConnection",zg={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Ug{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===jr?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=co(),a=this.Go(t,e.toUriEncodedString());oe(zs,`Sending RPC '${t}' ${o}:`,a,i);const c={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(c,n,r);const{host:h}=new URL(a),d=wo(h);return this.jo(t,a,c,i,d).then(l=>(oe(zs,`Received RPC '${t}' ${o}: `,l),l),l=>{throw hi(zs,`RPC '${t}' ${o} failed with error: `,l,"url: ",a,"request:",i),l})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+on}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=zg[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jg{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ft="WebChannelConnection";class qg extends Ug{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=co();return new Promise((a,c)=>{const h=new Oc;h.setWithCredentials(!0),h.listenOnce(Fc.COMPLETE,()=>{try{switch(h.getLastErrorCode()){case Cr.NO_ERROR:const l=h.getResponseJson();oe(ft,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(l)),a(l);break;case Cr.TIMEOUT:oe(ft,`RPC '${t}' ${o} timed out`),c(new ne(X.DEADLINE_EXCEEDED,"Request time out"));break;case Cr.HTTP_ERROR:const f=h.getStatus();if(oe(ft,`RPC '${t}' ${o} failed with status:`,f,"response text:",h.getResponseText()),f>0){let p=h.getResponseJson();Array.isArray(p)&&(p=p[0]);const m=p==null?void 0:p.error;if(m&&m.status&&m.message){const v=function(x){const R=x.toLowerCase().replace(/_/g,"-");return Object.values(X).indexOf(R)>=0?R:X.UNKNOWN}(m.status);c(new ne(v,m.message))}else c(new ne(X.UNKNOWN,"Server responded with status "+h.getStatus()))}else c(new ne(X.UNAVAILABLE,"Connection failed."));break;default:pe(9055,{c_:t,streamId:o,l_:h.getLastErrorCode(),h_:h.getLastError()})}}finally{oe(ft,`RPC '${t}' ${o} completed.`)}});const d=JSON.stringify(n);oe(ft,`RPC '${t}' ${o} sending request:`,n),h.send(e,"POST",d,i,15)})}P_(t,e,i){const n=co(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=Bc(),a=Vc(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},h=this.longPollingOptions.timeoutSeconds;h!==void 0&&(c.longPollingTimeout=Math.round(1e3*h)),this.useFetchStreams&&(c.useFetchStreams=!0),this.zo(c.initMessageHeaders,e,i),c.encodeInitMessageHeaders=!0;const d=r.join("");oe(ft,`Creating RPC '${t}' stream ${n}: ${d}`,c);const l=o.createWebChannel(d,c);this.T_(l);let f=!1,p=!1;const m=new jg({Ho:w=>{p?oe(ft,`Not sending because RPC '${t}' stream ${n} is closed:`,w):(f||(oe(ft,`Opening RPC '${t}' stream ${n} transport.`),l.open(),f=!0),oe(ft,`RPC '${t}' stream ${n} sending:`,w),l.send(w))},Yo:()=>l.close()}),v=(w,x,R)=>{w.listen(x,L=>{try{R(L)}catch(j){setTimeout(()=>{throw j},0)}})};return v(l,Cn.EventType.OPEN,()=>{p||(oe(ft,`RPC '${t}' stream ${n} transport opened.`),m.s_())}),v(l,Cn.EventType.CLOSE,()=>{p||(p=!0,oe(ft,`RPC '${t}' stream ${n} transport closed`),m.__(),this.I_(l))}),v(l,Cn.EventType.ERROR,w=>{p||(p=!0,hi(ft,`RPC '${t}' stream ${n} transport errored. Name:`,w.name,"Message:",w.message),m.__(new ne(X.UNAVAILABLE,"The operation could not be completed")))}),v(l,Cn.EventType.MESSAGE,w=>{var x;if(!p){const R=w.data[0];Oe(!!R,16349);const L=R,j=(L==null?void 0:L.error)||((x=L[0])===null||x===void 0?void 0:x.error);if(j){oe(ft,`RPC '${t}' stream ${n} received error:`,j);const G=j.status;let J=function(C){const k=Ze[C];if(k!==void 0)return wh(k)}(G),M=j.message;J===void 0&&(J=X.INTERNAL,M="Unknown error status: "+G+" with message "+j.message),p=!0,m.__(new ne(J,M)),l.close()}else oe(ft,`RPC '${t}' stream ${n} received:`,R),m.a_(R)}}),v(a,Lc.STAT_EVENT,w=>{w.stat===Ks.PROXY?oe(ft,`RPC '${t}' stream ${n} detected buffering proxy`):w.stat===Ks.NOPROXY&&oe(ft,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{m.o_()},0),m}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function Us(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function cs(s){return new Xm(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kh{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&oe("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Gl="PersistentStream";class Oh{constructor(t,e,i,n,r,o,a,c){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=c,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new kh(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===X.RESOURCE_EXHAUSTED?($t(e.toString()),$t("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===X.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new ne(X.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return oe(Gl,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(oe(Gl,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Wg extends Oh{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=Qm(this.serializer,t),i=function(r){if(!("targetChange"in r))return ge.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?ge.min():o.readTime?zt(o.readTime):ge.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=ao(this.serializer),e.addTarget=function(r,o){let a;const c=o.target;if(a=to(c)?{documents:eg(r,c)}:{query:tg(r,c).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Eh(r,o.resumeToken);const h=ro(r,o.expectedCount);h!==null&&(a.expectedCount=h)}else if(o.snapshotVersion.compareTo(ge.min())>0){a.readTime=Xr(r,o.snapshotVersion.toTimestamp());const h=ro(r,o.expectedCount);h!==null&&(a.expectedCount=h)}return a}(this.serializer,t);const i=ng(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=ao(this.serializer),e.removeTarget=t,this.k_(e)}}class Gg extends Oh{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return Oe(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,Oe(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){Oe(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=$m(t.writeResults,t.commitTime),i=zt(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=ao(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>Jm(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zg{}class Xg extends Zg{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new ne(X.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,so(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===X.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new ne(X.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,so(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===X.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new ne(X.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class Yg{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?($t(e),this._a=!1):oe("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ri="RemoteStore";class Kg{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{Mi(this)&&(oe(Ri,"Restarting streams for network reachability change."),await async function(c){const h=ye(c);h.Ia.add(4),await $n(h),h.Aa.set("Unknown"),h.Ia.delete(4),await hs(h)}(this))})}),this.Aa=new Yg(i,n)}}async function hs(s){if(Mi(s))for(const t of s.da)await t(!0)}async function $n(s){for(const t of s.da)await t(!1)}function Fh(s,t){const e=ye(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),zo(e)?Ho(e):hn(e).x_()&&No(e,t))}function Bo(s,t){const e=ye(s),i=hn(e);e.Ta.delete(t),i.x_()&&Lh(e,t),e.Ta.size===0&&(i.x_()?i.B_():Mi(e)&&e.Aa.set("Unknown"))}function No(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(ge.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}hn(s).H_(t)}function Lh(s,t){s.Ra.$e(t),hn(s).Y_(t)}function Ho(s){s.Ra=new qm({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),hn(s).start(),s.Aa.aa()}function zo(s){return Mi(s)&&!hn(s).M_()&&s.Ta.size>0}function Mi(s){return ye(s).Ia.size===0}function Vh(s){s.Ra=void 0}async function Qg(s){s.Aa.set("Online")}async function Jg(s){s.Ta.forEach((t,e)=>{No(s,t)})}async function $g(s,t){Vh(s),zo(s)?(s.Aa.la(t),Ho(s)):s.Aa.set("Unknown")}async function ev(s,t,e){if(s.Aa.set("Online"),t instanceof Th&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){oe(Ri,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await Kr(s,i)}else if(t instanceof Dr?s.Ra.Ye(t):t instanceof _h?s.Ra.it(t):s.Ra.et(t),!e.isEqual(ge.min()))try{const i=await Mh(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((c,h)=>{if(c.resumeToken.approximateByteSize()>0){const d=r.Ta.get(h);d&&r.Ta.set(h,d.withResumeToken(c.resumeToken,o))}}),a.targetMismatches.forEach((c,h)=>{const d=r.Ta.get(c);if(!d)return;r.Ta.set(c,d.withResumeToken(at.EMPTY_BYTE_STRING,d.snapshotVersion)),Lh(r,c);const l=new ri(d.target,c,h,d.sequenceNumber);No(r,l)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){oe(Ri,"Failed to raise snapshot:",i),await Kr(s,i)}}async function Kr(s,t,e){if(!ln(t))throw t;s.Ia.add(1),await $n(s),s.Aa.set("Offline"),e||(e=()=>Mh(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{oe(Ri,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await hs(s)})}function Bh(s,t){return t().catch(e=>Kr(s,e,t))}async function us(s){const t=ye(s),e=mi(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:xo;for(;tv(t);)try{const n=await Lg(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,iv(t,n)}catch(n){await Kr(t,n)}Nh(t)&&Hh(t)}function tv(s){return Mi(s)&&s.Pa.length<10}function iv(s,t){s.Pa.push(t);const e=mi(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function Nh(s){return Mi(s)&&!mi(s).M_()&&s.Pa.length>0}function Hh(s){mi(s).start()}async function nv(s){mi(s).na()}async function rv(s){const t=mi(s);for(const e of s.Pa)t.X_(e.mutations)}async function sv(s,t,e){const i=s.Pa.shift(),n=Do.from(i,t,e);await Bh(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await us(s)}async function ov(s,t){t&&mi(s).Z_&&await async function(i,n){if(function(o){return Um(o)&&o!==X.ABORTED}(n.code)){const r=i.Pa.shift();mi(i).N_(),await Bh(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await us(i)}}(s,t),Nh(s)&&Hh(s)}async function Zl(s,t){const e=ye(s);e.asyncQueue.verifyOperationInProgress(),oe(Ri,"RemoteStore received new credentials");const i=Mi(e);e.Ia.add(3),await $n(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await hs(e)}async function av(s,t){const e=ye(s);t?(e.Ia.delete(2),await hs(e)):t||(e.Ia.add(2),await $n(e),e.Aa.set("Unknown"))}function hn(s){return s.Va||(s.Va=function(e,i,n){const r=ye(e);return r.ia(),new Wg(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:Qg.bind(null,s),e_:Jg.bind(null,s),n_:$g.bind(null,s),J_:ev.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),zo(s)?Ho(s):s.Aa.set("Unknown")):(await s.Va.stop(),Vh(s))})),s.Va}function mi(s){return s.ma||(s.ma=function(e,i,n){const r=ye(e);return r.ia(),new Gg(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:nv.bind(null,s),n_:ov.bind(null,s),ea:rv.bind(null,s),ta:sv.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await us(s)):(await s.ma.stop(),s.Pa.length>0&&(oe(Ri,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Uo{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new Ci,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new Uo(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new ne(X.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function jo(s,t){if($t("AsyncQueue",`${t}: ${s}`),ln(s))return new ne(X.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yi{static emptySet(t){return new Yi(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||de.comparator(e.key,i.key):(e,i)=>de.comparator(e.key,i.key),this.keyedMap=An(),this.sortedSet=new je(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Yi)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new Yi;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xl{constructor(){this.fa=new je(de.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):pe(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class tn{constructor(t,e,i,n,r,o,a,c,h){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=c,this.hasCachedResults=h}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new tn(t,e,Yi.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&rs(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lv{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class cv{constructor(){this.queries=Yl(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=ye(e),r=n.queries;n.queries=Yl(),r.forEach((o,a)=>{for(const c of a.wa)c.onError(i)})})(this,new ne(X.ABORTED,"Firestore shutting down"))}}function Yl(){return new Di(s=>ah(s),rs)}async function hv(s,t){const e=ye(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new lv,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=jo(o,`Initialization of query '${qi(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&qo(e)}async function uv(s,t){const e=ye(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function dv(s,t){const e=ye(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&qo(e)}function fv(s,t,e){const i=ye(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function qo(s){s.Da.forEach(t=>{t.next()})}var ho,Kl;(Kl=ho||(ho={})).Fa="default",Kl.Cache="cache";class pv{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new tn(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=tn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==ho.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zh{constructor(t){this.key=t}}class Uh{constructor(t){this.key=t}}class mv{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Ce(),this.mutatedKeys=Ce(),this.Xa=lh(t),this.eu=new Yi(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new Xl,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const c=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,h=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((d,l)=>{const f=n.get(d),p=ss(this.query,l)?l:null,m=!!f&&this.mutatedKeys.has(f.key),v=!!p&&(p.hasLocalMutations||this.mutatedKeys.has(p.key)&&p.hasCommittedMutations);let w=!1;f&&p?f.data.isEqual(p.data)?m!==v&&(i.track({type:3,doc:p}),w=!0):this.iu(f,p)||(i.track({type:2,doc:p}),w=!0,(c&&this.Xa(p,c)>0||h&&this.Xa(p,h)<0)&&(a=!0)):!f&&p?(i.track({type:0,doc:p}),w=!0):f&&!p&&(i.track({type:1,doc:f}),w=!0,(c||h)&&(a=!0)),w&&(p?(o=o.add(p),r=v?r.add(d):r.delete(d)):(o=o.delete(d),r=r.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),r=r.delete(d.key),i.track({type:1,doc:d})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((d,l)=>function(p,m){const v=w=>{switch(w){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return pe(20277,{At:w})}};return v(p)-v(m)}(d.type,l.type)||this.Xa(d.doc,l.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],c=this.Za.size===0&&this.current&&!n?1:0,h=c!==this.Ya;return this.Ya=c,o.length!==0||h?{snapshot:new tn(this.query,t.eu,r,o,t.mutatedKeys,c===0,h,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new Xl,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Ce(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new Uh(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new zh(i))}),e}uu(t){this.Ha=t.qs,this.Za=Ce();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return tn.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const Wo="SyncEngine";class gv{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class vv{constructor(t){this.key=t,this.lu=!1}}class yv{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new Di(a=>ah(a),rs),this.Tu=new Map,this.Iu=new Set,this.du=new je(de.comparator),this.Eu=new Map,this.Au=new Oo,this.Ru={},this.Vu=new Map,this.mu=en.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function wv(s,t,e=!0){const i=Xh(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await jh(i,t,e,!0),n}async function _v(s,t){const e=Xh(s);await jh(e,t,!0,!1)}async function jh(s,t,e,i){const n=await Vg(s.localStore,Ht(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await Tv(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&Fh(s.remoteStore,n),a}async function Tv(s,t,e,i,n){s.gu=(l,f,p)=>async function(v,w,x,R){let L=w.view.nu(x);L.Ds&&(L=await Ul(v.localStore,w.query,!1).then(({documents:M})=>w.view.nu(M,L)));const j=R&&R.targetChanges.get(w.targetId),G=R&&R.targetMismatches.get(w.targetId)!=null,J=w.view.applyChanges(L,v.isPrimaryClient,j,G);return Jl(v,w.targetId,J._u),J.snapshot}(s,l,f,p);const r=await Ul(s.localStore,t,!0),o=new mv(t,r.qs),a=o.nu(r.documents),c=Jn.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),h=o.applyChanges(a,s.isPrimaryClient,c);Jl(s,e,h._u);const d=new gv(t,e,o);return s.Pu.set(t,d),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),h.snapshot}async function Ev(s,t,e){const i=ye(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!rs(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await lo(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&Bo(i.remoteStore,n.targetId),uo(i,n.targetId)}).catch(an)):(uo(i,n.targetId),await lo(i.localStore,n.targetId,!0))}async function xv(s,t){const e=ye(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),Bo(e.remoteStore,i.targetId))}async function bv(s,t,e){const i=Dv(s);try{const n=await function(o,a){const c=ye(o),h=He.now(),d=a.reduce((p,m)=>p.add(m.key),Ce());let l,f;return c.persistence.runTransaction("Locally write mutations","readwrite",p=>{let m=ei(),v=Ce();return c.Os.getEntries(p,d).next(w=>{m=w,m.forEach((x,R)=>{R.isValidDocument()||(v=v.add(x))})}).next(()=>c.localDocuments.getOverlayedDocuments(p,m)).next(w=>{l=w;const x=[];for(const R of a){const L=Vm(R,l.get(R.key).overlayedDocument);L!=null&&x.push(new wi(R.key,L,$c(L.value.mapValue),kt.exists(!0)))}return c.mutationQueue.addMutationBatch(p,h,x,a)}).next(w=>{f=w;const x=w.applyToLocalDocumentSet(l,v);return c.documentOverlayCache.saveOverlays(p,w.batchId,x)})}).then(()=>({batchId:f.batchId,changes:hh(l)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,c){let h=o.Ru[o.currentUser.toKey()];h||(h=new je(be)),h=h.insert(a,c),o.Ru[o.currentUser.toKey()]=h}(i,n.batchId,e),await er(i,n.changes),await us(i.remoteStore)}catch(n){const r=jo(n,"Failed to persist write");e.reject(r)}}async function qh(s,t){const e=ye(s);try{const i=await Og(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(Oe(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?Oe(o.lu,14607):n.removedDocuments.size>0&&(Oe(o.lu,42227),o.lu=!1))}),await er(e,i,t)}catch(i){await an(i)}}function Ql(s,t,e){const i=ye(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const c=ye(o);c.onlineState=a;let h=!1;c.queries.forEach((d,l)=>{for(const f of l.wa)f.va(a)&&(h=!0)}),h&&qo(c)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function Sv(s,t,e){const i=ye(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new je(de.comparator);o=o.insert(r,gt.newNoDocument(r,ge.min()));const a=Ce().add(r),c=new ls(ge.min(),new Map,new je(be),o,a);await qh(i,c),i.du=i.du.remove(r),i.Eu.delete(t),Go(i)}else await lo(i.localStore,t,!1).then(()=>uo(i,t,e)).catch(an)}async function Pv(s,t){const e=ye(s),i=t.batch.batchId;try{const n=await kg(e.localStore,t);Gh(e,i,null),Wh(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await er(e,n)}catch(n){await an(n)}}async function Cv(s,t,e){const i=ye(s);try{const n=await function(o,a){const c=ye(o);return c.persistence.runTransaction("Reject batch","readwrite-primary",h=>{let d;return c.mutationQueue.lookupMutationBatch(h,a).next(l=>(Oe(l!==null,37113),d=l.keys(),c.mutationQueue.removeMutationBatch(h,l))).next(()=>c.mutationQueue.performConsistencyCheck(h)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(h,d,a)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(h,d)).next(()=>c.localDocuments.getDocuments(h,d))})}(i.localStore,t);Gh(i,t,e),Wh(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await er(i,n)}catch(n){await an(n)}}function Wh(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function Gh(s,t,e){const i=ye(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function uo(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||Zh(s,i)})}function Zh(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&(Bo(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),Go(s))}function Jl(s,t,e){for(const i of e)i instanceof zh?(s.Au.addReference(i.key,t),Av(s,i)):i instanceof Uh?(oe(Wo,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||Zh(s,i.key)):pe(19791,{yu:i})}function Av(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(oe(Wo,"New document in limbo: "+e),s.Iu.add(i),Go(s))}function Go(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new de(Ve.fromString(t)),i=s.mu.next();s.Eu.set(i,new vv(e)),s.du=s.du.insert(e,i),Fh(s.remoteStore,new ri(Ht(Ao(e.path)),i,"TargetPurposeLimboResolution",ts.ue))}}async function er(s,t,e){const i=ye(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,c)=>{o.push(i.gu(c,t,e).then(h=>{var d;if((h||e)&&i.isPrimaryClient){const l=h?!h.fromCache:(d=e==null?void 0:e.targetChanges.get(c.targetId))===null||d===void 0?void 0:d.current;i.sharedClientState.updateQueryState(c.targetId,l?"current":"not-current")}if(h){n.push(h);const l=Lo.Es(c.targetId,h);r.push(l)}}))}),await Promise.all(o),i.hu.J_(n),await async function(c,h){const d=ye(c);try{await d.persistence.runTransaction("notifyLocalViewChanges","readwrite",l=>K.forEach(h,f=>K.forEach(f.Is,p=>d.persistence.referenceDelegate.addReference(l,f.targetId,p)).next(()=>K.forEach(f.ds,p=>d.persistence.referenceDelegate.removeReference(l,f.targetId,p)))))}catch(l){if(!ln(l))throw l;oe(Vo,"Failed to update sequence numbers: "+l)}for(const l of h){const f=l.targetId;if(!l.fromCache){const p=d.Fs.get(f),m=p.snapshotVersion,v=p.withLastLimboFreeSnapshotVersion(m);d.Fs=d.Fs.insert(f,v)}}}(i.localStore,r))}async function Iv(s,t){const e=ye(s);if(!e.currentUser.isEqual(t)){oe(Wo,"User change. New user:",t.toKey());const i=await Dh(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(c=>{c.reject(new ne(X.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await er(e,i.Bs)}}function Rv(s,t){const e=ye(s),i=e.Eu.get(t);if(i&&i.lu)return Ce().add(i.key);{let n=Ce();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function Xh(s){const t=ye(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=qh.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Rv.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Sv.bind(null,t),t.hu.J_=dv.bind(null,t.eventManager),t.hu.pu=fv.bind(null,t.eventManager),t}function Dv(s){const t=ye(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Pv.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Cv.bind(null,t),t}class Qr{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=cs(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return Mg(this.persistence,new Ig,t.initialUser,this.serializer)}Du(t){return new Rh(Fo.Vi,this.serializer)}bu(t){return new Ng}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}Qr.provider={build:()=>new Qr};class Mv extends Qr{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){Oe(this.persistence.referenceDelegate instanceof Yr,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new pg(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?_t.withCacheSize(this.cacheSizeBytes):_t.DEFAULT;return new Rh(i=>Yr.Vi(i,e),this.serializer)}}class fo{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>Ql(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=Iv.bind(null,this.syncEngine),await av(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new cv}()}createDatastore(t){const e=cs(t.databaseInfo.databaseId),i=function(r){return new qg(r)}(t.databaseInfo);return function(r,o,a,c){return new Xg(r,o,a,c)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new Kg(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>Ql(this.syncEngine,e,0),function(){return Wl.C()?new Wl:new Hg}())}createSyncEngine(t,e){return function(n,r,o,a,c,h,d){const l=new yv(n,r,o,a,c,h);return d&&(l.fu=!0),l}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=ye(n);oe(Ri,"RemoteStore shutting down."),r.Ia.add(5),await $n(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}fo.provider={build:()=>new fo};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kv{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):$t("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gi="FirestoreClient";class Ov{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=mt.UNAUTHENTICATED,this.clientId=Eo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{oe(gi,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(oe(gi,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Ci;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=jo(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function js(s,t){s.asyncQueue.verifyOperationInProgress(),oe(gi,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await Dh(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{hi("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{oe("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{hi("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function $l(s,t){s.asyncQueue.verifyOperationInProgress();const e=await Fv(s);oe(gi,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>Zl(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>Zl(t.remoteStore,n)),s._onlineComponents=t}async function Fv(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){oe(gi,"Using user provided OfflineComponentProvider");try{await js(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===X.FAILED_PRECONDITION||n.code===X.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;hi("Error using user provided cache. Falling back to memory cache: "+e),await js(s,new Qr)}}else oe(gi,"Using default OfflineComponentProvider"),await js(s,new Mv(void 0));return s._offlineComponents}async function Yh(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(oe(gi,"Using user provided OnlineComponentProvider"),await $l(s,s._uninitializedComponentsProvider._online)):(oe(gi,"Using default OnlineComponentProvider"),await $l(s,new fo))),s._onlineComponents}function Lv(s){return Yh(s).then(t=>t.syncEngine)}async function ec(s){const t=await Yh(s),e=t.eventManager;return e.onListen=wv.bind(null,t.syncEngine),e.onUnlisten=Ev.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=_v.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=xv.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Kh(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tc=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qh="firestore.googleapis.com",ic=!0;class nc{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new ne(X.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Qh,this.ssl=ic}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:ic;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=Ih;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<dg)throw new ne(X.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Qp("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Kh((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new ne(X.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new ne(X.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new ne(X.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class ds{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new nc({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new ne(X.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new ne(X.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new nc(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new Up;switch(i.type){case"firstParty":return new Gp(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new ne(X.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=tc.get(e);i&&(oe("ComponentProvider","Removing Datastore"),tc.delete(e),i.terminate())}(this),Promise.resolve()}}function Vv(s,t,e,i={}){var n;s=li(s,ds);const r=wo(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),c=`${t}:${e}`;r&&(vf(`https://${c}`),Tf("Firestore",!0)),o.host!==Qh&&o.host!==c&&hi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const h=Object.assign(Object.assign({},o),{host:c,ssl:r,emulatorOptions:i});if(!Nr(h,a)&&(s._setSettings(h),i.mockUserToken)){let d,l;if(typeof i.mockUserToken=="string")d=i.mockUserToken,l=mt.MOCK_USER;else{d=yf(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const f=i.mockUserToken.sub||i.mockUserToken.user_id;if(!f)throw new ne(X.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new mt(f)}s._authCredentials=new jp(new Hc(d,l))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ki{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new ki(this.firestore,t,this._query)}}class Qe{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ci(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Qe(this.firestore,t,this._key)}toJSON(){return{type:Qe._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(Kn(e,Qe._jsonSchema))return new Qe(t,i||null,new de(Ve.fromString(e.referencePath)))}}Qe._jsonSchemaVersion="firestore/documentReference/1.0",Qe._jsonSchema={type:Ke("string",Qe._jsonSchemaVersion),referencePath:Ke("string")};class ci extends ki{constructor(t,e,i){super(t,e,Ao(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Qe(this.firestore,null,new de(t))}withConverter(t){return new ci(this.firestore,t,this._path)}}function rc(s,t,...e){if(s=qt(s),Uc("collection","path",t),s instanceof ds){const i=Ve.fromString(t,...e);return ml(i),new ci(s,null,i)}{if(!(s instanceof Qe||s instanceof ci))throw new ne(X.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ve.fromString(t,...e));return ml(i),new ci(s.firestore,null,i)}}function po(s,t,...e){if(s=qt(s),arguments.length===1&&(t=Eo.newId()),Uc("doc","path",t),s instanceof ds){const i=Ve.fromString(t,...e);return pl(i),new Qe(s,null,new de(i))}{if(!(s instanceof Qe||s instanceof ci))throw new ne(X.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ve.fromString(t,...e));return pl(i),new Qe(s.firestore,s instanceof ci?s.converter:null,new de(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sc="AsyncQueue";class oc{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new kh(this,"async_queue_retry"),this.oc=()=>{const i=Us();i&&oe(sc,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=Us();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=Us();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new Ci;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!ln(t))throw t;oe(sc,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,$t("INTERNAL UNHANDLED ERROR: ",ac(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=Uo.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&pe(47125,{hc:ac(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function ac(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lc(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class nn extends ds{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new oc,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new oc(t),this._firestoreClient=void 0,await t}}}function Bv(s,t){const e=typeof s=="object"?s:Dp(),i=typeof s=="string"?s:jr,n=Pp(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=mf("firestore");r&&Vv(n,...r)}return n}function Jh(s){if(s._terminated)throw new ne(X.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||Nv(s),s._firestoreClient}function Nv(s){var t,e,i;const n=s._freezeSettings(),r=function(a,c,h,d){return new lm(a,c,h,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,Kh(d.experimentalLongPollingOptions),d.useFetchStreams,d.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new Ov(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const c=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(c),_online:c}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class At{constructor(t){this._byteString=t}static fromBase64String(t){try{return new At(at.fromBase64String(t))}catch(e){throw new ne(X.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new At(at.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:At._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(Kn(t,At._jsonSchema))return At.fromBase64String(t.bytes)}}At._jsonSchemaVersion="firestore/bytes/1.0",At._jsonSchema={type:Ke("string",At._jsonSchemaVersion),bytes:Ke("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fs{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new ne(X.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ot(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zo{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ut{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new ne(X.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new ne(X.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return be(this._lat,t._lat)||be(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:Ut._jsonSchemaVersion}}static fromJSON(t){if(Kn(t,Ut._jsonSchema))return new Ut(t.latitude,t.longitude)}}Ut._jsonSchemaVersion="firestore/geoPoint/1.0",Ut._jsonSchema={type:Ke("string",Ut._jsonSchemaVersion),latitude:Ke("number"),longitude:Ke("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jt{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:jt._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(Kn(t,jt._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new jt(t.vectorValues);throw new ne(X.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}jt._jsonSchemaVersion="firestore/vectorValue/1.0",jt._jsonSchema={type:Ke("string",jt._jsonSchemaVersion),vectorValues:Ke("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hv=/^__.*__$/;class zv{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new wi(t,this.data,this.fieldMask,e,this.fieldTransforms):new Qn(t,this.data,e,this.fieldTransforms)}}class $h{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new wi(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function eu(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw pe(40011,{Ec:s})}}class Xo{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new Xo(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return Jr(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(eu(this.Ec)&&Hv.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class Uv{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||cs(t)}Dc(t,e,i,n=!1){return new Xo({Ec:t,methodName:e,bc:i,path:ot.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Yo(s){const t=s._freezeSettings(),e=cs(s._databaseId);return new Uv(s._databaseId,!!t.ignoreUndefinedProperties,e)}function jv(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);Ko("Data must be an object, but it was:",o,i);const a=tu(i,o);let c,h;if(r.merge)c=new Pt(o.fieldMask),h=o.fieldTransforms;else if(r.mergeFields){const d=[];for(const l of r.mergeFields){const f=mo(t,l,e);if(!o.contains(f))throw new ne(X.INVALID_ARGUMENT,`Field '${f}' is specified in your field mask but missing from your input data.`);nu(d,f)||d.push(f)}c=new Pt(d),h=o.fieldTransforms.filter(l=>c.covers(l.field))}else c=null,h=o.fieldTransforms;return new zv(new Tt(a),c,h)}class ps extends Zo{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof ps}}function qv(s,t,e,i){const n=s.Dc(1,t,e);Ko("Data must be an object, but it was:",n,i);const r=[],o=Tt.empty();yi(i,(c,h)=>{const d=Qo(t,c,e);h=qt(h);const l=n.gc(d);if(h instanceof ps)r.push(d);else{const f=tr(h,l);f!=null&&(r.push(d),o.set(d,f))}});const a=new Pt(r);return new $h(o,a,n.fieldTransforms)}function Wv(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[mo(t,i,e)],c=[n];if(r.length%2!=0)throw new ne(X.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<r.length;f+=2)a.push(mo(t,r[f])),c.push(r[f+1]);const h=[],d=Tt.empty();for(let f=a.length-1;f>=0;--f)if(!nu(h,a[f])){const p=a[f];let m=c[f];m=qt(m);const v=o.gc(p);if(m instanceof ps)h.push(p);else{const w=tr(m,v);w!=null&&(h.push(p),d.set(p,w))}}const l=new Pt(h);return new $h(d,l,o.fieldTransforms)}function Gv(s,t,e,i=!1){return tr(e,s.Dc(i?4:3,t))}function tr(s,t){if(iu(s=qt(s)))return Ko("Unsupported field value:",t,s),tu(s,t);if(s instanceof Zo)return function(i,n){if(!eu(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let c=tr(a,n.yc(o));c==null&&(c={nullValue:"NULL_VALUE"}),r.push(c),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=qt(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return Dm(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=He.fromDate(i);return{timestampValue:Xr(n.serializer,r)}}if(i instanceof He){const r=new He(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:Xr(n.serializer,r)}}if(i instanceof Ut)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof At)return{bytesValue:Eh(n.serializer,i._byteString)};if(i instanceof Qe){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ko(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof jt)return function(o,a){return{mapValue:{fields:{[Qc]:{stringValue:Jc},[qr]:{arrayValue:{values:o.toArray().map(h=>{if(typeof h!="number")throw a.wc("VectorValues must only contain numeric values.");return Io(a.serializer,h)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${es(i)}`)}(s,t)}function tu(s,t){const e={};return Wc(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):yi(s,(i,n)=>{const r=tr(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function iu(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof He||s instanceof Ut||s instanceof At||s instanceof Qe||s instanceof Zo||s instanceof jt)}function Ko(s,t,e){if(!iu(e)||!jc(e)){const i=es(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function mo(s,t,e){if((t=qt(t))instanceof fs)return t._internalPath;if(typeof t=="string")return Qo(s,t);throw Jr("Field path arguments must be of type string or ",s,!1,void 0,e)}const Zv=new RegExp("[~\\*/\\[\\]]");function Qo(s,t,e){if(t.search(Zv)>=0)throw Jr(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new fs(...t.split("."))._internalPath}catch{throw Jr(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function Jr(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(r||o)&&(c+=" (found",r&&(c+=` in field ${i}`),o&&(c+=` in document ${n}`),c+=")"),new ne(X.INVALID_ARGUMENT,a+s+c)}function nu(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ru{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new Qe(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new Xv(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(ms("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class Xv extends ru{data(){return super.data()}}function ms(s,t){return typeof t=="string"?Qo(s,t):t instanceof fs?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yv(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new ne(X.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Jo{}class su extends Jo{}function Kv(s,t,...e){let i=[];t instanceof Jo&&i.push(t),i=i.concat(e),function(r){const o=r.filter(c=>c instanceof $o).length,a=r.filter(c=>c instanceof gs).length;if(o>1||o>0&&a>0)throw new ne(X.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class gs extends su{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new gs(t,e,i)}_apply(t){const e=this._parse(t);return ou(t._query,e),new ki(t.firestore,t.converter,io(t._query,e))}_parse(t){const e=Yo(t.firestore);return function(r,o,a,c,h,d,l){let f;if(h.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new ne(X.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){hc(l,d);const m=[];for(const v of l)m.push(cc(c,r,v));f={arrayValue:{values:m}}}else f=cc(c,r,l)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||hc(l,d),f=Gv(a,o,l,d==="in"||d==="not-in");return Ye.create(h,d,f)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function Qv(s,t,e){const i=t,n=ms("where",s);return gs._create(n,i,e)}class $o extends Jo{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new $o(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:Ot.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const c of a)ou(o,c),o=io(o,c)}(t._query,e),new ki(t.firestore,t.converter,io(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class ea extends su{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new ea(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new ne(X.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new ne(X.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Wn(r,o)}(t._query,this._field,this._direction);return new ki(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new cn(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function Jv(s,t="asc"){const e=t,i=ms("orderBy",s);return ea._create(i,e)}function cc(s,t,e){if(typeof(e=qt(e))=="string"){if(e==="")throw new ne(X.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!oh(t)&&e.indexOf("/")!==-1)throw new ne(X.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(Ve.fromString(e));if(!de.isDocumentKey(i))throw new ne(X.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return xl(s,new de(i))}if(e instanceof Qe)return xl(s,e._key);throw new ne(X.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${es(e)}.`)}function hc(s,t){if(!Array.isArray(s)||s.length===0)throw new ne(X.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function ou(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new ne(X.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new ne(X.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class $v{convertValue(t,e="none"){switch(pi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return We(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(fi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw pe(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return yi(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[qr].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>We(o.doubleValue));return new jt(r)}convertGeoPoint(t){return new Ut(We(t.latitude),We(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=ns(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(Un(t));default:return null}}convertTimestamp(t){const e=di(t);return new He(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=Ve.fromString(t);Oe(Ah(i),9688,{name:t});const n=new jn(i.get(1),i.get(3)),r=new de(i.popFirst(5));return n.isEqual(e)||$t(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ey(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class Rn{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Ai extends ru{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Mr(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(ms("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new ne(X.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=Ai._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}Ai._jsonSchemaVersion="firestore/documentSnapshot/1.0",Ai._jsonSchema={type:Ke("string",Ai._jsonSchemaVersion),bundleSource:Ke("string","DocumentSnapshot"),bundleName:Ke("string"),bundle:Ke("string")};class Mr extends Ai{data(t={}){return super.data(t)}}class Ki{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new Rn(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new Mr(this._firestore,this._userDataWriter,i.key,i,new Rn(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new ne(X.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const c=new Mr(n._firestore,n._userDataWriter,a.doc.key,a.doc,new Rn(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:c,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const c=new Mr(n._firestore,n._userDataWriter,a.doc.key,a.doc,new Rn(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let h=-1,d=-1;return a.type!==0&&(h=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),d=o.indexOf(a.doc.key)),{type:ty(a.type),doc:c,oldIndex:h,newIndex:d}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new ne(X.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=Ki._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=Eo.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function ty(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return pe(61501,{type:s})}}Ki._jsonSchemaVersion="firestore/querySnapshot/1.0",Ki._jsonSchema={type:Ke("string",Ki._jsonSchemaVersion),bundleSource:Ke("string","QuerySnapshot"),bundleName:Ke("string"),bundle:Ke("string")};class au extends $v{constructor(t){super(),this.firestore=t}convertBytes(t){return new At(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Qe(this.firestore,null,e)}}function iy(s,t,e,...i){s=li(s,Qe);const n=li(s.firestore,nn),r=Yo(n);let o;return o=typeof(t=qt(t))=="string"||t instanceof fs?Wv(r,"updateDoc",s._key,t,e,i):qv(r,"updateDoc",s._key,t),ta(n,[o.toMutation(s._key,kt.exists(!0))])}function ny(s){return ta(li(s.firestore,nn),[new Ro(s._key,kt.none())])}function ry(s,t){const e=li(s.firestore,nn),i=po(s),n=ey(s.converter,t);return ta(e,[jv(Yo(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,kt.exists(!1))]).then(()=>i)}function sy(s,...t){var e,i,n;s=qt(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||lc(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(lc(t[o])){const l=t[o];t[o]=(e=l.next)===null||e===void 0?void 0:e.bind(l),t[o+1]=(i=l.error)===null||i===void 0?void 0:i.bind(l),t[o+2]=(n=l.complete)===null||n===void 0?void 0:n.bind(l)}let c,h,d;if(s instanceof Qe)h=li(s.firestore,nn),d=Ao(s._key.path),c={next:l=>{t[o]&&t[o](oy(h,s,l))},error:t[o+1],complete:t[o+2]};else{const l=li(s,ki);h=li(l.firestore,nn),d=l._query;const f=new au(h);c={next:p=>{t[o]&&t[o](new Ki(h,f,l,p))},error:t[o+1],complete:t[o+2]},Yv(s._query)}return function(f,p,m,v){const w=new kv(v),x=new pv(p,w,m);return f.asyncQueue.enqueueAndForget(async()=>hv(await ec(f),x)),()=>{w.Ou(),f.asyncQueue.enqueueAndForget(async()=>uv(await ec(f),x))}}(Jh(h),d,a,c)}function ta(s,t){return function(i,n){const r=new Ci;return i.asyncQueue.enqueueAndForget(async()=>bv(await Lv(i),n,r)),r.promise}(Jh(s),t)}function oy(s,t,e){const i=e.docs.get(t._key),n=new au(s);return new Ai(s,n,t._key,i,new Rn(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){on=n})(Rp),zr(new Nn("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new nn(new qp(i.getProvider("auth-internal")),new Zp(o,i.getProvider("app-check-internal")),function(h,d){if(!Object.prototype.hasOwnProperty.apply(h.options,["projectId"]))throw new ne(X.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new jn(h.options.projectId,d)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),Xi(cl,hl,t),Xi(cl,hl,"esm2017")})();var ay="firebase",ly="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Xi(ay,ly,"app");const cy={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},hy=Rc(cy),Sr=Bv(hy);var uy=ie('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),dy=ie("<div style=margin-bottom:12px;>"),fy=ie('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;"> Add feedback'),py=ie("<div style=margin-top:16px;>"),my=ie('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),gy=ie('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),vy=ie('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),yy=ie("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;>  </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),wy=ie("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),_y=ie('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function uc({updateId:s,updateTitle:t}){const[e,i]=me([]),[n,r]=me(""),[o,a]=me(null),[c,h]=me(""),[d,l]=me(!1),[f,p]=me(localStorage.getItem("feedbackAuthor")||"Deji"),[m,v]=me(!1),[w,x]=me(!1),[R,L]=me(!1);Si(()=>{const A=Kv(rc(Sr,"feedbacks"),Qv("updateId","==",s),Jv("timestamp","desc")),C=sy(A,k=>{const F=[];k.forEach(O=>{F.push({id:O.id,...O.data()})}),i(F)});return()=>C()});const j=async A=>{if(A.preventDefault(),!!n().trim()){l(!0);try{await ry(rc(Sr,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:f(),timestamp:new Date,edited:!1}),r(""),L(!1)}catch(C){console.error("Error adding feedback:",C)}l(!1)}},G=async A=>{if(c().trim())try{await iy(po(Sr,"feedbacks",A),{text:c(),edited:!0,editedAt:new Date}),a(null),h("")}catch(C){console.error("Error editing feedback:",C)}},J=async A=>{if(confirm("Delete this feedback?"))try{await ny(po(Sr,"feedbacks",A))}catch(C){console.error("Error deleting feedback:",C)}},M=A=>{if(!A)return"";const C=A.toDate?A.toDate():new Date(A),F=new Date-C,O=Math.floor(F/(1e3*60*60));return O<1?"Just now":O<24?`${O} hour${O>1?"s":""} ago`:O<48?"Yesterday":C.toLocaleDateString()};return(()=>{var A=py();return se(A,fe(ke,{get when(){return e().length>0},get children(){var C=dy();return se(C,fe(qu,{get each(){return pt(()=>!!w())()?e():e().slice(0,2)},children:k=>(()=>{var F=gy();return se(F,fe(ke,{get when(){return o()===k.id},get fallback(){return[(()=>{var O=vy();return se(O,()=>k.text),O})(),(()=>{var O=yy(),D=O.firstChild,z=D.firstChild,xe=D.nextSibling,Se=xe.firstChild,Me=Se.nextSibling;return se(D,()=>k.author,z),se(D,()=>M(k.timestamp),null),se(D,()=>k.edited&&" (edited)",null),Se.$$click=()=>{a(k.id),h(k.text)},Me.$$click=()=>J(k.id),O})()]},get children(){var O=my(),D=O.firstChild,z=D.nextSibling,xe=z.firstChild,Se=xe.nextSibling;return D.$$input=Me=>h(Me.target.value),xe.$$click=()=>G(k.id),Se.$$click=()=>{a(null),h("")},st(()=>D.value=c()),O}})),F})()}),null),se(C,fe(ke,{get when(){return e().length>2},get children(){var k=uy();return k.$$click=()=>x(!w()),se(k,(()=>{var F=pt(()=>!!w());return()=>F()?` Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),k}}),null),C}}),null),se(A,fe(ke,{get when(){return!R()},get fallback(){return(()=>{var C=_y(),k=C.firstChild,F=k.firstChild,O=F.firstChild,D=O.nextSibling,z=F.nextSibling,xe=k.nextSibling,Se=xe.firstChild,Me=Se.nextSibling,re=Me.firstChild,ve=re.nextSibling;return se(D,f),z.$$click=()=>v(!m()),se(C,fe(ke,{get when(){return m()},get children(){var we=wy(),tt=we.firstChild,Fe=tt.firstChild,te=Fe.nextSibling;return Fe.$$click=()=>{p("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),v(!1)},te.$$click=()=>{p("Deji"),localStorage.setItem("feedbackAuthor","Deji"),v(!1)},st(Ge=>{var ze=`background: ${f()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,Ct=`background: ${f()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return Ge.e=Ds(Fe,ze,Ge.e),Ge.t=Ds(te,Ct,Ge.t),Ge},{e:void 0,t:void 0}),we}}),xe),xe.addEventListener("submit",j),Se.$$input=we=>r(we.target.value),se(re,()=>d()?"Posting...":"Post"),ve.$$click=()=>{L(!1),r("")},st(we=>{var tt=d(),Fe=d()||!n().trim(),te=`background: ${d()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${d()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return tt!==we.e&&(Se.disabled=we.e=tt),Fe!==we.t&&(re.disabled=we.t=Fe),we.a=Ds(re,te,we.a),we},{e:void 0,t:void 0,a:void 0}),st(()=>Se.value=n()),C})()},get children(){var C=fy();return C.$$click=()=>L(!0),C}}),null),A})()}rn(["click","input"]);var Ty=ie("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),Ey=ie('<p><strong>How it works:</strong><br> Type your feedback in the text box below any update<br> Click "Post Feedback" to send<br> Edit or delete your comments anytime<br> Everything syncs in real-time between us'),xy=ie('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),by=ie("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),Sy=ie("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),Py=ie("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),Cy=ie("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),Ay=ie("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),Iy=ie("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),Ry=ie("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),Dy=ie("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br> Uses radial gradient masks instead of polygon cutouts<br> Provides a circular/elliptical spotlight effect around hotspots<br> Maintains smooth 60 FPS performance on all iOS devices"),My=ie("<p><strong>What's Different:</strong><br> <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br> <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),ky=ie("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),Oy=ie("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),Fy=ie("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),Ly=ie("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br> iPhone (Safari & Chrome)<br> iPad (Safari & Chrome)<br> Mac (Safari only - Chrome works fine!)"),Vy=ie("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),By=ie("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),Ny=ie("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),Hy=ie("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),zy=ie("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),Uy=ie("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),jy=ie(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now  `),qy=ie("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),Wy=ie(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),Gy=ie("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),Zy=ie("<p>Hey Deji! "),Xy=ie("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),Yy=ie("<p>I totally relate to your potato mode confession  We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),Ky=ie("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable  I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),Qy=ie(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),Jy=ie("<p>Looking forward to showing you the improvements!<br>- Leonard"),$y=ie('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),ew=ie(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn></button></div><div class=update-section style="background:linear-gradient(135deg, #1a1f2e 0%, #1e2330 100%);border:1px solid rgba(0, 136, 204, 0.3);margin-bottom:20px;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);"><h4 style="color:#0088cc;margin:0 0 16px 0;font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px;"><span style=font-size:20px;></span> Communication Update</h4><p style="color:rgba(255, 255, 255, 0.85);margin:0 0 20px 0;font-size:14px;line-height:1.6;">Our Upwork channel is no longer available. I've reached out via your business contacts and remain fully committed to your project.</p><div style="background:rgba(0, 136, 204, 0.1);padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;"><a href=https://t.me/LeonardCote target=_blank style="display:inline-flex;align-items:center;gap:8px;background:#0088cc;color:white;padding:10px 24px;border-radius:6px;text-decoration:none;font-weight:500;font-size:15px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0, 136, 204, 0.3);"><svg width=16 height=16 viewBox="0 0 24 24"fill=currentColor><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.223-.548.223l.188-2.85 5.18-4.68c.223-.198-.054-.308-.346-.111l-6.4 4.02-2.76-.918c-.6-.187-.612-.6.125-.89l10.782-4.156c.5-.18.94.12.78.88z"></path></svg>Message me on Telegram</a><p style="color:rgba(255, 255, 255, 0.6);margin:12px 0 0 0;font-size:13px;text-align:center;">or email: <a href=mailto:leonard.cote08@gmail.com style=color:#0088cc;text-decoration:none;>leonard.cote08@gmail.com</a></p></div><p style="color:rgba(255, 255, 255, 0.7);margin:0;font-size:13px;line-height:1.5;">The project continues to progress. All updates are posted here.<br><em style=opacity:0.8;>Platform details can be discussed when we connect.</em></p></div><div class=message-toggle><button class=toggle-btn>`),dc=ie("<div class=update-section><h4> (<!>)"),tw=ie("<div class=app-container>"),iw=ie("<div class=loading-screen><p>Loading Interactive Art Diary...");function nw({onClose:s}){const[t,e]=me(!1),i=[{id:"feedback-system-july3",date:"July 3 - night",title:" New: Direct Feedback System",content:[Ty(),Ey(),xy(),by()]},{id:"border-experiment-july3",date:"July 3",title:" Border Experiment for Apple Mode",content:[Sy(),Py(),Cy(),Ay(),Iy()]},{id:"safari-solution-july2",date:"July 2",title:" Safari/iOS Spotlight Solution Implemented",content:[Ry(),Dy(),My(),ky(),Oy()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:" Spotlight Effect - Browser Compatibility",content:[Fy(),Ly(),Vy(),By(),Ny(),Hy()]},{id:"zoom-speed-july1",date:"July 1",title:" Zoom Speed Control & Performance Update",content:[zy(),Uy(),jy(),qy()]},{id:"performance-june30",date:"June 30",title:" Performance Breakthrough",content:Wy()},{id:"focus-mode-june29",date:"June 29",title:" New Feature",content:Gy()},{id:"personal-june28",date:"June 28",title:" Personal Message",content:[Zy(),Xy(),Yy(),Ky(),Qy(),Jy()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=ew(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=a.nextSibling,l=d.nextSibling,f=l.firstChild;return _c(h,"click",s),se(o,()=>n.map(p=>(()=>{var m=dc(),v=m.firstChild,w=v.firstChild,x=w.nextSibling;return x.nextSibling,se(v,()=>p.title,w),se(v,()=>p.date,x),se(m,()=>p.content,null),se(m,fe(uc,{get updateId(){return p.id},get updateTitle(){return p.title}}),null),m})()),l),f.$$click=()=>e(!t()),se(f,()=>t()?" Hide previous updates":"+ Show previous updates"),se(o,fe(ke,{get when(){return t()},get children(){var p=$y();return p.firstChild,se(p,()=>r.map(m=>(()=>{var v=dc(),w=v.firstChild,x=w.firstChild,R=x.nextSibling;return R.nextSibling,se(w,()=>m.title,x),se(w,()=>m.date,R),se(v,()=>m.content,null),se(v,fe(uc,{get updateId(){return m.id},get updateTitle(){return m.title}}),null),v})()),null),p}}),null),o})()}function rw(){const[s,t]=me(!1),[e]=me("zebra"),[i,n]=me(!0),r=()=>{n(!1)};return go(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var o=tw();return se(o,(()=>{var a=pt(()=>!!i());return()=>a()&&fe(nw,{onClose:r})})(),null),se(o,(()=>{var a=pt(()=>!!s());return()=>a()?fe(rf,{get artworkId(){return e()}}):iw()})(),null),o})()}rn(["click"]);const sw=document.getElementById("root");Gu(()=>fe(rw,{}),sw);
