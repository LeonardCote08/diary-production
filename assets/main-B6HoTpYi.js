(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const Dh=!1,Mh=(s,t)=>s===t,kh=Symbol("solid-track"),Dr={equals:Mh};let du=mu;const yi=1,Mr=2,fu={owned:null,cleanups:null,context:null,owner:null};var rt=null;let Is=null,Fh=null,Je=null,Tt=null,Jt=null,$r=0;function xr(s,t){const e=Je,i=rt,n=s.length===0,r=t===void 0?i:t,o=n?fu:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>Wt(()=>Nn(o)));rt=o,Je=null;try{return Kn(a,!0)}finally{Je=e,rt=i}}function oe(s,t){t=t?Object.assign({},Dr,t):Dr;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),gu(e,n));return[pu.bind(e),i]}function Oe(s,t,e){const i=fo(s,t,!1,yi);Xn(i)}function Gi(s,t,e){du=Nh;const i=fo(s,t,!1,yi);i.user=!0,Jt?Jt.push(i):Xn(i)}function Ft(s,t,e){e=e?Object.assign({},Dr,e):Dr;const i=fo(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,Xn(i),pu.bind(i)}function Wt(s){if(Je===null)return s();const t=Je;Je=null;try{return s()}finally{Je=t}}function kr(s){Gi(()=>Wt(s))}function Ln(s){return rt===null||(rt.cleanups===null?rt.cleanups=[s]:rt.cleanups.push(s)),s}function Oh(s){const t=Ft(s),e=Ft(()=>Bs(t()));return e.toArray=()=>{const i=e();return Array.isArray(i)?i:i!=null?[i]:[]},e}function pu(){if(this.sources&&this.state)if(this.state===yi)Xn(this);else{const s=Tt;Tt=null,Kn(()=>Or(this),!1),Tt=s}if(Je){const s=this.observers?this.observers.length:0;Je.sources?(Je.sources.push(this),Je.sourceSlots.push(s)):(Je.sources=[this],Je.sourceSlots=[s]),this.observers?(this.observers.push(Je),this.observerSlots.push(Je.sources.length-1)):(this.observers=[Je],this.observerSlots=[Je.sources.length-1])}return this.value}function gu(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&Kn(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=Is&&Is.running;o&&Is.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?Tt.push(r):Jt.push(r),r.observers&&vu(r)),o||(r.state=yi)}if(Tt.length>1e6)throw Tt=[],new Error},!1)),t}function Xn(s){if(!s.fn)return;Nn(s);const t=$r;Vh(s,s.value,t)}function Vh(s,t,e){let i;const n=rt,r=Je;Je=rt=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=yi,s.owned&&s.owned.forEach(Nn),s.owned=null),s.updatedAt=e+1,yu(o)}finally{Je=r,rt=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?gu(s,i):s.value=i,s.updatedAt=e)}function fo(s,t,e,i=yi,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:rt,context:rt?rt.context:null,pure:e};return rt===null||rt!==fu&&(rt.owned?rt.owned.push(r):rt.owned=[r]),r}function Fr(s){if(s.state===0)return;if(s.state===Mr)return Or(s);if(s.suspense&&Wt(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<$r);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===yi)Xn(s);else if(s.state===Mr){const i=Tt;Tt=null,Kn(()=>Or(s,t[0]),!1),Tt=i}}function Kn(s,t){if(Tt)return s();let e=!1;t||(Tt=[]),Jt?e=!0:Jt=[],$r++;try{const i=s();return Lh(e),i}catch(i){e||(Jt=null),Tt=null,yu(i)}}function Lh(s){if(Tt&&(mu(Tt),Tt=null),s)return;const t=Jt;Jt=null,t.length&&Kn(()=>du(t),!1)}function mu(s){for(let t=0;t<s.length;t++)Fr(s[t])}function Nh(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:Fr(i)}for(t=0;t<e;t++)Fr(s[t])}function Or(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===yi?i!==t&&(!i.updatedAt||i.updatedAt<$r)&&Fr(i):n===Mr&&Or(i,t)}}}function vu(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=Mr,e.pure?Tt.push(e):Jt.push(e),e.observers&&vu(e))}}function Nn(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)Nn(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)Nn(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function Bh(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function yu(s,t=rt){throw Bh(s)}function Bs(s){if(typeof s=="function"&&!s.length)return Bs(s());if(Array.isArray(s)){const t=[];for(let e=0;e<s.length;e++){const i=Bs(s[e]);Array.isArray(i)?t.push.apply(t,i):t.push(i)}return t}return s}const zh=Symbol("fallback");function Ha(s){for(let t=0;t<s.length;t++)s[t]()}function Hh(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return Ln(()=>Ha(r)),()=>{let l=s()||[],u=l.length,h,d;return l[kh],Wt(()=>{let m,v,E,T,x,O,V,G,Y;if(u===0)o!==0&&(Ha(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[zh],n[0]=xr(J=>(r[0]=J,e.fallback())),o=1);else if(o===0){for(n=new Array(u),d=0;d<u;d++)i[d]=l[d],n[d]=xr(f);o=u}else{for(E=new Array(u),T=new Array(u),a&&(x=new Array(u)),O=0,V=Math.min(o,u);O<V&&i[O]===l[O];O++);for(V=o-1,G=u-1;V>=O&&G>=O&&i[V]===l[G];V--,G--)E[G]=n[V],T[G]=r[V],a&&(x[G]=a[V]);for(m=new Map,v=new Array(G+1),d=G;d>=O;d--)Y=l[d],h=m.get(Y),v[d]=h===void 0?-1:h,m.set(Y,d);for(h=O;h<=V;h++)Y=i[h],d=m.get(Y),d!==void 0&&d!==-1?(E[d]=n[h],T[d]=r[h],a&&(x[d]=a[h]),d=v[d],m.set(Y,d)):r[h]();for(d=O;d<u;d++)d in E?(n[d]=E[d],r[d]=T[d],a&&(a[d]=x[d],a[d](d))):n[d]=xr(f);n=n.slice(0,o=u),i=l.slice(0)}return n});function f(m){if(r[d]=m,a){const[v,E]=oe(d);return a[d]=E,t(l[d],v)}return t(l[d])}}}function he(s,t){return Wt(()=>s(t||{}))}const wu=s=>`Stale read from <${s}>.`;function Vr(s){const t="fallback"in s&&{fallback:()=>s.fallback};return Ft(Hh(()=>s.each,s.children,t||void 0))}function Ve(s){const t=s.keyed,e=Ft(()=>s.when,void 0,void 0),i=t?e:Ft(e,void 0,{equals:(n,r)=>!n==!r});return Ft(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?Wt(()=>r(t?n:()=>{if(!Wt(i))throw wu("Show");return e()})):r}return s.fallback},void 0,void 0)}function Uh(s){const t=Oh(()=>s.children),e=Ft(()=>{const i=t(),n=Array.isArray(i)?i:[i];let r=()=>{};for(let o=0;o<n.length;o++){const a=o,l=n[o],u=r,h=Ft(()=>u()?void 0:l.when,void 0,void 0),d=l.keyed?h:Ft(h,void 0,{equals:(f,m)=>!f==!m});r=()=>u()||(d()?[a,h,l]:void 0)}return r});return Ft(()=>{const i=e()();if(!i)return s.fallback;const[n,r,o]=i,a=o.children;return typeof a=="function"&&a.length>0?Wt(()=>a(o.keyed?r():()=>{var u;if(((u=Wt(e)())==null?void 0:u[0])!==n)throw wu("Match");return r()})):a},void 0,void 0)}function mr(s){return s}const Ct=s=>Ft(()=>s());function jh(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,l=t[n-1].nextSibling,u=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const h=r<i?a?e[a-1].nextSibling:e[r-a]:l;for(;a<r;)s.insertBefore(e[a++],h)}else if(r===a)for(;o<n;)(!u||!u.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const h=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],h),t[n]=e[r]}else{if(!u){u=new Map;let d=a;for(;d<r;)u.set(e[d],d++)}const h=u.get(t[o]);if(h!=null)if(a<h&&h<r){let d=o,f=1,m;for(;++d<n&&d<r&&!((m=u.get(t[d]))==null||m!==h+f);)f++;if(f>h-a){const v=t[o];for(;a<h;)s.insertBefore(e[a++],v)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const Ua="_$DX_DELEGATE";function Wh(s,t,e,i={}){let n;return xr(r=>{n=r,t===document?s():ee(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function L(s,t,e,i){let n;const r=()=>{const a=document.createElement("template");return a.innerHTML=s,a.content.firstChild},o=()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function wi(s,t=window.document){const e=t[Ua]||(t[Ua]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,qh))}}function Ot(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function qe(s,t){t==null?s.removeAttribute("class"):s.className=t}function Gh(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function An(s,t,e){if(!t)return e?Ot(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function _u(s,t,e){return Wt(()=>s(t,e))}function ee(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return Lr(s,t,i,e);Oe(n=>Lr(s,t(),n,e),i)}function qh(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=l=>Object.defineProperty(s,"target",{configurable:!0,value:l}),o=()=>{const l=t[e];if(l&&!t.disabled){const u=t[`${e}Data`];if(u!==void 0?l.call(t,u,s):l.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const l=s.composedPath();r(l[0]);for(let u=0;u<l.length-2&&(t=l[u],!!o());u++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function Lr(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=Bi(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=Bi(s,e,i);else{if(r==="function")return Oe(()=>{let a=t();for(;typeof a=="function";)a=a();e=Lr(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],l=e&&Array.isArray(e);if(zs(a,t,e,n))return Oe(()=>e=Lr(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=Bi(s,e,i),o)return e}else l?e.length===0?ja(s,a,i):jh(s,e,a):(e&&Bi(s),ja(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=Bi(s,e,i,t);Bi(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function zs(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],l=e&&e[s.length],u;if(!(a==null||a===!0||a===!1))if((u=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=zs(s,a,l)||n;else if(u==="function")if(i){for(;typeof a=="function";)a=a();n=zs(s,Array.isArray(a)?a:[a],Array.isArray(l)?l:[l])||n}else s.push(a),n=!0;else{const h=String(a);l&&l.nodeType===3&&l.data===h?s.push(l):s.push(document.createTextNode(h))}}return n}function ja(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function Bi(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const l=a.parentNode===s;!r&&!o?l?s.replaceChild(n,a):s.insertBefore(n,e):l&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}const Zh="modulepreload",Xh=function(s){return"/"+s},Wa={},Kh=function(t,e,i){let n=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(e.map(l=>{if(l=Xh(l),l in Wa)return;Wa[l]=!0;const u=l.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":Zh,u||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),u)return new Promise((f,m)=>{d.addEventListener("load",f),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return n.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},j_=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream,i=/android/i.test(s),n=/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;if(n||t||e||i)return console.log("Mobile/Safari/iOS/Android detected - FORCING canvas drawer (Research: WebGL regression in 5.0.0+)"),"canvas";if(t&&!n)return console.log("Desktop Safari detected - using canvas drawer (WebKit compatibility)"),"canvas";const r=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),o=/firefox|fxios/i.test(s);return r||o?(console.log("Desktop Chrome/Firefox detected - using canvas drawer (Research: Better tile performance)"),"canvas"):(console.log("Unknown browser detected - defaulting to canvas drawer"),"canvas")},$e=()=>{var o;const s=navigator.userAgent.toLowerCase();if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(s)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1)return!0;const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<=768,n=window.innerWidth<=1024;return e&&i||e&&n&&navigator.maxTouchPoints>1?!0:/mobi|tablet/i.test(s)||((o=navigator.userAgentData)==null?void 0:o.mobile)||!1};var Yh=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Qh(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Tu={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var l in o)a=l;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,l=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/l}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var l,u,h,d,f,m,v=arguments[0]||{},E=arguments.length,T=!1,x=1;for(typeof v=="boolean"&&(T=v,v=arguments[1]||{},x=2),typeof v!="object"&&!t.isFunction(v)&&(v={}),E===x&&(v=this,--x);x<E;x++)if(l=arguments[x],l!==null||l!==void 0)for(u in l){var O=Object.getOwnPropertyDescriptor(l,u);if(O!==void 0){if(O.get||O.set){Object.defineProperty(v,u,O);continue}d=O.value}else{e.console.warn('Could not copy inherited property "'+u+'".');continue}v!==d&&(T&&d&&(t.isPlainObject(d)||(f=t.isArray(d)))?(h=v[u],f?(f=!1,m=h&&t.isArray(h)?h:[]):m=h&&t.isPlainObject(h)?h:{},v[u]=t.extend(T,m,d)):d!==void 0&&(v[u]=d))}return v};var i=function(){if(typeof navigator!="object")return!1;var l=navigator.userAgent;return typeof l!="string"?!1:l.indexOf("iPhone")!==-1||l.indexOf("iPad")!==-1||l.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(l,u){return function(){var h=arguments;return h===void 0&&(h=[]),u.apply(l,h)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(l){return e._viewers.get(this.getElement(l))},getElement:function(l){return typeof l=="string"&&(l=document.getElementById(l)),l},getElementPosition:function(l){var u=new e.Point,h,d;for(l=e.getElement(l),h=e.getElementStyle(l).position==="fixed",d=a(l,h);d;)u.x+=l.offsetLeft,u.y+=l.offsetTop,h&&(u=u.plus(e.getPageScroll())),l=d,h=e.getElementStyle(l).position==="fixed",d=a(l,h);return u},getElementOffset:function(l){l=e.getElement(l);var u=l&&l.ownerDocument,h,d,f={top:0,left:0};return u?(h=u.documentElement,typeof l.getBoundingClientRect<"u"&&(f=l.getBoundingClientRect()),d=u===u.window?u:u.nodeType===9?u.defaultView||u.parentWindow:!1,new e.Point(f.left+(d.pageXOffset||h.scrollLeft)-(h.clientLeft||0),f.top+(d.pageYOffset||h.scrollTop)-(h.clientTop||0))):new e.Point},getElementSize:function(l){return l=e.getElement(l),new e.Point(l.clientWidth,l.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(l){return l=e.getElement(l),l.currentStyle}:function(l){return l=e.getElement(l),window.getComputedStyle(l,"")},getCssPropertyWithVendorPrefix:function(l){var u={};return e.getCssPropertyWithVendorPrefix=function(h){if(u[h]!==void 0)return u[h];var d=document.createElement("div").style,f=null;if(d[h]!==void 0)f=h;else for(var m=["Webkit","Moz","MS","O","webkit","moz","ms","o"],v=e.capitalizeFirstLetter(h),E=0;E<m.length;E++){var T=m[E]+v;if(d[T]!==void 0){f=T;break}}return u[h]=f,f},e.getCssPropertyWithVendorPrefix(l)},capitalizeFirstLetter:function(l){return l.charAt(0).toUpperCase()+l.slice(1)},positiveModulo:function(l,u){var h=l%u;return h<0&&(h+=u),h},pointInElement:function(l,u){l=e.getElement(l);var h=e.getElementOffset(l),d=e.getElementSize(l);return u.x>=h.x&&u.x<h.x+d.x&&u.y<h.y+d.y&&u.y>=h.y},getMousePosition:function(l){if(typeof l.pageX=="number")e.getMousePosition=function(u){var h=new e.Point;return h.x=u.pageX,h.y=u.pageY,h};else if(typeof l.clientX=="number")e.getMousePosition=function(u){var h=new e.Point;return h.x=u.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,h.y=u.clientY+document.body.scrollTop+document.documentElement.scrollTop,h};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(l)},getPageScroll:function(){var l=document.documentElement||{},u=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(u.scrollLeft||u.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(l.scrollLeft||l.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(l){if(typeof window.scrollTo<"u")e.setPageScroll=function(d){window.scrollTo(d.x,d.y)};else{var u=e.getPageScroll();if(u.x===l.x&&u.y===l.y)return;document.body.scrollLeft=l.x,document.body.scrollTop=l.y;var h=e.getPageScroll();if(h.x!==u.x&&h.y!==u.y){e.setPageScroll=function(d){document.body.scrollLeft=d.x,document.body.scrollTop=d.y};return}if(document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y,h=e.getPageScroll(),h.x!==u.x&&h.y!==u.y){e.setPageScroll=function(d){document.documentElement.scrollLeft=d.x,document.documentElement.scrollTop=d.y};return}e.setPageScroll=function(d){}}e.setPageScroll(l)},getWindowSize:function(){var l=document.documentElement||{},u=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(l.clientWidth||l.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(u.clientWidth||u.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(l){l=e.getElement(l);var u=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(u[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(u[1].style,{display:"table-row"}),e.extend(u[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),u[0].appendChild(u[1]),u[1].appendChild(u[2]),u[2].appendChild(l),u[0]},makeNeutralElement:function(l){var u=document.createElement(l),h=u.style;return h.background="transparent none",h.border="none",h.margin="0px",h.padding="0px",h.position="static",u},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(l){var u=e.makeNeutralElement("img");return u.src=l,u},setElementOpacity:function(l,u,h){var d,f;l=e.getElement(l),h&&!e.Browser.alpha&&(u=Math.round(u)),e.Browser.opacity?l.style.opacity=u<1?u:"":u<1?(d=Math.round(100*u),f="alpha(opacity="+d+")",l.style.filter=f):l.style.filter=""},setElementTouchActionNone:function(l){l=e.getElement(l),typeof l.style.touchAction<"u"?l.style.touchAction="none":typeof l.style.msTouchAction<"u"&&(l.style.msTouchAction="none")},setElementPointerEvents:function(l,u){l=e.getElement(l),typeof l.style<"u"&&typeof l.style.pointerEvents<"u"&&(l.style.pointerEvents=u)},setElementPointerEventsNone:function(l){e.setElementPointerEvents(l,"none")},addClass:function(l,u){l=e.getElement(l),l.className?(" "+l.className+" ").indexOf(" "+u+" ")===-1&&(l.className+=" "+u):l.className=u},indexOf:function(l,u,h){return Array.prototype.indexOf?this.indexOf=function(d,f,m){return d.indexOf(f,m)}:this.indexOf=function(d,f,m){var v,E=m||0,T;if(!d)throw new TypeError;if(T=d.length,T===0||E>=T)return-1;for(E<0&&(E=T-Math.abs(E)),v=E;v<T;v++)if(d[v]===f)return v;return-1},this.indexOf(l,u,h)},removeClass:function(l,u){var h,d=[],f;for(l=e.getElement(l),h=l.className.split(/\s+/),f=0;f<h.length;f++)h[f]&&h[f]!==u&&d.push(h[f]);l.className=d.join(" ")},normalizeEventListenerOptions:function(l){var u;return typeof l<"u"?typeof l=="boolean"?u=e.supportsEventListenerOptions?{capture:l}:l:u=e.supportsEventListenerOptions?l:typeof l.capture<"u"?l.capture:!1:u=e.supportsEventListenerOptions?{capture:!1}:!1,u},addEvent:function(){if(e.supportsAddEventListener)return function(l,u,h,d){d=e.normalizeEventListenerOptions(d),l=e.getElement(l),l.addEventListener(u,h,d)};if(document.documentElement.attachEvent&&document.attachEvent)return function(l,u,h){l=e.getElement(l),l.attachEvent("on"+u,h)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(l,u,h,d){d=e.normalizeEventListenerOptions(d),l=e.getElement(l),l.removeEventListener(u,h,d)};if(document.documentElement.detachEvent&&document.detachEvent)return function(l,u,h){l=e.getElement(l),l.detachEvent("on"+u,h)};throw new Error("No known event model.")}(),cancelEvent:function(l){l.preventDefault()},eventIsCanceled:function(l){return l.defaultPrevented},stopEvent:function(l){l.stopPropagation()},createCallback:function(l,u){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var h=[],d;for(d=2;d<arguments.length;d++)h.push(arguments[d]);return function(){var f=h.concat([]),m;for(m=0;m<arguments.length;m++)f.push(arguments[m]);return u.apply(l,f)}},getUrlParameter:function(l){var u=o[l];return u||null},getUrlProtocol:function(l){var u=l.match(/^([a-z]+:)\/\//i);return u===null?window.location.protocol:u[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(l,u,h){var d,f,m,v;e.isPlainObject(l)&&(u=l.success,h=l.error,d=l.withCredentials,f=l.headers,m=l.responseType||null,v=l.postData||null,l=l.url);var E=e.getUrlProtocol(l),T=e.createAjaxRequest();if(!e.isFunction(u))throw new Error("makeAjaxRequest requires a success callback");T.onreadystatechange=function(){T.readyState===4&&(T.onreadystatechange=function(){},T.status>=200&&T.status<300||T.status===0&&E!=="http:"&&E!=="https:"?u(T):e.isFunction(h)?h(T):e.console.error("AJAX request returned %d: %s",T.status,l))};var x=v?"POST":"GET";try{if(T.open(x,l,!0),m&&(T.responseType=m),f)for(var O in f)Object.prototype.hasOwnProperty.call(f,O)&&f[O]&&T.setRequestHeader(O,f[O]);d&&(T.withCredentials=!0),T.send(v)}catch(V){e.console.error("%s while making AJAX request: %s",V.name,V.message),T.onreadystatechange=function(){},e.isFunction(h)&&h(T,V)}return T},jsonp:function(l){var u,h=l.url,d=document.head||document.getElementsByTagName("head")[0]||document.documentElement,f=l.callbackName||"openseadragon"+e.now(),m=window[f],v="$1"+f+"$2",E=l.param||"callback",T=l.callback;h=h.replace(/(=)\?(&|$)|\?\?/i,v),h+=(/\?/.test(h)?"&":"?")+E+"="+f,window[f]=function(x){if(m)window[f]=m;else try{delete window[f]}catch{}T&&e.isFunction(T)&&T(x)},u=document.createElement("script"),(l.async!==void 0||l.async!==!1)&&(u.async="async"),l.scriptCharset&&(u.charset=l.scriptCharset),u.src=h,u.onload=u.onreadystatechange=function(x,O){(O||!u.readyState||/loaded|complete/.test(u.readyState))&&(u.onload=u.onreadystatechange=null,d&&u.parentNode&&d.removeChild(u),u=void 0)},d.insertBefore(u,d.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(l){if(window.DOMParser)e.parseXml=function(u){var h=null,d;return d=new DOMParser,h=d.parseFromString(u,"text/xml"),h};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(l)},parseJSON:function(l){return e.parseJSON=window.JSON.parse,e.parseJSON(l)},imageFormatSupported:function(l){return l=l||"",!!r[l.toLowerCase()]},setImageFormatsSupported:function(l){e.extend(r,l)}});var n=function(l){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var l=navigator.appVersion,u=navigator.userAgent,h;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(u.substring(u.indexOf("MSIE")+5,u.indexOf(";",u.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(u.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(u.substring(u.indexOf("Edge")+5))):u.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(u.substring(u.indexOf("Edg")+4))):u.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(u.substring(u.indexOf("Firefox")+8))):u.indexOf("Safari")>=0?(e.Browser.vendor=u.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(u.substring(u.substring(0,u.indexOf("Safari")).lastIndexOf("/")+1,u.indexOf("Safari")))):(h=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),h.exec(u)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(l);break}var d=window.location.search.substring(1),f=d.split("&"),m,v,E;for(E=0;E<f.length;E++)if(m=f[E],v=m.indexOf("="),v>0){var T=m.substring(0,v),x=m.substring(v+1);try{o[T]=decodeURIComponent(x)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",T,x)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(l){var u=l.requestAnimationFrame||l.mozRequestAnimationFrame||l.webkitRequestAnimationFrame||l.msRequestAnimationFrame,h=l.cancelAnimationFrame||l.mozCancelAnimationFrame||l.webkitCancelAnimationFrame||l.msCancelAnimationFrame;if(u&&h)e.requestAnimationFrame=function(){return u.apply(l,arguments)},e.cancelAnimationFrame=function(){return h.apply(l,arguments)};else{var d=[],f=[],m=0,v;e.requestAnimationFrame=function(E){return d.push([++m,E]),v||(v=setInterval(function(){if(d.length){var T=e.now(),x=f;for(f=d,d=x;f.length;)f.shift()[1](T)}else clearInterval(v),v=void 0},1e3/50)),m},e.cancelAnimationFrame=function(E){var T,x;for(T=0,x=d.length;T<x;T+=1)if(d[T][0]===E){d.splice(T,1);return}for(T=0,x=f.length;T<x;T+=1)if(f[T][0]===E){f.splice(T,1);return}}}}(window);function a(l,u){return u&&l!==document.body?document.body:l.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(Yh,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var l=o[0*3+0],u=o[0*3+1],h=o[0*3+2],d=o[1*3+0],f=o[1*3+1],m=o[1*3+2],v=o[2*3+0],E=o[2*3+1],T=o[2*3+2],x=a[0*3+0],O=a[0*3+1],V=a[0*3+2],G=a[1*3+0],Y=a[1*3+1],J=a[1*3+2],A=a[2*3+0],S=a[2*3+1],R=a[2*3+2];return new i([x*l+O*d+V*v,x*u+O*f+V*E,x*h+O*m+V*T,G*l+Y*d+J*v,G*u+Y*f+J*E,G*h+Y*m+J*T,A*l+S*d+R*v,A*u+S*f+R*E,A*h+S*m+R*T])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var l=this;o=o||1;var u=0,h=function(d){return u++,u===o&&l.removeHandler(i,h),n(d)};return this.addHandler(i,h,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var l=a.length,u={handler:n,userData:r||null,priority:o||0};for(a[l]=u;l>0&&a[l-1].priority<a[l].priority;)a[l]=a[l-1],a[l-1]=u,l--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,l=n.length;for(a=0;a<l;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(_){var w=arguments;e.isPlainObject(_)||(_={element:w[0],clickTimeThreshold:w[1],clickDistThreshold:w[2]}),this.hash=Math.random(),this.element=e.getElement(_.element),this.clickTimeThreshold=_.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=_.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=_.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=_.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=_.userData||null,this.stopDelay=_.stopDelay||50,this.preProcessEventHandler=_.preProcessEventHandler||null,this.contextMenuHandler=_.contextMenuHandler||null,this.enterHandler=_.enterHandler||null,this.leaveHandler=_.leaveHandler||null,this.exitHandler=_.exitHandler||null,this.overHandler=_.overHandler||null,this.outHandler=_.outHandler||null,this.pressHandler=_.pressHandler||null,this.nonPrimaryPressHandler=_.nonPrimaryPressHandler||null,this.releaseHandler=_.releaseHandler||null,this.nonPrimaryReleaseHandler=_.nonPrimaryReleaseHandler||null,this.moveHandler=_.moveHandler||null,this.scrollHandler=_.scrollHandler||null,this.clickHandler=_.clickHandler||null,this.dblClickHandler=_.dblClickHandler||null,this.dragHandler=_.dragHandler||null,this.dragEndHandler=_.dragEndHandler||null,this.pinchHandler=_.pinchHandler||null,this.stopHandler=_.stopHandler||null,this.keyDownHandler=_.keyDownHandler||null,this.keyUpHandler=_.keyUpHandler||null,this.keyHandler=_.keyHandler||null,this.focusHandler=_.focusHandler||null,this.blurHandler=_.blurHandler||null;var C=this;i[this.hash]={click:function(I){V(C,I)},dblclick:function(I){G(C,I)},keydown:function(I){Y(C,I)},keyup:function(I){J(C,I)},keypress:function(I){A(C,I)},focus:function(I){S(C,I)},blur:function(I){R(C,I)},contextmenu:function(I){M(C,I)},wheel:function(I){k(C,I)},mousewheel:function(I){F(C,I)},DOMMouseScroll:function(I){F(C,I)},MozMousePixelScroll:function(I){F(C,I)},losecapture:function(I){xe(C,I)},mouseenter:function(I){K(C,I)},mouseleave:function(I){be(C,I)},mouseover:function(I){ge(C,I)},mouseout:function(I){ye(C,I)},mousedown:function(I){Ce(C,I)},mouseup:function(I){He(C,I)},mousemove:function(I){Ke(C,I)},touchstart:function(I){Pe(C,I)},touchend:function(I){te(C,I)},touchmove:function(I){se(C,I)},touchcancel:function(I){W(C,I)},gesturestart:function(I){ne(C,I)},gesturechange:function(I){U(C,I)},gotpointercapture:function(I){fe(C,I)},lostpointercapture:function(I){re(C,I)},pointerenter:function(I){K(C,I)},pointerleave:function(I){be(C,I)},pointerover:function(I){ge(C,I)},pointerout:function(I){ye(C,I)},pointerdown:function(I){Ce(C,I)},pointerup:function(I){He(C,I)},pointermove:function(I){Ke(C,I)},pointercancel:function(I){gt(C,I)},pointerupcaptured:function(I){pt(C,I)},pointermovecaptured:function(I){We(C,I)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),_.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){l(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(_){return _?a(this):l(this),this},getActivePointersListByType:function(_){var w=i[this.hash],C,I=w?w.activePointersLists.length:0,H;for(C=0;C<I;C++)if(w.activePointersLists[C].type===_)return w.activePointersLists[C];return H=new e.MouseTracker.GesturePointList(_),w&&w.activePointersLists.push(H),H},getActivePointerCount:function(){var _=i[this.hash],w,C=_.activePointersLists.length,I=0;for(w=0;w<C;w++)I+=_.activePointersLists[w].getLength();return I},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(_){try{return _.addEventListener&&_.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var _=[],w=0,C=0,I=function(ke,ve){return ke.hash.toString()+ve.type+ve.id.toString()},H=function(){var ke,ve=_.length,lt,Ge,At=e.now(),Mt,Zt,Xt;for(Mt=At-C,C=At,ke=0;ke<ve;ke++)lt=_[ke],Ge=lt.gPoint,Ge.direction=Math.atan2(Ge.currentPos.y-lt.lastPos.y,Ge.currentPos.x-lt.lastPos.x),Zt=lt.lastPos.distanceTo(Ge.currentPos),lt.lastPos=Ge.currentPos,Xt=1e3*Zt/(Mt+1),Ge.speed=.75*Xt+.25*Ge.speed},Q=function(ke,ve){var lt=I(ke,ve);_.push({guid:lt,gPoint:ve,lastPos:ve.currentPos}),_.length===1&&(C=e.now(),w=window.setInterval(H,50))},de=function(ke,ve){var lt=I(ke,ve),Ge,At=_.length;for(Ge=0;Ge<At;Ge++)if(_[Ge].guid===lt){_.splice(Ge,1),At--,At===0&&window.clearInterval(w);break}};return{addPoint:Q,removePoint:de}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var _=document.createElement("div");return e.isFunction(_.setPointerCapture)&&e.isFunction(_.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var _=document.createElement("div");return e.isFunction(_.setCapture)&&e.isFunction(_.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(_){this._gPoints=[],this.type=_,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(_){return this._gPoints.push(_)},removeById:function(_){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].id===_){this._gPoints.splice(w,1);break}return this._gPoints.length},getByIndex:function(_){return _<this._gPoints.length?this._gPoints[_]:null},getById:function(_){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].id===_)return this._gPoints[w];return null},getPrimary:function(_){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].isPrimary)return this._gPoints[w];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(_){var w=i[_.hash],C,I,H,Q,de,ke=w.activePointersLists.length;for(C=0;C<ke;C++)if(H=w.activePointersLists[C],H.getLength()>0){for(de=[],Q=H.asArray(),I=0;I<Q.length;I++)de.push(Q[I]);for(I=0;I<de.length;I++)at(_,H,de[I])}for(C=0;C<ke;C++)w.activePointersLists.pop();w.sentDragEvent=!1}function a(_){var w=i[_.hash],C,I;if(!w.tracking){for(I=0;I<e.MouseTracker.subscribeEvents.length;I++)C=e.MouseTracker.subscribeEvents[I],e.addEvent(_.element,C,w[C],C===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(_),w.tracking=!0}}function l(_){var w=i[_.hash],C,I;if(w.tracking){for(I=0;I<e.MouseTracker.subscribeEvents.length;I++)C=e.MouseTracker.subscribeEvents[I],e.removeEvent(_.element,C,w[C],!1);o(_),w.tracking=!1}}function u(_,w){var C=i[_.hash];if(w==="pointerevent")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(w==="mouse")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(w==="touch")return{upName:"touchend",upHandler:C.touchendcaptured,moveName:"touchmove",moveHandler:C.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function h(_,w){var C;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{_.element.setPointerCapture(w.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else _.element.setCapture(!0);else C=u(_,e.MouseTracker.havePointerEvents?"pointerevent":w.type),n&&r(window.top)&&e.addEvent(window.top,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0);N(_,w,!0)}function d(_,w){var C,I,H;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(I=_.getActivePointersListByType(w.type),H=I.getById(w.id),!H||!H.captured)return;try{_.element.releasePointerCapture(w.id)}catch{}}else _.element.releaseCapture();else C=u(_,e.MouseTracker.havePointerEvents?"pointerevent":w.type),n&&r(window.top)&&e.removeEvent(window.top,C.upName,C.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0);N(_,w,!1)}function f(_){return e.MouseTracker.havePointerEvents?_.pointerId:e.MouseTracker.mousePointerId}function m(_){return e.MouseTracker.havePointerEvents&&_.pointerType?_.pointerType:"mouse"}function v(_){return e.MouseTracker.havePointerEvents?_.isPrimary:!0}function E(_){return e.getMousePosition(_)}function T(_,w){return x(E(_),w)}function x(_,w){var C=e.getElementOffset(w);return _.minus(C)}function O(_,w){return new e.Point((_.x+w.x)/2,(_.y+w.y)/2)}function V(_,w){var C={originalEvent:w,eventType:"click",pointerType:"mouse",isEmulated:!1};b(_,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(w),C.stopPropagation&&e.stopEvent(w)}function G(_,w){var C={originalEvent:w,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};b(_,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(w),C.stopPropagation&&e.stopEvent(w)}function Y(_,w){var C=null,I={originalEvent:w,eventType:"keydown",pointerType:"",isEmulated:!1};b(_,I),_.keyDownHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:_,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:I.preventDefault||I.defaultPrevented,userData:_.userData},_.keyDownHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function J(_,w){var C=null,I={originalEvent:w,eventType:"keyup",pointerType:"",isEmulated:!1};b(_,I),_.keyUpHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:_,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:I.preventDefault||I.defaultPrevented,userData:_.userData},_.keyUpHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function A(_,w){var C=null,I={originalEvent:w,eventType:"keypress",pointerType:"",isEmulated:!1};b(_,I),_.keyHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:_,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:I.preventDefault||I.defaultPrevented,userData:_.userData},_.keyHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function S(_,w){var C={originalEvent:w,eventType:"focus",pointerType:"",isEmulated:!1};b(_,C),_.focusHandler&&!C.preventGesture&&_.focusHandler({eventSource:_,originalEvent:w,userData:_.userData})}function R(_,w){var C={originalEvent:w,eventType:"blur",pointerType:"",isEmulated:!1};b(_,C),_.blurHandler&&!C.preventGesture&&_.blurHandler({eventSource:_,originalEvent:w,userData:_.userData})}function M(_,w){var C=null,I={originalEvent:w,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};b(_,I),_.contextMenuHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:_,position:x(E(w),_.element),originalEvent:I.originalEvent,preventDefault:I.preventDefault||I.defaultPrevented,userData:_.userData},_.contextMenuHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function k(_,w){D(_,w,w)}function F(_,w){var C={target:w.target||w.srcElement,type:"wheel",shiftKey:w.shiftKey||!1,clientX:w.clientX,clientY:w.clientY,pageX:w.pageX?w.pageX:w.clientX,pageY:w.pageY?w.pageY:w.clientY,deltaMode:w.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?C.deltaY=-w.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:C.deltaY=w.detail,D(_,C,w)}function D(_,w,C){var I=0,H,Q=null;I=w.deltaY?w.deltaY<0?1:-1:0,H={originalEvent:w,eventType:"wheel",pointerType:"mouse",isEmulated:w!==C},b(_,H),_.scrollHandler&&!H.preventGesture&&!H.defaultPrevented&&(Q={eventSource:_,pointerType:"mouse",position:T(w,_.element),scroll:I,shift:w.shiftKey,isTouchEvent:!1,originalEvent:C,preventDefault:H.preventDefault||H.defaultPrevented,userData:_.userData},_.scrollHandler(Q)),H.stopPropagation&&e.stopEvent(C),(Q&&Q.preventDefault||H.preventDefault&&!H.defaultPrevented)&&e.cancelEvent(C)}function xe(_,w){var C={id:e.MouseTracker.mousePointerId,type:"mouse"},I={originalEvent:w,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};b(_,I),w.target===_.element&&N(_,C,!1),I.stopPropagation&&e.stopEvent(w)}function Pe(_,w){var C,I,H=w.changedTouches.length,Q,de=_.getActivePointersListByType("touch");C=e.now(),de.getLength()>w.touches.length-H&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var ke={originalEvent:w,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(b(_,ke),I=0;I<H;I++)Q={id:w.changedTouches[I].identifier,type:"touch",isPrimary:de.getLength()===0,currentPos:E(w.changedTouches[I]),currentTime:C},j(_,ke,Q),me(_,ke,Q,0),N(_,Q,!0);ke.preventDefault&&!ke.defaultPrevented&&e.cancelEvent(w),ke.stopPropagation&&e.stopEvent(w)}function te(_,w){var C,I,H=w.changedTouches.length,Q;C=e.now();var de={originalEvent:w,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(b(_,de),I=0;I<H;I++)Q={id:w.changedTouches[I].identifier,type:"touch",currentPos:E(w.changedTouches[I]),currentTime:C},Ie(_,de,Q,0),N(_,Q,!1),$(_,de,Q);de.preventDefault&&!de.defaultPrevented&&e.cancelEvent(w),de.stopPropagation&&e.stopEvent(w)}function se(_,w){var C,I,H=w.changedTouches.length,Q;C=e.now();var de={originalEvent:w,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(b(_,de),I=0;I<H;I++)Q={id:w.changedTouches[I].identifier,type:"touch",currentPos:E(w.changedTouches[I]),currentTime:C},_e(_,de,Q);de.preventDefault&&!de.defaultPrevented&&e.cancelEvent(w),de.stopPropagation&&e.stopEvent(w)}function W(_,w){var C=w.changedTouches.length,I,H,Q={originalEvent:w,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(b(_,Q),I=0;I<C;I++)H={id:w.changedTouches[I].identifier,type:"touch"},ce(_,Q,H);Q.stopPropagation&&e.stopEvent(w)}function ne(_,w){return e.eventIsCanceled(w)||w.preventDefault(),!1}function U(_,w){return e.eventIsCanceled(w)||w.preventDefault(),!1}function fe(_,w){var C={originalEvent:w,eventType:"gotpointercapture",pointerType:m(w),isEmulated:!1};b(_,C),w.target===_.element&&N(_,{id:w.pointerId,type:m(w)},!0),C.stopPropagation&&e.stopEvent(w)}function re(_,w){var C={originalEvent:w,eventType:"lostpointercapture",pointerType:m(w),isEmulated:!1};b(_,C),w.target===_.element&&N(_,{id:w.pointerId,type:m(w)},!1),C.stopPropagation&&e.stopEvent(w)}function K(_,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()},I={originalEvent:w,eventType:"pointerenter",pointerType:C.type,isEmulated:!1};b(_,I),j(_,I,C)}function be(_,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()},I={originalEvent:w,eventType:"pointerleave",pointerType:C.type,isEmulated:!1};b(_,I),$(_,I,C)}function ge(_,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()},I={originalEvent:w,eventType:"pointerover",pointerType:C.type,isEmulated:!1};b(_,I),ae(_,I,C),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function ye(_,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()},I={originalEvent:w,eventType:"pointerout",pointerType:C.type,isEmulated:!1};b(_,I),Z(_,I,C),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function Ce(_,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()},I=e.MouseTracker.havePointerEvents&&C.type==="touch",H={originalEvent:w,eventType:"pointerdown",pointerType:C.type,isEmulated:!1};b(_,H),me(_,H,C,w.button),H.preventDefault&&!H.defaultPrevented&&e.cancelEvent(w),H.stopPropagation&&e.stopEvent(w),H.shouldCapture&&(I?N(_,C,!0):h(_,C))}function He(_,w){nt(_,w)}function pt(_,w){var C=_.getActivePointersListByType(m(w));C.getById(w.pointerId)&&nt(_,w),e.stopEvent(w)}function nt(_,w){var C;C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()};var I={originalEvent:w,eventType:"pointerup",pointerType:C.type,isEmulated:!1};b(_,I),Ie(_,I,C,w.button),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w),I.shouldReleaseCapture&&(w.target===_.element?d(_,C):N(_,C,!1))}function Ke(_,w){Et(_,w)}function We(_,w){var C=_.getActivePointersListByType(m(w));C.getById(w.pointerId)&&Et(_,w),e.stopEvent(w)}function Et(_,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:E(w),currentTime:e.now()},I={originalEvent:w,eventType:"pointermove",pointerType:C.type,isEmulated:!1};b(_,I),_e(_,I,C),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(w),I.stopPropagation&&e.stopEvent(w)}function gt(_,w){var C={id:w.pointerId,type:m(w)},I={originalEvent:w,eventType:"pointercancel",pointerType:C.type,isEmulated:!1};b(_,I),ce(_,I,C),I.stopPropagation&&e.stopEvent(w)}function Re(_,w){return w.speed=0,w.direction=0,w.contactPos=w.currentPos,w.contactTime=w.currentTime,w.lastPos=w.currentPos,w.lastTime=w.currentTime,_.add(w)}function at(_,w,C){var I,H=w.getById(C.id);return H?(H.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),d(_,H)),w.removeContact(),I=w.removeById(C.id)):I=w.getLength(),I}function g(_,w){switch(w.eventType){case"pointermove":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!_.hasGestureHandlers,w.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break;case"pointerdown":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!_.hasGestureHandlers,w.stopPropagation=!1;break;case"pointerup":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!_.hasGestureHandlers,w.stopPropagation=!1;break;case"wheel":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!_.hasScrollHandler,w.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":w.isStoppable=!0,w.isCancelable=!1,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break;case"click":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!!_.clickHandler,w.preventGesture=!1,w.stopPropagation=!1;break;case"dblclick":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!!_.dblClickHandler,w.preventGesture=!1,w.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:w.isStoppable=!1,w.isCancelable=!1,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break}}function b(_,w){w.eventSource=_,w.eventPhase=w.originalEvent&&typeof w.originalEvent.eventPhase<"u"?w.originalEvent.eventPhase:0,w.defaultPrevented=e.eventIsCanceled(w.originalEvent),w.shouldCapture=!1,w.shouldReleaseCapture=!1,w.userData=_.userData,g(_,w),_.preProcessEventHandler&&_.preProcessEventHandler(w)}function N(_,w,C){var I=_.getActivePointersListByType(w.type),H=I.getById(w.id);H?C&&!H.captured?(H.captured=!0,I.captureCount++):!C&&H.captured&&(H.captured=!1,I.captureCount--,I.captureCount<0&&(I.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function j(_,w,C){var I=_.getActivePointersListByType(C.type),H;H=I.getById(C.id),H?(H.insideElement=!0,H.lastPos=H.currentPos,H.lastTime=H.currentTime,H.currentPos=C.currentPos,H.currentTime=C.currentTime,C=H):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,Re(I,C)),_.enterHandler&&_.enterHandler({eventSource:_,pointerType:C.type,position:x(C.currentPos,_.element),buttons:I.buttons,pointers:_.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData})}function $(_,w,C){var I=_.getActivePointersListByType(C.type),H,Q;H=I.getById(C.id),H?(H.captured?(H.insideElement=!1,H.lastPos=H.currentPos,H.lastTime=H.currentTime,H.currentPos=C.currentPos,H.currentTime=C.currentTime):at(_,I,H),C=H):(C.captured=!1,C.insideElementPressed=!1),(_.leaveHandler||_.exitHandler)&&(Q={eventSource:_,pointerType:C.type,position:C.currentPos&&x(C.currentPos,_.element),buttons:I.buttons,pointers:_.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData},_.leaveHandler&&_.leaveHandler(Q),_.exitHandler&&_.exitHandler(Q))}function ae(_,w,C){var I,H;I=_.getActivePointersListByType(C.type),H=I.getById(C.id),H?C=H:(C.captured=!1,C.insideElementPressed=!1),_.overHandler&&_.overHandler({eventSource:_,pointerType:C.type,position:x(C.currentPos,_.element),buttons:I.buttons,pointers:_.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData})}function Z(_,w,C){var I,H;I=_.getActivePointersListByType(C.type),H=I.getById(C.id),H?C=H:(C.captured=!1,C.insideElementPressed=!1),_.outHandler&&_.outHandler({eventSource:_,pointerType:C.type,position:C.currentPos&&x(C.currentPos,_.element),buttons:I.buttons,pointers:_.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData})}function me(_,w,C,I){var H=i[_.hash],Q=_.getActivePointersListByType(C.type),de;if(typeof w.originalEvent.buttons<"u"?Q.buttons=w.originalEvent.buttons:I===0?Q.buttons|=1:I===1?Q.buttons|=4:I===2?Q.buttons|=2:I===3?Q.buttons|=8:I===4?Q.buttons|=16:I===5&&(Q.buttons|=32),I!==0){w.shouldCapture=!1,w.shouldReleaseCapture=!1,_.nonPrimaryPressHandler&&!w.preventGesture&&!w.defaultPrevented&&(w.preventDefault=!0,_.nonPrimaryPressHandler({eventSource:_,pointerType:C.type,position:x(C.currentPos,_.element),button:I,buttons:Q.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData}));return}de=Q.getById(C.id),de?(de.insideElementPressed=!0,de.insideElement=!0,de.originalTarget=w.originalEvent.target,de.contactPos=C.currentPos,de.contactTime=C.currentTime,de.lastPos=de.currentPos,de.lastTime=de.currentTime,de.currentPos=C.currentPos,de.currentTime=C.currentTime,C=de):(C.captured=!1,C.insideElementPressed=!0,C.insideElement=!0,C.originalTarget=w.originalEvent.target,Re(Q,C)),Q.addContact(),!w.preventGesture&&!w.defaultPrevented?(w.shouldCapture=!0,w.shouldReleaseCapture=!1,w.preventDefault=!0,(_.dragHandler||_.dragEndHandler||_.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(_,C),Q.contacts===1?_.pressHandler&&!w.preventGesture&&_.pressHandler({eventSource:_,pointerType:C.type,position:x(C.contactPos,_.element),buttons:Q.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData}):Q.contacts===2&&_.pinchHandler&&C.type==="touch"&&(H.pinchGPoints=Q.asArray(),H.lastPinchDist=H.currentPinchDist=H.pinchGPoints[0].currentPos.distanceTo(H.pinchGPoints[1].currentPos),H.lastPinchCenter=H.currentPinchCenter=O(H.pinchGPoints[0].currentPos,H.pinchGPoints[1].currentPos))):(w.shouldCapture=!1,w.shouldReleaseCapture=!1)}function Ie(_,w,C,I){var H=i[_.hash],Q=_.getActivePointersListByType(C.type),de,ke,ve,lt=!1,Ge;if(typeof w.originalEvent.buttons<"u"?Q.buttons=w.originalEvent.buttons:I===0?Q.buttons^=-2:I===1?Q.buttons^=-5:I===2?Q.buttons^=-3:I===3?Q.buttons^=-9:I===4?Q.buttons^=-17:I===5&&(Q.buttons^=-33),w.shouldCapture=!1,I!==0){w.shouldReleaseCapture=!1,_.nonPrimaryReleaseHandler&&!w.preventGesture&&!w.defaultPrevented&&(w.preventDefault=!0,_.nonPrimaryReleaseHandler({eventSource:_,pointerType:C.type,position:x(C.currentPos,_.element),button:I,buttons:Q.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData}));return}ve=Q.getById(C.id),ve?(Q.removeContact(),ve.captured&&(lt=!0),ve.lastPos=ve.currentPos,ve.lastTime=ve.currentTime,ve.currentPos=C.currentPos,ve.currentTime=C.currentTime,ve.insideElement||at(_,Q,ve),de=ve.currentPos,ke=ve.currentTime):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,Re(Q,C),ve=C),!w.preventGesture&&!w.defaultPrevented&&(lt?(w.shouldReleaseCapture=!0,w.preventDefault=!0,(_.dragHandler||_.dragEndHandler||_.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(_,ve),Q.contacts===0?(_.releaseHandler&&de&&_.releaseHandler({eventSource:_,pointerType:ve.type,position:x(de,_.element),buttons:Q.buttons,insideElementPressed:ve.insideElementPressed,insideElementReleased:ve.insideElement,isTouchEvent:ve.type==="touch",originalEvent:w.originalEvent,userData:_.userData}),_.dragEndHandler&&H.sentDragEvent&&_.dragEndHandler({eventSource:_,pointerType:ve.type,position:x(ve.currentPos,_.element),speed:ve.speed,direction:ve.direction,shift:w.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:w.originalEvent,userData:_.userData}),H.sentDragEvent=!1,(_.clickHandler||_.dblClickHandler)&&ve.insideElement&&(Ge=ke-ve.contactTime<=_.clickTimeThreshold&&ve.contactPos.distanceTo(de)<=_.clickDistThreshold,_.clickHandler&&_.clickHandler({eventSource:_,pointerType:ve.type,position:x(ve.currentPos,_.element),quick:Ge,shift:w.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:w.originalEvent,originalTarget:ve.originalTarget,userData:_.userData}),_.dblClickHandler&&Ge&&(Q.clicks++,Q.clicks===1?(H.lastClickPos=de,H.dblClickTimeOut=setTimeout(function(){Q.clicks=0},_.dblClickTimeThreshold)):Q.clicks===2&&(clearTimeout(H.dblClickTimeOut),Q.clicks=0,H.lastClickPos.distanceTo(de)<=_.dblClickDistThreshold&&_.dblClickHandler({eventSource:_,pointerType:ve.type,position:x(ve.currentPos,_.element),shift:w.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:w.originalEvent,userData:_.userData}),H.lastClickPos=null)))):Q.contacts===2&&_.pinchHandler&&ve.type==="touch"&&(H.pinchGPoints=Q.asArray(),H.lastPinchDist=H.currentPinchDist=H.pinchGPoints[0].currentPos.distanceTo(H.pinchGPoints[1].currentPos),H.lastPinchCenter=H.currentPinchCenter=O(H.pinchGPoints[0].currentPos,H.pinchGPoints[1].currentPos))):(w.shouldReleaseCapture=!1,_.releaseHandler&&de&&(_.releaseHandler({eventSource:_,pointerType:ve.type,position:x(de,_.element),buttons:Q.buttons,insideElementPressed:ve.insideElementPressed,insideElementReleased:ve.insideElement,isTouchEvent:ve.type==="touch",originalEvent:w.originalEvent,userData:_.userData}),w.preventDefault=!0)))}function _e(_,w,C){var I=i[_.hash],H=_.getActivePointersListByType(C.type),Q,de,ke;if(typeof w.originalEvent.buttons<"u"&&(H.buttons=w.originalEvent.buttons),Q=H.getById(C.id),Q)Q.lastPos=Q.currentPos,Q.lastTime=Q.currentTime,Q.currentPos=C.currentPos,Q.currentTime=C.currentTime;else return;w.shouldCapture=!1,w.shouldReleaseCapture=!1,_.stopHandler&&C.type==="mouse"&&(clearTimeout(_.stopTimeOut),_.stopTimeOut=setTimeout(function(){Ne(_,w.originalEvent,C.type)},_.stopDelay)),H.contacts===0?_.moveHandler&&_.moveHandler({eventSource:_,pointerType:C.type,position:x(C.currentPos,_.element),buttons:H.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:_.userData}):H.contacts===1?(_.moveHandler&&(Q=H.asArray()[0],_.moveHandler({eventSource:_,pointerType:Q.type,position:x(Q.currentPos,_.element),buttons:H.buttons,isTouchEvent:Q.type==="touch",originalEvent:w.originalEvent,userData:_.userData})),_.dragHandler&&!w.preventGesture&&!w.defaultPrevented&&(Q=H.asArray()[0],ke=Q.currentPos.minus(Q.lastPos),_.dragHandler({eventSource:_,pointerType:Q.type,position:x(Q.currentPos,_.element),buttons:H.buttons,delta:ke,speed:Q.speed,direction:Q.direction,shift:w.originalEvent.shiftKey,isTouchEvent:Q.type==="touch",originalEvent:w.originalEvent,userData:_.userData}),w.preventDefault=!0,I.sentDragEvent=!0)):H.contacts===2&&(_.moveHandler&&(de=H.asArray(),_.moveHandler({eventSource:_,pointerType:de[0].type,position:x(O(de[0].currentPos,de[1].currentPos),_.element),buttons:H.buttons,isTouchEvent:de[0].type==="touch",originalEvent:w.originalEvent,userData:_.userData})),_.pinchHandler&&C.type==="touch"&&!w.preventGesture&&!w.defaultPrevented&&(ke=I.pinchGPoints[0].currentPos.distanceTo(I.pinchGPoints[1].currentPos),ke!==I.currentPinchDist&&(I.lastPinchDist=I.currentPinchDist,I.currentPinchDist=ke,I.lastPinchCenter=I.currentPinchCenter,I.currentPinchCenter=O(I.pinchGPoints[0].currentPos,I.pinchGPoints[1].currentPos),_.pinchHandler({eventSource:_,pointerType:"touch",gesturePoints:I.pinchGPoints,lastCenter:x(I.lastPinchCenter,_.element),center:x(I.currentPinchCenter,_.element),lastDistance:I.lastPinchDist,distance:I.currentPinchDist,shift:w.originalEvent.shiftKey,originalEvent:w.originalEvent,userData:_.userData}),w.preventDefault=!0)))}function ce(_,w,C){var I=_.getActivePointersListByType(C.type),H;H=I.getById(C.id),H&&at(_,I,H)}function Ne(_,w,C){_.stopHandler&&_.stopHandler({eventSource:_,pointerType:C,position:T(w,_.element),buttons:_.getActivePointersListByType(C).buttons,isTouchEvent:C==="touch",originalEvent:w,userData:_.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(g){var b=arguments,N=this,j;e.isPlainObject(g)||(g={id:b[0],xmlPath:b.length>1?b[1]:void 0,prefixUrl:b.length>2?b[2]:void 0,controls:b.length>3?b[3]:void 0,overlays:b.length>4?b[4]:void 0}),g.config&&(e.extend(!0,g,g.config),delete g.config);let $=["useCanvas"];if(g.drawerOptions=Object.assign({},$.reduce((Z,me)=>(Z[me]=g[me],delete g[me],Z),{}),g.drawerOptions),e.extend(!0,this,{id:g.id,hash:g.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,g),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(Z){var me=e.getString("Errors.OpenFailed",Z.eventSource,Z.message);N._showMessage(me)}),e.ControlDock.call(this,g),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(Z){Z.width="100%",Z.height="100%",Z.overflow="hidden",Z.position="absolute",Z.top="0px",Z.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),g.tabIndex!==""&&(this.canvas.tabIndex=g.tabIndex===void 0?0:g.tabIndex),this.container.className="openseadragon-container",function(Z){Z.width="100%",Z.height="100%",Z.position="relative",Z.overflow="hidden",Z.left="0px",Z.top="0px",Z.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,T),keyDownHandler:e.delegate(this,x),keyHandler:e.delegate(this,O),clickHandler:e.delegate(this,V),dblClickHandler:e.delegate(this,G),dragHandler:e.delegate(this,Y),dragEndHandler:e.delegate(this,J),enterHandler:e.delegate(this,A),leaveHandler:e.delegate(this,S),pressHandler:e.delegate(this,R),releaseHandler:e.delegate(this,M),nonPrimaryPressHandler:e.delegate(this,k),nonPrimaryReleaseHandler:e.delegate(this,F),scrollHandler:e.delegate(this,te),pinchHandler:e.delegate(this,D),focusHandler:e.delegate(this,xe),blurHandler:e.delegate(this,Pe)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,se),leaveHandler:e.delegate(this,W)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[N.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(Z){N.source=N.world.getItemAt(0).source,i[N.hash].forceRedraw=!0,N._updateRequestId||(N._updateRequestId=u(N,ne))}),this.world.addHandler("remove-item",function(Z){N.world.getItemCount()?N.source=N.world.getItemAt(0).source:N.source=null,i[N.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(Z){N.viewport&&N.viewport._setContentBounds(N.world.getHomeBounds(),N.world.getContentFactor())}),this.world.addHandler("item-index-change",function(Z){N.source=N.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:g.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let ae=Array.isArray(this.drawer)?this.drawer:[this.drawer];ae.length===0&&(ae=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const Z of ae)if(this.requestDrawer(Z,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(j=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(j,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(j=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(j,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),j=0;j<this.customControls.length;j++)this.addControl(this.customControls[j].id,{anchor:this.customControls[j].anchor});e.requestAnimationFrame(function(){d(N)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(g){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(g)},openTileSource:function(g){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(g)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(g,b){var N=this;if(this.close(),!g)return this;if(this.sequenceMode&&e.isArray(g))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof b<"u"&&!isNaN(b)&&(this.initialPage=b),this.tileSources=g,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(g)||(g=[g]),!g.length)return this;this._opening=!0;for(var j=g.length,$=0,ae=0,Z,me=function(){if($+ae===j)if($){(N._firstOpen||!N.preserveViewport)&&(N.viewport.goHome(!0),N.viewport.update()),N._firstOpen=!1;var ce=g[0];if(ce.tileSource&&(ce=ce.tileSource),N.overlays&&!N.preserveOverlays)for(var Ne=0;Ne<N.overlays.length;Ne++)N.currentOverlays[Ne]=a(N,N.overlays[Ne]);N._drawOverlays(),N._opening=!1,N.raiseEvent("open",{source:ce})}else N._opening=!1,N.raiseEvent("open-failed",Z)},Ie=function(ce){(!e.isPlainObject(ce)||!ce.tileSource)&&(ce={tileSource:ce}),ce.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete ce.index),ce.collectionImmediately===void 0&&(ce.collectionImmediately=!0);var Ne=ce.success;ce.success=function(w){if($++,ce.tileSource.overlays)for(var C=0;C<ce.tileSource.overlays.length;C++)N.addOverlay(ce.tileSource.overlays[C]);Ne&&Ne(w),me()};var _=ce.error;ce.error=function(w){ae++,Z||(Z=w),_&&_(w),me()},N.addTiledImage(ce)},_e=0;_e<g.length;_e++)Ie(g[_e]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(g,b){const N={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};b=e.extend(!0,N,b);const j=b.mainDrawer,$=b.redrawImmediately,ae=b.drawerOptions,Z=this.drawer;let me=null;if(g&&g.prototype instanceof e.DrawerBase?(me=g,g="custom"):typeof g=="string"&&(me=e.determineDrawer(g)),me||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),me&&me.isSupported()){Z&&j&&Z.destroy();const Ie=new me({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:ae||this.drawerOptions[g]});return j&&(this.drawer=Ie,$&&this.forceRedraw()),Ie}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(g){return this.innerTracker.setTracking(g),this.outerTracker.setTracking(g),this.raiseEvent("mouse-enabled",{enabled:g}),this},areControlsEnabled:function(){var g=this.controls.length,b;for(b=0;b<this.controls.length;b++)g=g&&this.controls[b].isVisible();return g},setControlsEnabled:function(g){return g?m(this):d(this),this.raiseEvent("controls-enabled",{enabled:g}),this},setDebugMode:function(g){for(var b=0;b<this.world.getItemCount();b++)this.world.getItemAt(b).debugMode=g;this.debugMode=g,this.forceRedraw()},setAjaxHeaders:function(g,b){if(g===null&&(g={}),!e.isPlainObject(g)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(b===void 0&&(b=!0),this.ajaxHeaders=g,b){for(var N=0;N<this.world.getItemCount();N++)this.world.getItemAt(N)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var j in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[j].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(g){this.buttonGroup.addButton(g)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(g){var b=document.body,N=b.style,j=document.documentElement.style,$=this,ae,Z;if(g===this.isFullPage())return this;var me={fullPage:g,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",me),me.preventDefaultAction)return this;if(g&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=N.margin,this.docMargin=j.margin,N.margin="0",j.margin="0",this.bodyPadding=N.padding,this.docPadding=j.padding,N.padding="0",j.padding="0",this.bodyWidth=N.width,this.docWidth=j.width,N.width="100%",j.width="100%",this.bodyHeight=N.height,this.docHeight=j.height,N.height="100%",j.height="100%",this.bodyDisplay=N.display,N.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,ae=b.childNodes.length,Z=0;Z<ae;Z++)this.previousBody.push(b.childNodes[0]),b.removeChild(b.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,b.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),b.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,se)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,N.margin=this.bodyMargin,j.margin=this.docMargin,N.padding=this.bodyPadding,j.padding=this.docPadding,N.width=this.bodyWidth,j.width=this.docWidth,N.height=this.bodyHeight,j.height=this.docHeight,N.display=this.bodyDisplay,b.removeChild(this.element),ae=this.previousBody.length,Z=0;Z<ae;Z++)b.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(b.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var Ie=0,_e=function(){e.setPageScroll($.pageScroll);var ce=e.getPageScroll();Ie++,Ie<10&&(ce.x!==$.pageScroll.x||ce.y!==$.pageScroll.y)&&e.requestAnimationFrame(_e)};e.requestAnimationFrame(_e),i[this.hash].fullPage=!1,e.delegate(this,W)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:g}),this},setFullScreen:function(g){var b=this;if(!e.supportsFullScreen)return this.setFullPage(g);if(e.isFullScreen()===g)return this;var N={fullScreen:g,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",N),N.preventDefaultAction)return this;if(g){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var j=function(){var $=e.isFullScreen();$||(e.removeEvent(document,e.fullScreenEventName,j),e.removeEvent(document,e.fullScreenErrorEventName,j),b.setFullPage(!1),b.isFullPage()&&(b.element.style.width=b.fullPageStyleWidth,b.element.style.height=b.fullPageStyleHeight)),b.navigator&&b.viewport&&setTimeout(function(){b.navigator.update(b.viewport)}),b.raiseEvent("full-screen",{fullScreen:$})};e.addEvent(document,e.fullScreenEventName,j),e.addEvent(document,e.fullScreenErrorEventName,j),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(g){return this.container.style.visibility=g?"":"hidden",this.raiseEvent("visible",{visible:g}),this},addTiledImage:function(g){e.console.assert(g,"[Viewer.addTiledImage] options is required"),e.console.assert(g.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!g.replace||g.index>-1&&g.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var b=this;g.replace&&(g.replaceItem=b.world.getItemAt(g.index)),this._hideMessage(),g.placeholderFillStyle===void 0&&(g.placeholderFillStyle=this.placeholderFillStyle),g.opacity===void 0&&(g.opacity=this.opacity),g.preload===void 0&&(g.preload=this.preload),g.compositeOperation===void 0&&(g.compositeOperation=this.compositeOperation),g.crossOriginPolicy===void 0&&(g.crossOriginPolicy=g.tileSource.crossOriginPolicy!==void 0?g.tileSource.crossOriginPolicy:this.crossOriginPolicy),g.ajaxWithCredentials===void 0&&(g.ajaxWithCredentials=this.ajaxWithCredentials),g.loadTilesWithAjax===void 0&&(g.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(g.ajaxHeaders)||(g.ajaxHeaders={});var N={options:g};function j(Z){for(var me=0;me<b._loadQueue.length;me++)if(b._loadQueue[me]===N){b._loadQueue.splice(me,1);break}b._loadQueue.length===0&&$(N),b.raiseEvent("add-item-failed",Z),g.error&&g.error(Z)}function $(Z){b.collectionMode&&(b.world.arrange({immediately:Z.options.collectionImmediately,rows:b.collectionRows,columns:b.collectionColumns,layout:b.collectionLayout,tileSize:b.collectionTileSize,tileMargin:b.collectionTileMargin}),b.world.setAutoRefigureSizes(!0))}if(e.isArray(g.tileSource)){setTimeout(function(){j({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:g.tileSource,options:g})});return}this._loadQueue.push(N);function ae(){for(var Z,me,Ie;b._loadQueue.length&&(Z=b._loadQueue[0],!!Z.tileSource);){if(b._loadQueue.splice(0,1),Z.options.replace){var _e=b.world.getIndexOfItem(Z.options.replaceItem);_e!==-1&&(Z.options.index=_e),b.world.removeItem(Z.options.replaceItem)}me=new e.TiledImage({viewer:b,source:Z.tileSource,viewport:b.viewport,drawer:b.drawer,tileCache:b.tileCache,imageLoader:b.imageLoader,x:Z.options.x,y:Z.options.y,width:Z.options.width,height:Z.options.height,fitBounds:Z.options.fitBounds,fitBoundsPlacement:Z.options.fitBoundsPlacement,clip:Z.options.clip,placeholderFillStyle:Z.options.placeholderFillStyle,opacity:Z.options.opacity,preload:Z.options.preload,degrees:Z.options.degrees,flipped:Z.options.flipped,compositeOperation:Z.options.compositeOperation,springStiffness:b.springStiffness,animationTime:b.animationTime,minZoomImageRatio:b.minZoomImageRatio,wrapHorizontal:b.wrapHorizontal,wrapVertical:b.wrapVertical,maxTilesPerFrame:b.maxTilesPerFrame,immediateRender:b.immediateRender,blendTime:b.blendTime,alwaysBlend:b.alwaysBlend,minPixelRatio:b.minPixelRatio,smoothTileEdgesMinZoom:b.smoothTileEdgesMinZoom,iOSDevice:b.iOSDevice,crossOriginPolicy:Z.options.crossOriginPolicy,ajaxWithCredentials:Z.options.ajaxWithCredentials,loadTilesWithAjax:Z.options.loadTilesWithAjax,ajaxHeaders:Z.options.ajaxHeaders,debugMode:b.debugMode,subPixelRoundingForTransparency:b.subPixelRoundingForTransparency}),b.collectionMode&&b.world.setAutoRefigureSizes(!1),b.navigator&&(Ie=e.extend({},Z.options,{replace:!1,originalTiledImage:me,tileSource:Z.tileSource}),b.navigator.addTiledImage(Ie)),b.world.addItem(me,{index:Z.options.index}),b._loadQueue.length===0&&$(Z),b.world.getItemCount()===1&&!b.preserveViewport&&b.viewport.goHome(!0),Z.options.success&&Z.options.success({item:me})}}o(this,g.tileSource,g,function(Z){N.tileSource=Z,ae()},function(Z){Z.options=g,j(Z),ae()})},addSimpleImage:function(g){e.console.assert(g,"[Viewer.addSimpleImage] options is required"),e.console.assert(g.url,"[Viewer.addSimpleImage] options.url is required");var b=e.extend({},g,{tileSource:{type:"image",url:g.url}});delete b.url,this.addTiledImage(b)},addLayer:function(g){var b=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var N=e.extend({},g,{success:function(j){b.raiseEvent("add-layer",{options:g,drawer:j.item})},error:function(j){b.raiseEvent("add-layer-failed",j)}});return this.addTiledImage(N),this},getLayerAtLevel:function(g){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(g)},getLevelOfLayer:function(g){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(g)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(g,b){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(g,b)},removeLayer:function(g){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(g)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var g=e.delegate(this,v),b=e.delegate(this,E),N=e.delegate(this,this.goToNextPage),j=e.delegate(this,this.goToPreviousPage),$=this.navImages,ae=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(ae=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:K(this.prefixUrl,$.previous.REST),srcGroup:K(this.prefixUrl,$.previous.GROUP),srcHover:K(this.prefixUrl,$.previous.HOVER),srcDown:K(this.prefixUrl,$.previous.DOWN),onRelease:j,onFocus:g,onBlur:b}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:K(this.prefixUrl,$.next.REST),srcGroup:K(this.prefixUrl,$.next.GROUP),srcHover:K(this.prefixUrl,$.next.HOVER),srcDown:K(this.prefixUrl,$.next.DOWN),onRelease:N,onFocus:g,onBlur:b}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),ae&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var g=e.delegate(this,be),b=e.delegate(this,ye),N=e.delegate(this,pt),j=e.delegate(this,ge),$=e.delegate(this,nt),ae=e.delegate(this,We),Z=e.delegate(this,Et),me=e.delegate(this,gt),Ie=e.delegate(this,Re),_e=e.delegate(this,at),ce=e.delegate(this,v),Ne=e.delegate(this,E),_=this.navImages,w=[],C=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(C=!1),this.showZoomControl&&(w.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:K(this.prefixUrl,_.zoomIn.REST),srcGroup:K(this.prefixUrl,_.zoomIn.GROUP),srcHover:K(this.prefixUrl,_.zoomIn.HOVER),srcDown:K(this.prefixUrl,_.zoomIn.DOWN),onPress:g,onRelease:b,onClick:N,onEnter:g,onExit:b,onFocus:ce,onBlur:Ne})),w.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:K(this.prefixUrl,_.zoomOut.REST),srcGroup:K(this.prefixUrl,_.zoomOut.GROUP),srcHover:K(this.prefixUrl,_.zoomOut.HOVER),srcDown:K(this.prefixUrl,_.zoomOut.DOWN),onPress:j,onRelease:b,onClick:$,onEnter:j,onExit:b,onFocus:ce,onBlur:Ne}))),this.showHomeControl&&w.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:K(this.prefixUrl,_.home.REST),srcGroup:K(this.prefixUrl,_.home.GROUP),srcHover:K(this.prefixUrl,_.home.HOVER),srcDown:K(this.prefixUrl,_.home.DOWN),onRelease:ae,onFocus:ce,onBlur:Ne})),this.showFullPageControl&&w.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:K(this.prefixUrl,_.fullpage.REST),srcGroup:K(this.prefixUrl,_.fullpage.GROUP),srcHover:K(this.prefixUrl,_.fullpage.HOVER),srcDown:K(this.prefixUrl,_.fullpage.DOWN),onRelease:Z,onFocus:ce,onBlur:Ne})),this.showRotationControl&&(w.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:K(this.prefixUrl,_.rotateleft.REST),srcGroup:K(this.prefixUrl,_.rotateleft.GROUP),srcHover:K(this.prefixUrl,_.rotateleft.HOVER),srcDown:K(this.prefixUrl,_.rotateleft.DOWN),onRelease:me,onFocus:ce,onBlur:Ne})),w.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:K(this.prefixUrl,_.rotateright.REST),srcGroup:K(this.prefixUrl,_.rotateright.GROUP),srcHover:K(this.prefixUrl,_.rotateright.HOVER),srcDown:K(this.prefixUrl,_.rotateright.DOWN),onRelease:Ie,onFocus:ce,onBlur:Ne}))),this.showFlipControl&&w.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:K(this.prefixUrl,_.flip.REST),srcGroup:K(this.prefixUrl,_.flip.GROUP),srcHover:K(this.prefixUrl,_.flip.HOVER),srcDown:K(this.prefixUrl,_.flip.DOWN),onRelease:_e,onFocus:ce,onBlur:Ne})),C?(this.buttonGroup=new e.ButtonGroup({buttons:w,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,Ke)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=w),this},currentPage:function(){return this._sequenceIndex},goToPage:function(g){return this.tileSources&&g>=0&&g<this.tileSources.length&&(this._sequenceIndex=g,this._updateSequenceButtons(g),this.open(this.tileSources[g]),this.referenceStrip&&this.referenceStrip.setFocus(g),this.raiseEvent("page",{page:g})),this},addOverlay:function(g,b,N,j){var $;if(e.isPlainObject(g)?$=g:$={element:g,location:b,placement:N,onDraw:j},g=e.getElement($.element),l(this.currentOverlays,g)>=0)return this;var ae=a(this,$);return this.currentOverlays.push(ae),ae.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:g,location:$.location,placement:$.placement}),this},updateOverlay:function(g,b,N){var j;return g=e.getElement(g),j=l(this.currentOverlays,g),j>=0&&(this.currentOverlays[j].update(b,N),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:g,location:b,placement:N})),this},removeOverlay:function(g){var b;return g=e.getElement(g),b=l(this.currentOverlays,g),b>=0&&(this.currentOverlays[b].destroy(),this.currentOverlays.splice(b,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:g})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(g){var b;return g=e.getElement(g),b=l(this.currentOverlays,g),b>=0?this.currentOverlays[b]:null},_updateSequenceButtons:function(g){this.nextButton&&(!this.tileSources||this.tileSources.length-1===g?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(g>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(g){this._hideMessage();var b=e.makeNeutralElement("div");b.appendChild(document.createTextNode(g)),this.messageDiv=e.makeCenteredNode(b),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var g=this.messageDiv;g&&(g.parentNode.removeChild(g),delete this.messageDiv)},gestureSettingsByDeviceType:function(g){switch(g){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var g,b=this.currentOverlays.length;for(g=0;g<b;g++)this.currentOverlays[g].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var g=e.pixelDensityRatio,b=e.getCurrentPixelDensityRatio();g!==b&&(e.pixelDensityRatio=b,this.forceResize())},goToPreviousPage:function(){var g=this._sequenceIndex-1;this.navPrevNextWrap&&g<0&&(g+=this.tileSources.length),this.goToPage(g)},goToNextPage:function(){var g=this._sequenceIndex+1;this.navPrevNextWrap&&g>=this.tileSources.length&&(g=0),this.goToPage(g)},isAnimating:function(){return i[this.hash].animating}});function r(g){return g=e.getElement(g),new e.Point(g.clientWidth===0?1:g.clientWidth,g.clientHeight===0?1:g.clientHeight)}function o(g,b,N,j,$){var ae=g;if(e.type(b)==="string"){if(b.match(/^\s*<.*>\s*$/))b=e.parseXml(b);else if(b.match(/^\s*[{[].*[}\]]\s*$/))try{var Z=e.parseJSON(b);b=Z}catch{}}function me(Ie,_e){Ie.ready?j(Ie):(Ie.addHandler("ready",function(){j(Ie)}),Ie.addHandler("open-failed",function(ce){$({message:ce.message,source:_e})}))}setTimeout(function(){if(e.type(b)==="string")b=new e.TileSource({url:b,crossOriginPolicy:N.crossOriginPolicy!==void 0?N.crossOriginPolicy:g.crossOriginPolicy,ajaxWithCredentials:g.ajaxWithCredentials,ajaxHeaders:N.ajaxHeaders?N.ajaxHeaders:g.ajaxHeaders,splitHashDataForPost:g.splitHashDataForPost,success:function(Ne){j(Ne.tileSource)}}),b.addHandler("open-failed",function(Ne){$(Ne)});else if(e.isPlainObject(b)||b.nodeType)if(b.crossOriginPolicy===void 0&&(N.crossOriginPolicy!==void 0||g.crossOriginPolicy!==void 0)&&(b.crossOriginPolicy=N.crossOriginPolicy!==void 0?N.crossOriginPolicy:g.crossOriginPolicy),b.ajaxWithCredentials===void 0&&(b.ajaxWithCredentials=g.ajaxWithCredentials),e.isFunction(b.getTileUrl)){var Ie=new e.TileSource(b);Ie.getTileUrl=b.getTileUrl,j(Ie)}else{var _e=e.TileSource.determineType(ae,b);if(!_e){$({message:"Unable to load TileSource",source:b});return}var ce=_e.prototype.configure.apply(ae,[b]);me(new _e(ce),b)}else me(b,b)})}function a(g,b){if(b instanceof e.Overlay)return b;var N=null;if(b.element)N=e.getElement(b.element);else{var j=b.id?b.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);N=e.getElement(b.id),N||(N=document.createElement("a"),N.href="#/overlay/"+j),N.id=j,e.addClass(N,b.className?b.className:"openseadragon-overlay")}var $=b.location,ae=b.width,Z=b.height;if(!$){var me=b.x,Ie=b.y;if(b.px!==void 0){var _e=g.viewport.imageToViewportRectangle(new e.Rect(b.px,b.py,ae||0,Z||0));me=_e.x,Ie=_e.y,ae=ae!==void 0?_e.width:void 0,Z=Z!==void 0?_e.height:void 0}$=new e.Point(me,Ie)}var ce=b.placement;return ce&&e.type(ce)==="string"&&(ce=e.Placement[b.placement.toUpperCase()]),new e.Overlay({element:N,location:$,placement:ce,onDraw:b.onDraw,checkResize:b.checkResize,width:ae,height:Z,rotationMode:b.rotationMode})}function l(g,b){var N;for(N=g.length-1;N>=0;N--)if(g[N].element===b)return N;return-1}function u(g,b){return e.requestAnimationFrame(function(){b(g)})}function h(g){e.requestAnimationFrame(function(){f(g)})}function d(g){g.autoHideControls&&(g.controlsShouldFade=!0,g.controlsFadeBeginTime=e.now()+g.controlsFadeDelay,window.setTimeout(function(){h(g)},g.controlsFadeDelay))}function f(g){var b,N,j,$;if(g.controlsShouldFade){for(b=e.now(),N=b-g.controlsFadeBeginTime,j=1-N/g.controlsFadeLength,j=Math.min(1,j),j=Math.max(0,j),$=g.controls.length-1;$>=0;$--)g.controls[$].autoFade&&g.controls[$].setOpacity(j);j>0&&h(g)}}function m(g){var b;for(g.controlsShouldFade=!1,b=g.controls.length-1;b>=0;b--)g.controls[b].setOpacity(1)}function v(){m(this)}function E(){d(this)}function T(g){var b={tracker:g.eventSource,position:g.position,originalEvent:g.originalEvent,preventDefault:g.preventDefault};this.raiseEvent("canvas-contextmenu",b),g.preventDefault=b.preventDefault}function x(g){var b={originalEvent:g.originalEvent,preventDefaultAction:!1,preventVerticalPan:g.preventVerticalPan||!this.panVertical,preventHorizontalPan:g.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",b),!b.preventDefaultAction&&!g.ctrl&&!g.alt&&!g.meta)switch(g.keyCode){case 38:b.preventVerticalPan||(g.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 40:b.preventVerticalPan||(g.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 37:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 39:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 87:b.preventVerticalPan||(g.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 83:b.preventVerticalPan||(g.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 65:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 68:b.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 82:g.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),g.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:g.preventDefault=!1;break}else g.preventDefault=!1}function O(g){var b={originalEvent:g.originalEvent};this.raiseEvent("canvas-key-press",b)}function V(g){var b,N=document.activeElement===this.canvas;N||this.canvas.focus(),this.viewport.flipped&&(g.position.x=this.viewport.getContainerSize().x-g.position.x);var j={tracker:g.eventSource,position:g.position,quick:g.quick,shift:g.shift,originalEvent:g.originalEvent,originalTarget:g.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",j),!j.preventDefaultAction&&this.viewport&&g.quick&&(b=this.gestureSettingsByDeviceType(g.pointerType),b.clickToZoom===!0&&(this.viewport.zoomBy(g.shift?1/this.zoomPerClick:this.zoomPerClick,b.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints()),b.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function G(g){var b,N={tracker:g.eventSource,position:g.position,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",N),!N.preventDefaultAction&&this.viewport&&(b=this.gestureSettingsByDeviceType(g.pointerType),b.dblClickToZoom&&(this.viewport.zoomBy(g.shift?1/this.zoomPerClick:this.zoomPerClick,b.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints()))}function Y(g){var b,N={tracker:g.eventSource,pointerType:g.pointerType,position:g.position,delta:g.delta,speed:g.speed,direction:g.direction,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",N),b=this.gestureSettingsByDeviceType(g.pointerType),!N.preventDefaultAction&&this.viewport){if(b.dblClickDragToZoom&&i[this.hash].draggingToZoom){var j=Math.pow(this.zoomPerDblClickDrag,g.delta.y/50);this.viewport.zoomBy(j)}else if(b.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(g.delta.x=0),this.panVertical||(g.delta.y=0),this.viewport.flipped&&(g.delta.x=-g.delta.x),this.constrainDuringPan){var $=this.viewport.deltaPointsFromPixels(g.delta.negate());this.viewport.centerSpringX.target.value+=$.x,this.viewport.centerSpringY.target.value+=$.y;var ae=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=$.x,this.viewport.centerSpringY.target.value-=$.y,ae.xConstrained&&(g.delta.x=0),ae.yConstrained&&(g.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(g.delta.negate()),b.flickEnabled&&!this.constrainDuringPan)}}}function J(g){var b,N={tracker:g.eventSource,pointerType:g.pointerType,position:g.position,speed:g.speed,direction:g.direction,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",N),b=this.gestureSettingsByDeviceType(g.pointerType),!N.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&b.dragToPan&&b.flickEnabled&&g.speed>=b.flickMinSpeed){var j=0;this.panHorizontal&&(j=b.flickMomentum*g.speed*Math.cos(g.direction));var $=0;this.panVertical&&($=b.flickMomentum*g.speed*Math.sin(g.direction));var ae=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),Z=this.viewport.pointFromPixel(new e.Point(ae.x-j,ae.y-$));this.viewport.panTo(Z,!1)}this.viewport.applyConstraints()}b.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function A(g){this.raiseEvent("canvas-enter",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function S(g){this.raiseEvent("canvas-exit",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function R(g){var b;if(this.raiseEvent("canvas-press",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElementReleased,originalEvent:g.originalEvent}),b=this.gestureSettingsByDeviceType(g.pointerType),b.dblClickDragToZoom){var N=i[this.hash].lastClickTime,j=e.now();if(N===null)return;j-N<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function M(g){this.raiseEvent("canvas-release",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElementReleased,originalEvent:g.originalEvent})}function k(g){this.raiseEvent("canvas-nonprimary-press",{tracker:g.eventSource,position:g.position,pointerType:g.pointerType,button:g.button,buttons:g.buttons,originalEvent:g.originalEvent})}function F(g){this.raiseEvent("canvas-nonprimary-release",{tracker:g.eventSource,position:g.position,pointerType:g.pointerType,button:g.button,buttons:g.buttons,originalEvent:g.originalEvent})}function D(g){var b,N,j,$,ae={tracker:g.eventSource,pointerType:g.pointerType,gesturePoints:g.gesturePoints,lastCenter:g.lastCenter,center:g.center,lastDistance:g.lastDistance,distance:g.distance,shift:g.shift,originalEvent:g.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",ae),this.viewport&&(b=this.gestureSettingsByDeviceType(g.pointerType),b.pinchToZoom&&(!ae.preventDefaultPanAction||!ae.preventDefaultZoomAction)&&(N=this.viewport.pointFromPixel(g.center,!0),b.zoomToRefPoint&&!ae.preventDefaultPanAction&&(j=this.viewport.pointFromPixel(g.lastCenter,!0),$=j.minus(N),this.panHorizontal||($.x=0),this.panVertical||($.y=0),this.viewport.panBy($,!0)),ae.preventDefaultZoomAction||this.viewport.zoomBy(g.distance/g.lastDistance,N,!0),this.viewport.applyConstraints()),b.pinchRotate&&!ae.preventDefaultRotateAction)){var Z=Math.atan2(g.gesturePoints[0].currentPos.y-g.gesturePoints[1].currentPos.y,g.gesturePoints[0].currentPos.x-g.gesturePoints[1].currentPos.x),me=Math.atan2(g.gesturePoints[0].lastPos.y-g.gesturePoints[1].lastPos.y,g.gesturePoints[0].lastPos.x-g.gesturePoints[1].lastPos.x);N=this.viewport.pointFromPixel(g.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(Z-me)*(180/Math.PI),N,!0)}}function xe(g){this.raiseEvent("canvas-focus",{tracker:g.eventSource,originalEvent:g.originalEvent})}function Pe(g){this.raiseEvent("canvas-blur",{tracker:g.eventSource,originalEvent:g.originalEvent})}function te(g){var b,N,j,$,ae;$=e.now(),ae=$-this._lastScrollTime,ae>this.minScrollDeltaTime?(this._lastScrollTime=$,b={tracker:g.eventSource,position:g.position,scroll:g.scroll,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",b),!b.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(g.position.x=this.viewport.getContainerSize().x-g.position.x),N=this.gestureSettingsByDeviceType(g.pointerType),N.scrollToZoom&&(j=Math.pow(this.zoomPerScroll,g.scroll),this.viewport.zoomBy(j,N.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints())),g.preventDefault=b.preventDefault):g.preventDefault=!0}function se(g){i[this.hash].mouseInside=!0,m(this),this.raiseEvent("container-enter",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function W(g){g.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||d(this)),this.raiseEvent("container-exit",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function ne(g){fe(g),g.isOpen()?g._updateRequestId=u(g,ne):g._updateRequestId=!1}function U(g,b){var N=g.viewport,j=N.getZoom(),$=N.getCenter();N.resize(b,g.preserveImageSizeOnResize),N.panTo($,!0);var ae;if(g.preserveImageSizeOnResize)ae=i[g.hash].prevContainerSize.x/b.x;else{var Z=new e.Point(0,0),me=new e.Point(i[g.hash].prevContainerSize.x,i[g.hash].prevContainerSize.y).distanceTo(Z),Ie=new e.Point(b.x,b.y).distanceTo(Z);ae=Ie/me*i[g.hash].prevContainerSize.x/b.x}N.zoomTo(j*ae,null,!0),i[g.hash].prevContainerSize=b,i[g.hash].forceRedraw=!0,i[g.hash].needsResize=!1,i[g.hash].forceResize=!1}function fe(g){if(!(g._opening||!i[g.hash])){if(g.autoResize||i[g.hash].forceResize){var b;if(g._autoResizePolling){b=r(g.container);var N=i[g.hash].prevContainerSize;b.equals(N)||(i[g.hash].needsResize=!0)}i[g.hash].needsResize&&U(g,b||r(g.container))}var j=g.viewport.update(),$=g.world.update(j)||j;j&&g.raiseEvent("viewport-change"),g.referenceStrip&&($=g.referenceStrip.update(g.viewport)||$);var ae=i[g.hash].animating;!ae&&$&&(g.raiseEvent("animation-start"),m(g));var Z=ae&&!$;Z&&(i[g.hash].animating=!1),($||Z||i[g.hash].forceRedraw||g.world.needsDraw())&&(re(g),g._drawOverlays(),g.navigator&&g.navigator.update(g.viewport),i[g.hash].forceRedraw=!1,$&&g.raiseEvent("animation")),Z&&(g.raiseEvent("animation-finish"),i[g.hash].mouseInside||d(g)),i[g.hash].animating=$}}function re(g){g.imageLoader.clear(),g.world.draw(),g.raiseEvent("update-viewport",{})}function K(g,b){return g?g+b:b}function be(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,Ce(this)}function ge(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,Ce(this)}function ye(){i[this.hash].zooming=!1}function Ce(g){e.requestAnimationFrame(e.delegate(g,He))}function He(){var g,b,N;i[this.hash].zooming&&this.viewport&&(g=e.now(),b=g-i[this.hash].lastZoomTime,N=Math.pow(i[this.hash].zoomFactor,b/1e3),this.viewport.zoomBy(N),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=g,Ce(this))}function pt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function nt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function Ke(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function We(){this.viewport&&this.viewport.goHome()}function Et(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function gt(){if(this.viewport){var g=this.viewport.getRotation();this.viewport.flipped?g+=this.rotationIncrement:g-=this.rotationIncrement,this.viewport.setRotation(g)}}function Re(){if(this.viewport){var g=this.viewport.getRotation();this.viewport.flipped?g-=this.rotationIncrement:g+=this.rotationIncrement,this.viewport.setRotation(g)}}function at(){this.viewport.toggleFlip()}e.determineDrawer=function(g){for(let b in t){const N=t[b],j=N.prototype;if(j&&j instanceof t.DrawerBase&&e.isFunction(j.getType)&&j.getType.call(N)===g)return N}return null}}(t),function(e){e.Navigator=function(u){var h=u.viewer,d=this,f,m;u.element||u.id?(u.element?(u.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),u.element.id?u.id=u.element.id:u.id="navigator-"+e.now(),this.element=u.element):this.element=document.getElementById(u.id),u.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(u.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),u.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:u.autoFade},u.position&&(u.position==="BOTTOM_RIGHT"?u.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:u.position==="BOTTOM_LEFT"?u.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:u.position==="TOP_RIGHT"?u.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:u.position==="TOP_LEFT"?u.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:u.position==="ABSOLUTE"&&(u.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,u.controlOptions.top=u.top,u.controlOptions.left=u.left,u.controlOptions.height=u.height,u.controlOptions.width=u.width))),this.element.id=u.id,this.element.className+=" navigator",u=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},u,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:u.animationTime,autoResize:!1,minZoomImageRatio:1,background:u.background,opacity:u.opacity,borderColor:u.borderColor,displayRegionColor:u.displayRegionColor}),u.minPixelRatio=this.minPixelRatio=h.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),u.controlOptions.anchor!==e.ControlAnchor.NONE&&function(T,x){T.margin="0px",T.border=x+"px solid "+u.borderColor,T.padding="0px",T.background=u.background,T.opacity=u.opacity,T.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(T,x){T.position="relative",T.top="0px",T.left="0px",T.fontSize="0px",T.overflow="hidden",T.border=x+"px solid "+u.displayRegionColor,T.margin="0px",T.padding="0px",T.background="transparent",T.float="left",T.cssFloat="left",T.zIndex=999999999,T.cursor="default",T.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),h.addControl(this.element,u.controlOptions),this._resizeWithViewer=u.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&u.controlOptions.anchor!==e.ControlAnchor.NONE,u.width&&u.height?(this.setWidth(u.width),this.setHeight(u.height)):this._resizeWithViewer&&(f=e.getElementSize(h.element),this.element.style.height=Math.round(f.y*u.sizeRatio)+"px",this.element.style.width=Math.round(f.x*u.sizeRatio)+"px",this.oldViewerSize=f,m=e.getElementSize(this.element),this.elementArea=m.x*m.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[u]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function v(T,x){a(d.displayRegionContainer,T),a(d.displayRegion,-T),d.viewport.setRotation(T,x)}if(u.navigatorRotate){var E=u.viewer.viewport?u.viewer.viewport.getRotation():u.viewer.degrees||0;v(E,!0),u.viewer.addHandler("rotate",function(T){v(T.degrees,T.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(T){T.eventType==="wheel"&&(T.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){d.viewport&&d.viewport.goHome(!0)}),h.world.addHandler("item-index-change",function(T){window.setTimeout(function(){var x=d.world.getItemAt(T.previousIndex);d.world.setItemIndex(x,T.newIndex)},1)}),h.world.addHandler("remove-item",function(T){var x=T.item,O=d._getMatchingItem(x);O&&d.world.removeItem(O)}),this.update(h.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var u=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);u.equals(this.oldContainerSize)||(this.viewport.resize(u,!0),this.viewport.goHome(!0),this.oldContainerSize=u,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(u){this.width=u,this.element.style.width=typeof u=="number"?u+"px":u,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(u){this.height=u,this.element.style.height=typeof u=="number"?u+"px":u,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(u){return this.viewport.setFlip(u),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(u){l(this.canvas,u),l(this.element,u)},update:function(u){var h,d,f,m,v,E;if(u||(u=this.viewer.viewport),h=e.getElementSize(this.viewer.element),this._resizeWithViewer&&h.x&&h.y&&!h.equals(this.oldViewerSize)&&(this.oldViewerSize=h,this.maintainSizeRatio||!this.elementArea?(d=h.x*this.sizeRatio,f=h.y*this.sizeRatio):(d=Math.sqrt(this.elementArea*(h.x/h.y)),f=this.elementArea/d),this.element.style.width=Math.round(d)+"px",this.element.style.height=Math.round(f)+"px",this.elementArea||(this.elementArea=d*f),this.updateSize()),u&&this.viewport){if(m=u.getBoundsNoRotate(!0),v=this.viewport.pixelFromPointNoRotate(m.getTopLeft(),!1),E=this.viewport.pixelFromPointNoRotate(m.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var T=u.getRotation(!0);a(this.displayRegion,-T)}var x=this.displayRegion.style;x.display=this.world.getItemCount()?"block":"none",x.top=v.y.toFixed(2)+"px",x.left=v.x.toFixed(2)+"px";var O=E.x-v.x,V=E.y-v.y;x.width=Math.round(Math.max(O,0))+"px",x.height=Math.round(Math.max(V,0))+"px"}},addTiledImage:function(u){var h=this,d=u.originalTiledImage;delete u.original;var f=e.extend({},u,{success:function(m){var v=m.item;v._originalForNavigator=d,h._matchBounds(v,d,!0),h._matchOpacity(v,d),h._matchCompositeOperation(v,d);function E(){h._matchBounds(v,d)}function T(){h._matchOpacity(v,d)}function x(){h._matchCompositeOperation(v,d)}d.addHandler("bounds-change",E),d.addHandler("clip-change",E),d.addHandler("opacity-change",T),d.addHandler("composite-operation-change",x)}});return e.Viewer.prototype.addTiledImage.apply(this,[f])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(u){for(var h=this.world.getItemCount(),d,f=0;f<h;f++)if(d=this.world.getItemAt(f),d._originalForNavigator===u)return d;return null},_matchBounds:function(u,h,d){var f=h.getBoundsNoRotate();u.setPosition(f.getTopLeft(),d),u.setWidth(f.width,d),u.setRotation(h.getRotation(),d),u.setClip(h.getClip()),u.setFlip(h.getFlip())},_matchOpacity:function(u,h){u.setOpacity(h.opacity)},_matchCompositeOperation:function(u,h){u.setCompositeOperation(h.compositeOperation)}});function i(u){var h={tracker:u.eventSource,position:u.position,quick:u.quick,shift:u.shift,originalEvent:u.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",h),!h.preventDefaultAction&&u.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(u.position.x=this.viewport.getContainerSize().x-u.position.x);var d=this.viewport.pointFromPixel(u.position);this.panVertical?this.panHorizontal||(d.x=this.viewer.viewport.getCenter(!0).x):d.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(d),this.viewer.viewport.applyConstraints()}}function n(u){var h={tracker:u.eventSource,position:u.position,delta:u.delta,speed:u.speed,direction:u.direction,shift:u.shift,originalEvent:u.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",h),!h.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(u.delta.x=0),this.panVertical||(u.delta.y=0),this.viewer.viewport.flipped&&(u.delta.x=-u.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(u.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(u){u.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(u){var h={tracker:u.eventSource,position:u.position,scroll:u.scroll,shift:u.shift,originalEvent:u.originalEvent,preventDefault:u.preventDefault};this.viewer.raiseEvent("navigator-scroll",h),u.preventDefault=h.preventDefault}function a(u,h){l(u,"rotate("+h+"deg)")}function l(u,h){u.style.webkitTransform=h,u.style.mozTransform=h,u.style.msTransform=h,u.style.oTransform=h,u.style.transform=h}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,l=i,u;for(u=0;u<r.length-1;u++)l=l[r[u]]||{};return o=l[r[u]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(h){var d=parseInt(h.match(/\d+/),10)+1;return d<a.length?a[d]:""})},setString:function(n,r){var o=n.split("."),a=i,l;for(l=0;l<o.length-1;l++)a[o[l]]||(a[o[l]]={}),a=a[o[l]];a[o[l]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var l=i*Math.PI/180;r=Math.cos(l),o=Math.sin(l)}var u=r*(this.x-n.x)-o*(this.y-n.y)+n.x,h=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(u,h)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,l,u){var h=this,d=arguments,f,m;if(e.isPlainObject(n)?f=n:f={width:d[0],height:d[1],tileSize:d[2],tileOverlap:d[3],minLevel:d[4],maxLevel:d[5]},e.EventSource.call(this),e.extend(!0,this,f),!this.success){for(m=0;m<arguments.length;m++)if(e.isFunction(arguments[m])){this.success=arguments[m];break}}this.success&&this.addHandler("ready",function(v){h.success(v)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=f.width&&f.height?f.width/f.height:1,this.dimensions=new e.Point(f.width,f.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=f.tileOverlap?f.tileOverlap:0,this.minLevel=f.minLevel?f.minLevel:0,this.maxLevel=f.maxLevel!==void 0&&f.maxLevel!==null?f.maxLevel:f.width&&f.height?Math.ceil(Math.log(Math.max(f.width,f.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),l=r.x*a,u=r.y*a,h=Math.floor(l/this.getTileWidth(n)),d=Math.floor(u/this.getTileHeight(n));r.x>=1&&(h=this.getNumTiles(n).x-1);var f=1e-15;return r.y>=1/this.aspectRatio-f&&(d=this.getNumTiles(n).y-1),new e.Point(h,d)},getTileBounds:function(n,r,o,a){var l=this.dimensions.times(this.getLevelScale(n)),u=this.getTileWidth(n),h=this.getTileHeight(n),d=r===0?0:u*r-this.tileOverlap,f=o===0?0:h*o-this.tileOverlap,m=u+(r===0?1:2)*this.tileOverlap,v=h+(o===0?1:2)*this.tileOverlap,E=1/l.x;return m=Math.min(m,l.x-d),v=Math.min(v,l.y-f),a?new e.Rect(0,0,m,v):new e.Rect(d*E,f*E,m*E,v*E)},getImageInfo:function(n){var r=this,o,a,l,u,h,d,f;n&&(h=n.split("/"),d=h[h.length-1],f=d.lastIndexOf("."),f>-1&&(h[h.length-1]=d.slice(0,f)));var m=null;if(this.splitHashDataForPost){var v=n.indexOf("#");v!==-1&&(m=n.substring(v+1),n=n.substr(0,v))}a=function(E){typeof E=="string"&&(E=e.parseXml(E));var T=e.TileSource.determineType(r,E,n);if(!T){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}u=T.prototype.configure.apply(r,[E,n,m]),u.ajaxWithCredentials===void 0&&(u.ajaxWithCredentials=r.ajaxWithCredentials),l=new T(u),r.ready=!0,r.raiseEvent("ready",{tileSource:l})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:m,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(E){var T=i(E);a(T)},error:function(E,T){var x;try{x="HTTP "+E.status+" attempting to load TileSource: "+n}catch{var O;typeof T>"u"||!T.toString?O="Unknown error":O=T.toString(),x=O+" attempting to load TileSource: "+n}e.console.error(x),r.raiseEvent("open-failed",{message:x,source:n,postData:m})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,l,u){function h(d){return l?d+"+"+JSON.stringify(l):d}return h(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(l){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(l?null:o,r.request,l)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(l){var u;try{u=new window.Blob([l.response])}catch(f){var h=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(f.name==="TypeError"&&h){var d=new h;d.append(l.response),u=d.getBlob()}}u.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(u)},error:function(l){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,l;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{l=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{l=n.responseText}else if(r.match(/\s*[{[].*/))try{l=e.parseJSON(r)}catch{l=r}else l=r;return l}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,l,u,h,d,f,m){var v,E,T,x;if(e.isPlainObject(r)?x=r:x={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=x.tilesUrl,this.fileFormat=x.fileFormat,this.displayRects=x.displayRects,this.displayRects)for(v=this.displayRects.length-1;v>=0;v--)for(E=this.displayRects[v],T=E.minLevel;T<=E.maxLevel;T++)this._levelRects[T]||(this._levelRects[T]=[]),this._levelRects[T].push(E);e.TileSource.apply(this,[x])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var l;return e.isPlainObject(r)?l=n(this,r):l=i(this,r),o&&!l.tilesUrl&&(l.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?l.queryParams=o.match(/\?.*/):l.queryParams=""),l},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var l=this._levelRects[r],u,h,d,f,m,v,E;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!l||!l.length)return!0;for(E=l.length-1;E>=0;E--)if(u=l[E],!(r<u.minLevel||r>u.maxLevel)&&(h=this.getLevelScale(r),d=u.x*h,f=u.y*h,m=d+u.width*h,v=f+u.height*h,d=Math.floor(d/this._tileWidth),f=Math.floor(f/this._tileWidth),m=Math.ceil(m/this._tileWidth),v=Math.ceil(v/this._tileWidth),d<=o&&o<m&&f<=a&&a<v))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,l=a.localName||a.tagName,u=o.documentElement.namespaceURI,h=null,d=[],f,m,v,E,T;if(l==="Image")try{if(E=a.getElementsByTagName("Size")[0],E===void 0&&(E=a.getElementsByTagNameNS(u,"Size")[0]),h={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(E.getAttribute("Height"),10),Width:parseInt(E.getAttribute("Width"),10)}}},!e.imageFormatSupported(h.Image.Format))throw new Error(e.getString("Errors.ImageFormat",h.Image.Format.toUpperCase()));for(f=a.getElementsByTagName("DisplayRect"),f===void 0&&(f=a.getElementsByTagNameNS(u,"DisplayRect")[0]),T=0;T<f.length;T++)m=f[T],v=m.getElementsByTagName("Rect")[0],v===void 0&&(v=m.getElementsByTagNameNS(u,"Rect")[0]),d.push({Rect:{X:parseInt(v.getAttribute("X"),10),Y:parseInt(v.getAttribute("Y"),10),Width:parseInt(v.getAttribute("Width"),10),Height:parseInt(v.getAttribute("Height"),10),MinLevel:parseInt(m.getAttribute("MinLevel"),10),MaxLevel:parseInt(m.getAttribute("MaxLevel"),10)}});return d.length&&(h.Image.DisplayRect=d),n(r,h)}catch(V){throw V instanceof Error?V:new Error(e.getString("Errors.Dzi"))}else{if(l==="Collection")throw new Error(e.getString("Errors.Dzc"));if(l==="Error"){var x=a.getElementsByTagName("Message")[0],O=x.firstChild.nodeValue;throw new Error(O)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,l=a.Url,u=a.Format,h=a.Size,d=a.DisplayRect||[],f=parseInt(h.Width,10),m=parseInt(h.Height,10),v=parseInt(a.TileSize,10),E=parseInt(a.Overlap,10),T=[],x,O;for(O=0;O<d.length;O++)x=d[O].Rect,T.push(new e.DisplayRect(parseInt(x.X,10),parseInt(x.Y,10),parseInt(x.Width,10),parseInt(x.Height,10),parseInt(x.MinLevel,10),parseInt(x.MaxLevel,10)));return e.extend(!0,{width:f,height:m,tileSize:v,tileOverlap:E,minLevel:null,maxLevel:null,tilesUrl:l,fileFormat:u,displayRects:T},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var l=0;l<this.tiles.length;l++)for(var u=0;u<this.tiles[l].scaleFactors.length;u++){var h=this.tiles[l].scaleFactors[u];this.scale_factors.push(h),a.tileSizePerScaleFactor[h]={width:this.tiles[l].width,height:this.tiles[l].height||this.tiles[l].width}}}else if(i(a)){for(var d=Math.min(this.height,this.width),f=[256,512,1024],m=[],v=0;v<f.length;v++)f[v]<=d&&m.push(f[v]);m.length>0?a.tileSize=Math.max.apply(null,m):a.tileSize=d}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var E=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(E)*Math.LOG2E)}if(this.sizes){var T=this.sizes.length;(T===a.maxLevel||T===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((x,O)=>x.width-O.width),T===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,l){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,l,u){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=l.replace("/info.json",""),a.version=1;else{var d=a["@context"];if(Array.isArray(d)){for(var f=0;f<d.length;f++)if(typeof d[f]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(d[f])||d[f]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){d=d[f];break}}switch(d){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var m=0;m<a.preferredFormats.length;m++)if(t.imageFormatSupported(a.preferredFormats[m])){a.tileFormat=a.preferredFormats[m];break}}return a}else{var h=r(a);return h["@context"]="http://iiif.io/api/image/1.0/context.json",h["@id"]=l.replace("/info.xml",""),h.version=1,h}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var l=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[l]?this.tileSizePerScaleFactor[l].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var l=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[l]?this.tileSizePerScaleFactor[l].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var l=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(l=this.levels[a].width/this.levels[this.maxLevel].width),l}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var l=this.getLevelScale(a);return l?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var u=this.levelSizes[a],h=Math.ceil(u.width/this.getTileWidth(a)),d=Math.ceil(u.height/this.getTileHeight(a));return new e.Point(h,d)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,l){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var u=l.x>=0&&l.x<=1&&l.y>=0&&l.y<=1/this.aspectRatio;e.console.assert(u,"[TileSource.getTileAtPoint] must be called with a valid point.");var h=this.levelSizes[a].width,d=l.x*h,f=l.y*h,m=Math.floor(d/this.getTileWidth(a)),v=Math.floor(f/this.getTileHeight(a));l.x>=1&&(m=this.getNumTiles(a).x-1);var E=1e-15;return l.y>=1/this.aspectRatio-E&&(v=this.getNumTiles(a).y-1),new e.Point(m,v)}return e.TileSource.prototype.getTileAtPoint.call(this,a,l)},getTileUrl:function(a,l,u){if(this.emulateLegacyImagePyramid){var h=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(h=this.levels[a].url),h}var d="0",f=Math.pow(.5,this.maxLevel-a),m,v,E,T,x,O,V,G,Y,J,A,S,R,M,k,F;return this.levelSizes?(m=this.levelSizes[a].width,v=this.levelSizes[a].height):(m=Math.ceil(this.width*f),v=Math.ceil(this.height*f)),E=this.getTileWidth(a),T=this.getTileHeight(a),x=Math.round(E/f),O=Math.round(T/f),this.version===1?k="native."+this.tileFormat:k="default."+this.tileFormat,m<E&&v<T?(this.version===2&&m===this.width?S="full":this.version===3&&m===this.width&&v===this.height?S="max":this.version===3?S=m+","+v:S=m+",",V="full"):(G=l*x,Y=u*O,J=Math.min(x,this.width-G),A=Math.min(O,this.height-Y),l===0&&u===0&&J===this.width&&A===this.height?V="full":V=[G,Y,J,A].join(","),R=Math.min(E,m-l*E),M=Math.min(T,v-u*T),this.version===2&&R===this.width?S="full":this.version===3&&R===this.width&&M===this.height?S="max":this.version===3?S=R+","+M:S=R+","),F=[this._id,V,S,d,k].join("/"),F},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var l=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],u=Array.isArray(a.profile)?a.profile[0]:a.profile,h=l.indexOf(u)!==-1,d=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(d=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(d=a.extraFeatures.indexOf("sizeByWh")!==-1),!h||d}function n(a){for(var l=[],u=0;u<a.sizes.length;u++)l.push({url:a._id+"/full/"+a.sizes[u].width+","+(a.version===3?a.sizes[u].height:"")+"/0/default."+a.tileFormat,width:a.sizes[u].width,height:a.sizes[u].height});return l.sort(function(h,d){return h.width-d.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var l=a.documentElement,u=l.tagName,h=null;if(u==="info")try{return h={},o(l,h),h}catch(d){throw d instanceof Error?d:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,l,u){var h,d;if(a.nodeType===3&&u)d=a.nodeValue.trim(),d.match(/^\d*$/)&&(d=Number(d)),l[u]?(e.isArray(l[u])||(l[u]=[l[u]]),l[u].push(d)):l[u]=d;else if(a.nodeType===1)for(h=0;h<a.childNodes.length;h++)o(a.childNodes[h],l,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var l;e.isPlainObject(i)?l=i:l={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!l.width||!l.height)&&(l.width=65572864,l.height=65572864),l.tileSize||(l.tileSize=256,l.tileOverlap=0),l.tilesUrl||(l.tilesUrl="http://tile.openstreetmap.org/"),l.minLevel=8,e.TileSource.apply(this,[l])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var l;e.isPlainObject(i)?l=i:l={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var u=Math.ceil(l.width/256)*256,h=Math.ceil(l.height/256)*256,d;u>h?d=u/256:d=h/256,l.maxLevel=Math.ceil(Math.log(d)/Math.log(2))-1,l.tileSize=256,l.width=u,l.height=h,e.TileSource.apply(this,[l])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},l=0;l<i;l++)a=this.gridSize[l],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,l,u;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(l=a.levels[a.levels.length-1].width,u=a.levels[a.levels.length-1].height):(l=0,u=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:l,height:u,tileSize:Math.max(u,l),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,l){var u;return e.isPlainObject(o)?u=r(this,o):u=n(this,o),u},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,l){var u=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(u=this.levels[o].url),u}});function i(o){var a=[],l,u;for(u=0;u<o.length;u++)l=o[u],l.height&&l.width&&l.url?a.push({url:l.url,width:Number(l.width),height:Number(l.height)}):e.console.error("Unsupported image format: %s",l.url?l.url:"<no URL>");return a.sort(function(h,d){return h.height-d.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var l=a.documentElement,u=l.tagName,h=null,d=[],f,m;if(u==="image")try{for(h={type:l.getAttribute("type"),levels:[]},d=l.getElementsByTagName("level"),m=0;m<d.length;m++)f=d[m],h.levels.push({url:f.getAttribute("url"),width:parseInt(f.getAttribute("width"),10),height:parseInt(f.getAttribute("height"),10)});return r(o,h)}catch(v){throw v instanceof Error?v:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(u==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(u==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+u)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var l=document.createElement("canvas"),u=l.getContext("2d");l.width=n,l.height=r,u.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:u,width:n,height:r}),o=l,a=u}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(u){var h=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},u),this.element=u.element||e.makeNeutralElement("div"),u.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(d){d.insideElementPressed?(a(h,e.ButtonState.DOWN),h.raiseEvent("enter",{originalEvent:d.originalEvent})):d.buttonDownAny||a(h,e.ButtonState.HOVER)},focusHandler:function(d){h.tracker.enterHandler(d),h.raiseEvent("focus",{originalEvent:d.originalEvent})},leaveHandler:function(d){l(h,e.ButtonState.GROUP),d.insideElementPressed&&h.raiseEvent("exit",{originalEvent:d.originalEvent})},blurHandler:function(d){h.tracker.leaveHandler(d),h.raiseEvent("blur",{originalEvent:d.originalEvent})},pressHandler:function(d){a(h,e.ButtonState.DOWN),h.raiseEvent("press",{originalEvent:d.originalEvent})},releaseHandler:function(d){d.insideElementPressed&&d.insideElementReleased?(l(h,e.ButtonState.HOVER),h.raiseEvent("release",{originalEvent:d.originalEvent})):d.insideElementPressed?l(h,e.ButtonState.GROUP):a(h,e.ButtonState.HOVER)},clickHandler:function(d){d.quick&&h.raiseEvent("click",{originalEvent:d.originalEvent})},keyHandler:function(d){d.keyCode===13?(h.raiseEvent("click",{originalEvent:d.originalEvent}),h.raiseEvent("release",{originalEvent:d.originalEvent}),d.preventDefault=!0):d.preventDefault=!1}}),l(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){l(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(u){e.requestAnimationFrame(function(){n(u)})}function n(u){var h,d,f;u.shouldFade&&(h=e.now(),d=h-u.fadeBeginTime,f=1-d/u.fadeLength,f=Math.min(1,f),f=Math.max(0,f),u.imgGroup&&e.setElementOpacity(u.imgGroup,f,!0),f>0&&i(u))}function r(u){u.shouldFade=!0,u.fadeBeginTime=e.now()+u.fadeDelay,window.setTimeout(function(){i(u)},u.fadeDelay)}function o(u){u.shouldFade=!1,u.imgGroup&&e.setElementOpacity(u.imgGroup,1,!0)}function a(u,h){u.element.disabled||(h>=e.ButtonState.GROUP&&u.currentState===e.ButtonState.REST&&(o(u),u.currentState=e.ButtonState.GROUP),h>=e.ButtonState.HOVER&&u.currentState===e.ButtonState.GROUP&&(u.imgHover&&(u.imgHover.style.visibility=""),u.currentState=e.ButtonState.HOVER),h>=e.ButtonState.DOWN&&u.currentState===e.ButtonState.HOVER&&(u.imgDown&&(u.imgDown.style.visibility=""),u.currentState=e.ButtonState.DOWN))}function l(u,h){u.element.disabled||(h<=e.ButtonState.HOVER&&u.currentState===e.ButtonState.DOWN&&(u.imgDown&&(u.imgDown.style.visibility="hidden"),u.currentState=e.ButtonState.HOVER),h<=e.ButtonState.GROUP&&u.currentState===e.ButtonState.HOVER&&(u.imgHover&&(u.imgHover.style.visibility="hidden"),u.currentState=e.ButtonState.GROUP),h<=e.ButtonState.REST&&u.currentState===e.ButtonState.GROUP&&(r(u),u.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var l;for(l=0;l<r.buttons.length;l++)r.buttons[l].notifyGroupEnter()},leaveHandler:function(a){var l;if(!a.insideElementPressed)for(l=0;l<r.buttons.length;l++)r.buttons[l].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var l,u;this.degrees>=270?(l=this.getTopRight(),this.x=l.x,this.y=l.y,u=this.height,this.height=this.width,this.width=u,this.degrees-=270):this.degrees>=180?(l=this.getBottomRight(),this.x=l.x,this.y=l.y,this.degrees-=180):this.degrees>=90&&(l=this.getBottomLeft(),this.x=l.x,this.y=l.y,u=this.height,this.height=this.width,this.width=u,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),l=n.minus(i),u=Math.atan(l.y/l.x);return l.x<0?u+=Math.PI:l.y<0&&(u+=2*Math.PI),new e.Rect(i.x,i.y,o,a,u/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),l=Math.max(n.x+n.width,r.x+r.width),u=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,l-o,u-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var l=this.getBottomLeft();i.containsPoint(l,n)&&r.push(l);var u=this.getBottomRight();i.containsPoint(u,n)&&r.push(u);var h=i.getTopLeft();this.containsPoint(h,n)&&r.push(h);var d=i.getTopRight();this.containsPoint(d,n)&&r.push(d);var f=i.getBottomLeft();this.containsPoint(f,n)&&r.push(f);var m=i.getBottomRight();this.containsPoint(m,n)&&r.push(m);for(var v=this._getSegments(),E=i._getSegments(),T=0;T<v.length;T++)for(var x=v[T],O=0;O<E.length;O++){var V=E[O],G=Y(x[0],x[1],V[0],V[1]);G&&r.push(G)}function Y(F,D,xe,Pe){var te=D.minus(F),se=Pe.minus(xe),W=-se.x*te.y+te.x*se.y;if(W===0)return null;var ne=(te.x*(F.y-xe.y)-te.y*(F.x-xe.x))/W,U=(se.x*(F.y-xe.y)-se.y*(F.x-xe.x))/W;return-n<=ne&&ne<=1-n&&-n<=U&&U<=1-n?new e.Point(F.x+U*te.x,F.y+U*te.y):null}if(r.length===0)return null;for(var J=r[0].x,A=r[0].x,S=r[0].y,R=r[0].y,M=1;M<r.length;M++){var k=r[M];k.x<J&&(J=k.x),k.x>A&&(A=k.x),k.y<S&&(S=k.y),k.y>R&&(R=k.y)}return new e.Rect(J,S,A-J,R-S)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(u){var h=1e-15;return Math.abs(u)<h?0:u});var l=Math.atan(a.y/a.x);return a.x<0?l+=Math.PI:a.y<0&&(l+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,l/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),l=Math.max(i.x,n.x,r.x,o.x),u=Math.min(i.y,n.y,r.y,o.y),h=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,u,l-a,h-u)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),l=o.minus(r),u=a.minus(r);return(i.x-r.x)*l.x+(i.y-r.y)*l.y>=-n&&(i.x-o.x)*l.x+(i.y-o.y)*l.y<=n&&(i.x-r.x)*u.x+(i.y-r.y)*u.y>=-n&&(i.x-a.x)*u.x+(i.y-a.y)*u.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(f){var m=this,v=f.viewer,E=e.getElementSize(v.element),T,x,O;for(f.id||(f.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=f.id,this.element.className="referencestrip"),f=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},f,{element:this.element}),e.extend(this,f),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,x=this.element.style,x.marginTop="0px",x.marginRight="0px",x.marginBottom="0px",x.marginLeft="0px",x.left="0px",x.bottom="0px",x.border="0px",x.background="#000",x.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=v,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,l),leaveHandler:e.delegate(this,u),keyDownHandler:e.delegate(this,h),keyHandler:e.delegate(this,d),preProcessEventHandler:function(V){V.eventType==="wheel"&&(V.preventDefault=!0)}}),f.width&&f.height?(this.element.style.width=f.width+"px",this.element.style.height=f.height+"px",v.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):f.scroll==="horizontal"?(this.element.style.width=E.x*f.sizeRatio*v.tileSources.length+12*v.tileSources.length+"px",this.element.style.height=E.y*f.sizeRatio+"px",v.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=E.y*f.sizeRatio*v.tileSources.length+12*v.tileSources.length+"px",this.element.style.width=E.x*f.sizeRatio+"px",v.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=E.x*this.sizeRatio+8,this.panelHeight=E.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},O=0;O<v.tileSources.length;O++)T=e.makeNeutralElement("div"),T.id=this.element.id+"-"+O,T.style.width=m.panelWidth+"px",T.style.height=m.panelHeight+"px",T.style.display="inline",T.style.float="left",T.style.cssFloat="left",T.style.padding="2px",e.setElementTouchActionNone(T),e.setElementPointerEventsNone(T),this.element.appendChild(T),T.activePanel=!1,this.panels.push(T);a(this,this.scroll==="vertical"?E.y:E.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(f){var m=this.element.querySelector("#"+this.element.id+"-"+f),v=e.getElementSize(this.viewer.canvas),E=Number(this.element.style.width.replace("px","")),T=Number(this.element.style.height.replace("px","")),x=-Number(this.element.style.marginLeft.replace("px","")),O=-Number(this.element.style.marginTop.replace("px","")),V;this.currentSelected!==m&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=m,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(V=Number(f)*(this.panelWidth+3),V>x+v.x-this.panelWidth?(V=Math.min(V,E-v.x),this.element.style.marginLeft=-V+"px",a(this,v.x,-V)):V<x&&(V=Math.max(0,V-v.x/2),this.element.style.marginLeft=-V+"px",a(this,v.x,-V))):(V=Number(f)*(this.panelHeight+3),V>O+v.y-this.panelHeight?(V=Math.min(V,T-v.y),this.element.style.marginTop=-V+"px",a(this,v.y,-V)):V<O&&(V=Math.max(0,V-v.y/2),this.element.style.marginTop=-V+"px",a(this,v.y,-V))),this.currentPage=f,l.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var f in this.miniViewers)this.miniViewers[f].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(f){if(f.quick){var m;this.scroll==="horizontal"?m=Math.floor(f.position.x/(this.panelWidth+4)):m=Math.floor(f.position.y/this.panelHeight),this.viewer.goToPage(m)}this.element.focus()}function r(f){if(this.dragging=!0,this.element){var m=Number(this.element.style.marginLeft.replace("px","")),v=Number(this.element.style.marginTop.replace("px","")),E=Number(this.element.style.width.replace("px","")),T=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-f.delta.x>0?m>-(E-x.x)&&(this.element.style.marginLeft=m+f.delta.x*2+"px",a(this,x.x,m+f.delta.x*2)):-f.delta.x<0&&m<0&&(this.element.style.marginLeft=m+f.delta.x*2+"px",a(this,x.x,m+f.delta.x*2)):-f.delta.y>0?v>-(T-x.y)&&(this.element.style.marginTop=v+f.delta.y*2+"px",a(this,x.y,v+f.delta.y*2)):-f.delta.y<0&&v<0&&(this.element.style.marginTop=v+f.delta.y*2+"px",a(this,x.y,v+f.delta.y*2))}}function o(f){if(this.element){var m=Number(this.element.style.marginLeft.replace("px","")),v=Number(this.element.style.marginTop.replace("px","")),E=Number(this.element.style.width.replace("px","")),T=Number(this.element.style.height.replace("px","")),x=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?f.scroll>0?m>-(E-x.x)&&(this.element.style.marginLeft=m-f.scroll*60+"px",a(this,x.x,m-f.scroll*60)):f.scroll<0&&m<0&&(this.element.style.marginLeft=m-f.scroll*60+"px",a(this,x.x,m-f.scroll*60)):f.scroll<0?v>x.y-T&&(this.element.style.marginTop=v+f.scroll*60+"px",a(this,x.y,v+f.scroll*60)):f.scroll>0&&v<0&&(this.element.style.marginTop=v+f.scroll*60+"px",a(this,x.y,v+f.scroll*60)),f.preventDefault=!0}}function a(f,m,v){var E,T,x,O,V,G;for(f.scroll==="horizontal"?E=f.panelWidth:E=f.panelHeight,T=Math.ceil(m/E)+5,x=Math.ceil((Math.abs(v)+m)/E)+1,T=x-T,T=T<0?0:T,V=T;V<x&&V<f.panels.length;V++)if(G=f.panels[V],!G.activePanel){var Y,J=f.viewer.tileSources[V];J.referenceStripThumbnailUrl?Y={type:"image",url:J.referenceStripThumbnailUrl}:Y=J,O=new e.Viewer({id:G.id,tileSources:[Y],element:G,navigatorSizeRatio:f.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:f.viewer.loadTilesWithAjax,ajaxHeaders:f.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(O.canvas),e.setElementPointerEventsNone(O.container),O.innerTracker.setTracking(!1),O.outerTracker.setTracking(!1),f.miniViewers[G.id]=O,G.activePanel=!0}}function l(f){var m=f.eventSource.element;this.scroll==="horizontal"?m.style.marginBottom="0px":m.style.marginLeft="0px"}function u(f){var m=f.eventSource.element;this.scroll==="horizontal"?m.style.marginBottom="-"+e.getElementSize(m).y/2+"px":m.style.marginLeft="-"+e.getElementSize(m).x/2+"px"}function h(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}function d(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,l){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=l},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(h){i(o,h,n.callback)},l={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},u=new e.ImageJob(l);!this.jobLimit||this.jobsInProgress<this.jobLimit?(u.start(),this.jobsInProgress++):this.jobQueue.push(u)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,l,u,h,d,f,m,v){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=f,this.exists=a,this._url=l,this.postData=m,this.context2D=u,this.loadWithAjax=h,this.ajaxHeaders=d,v===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),v=e.TileSource.prototype.getTileHashKey(i,n,r,l,d,m)),this.cacheKey=v,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(l){return l%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,l=this.size=o.size,u="";n.overlayPreserveContentDirection&&(u=n.flipped?" scaleX(-1)":" scaleX(1)");var h=n.flipped?-o.rotate:o.rotate,d=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,l,this.element);else{var f=this.style,m=this.element.style;m.display="block",f.left=a.x+"px",f.top=a.y+"px",this.width!==null&&(m.width=l.x+"px"),this.height!==null&&(m.height=l.y+"px");var v=e.getCssPropertyWithVendorPrefix("transformOrigin"),E=e.getCssPropertyWithVendorPrefix("transform");v&&E&&(h&&!n.flipped?(m[E]="",f[v]=this._getTransformOrigin(),f[E]="rotate("+h+"deg)"):!h&&n.flipped?(m[E]=u,f[v]=this._getTransformOrigin(),f[E]=d):h&&n.flipped?(m[E]=u,f[v]=this._getTransformOrigin(),f[E]="rotate("+h+"deg)"+d):(m[E]="",f[v]="",f[E]="")),f.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),l=this._getBoundingBox(a,i.getRotation(!0));n=l.getTopLeft(),r=l.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(l){l.opacity!==0&&a._drawTiles(l)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(h=>h.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var l=a.length-1;l>=0;l--){var u=a[l];this._drawTile(u),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:u})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var l=o.getImage();if(!l)return;o.element=e.makeNeutralElement("div"),o.imgElement=l.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(h){super(h),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let h=e.makeNeutralElement("canvas"),d=this._calculateCanvasSize();return h.width=d.x,h.height=d.y,h}draw(h){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const d of h)d.opacity!==0&&this._drawTiles(d)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(h){return!0}setImageSmoothingEnabled(h){this._imageSmoothingEnabled=!!h,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(h){var d=this.context;d.save(),d.lineWidth=2*e.pixelDensityRatio,d.strokeStyle=this.debugGridColor[0],d.fillStyle=this.debugGridColor[0],d.strokeRect(h.x*e.pixelDensityRatio,h.y*e.pixelDensityRatio,h.width*e.pixelDensityRatio,h.height*e.pixelDensityRatio),d.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(h,d,f,m){this.viewer.raiseEvent("tile-drawing",{tiledImage:h,context:d,tile:f,rendered:m})}_prepareNewFrame(){var h=this._calculateCanvasSize();if((this.canvas.width!==h.x||this.canvas.height!==h.y)&&(this.canvas.width=h.x,this.canvas.height=h.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var d=this._calculateSketchCanvasSize();this.sketchCanvas.width=d.x,this.sketchCanvas.height=d.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(h,d){var f=this._getContext(h);if(d)f.clearRect(d.x,d.y,d.width,d.height);else{var m=f.canvas;f.clearRect(0,0,m.width,m.height)}}_drawTiles(h){var d=h.getTilesToDraw().map(F=>F.tile);if(!(h.opacity===0||d.length===0&&!h.placeholderFillStyle)){var f=d[0],m;f&&(m=h.opacity<1||h.compositeOperation&&h.compositeOperation!=="source-over"||!h._isBottomItem()&&h.source.hasTransparency(f.context2D,f.getUrl(),f.ajaxHeaders,f.postData));var v,E,T=this.viewport.getZoom(!0),x=h.viewportToImageZoom(T);d.length>1&&x>h.smoothTileEdgesMinZoom&&!h.iOSDevice&&h.getRotation(!0)%360===0&&(m=!0,v=f.getScaleForEdgeSmoothing(),E=f.getTranslationForEdgeSmoothing(v,this._getCanvasSize(!1),this._getCanvasSize(!0)));var O;m&&(v||(O=this.viewport.viewportToViewerElementRectangle(h.getClippedBounds(!0)).getIntegerBoundingBox(),O=O.times(e.pixelDensityRatio)),this._clear(!0,O)),v||this._setRotations(h,m);var V=!1;if(h._clip){this._saveContext(m);var G=h.imageToViewportRectangle(h._clip,!0);G=G.rotate(-h.getRotation(!0),h._getRotationPoint(!0));var Y=this.viewportToDrawerRectangle(G);v&&(Y=Y.times(v)),E&&(Y=Y.translate(E)),this._setClip(Y,m),V=!0}if(h._croppingPolygons){var J=this;V||this._saveContext(m);try{var A=h._croppingPolygons.map(function(F){return F.map(function(D){var xe=h.imageToViewportCoordinates(D.x,D.y,!0).rotate(-h.getRotation(!0),h._getRotationPoint(!0)),Pe=J.viewportCoordToDrawerCoord(xe);return v&&(Pe=Pe.times(v)),E&&(Pe=Pe.plus(E)),Pe})});this._clipWithPolygons(A,m)}catch(F){e.console.error(F)}V=!0}if(h._hasOpaqueTile=!1,h.placeholderFillStyle&&h._hasOpaqueTile===!1){let F=this.viewportToDrawerRectangle(h.getBoundsNoRotate(!0));v&&(F=F.times(v)),E&&(F=F.translate(E));let D=null;typeof h.placeholderFillStyle=="function"?D=h.placeholderFillStyle(h,this.context):D=h.placeholderFillStyle,this._drawRectangle(F,D,m)}var S=l(h.subPixelRoundingForTransparency),R=!1;if(S===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)R=!0;else if(S===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var M=this.viewer&&this.viewer.isAnimating();R=!M}for(var k=0;k<d.length;k++)f=d[k],this._drawTile(f,h,m,v,E,R,h.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:h,tile:f});V&&this._restoreContext(m),v||(h.getRotation(!0)%360!==0&&this._restoreRotationChanges(m),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(m)),m&&(v&&this._setRotations(h),this.blendSketch({opacity:h.opacity,scale:v,translate:E,compositeOperation:h.compositeOperation,bounds:O}),v&&(h.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(h,d),this._raiseTiledImageDrawnEvent(h,d)}}_drawDebugInfo(h,d){if(h.debugMode)for(var f=d.length-1;f>=0;f--){var m=d[f];try{this._drawDebugInfoOnTile(m,d.length,f,h)}catch(v){e.console.error(v)}}}_clipWithPolygons(h,d){var f=this._getContext(d);f.beginPath();for(const m of h)for(const[v,E]of m.entries())f[v===0?"moveTo":"lineTo"](E.x,E.y);f.clip()}_drawTile(h,d,f,m,v,E,T){e.console.assert(h,"[Drawer._drawTile] tile is required"),e.console.assert(d,"[Drawer._drawTile] drawingHandler is required");var x=this._getContext(f);m=m||1,this._drawTileToCanvas(h,x,d,m,v,E,T)}_drawTileToCanvas(h,d,f,m,v,E,T){var x=h.position.times(e.pixelDensityRatio),O=h.size.times(e.pixelDensityRatio),V;if(!h.context2D&&!h.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",h.toString());return}if(V=h.getCanvasContext(),!h.loaded||!V){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",h.toString());return}d.save(),typeof m=="number"&&m!==1&&(x=x.times(m),O=O.times(m)),v instanceof e.Point&&(x=x.plus(v)),d.globalAlpha===1&&h.hasTransparency&&(E&&(x.x=Math.round(x.x),x.y=Math.round(x.y),O.x=Math.round(O.x),O.y=Math.round(O.y)),d.clearRect(x.x,x.y,O.x,O.y)),this._raiseTileDrawingEvent(f,d,h,V);var G,Y;h.sourceBounds?(G=Math.min(h.sourceBounds.width,V.canvas.width),Y=Math.min(h.sourceBounds.height,V.canvas.height)):(G=V.canvas.width,Y=V.canvas.height),d.translate(x.x+O.x/2,0),h.flipped&&d.scale(-1,1),d.drawImage(V.canvas,0,0,G,Y,-O.x/2,x.y,O.x,O.y),d.restore()}_getContext(h){var d=this.context;if(h){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var f=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=f.x,this.sketchCanvas.height=f.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var m=this;this.viewer.addHandler("rotate",function v(){if(m.viewport.getRotation()!==0){m.viewer.removeHandler("rotate",v);var E=m._calculateSketchCanvasSize();m.sketchCanvas.width=E.x,m.sketchCanvas.height=E.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}d=this.sketchContext}return d}_saveContext(h){this._getContext(h).save()}_restoreContext(h){this._getContext(h).restore()}_setClip(h,d){var f=this._getContext(d);f.beginPath(),f.rect(h.x,h.y,h.width,h.height),f.clip()}_drawRectangle(h,d,f){var m=this._getContext(f);m.save(),m.fillStyle=d,m.fillRect(h.x,h.y,h.width,h.height),m.restore()}blendSketch(h,d,f,m){var v=h;e.isPlainObject(v)||(v={opacity:h,scale:d,translate:f,compositeOperation:m}),h=v.opacity,m=v.compositeOperation;var E=v.bounds;if(this.context.save(),this.context.globalAlpha=h,m&&(this.context.globalCompositeOperation=m),E)E.x<0&&(E.width+=E.x,E.x=0),E.x+E.width>this.canvas.width&&(E.width=this.canvas.width-E.x),E.y<0&&(E.height+=E.y,E.y=0),E.y+E.height>this.canvas.height&&(E.height=this.canvas.height-E.y),this.context.drawImage(this.sketchCanvas,E.x,E.y,E.width,E.height,E.x,E.y,E.width,E.height);else{d=v.scale||1,f=v.translate;var T=f instanceof e.Point?f:new e.Point(0,0),x=0,O=0;if(f){var V=this.sketchCanvas.width-this.canvas.width,G=this.sketchCanvas.height-this.canvas.height;x=Math.round(V/2),O=Math.round(G/2)}this.context.drawImage(this.sketchCanvas,T.x-x*d,T.y-O*d,(this.canvas.width+2*x)*d,(this.canvas.height+2*O)*d,-x,-O,this.canvas.width+2*x,this.canvas.height+2*O)}this.context.restore()}_drawDebugInfoOnTile(h,d,f,m){var v=this.viewer.world.getIndexOfItem(m)%this.debugGridColor.length,E=this.context;E.save(),E.lineWidth=2*e.pixelDensityRatio,E.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",E.strokeStyle=this.debugGridColor[v],E.fillStyle=this.debugGridColor[v],this._setRotations(m),this._viewportFlipped&&this._flip({point:h.position.plus(h.size.divide(2))}),E.strokeRect(h.position.x*e.pixelDensityRatio,h.position.y*e.pixelDensityRatio,h.size.x*e.pixelDensityRatio,h.size.y*e.pixelDensityRatio);var T=(h.position.x+h.size.x/2)*e.pixelDensityRatio,x=(h.position.y+h.size.y/2)*e.pixelDensityRatio;E.translate(T,x);const O=this.viewport.getRotation(!0);E.rotate(Math.PI/180*-O),E.translate(-T,-x),h.x===0&&h.y===0&&(E.fillText("Zoom: "+this.viewport.getZoom(),h.position.x*e.pixelDensityRatio,(h.position.y-30)*e.pixelDensityRatio),E.fillText("Pan: "+this.viewport.getBounds().toString(),h.position.x*e.pixelDensityRatio,(h.position.y-20)*e.pixelDensityRatio)),E.fillText("Level: "+h.level,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+20)*e.pixelDensityRatio),E.fillText("Column: "+h.x,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+30)*e.pixelDensityRatio),E.fillText("Row: "+h.y,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+40)*e.pixelDensityRatio),E.fillText("Order: "+f+" of "+d,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+50)*e.pixelDensityRatio),E.fillText("Size: "+h.size.toString(),(h.position.x+10)*e.pixelDensityRatio,(h.position.y+60)*e.pixelDensityRatio),E.fillText("Position: "+h.position.toString(),(h.position.x+10)*e.pixelDensityRatio,(h.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),m.getRotation(!0)%360!==0&&this._restoreRotationChanges(),E.restore()}_updateImageSmoothingEnabled(h){h.msImageSmoothingEnabled=this._imageSmoothingEnabled,h.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(h){var d=this._getContext(h).canvas;return new e.Point(d.width,d.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(h,d=!1){var f=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:d,saveContext:f}),f=!1),h.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:h.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(h._getRotationPoint(!0),!0),useSketch:d,saveContext:f})}_offsetForRotation(h){var d=h.point?h.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(h.useSketch);f.save(),f.translate(d.x,d.y),f.rotate(Math.PI/180*h.degrees),f.translate(-d.x,-d.y)}_flip(h){h=h||{};var d=h.point?h.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(h.useSketch);f.translate(d.x,0),f.scale(-1,1),f.translate(-d.x,0)}_restoreRotationChanges(h){var d=this._getContext(h);d.restore()}_calculateCanvasSize(){var h=e.pixelDensityRatio,d=this.viewport.getContainerSize();return{x:Math.round(d.x*h),y:Math.round(d.y*h)}}_calculateSketchCanvasSize(){var h=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return h;var d=Math.ceil(Math.sqrt(h.x*h.x+h.y*h.y));return{x:d,y:d}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(u){return u!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&u!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&u!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(u){return o(u)?r:u}function l(u){if(typeof u=="number")return a(u);if(!u||!e.Browser)return r;var h=u[e.Browser.vendor];return o(h)&&(h=u["*"]),a(h)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let l=0;l<o;++l)r.activeTexture(r.TEXTURE0+l),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let l={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},u=this.viewport.flipped?-1:1,h=e.Mat3.makeTranslation(-l.center.x,-l.center.y),d=e.Mat3.makeScaling(2/l.bounds.width*u,-2/l.bounds.height),f=e.Mat3.makeRotation(-l.rotation),m=d.multiply(f).multiply(h);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let v=!1;r.forEach((E,T)=>{if(E.isTainted()){v&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),v=!1);const x=this._getBackupCanvasDrawer();x.draw([E]),this._outputContext.drawImage(x.canvas,0,0)}else{let x=E.getTilesToDraw();if(E.placeholderFillStyle&&E._hasOpaqueTile===!1&&this._drawPlaceholder(E),x.length===0||E.getOpacity()===0)return;let O=x[0],V=E.compositeOperation||this.viewer.compositeOperation||E._clip||E._croppingPolygons||E.debugMode,G=V||E.opacity<1||O.hasTransparency;V&&(v&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),G?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let Y=m,J=E.getRotation(!0);if(J%360!==0){let F=e.Mat3.makeRotation(-J*Math.PI/180),D=E.getBoundsNoRotate(!0).getCenter(),xe=e.Mat3.makeTranslation(D.x,D.y),Pe=e.Mat3.makeTranslation(-D.x,-D.y),te=xe.multiply(F).multiply(Pe);Y=m.multiply(te)}let A=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(A<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${A}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let S=new Float32Array(A*12),R=new Array(A),M=new Array(A),k=new Array(A);for(let F=0;F<x.length;F++){let D=x[F].tile,xe=F%A,Pe=xe+1,te=D.getCanvasContext(),se=te?this._TextureMap.get(te.canvas):null;if(se||(this._tileReadyHandler({tile:D,tiledImage:E}),se=te?this._TextureMap.get(te.canvas):null),se&&this._getTileData(D,E,se,Y,xe,S,R,M,k),Pe===A||F===x.length-1){for(let W=0;W<=Pe;W++)o.activeTexture(o.TEXTURE0+W),o.bindTexture(o.TEXTURE_2D,R[W]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,S,o.DYNAMIC_DRAW),M.forEach((W,ne)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[ne],!1,W)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(k)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*Pe)}}G&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,E.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),v=!0,V&&(this._applyContext2dPipeline(E,x,T),v=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),T===0&&this._raiseTiledImageDrawnEvent(E,x.map(F=>F.tile))}}),v&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const l=this.viewer.viewport.getFlip();l&&this._flip(),this._drawDebugInfo(o,r,l),l&&this._flip()}}_getTileData(r,o,a,l,u,h,d,f,m){let v=a.texture,E=a.position;h.set(E,u*12);let T=this._calculateOverlapFraction(r,o),x=r.positionedBounds.width*T.x,O=r.positionedBounds.height*T.y,V=r.positionedBounds.x+(r.x===0?0:x),G=r.positionedBounds.y+(r.y===0?0:O),Y=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:x),J=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:O),A=Y-V,S=J-G,R=new e.Mat3([A,0,0,0,S,0,V,G,1]);if(r.flipped){let k=e.Mat3.makeTranslation(.5,0),F=e.Mat3.makeTranslation(-.5,0),D=k.multiply(e.Mat3.makeScaling(-1,1)).multiply(F);R=R.multiply(D)}let M=l.multiply(R);m[u]=r.opacity,d[u]=v,f[u]=M.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(v=>`uniform mat3 u_matrix_${v};`).join(`
`),a=()=>[...Array(r).keys()].map(v=>`${v>0?"else ":""}if(int(a_index) == ${v}) { transform_matrix = u_matrix_${v}; }`).join(`
`);const l=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,u=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let h=this._gl,d=this.constructor.initShaderProgram(h,l,u);h.useProgram(d),this._firstPass={shaderProgram:d,aOutputPosition:h.getAttribLocation(d,"a_output_position"),aTexturePosition:h.getAttribLocation(d,"a_texture_position"),aIndex:h.getAttribLocation(d,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(v=>h.getUniformLocation(d,`u_matrix_${v}`)),uImages:h.getUniformLocation(d,"u_images"),uOpacities:h.getUniformLocation(d,"u_opacities"),bufferOutputPosition:h.createBuffer(),bufferTexturePosition:h.createBuffer(),bufferIndex:h.createBuffer()},h.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let f=new Float32Array(r*12);for(let v=0;v<r;++v)f.set(Float32Array.from(this._unitQuad),v*12);h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),h.bufferData(h.ARRAY_BUFFER,f,h.STATIC_DRAW),h.enableVertexAttribArray(this._firstPass.aOutputPosition),h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),h.enableVertexAttribArray(this._firstPass.aTexturePosition),h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferIndex);let m=[...Array(this._glNumTextures).keys()].map(v=>Array(6).fill(v)).flat();h.bufferData(h.ARRAY_BUFFER,new Float32Array(m),h.STATIC_DRAW),h.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,l=this.constructor.initShaderProgram(a,r,o);a.useProgram(l),this._secondPass={shaderProgram:l,aOutputPosition:a.getAttribLocation(l,"a_output_position"),aTexturePosition:a.getAttribLocation(l,"a_texture_position"),uMatrix:a.getUniformLocation(l,"u_matrix"),uImage:a.getUniformLocation(l,"u_image"),uOpacityMultiplier:a.getUniformLocation(l,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let u=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,u.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,l){return new Float32Array([r,l,o,l,r,a,r,a,o,l,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let l=o.getCanvasContext(),u=l&&l.canvas;if(!u||e.isCanvasTainted(u)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(u)){let d=this._gl,f=d.createTexture(),m,v=a.source.tileOverlap,E,T;if(o.sourceBounds?(E=Math.min(o.sourceBounds.width,u.width)/u.width,T=Math.min(o.sourceBounds.height,u.height)/u.height):(E=1,T=1),v>0){let O=this._calculateOverlapFraction(o,a),V=(o.x===0?0:O.x)*E,G=(o.y===0?0:O.y)*T,Y=(o.isRightMost?1:1-O.x)*E,J=(o.isBottomMost?1:1-O.y)*T;m=this._makeQuadVertexBuffer(V,Y,G,J)}else E===1&&T===1?m=this._unitQuad:m=this._makeQuadVertexBuffer(0,E,0,T);let x={texture:f,position:m};this._TextureMap.set(u,x),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,f),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this._textureFilter()),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(l)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,l=r.sourceBounds.width,u=r.sourceBounds.height,h=(r.x===0?0:a)+(r.isRightMost?0:a),d=(r.y===0?0:a)+(r.isBottomMost?0:a),f=a/(l+h),m=a/(u+d);return{x:f,y:m}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(l){e.console.error("Error uploading image data to WebGL",l)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(l=>{let u=r.imageToViewportCoordinates(l.x,l.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(u)});this._clippingContext.beginPath(),a.forEach((l,u)=>{this._clippingContext[u===0?"moveTo":"lineTo"](l.x,l.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(l=>{let u=r.imageToViewportCoordinates(l.x,l.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(u)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((l,u)=>{this._clippingContext[u===0?"moveTo":"lineTo"](l.x,l.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var l=r.length-1;l>=0;l--){var u=r[l].tile;try{this._drawDebugInfoOnTile(u,r.length,l,o,a)}catch(h){e.console.error(h)}}}_drawDebugInfoOnTile(r,o,a,l,u){var h=this.viewer.world.getIndexOfItem(l)%this.debugGridColor.length,d=this.context;d.save(),d.lineWidth=2*e.pixelDensityRatio,d.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",d.strokeStyle=this.debugGridColor[h],d.fillStyle=this.debugGridColor[h],this._setRotations(l),u&&this._flip({point:r.position.plus(r.size.divide(2))}),d.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var f=(r.position.x+r.size.x/2)*e.pixelDensityRatio,m=(r.position.y+r.size.y/2)*e.pixelDensityRatio;d.translate(f,m);const v=this.viewport.getRotation(!0);d.rotate(Math.PI/180*-v),d.translate(-f,-m),r.x===0&&r.y===0&&(d.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),d.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),d.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),d.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),d.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),d.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),d.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),d.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.getRotation(!0)%360!==0&&this._restoreRotationChanges(),d.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),l=this._outputContext;let u;typeof r.placeholderFillStyle=="function"?u=r.placeholderFillStyle(r,l):u=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),l.fillStyle=u,l.translate(a.x,a.y),l.rotate(Math.PI/180*o.degrees),l.translate(-a.x,-a.y),l.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function l(f,m,v){const E=f.createShader(m);return f.shaderSource(E,v),f.compileShader(E),f.getShaderParameter(E,f.COMPILE_STATUS)?E:(e.console.error(`An error occurred compiling the shaders: ${f.getShaderInfoLog(E)}`),f.deleteShader(E),null)}const u=l(r,r.VERTEX_SHADER,o),h=l(r,r.FRAGMENT_SHADER,a),d=r.createProgram();return r.attachShader(d,u),r.attachShader(d,h),r.linkProgram(d),r.getProgramParameter(d,r.LINK_STATUS)?d:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(d)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,l,u,h,d,f,m;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),l=1/a,u=l/this.getAspectRatio(),h=new e.Rect(n.x-l/2,n.y-u/2,l,u),d=this._pixelFromPoint(this.zoomPoint,h),f=d.minus(o).rotate(-this.getRotation(!0)),m=f.divide(this._containerInnerSize.x*a),r.plus(m)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var l=n.x+n.width,u=r.x+r.width,h,d,f;n.width>r.width?h=this.visibilityRatio*r.width:h=this.visibilityRatio*n.width,d=r.x-l+h,f=u-n.x-h,h>r.width?(n.x+=(d+f)/2,o=!0):f<0?(n.x+=f,o=!0):d>0&&(n.x+=d,o=!0)}if(!this.wrapVertical){var m=n.y+n.height,v=r.y+r.height,E,T,x;n.height>r.height?E=this.visibilityRatio*r.height:E=this.visibilityRatio*n.height,T=r.y-m+E,x=v-n.y-E,E>r.height?(n.y+=(T+x)/2,a=!0):x<0?(n.y+=x,a=!0):T>0&&(n.y+=T,a=!0)}var O=o||a,V=O?this.viewerElementToViewportRectangle(n):i.clone();return V.xConstrained=o,V.yConstrained=a,V.constraintApplied=O,V},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),l=i.getCenter(),u=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();u.getAspectRatio()>=a?u.height=u.width/a:u.width=u.height*a,u.x=l.x-u.width/2,u.y=l.y-u.height/2;var h=1/u.width;if(r)return this.panTo(l,!0),this.zoomTo(h,null,!0),o&&this.applyConstraints(!0),this;var d=this.getCenter(!0),f=this.getZoom(!0);this.panTo(d,!0),this.zoomTo(f,null,!0);var m=this.getBounds(),v=this.getZoom();if(v===0||Math.abs(h/v-1)<1e-8)return this.zoomTo(h,null,!0),this.panTo(l,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(l,!1),h=this._applyZoomConstraints(h),this.zoomTo(h,null,!1);var E=this.getConstrainedBounds();this.panTo(d,!0),this.zoomTo(f,null,!0),this.fitBounds(E)}else{var T=u.rotate(-this.getRotation()),x=T.getTopLeft().times(h).minus(m.getTopLeft().times(v)).divide(h-v);this.zoomTo(h,x,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),l=e.positiveModulo(i,360),u=l-a;u>180?l-=360:u<-180&&(l+=360);var h=a-l;this.degreesSpring.resetTo(i+h),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var l=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),l},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var l=this.viewer.world.getItemCount();if(l>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(l===1){var u=this.viewer.world.getItemAt(0);return u.imageToViewportRectangle(i,n,r,o,!0)}}var h=this.imageToViewportCoordinates(a.x,a.y),d=this._imageToViewportDelta(a.width,a.height);return new e.Rect(h.x,h.y,d.x,d.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var l=this.viewer.world.getItemCount();if(l>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(l===1){var u=this.viewer.world.getItemAt(0);return u.viewportToImageRectangle(i,n,r,o,!0)}}var h=this.viewportToImageCoordinates(a.x,a.y),d=this._viewportToImageDelta(a.width,a.height);return new e.Rect(h.x,h.y,d.x,d.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,l=this._contentBoundsNoRotate.width,u=a/o*l;return i*u},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,l=this._contentBoundsNoRotate.width,u=o/a/l;return i*u},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var l=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var u=i.degrees||0;delete i.degrees;var h=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:u,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,l,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(h,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),l=n||r||o||a||this._needsUpdate;if(l||i||!this._fullyLoaded){let u=this._updateLevelsForViewport();this._setFullyLoaded(u)}return this._needsUpdate=!1,l?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,l=(o.y+r%o.y)%o.y,u=this.source.getTileBounds(i,a,l);return this.getFlip()&&(u.x=Math.max(0,1-u.x-u.width)),u.x+=(n-a)/o.x,u.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-l)/o.y),u},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var l=i;l instanceof e.Rect?a=n:l=new e.Rect(i,n,r,o);var u=this.imageToViewportCoordinates(l.getTopLeft(),a),h=this._imageToViewportDelta(l.width,l.height,a);return new e.Rect(u.x,u.y,h.x,h.y,l.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var l=i;i instanceof e.Rect?a=n:l=new e.Rect(i,n,r,o);var u=this.viewportToImageCoordinates(l.getTopLeft(),a),h=this._viewportToImageDelta(l.width,l.height,a);return new e.Rect(u.x,u.y,h.x,h.y,l.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,l=0,u=0,h=1,d=1;if(this._clip&&(a=this._clip.getAspectRatio(),h=this._clip.width/this.source.dimensions.x,d=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(l=this._clip.x/this._clip.height*i.height,u=this._clip.y/this._clip.height*i.height):(l=this._clip.x/this._clip.width*i.width,u=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var f=i.height/d,m=0;o.isHorizontallyCentered?m=(i.width-i.height*a)/2:o.isRight&&(m=i.width-i.height*a),this.setPosition(new e.Point(i.x-l+m,i.y-u),r),this.setHeight(f,r)}else{var v=i.width/h,E=0;o.isVerticallyCentered?E=(i.height-i.width/a)/2:o.isBottom&&(E=i.height-i.width/a),this.setPosition(new e.Point(i.x-l,i.y-u+E),r),this.setWidth(v,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var l in this.tilesMatrix){n=this.source.getNumTiles(l);for(var u in this.tilesMatrix[l]){r=(n.x+u%n.x)%n.x;for(var h in this.tilesMatrix[l][u])if(o=(n.y+h%n.y)%n.y,a=this.tilesMatrix[l][u][h],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var d=this.source.getTileAjaxHeaders(l,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,d)}else a.ajaxHeaders=null}}for(var f=0;f<this._imageLoader.jobQueue.length;f++){var m=this._imageLoader.jobQueue[f];m.loadWithAjax=m.tile.loadWithAjax,m.ajaxHeaders=m.tile.loadWithAjax?m.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),l=e.now();if(this._lastDrawn.forEach(Y=>{Y.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var u=new Array(r-n+1);for(let Y=0,J=r;J>=n;J--,Y++)u[Y]=J;for(let Y=r+1;Y<=this.source.maxLevel;Y++){var h=this.tilesMatrix[Y]&&this.tilesMatrix[Y][0]&&this.tilesMatrix[Y][0][0];if(h&&h.isBottomMost&&h.isRightMost&&h.loaded){u.push(Y);break}}let d=!1;for(let Y=0;Y<u.length;Y++){let J=u[Y];var f=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!0).x*this._scaleSpring.current.value;if(Y===u.length-1||f>=this.minPixelRatio)d=!0;else if(!d)continue;var m=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!1).x*this._scaleSpring.current.value,v=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,E=this.immediateRender?1:v,T=Math.min(1,(f-.5)/.5),x=E/Math.abs(E-m),O=this._updateLevel(J,T,x,a,l,o);o=O.bestTiles;var V=O.updatedTiles.filter(A=>A.loaded),G=function(A,S,R){return function(M){return{tile:M,level:A,levelOpacity:S,currentTime:R}}}(J,T,l);if(this._tilesToDraw[J]=V.map(G),this._providesCoverage(this.coverage,J))break}return o&&o.length>0?(o.forEach(function(Y){Y&&!Y.context2D&&this._loadTile(Y,l)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function l(h){let d=h.tile;if(d&&d.loaded){let f=r._blendTile(d,d.x,d.y,h.level,h.levelOpacity,n,o);r._isBlending=r._isBlending||f,r._needsDraw=r._needsDraw||f||r._wasBlending}}let u=0;for(let h=0;h<i.length;h++){let d=i[h];l(d),this._providesCoverage(this.coverage,d.level)&&(u=Math.max(u,d.level))}if(u>0)for(let h in this._tilesToDraw)h<u&&delete this._tilesToDraw[h]},_blendTile:function(i,n,r,o,a,l,u){let h=1e3*this.blendTime,d,f;return i.blendStart||(i.blendStart=l),d=l-i.blendStart,f=h?Math.min(1,d/h):1,o===u&&(f=1,d=h),this.alwaysBlend&&(f*=a),i.opacity=f,f===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),d<h},_updateLevel:function(i,n,r,o,a,l){var u=o.getBoundingBox().getTopLeft(),h=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:u,bottomright:h,currenttime:a,best:l}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var d=this._getCornerTiles(i,u,h),f=d.topLeft,m=d.bottomRight,v=this.source.getNumTiles(i),E=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(m.x+=1,this.wrapHorizontal||(m.x=Math.min(m.x,v.x-1)));for(var T=Math.max(0,(m.x-f.x)*(m.y-f.y)),x=new Array(T),O=0,V=f.x;V<=m.x;V++)for(var G=f.y;G<=m.y;G++){var Y;if(this.getFlip()){var J=(v.x+V%v.x)%v.x;Y=V+v.x-J-J-1}else Y=V;if(o.intersection(this.getTileBounds(i,Y,G))!==null){var A=this._updateTile(Y,G,i,r,E,v,a,l);l=A.bestTiles,x[O]=A.tile,O+=1}}return{bestTiles:l,updatedTiles:x}},_positionTile:function(i,n,r,o,a){var l=i.bounds.getTopLeft();l.x*=this._scaleSpring.current.value,l.y*=this._scaleSpring.current.value,l.x+=this._xSpring.current.value,l.y+=this._ySpring.current.value;var u=i.bounds.getSize();u.x*=this._scaleSpring.current.value,u.y*=this._scaleSpring.current.value,i.positionedBounds.x=l.x,i.positionedBounds.y=l.y,i.positionedBounds.width=u.x,i.positionedBounds.height=u.y;var h=r.pixelFromPointNoRotate(l,!0),d=r.pixelFromPointNoRotate(l,!1),f=r.deltaPixelsFromPointsNoRotate(u,!0),m=r.deltaPixelsFromPointsNoRotate(u,!1),v=d.plus(m.divide(2)),E=o.squaredDistanceTo(v);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(f=f.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(f.x+=.75),i.isBottomMost&&this.wrapVertical&&(f.y+=.75)),i.position=h,i.size=f,i.squaredDistance=E,i.visibility=a},_updateTile:function(i,n,r,o,a,l,u,h){var d=this._getTile(i,n,r,u,l);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:d}),this._setCoverage(this.coverage,r,i,n,!1);var f=d.loaded||d.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,f),!d.exists)return{bestTiles:h,tile:d};if(d.loaded&&d.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(d,this.source.tileOverlap,this.viewport,a,o),!d.loaded)if(d.context2D)this._setTileLoaded(d);else{var m=this._tileCache.getImageRecord(d.cacheKey);m&&this._setTileLoaded(d,m.getData())}return d.loading?this._tilesLoading++:f||(h=this._compareTiles(h,d,this.maxTilesPerFrame)),{bestTiles:h,tile:d}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var l,u,h=1/this.source.aspectRatio;this.wrapVertical?(l=e.positiveModulo(n.y,h),u=e.positiveModulo(r.y,h)):(l=Math.max(0,n.y),u=Math.min(h,r.y));var d=this.source.getTileAtPoint(i,new e.Point(o,l)),f=this.source.getTileAtPoint(i,new e.Point(a,u)),m=this.source.getNumTiles(i);return this.wrapHorizontal&&(d.x+=m.x*Math.floor(n.x),f.x+=m.x*Math.floor(r.x)),this.wrapVertical&&(d.y+=m.y*Math.floor(n.y/h),f.y+=m.y*Math.floor(r.y/h)),{topLeft:d,bottomRight:f}},_getTile:function(i,n,r,o,a){var l,u,h,d,f,m,v,E,T,x,O=this.tilesMatrix,V=this.source;return O[r]||(O[r]={}),O[r][i]||(O[r][i]={}),(!O[r][i][n]||!O[r][i][n].flipped!=!this.flipped)&&(l=(a.x+i%a.x)%a.x,u=(a.y+n%a.y)%a.y,h=this.getTileBounds(r,i,n),d=V.getTileBounds(r,l,u,!0),f=V.tileExists(r,l,u),m=V.getTileUrl(r,l,u),v=V.getTilePostData(r,l,u),this.loadTilesWithAjax?(E=V.getTileAjaxHeaders(r,l,u),e.isPlainObject(this.ajaxHeaders)&&(E=e.extend({},this.ajaxHeaders,E))):E=null,T=V.getContext2D?V.getContext2D(r,l,u):void 0,x=new e.Tile(r,i,n,h,f,m,T,this.loadTilesWithAjax,E,d,v,V.getTileHashKey(r,l,u,m,E,v)),this.getFlip()?l===0&&(x.isRightMost=!0):l===a.x-1&&(x.isRightMost=!0),u===a.y-1&&(x.isBottomMost=!0),x.flipped=this.flipped,O[r][i][n]=x),x=O[r][i][n],x.lastTouchTime=o,x},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,l){r._onTileLoad(i,n,o,a,l)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var l=this,u=function(){var h=l.source,d=h.getClosestLevel();l._setTileLoaded(i,r,d,a)};u()},_setTileLoaded:function(i,n,r,o){var a=0,l=!1,u=this;function h(){return l&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,d}function d(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=u.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||u._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:u}),u.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:u,tileRequest:o}),u._needsDraw=!0)}var f=h();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:h}),l=!0,f()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,l,u,h;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(u in a)if(Object.prototype.hasOwnProperty.call(a,u)){l=a[u];for(h in l)if(Object.prototype.hasOwnProperty.call(l,h)&&!l[h])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,l=this._imagesLoaded[r.tile.cacheKey];if(l||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),l=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),l.addTile(r.tile),r.tile.cacheImageRecord=l,this._imagesLoadedCount>this._maxImageCacheCount){for(var u=null,h=-1,d=null,f,m,v,E,T,x,O=this._tilesLoaded.length-1;O>=0;O--)if(x=this._tilesLoaded[O],f=x.tile,!(f.level<=o||f.beingDrawn)){if(!u){u=f,h=O,d=x;continue}E=f.lastTouchTime,m=u.lastTouchTime,T=f.level,v=u.level,(E<m||E===m&&T>v)&&(u=f,h=O,d=x)}u&&h>=0&&(this._unloadTile(d),a=h)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let l=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var u=this._imagesLoaded[o.cacheKey];u&&(u.removeTile(o),u.getTileCount()||(u.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,l&&(l.canvas.width=0,l.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:l,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,l=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,u=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,h=l+u,d;!i.rows&&a?d=a:d=Math.ceil(this._items.length/o);var f=0,m=0,v,E,T,x,O;this.setAutoRefigureSizes(!1);for(var V=0;V<this._items.length;V++)V&&V%d===0&&(r==="horizontal"?(m+=h,f=0):(f+=h,m=0)),v=this._items[V],E=v.getBounds(),E.width>E.height?T=l:T=l*(E.width/E.height),x=T*(E.height/E.width),O=new e.Point(f+(l-T)/2,m+(l-x)/2),v.setPosition(O,n),v.setWidth(T,n),r==="horizontal"?f+=h:m+=h;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var l=o.getClippedBounds().getBoundingBox(),u=l.x,h=l.y,d=l.x+l.width,f=l.y+l.height,m=1;m<this._items.length;m++)o=this._items[m],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),l=o.getClippedBounds().getBoundingBox(),u=Math.min(u,l.x),h=Math.min(h,l.y),d=Math.max(d,l.x+l.width),f=Math.max(f,l.y+l.height);this._homeBounds=new e.Rect(u,h,d-u,f-h),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(Tu);var Jh=Tu.exports;const Qt=Qh(Jh);class Ga{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=50,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}getCachedViewportRect(){const t=performance.now();return(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t),this.cachedViewportRect}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),l=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-l}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],l=i[r];if((a[0]-o[0])*(l[1]-o[1])-(a[1]-o[1])*(l[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],l=t[(r+1)%n],u=Math.atan2(a[1]-o[1],a[0]-o[0]);let d=Math.atan2(l[1]-a[1],l[0]-a[0])-u;for(;d>Math.PI;)d-=2*Math.PI;for(;d<-Math.PI;)d+=2*Math.PI;const f=Math.sqrt(Math.pow(l[0]-a[0],2)+Math.pow(l[1]-a[1],2)),m=Math.abs(d)/(f+1e-10);e+=m,i=Math.max(i,m)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let h=0;h<e;h++){const d=t[(h+1)%e];n+=Math.sqrt(Math.pow(t[h][0]-d[0],2)+Math.pow(t[h][1]-d[1],2))}const o=n/e*3;for(let h=0;h<e;h++)for(let d=0;d<e;d++){if(h===d)continue;Math.sqrt(Math.pow(t[h][0]-t[d][0],2)+Math.pow(t[h][1]-t[d][1],2))<o&&i[h]++}const a=Math.max(...i),l=i.reduce((h,d)=>h+d,0)/e,u=i.reduce((h,d)=>h+Math.pow(d-l,2),0)/e;return{maxDensity:a,avgDensity:l,variance:u,uniformityScore:1-Math.sqrt(u)/(l+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation()):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation()))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getCachedViewportRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const r=this.calculateAdaptivePolygonExpansion(i),o=this.expandPolygon(i,r),a=[];let l=0,u=0;o.forEach(([d,f])=>{const m=this.viewer.viewport.imageToViewportCoordinates(new Qt.Point(d,f)),v=this.viewer.viewport.viewportToWindowCoordinates(m);l+=v.x,u+=v.y}),l/=o.length,u/=o.length;let h=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(h=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([d,f])=>{const m=this.viewer.viewport.imageToViewportCoordinates(new Qt.Point(d,f)),v=this.viewer.viewport.viewportToWindowCoordinates(m),E=l+(v.x-l)*h,T=u+(v.y-u)*h;a.push(`${E},${T}`)}),a.length>0)if(this.useClipPath){const d=e.width,f=e.height,m=`0,0 ${d},0 ${d},${f} 0,${f} 0,0`,v=a.slice().reverse().join(" "),E=`polygon(${m} ${v})`;this.overlayElement.style.clipPath=E,this.overlayElement.style.webkitClipPath=E}else{const d=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,m=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(d)))}`;this.overlayElement.style.mask=`url("${m}")`,this.overlayElement.style.webkitMask=`url("${m}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new Qt.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new Qt.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,l=o*this.viewer.container.clientHeight,h=Math.max(a,l)*.75;return Math.max(50,Math.min(500,h))}trackFocusReference(){if(!this.state.selectedHotspot||!this.viewer||!this.viewer.viewport)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.8?n=1:i<=.3?n=0:n=(i-.3)/(.8-.3);let r=1;if(this.state.selectedHotspot&&e){const o=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0],a=this.viewer.viewport.viewportToImageCoordinates(e),l={x:a.x,y:a.y};if(this.isPointInPolygon(l,o))r=1;else{const u=this.calculateDistanceToPolygon(l,o),h=this.getHotspotBounds(this.state.selectedHotspot),d=(h.width+h.height)/2,f=u/d,m=.1,v=.3;f<=m?r=1:f>=v?r=0:r=1-(f-m)/(v-m)}}return r<.1?r:Math.min(n,r)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const l=e[o][0],u=e[o][1],h=e[a][0],d=e[a][1];u>n!=d>n&&i<(h-l)*(n-u)/(d-u)+l&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const l=e.x+a*n,u=e.y+a*r;return Math.sqrt(Math.pow(t.x-l,2)+Math.pow(t.y-u,2))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){if(!this.overlayElement)return;this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([l,u])=>{e=Math.min(e,l),i=Math.min(i,u),n=Math.max(n,l),r=Math.max(r,u)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t);this.calculateZunicRosinConvexity(t);const i=this.calculateDiscreteRoughness(t);let n=0;return i.maxCurvature>10&&(n=Math.max(n,.5)),(e.aspectRatio>3||e.aspectRatio<.33)&&(n=Math.max(n,.4)),1+n*.1}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const l=o-n,u=a-r;return[n+l*e,r+u*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}resetAnimationState(){console.log(" CSSOverlayManager: Animation state reset (no-op)")}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class qa{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isWebKit="WebkitAppearance"in document.documentElement.style&&!window.chrome,this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.isSafariOrWebKit=this.isSafari||this.isWebKit,this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.85,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.25,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.zoomConfig={fadeStartZoom:2,fadeEndZoom:4,minCoverageRatio:1,enableZoomFade:!1},this.useEllipse=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0},this.tuningParams={circleMultiplier:.22,ellipseMultiplierX:1.2,ellipseMultiplierY:1.15,gradientMultiplier:1.5,pixelRadiusMultiplier:1,adaptivePaddingMultiplier:1.3,offsetX:0,offsetY:0},window.safariTuning=this.tuningParams,this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.zoomUpdateTimeout=null,this.lastUpdateTime=0,this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.lastPositionUpdate=0,this.positionUpdateThrottle=16,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=100,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[l,u]=i,h=n*(a-u)-r*(o-l)+o*u-l*a;if(Math.abs(h)<1e-10)return this.minCircleTrivial([t,e]);const d=(n*n+r*r)*(u-a)+(o*o+a*a)*(r-u)+(l*l+u*u)*(a-r),f=(n*n+r*r)*(o-l)+(o*o+a*a)*(l-n)+(l*l+u*u)*(n-o),m=-d/(2*h),v=-f/(2*h),E=n-m,T=r-v,x=Math.sqrt(E*E+T*T);return{x:m,y:v,r:x}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonArea(t),r=i.width*i.height,o=n/r,a=this.calculateConvexHull(t),l=this.calculatePolygonArea(a),u=n/l;let h=1;return u<.6?h=1.4:o<.7?h=1.3:h=1.2,this.isMobile&&(h*=.8),e*h*this.tuningParams.adaptivePaddingMultiplier}calculateEllipseFromPolygon(t){var u,h;const e=((u=this.state.selectedHotspot)==null?void 0:u.id)||`${t.length}_${JSON.stringify(t.slice(0,3))}`;if(this.ellipseCache.has(e)){const d=this.ellipseCache.get(e);return this.useEllipse=d.useEllipse,d.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=i.width/i.height,r=(Math.max(i.width,i.height)-Math.min(i.width,i.height))/(i.width+i.height);let o=!1;if(n<=1.5&&r<=.3?o=!1:n>2||r>.5?o=!0:o=Math.abs(i.width-i.height)/Math.max(i.width,i.height)>.3,console.log("Shape decision:",{hotspotId:(h=this.state.selectedHotspot)==null?void 0:h.id,aspectRatio:n.toFixed(2),elongationIndex:r.toFixed(2),useEllipse:o}),!o)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const a=1.2,l={radiusX:i.width/2*a*this.tuningParams.ellipseMultiplierX,radiusY:i.height/2*a*this.tuningParams.ellipseMultiplierY,rotation:0,aspectRatio:n,centerX:i.centerX,centerY:i.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:l}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.ellipseCache.clear()},5e3),l}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],l=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const u=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);l*u<0&&e++}}return Math.min(e/(i*.5),1)}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),l=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-l}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],l=i[r];if((a[0]-o[0])*(l[1]-o[1])-(a[1]-o[1])*(l[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height,o=this.calculateElongationIndex(n);return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,elongationIndex:o,vertexDensity:t.length/i}}calculateElongationIndex(t){const e=Math.max(t.width,t.height),i=Math.min(t.width,t.height);return(e-i)/(e+i)}calculateZoomAwareOpacity(t){if(!this.viewer||!this.zoomConfig.enableZoomFade)return t;const e=this.viewer.viewport.getZoom();if(e<=this.zoomConfig.fadeStartZoom)return t;if(e>=this.zoomConfig.fadeEndZoom)return 0;const i=this.zoomConfig.fadeEndZoom-this.zoomConfig.fadeStartZoom,n=(e-this.zoomConfig.fadeStartZoom)/i,r=1-Math.pow(1-n,2);return t*(1-r)}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement)),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}applyInitialStyles(){const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"block",visibility:"hidden","-webkit-mask-image":this.createGradientMask(50,50,0,0),"mask-image":this.createGradientMask(50,50,0,0),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const d=o.radiusX*n*this.tuningParams.ellipseMultiplierX,f=o.radiusY*n*this.tuningParams.ellipseMultiplierY,v=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(E=>{const T=d*E.position,x=f*E.position,O=(T+x)/2;return`rgba(0,0,0,${E.opacity}) ${O*this.tuningParams.gradientMultiplier}px`}).join(", ");return`radial-gradient(ellipse ${d*this.tuningParams.gradientMultiplier}px ${f*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%, 
        rgba(0,0,0,0) 0px,
        ${v})`}const l=i*n*this.tuningParams.circleMultiplier,h=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(d=>{const f=l+l*this.tuningParams.gradientMultiplier*.8*d.position;return`rgba(0,0,0,${d.opacity}) ${f}px`}).join(", ");return`radial-gradient(circle ${l*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%,
    rgba(0,0,0,0) 0px,
    rgba(0,0,0,0) ${l}px,
    ${h})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&(this.cachedViewportRect=null,this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.zoomUpdateTimeout=setTimeout(()=>{this.checkAutoDeselect()},100))}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&!this.animationFrame&&this.startAnimation()}),this.resizeHandler=()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()},window.addEventListener("resize",this.resizeHandler)}selectHotspot(t){var e,i;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(e=this.state.selectedHotspot)==null?void 0:e.id}),((i=this.state.selectedHotspot)==null?void 0:i.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.overlayElement&&(this.overlayElement.style.display="block",this.overlayElement.style.visibility="visible"),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,setTimeout(()=>{this.trackFocusReference()},800),console.log("Starting animation..."),this.startAnimation()):(console.log("Deselecting hotspot"),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation())}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;if(this.isUpdatingPosition){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,requestAnimationFrame(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()}));return}const t=performance.now();if(t-this.lastPositionUpdate<this.positionUpdateThrottle){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,setTimeout(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()},this.positionUpdateThrottle-(t-this.lastPositionUpdate)));return}this.isUpdatingPosition=!0,this.lastPositionUpdate=t;try{const e=this.state.selectedHotspot,i=this.getPerformanceMode();let n="full",r;if(i==="reduced"){const T=e.shape==="polygon"?e.coordinates:e.coordinates[0],x=this.simplifyPolygon(T,.5),O={...e,coordinates:e.shape==="polygon"?x:[x]};r=this.calculateSpotlightGeometry(O),n="simplified"}else r=this.calculateSpotlightGeometry(e);(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t);const o=this.cachedViewportRect,a=this.viewer.viewport.imageToViewportCoordinates(new Qt.Point(r.center.x,r.center.y)),l=this.viewer.viewport.viewportToWindowCoordinates(a);console.log("Coordinate conversion debug:",{imageCenter:r.center,viewportPoint:{x:a.x,y:a.y},windowPoint:{x:l.x,y:l.y},viewerSize:{width:this.viewer.container.clientWidth,height:this.viewer.container.clientHeight}});const u=l.x/o.width*100+this.tuningParams.offsetX,h=l.y/o.height*100+this.tuningParams.offsetY;this.state.targetPosition={x:u,y:h};const d=this.viewer.world.getItemAt(0).getContentSize(),f=r.radius/d.x,m=this.viewer.viewport.getZoom(),v=f*o.width*m,E=this.getHotspotBounds(e);if(E){const T=E.width/d.x*o.width*m,x=E.height/d.y*o.height*m,V=Math.max(T,x)/2*this.zoomConfig.minCoverageRatio;this.state.targetRadius=Math.max(V,v*this.tuningParams.pixelRadiusMultiplier)}else this.state.targetRadius=Math.max(80,Math.min(400,v*this.tuningParams.pixelRadiusMultiplier));if(console.log("Zoom-aware radius:",{currentZoom:m.toFixed(2),targetRadius:this.state.targetRadius.toFixed(0),willFade:m>this.zoomConfig.fadeStartZoom}),r.ellipseData){const T=r.ellipseData.radiusX/d.x*o.width*m,x=r.ellipseData.radiusY/d.y*o.height*m;this.useEllipse||(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:r.ellipseData.rotation}),this.ellipseData.targetRadiusX=T,this.ellipseData.targetRadiusY=x,this.ellipseData.rotation=r.ellipseData.rotation,this.useEllipse=!0}else this.useEllipse&&(this.ellipseData.targetRadiusX=this.state.targetRadius,this.ellipseData.targetRadiusY=this.state.targetRadius),this.useEllipse=!1;console.log("Spotlight position debug:",{hotspotId:e.id,hotspotCenter:r.center,windowPoint:l,viewportRect:{width:o.width,height:o.height},percentages:{x:u,y:h},radius:{geometric:r.radius,inViewport:f,inPixels:v,final:this.state.targetRadius},currentState:{x:this.state.currentPosition.x,y:this.state.currentPosition.y,radius:this.state.currentRadius},ellipseData:this.ellipseData,useEllipse:this.useEllipse,geometryQuality:n}),this.aspectRatio=r.aspectRatio,this.state.isAnimating?this.animationFrame||this.startAnimation():(this.state.currentPosition={...this.state.targetPosition},this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0&&(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY),this.applySpotlightStyles())}finally{this.isUpdatingPosition=!1}}invalidateViewportCache(){this.cachedViewportRect=null,this.viewportRectCacheTime=0}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateEllipseFromPolygon(e);if(n&&this.useEllipse)return{center:{x:n.centerX,y:n.centerY},radius:Math.max(n.radiusX,n.radiusY),aspectRatio:n.aspectRatio,bounds:i,ellipseData:n,useEllipse:!0};{const r=this.calculateMinimumEnclosingCircle(e);r.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),r.r=Math.max(i.width,i.height)/2);const o=this.calculateAdaptivePadding(e,r.r);return{center:{x:r.x,y:r.y},radius:r.r+o,aspectRatio:i.width/i.height,bounds:i,ellipseData:null,useEllipse:!1}}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let u=0,h=o-1;u<o;h=u++){const d=e[u][0],f=e[u][1],m=e[h][0],v=e[h][1],E=d*v-m*f;i+=E,n+=(d+m)*E,r+=(f+v)*E}i*=.5;const a=n/(6*i),l=r/(6*i);if(!isFinite(a)||!isFinite(l)){let u=0,h=0;return e.forEach(([d,f])=>{u+=d,h+=f}),{x:u/e.length,y:h/e.length}}return{x:a,y:l}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}if(!this.viewer||!this.viewer.viewport){console.warn("SafariOverlayManager: viewer or viewport is null in trackFocusReference");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||this.isUpdatingPosition)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<2e3)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking||!this.focusTracking.referenceZoom||!this.viewer||!this.viewer.viewport)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new Qt.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y));if(this.useEllipse&&this.ellipseData){const a=this.viewer.world.getItemAt(0).getContentSize();this.viewer.container.getBoundingClientRect(),this.viewer.viewport.getZoom();const l=this.ellipseData.radiusX/a.x,u=this.ellipseData.radiusY/a.y,h=this.calculateEllipseDistance(o.x,o.y,e.x,e.y,l,u,this.ellipseData.rotation),d=.5,f=.2;h<=d?r=1:h>=d+f?r=0:r=1-(h-d)/f}else{const a=e.x-o.x,l=e.y-o.y,u=Math.sqrt(a*a+l*l),h=.01,d=.02;u<=h?r=1:u>=h+d?r=0:r=1-(u-h)/d}}return r<.1?r:i>=.8&&r>.9?1:Math.min(n,r)}calculateEllipseDistance(t,e,i,n,r,o,a){const l=a*Math.PI/180,u=Math.cos(l),h=Math.sin(l),d=i-t,f=n-e,m=d*u+f*h,v=-d*h+f*u;return Math.sqrt(m*m/(r*r)+v*v/(o*o))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,this.overlayElement&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block"),this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity*this.config.maxOpacity,i=this.calculateZoomAwareOpacity(e),n=i-this.state.opacity,r=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(n)>.001?(this.state.opacity+=n*r,this.state.opacity=Math.max(0,Math.min(this.config.maxOpacity,this.state.opacity))):this.state.opacity=i;const o=this.state.targetScale-this.state.scale;Math.abs(o)>.01?this.state.scale+=o*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const a=this.state.targetPosition.x-this.state.currentPosition.x,l=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(a)>.1||Math.abs(l)>.1?(this.state.currentPosition.x+=a*this.config.positionSpeed,this.state.currentPosition.y+=l*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const u=this.state.targetRadius-this.state.currentRadius;if(Math.abs(u)>1?this.state.currentRadius+=u*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const d=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,f=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(d)>1||Math.abs(f)>1?(this.ellipseData.radiusX+=d*this.config.radiusSpeed,this.ellipseData.radiusY+=f*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(n)<=.001&&Math.abs(a)<=.1&&Math.abs(l)<=.1&&Math.abs(u)<=1&&Math.abs(o)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement&&(this.overlayElement.style.display="none")):this.overlayElement?this.animationFrame=requestAnimationFrame(this.animate):(this.state.isAnimating=!1,console.warn("SafariOverlayManager: Stopping animation - no overlay element"))}applySpotlightStyles(){if(!this.overlayElement){console.warn("SafariOverlayManager: overlayElement is null in applySpotlightStyles");return}this.state.opacity>0&&(this.overlayElement.style.visibility="visible"),this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none"),e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none",this.overlayElement.style.visibility="hidden")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([l,u])=>{e=Math.min(e,l),i=Math.min(i,u),n=Math.max(n,l),r=Math.max(r,u)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}resetAnimationState(){console.log(" SafariOverlayManager: Resetting animation state"),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.overlayElement&&this.state.selectedHotspot&&(this.updateSpotlightPosition(),!this.state.isAnimating&&this.state.targetOpacity>0&&this.startAnimation())}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}forceRecalculation(){this.state.selectedHotspot&&(this.ellipseCache.clear(),this.updateSpotlightPosition(),!this.state.isAnimating&&this.applySpotlightStyles())}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.cachedViewportRect=null,this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const l=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=l,t.style.webkitMaskImage=l,o++,requestAnimationFrame(a)}else{const l=performance.now()-r,u=o/l*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${u.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){if(!(!this.state.selectedHotspot||!this.useEllipse)&&window.performanceMonitor){const t=window.performanceMonitor.getMetrics();t.averageFPS<45&&this.useEllipse&&(console.warn("Disabling ellipses due to low FPS:",t.averageFPS),this.useEllipse=!1,this.config.useEllipse=!1,setTimeout(()=>{this.config.useEllipse=!0},1e4))}}}class Pi{static create(t){const e=this.detectBrowser();return console.log("Browser detection:",{isSafari:e.isSafari,isIOS:e.isIOS,isWebKit:e.isWebKit,userAgent:navigator.userAgent}),e.isSafari||e.isIOS||e.isWebKit?(console.log("Using SafariOverlayManager for WebKit-based browser"),new qa(t)):(console.log("Using CSSOverlayManager (default)"),new Ga(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r=n&&!i&&/Mac/.test(e),o="WebkitAppearance"in document.documentElement.style&&!window.chrome,a=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:o,isIOSChrome:a,isMacOSSafari:r,isWebKitBased:n||i||a}}static setPreference(t){return t==="css"||t==="safari"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css' or 'safari'.`),!1)}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t){const e=this.getCurrentType();return e==="safari"?(console.log("Creating SafariOverlayManager (forced)"),new qa(t)):e==="css"?(console.log("Creating CSSOverlayManager (forced)"),new Ga(t)):this.create(t)}}function $h(){var Ge,At,Mt,Zt,Xt,Nt,pn;const[s,t]=oe(!0),[e,i]=oe(!1),[n,r]=oe(!1);console.log("[useViewerState] Initializing state:",{isLoading:s(),viewerReady:e(),previewLoaded:n()});const[o,a]=oe(null),[l,u]=oe(null),[h,d]=oe(null),[f,m]=oe(null),[v,E]=oe(!1),[T,x]=oe(!1),[O,V]=oe(!1),[G,Y]=oe(!1),[J,A]=oe({x:0,y:0}),[S,R]=oe(!1),[M,k]=oe(!1),[F,D]=oe({}),[xe,Pe]=oe(null),[te,se]=oe(parseInt(localStorage.getItem("debugLevel")??"1")),[W,ne]=oe(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[U,fe]=oe(((Ge=window.safariTuning)==null?void 0:Ge.circleMultiplier)||($e()?.8:1.2)),[re,K]=oe(((At=window.safariTuning)==null?void 0:At.ellipseMultiplierX)||($e()?.8:1.15)),[be,ge]=oe(((Mt=window.safariTuning)==null?void 0:Mt.ellipseMultiplierY)||($e()?.8:1.15)),[ye,Ce]=oe(((Zt=window.safariTuning)==null?void 0:Zt.gradientMultiplier)||($e()?1:1.5)),[He,pt]=oe(((Xt=window.safariTuning)==null?void 0:Xt.offsetX)||0),[nt,Ke]=oe(((Nt=window.safariTuning)==null?void 0:Nt.offsetY)||0),[We,Et]=oe(!1),[gt,Re]=oe({x:0,y:0}),[at,g]=oe(!1),[b,N]=oe({x:0,y:0}),[j,$]=oe(0),[ae,Z]=oe(null),[me,Ie]=oe(localStorage.getItem("interactionMode")||($e()?"temporal":"direct")),[_e,ce]=oe(localStorage.getItem("revealStyle")||"invert"),[Ne,_]=oe({}),[w,C]=oe(null),[I,H]=oe(((pn=window.nativeHotspotRenderer)==null?void 0:pn.currentPalette)||"tech"),[Q,de]=oe(Pi.getCurrentType()||(Pi.detectBrowser().isWebKitBased?"safari":"css"));return{isLoading:s,setIsLoading:xt=>{console.log(`[useViewerState] setIsLoading called with: ${xt}`),t(xt)},viewerReady:e,setViewerReady:xt=>{console.log(`[useViewerState] setViewerReady called with: ${xt}`),i(xt)},previewLoaded:n,setPreviewLoaded:r,hoveredHotspot:o,setHoveredHotspot:a,selectedHotspot:l,setSelectedHotspot:u,currentPlayingHotspot:h,setCurrentPlayingHotspot:d,currentMediaHotspot:f,setCurrentMediaHotspot:m,showExpandButton:v,setShowExpandButton:E,expandButtonFading:T,setExpandButtonFading:x,isFullscreen:O,setIsFullscreen:V,showMediaButton:G,setShowMediaButton:Y,mediaButtonPosition:J,setMediaButtonPosition:A,isZoomingToHotspot:S,setIsZoomingToHotspot:R,isExpandingToFullView:M,setIsExpandingToFullView:k,components:F,setComponents:D,modeStateManager:xe,setModeStateManager:Pe,debugLevel:te,setDebugLevel:se,zoomSpeedMultiplier:W,setZoomSpeedMultiplier:ne,circleMultiplierValue:U,setCircleMultiplierValue:fe,ellipseXValue:re,setEllipseXValue:K,ellipseYValue:be,setEllipseYValue:ge,gradientSpreadValue:ye,setGradientSpreadValue:Ce,offsetXValue:He,setOffsetXValue:pt,offsetYValue:nt,setOffsetYValue:Ke,showFloatingPanel:We,setShowFloatingPanel:Et,panelPosition:gt,setPanelPosition:Re,isDragging:at,setIsDragging:g,dragStart:b,setDragStart:N,tapCount:j,setTapCount:$,tapTimeout:ae,setTapTimeout:Z,interactionMode:me,setInteractionMode:Ie,revealStyle:_e,setRevealStyle:ce,updateRevealStyle:xt=>{ce(xt),localStorage.setItem("revealStyle",xt),window.updateRevealStyle&&window.updateRevealStyle(xt)},performanceMetrics:Ne,setPerformanceMetrics:_,safariHybridMetrics:w,setSafariHybridMetrics:C,currentPalette:I,setCurrentPalette:H,currentOverlayType:Q,setCurrentOverlayType:de}}const ed=(s,t,e)=>{let i;if(s.coordinates){let x=1/0,O=1/0,V=-1/0,G=-1/0;(J=>{Array.isArray(J[0])&&typeof J[0][0]=="number"?J.forEach(([A,S])=>{x=Math.min(x,A),O=Math.min(O,S),V=Math.max(V,A),G=Math.max(G,S)}):J.forEach(A=>{A.forEach(([S,R])=>{x=Math.min(x,S),O=Math.min(O,R),V=Math.max(V,S),G=Math.max(G,R)})})})(s.coordinates),i={minX:x,minY:O,maxX:V,maxY:G}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new Qt.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new Qt.Point(i.maxX,i.maxY)),a=o.x-r.x,l=o.y-r.y,u=r.x+a/2,h=r.y+l/2,d=t.viewport.getAspectRatio(),f=a/l,m=e?.85:.8;let v,E;f>d?(v=a/m,E=v/d):(E=l/m,v=E*d);const T=new Qt.Rect(u-v/2,h-E/2,v,E);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:u,y:h},dimensions:{width:v,height:E},aspectRatios:{hotspot:f.toFixed(2),viewport:d.toFixed(2)},paddingFactor:m,zoomBounds:T}),T};let qi=new Map,Zi=null,Dn=null,Xi=!1,Ki=null,Yi=null;function q_(s){if(console.log("=== APPLYING ENHANCED TILE CASCADE FIX ==="),!s){console.error("OpenSeadragon not provided - cannot apply tile cascade fix");return}if(Ki=s.TiledImage.prototype._getLevelsInterval,Yi=s.TiledImage.prototype._updateLevels,!Ki){console.error("_getLevelsInterval method not found - cannot apply fix");return}s.TiledImage.prototype._getLevelsInterval=function(){const t=this.viewer.viewport.getZoom();if(Xi)return Ki.call(this);if(Zi!==null&&Math.abs(t-Zi)<.01&&qi.has(this))return qi.get(this);const e=Ki.call(this);if(!e||typeof e.lowestLevel>"u")return e;let i=e;if(t<3){const n=/Android|iPhone|iPad/i.test(navigator.userAgent),r=Math.floor(Math.log2(t*1024/256)),o=Math.max(8,Math.min(12,r+11)),a=Xi?4:2;i={lowestLevel:Math.max(8,o-Math.floor(a/2)),highestLevel:Math.min(14,o+Math.floor(a/2))},i.highestLevel-i.lowestLevel>a-1&&(i.lowestLevel=i.highestLevel-(a-1))}return qi.set(this,i),Zi=t,Dn&&clearTimeout(Dn),Dn=setTimeout(()=>{qi.clear(),Zi=null},100),i},Yi&&(s.TiledImage.prototype._updateLevels=function(){if(this.viewer.isAnimating()||Xi)return Yi.call(this);const t=Yi.call(this);if(this.viewer.viewport.getZoom()<3&&this._tilesToDraw&&!Xi){const i=this._getLevelsInterval();this._tilesToDraw=this._tilesToDraw.filter(n=>n.level>=i.lowestLevel&&n.level<=i.highestLevel)}return t}),console.log("=== ENHANCED TILE CASCADE FIX APPLIED ===")}function zi(s){Xi=s,s&&(qi.clear(),Zi=null),console.log(`TileCascadeFix: Cinematic mode ${s?"ENABLED":"DISABLED"}`)}function Z_(s){qi.clear(),Zi=null,Xi=!1,Dn&&clearTimeout(Dn),s&&Ki&&(s.TiledImage.prototype._getLevelsInterval=Ki),s&&Yi&&(s.TiledImage.prototype._updateLevels=Yi),console.log("=== TILE CASCADE FIX REMOVED ===")}function td(s,t,e){const{isZoomingToHotspot:i,setIsZoomingToHotspot:n,isExpandingToFullView:r,setIsExpandingToFullView:o,setShowExpandButton:a,zoomSpeedMultiplier:l}=t;return{isHotspotWellFramed:(m,v)=>{if(!s||!v)return!1;const E=s.viewport.getBounds();s.viewport.getZoom();const T=s.viewport.imageToViewportRectangle(v.x,v.y,v.width,v.height),x=E.intersection(T);if(!x)return!1;const O=T.width*T.height,G=x.width*x.height/O,Y=T.getCenter(),J=E.getCenter(),A=Math.sqrt(Math.pow(Y.x-J.x,2)+Math.pow(Y.y-J.y,2)),S=G>.8&&A<.1;return console.log("Well-framed check:",{overlapRatio:G,centerDistance:A,isWellFramed:S}),S},zoomToHotspot:async m=>{if(console.log(" Starting stabilized cinematic zoom",{hotspotId:m.id,isZoomingToHotspot:i()}),!s||i()||r())return;const v=ed(m,s,$e());if(!v)return;n(!0);const E=e().cinematicZoomManager;if(!E){console.error("CinematicZoomManager not initialized"),n(!1);return}zi(!0);const T={useSpringPhysics:!0,onComplete:()=>{console.log(" Cinematic zoom completed"),n(!1),a(!0),zi(!1),s.forceRedraw(),e().renderer&&($e()&&e().renderer.showOverlay(),setTimeout(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibility()},100))}};try{e().renderer&&(e().renderer.pauseUpdates(),$e()&&e().renderer.hideOverlay()),e().overlayManager&&e().overlayManager.startZoomAnimation&&e().overlayManager.startZoomAnimation(),await E.performCinematicZoom(v,T)}catch(x){console.error("Cinematic zoom failed:",x),n(!1),zi(!1)}},cleanupExpandAnimation:()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(m=>clearTimeout(m)),window.expandToFullViewTimeouts=[])},expandToFullView:async()=>{if(console.log("expandToFullView with stabilized zoom"),!s||r())return;i()&&n(!1),a(!1),o(!0);const m=s.world.getItemAt(0);if(!m){o(!1);return}const v=m.getBounds(),E=e().cinematicZoomManager;if(!E){console.error("CinematicZoomManager not initialized"),o(!1);return}zi(!0);const T={animationTime:$e()?.7:.9,springStiffness:$e()?9:7,onComplete:()=>{console.log(" Full view expansion completed"),o(!1),zi(!1),s.forceRedraw(),e().renderer&&($e()&&e().renderer.showOverlay(),setTimeout(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibility()},100))}};try{e().renderer&&(e().renderer.pauseUpdates(),$e()&&e().renderer.hideOverlay()),await E.performCinematicZoom(v,T)}catch(x){console.error("Full view expansion failed:",x),o(!1),zi(!1)}}}}var id=L('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),nd=L('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),rd=L('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),sd=L('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),od=L('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),ad=L('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),ld=L('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),ud=L("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),cd=L('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+)">'),hd=L('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+)">'),dd=L("<input type=range class=volume-slider min=0 max=100>"),fd=L("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+: Skip</span><span>M: Mute</span><span>Esc: Minimize"),pd=L('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),gd=L("<div>");const Za=()=>id(),Xa=()=>nd(),md=()=>rd(),vd=()=>sd(),yd=()=>od(),wd=()=>ad(),_d=()=>ld();function Td(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=oe(!0),[r,o]=oe(!1),[a,l]=oe(0),[u,h]=oe(0),[d,f]=oe(0),[m,v]=oe(80),[E,T]=oe(!1),[x,O]=oe(!1),[V,G]=oe(!0),[Y,J]=oe(!1);Gi(()=>{e()&&r()&&i()&&(J(!0),setTimeout(()=>J(!1),500))});const A=()=>window.innerWidth<=768;Gi(()=>{t&&(t.onProgress=W=>{x()||(l(W.percent),h(W.current),f(W.duration))},t.onPlaybackStart=()=>{o(!0),i()&&V()?(n(!1),G(!1)):i()||G(!1)},t.onPlaybackEnd=()=>{o(!1),l(0),h(0)},t.setVolume(m()/100))}),Gi(()=>{const W=ne=>{if(e()&&ne.target.tagName!=="INPUT")switch(ne.key){case" ":i()||(ne.preventDefault(),S());break;case"ArrowLeft":ne.shiftKey&&!i()&&(ne.preventDefault(),M());break;case"ArrowRight":ne.shiftKey&&!i()&&(ne.preventDefault(),R());break;case"m":case"M":i()||k();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",W),Ln(()=>window.removeEventListener("keydown",W))}),Gi(()=>{if(t){const W=t.getState();o(W.isPlaying),T(W.isMuted)}});const S=()=>{!t||!e()||(r()?t.pause():t.resume())},R=()=>{t&&t.skip(15)},M=()=>{t&&t.skip(-15)},k=()=>{if(!t)return;const W=t.toggleMute();T(W)},F=W=>{if(!t)return;const ne=W.currentTarget.getBoundingClientRect(),U=(W.clientX-ne.left)/ne.width*100;t.seekToPercent(U),l(U)},D=W=>{if(!x())return;const ne=W.currentTarget.getBoundingClientRect(),U=Math.max(0,Math.min(100,(W.clientX-ne.left)/ne.width*100));l(U)},xe=()=>{x()&&t&&(t.seekToPercent(a()),O(!1))},Pe=W=>{const ne=parseInt(W.target.value);v(ne),t&&(t.setVolume(ne/100),ne>0&&E()&&(t.toggleMute(),T(!1)))},te=W=>{if(!W||isNaN(W))return"0:00";const ne=Math.floor(W/60),U=Math.floor(W%60);return`${ne}:${U.toString().padStart(2,"0")}`},se=()=>{const W=e();return W?W.narrationTitle||`Hotspot ${W.id}`:""};return he(Ve,{get when(){return e()},get children(){var W=gd();return W.addEventListener("mouseleave",xe),W.$$mouseup=xe,ee(W,he(Ve,{get when(){return i()},get children(){var ne=ud(),U=ne.firstChild,fe=U.nextSibling,re=fe.firstChild;return U.$$click=()=>{r()?S():n(!1)},ee(U,(()=>{var K=Ct(()=>!!r());return()=>K()?he(Xa,{}):he(Za,{})})()),ee(re,se),Oe(K=>{var be=`btn-play-mini ${r()?"playing":""} ${Y()?"changing":""}`,ge=r()?"Pause":"Play";return be!==K.e&&qe(U,K.e=be),ge!==K.t&&Ot(U,"title",K.t=ge),K},{e:void 0,t:void 0}),ne}}),null),ee(W,he(Ve,{get when(){return!i()},get children(){var ne=pd(),U=ne.firstChild,fe=U.firstChild,re=fe.nextSibling,K=U.nextSibling,be=K.firstChild,ge=be.nextSibling,ye=ge.firstChild,Ce=ye.firstChild,He=Ce.nextSibling,pt=ge.nextSibling,nt=K.nextSibling,Ke=nt.firstChild,We=Ke.firstChild,Et=Ke.nextSibling,gt=Et.firstChild;return ee(fe,se),re.$$click=()=>n(!0),ee(re,he(_d,{})),ee(be,()=>te(u())),ge.$$mousemove=D,ge.$$mousedown=()=>O(!0),ge.$$click=F,ee(pt,()=>te(d())),ee(Ke,he(Ve,{get when(){return!A()},get children(){var Re=cd();return Re.$$click=M,ee(Re,he(md,{})),Re}}),We),We.$$click=S,ee(We,he(Ve,{get when(){return!r()},get children(){return he(Za,{})}}),null),ee(We,he(Ve,{get when(){return r()},get children(){return he(Xa,{})}}),null),ee(Ke,he(Ve,{get when(){return!A()},get children(){var Re=hd();return Re.$$click=R,ee(Re,he(vd,{})),Re}}),null),gt.$$click=k,ee(gt,he(Ve,{get when(){return Ct(()=>!E())()&&m()>0},get children(){return he(yd,{})}}),null),ee(gt,he(Ve,{get when(){return E()||m()===0},get children(){return he(wd,{})}}),null),ee(Et,he(Ve,{get when(){return!A()},get children(){var Re=dd();return Re.$$input=Pe,Oe(()=>Ot(Re,"title",`Volume: ${m()}%`)),Oe(()=>Re.value=m()),Re}}),null),ee(ne,he(Ve,{when:!1,get children(){return fd()}}),null),Oe(Re=>{var at=`${a()}%`,g=`${a()}%`,b=`btn-play ${r()?"playing":""}`,N=r()?"Pause (Space)":"Play (Space)",j=E()?"Unmute (M)":"Mute (M)";return at!==Re.e&&((Re.e=at)!=null?Ce.style.setProperty("width",at):Ce.style.removeProperty("width")),g!==Re.t&&((Re.t=g)!=null?He.style.setProperty("left",g):He.style.removeProperty("left")),b!==Re.a&&qe(We,Re.a=b),N!==Re.o&&Ot(We,"title",Re.o=N),j!==Re.i&&Ot(gt,"title",Re.i=j),Re},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ne}}),null),Oe(()=>qe(W,`audio-player ${i()?"minimized":""} ${A()?"mobile":"desktop"}`)),W}})}wi(["mouseup","click","mousedown","mousemove","input"]);var Ed=L('<div><button><svg class=media-button-icon width=16 height=16 viewBox="0 0 16 16"fill=none><path d="M2 4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4Z"stroke=currentColor stroke-width=1.5></path><circle cx=8 cy=8 r=2.5 stroke=currentColor stroke-width=1.5></circle><path d="M2 11L5 8L7 10L10 7L14 11"stroke=currentColor stroke-width=1.5 stroke-linecap=round stroke-linejoin=round></path></svg><span class=media-button-text>');function bd(s){const{hotspotId:t,onClick:e,isVisible:i=!0,position:n={x:0,y:0},isMobile:r=!1}=s,[o,a]=oe(!1),[l,u]=oe(!1),h=()=>"View Image",d=f=>{f.stopPropagation(),u(!0),e&&e(t),setTimeout(()=>u(!1),300)};return he(Ve,{when:i,get children(){var f=Ed(),m=f.firstChild,v=m.firstChild,E=v.nextSibling;return qe(f,`media-button-container ${r?"mobile":"desktop"}`),m.addEventListener("mouseleave",()=>a(!1)),m.addEventListener("mouseenter",()=>a(!0)),m.$$click=d,ee(E,h),Oe(T=>{var x=`media-button ${o()?"hovered":""} ${l()?"clicked":""}`,O=h();return x!==T.e&&qe(m,T.e=x),O!==T.t&&Ot(m,"title",T.t=O),T},{e:void 0,t:void 0}),f}})}wi(["click"]);function Hs(s,t){if(navigator.vibrate&&navigator.vibrate(50),t&&s){const e=document.createElement("span");e.className="ripple";const i=t.getBoundingClientRect(),n=Math.max(i.width,i.height),r=s.touches?s.touches[0].clientX:s.clientX,o=s.touches?s.touches[0].clientY:s.clientY,a=r-i.left-n/2,l=o-i.top-n/2;e.style.width=e.style.height=n+"px",e.style.left=a+"px",e.style.top=l+"px",t.appendChild(e),setTimeout(()=>e.remove(),600)}t&&(t.classList.add("tapped"),setTimeout(()=>t.classList.remove("tapped"),200))}const Qi={consciousness:{variations:{consciousnessOrganic:"cubic-bezier(0.25, 0.40, 0.40, 0.90)"}},organic:{original:"cubic-bezier(0.15, 0.40, 0.32, 0.88)",variations:{organicMeditative:"cubic-bezier(0.18, 0.35, 0.35, 0.90)",organicDynamic:"cubic-bezier(0.22, 0.25, 0.38, 0.85)"}}};function xd(s){const t=Qi[s];return t?{original:t.original,...t.variations}:null}function Eu(){const s={};return s.consciousnessOrganic=Qi.consciousness.variations.consciousnessOrganic,s.organic=Qi.organic.original,s.organicMeditative=Qi.organic.variations.organicMeditative,s.organicDynamic=Qi.organic.variations.organicDynamic,s}const X_=Object.freeze(Object.defineProperty({__proto__:null,EASING_VARIATIONS:Qi,getAllEasingOptions:Eu,getVariationsForCurve:xd},Symbol.toStringTag,{value:"Module"}));wi(["click"]);var Sd=L(`<div class=easing-compact-panel><style>
                .easing-compact-panel {
                    padding: 12px;
                }
                .panel-description {
                    font-size: 11px;
                    color: #888;
                    margin-bottom: 12px;
                    line-height: 1.4;
                }
                .curve-options {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                    margin-bottom: 12px;
                }
                .curve-btn {
                    padding: 12px 8px;
                    background: #1a1a1a;
                    border: 2px solid #333;
                    border-radius: 6px;
                    cursor: pointer;
                    text-align: center;
                    transition: all 0.2s;
                    position: relative;
                }
                .curve-btn:hover {
                    background: #222;
                    border-color: #555;
                    transform: translateY(-1px);
                }
                .curve-btn.active {
                    background: #0066cc;
                    border-color: #0099ff;
                    color: white;
                }
                .curve-btn.active::after {
                    content: '';
                    position: absolute;
                    top: 4px;
                    right: 6px;
                    font-size: 12px;
                }
                .curve-name {
                    font-size: 13px;
                    font-weight: bold;
                    margin-bottom: 4px;
                }
                .curve-desc {
                    font-size: 10px;
                    color: #999;
                    line-height: 1.2;
                }
                .curve-btn.active .curve-desc {
                    color: #cce6ff;
                }
                .preview-hint {
                    font-size: 10px;
                    color: #666;
                    text-align: center;
                    margin-top: 8px;
                    font-style: italic;
                }
            </style><div class=panel-description>Choose the animation style for hotspot stroke drawing on hover:</div><div class=curve-options></div><div class=preview-hint>Hover over a hotspot to see the effect`),Pd=L("<div><div class=curve-name></div><div class=curve-desc>");const Cd=s=>{const[t,e]=oe("organicMeditative");Eu();const i=["organicMeditative","organicDynamic","organic","consciousnessOrganic"],n=o=>{e(o),window.hotspotEasing&&window.hotspotEasing.set(o),s.forceUpdate&&s.forceUpdate()},r=o=>({consciousnessOrganic:"Mystical",organicMeditative:"Meditative",organicDynamic:"Dynamic",organic:"Natural"})[o]||o;return(()=>{var o=Sd(),a=o.firstChild,l=a.nextSibling,u=l.nextSibling;return ee(u,he(Vr,{each:i,children:h=>{const d={organicMeditative:"Calm and contemplative stroke",organicDynamic:"Energetic and expressive stroke",organic:"Natural and fluid stroke",consciousnessOrganic:"Mysterious and evocative stroke"};return(()=>{var f=Pd(),m=f.firstChild,v=m.nextSibling;return f.$$click=()=>n(h),ee(m,()=>r(h)),ee(v,()=>d[h]),Oe(()=>qe(f,`curve-btn ${t()===h?"active":""}`)),f})()}})),o})()};wi(["click"]);var Rd=L("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>Hovered</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Selected</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Type</span><span class=debug-stat-value>"),Id=L('<div class=debug-stat-row style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);"><span class=debug-stat-label style=color:#00ffff;>Safari Hybrid</span><span class=debug-stat-value style=color:#00ffff;>Active'),Ad=L("<div class=debug-stat-row><span class=debug-stat-label>Render Time</span><span class=debug-stat-value>ms"),Dd=L("<div class=debug-stat-row><span class=debug-stat-label>Visible/Total</span><span class=debug-stat-value>/"),Md=L("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>FPS</span><span class=debug-stat-value><span style=opacity:0.7;font-size:10px> (avg: <!>)</span></span></div><div class=debug-stat-row><span class=debug-stat-label>Status</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Memory</span><span class=debug-stat-value>MB</span></div><div class=debug-stat-row><span class=debug-stat-label>Frame Time</span><span class=debug-stat-value>ms</span></div><div class=debug-stat-row><span class=debug-stat-label>Zoom</span><span class=debug-stat-value>x"),kd=L("<div class=debug-control><label class=debug-control-label>Animation Speed<span class=debug-control-value>x</span></label><input type=range class=debug-slider min=0.5 max=2.5 step=0.1><p class=debug-control-description>How fast the artwork zooms when you click on elements"),Fd=L('<div class=debug-control><label class=debug-control-label>Color Theme<span class=debug-help-icon title="Changes the highlight colors">?</span></label><div class=debug-toggle-group><button type=button>Cyan Tech</button><button type=button>Golden Magic</button><button type=button>Blue Moon</button></div><div class=debug-toggle-group style=margin-top:8px;><button type=button>Pure White</button><button type=button>Soft White</button><button type=button>Dark Mode'),Od=L("<div class=debug-control><label class=debug-control-label>Interaction Style</label><div class=debug-toggle-group><div>Instant Click</div><div>Hold & Release</div></div><p class=debug-control-description>"),Vd=L("<div class=debug-control><label class=debug-control-label>Highlight Style</label><div class=debug-toggle-group><div>Sharp Outline</div><div>Soft Glow</div></div><p class=debug-control-description>"),Ld=L("<div class=debug-control><label class=debug-control-label>Activation</label><p class=debug-control-description>Press <strong>H</strong> key (desktop) or <strong>triple-tap</strong> (mobile)"),Nd=L("<div class=debug-control><label class=debug-control-label>Visual Style</label><div class=debug-toggle-group><button type=button>Black Outline</button><button type=button>White Pulse"),Bd=L("<span class=debug-mobile-compact-fps> FPS"),zd=L('<div class="debug-mobile-compact glass-button"><div class=debug-mobile-compact-content><span class=debug-mobile-compact-icon><svg width=16 height=16 viewBox="0 0 20 20"fill=none><path d="M4 4v12M10 2v4M10 14v4M16 8v8M10 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16 5.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM10 14.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round></path></svg></span><span class=debug-mobile-compact-label>Debug'),Hd=L('<div><div><div class=debug-mobile-sheet-handle><div class=debug-mobile-sheet-handle-bar></div></div><div class=debug-mobile-sheet-header><h3 class=debug-mobile-sheet-title><svg width=18 height=18 viewBox="0 0 20 20"fill=none><path d="M4 4v12M10 2v4M10 14v4M16 8v8M10 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16 5.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM10 14.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round></path></svg>Artwork Controls</h3></div><div class=debug-mobile-tabs></div><div class=debug-mobile-content>'),Ud=L("<button><span class=debug-mobile-tab-icon></span><span class=debug-mobile-tab-label>"),jd=L("<span style=margin-left:8px;>Artwork Controls"),Wd=L('<button title="Minimize panel"><svg viewBox="0 0 20 20"><rect x=11 y=15 width=14 height=2>'),Gd=L(`<div><div class=debug-panel-header><h3 class=debug-panel-title style="margin:0;display:'flex';alignItems:'center';"><svg viewBox="0 0 20 20"fill=none><path d="M4 4v12M10 2v4M10 14v4M16 8v8M10 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16 5.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM10 14.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>`),qd=L("<div><div class=debug-section-header><div class=debug-section-title><span class=debug-section-icon></span><span></span></div><span class=debug-section-chevron></span></div><div class=debug-section-content><div class=debug-section-body>");function Zd(s){const[t,e]=oe(!0),[i,n]=oe({artwork:!1,performance:!1,visual:!1,navigation:!1,overlay:!1,reveal:!1,easing:!1}),[r,o]=oe({x:null,y:null}),[a,l]=oe(!1),[u,h]=oe({x:0,y:0,elementX:0,elementY:0}),[d,f]=oe(0),m=()=>f(te=>te+1),[v,E]=oe(!1),[T,x]=oe(0),[O,V]=oe(!1),G=()=>{V(!0),setTimeout(()=>{E(!1),V(!1)},300)};let Y,J=0,A=0;const S=te=>{J=te.touches[0].clientY,A=0},R=te=>{if(!v()||!Y)return;const W=te.touches[0].clientY-J;W>0&&(A=W,Y.style.transform=`translateY(${W}px)`)},M=()=>{Y&&(A>100&&G(),Y.style.transform="",A=0)},k=[{id:"artwork",icon:"",title:"Active Element",content:()=>(()=>{var te=Rd(),se=te.firstChild,W=se.firstChild,ne=W.nextSibling,U=se.nextSibling,fe=U.firstChild,re=fe.nextSibling,K=U.nextSibling,be=K.firstChild,ge=be.nextSibling;return ee(ne,()=>{var ye;return((ye=s.hoveredHotspot())==null?void 0:ye.id)||"none"}),ee(re,()=>{var ye;return((ye=s.selectedHotspot())==null?void 0:ye.id)||"none"}),ee(ge,()=>{var ye,Ce;return((ye=s.hoveredHotspot())==null?void 0:ye.type)||((Ce=s.selectedHotspot())==null?void 0:Ce.type)||"none"}),te})()},{id:"performance",icon:"",title:"Performance",content:()=>(()=>{var te=Md(),se=te.firstChild,W=se.firstChild,ne=W.nextSibling,U=ne.firstChild,fe=U.firstChild,re=fe.nextSibling;re.nextSibling;var K=se.nextSibling,be=K.firstChild,ge=be.nextSibling,ye=K.nextSibling,Ce=ye.firstChild,He=Ce.nextSibling,pt=He.firstChild,nt=ye.nextSibling,Ke=nt.firstChild,We=Ke.nextSibling,Et=We.firstChild,gt=nt.nextSibling,Re=gt.firstChild,at=Re.nextSibling,g=at.firstChild;return ee(ne,()=>{var b,N;return((N=(b=s.performanceMetrics)==null?void 0:b.currentFPS)==null?void 0:N.toFixed(0))||"60"},U),ee(U,()=>{var b;return((b=s.performanceMetrics)==null?void 0:b.averageFPS)||"60"},re),ee(ge,()=>{var b;return((b=s.performanceMetrics)==null?void 0:b.performanceLevel)||"excellent"}),ee(He,()=>{var b,N;return((N=(b=s.performanceMetrics)==null?void 0:b.memoryUsage)==null?void 0:N.toFixed(0))||"0"},pt),ee(We,()=>{var b;return((b=s.performanceMetrics)==null?void 0:b.frameTime)||"16.67"},Et),ee(at,()=>{var b;return((b=s.performanceMetrics)==null?void 0:b.zoomLevel)||"1.00"},g),ee(te,he(Ve,{get when(){return s.safariHybridMetrics},get children(){return[Id(),(()=>{var b=Ad(),N=b.firstChild,j=N.nextSibling,$=j.firstChild;return ee(j,()=>{var ae;return((ae=s.safariHybridMetrics.renderTime)==null?void 0:ae.toFixed(2))||"0.00"},$),Oe(ae=>(ae=s.safariHybridMetrics.renderTime>16.67?"#FF9800":"#4CAF50")!=null?j.style.setProperty("color",ae):j.style.removeProperty("color")),b})(),(()=>{var b=Dd(),N=b.firstChild,j=N.nextSibling,$=j.firstChild;return ee(j,()=>s.safariHybridMetrics.visibleHotspots||"0",$),ee(j,()=>s.safariHybridMetrics.hotspotCount||"0",null),b})()]}}),null),Oe(b=>{var Z,me,Ie,_e,ce;var N=(((Z=s.performanceMetrics)==null?void 0:Z.currentFPS)||60)<55?"#FF9800":"#4CAF50",j={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"}[((me=s.performanceMetrics)==null?void 0:me.performanceLevel)||"excellent"],$=(((Ie=s.performanceMetrics)==null?void 0:Ie.memoryUsage)||0)>250?"#FF9800":"#4CAF50",ae=parseFloat(((_e=s.performanceMetrics)==null?void 0:_e.frameTime)||16.67)>33?"#F44336":parseFloat(((ce=s.performanceMetrics)==null?void 0:ce.frameTime)||16.67)>20?"#FF9800":"#4CAF50";return N!==b.e&&((b.e=N)!=null?ne.style.setProperty("color",N):ne.style.removeProperty("color")),j!==b.t&&((b.t=j)!=null?ge.style.setProperty("color",j):ge.style.removeProperty("color")),$!==b.a&&((b.a=$)!=null?He.style.setProperty("color",$):He.style.removeProperty("color")),ae!==b.o&&((b.o=ae)!=null?We.style.setProperty("color",ae):We.style.removeProperty("color")),b},{e:void 0,t:void 0,a:void 0,o:void 0}),te})()},{id:"visual",icon:"",title:"Visual Settings",content:()=>[(()=>{var te=kd(),se=te.firstChild,W=se.firstChild,ne=W.nextSibling,U=ne.firstChild,fe=se.nextSibling;return ee(ne,()=>s.zoomSpeed().toFixed(1),U),fe.$$input=re=>s.setZoomSpeed(parseFloat(re.target.value)),Oe(()=>fe.value=s.zoomSpeed()),te})(),(()=>{var te=Fd(),se=te.firstChild,W=se.nextSibling,ne=W.firstChild,U=ne.nextSibling,fe=U.nextSibling,re=W.nextSibling,K=re.firstChild,be=K.nextSibling,ge=be.nextSibling;return ne.$$click=()=>{console.log("Setting palette to tech"),s.setPalette("tech")},U.$$click=()=>{console.log("Setting palette to enchantedJournal"),s.setPalette("enchantedJournal")},fe.$$click=()=>{console.log("Setting palette to moonlitManuscript"),s.setPalette("moonlitManuscript")},K.$$click=()=>{console.log("Setting palette to pureWhiteHigh"),s.setPalette("pureWhiteHigh")},be.$$click=()=>{console.log("Setting palette to pureWhiteBalanced"),s.setPalette("pureWhiteBalanced")},ge.$$click=()=>{console.log("Setting palette to blackOnBlack"),s.setPalette("blackOnBlack")},Oe(ye=>{var Ce=`debug-toggle-option ${s.currentPalette()==="tech"?"active":""}`,He=`debug-toggle-option ${s.currentPalette()==="enchantedJournal"?"active":""}`,pt=`debug-toggle-option ${s.currentPalette()==="moonlitManuscript"?"active":""}`,nt=`debug-toggle-option ${s.currentPalette()==="pureWhiteHigh"?"active":""}`,Ke=`debug-toggle-option ${s.currentPalette()==="pureWhiteBalanced"?"active":""}`,We=`debug-toggle-option ${s.currentPalette()==="blackOnBlack"?"active":""}`;return Ce!==ye.e&&qe(ne,ye.e=Ce),He!==ye.t&&qe(U,ye.t=He),pt!==ye.a&&qe(fe,ye.a=pt),nt!==ye.o&&qe(K,ye.o=nt),Ke!==ye.i&&qe(be,ye.i=Ke),We!==ye.n&&qe(ge,ye.n=We),ye},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),te})()]},{id:"navigation",icon:"",title:"Click Behavior",content:()=>(()=>{var te=Od(),se=te.firstChild,W=se.nextSibling,ne=W.firstChild,U=ne.nextSibling,fe=W.nextSibling;return ne.$$click=()=>s.setInteractionMode("direct"),U.$$click=()=>s.setInteractionMode("temporal"),ee(fe,()=>s.interactionMode()==="direct"?"Click/tap to immediately select and zoom":"Hold down to preview, release to activate"),Oe(re=>{var K=`debug-toggle-option ${s.interactionMode()==="direct"?"active":""}`,be=`debug-toggle-option ${s.interactionMode()==="temporal"?"active":""}`;return K!==re.e&&qe(ne,re.e=K),be!==re.t&&qe(U,re.t=be),re},{e:void 0,t:void 0}),te})()},...$e()?[]:[{id:"easing",icon:"",title:"Stroke Style",content:()=>he(Cd,{forceUpdate:m})}],{id:"overlay",icon:"",title:"Highlighting System",content:()=>(console.log("Overlay section render - overlayType:",s.overlayType),(()=>{var te=Vd(),se=te.firstChild,W=se.nextSibling,ne=W.firstChild,U=ne.nextSibling,fe=W.nextSibling;return ne.$$click=()=>s.toggleOverlay("css"),U.$$click=()=>s.toggleOverlay("safari"),ee(fe,()=>{const re=s.overlayType;return console.log("Description render - currentType:",re),re==="css"?"Precise borders that follow exact shapes (Chrome, Firefox)":"Universal glow effect that works on all devices and browsers"}),Oe(re=>{var K=`debug-toggle-option ${s.overlayType==="css"?"active":""}`,be=`debug-toggle-option ${s.overlayType==="safari"?"active":""}`;return K!==re.e&&qe(ne,re.e=K),be!==re.t&&qe(U,re.t=be),re},{e:void 0,t:void 0}),te})())},{id:"reveal",icon:"",title:"Hotspot Discovery",content:()=>[Ld(),(()=>{var te=Nd(),se=te.firstChild,W=se.nextSibling,ne=W.firstChild,U=ne.nextSibling;return ne.$$click=()=>s.setRevealStyle("invert"),U.$$click=()=>s.setRevealStyle("neon"),Oe(fe=>{var re=`debug-toggle-option ${s.revealStyle()==="invert"?"active":""}`,K=`debug-toggle-option ${s.revealStyle()==="neon"?"active":""}`;return re!==fe.e&&qe(ne,fe.e=re),K!==fe.t&&qe(U,fe.t=K),fe},{e:void 0,t:void 0}),te})()]}];if($e()){const te=[{id:"visual",label:"Visual",icon:""},{id:"behavior",label:"Behavior",icon:""},{id:"highlighting",label:"Highlighting",icon:""},{id:"reveal",label:"Reveal",icon:""}];return[(()=>{var se=zd(),W=se.firstChild,ne=W.firstChild;return ne.nextSibling,se.$$click=U=>{Hs(U,U.currentTarget),E(!0)},se.style.setProperty("position","fixed"),se.style.setProperty("bottom","20px"),se.style.setProperty("left","20px"),se.style.setProperty("transform","none"),se.style.setProperty("zIndex","1000"),ee(W,he(Ve,{get when(){var U;return(U=s.performanceMetrics)==null?void 0:U.currentFPS},get children(){var U=Bd(),fe=U.firstChild;return ee(U,()=>{var re,K;return(K=(re=s.performanceMetrics)==null?void 0:re.currentFPS)==null?void 0:K.toFixed(0)},fe),Oe(re=>{var K;return(re=(((K=s.performanceMetrics)==null?void 0:K.currentFPS)||60)<45?"#FF9800":"#4CAF50")!=null?U.style.setProperty("color",re):U.style.removeProperty("color")}),U}}),null),Oe(U=>(U=v()?"none":"flex")!=null?se.style.setProperty("display",U):se.style.removeProperty("display")),se})(),he(Ve,{get when(){return v()},get children(){var se=Hd(),W=se.firstChild,ne=W.firstChild,U=ne.nextSibling,fe=U.firstChild,re=U.nextSibling,K=re.nextSibling;se.$$click=ge=>{ge.target===ge.currentTarget&&G()},W.$$pointerdown=ge=>ge.stopPropagation(),W.$$click=ge=>ge.stopPropagation(),W.$$touchend=M,W.$$touchmove=R,W.$$touchstart=S;var be=Y;return typeof be=="function"?_u(be,W):Y=W,W.style.setProperty("position","fixed"),W.style.setProperty("bottom","0"),W.style.setProperty("left","0"),W.style.setProperty("right","0"),W.style.setProperty("transform","translateY(0)"),W.style.setProperty("transition","transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"),W.style.setProperty("willChange","transform"),W.style.setProperty("minHeight","75vh"),W.style.setProperty("height","80vh"),W.style.setProperty("display","flex"),W.style.setProperty("flexDirection","column"),ne.style.setProperty("padding","8px"),U.style.setProperty("padding","12px 20px"),fe.style.setProperty("fontSize","14px"),fe.style.setProperty("margin","0"),fe.style.setProperty("display","flex"),fe.style.setProperty("alignItems","center"),fe.style.setProperty("gap","8px"),ee(re,he(Vr,{each:te,children:(ge,ye)=>(()=>{var Ce=Ud(),He=Ce.firstChild,pt=He.nextSibling;return Ce.$$click=()=>x(ye()),ee(He,()=>ge.icon),ee(pt,()=>ge.label),Oe(()=>qe(Ce,`debug-mobile-tab ${T()===ye()?"active":""}`)),Ce})()})),K.style.setProperty("flex","1"),K.style.setProperty("overflowY","auto"),K.style.setProperty("WebkitOverflowScrolling","touch"),K.style.setProperty("padding","32px 24px 40px"),K.style.setProperty("minHeight","300px"),ee(K,he(Uh,{get children(){return[he(mr,{get when(){return T()===0},get children(){return[Ct(()=>k[2].content())," "]}}),he(mr,{get when(){return T()===1},get children(){return[Ct(()=>k[3].content())," "]}}),he(mr,{get when(){return T()===2},get children(){return[Ct(()=>k[4].content())," "]}}),he(mr,{get when(){return T()===3},get children(){return[Ct(()=>k[5].content())," "]}})]}})),Oe(ge=>{var ye=`debug-mobile-backdrop ${O()?"closing":""}`,Ce=`debug-mobile-sheet ${O()?"closing":"expanded"}`;return ye!==ge.e&&qe(se,ge.e=ye),Ce!==ge.t&&qe(W,ge.t=Ce),ge},{e:void 0,t:void 0}),se}})]}const F=te=>{if(!te.target.closest(".debug-panel-header")||t())return;te.preventDefault(),l(!0);const W=te.currentTarget.getBoundingClientRect();h({x:te.clientX,y:te.clientY,elementX:r().x!==null?r().x:W.left,elementY:r().y!==null?r().y:W.top})},D=te=>{if(!a())return;const se=te.clientX-u().x,W=te.clientY-u().y;o({x:u().elementX+se,y:u().elementY+W})},xe=()=>{l(!1)};kr(()=>{document.addEventListener("mousemove",D),document.addEventListener("mouseup",xe)}),Ln(()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",xe)}),kr(()=>{if(document.addEventListener("mousemove",D),document.addEventListener("mouseup",xe),t()){const te=document.querySelector(".debug-panel.glass-button");te&&Hs(te)}});const Pe=te=>{n(se=>({...se,[te]:!se[te]}))};return(()=>{var te=Gd(),se=te.firstChild,W=se.firstChild,ne=W.firstChild;return te.$$mousedown=F,se.$$click=()=>{t()&&e(!1)},ne.style.setProperty("transition","all 0.3s"),ne.style.setProperty("color","rgba(255, 255, 255, 0.9)"),ee(W,he(Ve,{get when(){return!t()},get children(){return jd()}}),null),ee(se,he(Ve,{get when(){return!t()},get children(){var U=Wd(),fe=U.firstChild;return U.addEventListener("mouseleave",re=>{re.currentTarget.style.background="rgba(255,255,255,0.08)",re.currentTarget.style.borderColor="rgba(255,255,255,0.12)",re.currentTarget.style.color="rgba(255,255,255,0.5)"}),U.addEventListener("mouseenter",re=>{re.currentTarget.style.background="rgba(255,255,255,0.12)",re.currentTarget.style.borderColor="rgba(255,255,255,0.2)",re.currentTarget.style.color="rgba(255,255,255,0.8)"}),U.$$click=re=>{re.stopPropagation(),e(!t())},U.style.setProperty("position","absolute"),U.style.setProperty("top","12px"),U.style.setProperty("right","12px"),U.style.setProperty("background","rgba(255,255,255,0.08)"),U.style.setProperty("border","1px solid rgba(255,255,255,0.12)"),U.style.setProperty("color","rgba(255,255,255,0.5)"),U.style.setProperty("fontSize","14px"),U.style.setProperty("lineHeight","1"),U.style.setProperty("cursor","pointer"),U.style.setProperty("padding","0"),U.style.setProperty("width","28px"),U.style.setProperty("height","28px"),U.style.setProperty("display","flex"),U.style.setProperty("alignItems","center"),U.style.setProperty("justifyContent","center"),U.style.setProperty("borderRadius","8px"),U.style.setProperty("transition","all 0.2s"),fe.style.setProperty("width","16px"),fe.style.setProperty("height","16px"),fe.style.setProperty("fill","currentColor"),U}}),null),ee(te,he(Ve,{get when(){return!t()},get children(){return he(Vr,{each:k,children:U=>(()=>{var fe=qd(),re=fe.firstChild,K=re.firstChild,be=K.firstChild,ge=be.nextSibling,ye=re.nextSibling,Ce=ye.firstChild;return re.$$click=()=>Pe(U.id),ee(be,()=>U.icon),ee(ge,()=>U.title),ee(Ce,()=>U.content()),Oe(()=>qe(fe,`debug-section ${i()[U.id]?"expanded":""}`)),fe})()})}}),null),Oe(U=>{var ye,Ce,He;var fe=`debug-panel ${t()?"glass-button":""}`,re={...r().x!==null&&!t()?{position:"fixed",left:`${r().x}px`,top:`${r().y}px`,width:((ye=s.style)==null?void 0:ye.width)||"320px",maxWidth:((Ce=s.style)==null?void 0:Ce.maxWidth)||"320px",zIndex:((He=s.style)==null?void 0:He.zIndex)||1e3}:t()?{position:"fixed",bottom:"20px",left:"20px",zIndex:1e3,width:"44px",minWidth:"44px",height:"44px",borderRadius:"50%"}:{position:"fixed",bottom:"20px",left:"20px",width:"320px",maxWidth:"320px",maxHeight:"calc(100vh - 100px)",zIndex:1e3,...s.style||{}},cursor:a()?"grabbing":"default",transition:a()?"none":"all 0.2s"},K={cursor:t()?"pointer":"grab",...t()?{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:0}:{}},be=t()?"20":"18",ge=t()?"20":"18";return fe!==U.e&&qe(te,U.e=fe),U.t=An(te,re,U.t),U.a=An(se,K,U.a),be!==U.o&&Ot(ne,"width",U.o=be),ge!==U.i&&Ot(ne,"height",U.i=ge),U},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),te})()}wi(["input","click","touchstart","touchmove","touchend","pointerdown","mousedown"]);let st={blendTime:{value:0,min:0,max:.5,step:.01,description:"Tile blending duration - 0 eliminates transparency artifacts"},maxTilesPerFrame:{value:1,min:1,max:6,step:1,description:"Max concurrent tiles - lower prevents cascade artifacts"},animationTime:{value:1.2,min:.1,max:3,step:.1,description:"Zoom animation duration - affects smoothness"},springStiffness:{value:6.5,min:1,max:20,step:.5,description:"Animation responsiveness - affects zoom feel"},immediateRender:{value:!1,description:"Force immediate tile rendering"},imageLoaderLimit:{value:2,min:1,max:8,step:1,description:"Concurrent image loading limit"},enableProgressiveQuality:{value:!0,description:"Reduce quality during zoom for smoother animation"},qualityReductionThreshold:{value:2,min:.5,max:5,step:.1,description:"Zoom level to start quality reduction"},minQualityLevel:{value:.6,min:.1,max:1,step:.05,description:"Lowest quality during animation (0.1-1.0)"},enableMouseWheelSmoothing:{value:!0,description:"Smooth discrete mouse wheel events"},wheelEventThrottleMs:{value:16,min:8,max:100,step:4,description:"Mouse wheel event throttling (ms)"},wheelZoomStep:{value:.02,min:.01,max:.2,step:.01,description:"Zoom increment per wheel tick"},enableTileCascadePrevention:{value:!0,description:"Prevent multiple pyramid levels simultaneously"},maxTileLevels:{value:3,min:1,max:5,step:1,description:"Maximum tile pyramid levels at low zoom"},cascadePreventionZoom:{value:3,min:1,max:10,step:.5,description:"Zoom threshold for cascade prevention"},forceSafariCanvas:{value:!0,description:"Force Canvas renderer on Safari (40-50% performance boost)"},disableWebGLOnMobile:{value:!0,description:"Disable WebGL on mobile devices (research shows 15 FPS improvement)"},tileOverlap:{value:1,min:0,max:4,step:1,description:"Tile overlap in pixels (prevents seams)"},wheelEventThrottleMs:{value:16,min:8,max:100,step:4,description:"Mouse wheel event throttling (ms)"},wheelZoomStep:{value:.02,min:.01,max:.2,step:.01,description:"Zoom increment per wheel tick"}};function po(s,t){if(!s||!t)return;const e=st;s.blendTime=e.blendTime.value,s.animationTime=e.animationTime.value,s.springStiffness=e.springStiffness.value,t.viewer.blendTime=e.blendTime.value,t.viewer.maxTilesPerFrame=e.maxTilesPerFrame.value,t.viewer.animationTime=e.animationTime.value,t.viewer.springStiffness=e.springStiffness.value,t.viewer.immediateRender=e.immediateRender.value,t.viewer.imageLoaderLimit=e.imageLoaderLimit.value,t.viewer.artifactElimination&&(t.viewer.artifactElimination.enableTileCascadePrevention=e.enableTileCascadePrevention.value,t.viewer.artifactElimination.enableBlendingOptimization=e.blendTime.value===0,t.viewer.artifactElimination.enableMouseWheelSmoothing=e.enableMouseWheelSmoothing.value,t.viewer.artifactElimination.enableProgressiveQuality=e.enableProgressiveQuality.value),s.forceRedraw&&s.forceRedraw(),console.log("Applied debug tuning values:",{blendTime:e.blendTime.value,maxTilesPerFrame:e.maxTilesPerFrame.value,animationTime:e.animationTime.value,springStiffness:e.springStiffness.value})}function Xd(s,t){st[s]&&(typeof st[s].value=="boolean"?st[s].value=!!t:st[s].value=Number(t),localStorage.setItem(`debugTuning_${s}`,String(st[s].value)),window.viewer&&po(window.viewer,window.performanceConfig),console.log(`Updated tuning parameter ${s}:`,st[s].value))}function Kd(){Object.keys(st).forEach(s=>{const t=localStorage.getItem(`debugTuning_${s}`);t!==null&&(typeof st[s].value=="boolean"?st[s].value=t==="true":st[s].value=Number(t))}),console.log("Loaded saved tuning values:",st)}function Yd(){const s={blendTime:0,maxTilesPerFrame:1,animationTime:1.2,springStiffness:6.5,immediateRender:!1,imageLoaderLimit:2,enableProgressiveQuality:!0,qualityReductionThreshold:2,minQualityLevel:.6,enableMouseWheelSmoothing:!0,wheelEventThrottleMs:16,wheelZoomStep:.02,enableTileCascadePrevention:!0,maxTileLevels:3,cascadePreventionZoom:3,forceSafariCanvas:!0,disableWebGLOnMobile:!0,tileOverlap:1,wheelEventThrottleMs:16,wheelZoomStep:.02};Object.keys(s).forEach(t=>{st[t]&&(st[t].value=s[t],localStorage.setItem(`debugTuning_${t}`,String(s[t])))}),window.viewer&&po(window.viewer,window.performanceConfig),console.log("Reset tuning to research-based defaults")}function Qd(){const s={};Object.keys(st).forEach(e=>{s[e]=st[e].value});const t=JSON.stringify(s,null,2);return navigator.clipboard&&(navigator.clipboard.writeText(t),console.log("Tuning config copied to clipboard:",s)),s}function K_(){return st}function Jd(){Kd(),window.debugTuning={state:st,update:Xd,reset:Yd,export:Qd,apply:po},console.log("Debug tuning system initialized"),console.log("Access via window.debugTuning in console"),console.log("Current values:",st)}var $d=L('<img class=preview-image alt="Loading preview">'),ef=L("<div class=viewer-loading><p>Loading high-resolution artwork...</p><p style=font-size:12px;margin-top:10px;opacity:0.7;>Debug: isLoading=<!>, viewerReady="),tf=L("<div><div><div style=font-size:12px;color:#FFFFFF;font-weight:600;letter-spacing:0.5px;text-align:center;>SPOTLIGHT FINE-TUNING</div><button></button></div><div class=floating-panel-scrollable><div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Circle Size: </label><input type=range max=3.0 step=0.05>"),nf=L('<button aria-label="Expand to Full View"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>'),rf=L('<div class=fullscreen-button-container><button class="fullscreen-button glass-button">'),sf=L("<div class=viewer-container><div class=openseadragon-viewer>"),of=L('<svg width=20 height=20 viewBox="0 0 20 20"fill=none><path d="M5 1v4H1M15 1v4h4M5 19v-4H1M15 19v-4h4"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>'),af=L('<svg width=20 height=20 viewBox="0 0 20 20"fill=none><path d="M1 5V1h4M19 5V1h-4M1 15v4h4M19 15v4h-4"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round>');let vr=[];function lf(s){let t;const[e,i]=oe(null);let n={};const r=$h(),[o,a]=oe(null),l=v=>{console.log(`Switching overlay system to: ${v}`);try{r.setCurrentOverlayType(v),r.components().overlayManager&&typeof r.components().overlayManager.destroy=="function"&&(console.log("Destroying old overlay manager"),r.components().overlayManager.destroy()),Pi.setPreference(v),console.log("Creating new overlay manager with type:",v);const E=Pi.createWithOverride(e());E.initialize(),r.setComponents(T=>({...T,overlayManager:E})),window.overlayManager=E,r.selectedHotspot()&&(console.log("Re-selecting hotspot after overlay switch:",r.selectedHotspot().id),setTimeout(()=>{E.selectHotspot(r.selectedHotspot())},100)),console.log("Overlay system switch completed successfully")}catch(E){console.error("Error switching overlay system:",E),alert("Error switching overlay system. Please refresh the page to continue.")}},u=()=>{n.handleKeyPress&&window.removeEventListener("keydown",n.handleKeyPress),Object.values(n).forEach(v=>{typeof v=="number"&&clearInterval(v)}),n.performanceUpdate&&clearInterval(n.performanceUpdate),r.components().resizeObserver&&t&&r.components().resizeObserver.disconnect(),Object.values(r.components()).forEach(v=>{v&&typeof v.destroy=="function"&&v.destroy()}),e()&&e().destroy(),["performanceMonitor","viewer","tileOptimizer","lowZoomOptimizer","safariPerformanceOptimizer"].forEach(v=>{(window[v]===r.components()[v]||window[v]===e())&&delete window[v]})},h=async v=>{var T,x,O,V,G,Y,J,A,S,R;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:v?v.id:"null (deselecting)",isZoomingToHotspot:r.isZoomingToHotspot(),isExpandingToFullView:r.isExpandingToFullView(),timestamp:Date.now()}),r.isZoomingToHotspot()&&(console.log(" FORCE RESET: Clearing stuck isZoomingToHotspot state"),r.setIsZoomingToHotspot(!1),r.components().renderOptimizer&&r.components().renderOptimizer.endCinematicZoom(),r.components().renderer&&(r.components().renderer.resumeUpdates(),$e()&&r.components().renderer.showOverlay()),await new Promise(M=>setTimeout(M,16))),console.log("Components available?",!!r.components()),console.log("OverlayManager available?",!!((T=r.components())!=null&&T.overlayManager)),console.log("OverlayManager type:",(O=(x=r.components())==null?void 0:x.overlayManager)==null?void 0:O.constructor.name),console.log("OverlayManager initialized?",(G=(V=r.components())==null?void 0:V.overlayManager)==null?void 0:G.isInitialized),!v){r.setSelectedHotspot(null),r.setShowMediaButton(!1),r.setCurrentPlayingHotspot(null),r.setCurrentMediaHotspot(null),r.components().overlayManager?(console.log("Calling overlayManager.clearSelection()"),r.components().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(r.isExpandingToFullView()&&(console.log("Interrupting Full View animation for hotspot click"),(Y=e())==null||Y.viewport.stopAnimation(),(J=o())==null||J.cleanupExpandAnimation(),r.setIsExpandingToFullView(!1),r.components().renderOptimizer&&r.components().renderOptimizer.endCinematicZoom(),r.components().renderer&&(r.components().renderer.resumeUpdates(),$e()&&r.components().renderer.showOverlay()),await new Promise(M=>setTimeout(M,50))),r.isZoomingToHotspot()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),r.setIsZoomingToHotspot(!1)),r.setShowMediaButton(!1),r.setSelectedHotspot(v),r.setCurrentPlayingHotspot(v),(A=r.components())!=null&&A.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(v==null?void 0:v.id)||"null"),console.log("Hotspot data being passed:",v),console.log("OverlayManager method exists?",typeof r.components().overlayManager.selectHotspot);try{r.components().overlayManager.selectHotspot(v),console.log("selectHotspot call completed")}catch(M){console.error("Error calling selectHotspot:",M)}}else console.error("No overlay manager available in components!"),console.error("Components object:",r.components());(v.image_url_1||((S=r.components().imageOverlayManager)==null?void 0:S.getOverlay(v.id)))&&(r.components().imageOverlayManager.shouldAutoReveal(v.id)?d(v.id):r.components().imageOverlayManager.shouldShowButton(v.id)&&(r.setCurrentMediaHotspot(v),r.setShowMediaButton(!0))),console.log(" FIXED: Guaranteed zoom to hotspot:",v.id);try{await((R=o())==null?void 0:R.zoomToHotspot(v))}catch(M){console.error("Zoom failed, forcing state reset:",M),r.setIsZoomingToHotspot(!1)}},d=v=>{console.log("Media button clicked for:",v),r.setShowMediaButton(!1),r.components().imageOverlayManager&&r.components().imageOverlayManager.openOverlay(v)},f=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(v=>{console.log(`Error attempting to enable fullscreen: ${v.message}`)})},m=v=>{const E=v.currentTarget;Hs(v,E),f()};return window.artworkViewerHandleHotspotClick=h,kr(async()=>{Jd();try{vr=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${vr.length} hotspots`)}catch(A){console.error("Failed to load hotspots:",A),vr=[]}const v=new Image;v.onload=()=>r.setPreviewLoaded(!0),v.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`,console.log("About to import and initialize viewer...");const{initializeViewer:E}=await Kh(async()=>{const{initializeViewer:A}=await import("./viewerSetup-5VhOlBN0.js").then(S=>S.v);return{initializeViewer:A}},[]),T={setIsLoading:r.setIsLoading,setViewerReady:r.setViewerReady},x=await E(t,s,r,h);console.log("Viewer initialization result:",x),i(x.viewer),n=x.intervals,x.homeViewport,console.log("Viewer assigned:",!!x.viewer);const O=td(x.viewer,r,r.components);a(O),window.animations=O,console.log("Animation hooks set:",!!O);const V=setTimeout(()=>{var A;r.isLoading()&&(console.warn(" Failsafe: Force hiding loading screen after 5 seconds"),T.setIsLoading(!1),T.setViewerReady(!0),x.viewer&&((A=x.viewer.world)==null?void 0:A.getItemCount())>0&&console.log("Viewer has items, forcing ready state"))},5e3);setTimeout(()=>{console.log("Applying automatic renderer switch to fix flickering...");const A=r.currentOverlayType();l(A==="css"?"safari":"css"),setTimeout(()=>{l(A==="css"?"css":"safari"),console.log("Automatic renderer switch completed - flickering should be fixed")},200)},2e3),document.addEventListener("fullscreenchange",()=>{r.setIsFullscreen(!!document.fullscreenElement)});const G=A=>{if(r.isDragging()){const S=A.touches?A.touches[0].clientX:A.clientX,R=A.touches?A.touches[0].clientY:A.clientY;r.setPanelPosition({x:S-r.dragStart().x,y:R-r.dragStart().y})}},Y=A=>{r.isDragging()&&(A.preventDefault(),G(A))},J=()=>{r.setIsDragging(!1)};window.addEventListener("mousemove",G),window.addEventListener("mouseup",J),window.addEventListener("touchmove",Y,{passive:!1}),window.addEventListener("touchend",J),Ln(()=>{window.removeEventListener("mousemove",G),window.removeEventListener("mouseup",J),window.removeEventListener("touchmove",Y),window.removeEventListener("touchend",J),clearTimeout(V)}),Ln(u)}),(()=>{var v=sf(),E=v.firstChild;return ee(v,he(Ve,{get when(){return Ct(()=>!!r.previewLoaded())()&&!r.viewerReady()},get children(){var T=$d();return Oe(()=>Ot(T,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),T}}),E),_u(T=>{t=T,console.log("ViewerRef assigned:",!!T)},E),ee(v,he(Ve,{get when(){return r.isLoading()},get children(){var T=ef(),x=T.firstChild,O=x.nextSibling,V=O.firstChild,G=V.nextSibling;return G.nextSibling,ee(O,()=>String(r.isLoading()),G),ee(O,()=>String(r.viewerReady()),null),T}}),null),ee(v,he(Ve,{get when(){return Ct(()=>!!r.viewerReady())()&&r.debugLevel()===1},get children(){return he(Zd,{get style(){return{position:"fixed",top:"10px",right:"10px",width:$e()?"90%":"320px",maxWidth:"320px",zIndex:1e3}},get selectedHotspot(){return r.selectedHotspot},get hoveredHotspot(){return r.hoveredHotspot},get totalHotspots(){return vr.length},get visibleHotspotCount(){var T,x;return(x=(T=r.components().renderer)==null?void 0:T.visibleOverlays)==null?void 0:x.size},get revealStyle(){return r.revealStyle},get setRevealStyle(){return r.updateRevealStyle},get performanceMetrics(){return r.performanceMetrics()},get zoomSpeed(){return r.zoomSpeedMultiplier},get setZoomSpeed(){return r.setZoomSpeedMultiplier},get setDebugLevel(){return r.setDebugLevel},get currentPalette(){return r.currentPalette},setPalette:T=>{var x;window.setHotspotPalette&&(window.setHotspotPalette(T),r.setCurrentPalette(T),(x=e())==null||x.forceRedraw())},get interactionMode(){return r.interactionMode},setInteractionMode:T=>{var x;r.setInteractionMode(T),localStorage.setItem("interactionMode",T),(x=r.components().renderer)!=null&&x.modeStateManager&&r.components().renderer.modeStateManager.setMode(T)},get overlayType(){return r.currentOverlayType()},toggleOverlay:T=>{console.log("DebugPanel requesting overlay switch to:",T),l(T)},get safariOptimizerState(){var T,x;return(x=(T=r.components().safariPerformanceOptimizer)==null?void 0:T.getState)==null?void 0:x.call(T)},get safariHybridMetrics(){return r.safariHybridMetrics()},isMobile:()=>$e(),get showFloatingPanel(){return r.showFloatingPanel},get setShowFloatingPanel(){return r.setShowFloatingPanel}})}}),null),ee(v,he(Ve,{get when(){return Ct(()=>!!r.showFloatingPanel())()&&(Pi.getCurrentType()==="safari"||Pi.detectBrowser().isWebKitBased&&!Pi.getCurrentType())},get children(){var T=tf(),x=T.firstChild,O=x.firstChild,V=O.nextSibling,G=x.nextSibling,Y=G.firstChild,J=Y.firstChild;J.firstChild;var A=J.nextSibling;return T.style.setProperty("position","fixed"),T.style.setProperty("width","220px"),T.style.setProperty("background","rgba(20,20,20,0.85)"),T.style.setProperty("border","1px solid rgba(255,255,255,0.2)"),T.style.setProperty("borderRadius","12px"),T.style.setProperty("boxShadow","0 8px 32px rgba(0,0,0,0.6)"),T.style.setProperty("zIndex","10000"),T.style.setProperty("userSelect","none"),T.style.setProperty("backdropFilter","blur(20px)"),T.style.setProperty("-webkit-backdrop-filter","blur(20px)"),T.style.setProperty("display","flex"),T.style.setProperty("flexDirection","column"),T.style.setProperty("overflowY","auto"),T.style.setProperty("overflowX","hidden"),x.$$touchstart=S=>{const R=S.touches[0];r.setIsDragging(!0),r.setDragStart({x:R.clientX-r.panelPosition().x,y:R.clientY-r.panelPosition().y})},x.$$mousedown=S=>{r.setIsDragging(!0),r.setDragStart({x:S.clientX-r.panelPosition().x,y:S.clientY-r.panelPosition().y})},x.style.setProperty("position","relative"),x.style.setProperty("padding","12px 40px 12px 16px"),x.style.setProperty("borderBottom","1px solid rgba(255,255,255,0.1)"),x.style.setProperty("cursor","grab"),x.style.setProperty("background","rgba(255,255,255,0.03)"),x.style.setProperty("borderRadius","12px 12px 0 0"),V.$$click=()=>r.setShowFloatingPanel(!1),V.addEventListener("mouseleave",S=>{S.target.style.background="transparent",S.target.style.color="rgba(255,255,255,0.5)"}),V.addEventListener("mouseenter",S=>{S.target.style.background="rgba(255,255,255,0.1)",S.target.style.color="rgba(255,255,255,0.8)"}),V.style.setProperty("position","absolute"),V.style.setProperty("top","8px"),V.style.setProperty("right","8px"),V.style.setProperty("background","transparent"),V.style.setProperty("border","none"),V.style.setProperty("color","rgba(255,255,255,0.5)"),V.style.setProperty("fontSize","16px"),V.style.setProperty("cursor","pointer"),V.style.setProperty("padding","4px"),V.style.setProperty("width","24px"),V.style.setProperty("height","24px"),V.style.setProperty("display","flex"),V.style.setProperty("alignItems","center"),V.style.setProperty("justifyContent","center"),V.style.setProperty("borderRadius","4px"),V.style.setProperty("transition","all 0.2s"),G.style.setProperty("padding","16px"),G.style.setProperty("overflowY","auto"),G.style.setProperty("overflowX","hidden"),G.style.setProperty("flex","1"),G.style.setProperty("WebkitOverflowScrolling","touch"),G.style.setProperty("scrollbarWidth","thin"),G.style.setProperty("scrollbarColor","rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05)"),ee(J,()=>r.circleMultiplierValue().toFixed(2),null),A.$$input=S=>{const R=parseFloat(S.target.value);r.setCircleMultiplierValue(R),window.safariTuning&&(window.safariTuning.circleMultiplier=R,r.components().overlayManager&&r.selectedHotspot()&&r.components().overlayManager.forceRecalculation())},A.style.setProperty("width","100%"),A.style.setProperty("height","20px"),A.style.setProperty("background","rgba(255,255,255,0.1)"),A.style.setProperty("borderRadius","10px"),A.style.setProperty("outline","none"),A.style.setProperty("appearance","none"),A.style.setProperty("WebkitAppearance","none"),Oe(S=>{var R=`${r.panelPosition().x}px`,M=`${r.panelPosition().y}px`,k=r.isDragging()?"grabbing":"default",F=$e()?"80vh":"none",D=$e()?"0.2":"0.1";return R!==S.e&&((S.e=R)!=null?T.style.setProperty("left",R):T.style.removeProperty("left")),M!==S.t&&((S.t=M)!=null?T.style.setProperty("top",M):T.style.removeProperty("top")),k!==S.a&&((S.a=k)!=null?T.style.setProperty("cursor",k):T.style.removeProperty("cursor")),F!==S.o&&((S.o=F)!=null?T.style.setProperty("maxHeight",F):T.style.removeProperty("maxHeight")),D!==S.i&&Ot(A,"min",S.i=D),S},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),Oe(()=>A.value=r.circleMultiplierValue()),T}}),null),ee(v,he(Ve,{get when(){return r.showExpandButton()},get children(){var T=nf();return T.$$click=()=>{var x;return(x=o())==null?void 0:x.expandToFullView()},Oe(()=>qe(T,`expand-button glass-button ${r.expandButtonFading()?"fade-out":""}`)),T}}),null),ee(v,he(Ve,{get when(){return r.viewerReady()},get children(){var T=rf(),x=T.firstChild;return x.$$click=m,ee(x,(()=>{var O=Ct(()=>!!r.isFullscreen());return()=>O()?of():af()})()),Oe(()=>Ot(x,"aria-label",r.isFullscreen()?"Exit fullscreen":"Enter fullscreen")),T}}),null),ee(v,he(Ve,{get when(){return r.showMediaButton()},get children(){return he(bd,{get position(){return r.mediaButtonPosition()},onClick:()=>{var T;return d((T=r.currentMediaHotspot())==null?void 0:T.id)},isLoading:!1})}}),null),ee(v,he(Ve,{get when(){return r.viewerReady()},get children(){return he(Td,{get audioEngine(){return r.components().audioEngine},get currentHotspot(){return r.currentPlayingHotspot}})}}),null),v})()}wi(["mousedown","touchstart","click","input"]);const uf=()=>{};var Ka={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bu=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},cf=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],l=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(l>>10)),t[i++]=String.fromCharCode(56320+(l&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},xu={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,l=n+2<s.length,u=l?s[n+2]:0,h=r>>2,d=(r&3)<<4|a>>4;let f=(a&15)<<2|u>>6,m=u&63;l||(m=64,o||(f=64)),i.push(e[h],e[d],e[f],e[m])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(bu(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):cf(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const u=n<s.length?e[s.charAt(n)]:64;++n;const d=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||u==null||d==null)throw new hf;const f=r<<2|a>>4;if(i.push(f),u!==64){const m=a<<4&240|u>>2;if(i.push(m),d!==64){const v=u<<6&192|d;i.push(v)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class hf extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const df=function(s){const t=bu(s);return xu.encodeByteArray(t,!0)},Nr=function(s){return df(s).replace(/\./g,"")},ff=function(s){try{return xu.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function pf(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gf=()=>pf().__FIREBASE_DEFAULTS__,mf=()=>{if(typeof process>"u"||typeof Ka>"u")return;const s=Ka.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},vf=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&ff(s[1]);return t&&JSON.parse(t)},go=()=>{try{return uf()||gf()||mf()||vf()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},yf=s=>{var t,e;return(e=(t=go())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},wf=s=>{const t=yf(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},Su=()=>{var s;return(s=go())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _f{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mo(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Tf(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ef(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[Nr(JSON.stringify(e)),Nr(JSON.stringify(o)),""].join(".")}const Mn={};function bf(){const s={prod:[],emulator:[]};for(const t of Object.keys(Mn))Mn[t]?s.emulator.push(t):s.prod.push(t);return s}function xf(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let Ya=!1;function Sf(s,t){if(typeof window>"u"||typeof document>"u"||!mo(window.location.host)||Mn[s]===t||Mn[s]||Ya)return;Mn[s]=t;function e(f){return`__firebase__banner__${f}`}const i="__firebase__banner",r=bf().prod.length>0;function o(){const f=document.getElementById(i);f&&f.remove()}function a(f){f.style.display="flex",f.style.background="#7faaf0",f.style.position="fixed",f.style.bottom="5px",f.style.left="5px",f.style.padding=".5em",f.style.borderRadius="5px",f.style.alignItems="center"}function l(f,m){f.setAttribute("width","24"),f.setAttribute("id",m),f.setAttribute("height","24"),f.setAttribute("viewBox","0 0 24 24"),f.setAttribute("fill","none"),f.style.marginLeft="-6px"}function u(){const f=document.createElement("span");return f.style.cursor="pointer",f.style.marginLeft="16px",f.style.fontSize="24px",f.innerHTML=" &times;",f.onclick=()=>{Ya=!0,o()},f}function h(f,m){f.setAttribute("id",m),f.innerText="Learn more",f.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",f.setAttribute("target","__blank"),f.style.paddingLeft="5px",f.style.textDecoration="underline"}function d(){const f=xf(i),m=e("text"),v=document.getElementById(m)||document.createElement("span"),E=e("learnmore"),T=document.getElementById(E)||document.createElement("a"),x=e("preprendIcon"),O=document.getElementById(x)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(f.created){const V=f.element;a(V),h(T,E);const G=u();l(O,x),V.append(O,v,T,G),document.body.appendChild(V)}r?(v.innerText="Preview backend disconnected.",O.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(O.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,v.innerText="Preview backend running in this workspace."),v.setAttribute("id",m)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",d):d()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Pf(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Cf(){var s;const t=(s=go())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function Rf(){return!Cf()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function If(){try{return typeof indexedDB=="object"}catch{return!1}}function Af(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Df="FirebaseError";class ln extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=Df,Object.setPrototypeOf(this,ln.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Pu.prototype.create)}}class Pu{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?Mf(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new ln(n,a,i)}}function Mf(s,t){return s.replace(kf,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const kf=/\{\$([^}]+)}/g;function Br(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if(Qa(r)&&Qa(o)){if(!Br(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function Qa(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Gt(s){return s&&s._delegate?s._delegate:s}class Bn{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Si="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ff{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new _f;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(Vf(t))try{this.getOrInitializeService({instanceIdentifier:Si})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=Si){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=Si){return this.instances.has(t)}getOptions(t=Si){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:Of(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=Si){return this.component?this.component.multipleInstances?t:Si:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Of(s){return s===Si?void 0:s}function Vf(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lf{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new Ff(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Me;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(Me||(Me={}));const Nf={debug:Me.DEBUG,verbose:Me.VERBOSE,info:Me.INFO,warn:Me.WARN,error:Me.ERROR,silent:Me.SILENT},Bf=Me.INFO,zf={[Me.DEBUG]:"log",[Me.VERBOSE]:"log",[Me.INFO]:"info",[Me.WARN]:"warn",[Me.ERROR]:"error"},Hf=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=zf[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class Cu{constructor(t){this.name=t,this._logLevel=Bf,this._logHandler=Hf,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Me))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?Nf[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Me.DEBUG,...t),this._logHandler(this,Me.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Me.VERBOSE,...t),this._logHandler(this,Me.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Me.INFO,...t),this._logHandler(this,Me.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Me.WARN,...t),this._logHandler(this,Me.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Me.ERROR,...t),this._logHandler(this,Me.ERROR,...t)}}const Uf=(s,t)=>t.some(e=>s instanceof e);let Ja,$a;function jf(){return Ja||(Ja=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Wf(){return $a||($a=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Ru=new WeakMap,Us=new WeakMap,Iu=new WeakMap,As=new WeakMap,vo=new WeakMap;function Gf(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(oi(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Ru.set(e,s)}).catch(()=>{}),vo.set(t,s),t}function qf(s){if(Us.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});Us.set(s,t)}let js={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return Us.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Iu.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return oi(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function Zf(s){js=s(js)}function Xf(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(Ds(this),t,...e);return Iu.set(i,t.sort?t.sort():[t]),oi(i)}:Wf().includes(s)?function(...t){return s.apply(Ds(this),t),oi(Ru.get(this))}:function(...t){return oi(s.apply(Ds(this),t))}}function Kf(s){return typeof s=="function"?Xf(s):(s instanceof IDBTransaction&&qf(s),Uf(s,jf())?new Proxy(s,js):s)}function oi(s){if(s instanceof IDBRequest)return Gf(s);if(As.has(s))return As.get(s);const t=Kf(s);return t!==s&&(As.set(s,t),vo.set(t,s)),t}const Ds=s=>vo.get(s);function Yf(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=oi(o);return i&&o.addEventListener("upgradeneeded",l=>{i(oi(o.result),l.oldVersion,l.newVersion,oi(o.transaction),l)}),e&&o.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),n&&l.addEventListener("versionchange",u=>n(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}const Qf=["get","getKey","getAll","getAllKeys","count"],Jf=["put","add","delete","clear"],Ms=new Map;function el(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(Ms.get(t))return Ms.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=Jf.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||Qf.includes(e)))return;const r=async function(o,...a){const l=this.transaction(o,n?"readwrite":"readonly");let u=l.store;return i&&(u=u.index(a.shift())),(await Promise.all([u[e](...a),n&&l.done]))[0]};return Ms.set(t,r),r}Zf(s=>({...s,get:(t,e,i)=>el(t,e)||s.get(t,e,i),has:(t,e)=>!!el(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $f{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(ep(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function ep(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const Ws="@firebase/app",tl="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $t=new Cu("@firebase/app"),tp="@firebase/app-compat",ip="@firebase/analytics-compat",np="@firebase/analytics",rp="@firebase/app-check-compat",sp="@firebase/app-check",op="@firebase/auth",ap="@firebase/auth-compat",lp="@firebase/database",up="@firebase/data-connect",cp="@firebase/database-compat",hp="@firebase/functions",dp="@firebase/functions-compat",fp="@firebase/installations",pp="@firebase/installations-compat",gp="@firebase/messaging",mp="@firebase/messaging-compat",vp="@firebase/performance",yp="@firebase/performance-compat",wp="@firebase/remote-config",_p="@firebase/remote-config-compat",Tp="@firebase/storage",Ep="@firebase/storage-compat",bp="@firebase/firestore",xp="@firebase/ai",Sp="@firebase/firestore-compat",Pp="firebase",Cp="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Gs="[DEFAULT]",Rp={[Ws]:"fire-core",[tp]:"fire-core-compat",[np]:"fire-analytics",[ip]:"fire-analytics-compat",[sp]:"fire-app-check",[rp]:"fire-app-check-compat",[op]:"fire-auth",[ap]:"fire-auth-compat",[lp]:"fire-rtdb",[up]:"fire-data-connect",[cp]:"fire-rtdb-compat",[hp]:"fire-fn",[dp]:"fire-fn-compat",[fp]:"fire-iid",[pp]:"fire-iid-compat",[gp]:"fire-fcm",[mp]:"fire-fcm-compat",[vp]:"fire-perf",[yp]:"fire-perf-compat",[wp]:"fire-rc",[_p]:"fire-rc-compat",[Tp]:"fire-gcs",[Ep]:"fire-gcs-compat",[bp]:"fire-fst",[Sp]:"fire-fst-compat",[xp]:"fire-vertex","fire-js":"fire-js",[Pp]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zr=new Map,Ip=new Map,qs=new Map;function il(s,t){try{s.container.addComponent(t)}catch(e){$t.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function Hr(s){const t=s.name;if(qs.has(t))return $t.debug(`There were multiple attempts to register component ${t}.`),!1;qs.set(t,s);for(const e of zr.values())il(e,s);for(const e of Ip.values())il(e,s);return!0}function Ap(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function Dp(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mp={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},ai=new Pu("app","Firebase",Mp);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kp{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new Bn("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw ai.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fp=Cp;function Au(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:Gs,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw ai.create("bad-app-name",{appName:String(n)});if(e||(e=Su()),!e)throw ai.create("no-options");const r=zr.get(n);if(r){if(Br(e,r.options)&&Br(i,r.config))return r;throw ai.create("duplicate-app",{appName:n})}const o=new Lf(n);for(const l of qs.values())o.addComponent(l);const a=new kp(e,i,o);return zr.set(n,a),a}function Op(s=Gs){const t=zr.get(s);if(!t&&s===Gs&&Su())return Au();if(!t)throw ai.create("no-app",{appName:s});return t}function Ji(s,t,e){var i;let n=(i=Rp[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),$t.warn(a.join(" "));return}Hr(new Bn(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vp="firebase-heartbeat-database",Lp=1,zn="firebase-heartbeat-store";let ks=null;function Du(){return ks||(ks=Yf(Vp,Lp,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(zn)}catch(e){console.warn(e)}}}}).catch(s=>{throw ai.create("idb-open",{originalErrorMessage:s.message})})),ks}async function Np(s){try{const e=(await Du()).transaction(zn),i=await e.objectStore(zn).get(Mu(s));return await e.done,i}catch(t){if(t instanceof ln)$t.warn(t.message);else{const e=ai.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});$t.warn(e.message)}}}async function nl(s,t){try{const i=(await Du()).transaction(zn,"readwrite");await i.objectStore(zn).put(t,Mu(s)),await i.done}catch(e){if(e instanceof ln)$t.warn(e.message);else{const i=ai.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});$t.warn(i.message)}}}function Mu(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Bp=1024,zp=30;class Hp{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new jp(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=rl();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>zp){const o=Wp(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){$t.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=rl(),{heartbeatsToSend:i,unsentEntries:n}=Up(this._heartbeatsCache.heartbeats),r=Nr(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return $t.warn(e),""}}}function rl(){return new Date().toISOString().substring(0,10)}function Up(s,t=Bp){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),sl(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),sl(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class jp{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return If()?Af().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await Np(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return nl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return nl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function sl(s){return Nr(JSON.stringify({version:2,heartbeats:s})).length}function Wp(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Gp(s){Hr(new Bn("platform-logger",t=>new $f(t),"PRIVATE")),Hr(new Bn("heartbeat",t=>new Hp(t),"PRIVATE")),Ji(Ws,tl,s),Ji(Ws,tl,"esm2017"),Ji("fire-js","")}Gp("");var ol=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var li,ku;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(A,S){function R(){}R.prototype=S.prototype,A.D=S.prototype,A.prototype=new R,A.prototype.constructor=A,A.C=function(M,k,F){for(var D=Array(arguments.length-2),xe=2;xe<arguments.length;xe++)D[xe-2]=arguments[xe];return S.prototype[k].apply(M,D)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(A,S,R){R||(R=0);var M=Array(16);if(typeof S=="string")for(var k=0;16>k;++k)M[k]=S.charCodeAt(R++)|S.charCodeAt(R++)<<8|S.charCodeAt(R++)<<16|S.charCodeAt(R++)<<24;else for(k=0;16>k;++k)M[k]=S[R++]|S[R++]<<8|S[R++]<<16|S[R++]<<24;S=A.g[0],R=A.g[1],k=A.g[2];var F=A.g[3],D=S+(F^R&(k^F))+M[0]+3614090360&4294967295;S=R+(D<<7&4294967295|D>>>25),D=F+(k^S&(R^k))+M[1]+3905402710&4294967295,F=S+(D<<12&4294967295|D>>>20),D=k+(R^F&(S^R))+M[2]+606105819&4294967295,k=F+(D<<17&4294967295|D>>>15),D=R+(S^k&(F^S))+M[3]+3250441966&4294967295,R=k+(D<<22&4294967295|D>>>10),D=S+(F^R&(k^F))+M[4]+4118548399&4294967295,S=R+(D<<7&4294967295|D>>>25),D=F+(k^S&(R^k))+M[5]+1200080426&4294967295,F=S+(D<<12&4294967295|D>>>20),D=k+(R^F&(S^R))+M[6]+2821735955&4294967295,k=F+(D<<17&4294967295|D>>>15),D=R+(S^k&(F^S))+M[7]+4249261313&4294967295,R=k+(D<<22&4294967295|D>>>10),D=S+(F^R&(k^F))+M[8]+1770035416&4294967295,S=R+(D<<7&4294967295|D>>>25),D=F+(k^S&(R^k))+M[9]+2336552879&4294967295,F=S+(D<<12&4294967295|D>>>20),D=k+(R^F&(S^R))+M[10]+4294925233&4294967295,k=F+(D<<17&4294967295|D>>>15),D=R+(S^k&(F^S))+M[11]+2304563134&4294967295,R=k+(D<<22&4294967295|D>>>10),D=S+(F^R&(k^F))+M[12]+1804603682&4294967295,S=R+(D<<7&4294967295|D>>>25),D=F+(k^S&(R^k))+M[13]+4254626195&4294967295,F=S+(D<<12&4294967295|D>>>20),D=k+(R^F&(S^R))+M[14]+2792965006&4294967295,k=F+(D<<17&4294967295|D>>>15),D=R+(S^k&(F^S))+M[15]+1236535329&4294967295,R=k+(D<<22&4294967295|D>>>10),D=S+(k^F&(R^k))+M[1]+4129170786&4294967295,S=R+(D<<5&4294967295|D>>>27),D=F+(R^k&(S^R))+M[6]+3225465664&4294967295,F=S+(D<<9&4294967295|D>>>23),D=k+(S^R&(F^S))+M[11]+643717713&4294967295,k=F+(D<<14&4294967295|D>>>18),D=R+(F^S&(k^F))+M[0]+3921069994&4294967295,R=k+(D<<20&4294967295|D>>>12),D=S+(k^F&(R^k))+M[5]+3593408605&4294967295,S=R+(D<<5&4294967295|D>>>27),D=F+(R^k&(S^R))+M[10]+38016083&4294967295,F=S+(D<<9&4294967295|D>>>23),D=k+(S^R&(F^S))+M[15]+3634488961&4294967295,k=F+(D<<14&4294967295|D>>>18),D=R+(F^S&(k^F))+M[4]+3889429448&4294967295,R=k+(D<<20&4294967295|D>>>12),D=S+(k^F&(R^k))+M[9]+568446438&4294967295,S=R+(D<<5&4294967295|D>>>27),D=F+(R^k&(S^R))+M[14]+3275163606&4294967295,F=S+(D<<9&4294967295|D>>>23),D=k+(S^R&(F^S))+M[3]+4107603335&4294967295,k=F+(D<<14&4294967295|D>>>18),D=R+(F^S&(k^F))+M[8]+1163531501&4294967295,R=k+(D<<20&4294967295|D>>>12),D=S+(k^F&(R^k))+M[13]+2850285829&4294967295,S=R+(D<<5&4294967295|D>>>27),D=F+(R^k&(S^R))+M[2]+4243563512&4294967295,F=S+(D<<9&4294967295|D>>>23),D=k+(S^R&(F^S))+M[7]+1735328473&4294967295,k=F+(D<<14&4294967295|D>>>18),D=R+(F^S&(k^F))+M[12]+2368359562&4294967295,R=k+(D<<20&4294967295|D>>>12),D=S+(R^k^F)+M[5]+4294588738&4294967295,S=R+(D<<4&4294967295|D>>>28),D=F+(S^R^k)+M[8]+2272392833&4294967295,F=S+(D<<11&4294967295|D>>>21),D=k+(F^S^R)+M[11]+1839030562&4294967295,k=F+(D<<16&4294967295|D>>>16),D=R+(k^F^S)+M[14]+4259657740&4294967295,R=k+(D<<23&4294967295|D>>>9),D=S+(R^k^F)+M[1]+2763975236&4294967295,S=R+(D<<4&4294967295|D>>>28),D=F+(S^R^k)+M[4]+1272893353&4294967295,F=S+(D<<11&4294967295|D>>>21),D=k+(F^S^R)+M[7]+4139469664&4294967295,k=F+(D<<16&4294967295|D>>>16),D=R+(k^F^S)+M[10]+3200236656&4294967295,R=k+(D<<23&4294967295|D>>>9),D=S+(R^k^F)+M[13]+681279174&4294967295,S=R+(D<<4&4294967295|D>>>28),D=F+(S^R^k)+M[0]+3936430074&4294967295,F=S+(D<<11&4294967295|D>>>21),D=k+(F^S^R)+M[3]+3572445317&4294967295,k=F+(D<<16&4294967295|D>>>16),D=R+(k^F^S)+M[6]+76029189&4294967295,R=k+(D<<23&4294967295|D>>>9),D=S+(R^k^F)+M[9]+3654602809&4294967295,S=R+(D<<4&4294967295|D>>>28),D=F+(S^R^k)+M[12]+3873151461&4294967295,F=S+(D<<11&4294967295|D>>>21),D=k+(F^S^R)+M[15]+530742520&4294967295,k=F+(D<<16&4294967295|D>>>16),D=R+(k^F^S)+M[2]+3299628645&4294967295,R=k+(D<<23&4294967295|D>>>9),D=S+(k^(R|~F))+M[0]+4096336452&4294967295,S=R+(D<<6&4294967295|D>>>26),D=F+(R^(S|~k))+M[7]+1126891415&4294967295,F=S+(D<<10&4294967295|D>>>22),D=k+(S^(F|~R))+M[14]+2878612391&4294967295,k=F+(D<<15&4294967295|D>>>17),D=R+(F^(k|~S))+M[5]+4237533241&4294967295,R=k+(D<<21&4294967295|D>>>11),D=S+(k^(R|~F))+M[12]+1700485571&4294967295,S=R+(D<<6&4294967295|D>>>26),D=F+(R^(S|~k))+M[3]+2399980690&4294967295,F=S+(D<<10&4294967295|D>>>22),D=k+(S^(F|~R))+M[10]+4293915773&4294967295,k=F+(D<<15&4294967295|D>>>17),D=R+(F^(k|~S))+M[1]+2240044497&4294967295,R=k+(D<<21&4294967295|D>>>11),D=S+(k^(R|~F))+M[8]+1873313359&4294967295,S=R+(D<<6&4294967295|D>>>26),D=F+(R^(S|~k))+M[15]+4264355552&4294967295,F=S+(D<<10&4294967295|D>>>22),D=k+(S^(F|~R))+M[6]+2734768916&4294967295,k=F+(D<<15&4294967295|D>>>17),D=R+(F^(k|~S))+M[13]+1309151649&4294967295,R=k+(D<<21&4294967295|D>>>11),D=S+(k^(R|~F))+M[4]+4149444226&4294967295,S=R+(D<<6&4294967295|D>>>26),D=F+(R^(S|~k))+M[11]+3174756917&4294967295,F=S+(D<<10&4294967295|D>>>22),D=k+(S^(F|~R))+M[2]+718787259&4294967295,k=F+(D<<15&4294967295|D>>>17),D=R+(F^(k|~S))+M[9]+3951481745&4294967295,A.g[0]=A.g[0]+S&4294967295,A.g[1]=A.g[1]+(k+(D<<21&4294967295|D>>>11))&4294967295,A.g[2]=A.g[2]+k&4294967295,A.g[3]=A.g[3]+F&4294967295}i.prototype.u=function(A,S){S===void 0&&(S=A.length);for(var R=S-this.blockSize,M=this.B,k=this.h,F=0;F<S;){if(k==0)for(;F<=R;)n(this,A,F),F+=this.blockSize;if(typeof A=="string"){for(;F<S;)if(M[k++]=A.charCodeAt(F++),k==this.blockSize){n(this,M),k=0;break}}else for(;F<S;)if(M[k++]=A[F++],k==this.blockSize){n(this,M),k=0;break}}this.h=k,this.o+=S},i.prototype.v=function(){var A=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);A[0]=128;for(var S=1;S<A.length-8;++S)A[S]=0;var R=8*this.o;for(S=A.length-8;S<A.length;++S)A[S]=R&255,R/=256;for(this.u(A),A=Array(16),S=R=0;4>S;++S)for(var M=0;32>M;M+=8)A[R++]=this.g[S]>>>M&255;return A};function r(A,S){var R=a;return Object.prototype.hasOwnProperty.call(R,A)?R[A]:R[A]=S(A)}function o(A,S){this.h=S;for(var R=[],M=!0,k=A.length-1;0<=k;k--){var F=A[k]|0;M&&F==S||(R[k]=F,M=!1)}this.g=R}var a={};function l(A){return-128<=A&&128>A?r(A,function(S){return new o([S|0],0>S?-1:0)}):new o([A|0],0>A?-1:0)}function u(A){if(isNaN(A)||!isFinite(A))return d;if(0>A)return T(u(-A));for(var S=[],R=1,M=0;A>=R;M++)S[M]=A/R|0,R*=4294967296;return new o(S,0)}function h(A,S){if(A.length==0)throw Error("number format error: empty string");if(S=S||10,2>S||36<S)throw Error("radix out of range: "+S);if(A.charAt(0)=="-")return T(h(A.substring(1),S));if(0<=A.indexOf("-"))throw Error('number format error: interior "-" character');for(var R=u(Math.pow(S,8)),M=d,k=0;k<A.length;k+=8){var F=Math.min(8,A.length-k),D=parseInt(A.substring(k,k+F),S);8>F?(F=u(Math.pow(S,F)),M=M.j(F).add(u(D))):(M=M.j(R),M=M.add(u(D)))}return M}var d=l(0),f=l(1),m=l(16777216);s=o.prototype,s.m=function(){if(E(this))return-T(this).m();for(var A=0,S=1,R=0;R<this.g.length;R++){var M=this.i(R);A+=(0<=M?M:4294967296+M)*S,S*=4294967296}return A},s.toString=function(A){if(A=A||10,2>A||36<A)throw Error("radix out of range: "+A);if(v(this))return"0";if(E(this))return"-"+T(this).toString(A);for(var S=u(Math.pow(A,6)),R=this,M="";;){var k=G(R,S).g;R=x(R,k.j(S));var F=((0<R.g.length?R.g[0]:R.h)>>>0).toString(A);if(R=k,v(R))return F+M;for(;6>F.length;)F="0"+F;M=F+M}},s.i=function(A){return 0>A?0:A<this.g.length?this.g[A]:this.h};function v(A){if(A.h!=0)return!1;for(var S=0;S<A.g.length;S++)if(A.g[S]!=0)return!1;return!0}function E(A){return A.h==-1}s.l=function(A){return A=x(this,A),E(A)?-1:v(A)?0:1};function T(A){for(var S=A.g.length,R=[],M=0;M<S;M++)R[M]=~A.g[M];return new o(R,~A.h).add(f)}s.abs=function(){return E(this)?T(this):this},s.add=function(A){for(var S=Math.max(this.g.length,A.g.length),R=[],M=0,k=0;k<=S;k++){var F=M+(this.i(k)&65535)+(A.i(k)&65535),D=(F>>>16)+(this.i(k)>>>16)+(A.i(k)>>>16);M=D>>>16,F&=65535,D&=65535,R[k]=D<<16|F}return new o(R,R[R.length-1]&-2147483648?-1:0)};function x(A,S){return A.add(T(S))}s.j=function(A){if(v(this)||v(A))return d;if(E(this))return E(A)?T(this).j(T(A)):T(T(this).j(A));if(E(A))return T(this.j(T(A)));if(0>this.l(m)&&0>A.l(m))return u(this.m()*A.m());for(var S=this.g.length+A.g.length,R=[],M=0;M<2*S;M++)R[M]=0;for(M=0;M<this.g.length;M++)for(var k=0;k<A.g.length;k++){var F=this.i(M)>>>16,D=this.i(M)&65535,xe=A.i(k)>>>16,Pe=A.i(k)&65535;R[2*M+2*k]+=D*Pe,O(R,2*M+2*k),R[2*M+2*k+1]+=F*Pe,O(R,2*M+2*k+1),R[2*M+2*k+1]+=D*xe,O(R,2*M+2*k+1),R[2*M+2*k+2]+=F*xe,O(R,2*M+2*k+2)}for(M=0;M<S;M++)R[M]=R[2*M+1]<<16|R[2*M];for(M=S;M<2*S;M++)R[M]=0;return new o(R,0)};function O(A,S){for(;(A[S]&65535)!=A[S];)A[S+1]+=A[S]>>>16,A[S]&=65535,S++}function V(A,S){this.g=A,this.h=S}function G(A,S){if(v(S))throw Error("division by zero");if(v(A))return new V(d,d);if(E(A))return S=G(T(A),S),new V(T(S.g),T(S.h));if(E(S))return S=G(A,T(S)),new V(T(S.g),S.h);if(30<A.g.length){if(E(A)||E(S))throw Error("slowDivide_ only works with positive integers.");for(var R=f,M=S;0>=M.l(A);)R=Y(R),M=Y(M);var k=J(R,1),F=J(M,1);for(M=J(M,2),R=J(R,2);!v(M);){var D=F.add(M);0>=D.l(A)&&(k=k.add(R),F=D),M=J(M,1),R=J(R,1)}return S=x(A,k.j(S)),new V(k,S)}for(k=d;0<=A.l(S);){for(R=Math.max(1,Math.floor(A.m()/S.m())),M=Math.ceil(Math.log(R)/Math.LN2),M=48>=M?1:Math.pow(2,M-48),F=u(R),D=F.j(S);E(D)||0<D.l(A);)R-=M,F=u(R),D=F.j(S);v(F)&&(F=f),k=k.add(F),A=x(A,D)}return new V(k,A)}s.A=function(A){return G(this,A).h},s.and=function(A){for(var S=Math.max(this.g.length,A.g.length),R=[],M=0;M<S;M++)R[M]=this.i(M)&A.i(M);return new o(R,this.h&A.h)},s.or=function(A){for(var S=Math.max(this.g.length,A.g.length),R=[],M=0;M<S;M++)R[M]=this.i(M)|A.i(M);return new o(R,this.h|A.h)},s.xor=function(A){for(var S=Math.max(this.g.length,A.g.length),R=[],M=0;M<S;M++)R[M]=this.i(M)^A.i(M);return new o(R,this.h^A.h)};function Y(A){for(var S=A.g.length+1,R=[],M=0;M<S;M++)R[M]=A.i(M)<<1|A.i(M-1)>>>31;return new o(R,A.h)}function J(A,S){var R=S>>5;S%=32;for(var M=A.g.length-R,k=[],F=0;F<M;F++)k[F]=0<S?A.i(F+R)>>>S|A.i(F+R+1)<<32-S:A.i(F+R);return new o(k,A.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,ku=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=u,o.fromString=h,li=o}).apply(typeof ol<"u"?ol:typeof self<"u"?self:typeof window<"u"?window:{});var yr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Fu,Pn,Ou,Sr,Zs,Vu,Lu,Nu;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(c,p,y){return c==Array.prototype||c==Object.prototype||(c[p]=y.value),c};function e(c){c=[typeof globalThis=="object"&&globalThis,c,typeof window=="object"&&window,typeof self=="object"&&self,typeof yr=="object"&&yr];for(var p=0;p<c.length;++p){var y=c[p];if(y&&y.Math==Math)return y}throw Error("Cannot find global object")}var i=e(this);function n(c,p){if(p)e:{var y=i;c=c.split(".");for(var P=0;P<c.length-1;P++){var B=c[P];if(!(B in y))break e;y=y[B]}c=c[c.length-1],P=y[c],p=p(P),p!=P&&p!=null&&t(y,c,{configurable:!0,writable:!0,value:p})}}function r(c,p){c instanceof String&&(c+="");var y=0,P=!1,B={next:function(){if(!P&&y<c.length){var z=y++;return{value:p(z,c[z]),done:!1}}return P=!0,{done:!0,value:void 0}}};return B[Symbol.iterator]=function(){return B},B}n("Array.prototype.values",function(c){return c||function(){return r(this,function(p,y){return y})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function l(c){var p=typeof c;return p=p!="object"?p:c?Array.isArray(c)?"array":p:"null",p=="array"||p=="object"&&typeof c.length=="number"}function u(c){var p=typeof c;return p=="object"&&c!=null||p=="function"}function h(c,p,y){return c.call.apply(c.bind,arguments)}function d(c,p,y){if(!c)throw Error();if(2<arguments.length){var P=Array.prototype.slice.call(arguments,2);return function(){var B=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(B,P),c.apply(p,B)}}return function(){return c.apply(p,arguments)}}function f(c,p,y){return f=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?h:d,f.apply(null,arguments)}function m(c,p){var y=Array.prototype.slice.call(arguments,1);return function(){var P=y.slice();return P.push.apply(P,arguments),c.apply(this,P)}}function v(c,p){function y(){}y.prototype=p.prototype,c.aa=p.prototype,c.prototype=new y,c.prototype.constructor=c,c.Qb=function(P,B,z){for(var ie=Array(arguments.length-2),Be=2;Be<arguments.length;Be++)ie[Be-2]=arguments[Be];return p.prototype[B].apply(P,ie)}}function E(c){const p=c.length;if(0<p){const y=Array(p);for(let P=0;P<p;P++)y[P]=c[P];return y}return[]}function T(c,p){for(let y=1;y<arguments.length;y++){const P=arguments[y];if(l(P)){const B=c.length||0,z=P.length||0;c.length=B+z;for(let ie=0;ie<z;ie++)c[B+ie]=P[ie]}else c.push(P)}}class x{constructor(p,y){this.i=p,this.j=y,this.h=0,this.g=null}get(){let p;return 0<this.h?(this.h--,p=this.g,this.g=p.next,p.next=null):p=this.i(),p}}function O(c){return/^[\s\xa0]*$/.test(c)}function V(){var c=a.navigator;return c&&(c=c.userAgent)?c:""}function G(c){return G[" "](c),c}G[" "]=function(){};var Y=V().indexOf("Gecko")!=-1&&!(V().toLowerCase().indexOf("webkit")!=-1&&V().indexOf("Edge")==-1)&&!(V().indexOf("Trident")!=-1||V().indexOf("MSIE")!=-1)&&V().indexOf("Edge")==-1;function J(c,p,y){for(const P in c)p.call(y,c[P],P,c)}function A(c,p){for(const y in c)p.call(void 0,c[y],y,c)}function S(c){const p={};for(const y in c)p[y]=c[y];return p}const R="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function M(c,p){let y,P;for(let B=1;B<arguments.length;B++){P=arguments[B];for(y in P)c[y]=P[y];for(let z=0;z<R.length;z++)y=R[z],Object.prototype.hasOwnProperty.call(P,y)&&(c[y]=P[y])}}function k(c){var p=1;c=c.split(":");const y=[];for(;0<p&&c.length;)y.push(c.shift()),p--;return c.length&&y.push(c.join(":")),y}function F(c){a.setTimeout(()=>{throw c},0)}function D(){var c=ne;let p=null;return c.g&&(p=c.g,c.g=c.g.next,c.g||(c.h=null),p.next=null),p}class xe{constructor(){this.h=this.g=null}add(p,y){const P=Pe.get();P.set(p,y),this.h?this.h.next=P:this.g=P,this.h=P}}var Pe=new x(()=>new te,c=>c.reset());class te{constructor(){this.next=this.g=this.h=null}set(p,y){this.h=p,this.g=y,this.next=null}reset(){this.next=this.g=this.h=null}}let se,W=!1,ne=new xe,U=()=>{const c=a.Promise.resolve(void 0);se=()=>{c.then(fe)}};var fe=()=>{for(var c;c=D();){try{c.h.call(c.g)}catch(y){F(y)}var p=Pe;p.j(c),100>p.h&&(p.h++,c.next=p.g,p.g=c)}W=!1};function re(){this.s=this.s,this.C=this.C}re.prototype.s=!1,re.prototype.ma=function(){this.s||(this.s=!0,this.N())},re.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function K(c,p){this.type=c,this.g=this.target=p,this.defaultPrevented=!1}K.prototype.h=function(){this.defaultPrevented=!0};var be=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var c=!1,p=Object.defineProperty({},"passive",{get:function(){c=!0}});try{const y=()=>{};a.addEventListener("test",y,p),a.removeEventListener("test",y,p)}catch{}return c}();function ge(c,p){if(K.call(this,c?c.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,c){var y=this.type=c.type,P=c.changedTouches&&c.changedTouches.length?c.changedTouches[0]:null;if(this.target=c.target||c.srcElement,this.g=p,p=c.relatedTarget){if(Y){e:{try{G(p.nodeName);var B=!0;break e}catch{}B=!1}B||(p=null)}}else y=="mouseover"?p=c.fromElement:y=="mouseout"&&(p=c.toElement);this.relatedTarget=p,P?(this.clientX=P.clientX!==void 0?P.clientX:P.pageX,this.clientY=P.clientY!==void 0?P.clientY:P.pageY,this.screenX=P.screenX||0,this.screenY=P.screenY||0):(this.clientX=c.clientX!==void 0?c.clientX:c.pageX,this.clientY=c.clientY!==void 0?c.clientY:c.pageY,this.screenX=c.screenX||0,this.screenY=c.screenY||0),this.button=c.button,this.key=c.key||"",this.ctrlKey=c.ctrlKey,this.altKey=c.altKey,this.shiftKey=c.shiftKey,this.metaKey=c.metaKey,this.pointerId=c.pointerId||0,this.pointerType=typeof c.pointerType=="string"?c.pointerType:ye[c.pointerType]||"",this.state=c.state,this.i=c,c.defaultPrevented&&ge.aa.h.call(this)}}v(ge,K);var ye={2:"touch",3:"pen",4:"mouse"};ge.prototype.h=function(){ge.aa.h.call(this);var c=this.i;c.preventDefault?c.preventDefault():c.returnValue=!1};var Ce="closure_listenable_"+(1e6*Math.random()|0),He=0;function pt(c,p,y,P,B){this.listener=c,this.proxy=null,this.src=p,this.type=y,this.capture=!!P,this.ha=B,this.key=++He,this.da=this.fa=!1}function nt(c){c.da=!0,c.listener=null,c.proxy=null,c.src=null,c.ha=null}function Ke(c){this.src=c,this.g={},this.h=0}Ke.prototype.add=function(c,p,y,P,B){var z=c.toString();c=this.g[z],c||(c=this.g[z]=[],this.h++);var ie=Et(c,p,P,B);return-1<ie?(p=c[ie],y||(p.fa=!1)):(p=new pt(p,this.src,z,!!P,B),p.fa=y,c.push(p)),p};function We(c,p){var y=p.type;if(y in c.g){var P=c.g[y],B=Array.prototype.indexOf.call(P,p,void 0),z;(z=0<=B)&&Array.prototype.splice.call(P,B,1),z&&(nt(p),c.g[y].length==0&&(delete c.g[y],c.h--))}}function Et(c,p,y,P){for(var B=0;B<c.length;++B){var z=c[B];if(!z.da&&z.listener==p&&z.capture==!!y&&z.ha==P)return B}return-1}var gt="closure_lm_"+(1e6*Math.random()|0),Re={};function at(c,p,y,P,B){if(Array.isArray(p)){for(var z=0;z<p.length;z++)at(c,p[z],y,P,B);return null}return y=Ie(y),c&&c[Ce]?c.K(p,y,u(P)?!!P.capture:!1,B):g(c,p,y,!1,P,B)}function g(c,p,y,P,B,z){if(!p)throw Error("Invalid event type");var ie=u(B)?!!B.capture:!!B,Be=Z(c);if(Be||(c[gt]=Be=new Ke(c)),y=Be.add(p,y,P,ie,z),y.proxy)return y;if(P=b(),y.proxy=P,P.src=c,P.listener=y,c.addEventListener)be||(B=ie),B===void 0&&(B=!1),c.addEventListener(p.toString(),P,B);else if(c.attachEvent)c.attachEvent($(p.toString()),P);else if(c.addListener&&c.removeListener)c.addListener(P);else throw Error("addEventListener and attachEvent are unavailable.");return y}function b(){function c(y){return p.call(c.src,c.listener,y)}const p=ae;return c}function N(c,p,y,P,B){if(Array.isArray(p))for(var z=0;z<p.length;z++)N(c,p[z],y,P,B);else P=u(P)?!!P.capture:!!P,y=Ie(y),c&&c[Ce]?(c=c.i,p=String(p).toString(),p in c.g&&(z=c.g[p],y=Et(z,y,P,B),-1<y&&(nt(z[y]),Array.prototype.splice.call(z,y,1),z.length==0&&(delete c.g[p],c.h--)))):c&&(c=Z(c))&&(p=c.g[p.toString()],c=-1,p&&(c=Et(p,y,P,B)),(y=-1<c?p[c]:null)&&j(y))}function j(c){if(typeof c!="number"&&c&&!c.da){var p=c.src;if(p&&p[Ce])We(p.i,c);else{var y=c.type,P=c.proxy;p.removeEventListener?p.removeEventListener(y,P,c.capture):p.detachEvent?p.detachEvent($(y),P):p.addListener&&p.removeListener&&p.removeListener(P),(y=Z(p))?(We(y,c),y.h==0&&(y.src=null,p[gt]=null)):nt(c)}}}function $(c){return c in Re?Re[c]:Re[c]="on"+c}function ae(c,p){if(c.da)c=!0;else{p=new ge(p,this);var y=c.listener,P=c.ha||c.src;c.fa&&j(c),c=y.call(P,p)}return c}function Z(c){return c=c[gt],c instanceof Ke?c:null}var me="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ie(c){return typeof c=="function"?c:(c[me]||(c[me]=function(p){return c.handleEvent(p)}),c[me])}function _e(){re.call(this),this.i=new Ke(this),this.M=this,this.F=null}v(_e,re),_e.prototype[Ce]=!0,_e.prototype.removeEventListener=function(c,p,y,P){N(this,c,p,y,P)};function ce(c,p){var y,P=c.F;if(P)for(y=[];P;P=P.F)y.push(P);if(c=c.M,P=p.type||p,typeof p=="string")p=new K(p,c);else if(p instanceof K)p.target=p.target||c;else{var B=p;p=new K(P,c),M(p,B)}if(B=!0,y)for(var z=y.length-1;0<=z;z--){var ie=p.g=y[z];B=Ne(ie,P,!0,p)&&B}if(ie=p.g=c,B=Ne(ie,P,!0,p)&&B,B=Ne(ie,P,!1,p)&&B,y)for(z=0;z<y.length;z++)ie=p.g=y[z],B=Ne(ie,P,!1,p)&&B}_e.prototype.N=function(){if(_e.aa.N.call(this),this.i){var c=this.i,p;for(p in c.g){for(var y=c.g[p],P=0;P<y.length;P++)nt(y[P]);delete c.g[p],c.h--}}this.F=null},_e.prototype.K=function(c,p,y,P){return this.i.add(String(c),p,!1,y,P)},_e.prototype.L=function(c,p,y,P){return this.i.add(String(c),p,!0,y,P)};function Ne(c,p,y,P){if(p=c.i.g[String(p)],!p)return!0;p=p.concat();for(var B=!0,z=0;z<p.length;++z){var ie=p[z];if(ie&&!ie.da&&ie.capture==y){var Be=ie.listener,ct=ie.ha||ie.src;ie.fa&&We(c.i,ie),B=Be.call(ct,P)!==!1&&B}}return B&&!P.defaultPrevented}function _(c,p,y){if(typeof c=="function")y&&(c=f(c,y));else if(c&&typeof c.handleEvent=="function")c=f(c.handleEvent,c);else throw Error("Invalid listener argument");return 2147483647<Number(p)?-1:a.setTimeout(c,p||0)}function w(c){c.g=_(()=>{c.g=null,c.i&&(c.i=!1,w(c))},c.l);const p=c.h;c.h=null,c.m.apply(null,p)}class C extends re{constructor(p,y){super(),this.m=p,this.l=y,this.h=null,this.i=!1,this.g=null}j(p){this.h=arguments,this.g?this.i=!0:w(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function I(c){re.call(this),this.h=c,this.g={}}v(I,re);var H=[];function Q(c){J(c.g,function(p,y){this.g.hasOwnProperty(y)&&j(p)},c),c.g={}}I.prototype.N=function(){I.aa.N.call(this),Q(this)},I.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var de=a.JSON.stringify,ke=a.JSON.parse,ve=class{stringify(c){return a.JSON.stringify(c,void 0)}parse(c){return a.JSON.parse(c,void 0)}};function lt(){}lt.prototype.h=null;function Ge(c){return c.h||(c.h=c.i())}function At(){}var Mt={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Zt(){K.call(this,"d")}v(Zt,K);function Xt(){K.call(this,"c")}v(Xt,K);var Nt={},pn=null;function xt(){return pn=pn||new _e}Nt.La="serverreachability";function $o(c){K.call(this,Nt.La,c)}v($o,K);function gn(c){const p=xt();ce(p,new $o(p))}Nt.STAT_EVENT="statevent";function ea(c,p){K.call(this,Nt.STAT_EVENT,c),this.stat=p}v(ea,K);function bt(c){const p=xt();ce(p,new ea(p,c))}Nt.Ma="timingevent";function ta(c,p){K.call(this,Nt.Ma,c),this.size=p}v(ta,K);function mn(c,p){if(typeof c!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){c()},p)}function vn(){this.g=!0}vn.prototype.xa=function(){this.g=!1};function lh(c,p,y,P,B,z){c.info(function(){if(c.g)if(z)for(var ie="",Be=z.split("&"),ct=0;ct<Be.length;ct++){var Fe=Be[ct].split("=");if(1<Fe.length){var mt=Fe[0];Fe=Fe[1];var vt=mt.split("_");ie=2<=vt.length&&vt[1]=="type"?ie+(mt+"="+Fe+"&"):ie+(mt+"=redacted&")}}else ie=null;else ie=z;return"XMLHTTP REQ ("+P+") [attempt "+B+"]: "+p+`
`+y+`
`+ie})}function uh(c,p,y,P,B,z,ie){c.info(function(){return"XMLHTTP RESP ("+P+") [ attempt "+B+"]: "+p+`
`+y+`
`+z+" "+ie})}function Oi(c,p,y,P){c.info(function(){return"XMLHTTP TEXT ("+p+"): "+hh(c,y)+(P?" "+P:"")})}function ch(c,p){c.info(function(){return"TIMEOUT: "+p})}vn.prototype.info=function(){};function hh(c,p){if(!c.g)return p;if(!p)return null;try{var y=JSON.parse(p);if(y){for(c=0;c<y.length;c++)if(Array.isArray(y[c])){var P=y[c];if(!(2>P.length)){var B=P[1];if(Array.isArray(B)&&!(1>B.length)){var z=B[0];if(z!="noop"&&z!="stop"&&z!="close")for(var ie=1;ie<B.length;ie++)B[ie]=""}}}}return de(y)}catch{return p}}var ir={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},ia={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},vs;function nr(){}v(nr,lt),nr.prototype.g=function(){return new XMLHttpRequest},nr.prototype.i=function(){return{}},vs=new nr;function ii(c,p,y,P){this.j=c,this.i=p,this.l=y,this.R=P||1,this.U=new I(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new na}function na(){this.i=null,this.g="",this.h=!1}var ra={},ys={};function ws(c,p,y){c.L=1,c.v=ar(Kt(p)),c.m=y,c.P=!0,sa(c,null)}function sa(c,p){c.F=Date.now(),rr(c),c.A=Kt(c.v);var y=c.A,P=c.R;Array.isArray(P)||(P=[String(P)]),wa(y.i,"t",P),c.C=0,y=c.j.J,c.h=new na,c.g=La(c.j,y?p:null,!c.m),0<c.O&&(c.M=new C(f(c.Y,c,c.g),c.O)),p=c.U,y=c.g,P=c.ca;var B="readystatechange";Array.isArray(B)||(B&&(H[0]=B.toString()),B=H);for(var z=0;z<B.length;z++){var ie=at(y,B[z],P||p.handleEvent,!1,p.h||p);if(!ie)break;p.g[ie.key]=ie}p=c.H?S(c.H):{},c.m?(c.u||(c.u="POST"),p["Content-Type"]="application/x-www-form-urlencoded",c.g.ea(c.A,c.u,c.m,p)):(c.u="GET",c.g.ea(c.A,c.u,null,p)),gn(),lh(c.i,c.u,c.A,c.l,c.R,c.m)}ii.prototype.ca=function(c){c=c.target;const p=this.M;p&&Yt(c)==3?p.j():this.Y(c)},ii.prototype.Y=function(c){try{if(c==this.g)e:{const vt=Yt(this.g);var p=this.g.Ba();const Ni=this.g.Z();if(!(3>vt)&&(vt!=3||this.g&&(this.h.h||this.g.oa()||Pa(this.g)))){this.J||vt!=4||p==7||(p==8||0>=Ni?gn(3):gn(2)),_s(this);var y=this.g.Z();this.X=y;t:if(oa(this)){var P=Pa(this.g);c="";var B=P.length,z=Yt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Ei(this),yn(this);var ie="";break t}this.h.i=new a.TextDecoder}for(p=0;p<B;p++)this.h.h=!0,c+=this.h.i.decode(P[p],{stream:!(z&&p==B-1)});P.length=0,this.h.g+=c,this.C=0,ie=this.h.g}else ie=this.g.oa();if(this.o=y==200,uh(this.i,this.u,this.A,this.l,this.R,vt,y),this.o){if(this.T&&!this.K){t:{if(this.g){var Be,ct=this.g;if((Be=ct.g?ct.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!O(Be)){var Fe=Be;break t}}Fe=null}if(y=Fe)Oi(this.i,this.l,y,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ts(this,y);else{this.o=!1,this.s=3,bt(12),Ei(this),yn(this);break e}}if(this.P){y=!0;let kt;for(;!this.J&&this.C<ie.length;)if(kt=dh(this,ie),kt==ys){vt==4&&(this.s=4,bt(14),y=!1),Oi(this.i,this.l,null,"[Incomplete Response]");break}else if(kt==ra){this.s=4,bt(15),Oi(this.i,this.l,ie,"[Invalid Chunk]"),y=!1;break}else Oi(this.i,this.l,kt,null),Ts(this,kt);if(oa(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),vt!=4||ie.length!=0||this.h.h||(this.s=1,bt(16),y=!1),this.o=this.o&&y,!y)Oi(this.i,this.l,ie,"[Invalid Chunked Response]"),Ei(this),yn(this);else if(0<ie.length&&!this.W){this.W=!0;var mt=this.j;mt.g==this&&mt.ba&&!mt.M&&(mt.j.info("Great, no buffering proxy detected. Bytes received: "+ie.length),Cs(mt),mt.M=!0,bt(11))}}else Oi(this.i,this.l,ie,null),Ts(this,ie);vt==4&&Ei(this),this.o&&!this.J&&(vt==4?ka(this.j,this):(this.o=!1,rr(this)))}else Ih(this.g),y==400&&0<ie.indexOf("Unknown SID")?(this.s=3,bt(12)):(this.s=0,bt(13)),Ei(this),yn(this)}}}catch{}finally{}};function oa(c){return c.g?c.u=="GET"&&c.L!=2&&c.j.Ca:!1}function dh(c,p){var y=c.C,P=p.indexOf(`
`,y);return P==-1?ys:(y=Number(p.substring(y,P)),isNaN(y)?ra:(P+=1,P+y>p.length?ys:(p=p.slice(P,P+y),c.C=P+y,p)))}ii.prototype.cancel=function(){this.J=!0,Ei(this)};function rr(c){c.S=Date.now()+c.I,aa(c,c.I)}function aa(c,p){if(c.B!=null)throw Error("WatchDog timer not null");c.B=mn(f(c.ba,c),p)}function _s(c){c.B&&(a.clearTimeout(c.B),c.B=null)}ii.prototype.ba=function(){this.B=null;const c=Date.now();0<=c-this.S?(ch(this.i,this.A),this.L!=2&&(gn(),bt(17)),Ei(this),this.s=2,yn(this)):aa(this,this.S-c)};function yn(c){c.j.G==0||c.J||ka(c.j,c)}function Ei(c){_s(c);var p=c.M;p&&typeof p.ma=="function"&&p.ma(),c.M=null,Q(c.U),c.g&&(p=c.g,c.g=null,p.abort(),p.ma())}function Ts(c,p){try{var y=c.j;if(y.G!=0&&(y.g==c||Es(y.h,c))){if(!c.K&&Es(y.h,c)&&y.G==3){try{var P=y.Da.g.parse(p)}catch{P=null}if(Array.isArray(P)&&P.length==3){var B=P;if(B[0]==0){e:if(!y.u){if(y.g)if(y.g.F+3e3<c.F)fr(y),hr(y);else break e;Ps(y),bt(18)}}else y.za=B[1],0<y.za-y.T&&37500>B[2]&&y.F&&y.v==0&&!y.C&&(y.C=mn(f(y.Za,y),6e3));if(1>=ca(y.h)&&y.ca){try{y.ca()}catch{}y.ca=void 0}}else xi(y,11)}else if((c.K||y.g==c)&&fr(y),!O(p))for(B=y.Da.g.parse(p),p=0;p<B.length;p++){let Fe=B[p];if(y.T=Fe[0],Fe=Fe[1],y.G==2)if(Fe[0]=="c"){y.K=Fe[1],y.ia=Fe[2];const mt=Fe[3];mt!=null&&(y.la=mt,y.j.info("VER="+y.la));const vt=Fe[4];vt!=null&&(y.Aa=vt,y.j.info("SVER="+y.Aa));const Ni=Fe[5];Ni!=null&&typeof Ni=="number"&&0<Ni&&(P=1.5*Ni,y.L=P,y.j.info("backChannelRequestTimeoutMs_="+P)),P=y;const kt=c.g;if(kt){const gr=kt.g?kt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(gr){var z=P.h;z.g||gr.indexOf("spdy")==-1&&gr.indexOf("quic")==-1&&gr.indexOf("h2")==-1||(z.j=z.l,z.g=new Set,z.h&&(bs(z,z.h),z.h=null))}if(P.D){const Rs=kt.g?kt.g.getResponseHeader("X-HTTP-Session-Id"):null;Rs&&(P.ya=Rs,Ue(P.I,P.D,Rs))}}y.G=3,y.l&&y.l.ua(),y.ba&&(y.R=Date.now()-c.F,y.j.info("Handshake RTT: "+y.R+"ms")),P=y;var ie=c;if(P.qa=Va(P,P.J?P.ia:null,P.W),ie.K){ha(P.h,ie);var Be=ie,ct=P.L;ct&&(Be.I=ct),Be.B&&(_s(Be),rr(Be)),P.g=ie}else Da(P);0<y.i.length&&dr(y)}else Fe[0]!="stop"&&Fe[0]!="close"||xi(y,7);else y.G==3&&(Fe[0]=="stop"||Fe[0]=="close"?Fe[0]=="stop"?xi(y,7):Ss(y):Fe[0]!="noop"&&y.l&&y.l.ta(Fe),y.v=0)}}gn(4)}catch{}}var fh=class{constructor(c,p){this.g=c,this.map=p}};function la(c){this.l=c||10,a.PerformanceNavigationTiming?(c=a.performance.getEntriesByType("navigation"),c=0<c.length&&(c[0].nextHopProtocol=="hq"||c[0].nextHopProtocol=="h2")):c=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=c?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function ua(c){return c.h?!0:c.g?c.g.size>=c.j:!1}function ca(c){return c.h?1:c.g?c.g.size:0}function Es(c,p){return c.h?c.h==p:c.g?c.g.has(p):!1}function bs(c,p){c.g?c.g.add(p):c.h=p}function ha(c,p){c.h&&c.h==p?c.h=null:c.g&&c.g.has(p)&&c.g.delete(p)}la.prototype.cancel=function(){if(this.i=da(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const c of this.g.values())c.cancel();this.g.clear()}};function da(c){if(c.h!=null)return c.i.concat(c.h.D);if(c.g!=null&&c.g.size!==0){let p=c.i;for(const y of c.g.values())p=p.concat(y.D);return p}return E(c.i)}function ph(c){if(c.V&&typeof c.V=="function")return c.V();if(typeof Map<"u"&&c instanceof Map||typeof Set<"u"&&c instanceof Set)return Array.from(c.values());if(typeof c=="string")return c.split("");if(l(c)){for(var p=[],y=c.length,P=0;P<y;P++)p.push(c[P]);return p}p=[],y=0;for(P in c)p[y++]=c[P];return p}function gh(c){if(c.na&&typeof c.na=="function")return c.na();if(!c.V||typeof c.V!="function"){if(typeof Map<"u"&&c instanceof Map)return Array.from(c.keys());if(!(typeof Set<"u"&&c instanceof Set)){if(l(c)||typeof c=="string"){var p=[];c=c.length;for(var y=0;y<c;y++)p.push(y);return p}p=[],y=0;for(const P in c)p[y++]=P;return p}}}function fa(c,p){if(c.forEach&&typeof c.forEach=="function")c.forEach(p,void 0);else if(l(c)||typeof c=="string")Array.prototype.forEach.call(c,p,void 0);else for(var y=gh(c),P=ph(c),B=P.length,z=0;z<B;z++)p.call(void 0,P[z],y&&y[z],c)}var pa=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function mh(c,p){if(c){c=c.split("&");for(var y=0;y<c.length;y++){var P=c[y].indexOf("="),B=null;if(0<=P){var z=c[y].substring(0,P);B=c[y].substring(P+1)}else z=c[y];p(z,B?decodeURIComponent(B.replace(/\+/g," ")):"")}}}function bi(c){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,c instanceof bi){this.h=c.h,sr(this,c.j),this.o=c.o,this.g=c.g,or(this,c.s),this.l=c.l;var p=c.i,y=new Tn;y.i=p.i,p.g&&(y.g=new Map(p.g),y.h=p.h),ga(this,y),this.m=c.m}else c&&(p=String(c).match(pa))?(this.h=!1,sr(this,p[1]||"",!0),this.o=wn(p[2]||""),this.g=wn(p[3]||"",!0),or(this,p[4]),this.l=wn(p[5]||"",!0),ga(this,p[6]||"",!0),this.m=wn(p[7]||"")):(this.h=!1,this.i=new Tn(null,this.h))}bi.prototype.toString=function(){var c=[],p=this.j;p&&c.push(_n(p,ma,!0),":");var y=this.g;return(y||p=="file")&&(c.push("//"),(p=this.o)&&c.push(_n(p,ma,!0),"@"),c.push(encodeURIComponent(String(y)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),y=this.s,y!=null&&c.push(":",String(y))),(y=this.l)&&(this.g&&y.charAt(0)!="/"&&c.push("/"),c.push(_n(y,y.charAt(0)=="/"?wh:yh,!0))),(y=this.i.toString())&&c.push("?",y),(y=this.m)&&c.push("#",_n(y,Th)),c.join("")};function Kt(c){return new bi(c)}function sr(c,p,y){c.j=y?wn(p,!0):p,c.j&&(c.j=c.j.replace(/:$/,""))}function or(c,p){if(p){if(p=Number(p),isNaN(p)||0>p)throw Error("Bad port number "+p);c.s=p}else c.s=null}function ga(c,p,y){p instanceof Tn?(c.i=p,Eh(c.i,c.h)):(y||(p=_n(p,_h)),c.i=new Tn(p,c.h))}function Ue(c,p,y){c.i.set(p,y)}function ar(c){return Ue(c,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),c}function wn(c,p){return c?p?decodeURI(c.replace(/%25/g,"%2525")):decodeURIComponent(c):""}function _n(c,p,y){return typeof c=="string"?(c=encodeURI(c).replace(p,vh),y&&(c=c.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),c):null}function vh(c){return c=c.charCodeAt(0),"%"+(c>>4&15).toString(16)+(c&15).toString(16)}var ma=/[#\/\?@]/g,yh=/[#\?:]/g,wh=/[#\?]/g,_h=/[#\?@]/g,Th=/#/g;function Tn(c,p){this.h=this.g=null,this.i=c||null,this.j=!!p}function ni(c){c.g||(c.g=new Map,c.h=0,c.i&&mh(c.i,function(p,y){c.add(decodeURIComponent(p.replace(/\+/g," ")),y)}))}s=Tn.prototype,s.add=function(c,p){ni(this),this.i=null,c=Vi(this,c);var y=this.g.get(c);return y||this.g.set(c,y=[]),y.push(p),this.h+=1,this};function va(c,p){ni(c),p=Vi(c,p),c.g.has(p)&&(c.i=null,c.h-=c.g.get(p).length,c.g.delete(p))}function ya(c,p){return ni(c),p=Vi(c,p),c.g.has(p)}s.forEach=function(c,p){ni(this),this.g.forEach(function(y,P){y.forEach(function(B){c.call(p,B,P,this)},this)},this)},s.na=function(){ni(this);const c=Array.from(this.g.values()),p=Array.from(this.g.keys()),y=[];for(let P=0;P<p.length;P++){const B=c[P];for(let z=0;z<B.length;z++)y.push(p[P])}return y},s.V=function(c){ni(this);let p=[];if(typeof c=="string")ya(this,c)&&(p=p.concat(this.g.get(Vi(this,c))));else{c=Array.from(this.g.values());for(let y=0;y<c.length;y++)p=p.concat(c[y])}return p},s.set=function(c,p){return ni(this),this.i=null,c=Vi(this,c),ya(this,c)&&(this.h-=this.g.get(c).length),this.g.set(c,[p]),this.h+=1,this},s.get=function(c,p){return c?(c=this.V(c),0<c.length?String(c[0]):p):p};function wa(c,p,y){va(c,p),0<y.length&&(c.i=null,c.g.set(Vi(c,p),E(y)),c.h+=y.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const c=[],p=Array.from(this.g.keys());for(var y=0;y<p.length;y++){var P=p[y];const z=encodeURIComponent(String(P)),ie=this.V(P);for(P=0;P<ie.length;P++){var B=z;ie[P]!==""&&(B+="="+encodeURIComponent(String(ie[P]))),c.push(B)}}return this.i=c.join("&")};function Vi(c,p){return p=String(p),c.j&&(p=p.toLowerCase()),p}function Eh(c,p){p&&!c.j&&(ni(c),c.i=null,c.g.forEach(function(y,P){var B=P.toLowerCase();P!=B&&(va(this,P),wa(this,B,y))},c)),c.j=p}function bh(c,p){const y=new vn;if(a.Image){const P=new Image;P.onload=m(ri,y,"TestLoadImage: loaded",!0,p,P),P.onerror=m(ri,y,"TestLoadImage: error",!1,p,P),P.onabort=m(ri,y,"TestLoadImage: abort",!1,p,P),P.ontimeout=m(ri,y,"TestLoadImage: timeout",!1,p,P),a.setTimeout(function(){P.ontimeout&&P.ontimeout()},1e4),P.src=c}else p(!1)}function xh(c,p){const y=new vn,P=new AbortController,B=setTimeout(()=>{P.abort(),ri(y,"TestPingServer: timeout",!1,p)},1e4);fetch(c,{signal:P.signal}).then(z=>{clearTimeout(B),z.ok?ri(y,"TestPingServer: ok",!0,p):ri(y,"TestPingServer: server error",!1,p)}).catch(()=>{clearTimeout(B),ri(y,"TestPingServer: error",!1,p)})}function ri(c,p,y,P,B){try{B&&(B.onload=null,B.onerror=null,B.onabort=null,B.ontimeout=null),P(y)}catch{}}function Sh(){this.g=new ve}function Ph(c,p,y){const P=y||"";try{fa(c,function(B,z){let ie=B;u(B)&&(ie=de(B)),p.push(P+z+"="+encodeURIComponent(ie))})}catch(B){throw p.push(P+"type="+encodeURIComponent("_badmap")),B}}function lr(c){this.l=c.Ub||null,this.j=c.eb||!1}v(lr,lt),lr.prototype.g=function(){return new ur(this.l,this.j)},lr.prototype.i=function(c){return function(){return c}}({});function ur(c,p){_e.call(this),this.D=c,this.o=p,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}v(ur,_e),s=ur.prototype,s.open=function(c,p){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=c,this.A=p,this.readyState=1,bn(this)},s.send=function(c){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const p={headers:this.u,method:this.B,credentials:this.m,cache:void 0};c&&(p.body=c),(this.D||a).fetch(new Request(this.A,p)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,En(this)),this.readyState=0},s.Sa=function(c){if(this.g&&(this.l=c,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=c.headers,this.readyState=2,bn(this)),this.g&&(this.readyState=3,bn(this),this.g)))if(this.responseType==="arraybuffer")c.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in c){if(this.j=c.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;_a(this)}else c.text().then(this.Ra.bind(this),this.ga.bind(this))};function _a(c){c.j.read().then(c.Pa.bind(c)).catch(c.ga.bind(c))}s.Pa=function(c){if(this.g){if(this.o&&c.value)this.response.push(c.value);else if(!this.o){var p=c.value?c.value:new Uint8Array(0);(p=this.v.decode(p,{stream:!c.done}))&&(this.response=this.responseText+=p)}c.done?En(this):bn(this),this.readyState==3&&_a(this)}},s.Ra=function(c){this.g&&(this.response=this.responseText=c,En(this))},s.Qa=function(c){this.g&&(this.response=c,En(this))},s.ga=function(){this.g&&En(this)};function En(c){c.readyState=4,c.l=null,c.j=null,c.v=null,bn(c)}s.setRequestHeader=function(c,p){this.u.append(c,p)},s.getResponseHeader=function(c){return this.h&&this.h.get(c.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const c=[],p=this.h.entries();for(var y=p.next();!y.done;)y=y.value,c.push(y[0]+": "+y[1]),y=p.next();return c.join(`\r
`)};function bn(c){c.onreadystatechange&&c.onreadystatechange.call(c)}Object.defineProperty(ur.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(c){this.m=c?"include":"same-origin"}});function Ta(c){let p="";return J(c,function(y,P){p+=P,p+=":",p+=y,p+=`\r
`}),p}function xs(c,p,y){e:{for(P in y){var P=!1;break e}P=!0}P||(y=Ta(y),typeof c=="string"?y!=null&&encodeURIComponent(String(y)):Ue(c,p,y))}function Xe(c){_e.call(this),this.headers=new Map,this.o=c||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}v(Xe,_e);var Ch=/^https?$/i,Rh=["POST","PUT"];s=Xe.prototype,s.Ha=function(c){this.J=c},s.ea=function(c,p,y,P){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+c);p=p?p.toUpperCase():"GET",this.D=c,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():vs.g(),this.v=this.o?Ge(this.o):Ge(vs),this.g.onreadystatechange=f(this.Ea,this);try{this.B=!0,this.g.open(p,String(c),!0),this.B=!1}catch(z){Ea(this,z);return}if(c=y||"",y=new Map(this.headers),P)if(Object.getPrototypeOf(P)===Object.prototype)for(var B in P)y.set(B,P[B]);else if(typeof P.keys=="function"&&typeof P.get=="function")for(const z of P.keys())y.set(z,P.get(z));else throw Error("Unknown input type for opt_headers: "+String(P));P=Array.from(y.keys()).find(z=>z.toLowerCase()=="content-type"),B=a.FormData&&c instanceof a.FormData,!(0<=Array.prototype.indexOf.call(Rh,p,void 0))||P||B||y.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[z,ie]of y)this.g.setRequestHeader(z,ie);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Sa(this),this.u=!0,this.g.send(c),this.u=!1}catch(z){Ea(this,z)}};function Ea(c,p){c.h=!1,c.g&&(c.j=!0,c.g.abort(),c.j=!1),c.l=p,c.m=5,ba(c),cr(c)}function ba(c){c.A||(c.A=!0,ce(c,"complete"),ce(c,"error"))}s.abort=function(c){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=c||7,ce(this,"complete"),ce(this,"abort"),cr(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),cr(this,!0)),Xe.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?xa(this):this.bb())},s.bb=function(){xa(this)};function xa(c){if(c.h&&typeof o<"u"&&(!c.v[1]||Yt(c)!=4||c.Z()!=2)){if(c.u&&Yt(c)==4)_(c.Ea,0,c);else if(ce(c,"readystatechange"),Yt(c)==4){c.h=!1;try{const ie=c.Z();e:switch(ie){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var p=!0;break e;default:p=!1}var y;if(!(y=p)){var P;if(P=ie===0){var B=String(c.D).match(pa)[1]||null;!B&&a.self&&a.self.location&&(B=a.self.location.protocol.slice(0,-1)),P=!Ch.test(B?B.toLowerCase():"")}y=P}if(y)ce(c,"complete"),ce(c,"success");else{c.m=6;try{var z=2<Yt(c)?c.g.statusText:""}catch{z=""}c.l=z+" ["+c.Z()+"]",ba(c)}}finally{cr(c)}}}}function cr(c,p){if(c.g){Sa(c);const y=c.g,P=c.v[0]?()=>{}:null;c.g=null,c.v=null,p||ce(c,"ready");try{y.onreadystatechange=P}catch{}}}function Sa(c){c.I&&(a.clearTimeout(c.I),c.I=null)}s.isActive=function(){return!!this.g};function Yt(c){return c.g?c.g.readyState:0}s.Z=function(){try{return 2<Yt(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(c){if(this.g){var p=this.g.responseText;return c&&p.indexOf(c)==0&&(p=p.substring(c.length)),ke(p)}};function Pa(c){try{if(!c.g)return null;if("response"in c.g)return c.g.response;switch(c.H){case"":case"text":return c.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in c.g)return c.g.mozResponseArrayBuffer}return null}catch{return null}}function Ih(c){const p={};c=(c.g&&2<=Yt(c)&&c.g.getAllResponseHeaders()||"").split(`\r
`);for(let P=0;P<c.length;P++){if(O(c[P]))continue;var y=k(c[P]);const B=y[0];if(y=y[1],typeof y!="string")continue;y=y.trim();const z=p[B]||[];p[B]=z,z.push(y)}A(p,function(P){return P.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function xn(c,p,y){return y&&y.internalChannelParams&&y.internalChannelParams[c]||p}function Ca(c){this.Aa=0,this.i=[],this.j=new vn,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=xn("failFast",!1,c),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=xn("baseRetryDelayMs",5e3,c),this.cb=xn("retryDelaySeedMs",1e4,c),this.Wa=xn("forwardChannelMaxRetries",2,c),this.wa=xn("forwardChannelRequestTimeoutMs",2e4,c),this.pa=c&&c.xmlHttpFactory||void 0,this.Xa=c&&c.Tb||void 0,this.Ca=c&&c.useFetchStreams||!1,this.L=void 0,this.J=c&&c.supportsCrossDomainXhr||!1,this.K="",this.h=new la(c&&c.concurrentRequestLimit),this.Da=new Sh,this.P=c&&c.fastHandshake||!1,this.O=c&&c.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=c&&c.Rb||!1,c&&c.xa&&this.j.xa(),c&&c.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&c&&c.detectBufferingProxy||!1,this.ja=void 0,c&&c.longPollingTimeout&&0<c.longPollingTimeout&&(this.ja=c.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=Ca.prototype,s.la=8,s.G=1,s.connect=function(c,p,y,P){bt(0),this.W=c,this.H=p||{},y&&P!==void 0&&(this.H.OSID=y,this.H.OAID=P),this.F=this.X,this.I=Va(this,null,this.W),dr(this)};function Ss(c){if(Ra(c),c.G==3){var p=c.U++,y=Kt(c.I);if(Ue(y,"SID",c.K),Ue(y,"RID",p),Ue(y,"TYPE","terminate"),Sn(c,y),p=new ii(c,c.j,p),p.L=2,p.v=ar(Kt(y)),y=!1,a.navigator&&a.navigator.sendBeacon)try{y=a.navigator.sendBeacon(p.v.toString(),"")}catch{}!y&&a.Image&&(new Image().src=p.v,y=!0),y||(p.g=La(p.j,null),p.g.ea(p.v)),p.F=Date.now(),rr(p)}Oa(c)}function hr(c){c.g&&(Cs(c),c.g.cancel(),c.g=null)}function Ra(c){hr(c),c.u&&(a.clearTimeout(c.u),c.u=null),fr(c),c.h.cancel(),c.s&&(typeof c.s=="number"&&a.clearTimeout(c.s),c.s=null)}function dr(c){if(!ua(c.h)&&!c.s){c.s=!0;var p=c.Ga;se||U(),W||(se(),W=!0),ne.add(p,c),c.B=0}}function Ah(c,p){return ca(c.h)>=c.h.j-(c.s?1:0)?!1:c.s?(c.i=p.D.concat(c.i),!0):c.G==1||c.G==2||c.B>=(c.Va?0:c.Wa)?!1:(c.s=mn(f(c.Ga,c,p),Fa(c,c.B)),c.B++,!0)}s.Ga=function(c){if(this.s)if(this.s=null,this.G==1){if(!c){this.U=Math.floor(1e5*Math.random()),c=this.U++;const B=new ii(this,this.j,c);let z=this.o;if(this.S&&(z?(z=S(z),M(z,this.S)):z=this.S),this.m!==null||this.O||(B.H=z,z=null),this.P)e:{for(var p=0,y=0;y<this.i.length;y++){t:{var P=this.i[y];if("__data__"in P.map&&(P=P.map.__data__,typeof P=="string")){P=P.length;break t}P=void 0}if(P===void 0)break;if(p+=P,4096<p){p=y;break e}if(p===4096||y===this.i.length-1){p=y+1;break e}}p=1e3}else p=1e3;p=Aa(this,B,p),y=Kt(this.I),Ue(y,"RID",c),Ue(y,"CVER",22),this.D&&Ue(y,"X-HTTP-Session-Id",this.D),Sn(this,y),z&&(this.O?p="headers="+encodeURIComponent(String(Ta(z)))+"&"+p:this.m&&xs(y,this.m,z)),bs(this.h,B),this.Ua&&Ue(y,"TYPE","init"),this.P?(Ue(y,"$req",p),Ue(y,"SID","null"),B.T=!0,ws(B,y,null)):ws(B,y,p),this.G=2}}else this.G==3&&(c?Ia(this,c):this.i.length==0||ua(this.h)||Ia(this))};function Ia(c,p){var y;p?y=p.l:y=c.U++;const P=Kt(c.I);Ue(P,"SID",c.K),Ue(P,"RID",y),Ue(P,"AID",c.T),Sn(c,P),c.m&&c.o&&xs(P,c.m,c.o),y=new ii(c,c.j,y,c.B+1),c.m===null&&(y.H=c.o),p&&(c.i=p.D.concat(c.i)),p=Aa(c,y,1e3),y.I=Math.round(.5*c.wa)+Math.round(.5*c.wa*Math.random()),bs(c.h,y),ws(y,P,p)}function Sn(c,p){c.H&&J(c.H,function(y,P){Ue(p,P,y)}),c.l&&fa({},function(y,P){Ue(p,P,y)})}function Aa(c,p,y){y=Math.min(c.i.length,y);var P=c.l?f(c.l.Na,c.l,c):null;e:{var B=c.i;let z=-1;for(;;){const ie=["count="+y];z==-1?0<y?(z=B[0].g,ie.push("ofs="+z)):z=0:ie.push("ofs="+z);let Be=!0;for(let ct=0;ct<y;ct++){let Fe=B[ct].g;const mt=B[ct].map;if(Fe-=z,0>Fe)z=Math.max(0,B[ct].g-100),Be=!1;else try{Ph(mt,ie,"req"+Fe+"_")}catch{P&&P(mt)}}if(Be){P=ie.join("&");break e}}}return c=c.i.splice(0,y),p.D=c,P}function Da(c){if(!c.g&&!c.u){c.Y=1;var p=c.Fa;se||U(),W||(se(),W=!0),ne.add(p,c),c.v=0}}function Ps(c){return c.g||c.u||3<=c.v?!1:(c.Y++,c.u=mn(f(c.Fa,c),Fa(c,c.v)),c.v++,!0)}s.Fa=function(){if(this.u=null,Ma(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var c=2*this.R;this.j.info("BP detection timer enabled: "+c),this.A=mn(f(this.ab,this),c)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,bt(10),hr(this),Ma(this))};function Cs(c){c.A!=null&&(a.clearTimeout(c.A),c.A=null)}function Ma(c){c.g=new ii(c,c.j,"rpc",c.Y),c.m===null&&(c.g.H=c.o),c.g.O=0;var p=Kt(c.qa);Ue(p,"RID","rpc"),Ue(p,"SID",c.K),Ue(p,"AID",c.T),Ue(p,"CI",c.F?"0":"1"),!c.F&&c.ja&&Ue(p,"TO",c.ja),Ue(p,"TYPE","xmlhttp"),Sn(c,p),c.m&&c.o&&xs(p,c.m,c.o),c.L&&(c.g.I=c.L);var y=c.g;c=c.ia,y.L=1,y.v=ar(Kt(p)),y.m=null,y.P=!0,sa(y,c)}s.Za=function(){this.C!=null&&(this.C=null,hr(this),Ps(this),bt(19))};function fr(c){c.C!=null&&(a.clearTimeout(c.C),c.C=null)}function ka(c,p){var y=null;if(c.g==p){fr(c),Cs(c),c.g=null;var P=2}else if(Es(c.h,p))y=p.D,ha(c.h,p),P=1;else return;if(c.G!=0){if(p.o)if(P==1){y=p.m?p.m.length:0,p=Date.now()-p.F;var B=c.B;P=xt(),ce(P,new ta(P,y)),dr(c)}else Da(c);else if(B=p.s,B==3||B==0&&0<p.X||!(P==1&&Ah(c,p)||P==2&&Ps(c)))switch(y&&0<y.length&&(p=c.h,p.i=p.i.concat(y)),B){case 1:xi(c,5);break;case 4:xi(c,10);break;case 3:xi(c,6);break;default:xi(c,2)}}}function Fa(c,p){let y=c.Ta+Math.floor(Math.random()*c.cb);return c.isActive()||(y*=2),y*p}function xi(c,p){if(c.j.info("Error code "+p),p==2){var y=f(c.fb,c),P=c.Xa;const B=!P;P=new bi(P||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||sr(P,"https"),ar(P),B?bh(P.toString(),y):xh(P.toString(),y)}else bt(2);c.G=0,c.l&&c.l.sa(p),Oa(c),Ra(c)}s.fb=function(c){c?(this.j.info("Successfully pinged google.com"),bt(2)):(this.j.info("Failed to ping google.com"),bt(1))};function Oa(c){if(c.G=0,c.ka=[],c.l){const p=da(c.h);(p.length!=0||c.i.length!=0)&&(T(c.ka,p),T(c.ka,c.i),c.h.i.length=0,E(c.i),c.i.length=0),c.l.ra()}}function Va(c,p,y){var P=y instanceof bi?Kt(y):new bi(y);if(P.g!="")p&&(P.g=p+"."+P.g),or(P,P.s);else{var B=a.location;P=B.protocol,p=p?p+"."+B.hostname:B.hostname,B=+B.port;var z=new bi(null);P&&sr(z,P),p&&(z.g=p),B&&or(z,B),y&&(z.l=y),P=z}return y=c.D,p=c.ya,y&&p&&Ue(P,y,p),Ue(P,"VER",c.la),Sn(c,P),P}function La(c,p,y){if(p&&!c.J)throw Error("Can't create secondary domain capable XhrIo object.");return p=c.Ca&&!c.pa?new Xe(new lr({eb:y})):new Xe(c.pa),p.Ha(c.J),p}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function Na(){}s=Na.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function pr(){}pr.prototype.g=function(c,p){return new Rt(c,p)};function Rt(c,p){_e.call(this),this.g=new Ca(p),this.l=c,this.h=p&&p.messageUrlParams||null,c=p&&p.messageHeaders||null,p&&p.clientProtocolHeaderRequired&&(c?c["X-Client-Protocol"]="webchannel":c={"X-Client-Protocol":"webchannel"}),this.g.o=c,c=p&&p.initMessageHeaders||null,p&&p.messageContentType&&(c?c["X-WebChannel-Content-Type"]=p.messageContentType:c={"X-WebChannel-Content-Type":p.messageContentType}),p&&p.va&&(c?c["X-WebChannel-Client-Profile"]=p.va:c={"X-WebChannel-Client-Profile":p.va}),this.g.S=c,(c=p&&p.Sb)&&!O(c)&&(this.g.m=c),this.v=p&&p.supportsCrossDomainXhr||!1,this.u=p&&p.sendRawJson||!1,(p=p&&p.httpSessionIdParam)&&!O(p)&&(this.g.D=p,c=this.h,c!==null&&p in c&&(c=this.h,p in c&&delete c[p])),this.j=new Li(this)}v(Rt,_e),Rt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Rt.prototype.close=function(){Ss(this.g)},Rt.prototype.o=function(c){var p=this.g;if(typeof c=="string"){var y={};y.__data__=c,c=y}else this.u&&(y={},y.__data__=de(c),c=y);p.i.push(new fh(p.Ya++,c)),p.G==3&&dr(p)},Rt.prototype.N=function(){this.g.l=null,delete this.j,Ss(this.g),delete this.g,Rt.aa.N.call(this)};function Ba(c){Zt.call(this),c.__headers__&&(this.headers=c.__headers__,this.statusCode=c.__status__,delete c.__headers__,delete c.__status__);var p=c.__sm__;if(p){e:{for(const y in p){c=y;break e}c=void 0}(this.i=c)&&(c=this.i,p=p!==null&&c in p?p[c]:void 0),this.data=p}else this.data=c}v(Ba,Zt);function za(){Xt.call(this),this.status=1}v(za,Xt);function Li(c){this.g=c}v(Li,Na),Li.prototype.ua=function(){ce(this.g,"a")},Li.prototype.ta=function(c){ce(this.g,new Ba(c))},Li.prototype.sa=function(c){ce(this.g,new za)},Li.prototype.ra=function(){ce(this.g,"b")},pr.prototype.createWebChannel=pr.prototype.g,Rt.prototype.send=Rt.prototype.o,Rt.prototype.open=Rt.prototype.m,Rt.prototype.close=Rt.prototype.close,Nu=function(){return new pr},Lu=function(){return xt()},Vu=Nt,Zs={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},ir.NO_ERROR=0,ir.TIMEOUT=8,ir.HTTP_ERROR=6,Sr=ir,ia.COMPLETE="complete",Ou=ia,At.EventType=Mt,Mt.OPEN="a",Mt.CLOSE="b",Mt.ERROR="c",Mt.MESSAGE="d",_e.prototype.listen=_e.prototype.K,Pn=At,Xe.prototype.listenOnce=Xe.prototype.L,Xe.prototype.getLastError=Xe.prototype.Ka,Xe.prototype.getLastErrorCode=Xe.prototype.Ba,Xe.prototype.getStatus=Xe.prototype.Z,Xe.prototype.getResponseJson=Xe.prototype.Oa,Xe.prototype.getResponseText=Xe.prototype.oa,Xe.prototype.send=Xe.prototype.ea,Xe.prototype.setWithCredentials=Xe.prototype.Ha,Fu=Xe}).apply(typeof yr<"u"?yr:typeof self<"u"?self:typeof window<"u"?window:{});const al="@firebase/firestore",ll="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wt{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}wt.UNAUTHENTICATED=new wt(null),wt.GOOGLE_CREDENTIALS=new wt("google-credentials-uid"),wt.FIRST_PARTY=new wt("first-party-uid"),wt.MOCK_USER=new wt("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let un="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ai=new Cu("@firebase/firestore");function Hi(){return Ai.logLevel}function ue(s,...t){if(Ai.logLevel<=Me.DEBUG){const e=t.map(yo);Ai.debug(`Firestore (${un}): ${s}`,...e)}}function ei(s,...t){if(Ai.logLevel<=Me.ERROR){const e=t.map(yo);Ai.error(`Firestore (${un}): ${s}`,...e)}}function hi(s,...t){if(Ai.logLevel<=Me.WARN){const e=t.map(yo);Ai.warn(`Firestore (${un}): ${s}`,...e)}}function yo(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function we(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,Bu(s,i,e)}function Bu(s,t,e){let i=`FIRESTORE (${un}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw ei(i),new Error(i)}function Le(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||Bu(t,n,i)}function Ee(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const q={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class le extends ln{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ri{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zu{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class qp{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(wt.UNAUTHENTICATED))}shutdown(){}}class Zp{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class Xp{constructor(t){this.t=t,this.currentUser=wt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){Le(this.o===void 0,42304);let i=this.i;const n=l=>this.i!==i?(i=this.i,e(l)):Promise.resolve();let r=new Ri;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Ri,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const l=r;t.enqueueRetryable(async()=>{await l.promise,await n(this.currentUser)})},a=l=>{ue("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=l,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(l=>a(l)),setTimeout(()=>{if(!this.auth){const l=this.t.getImmediate({optional:!0});l?a(l):(ue("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Ri)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(ue("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(Le(typeof i.accessToken=="string",31837,{l:i}),new zu(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return Le(t===null||typeof t=="string",2055,{h:t}),new wt(t)}}class Kp{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=wt.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Yp{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new Kp(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(wt.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class ul{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Qp{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,Dp(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){Le(this.o===void 0,3512);const i=r=>{r.error!=null&&ue("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,ue("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{ue("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):ue("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new ul(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(Le(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new ul(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Jp(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Hu(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wo{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=Jp(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function Se(s,t){return s<t?-1:s>t?1:0}function Xs(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return Se(i,n);{const r=Hu(),o=$p(r.encode(cl(s,e)),r.encode(cl(t,e)));return o!==0?o:Se(i,n)}}e+=i>65535?2:1}return Se(s.length,t.length)}function cl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function $p(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return Se(s[e],t[e]);return Se(s.length,t.length)}function tn(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hl="__name__";class Bt{constructor(t,e,i){e===void 0?e=0:e>t.length&&we(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&we(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return Bt.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Bt?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=Bt.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return Se(t.length,e.length)}static compareSegments(t,e){const i=Bt.isNumericId(t),n=Bt.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?Bt.extractNumericId(t).compare(Bt.extractNumericId(e)):Xs(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return li.fromString(t.substring(4,t.length-2))}}class ze extends Bt{construct(t,e,i){return new ze(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new le(q.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new ze(e)}static emptyPath(){return new ze([])}}const eg=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class dt extends Bt{construct(t,e,i){return new dt(t,e,i)}static isValidIdentifier(t){return eg.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),dt.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===hl}static keyField(){return new dt([hl])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new le(q.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new le(q.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const l=t[n+1];if(l!=="\\"&&l!=="."&&l!=="`")throw new le(q.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=l,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new le(q.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new dt(e)}static emptyPath(){return new dt([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pe{constructor(t){this.path=t}static fromPath(t){return new pe(ze.fromString(t))}static fromName(t){return new pe(ze.fromString(t).popFirst(5))}static empty(){return new pe(ze.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&ze.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return ze.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new pe(new ze(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Uu(s,t,e){if(!e)throw new le(q.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function tg(s,t,e,i){if(t===!0&&i===!0)throw new le(q.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function dl(s){if(!pe.isDocumentKey(s))throw new le(q.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function fl(s){if(pe.isDocumentKey(s))throw new le(q.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function ju(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function es(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":we(12329,{type:typeof s})}function ui(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new le(q.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=es(s);throw new le(q.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function tt(s,t){const e={typeString:s};return t&&(e.value=t),e}function Yn(s,t){if(!ju(s))throw new le(q.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new le(q.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pl=-62135596800,gl=1e6;class je{static now(){return je.fromMillis(Date.now())}static fromDate(t){return je.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*gl);return new je(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new le(q.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new le(q.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<pl)throw new le(q.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new le(q.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/gl}_compareTo(t){return this.seconds===t.seconds?Se(this.nanoseconds,t.nanoseconds):Se(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:je._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(Yn(t,je._jsonSchema))return new je(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-pl;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}je._jsonSchemaVersion="firestore/timestamp/1.0",je._jsonSchema={type:tt("string",je._jsonSchemaVersion),seconds:tt("number"),nanoseconds:tt("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Te{static fromTimestamp(t){return new Te(t)}static min(){return new Te(new je(0,0))}static max(){return new Te(new je(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hn=-1;function ig(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=Te.fromTimestamp(i===1e9?new je(e+1,0):new je(e,i));return new di(n,pe.empty(),t)}function ng(s){return new di(s.readTime,s.key,Hn)}class di{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new di(Te.min(),pe.empty(),Hn)}static max(){return new di(Te.max(),pe.empty(),Hn)}}function rg(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=pe.comparator(s.documentKey,t.documentKey),e!==0?e:Se(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sg="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class og{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function cn(s){if(s.code!==q.FAILED_PRECONDITION||s.message!==sg)throw s;ue("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class X{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&we(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new X((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof X?e:X.resolve(e)}catch(e){return X.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):X.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):X.reject(e)}static resolve(t){return new X((e,i)=>{e(t)})}static reject(t){return new X((e,i)=>{i(t)})}static waitFor(t){return new X((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},l=>i(l))}),o=!0,r===n&&e()})}static or(t){let e=X.resolve(!1);for(const i of t)e=e.next(n=>n?X.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new X((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let l=0;l<r;l++){const u=l;e(t[u]).next(h=>{o[u]=h,++a,a===r&&i(o)},h=>n(h))}})}static doWhile(t,e){return new X((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function ag(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function hn(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ts{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}ts.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _o=-1;function is(s){return s==null}function Ur(s){return s===0&&1/s==-1/0}function lg(s){return typeof s=="number"&&Number.isInteger(s)&&!Ur(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wu="";function ug(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=ml(t)),t=cg(s.get(e),t);return ml(t)}function cg(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case Wu:e+="";break;default:e+=r}}return e}function ml(s){return s+Wu+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vl(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function _i(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function Gu(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ze{constructor(t,e){this.comparator=t,this.root=e||ht.EMPTY}insert(t,e){return new Ze(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ht.BLACK,null,null))}remove(t){return new Ze(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ht.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new wr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new wr(this.root,t,this.comparator,!1)}getReverseIterator(){return new wr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new wr(this.root,t,this.comparator,!0)}}class wr{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class ht{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??ht.RED,this.left=n??ht.EMPTY,this.right=r??ht.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new ht(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return ht.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return ht.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,ht.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,ht.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw we(43730,{key:this.key,value:this.value});if(this.right.isRed())throw we(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw we(27949);return t+(this.isRed()?0:1)}}ht.EMPTY=null,ht.RED=!0,ht.BLACK=!1;ht.EMPTY=new class{constructor(){this.size=0}get key(){throw we(57766)}get value(){throw we(16141)}get color(){throw we(16727)}get left(){throw we(29726)}get right(){throw we(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new ht(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ot{constructor(t){this.comparator=t,this.data=new Ze(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new yl(this.data.getIterator())}getIteratorFrom(t){return new yl(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof ot)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new ot(this.comparator);return e.data=t,e}}class yl{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class It{constructor(t){this.fields=t,t.sort(dt.comparator)}static empty(){return new It([])}unionWith(t){let e=new ot(dt.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new It(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return tn(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qu extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ft{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new qu("Invalid base64 string: "+r):r}}(t);return new ft(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new ft(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Se(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}ft.EMPTY_BYTE_STRING=new ft("");const hg=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function fi(s){if(Le(!!s,39018),typeof s=="string"){let t=0;const e=hg.exec(s);if(Le(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:Ye(s.seconds),nanos:Ye(s.nanos)}}function Ye(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function pi(s){return typeof s=="string"?ft.fromBase64String(s):ft.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zu="server_timestamp",Xu="__type__",Ku="__previous_value__",Yu="__local_write_time__";function To(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[Xu])===null||e===void 0?void 0:e.stringValue)===Zu}function ns(s){const t=s.mapValue.fields[Ku];return To(t)?ns(t):t}function Un(s){const t=fi(s.mapValue.fields[Yu].timestampValue);return new je(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dg{constructor(t,e,i,n,r,o,a,l,u,h){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=l,this.useFetchStreams=u,this.isUsingEmulator=h}}const jr="(default)";class jn{constructor(t,e){this.projectId=t,this.database=e||jr}static empty(){return new jn("","")}get isDefaultDatabase(){return this.database===jr}isEqual(t){return t instanceof jn&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qu="__type__",fg="__max__",_r={mapValue:{}},Ju="__vector__",Wr="value";function gi(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?To(s)?4:gg(s)?9007199254740991:pg(s)?10:11:we(28295,{value:s})}function qt(s,t){if(s===t)return!0;const e=gi(s);if(e!==gi(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return Un(s).isEqual(Un(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=fi(n.timestampValue),a=fi(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return pi(n.bytesValue).isEqual(pi(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return Ye(n.geoPointValue.latitude)===Ye(r.geoPointValue.latitude)&&Ye(n.geoPointValue.longitude)===Ye(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return Ye(n.integerValue)===Ye(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=Ye(n.doubleValue),a=Ye(r.doubleValue);return o===a?Ur(o)===Ur(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return tn(s.arrayValue.values||[],t.arrayValue.values||[],qt);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(vl(o)!==vl(a))return!1;for(const l in o)if(o.hasOwnProperty(l)&&(a[l]===void 0||!qt(o[l],a[l])))return!1;return!0}(s,t);default:return we(52216,{left:s})}}function Wn(s,t){return(s.values||[]).find(e=>qt(e,t))!==void 0}function nn(s,t){if(s===t)return 0;const e=gi(s),i=gi(t);if(e!==i)return Se(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return Se(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=Ye(r.integerValue||r.doubleValue),l=Ye(o.integerValue||o.doubleValue);return a<l?-1:a>l?1:a===l?0:isNaN(a)?isNaN(l)?0:-1:1}(s,t);case 3:return wl(s.timestampValue,t.timestampValue);case 4:return wl(Un(s),Un(t));case 5:return Xs(s.stringValue,t.stringValue);case 6:return function(r,o){const a=pi(r),l=pi(o);return a.compareTo(l)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),l=o.split("/");for(let u=0;u<a.length&&u<l.length;u++){const h=Se(a[u],l[u]);if(h!==0)return h}return Se(a.length,l.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=Se(Ye(r.latitude),Ye(o.latitude));return a!==0?a:Se(Ye(r.longitude),Ye(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return _l(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,l,u,h;const d=r.fields||{},f=o.fields||{},m=(a=d[Wr])===null||a===void 0?void 0:a.arrayValue,v=(l=f[Wr])===null||l===void 0?void 0:l.arrayValue,E=Se(((u=m==null?void 0:m.values)===null||u===void 0?void 0:u.length)||0,((h=v==null?void 0:v.values)===null||h===void 0?void 0:h.length)||0);return E!==0?E:_l(m,v)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===_r.mapValue&&o===_r.mapValue)return 0;if(r===_r.mapValue)return 1;if(o===_r.mapValue)return-1;const a=r.fields||{},l=Object.keys(a),u=o.fields||{},h=Object.keys(u);l.sort(),h.sort();for(let d=0;d<l.length&&d<h.length;++d){const f=Xs(l[d],h[d]);if(f!==0)return f;const m=nn(a[l[d]],u[h[d]]);if(m!==0)return m}return Se(l.length,h.length)}(s.mapValue,t.mapValue);default:throw we(23264,{le:e})}}function wl(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return Se(s,t);const e=fi(s),i=fi(t),n=Se(e.seconds,i.seconds);return n!==0?n:Se(e.nanos,i.nanos)}function _l(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=nn(e[n],i[n]);if(r)return r}return Se(e.length,i.length)}function rn(s){return Ks(s)}function Ks(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=fi(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return pi(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return pe.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=Ks(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${Ks(e.fields[o])}`;return n+"}"}(s.mapValue):we(61005,{value:s})}function Pr(s){switch(gi(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=ns(s);return t?16+Pr(t):16;case 5:return 2*s.stringValue.length;case 6:return pi(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+Pr(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return _i(i.fields,(r,o)=>{n+=r.length+Pr(o)}),n}(s.mapValue);default:throw we(13486,{value:s})}}function Tl(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function Ys(s){return!!s&&"integerValue"in s}function Eo(s){return!!s&&"arrayValue"in s}function El(s){return!!s&&"nullValue"in s}function bl(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function Cr(s){return!!s&&"mapValue"in s}function pg(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[Qu])===null||e===void 0?void 0:e.stringValue)===Ju}function kn(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return _i(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=kn(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=kn(s.arrayValue.values[e]);return t}return Object.assign({},s)}function gg(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===fg}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pt{constructor(t){this.value=t}static empty(){return new Pt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!Cr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=kn(e)}setAll(t){let e=dt.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const l=this.getFieldsMap(e);this.applyChanges(l,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=kn(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());Cr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return qt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];Cr(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){_i(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Pt(kn(this.value))}}function $u(s){const t=[];return _i(s.fields,(e,i)=>{const n=new dt([e]);if(Cr(i)){const r=$u(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new It(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _t{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new _t(t,0,Te.min(),Te.min(),Te.min(),Pt.empty(),0)}static newFoundDocument(t,e,i,n){return new _t(t,1,e,Te.min(),i,n,0)}static newNoDocument(t,e){return new _t(t,2,e,Te.min(),Te.min(),Pt.empty(),0)}static newUnknownDocument(t,e){return new _t(t,3,e,Te.min(),Te.min(),Pt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(Te.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Pt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Pt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Te.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof _t&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new _t(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gr{constructor(t,e){this.position=t,this.inclusive=e}}function xl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=pe.comparator(pe.fromName(o.referenceValue),e.key):i=nn(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function Sl(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!qt(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gn{constructor(t,e="asc"){this.field=t,this.dir=e}}function mg(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ec{}class et extends ec{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new yg(t,e,i):e==="array-contains"?new Tg(t,i):e==="in"?new Eg(t,i):e==="not-in"?new bg(t,i):e==="array-contains-any"?new xg(t,i):new et(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new wg(t,i):new _g(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(nn(e,this.value)):e!==null&&gi(this.value)===gi(e)&&this.matchesComparison(nn(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return we(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Lt extends ec{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new Lt(t,e)}matches(t){return tc(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function tc(s){return s.op==="and"}function ic(s){return vg(s)&&tc(s)}function vg(s){for(const t of s.filters)if(t instanceof Lt)return!1;return!0}function Qs(s){if(s instanceof et)return s.field.canonicalString()+s.op.toString()+rn(s.value);if(ic(s))return s.filters.map(t=>Qs(t)).join(",");{const t=s.filters.map(e=>Qs(e)).join(",");return`${s.op}(${t})`}}function nc(s,t){return s instanceof et?function(i,n){return n instanceof et&&i.op===n.op&&i.field.isEqual(n.field)&&qt(i.value,n.value)}(s,t):s instanceof Lt?function(i,n){return n instanceof Lt&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&nc(o,n.filters[a]),!0):!1}(s,t):void we(19439)}function rc(s){return s instanceof et?function(e){return`${e.field.canonicalString()} ${e.op} ${rn(e.value)}`}(s):s instanceof Lt?function(e){return e.op.toString()+" {"+e.getFilters().map(rc).join(" ,")+"}"}(s):"Filter"}class yg extends et{constructor(t,e,i){super(t,e,i),this.key=pe.fromName(i.referenceValue)}matches(t){const e=pe.comparator(t.key,this.key);return this.matchesComparison(e)}}class wg extends et{constructor(t,e){super(t,"in",e),this.keys=sc("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class _g extends et{constructor(t,e){super(t,"not-in",e),this.keys=sc("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function sc(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>pe.fromName(i.referenceValue))}class Tg extends et{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Eo(e)&&Wn(e.arrayValue,this.value)}}class Eg extends et{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&Wn(this.value.arrayValue,e)}}class bg extends et{constructor(t,e){super(t,"not-in",e)}matches(t){if(Wn(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!Wn(this.value.arrayValue,e)}}class xg extends et{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Eo(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>Wn(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sg{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function Pl(s,t=null,e=[],i=[],n=null,r=null,o=null){return new Sg(s,t,e,i,n,r,o)}function bo(s){const t=Ee(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>Qs(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),is(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>rn(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>rn(i)).join(",")),t.Pe=e}return t.Pe}function xo(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!mg(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!nc(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!Sl(s.startAt,t.startAt)&&Sl(s.endAt,t.endAt)}function Js(s){return pe.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dn{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,l=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=l,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function Pg(s,t,e,i,n,r,o,a){return new dn(s,t,e,i,n,r,o,a)}function So(s){return new dn(s)}function Cl(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function oc(s){return s.collectionGroup!==null}function Fn(s){const t=Ee(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new ot(dt.comparator);return o.filters.forEach(l=>{l.getFlattenedFilters().forEach(u=>{u.isInequality()&&(a=a.add(u.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new Gn(r,i))}),e.has(dt.keyField().canonicalString())||t.Te.push(new Gn(dt.keyField(),i))}return t.Te}function zt(s){const t=Ee(s);return t.Ie||(t.Ie=Cg(t,Fn(s))),t.Ie}function Cg(s,t){if(s.limitType==="F")return Pl(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new Gn(n.field,r)});const e=s.endAt?new Gr(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new Gr(s.startAt.position,s.startAt.inclusive):null;return Pl(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function $s(s,t){const e=s.filters.concat([t]);return new dn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function eo(s,t,e){return new dn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function rs(s,t){return xo(zt(s),zt(t))&&s.limitType===t.limitType}function ac(s){return`${bo(zt(s))}|lt:${s.limitType}`}function Ui(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>rc(n)).join(", ")}]`),is(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>rn(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>rn(n)).join(",")),`Target(${i})`}(zt(s))}; limitType=${s.limitType})`}function ss(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):pe.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of Fn(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,l){const u=xl(o,a,l);return o.inclusive?u<=0:u<0}(i.startAt,Fn(i),n)||i.endAt&&!function(o,a,l){const u=xl(o,a,l);return o.inclusive?u>=0:u>0}(i.endAt,Fn(i),n))}(s,t)}function Rg(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function lc(s){return(t,e)=>{let i=!1;for(const n of Fn(s)){const r=Ig(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function Ig(s,t,e){const i=s.field.isKeyField()?pe.comparator(t.key,e.key):function(r,o,a){const l=o.data.field(r),u=a.data.field(r);return l!==null&&u!==null?nn(l,u):we(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return we(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mi{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){_i(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return Gu(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ag=new Ze(pe.comparator);function ti(){return Ag}const uc=new Ze(pe.comparator);function Cn(...s){let t=uc;for(const e of s)t=t.insert(e.key,e);return t}function cc(s){let t=uc;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function Ci(){return On()}function hc(){return On()}function On(){return new Mi(s=>s.toString(),(s,t)=>s.isEqual(t))}const Dg=new Ze(pe.comparator),Mg=new ot(pe.comparator);function Ae(...s){let t=Mg;for(const e of s)t=t.add(e);return t}const kg=new ot(Se);function Fg(){return kg}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Po(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ur(t)?"-0":t}}function dc(s){return{integerValue:""+s}}function Og(s,t){return lg(t)?dc(t):Po(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class os{constructor(){this._=void 0}}function Vg(s,t,e){return s instanceof qr?function(n,r){const o={fields:{[Xu]:{stringValue:Zu},[Yu]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&To(r)&&(r=ns(r)),r&&(o.fields[Ku]=r),{mapValue:o}}(e,t):s instanceof qn?pc(s,t):s instanceof Zn?gc(s,t):function(n,r){const o=fc(n,r),a=Rl(o)+Rl(n.Ee);return Ys(o)&&Ys(n.Ee)?dc(a):Po(n.serializer,a)}(s,t)}function Lg(s,t,e){return s instanceof qn?pc(s,t):s instanceof Zn?gc(s,t):e}function fc(s,t){return s instanceof Zr?function(i){return Ys(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class qr extends os{}class qn extends os{constructor(t){super(),this.elements=t}}function pc(s,t){const e=mc(t);for(const i of s.elements)e.some(n=>qt(n,i))||e.push(i);return{arrayValue:{values:e}}}class Zn extends os{constructor(t){super(),this.elements=t}}function gc(s,t){let e=mc(t);for(const i of s.elements)e=e.filter(n=>!qt(n,i));return{arrayValue:{values:e}}}class Zr extends os{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function Rl(s){return Ye(s.integerValue||s.doubleValue)}function mc(s){return Eo(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function Ng(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof qn&&n instanceof qn||i instanceof Zn&&n instanceof Zn?tn(i.elements,n.elements,qt):i instanceof Zr&&n instanceof Zr?qt(i.Ee,n.Ee):i instanceof qr&&n instanceof qr}(s.transform,t.transform)}class Bg{constructor(t,e){this.version=t,this.transformResults=e}}class Vt{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Vt}static exists(t){return new Vt(void 0,t)}static updateTime(t){return new Vt(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Rr(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class as{}function vc(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new Co(s.key,Vt.none()):new Qn(s.key,s.data,Vt.none());{const e=s.data,i=Pt.empty();let n=new ot(dt.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new Ti(s.key,i,new It(n.toArray()),Vt.none())}}function zg(s,t,e){s instanceof Qn?function(n,r,o){const a=n.value.clone(),l=Al(n.fieldTransforms,r,o.transformResults);a.setAll(l),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof Ti?function(n,r,o){if(!Rr(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=Al(n.fieldTransforms,r,o.transformResults),l=r.data;l.setAll(yc(n)),l.setAll(a),r.convertToFoundDocument(o.version,l).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function Vn(s,t,e,i){return s instanceof Qn?function(r,o,a,l){if(!Rr(r.precondition,o))return a;const u=r.value.clone(),h=Dl(r.fieldTransforms,l,o);return u.setAll(h),o.convertToFoundDocument(o.version,u).setHasLocalMutations(),null}(s,t,e,i):s instanceof Ti?function(r,o,a,l){if(!Rr(r.precondition,o))return a;const u=Dl(r.fieldTransforms,l,o),h=o.data;return h.setAll(yc(r)),h.setAll(u),o.convertToFoundDocument(o.version,h).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(d=>d.field))}(s,t,e,i):function(r,o,a){return Rr(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function Hg(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=fc(i.transform,n||null);r!=null&&(e===null&&(e=Pt.empty()),e.set(i.field,r))}return e||null}function Il(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&tn(i,n,(r,o)=>Ng(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class Qn extends as{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class Ti extends as{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function yc(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function Al(s,t,e){const i=new Map;Le(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,Lg(o,a,e[n]))}return i}function Dl(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,Vg(r,o,t))}return i}class Co extends as{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ug extends as{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jg{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&zg(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=Vn(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=Vn(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=hc();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const l=vc(o,a);l!==null&&i.set(n.key,l),o.isValidDocument()||o.convertToNoDocument(Te.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Ae())}isEqual(t){return this.batchId===t.batchId&&tn(this.mutations,t.mutations,(e,i)=>Il(e,i))&&tn(this.baseMutations,t.baseMutations,(e,i)=>Il(e,i))}}class Ro{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){Le(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return Dg}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new Ro(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wg{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gg{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Qe,De;function qg(s){switch(s){case q.OK:return we(64938);case q.CANCELLED:case q.UNKNOWN:case q.DEADLINE_EXCEEDED:case q.RESOURCE_EXHAUSTED:case q.INTERNAL:case q.UNAVAILABLE:case q.UNAUTHENTICATED:return!1;case q.INVALID_ARGUMENT:case q.NOT_FOUND:case q.ALREADY_EXISTS:case q.PERMISSION_DENIED:case q.FAILED_PRECONDITION:case q.ABORTED:case q.OUT_OF_RANGE:case q.UNIMPLEMENTED:case q.DATA_LOSS:return!0;default:return we(15467,{code:s})}}function wc(s){if(s===void 0)return ei("GRPC error has no .code"),q.UNKNOWN;switch(s){case Qe.OK:return q.OK;case Qe.CANCELLED:return q.CANCELLED;case Qe.UNKNOWN:return q.UNKNOWN;case Qe.DEADLINE_EXCEEDED:return q.DEADLINE_EXCEEDED;case Qe.RESOURCE_EXHAUSTED:return q.RESOURCE_EXHAUSTED;case Qe.INTERNAL:return q.INTERNAL;case Qe.UNAVAILABLE:return q.UNAVAILABLE;case Qe.UNAUTHENTICATED:return q.UNAUTHENTICATED;case Qe.INVALID_ARGUMENT:return q.INVALID_ARGUMENT;case Qe.NOT_FOUND:return q.NOT_FOUND;case Qe.ALREADY_EXISTS:return q.ALREADY_EXISTS;case Qe.PERMISSION_DENIED:return q.PERMISSION_DENIED;case Qe.FAILED_PRECONDITION:return q.FAILED_PRECONDITION;case Qe.ABORTED:return q.ABORTED;case Qe.OUT_OF_RANGE:return q.OUT_OF_RANGE;case Qe.UNIMPLEMENTED:return q.UNIMPLEMENTED;case Qe.DATA_LOSS:return q.DATA_LOSS;default:return we(39323,{code:s})}}(De=Qe||(Qe={}))[De.OK=0]="OK",De[De.CANCELLED=1]="CANCELLED",De[De.UNKNOWN=2]="UNKNOWN",De[De.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",De[De.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",De[De.NOT_FOUND=5]="NOT_FOUND",De[De.ALREADY_EXISTS=6]="ALREADY_EXISTS",De[De.PERMISSION_DENIED=7]="PERMISSION_DENIED",De[De.UNAUTHENTICATED=16]="UNAUTHENTICATED",De[De.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",De[De.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",De[De.ABORTED=10]="ABORTED",De[De.OUT_OF_RANGE=11]="OUT_OF_RANGE",De[De.UNIMPLEMENTED=12]="UNIMPLEMENTED",De[De.INTERNAL=13]="INTERNAL",De[De.UNAVAILABLE=14]="UNAVAILABLE",De[De.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zg=new li([4294967295,4294967295],0);function Ml(s){const t=Hu().encode(s),e=new ku;return e.update(t),new Uint8Array(e.digest())}function kl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new li([e,i],0),new li([n,r],0)]}class Io{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new Rn(`Invalid padding: ${e}`);if(i<0)throw new Rn(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new Rn(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new Rn(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=li.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(li.fromNumber(i)));return n.compare(Zg)===1&&(n=new li([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=Ml(t),[i,n]=kl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new Io(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=Ml(t),[i,n]=kl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class Rn extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ls{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,Jn.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new ls(Te.min(),n,new Ze(Se),ti(),Ae())}}class Jn{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new Jn(i,e,Ae(),Ae(),Ae())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ir{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class _c{constructor(t,e){this.targetId=t,this.De=e}}class Tc{constructor(t,e,i=ft.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class Fl{constructor(){this.ve=0,this.Ce=Ol(),this.Fe=ft.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Ae(),e=Ae(),i=Ae();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:we(38017,{changeType:r})}}),new Jn(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Ol()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,Le(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class Xg{constructor(t){this.We=t,this.Ge=new Map,this.ze=ti(),this.je=Tr(),this.Je=Tr(),this.He=new Ze(Se)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:we(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(Js(r))if(i===0){const o=new pe(r.path);this.Xe(e,o,_t.newNoDocument(o,Te.min()))}else Le(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),l=a?this.ut(a,t,o):1;if(l!==0){this.rt(e);const u=l===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,u)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=pi(i).toUint8Array()}catch(l){if(l instanceof qu)return hi("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{a=new Io(o,n,r)}catch(l){return hi(l instanceof Rn?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&Js(a.target)){const l=new pe(a.target.path);this.Tt(l).has(o)||this.It(o,l)||this.Xe(o,l,_t.newNoDocument(l,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Ae();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(l=>{const u=this.st(l);return!u||u.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new ls(t,e,this.He,this.ze,i);return this.ze=ti(),this.je=Tr(),this.Je=Tr(),this.He=new Ze(Se),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new Fl,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new ot(Se),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new ot(Se),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||ue("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new Fl),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function Tr(){return new Ze(pe.comparator)}function Ol(){return new Ze(pe.comparator)}const Kg={asc:"ASCENDING",desc:"DESCENDING"},Yg={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Qg={and:"AND",or:"OR"};class Jg{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function to(s,t){return s.useProto3Json||is(t)?t:{value:t}}function Xr(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ec(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function $g(s,t){return Xr(s,t.toTimestamp())}function Ht(s){return Le(!!s,49232),Te.fromTimestamp(function(e){const i=fi(e);return new je(i.seconds,i.nanos)}(s))}function Ao(s,t){return io(s,t).canonicalString()}function io(s,t){const e=function(n){return new ze(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function bc(s){const t=ze.fromString(s);return Le(Rc(t),10190,{key:t.toString()}),t}function no(s,t){return Ao(s.databaseId,t.path)}function Fs(s,t){const e=bc(t);if(e.get(1)!==s.databaseId.projectId)throw new le(q.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new le(q.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new pe(Sc(e))}function xc(s,t){return Ao(s.databaseId,t)}function em(s){const t=bc(s);return t.length===4?ze.emptyPath():Sc(t)}function ro(s){return new ze(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function Sc(s){return Le(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Vl(s,t,e){return{name:no(s,t),fields:e.value.mapValue.fields}}function tm(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(u){return u==="NO_CHANGE"?0:u==="ADD"?1:u==="REMOVE"?2:u==="CURRENT"?3:u==="RESET"?4:we(39313,{state:u})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(u,h){return u.useProto3Json?(Le(h===void 0||typeof h=="string",58123),ft.fromBase64String(h||"")):(Le(h===void 0||h instanceof Buffer||h instanceof Uint8Array,16193),ft.fromUint8Array(h||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(u){const h=u.code===void 0?q.UNKNOWN:wc(u.code);return new le(h,u.message||"")}(o);e=new Tc(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=Fs(s,i.document.name),r=Ht(i.document.updateTime),o=i.document.createTime?Ht(i.document.createTime):Te.min(),a=new Pt({mapValue:{fields:i.document.fields}}),l=_t.newFoundDocument(n,r,o,a),u=i.targetIds||[],h=i.removedTargetIds||[];e=new Ir(u,h,l.key,l)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=Fs(s,i.document),r=i.readTime?Ht(i.readTime):Te.min(),o=_t.newNoDocument(n,r),a=i.removedTargetIds||[];e=new Ir([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=Fs(s,i.document),r=i.removedTargetIds||[];e=new Ir([],r,n,null)}else{if(!("filter"in t))return we(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new Gg(n,r),a=i.targetId;e=new _c(a,o)}}return e}function im(s,t){let e;if(t instanceof Qn)e={update:Vl(s,t.key,t.value)};else if(t instanceof Co)e={delete:no(s,t.key)};else if(t instanceof Ti)e={update:Vl(s,t.key,t.data),updateMask:hm(t.fieldMask)};else{if(!(t instanceof Ug))return we(16599,{Rt:t.type});e={verify:no(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof qr)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof qn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Zn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof Zr)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw we(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:$g(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:we(27497)}(s,t.precondition)),e}function nm(s,t){return s&&s.length>0?(Le(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?Ht(n.updateTime):Ht(r);return o.isEqual(Te.min())&&(o=Ht(r)),new Bg(o,n.transformResults||[])}(e,t))):[]}function rm(s,t){return{documents:[xc(s,t.path)]}}function sm(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=xc(s,n);const r=function(u){if(u.length!==0)return Cc(Lt.create(u,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(u){if(u.length!==0)return u.map(h=>function(f){return{field:ji(f.field),direction:lm(f.dir)}}(h))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=to(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(u){return{before:u.inclusive,values:u.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(u){return{before:!u.inclusive,values:u.position}}(t.endAt)),{Vt:e,parent:n}}function om(s){let t=em(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){Le(i===1,65062);const h=e.from[0];h.allDescendants?n=h.collectionId:t=t.child(h.collectionId)}let r=[];e.where&&(r=function(d){const f=Pc(d);return f instanceof Lt&&ic(f)?f.getFilters():[f]}(e.where));let o=[];e.orderBy&&(o=function(d){return d.map(f=>function(v){return new Gn(Wi(v.field),function(T){switch(T){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(v.direction))}(f))}(e.orderBy));let a=null;e.limit&&(a=function(d){let f;return f=typeof d=="object"?d.value:d,is(f)?null:f}(e.limit));let l=null;e.startAt&&(l=function(d){const f=!!d.before,m=d.values||[];return new Gr(m,f)}(e.startAt));let u=null;return e.endAt&&(u=function(d){const f=!d.before,m=d.values||[];return new Gr(m,f)}(e.endAt)),Pg(t,n,o,r,a,"F",l,u)}function am(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return we(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Pc(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=Wi(e.unaryFilter.field);return et.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=Wi(e.unaryFilter.field);return et.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Wi(e.unaryFilter.field);return et.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Wi(e.unaryFilter.field);return et.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return we(61313);default:return we(60726)}}(s):s.fieldFilter!==void 0?function(e){return et.create(Wi(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return we(58110);default:return we(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return Lt.create(e.compositeFilter.filters.map(i=>Pc(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return we(1026)}}(e.compositeFilter.op))}(s):we(30097,{filter:s})}function lm(s){return Kg[s]}function um(s){return Yg[s]}function cm(s){return Qg[s]}function ji(s){return{fieldPath:s.canonicalString()}}function Wi(s){return dt.fromServerFormat(s.fieldPath)}function Cc(s){return s instanceof et?function(e){if(e.op==="=="){if(bl(e.value))return{unaryFilter:{field:ji(e.field),op:"IS_NAN"}};if(El(e.value))return{unaryFilter:{field:ji(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(bl(e.value))return{unaryFilter:{field:ji(e.field),op:"IS_NOT_NAN"}};if(El(e.value))return{unaryFilter:{field:ji(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ji(e.field),op:um(e.op),value:e.value}}}(s):s instanceof Lt?function(e){const i=e.getFilters().map(n=>Cc(n));return i.length===1?i[0]:{compositeFilter:{op:cm(e.op),filters:i}}}(s):we(54877,{filter:s})}function hm(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Rc(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class si{constructor(t,e,i,n,r=Te.min(),o=Te.min(),a=ft.EMPTY_BYTE_STRING,l=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=l}withSequenceNumber(t){return new si(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new si(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new si(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new si(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dm{constructor(t){this.gt=t}}function fm(s){const t=om({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?eo(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pm{constructor(){this.Dn=new gm}addToCollectionParentIndex(t,e){return this.Dn.add(e),X.resolve()}getCollectionParents(t,e){return X.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return X.resolve()}deleteFieldIndex(t,e){return X.resolve()}deleteAllFieldIndexes(t){return X.resolve()}createTargetIndexes(t,e){return X.resolve()}getDocumentsMatchingTarget(t,e){return X.resolve(null)}getIndexType(t,e){return X.resolve(0)}getFieldIndexes(t,e){return X.resolve([])}getNextCollectionGroupToUpdate(t){return X.resolve(null)}getMinOffset(t,e){return X.resolve(di.min())}getMinOffsetFromCollectionGroup(t,e){return X.resolve(di.min())}updateCollectionGroup(t,e,i){return X.resolve()}updateIndexEntries(t,e){return X.resolve()}}class gm{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new ot(ze.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new ot(ze.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ll={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Ic=41943040;class St{static withCacheSize(t){return new St(t,St.DEFAULT_COLLECTION_PERCENTILE,St.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */St.DEFAULT_COLLECTION_PERCENTILE=10,St.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,St.DEFAULT=new St(Ic,St.DEFAULT_COLLECTION_PERCENTILE,St.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),St.DISABLED=new St(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sn{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new sn(0)}static ur(){return new sn(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Nl="LruGarbageCollector",mm=1048576;function Bl([s,t],[e,i]){const n=Se(s,e);return n===0?Se(t,i):n}class vm{constructor(t){this.Tr=t,this.buffer=new ot(Bl),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();Bl(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class ym{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){ue(Nl,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){hn(e)?ue(Nl,"Ignoring IndexedDB error during garbage collection: ",e):await cn(e)}await this.Rr(3e5)})}}class wm{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return X.resolve(ts.ue);const i=new vm(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(ue("LruGarbageCollector","Garbage collection skipped; disabled"),X.resolve(Ll)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(ue("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ll):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,l,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(d=>(d>this.params.maximumSequenceNumbersToCollect?(ue("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${d}`),n=this.params.maximumSequenceNumbersToCollect):n=d,o=Date.now(),this.nthSequenceNumber(t,n))).next(d=>(i=d,a=Date.now(),this.removeTargets(t,i,e))).next(d=>(r=d,l=Date.now(),this.removeOrphanedDocuments(t,i))).next(d=>(u=Date.now(),Hi()<=Me.DEBUG&&ue("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-h}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(l-a)+`ms
	Removed ${d} documents in `+(u-l)+`ms
Total Duration: ${u-h}ms`),X.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:d})))}}function _m(s,t){return new wm(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tm{constructor(){this.changes=new Mi(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,_t.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?X.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Em{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bm{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&Vn(i.mutation,n,It.empty(),je.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Ae()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Ae()){const n=Ci();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=Cn();return r.forEach((a,l)=>{o=o.insert(a,l.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=Ci();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Ae()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=ti();const o=On(),a=function(){return On()}();return e.forEach((l,u)=>{const h=i.get(u.key);n.has(u.key)&&(h===void 0||h.mutation instanceof Ti)?r=r.insert(u.key,u):h!==void 0?(o.set(u.key,h.mutation.getFieldMask()),Vn(h.mutation,u,h.mutation.getFieldMask(),je.now())):o.set(u.key,It.empty())}),this.recalculateAndSaveOverlays(t,r).next(l=>(l.forEach((u,h)=>o.set(u,h)),e.forEach((u,h)=>{var d;return a.set(u,new Em(h,(d=o.get(u))!==null&&d!==void 0?d:null))}),a))}recalculateAndSaveOverlays(t,e){const i=On();let n=new Ze((o,a)=>o-a),r=Ae();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(l=>{const u=e.get(l);if(u===null)return;let h=i.get(l)||It.empty();h=a.applyToLocalView(u,h),i.set(l,h);const d=(n.get(a.batchId)||Ae()).add(l);n=n.insert(a.batchId,d)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const l=a.getNext(),u=l.key,h=l.value,d=hc();h.forEach(f=>{if(!r.has(f)){const m=vc(e.get(f),i.get(f));m!==null&&d.set(f,m),r=r.add(f)}}),o.push(this.documentOverlayCache.saveOverlays(t,u,d))}return X.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return pe.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):oc(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):X.resolve(Ci());let a=Hn,l=r;return o.next(u=>X.forEach(u,(h,d)=>(a<d.largestBatchId&&(a=d.largestBatchId),r.get(h)?X.resolve():this.remoteDocumentCache.getEntry(t,h).next(f=>{l=l.insert(h,f)}))).next(()=>this.populateOverlays(t,u,r)).next(()=>this.computeViews(t,l,u,Ae())).next(h=>({batchId:a,changes:cc(h)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new pe(e)).next(i=>{let n=Cn();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=Cn();return this.indexManager.getCollectionParents(t,r).next(a=>X.forEach(a,l=>{const u=function(d,f){return new dn(f,null,d.explicitOrderBy.slice(),d.filters.slice(),d.limit,d.limitType,d.startAt,d.endAt)}(e,l.child(r));return this.getDocumentsMatchingCollectionQuery(t,u,i,n).next(h=>{h.forEach((d,f)=>{o=o.insert(d,f)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((l,u)=>{const h=u.getKey();o.get(h)===null&&(o=o.insert(h,_t.newInvalidDocument(h)))});let a=Cn();return o.forEach((l,u)=>{const h=r.get(l);h!==void 0&&Vn(h.mutation,u,It.empty(),je.now()),ss(e,u)&&(a=a.insert(l,u))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xm{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return X.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:Ht(n.createTime)}}(e)),X.resolve()}getNamedQuery(t,e){return X.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:fm(n.bundledQuery),readTime:Ht(n.readTime)}}(e)),X.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sm{constructor(){this.overlays=new Ze(pe.comparator),this.kr=new Map}getOverlay(t,e){return X.resolve(this.overlays.get(e))}getOverlays(t,e){const i=Ci();return X.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),X.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),X.resolve()}getOverlaysForCollection(t,e,i){const n=Ci(),r=e.length+1,o=new pe(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const l=a.getNext().value,u=l.getKey();if(!e.isPrefixOf(u.path))break;u.path.length===r&&l.largestBatchId>i&&n.set(l.getKey(),l)}return X.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new Ze((u,h)=>u-h);const o=this.overlays.getIterator();for(;o.hasNext();){const u=o.getNext().value;if(u.getKey().getCollectionGroup()===e&&u.largestBatchId>i){let h=r.get(u.largestBatchId);h===null&&(h=Ci(),r=r.insert(u.largestBatchId,h)),h.set(u.getKey(),u)}}const a=Ci(),l=r.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((u,h)=>a.set(u,h)),!(a.size()>=n)););return X.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new Wg(e,i));let r=this.kr.get(e);r===void 0&&(r=Ae(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pm{constructor(){this.sessionToken=ft.EMPTY_BYTE_STRING}getSessionToken(t){return X.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,X.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Do{constructor(){this.qr=new ot(ut.Qr),this.$r=new ot(ut.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new ut(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new ut(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new pe(new ze([])),i=new ut(e,t),n=new ut(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new pe(new ze([])),i=new ut(e,t),n=new ut(e,t+1);let r=Ae();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new ut(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class ut{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return pe.comparator(t.key,e.key)||Se(t.Hr,e.Hr)}static Ur(t,e){return Se(t.Hr,e.Hr)||pe.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cm{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new ot(ut.Qr)}checkEmpty(t){return X.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new jg(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new ut(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return X.resolve(o)}lookupMutationBatch(t,e){return X.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return X.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return X.resolve(this.mutationQueue.length===0?_o:this.er-1)}getAllMutationBatches(t){return X.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new ut(e,0),n=new ut(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),X.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new ot(Se);return e.forEach(n=>{const r=new ut(n,0),o=new ut(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),X.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;pe.isDocumentKey(r)||(r=r.child(""));const o=new ut(new pe(r),0);let a=new ot(Se);return this.Yr.forEachWhile(l=>{const u=l.key.path;return!!i.isPrefixOf(u)&&(u.length===n&&(a=a.add(l.Hr)),!0)},o),X.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){Le(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return X.forEach(e.mutations,n=>{const r=new ut(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new ut(e,0),n=this.Yr.firstAfterOrEqual(i);return X.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,X.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rm{constructor(t){this.ni=t,this.docs=function(){return new Ze(pe.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return X.resolve(i?i.document.mutableCopy():_t.newInvalidDocument(e))}getEntries(t,e){let i=ti();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():_t.newInvalidDocument(n))}),X.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=ti();const o=e.path,a=new pe(o.child("__id-9223372036854775808__")),l=this.docs.getIteratorFrom(a);for(;l.hasNext();){const{key:u,value:{document:h}}=l.getNext();if(!o.isPrefixOf(u.path))break;u.path.length>o.length+1||rg(ng(h),i)<=0||(n.has(h.key)||ss(e,h))&&(r=r.insert(h.key,h.mutableCopy()))}return X.resolve(r)}getAllFromCollectionGroup(t,e,i,n){we(9500)}ri(t,e){return X.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new Im(this)}getSize(t){return X.resolve(this.size)}}class Im extends Tm{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),X.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Am{constructor(t){this.persistence=t,this.ii=new Mi(e=>bo(e),xo),this.lastRemoteSnapshotVersion=Te.min(),this.highestTargetId=0,this.si=0,this.oi=new Do,this.targetCount=0,this._i=sn.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),X.resolve()}getLastRemoteSnapshotVersion(t){return X.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return X.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),X.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),X.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new sn(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,X.resolve()}updateTargetData(t,e){return this.hr(e),X.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,X.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),X.waitFor(r).next(()=>n)}getTargetCount(t){return X.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return X.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),X.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),X.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),X.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return X.resolve(i)}containsKey(t,e){return X.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ac{constructor(t,e){this.ai={},this.overlays={},this.ui=new ts(0),this.ci=!1,this.ci=!0,this.li=new Pm,this.referenceDelegate=t(this),this.hi=new Am(this),this.indexManager=new pm,this.remoteDocumentCache=function(n){return new Rm(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new dm(e),this.Ti=new xm(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Sm,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new Cm(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){ue("MemoryPersistence","Starting transaction:",t);const n=new Dm(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return X.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class Dm extends og{constructor(t){super(),this.currentSequenceNumber=t}}class Mo{constructor(t){this.persistence=t,this.Ai=new Do,this.Ri=null}static Vi(t){return new Mo(t)}get mi(){if(this.Ri)return this.Ri;throw we(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),X.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),X.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),X.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return X.forEach(this.mi,i=>{const n=pe.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,Te.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return X.or([()=>X.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class Kr{constructor(t,e){this.persistence=t,this.gi=new Mi(i=>ug(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=_m(this,e)}static Vi(t,e){return new Kr(t,e)}Ii(){}di(t){return X.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return X.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?X.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,Te.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),X.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),X.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),X.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),X.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=Pr(t.data.value)),e}Sr(t,e,i){return X.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return X.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ko{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Ae(),n=Ae();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new ko(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mm{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class km{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return Rf()?8:ag(Pf())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new Mm;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(Hi()<=Me.DEBUG&&ue("QueryEngine","SDK will not create cache indexes for query:",Ui(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),X.resolve()):(Hi()<=Me.DEBUG&&ue("QueryEngine","Query:",Ui(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(Hi()<=Me.DEBUG&&ue("QueryEngine","The SDK decides to create cache indexes for query:",Ui(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,zt(e))):X.resolve())}ps(t,e){if(Cl(e))return X.resolve(null);let i=zt(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=eo(e,null,"F"),i=zt(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Ae(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(l=>{const u=this.bs(e,a);return this.Ds(e,u,o,l.readTime)?this.ps(t,eo(e,null,"F")):this.vs(t,u,e,l)}))})))}ys(t,e,i,n){return Cl(e)||n.isEqual(Te.min())?X.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?X.resolve(null):(Hi()<=Me.DEBUG&&ue("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Ui(e)),this.vs(t,o,e,ig(n,Hn)).next(a=>a))})}bs(t,e){let i=new ot(lc(t));return e.forEach((n,r)=>{ss(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return Hi()<=Me.DEBUG&&ue("QueryEngine","Using full collection scan to execute query:",Ui(e)),this.gs.getDocumentsMatchingQuery(t,e,di.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fo="LocalStore",Fm=3e8;class Om{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new Ze(Se),this.Ms=new Mi(r=>bo(r),xo),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new bm(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function Vm(s,t,e,i){return new Om(s,t,e,i)}async function Dc(s,t){const e=Ee(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let l=Ae();for(const u of n){o.push(u.batchId);for(const h of u.mutations)l=l.add(h.key)}for(const u of r){a.push(u.batchId);for(const h of u.mutations)l=l.add(h.key)}return e.localDocuments.getDocuments(i,l).next(u=>({Bs:u,removedBatchIds:o,addedBatchIds:a}))})})}function Lm(s,t){const e=Ee(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,l,u,h){const d=u.batch,f=d.keys();let m=X.resolve();return f.forEach(v=>{m=m.next(()=>h.getEntry(l,v)).next(E=>{const T=u.docVersions.get(v);Le(T!==null,48541),E.version.compareTo(T)<0&&(d.applyToRemoteDocument(E,u),E.isValidDocument()&&(E.setReadTime(u.commitVersion),h.addEntry(E)))})}),m.next(()=>a.mutationQueue.removeMutationBatch(l,d))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let l=Ae();for(let u=0;u<a.mutationResults.length;++u)a.mutationResults[u].transformResults.length>0&&(l=l.add(a.batch.mutations[u].key));return l}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function Mc(s){const t=Ee(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function Nm(s,t){const e=Ee(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((h,d)=>{const f=n.get(d);if(!f)return;a.push(e.hi.removeMatchingKeys(r,h.removedDocuments,d).next(()=>e.hi.addMatchingKeys(r,h.addedDocuments,d)));let m=f.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(d)!==null?m=m.withResumeToken(ft.EMPTY_BYTE_STRING,Te.min()).withLastLimboFreeSnapshotVersion(Te.min()):h.resumeToken.approximateByteSize()>0&&(m=m.withResumeToken(h.resumeToken,i)),n=n.insert(d,m),function(E,T,x){return E.resumeToken.approximateByteSize()===0||T.snapshotVersion.toMicroseconds()-E.snapshotVersion.toMicroseconds()>=Fm?!0:x.addedDocuments.size+x.modifiedDocuments.size+x.removedDocuments.size>0}(f,m,h)&&a.push(e.hi.updateTargetData(r,m))});let l=ti(),u=Ae();if(t.documentUpdates.forEach(h=>{t.resolvedLimboDocuments.has(h)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,h))}),a.push(Bm(r,o,t.documentUpdates).next(h=>{l=h.Ls,u=h.ks})),!i.isEqual(Te.min())){const h=e.hi.getLastRemoteSnapshotVersion(r).next(d=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(h)}return X.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,l,u)).next(()=>l)}).then(r=>(e.Fs=n,r))}function Bm(s,t,e){let i=Ae(),n=Ae();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=ti();return e.forEach((a,l)=>{const u=r.get(a);l.isFoundDocument()!==u.isFoundDocument()&&(n=n.add(a)),l.isNoDocument()&&l.version.isEqual(Te.min())?(t.removeEntry(a,l.readTime),o=o.insert(a,l)):!u.isValidDocument()||l.version.compareTo(u.version)>0||l.version.compareTo(u.version)===0&&u.hasPendingWrites?(t.addEntry(l),o=o.insert(a,l)):ue(Fo,"Ignoring outdated watch update for ",a,". Current version:",u.version," Watch version:",l.version)}),{Ls:o,ks:n}})}function zm(s,t){const e=Ee(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=_o),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function Hm(s,t){const e=Ee(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,X.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new si(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function so(s,t,e){const i=Ee(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!hn(o))throw o;ue(Fo,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function zl(s,t,e){const i=Ee(s);let n=Te.min(),r=Ae();return i.persistence.runTransaction("Execute query","readwrite",o=>function(l,u,h){const d=Ee(l),f=d.Ms.get(h);return f!==void 0?X.resolve(d.Fs.get(f)):d.hi.getTargetData(u,h)}(i,o,zt(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(l=>{r=l})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:Te.min(),e?r:Ae())).next(a=>(Um(i,Rg(t),a),{documents:a,qs:r})))}function Um(s,t,e){let i=s.xs.get(t)||Te.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class Hl{constructor(){this.activeTargetIds=Fg()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class jm{constructor(){this.Fo=new Hl,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new Hl,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wm{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ul="ConnectivityMonitor";class jl{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){ue(Ul,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){ue(Ul,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Er=null;function oo(){return Er===null?Er=function(){return 268435456+Math.round(2147483648*Math.random())}():Er++,"0x"+Er.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Os="RestConnection",Gm={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class qm{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===jr?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=oo(),a=this.Go(t,e.toUriEncodedString());ue(Os,`Sending RPC '${t}' ${o}:`,a,i);const l={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(l,n,r);const{host:u}=new URL(a),h=mo(u);return this.jo(t,a,l,i,h).then(d=>(ue(Os,`Received RPC '${t}' ${o}: `,d),d),d=>{throw hi(Os,`RPC '${t}' ${o} failed with error: `,d,"url: ",a,"request:",i),d})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+un}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=Gm[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zm{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const yt="WebChannelConnection";class Xm extends qm{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=oo();return new Promise((a,l)=>{const u=new Fu;u.setWithCredentials(!0),u.listenOnce(Ou.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case Sr.NO_ERROR:const d=u.getResponseJson();ue(yt,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(d)),a(d);break;case Sr.TIMEOUT:ue(yt,`RPC '${t}' ${o} timed out`),l(new le(q.DEADLINE_EXCEEDED,"Request time out"));break;case Sr.HTTP_ERROR:const f=u.getStatus();if(ue(yt,`RPC '${t}' ${o} failed with status:`,f,"response text:",u.getResponseText()),f>0){let m=u.getResponseJson();Array.isArray(m)&&(m=m[0]);const v=m==null?void 0:m.error;if(v&&v.status&&v.message){const E=function(x){const O=x.toLowerCase().replace(/_/g,"-");return Object.values(q).indexOf(O)>=0?O:q.UNKNOWN}(v.status);l(new le(E,v.message))}else l(new le(q.UNKNOWN,"Server responded with status "+u.getStatus()))}else l(new le(q.UNAVAILABLE,"Connection failed."));break;default:we(9055,{c_:t,streamId:o,l_:u.getLastErrorCode(),h_:u.getLastError()})}}finally{ue(yt,`RPC '${t}' ${o} completed.`)}});const h=JSON.stringify(n);ue(yt,`RPC '${t}' ${o} sending request:`,n),u.send(e,"POST",h,i,15)})}P_(t,e,i){const n=oo(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=Nu(),a=Lu(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;u!==void 0&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.zo(l.initMessageHeaders,e,i),l.encodeInitMessageHeaders=!0;const h=r.join("");ue(yt,`Creating RPC '${t}' stream ${n}: ${h}`,l);const d=o.createWebChannel(h,l);this.T_(d);let f=!1,m=!1;const v=new Zm({Ho:T=>{m?ue(yt,`Not sending because RPC '${t}' stream ${n} is closed:`,T):(f||(ue(yt,`Opening RPC '${t}' stream ${n} transport.`),d.open(),f=!0),ue(yt,`RPC '${t}' stream ${n} sending:`,T),d.send(T))},Yo:()=>d.close()}),E=(T,x,O)=>{T.listen(x,V=>{try{O(V)}catch(G){setTimeout(()=>{throw G},0)}})};return E(d,Pn.EventType.OPEN,()=>{m||(ue(yt,`RPC '${t}' stream ${n} transport opened.`),v.s_())}),E(d,Pn.EventType.CLOSE,()=>{m||(m=!0,ue(yt,`RPC '${t}' stream ${n} transport closed`),v.__(),this.I_(d))}),E(d,Pn.EventType.ERROR,T=>{m||(m=!0,hi(yt,`RPC '${t}' stream ${n} transport errored. Name:`,T.name,"Message:",T.message),v.__(new le(q.UNAVAILABLE,"The operation could not be completed")))}),E(d,Pn.EventType.MESSAGE,T=>{var x;if(!m){const O=T.data[0];Le(!!O,16349);const V=O,G=(V==null?void 0:V.error)||((x=V[0])===null||x===void 0?void 0:x.error);if(G){ue(yt,`RPC '${t}' stream ${n} received error:`,G);const Y=G.status;let J=function(R){const M=Qe[R];if(M!==void 0)return wc(M)}(Y),A=G.message;J===void 0&&(J=q.INTERNAL,A="Unknown error status: "+Y+" with message "+G.message),m=!0,v.__(new le(J,A)),d.close()}else ue(yt,`RPC '${t}' stream ${n} received:`,O),v.a_(O)}}),E(a,Vu.STAT_EVENT,T=>{T.stat===Zs.PROXY?ue(yt,`RPC '${t}' stream ${n} detected buffering proxy`):T.stat===Zs.NOPROXY&&ue(yt,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{v.o_()},0),v}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function Vs(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function us(s){return new Jg(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kc{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&ue("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wl="PersistentStream";class Fc{constructor(t,e,i,n,r,o,a,l){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=l,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new kc(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===q.RESOURCE_EXHAUSTED?(ei(e.toString()),ei("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===q.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new le(q.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return ue(Wl,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(ue(Wl,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Km extends Fc{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=tm(this.serializer,t),i=function(r){if(!("targetChange"in r))return Te.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?Te.min():o.readTime?Ht(o.readTime):Te.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=ro(this.serializer),e.addTarget=function(r,o){let a;const l=o.target;if(a=Js(l)?{documents:rm(r,l)}:{query:sm(r,l).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Ec(r,o.resumeToken);const u=to(r,o.expectedCount);u!==null&&(a.expectedCount=u)}else if(o.snapshotVersion.compareTo(Te.min())>0){a.readTime=Xr(r,o.snapshotVersion.toTimestamp());const u=to(r,o.expectedCount);u!==null&&(a.expectedCount=u)}return a}(this.serializer,t);const i=am(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=ro(this.serializer),e.removeTarget=t,this.k_(e)}}class Ym extends Fc{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return Le(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,Le(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){Le(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=nm(t.writeResults,t.commitTime),i=Ht(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=ro(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>im(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qm{}class Jm extends Qm{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new le(q.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,io(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===q.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new le(q.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,io(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===q.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new le(q.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class $m{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?(ei(e),this._a=!1):ue("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Di="RemoteStore";class ev{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{ki(this)&&(ue(Di,"Restarting streams for network reachability change."),await async function(l){const u=Ee(l);u.Ia.add(4),await $n(u),u.Aa.set("Unknown"),u.Ia.delete(4),await cs(u)}(this))})}),this.Aa=new $m(i,n)}}async function cs(s){if(ki(s))for(const t of s.da)await t(!0)}async function $n(s){for(const t of s.da)await t(!1)}function Oc(s,t){const e=Ee(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),No(e)?Lo(e):fn(e).x_()&&Vo(e,t))}function Oo(s,t){const e=Ee(s),i=fn(e);e.Ta.delete(t),i.x_()&&Vc(e,t),e.Ta.size===0&&(i.x_()?i.B_():ki(e)&&e.Aa.set("Unknown"))}function Vo(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Te.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}fn(s).H_(t)}function Vc(s,t){s.Ra.$e(t),fn(s).Y_(t)}function Lo(s){s.Ra=new Xg({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),fn(s).start(),s.Aa.aa()}function No(s){return ki(s)&&!fn(s).M_()&&s.Ta.size>0}function ki(s){return Ee(s).Ia.size===0}function Lc(s){s.Ra=void 0}async function tv(s){s.Aa.set("Online")}async function iv(s){s.Ta.forEach((t,e)=>{Vo(s,t)})}async function nv(s,t){Lc(s),No(s)?(s.Aa.la(t),Lo(s)):s.Aa.set("Unknown")}async function rv(s,t,e){if(s.Aa.set("Online"),t instanceof Tc&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){ue(Di,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await Yr(s,i)}else if(t instanceof Ir?s.Ra.Ye(t):t instanceof _c?s.Ra.it(t):s.Ra.et(t),!e.isEqual(Te.min()))try{const i=await Mc(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((l,u)=>{if(l.resumeToken.approximateByteSize()>0){const h=r.Ta.get(u);h&&r.Ta.set(u,h.withResumeToken(l.resumeToken,o))}}),a.targetMismatches.forEach((l,u)=>{const h=r.Ta.get(l);if(!h)return;r.Ta.set(l,h.withResumeToken(ft.EMPTY_BYTE_STRING,h.snapshotVersion)),Vc(r,l);const d=new si(h.target,l,u,h.sequenceNumber);Vo(r,d)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){ue(Di,"Failed to raise snapshot:",i),await Yr(s,i)}}async function Yr(s,t,e){if(!hn(t))throw t;s.Ia.add(1),await $n(s),s.Aa.set("Offline"),e||(e=()=>Mc(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{ue(Di,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await cs(s)})}function Nc(s,t){return t().catch(e=>Yr(s,e,t))}async function hs(s){const t=Ee(s),e=mi(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:_o;for(;sv(t);)try{const n=await zm(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,ov(t,n)}catch(n){await Yr(t,n)}Bc(t)&&zc(t)}function sv(s){return ki(s)&&s.Pa.length<10}function ov(s,t){s.Pa.push(t);const e=mi(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function Bc(s){return ki(s)&&!mi(s).M_()&&s.Pa.length>0}function zc(s){mi(s).start()}async function av(s){mi(s).na()}async function lv(s){const t=mi(s);for(const e of s.Pa)t.X_(e.mutations)}async function uv(s,t,e){const i=s.Pa.shift(),n=Ro.from(i,t,e);await Nc(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await hs(s)}async function cv(s,t){t&&mi(s).Z_&&await async function(i,n){if(function(o){return qg(o)&&o!==q.ABORTED}(n.code)){const r=i.Pa.shift();mi(i).N_(),await Nc(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await hs(i)}}(s,t),Bc(s)&&zc(s)}async function Gl(s,t){const e=Ee(s);e.asyncQueue.verifyOperationInProgress(),ue(Di,"RemoteStore received new credentials");const i=ki(e);e.Ia.add(3),await $n(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await cs(e)}async function hv(s,t){const e=Ee(s);t?(e.Ia.delete(2),await cs(e)):t||(e.Ia.add(2),await $n(e),e.Aa.set("Unknown"))}function fn(s){return s.Va||(s.Va=function(e,i,n){const r=Ee(e);return r.ia(),new Km(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:tv.bind(null,s),e_:iv.bind(null,s),n_:nv.bind(null,s),J_:rv.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),No(s)?Lo(s):s.Aa.set("Unknown")):(await s.Va.stop(),Lc(s))})),s.Va}function mi(s){return s.ma||(s.ma=function(e,i,n){const r=Ee(e);return r.ia(),new Ym(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:av.bind(null,s),n_:cv.bind(null,s),ea:lv.bind(null,s),ta:uv.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await hs(s)):(await s.ma.stop(),s.Pa.length>0&&(ue(Di,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bo{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new Ri,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new Bo(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new le(q.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function zo(s,t){if(ei("AsyncQueue",`${t}: ${s}`),hn(s))return new le(q.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $i{static emptySet(t){return new $i(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||pe.comparator(e.key,i.key):(e,i)=>pe.comparator(e.key,i.key),this.keyedMap=Cn(),this.sortedSet=new Ze(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof $i)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new $i;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ql{constructor(){this.fa=new Ze(pe.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):we(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class on{constructor(t,e,i,n,r,o,a,l,u){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=l,this.hasCachedResults=u}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new on(t,e,$i.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&rs(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dv{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class fv{constructor(){this.queries=Zl(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=Ee(e),r=n.queries;n.queries=Zl(),r.forEach((o,a)=>{for(const l of a.wa)l.onError(i)})})(this,new le(q.ABORTED,"Firestore shutting down"))}}function Zl(){return new Mi(s=>ac(s),rs)}async function pv(s,t){const e=Ee(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new dv,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=zo(o,`Initialization of query '${Ui(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&Ho(e)}async function gv(s,t){const e=Ee(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function mv(s,t){const e=Ee(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&Ho(e)}function vv(s,t,e){const i=Ee(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function Ho(s){s.Da.forEach(t=>{t.next()})}var ao,Xl;(Xl=ao||(ao={})).Fa="default",Xl.Cache="cache";class yv{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new on(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=on.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==ao.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hc{constructor(t){this.key=t}}class Uc{constructor(t){this.key=t}}class wv{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Ae(),this.mutatedKeys=Ae(),this.Xa=lc(t),this.eu=new $i(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new ql,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const l=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,u=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((h,d)=>{const f=n.get(h),m=ss(this.query,d)?d:null,v=!!f&&this.mutatedKeys.has(f.key),E=!!m&&(m.hasLocalMutations||this.mutatedKeys.has(m.key)&&m.hasCommittedMutations);let T=!1;f&&m?f.data.isEqual(m.data)?v!==E&&(i.track({type:3,doc:m}),T=!0):this.iu(f,m)||(i.track({type:2,doc:m}),T=!0,(l&&this.Xa(m,l)>0||u&&this.Xa(m,u)<0)&&(a=!0)):!f&&m?(i.track({type:0,doc:m}),T=!0):f&&!m&&(i.track({type:1,doc:f}),T=!0,(l||u)&&(a=!0)),T&&(m?(o=o.add(m),r=E?r.add(h):r.delete(h)):(o=o.delete(h),r=r.delete(h)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const h=this.query.limitType==="F"?o.last():o.first();o=o.delete(h.key),r=r.delete(h.key),i.track({type:1,doc:h})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((h,d)=>function(m,v){const E=T=>{switch(T){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return we(20277,{At:T})}};return E(m)-E(v)}(h.type,d.type)||this.Xa(h.doc,d.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],l=this.Za.size===0&&this.current&&!n?1:0,u=l!==this.Ya;return this.Ya=l,o.length!==0||u?{snapshot:new on(this.query,t.eu,r,o,t.mutatedKeys,l===0,u,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new ql,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Ae(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new Uc(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new Hc(i))}),e}uu(t){this.Ha=t.qs,this.Za=Ae();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return on.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const Uo="SyncEngine";class _v{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class Tv{constructor(t){this.key=t,this.lu=!1}}class Ev{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new Mi(a=>ac(a),rs),this.Tu=new Map,this.Iu=new Set,this.du=new Ze(pe.comparator),this.Eu=new Map,this.Au=new Do,this.Ru={},this.Vu=new Map,this.mu=sn.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function bv(s,t,e=!0){const i=Xc(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await jc(i,t,e,!0),n}async function xv(s,t){const e=Xc(s);await jc(e,t,!0,!1)}async function jc(s,t,e,i){const n=await Hm(s.localStore,zt(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await Sv(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&Oc(s.remoteStore,n),a}async function Sv(s,t,e,i,n){s.gu=(d,f,m)=>async function(E,T,x,O){let V=T.view.nu(x);V.Ds&&(V=await zl(E.localStore,T.query,!1).then(({documents:A})=>T.view.nu(A,V)));const G=O&&O.targetChanges.get(T.targetId),Y=O&&O.targetMismatches.get(T.targetId)!=null,J=T.view.applyChanges(V,E.isPrimaryClient,G,Y);return Yl(E,T.targetId,J._u),J.snapshot}(s,d,f,m);const r=await zl(s.localStore,t,!0),o=new wv(t,r.qs),a=o.nu(r.documents),l=Jn.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),u=o.applyChanges(a,s.isPrimaryClient,l);Yl(s,e,u._u);const h=new _v(t,e,o);return s.Pu.set(t,h),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),u.snapshot}async function Pv(s,t,e){const i=Ee(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!rs(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await so(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&Oo(i.remoteStore,n.targetId),lo(i,n.targetId)}).catch(cn)):(lo(i,n.targetId),await so(i.localStore,n.targetId,!0))}async function Cv(s,t){const e=Ee(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),Oo(e.remoteStore,i.targetId))}async function Rv(s,t,e){const i=Ov(s);try{const n=await function(o,a){const l=Ee(o),u=je.now(),h=a.reduce((m,v)=>m.add(v.key),Ae());let d,f;return l.persistence.runTransaction("Locally write mutations","readwrite",m=>{let v=ti(),E=Ae();return l.Os.getEntries(m,h).next(T=>{v=T,v.forEach((x,O)=>{O.isValidDocument()||(E=E.add(x))})}).next(()=>l.localDocuments.getOverlayedDocuments(m,v)).next(T=>{d=T;const x=[];for(const O of a){const V=Hg(O,d.get(O.key).overlayedDocument);V!=null&&x.push(new Ti(O.key,V,$u(V.value.mapValue),Vt.exists(!0)))}return l.mutationQueue.addMutationBatch(m,u,x,a)}).next(T=>{f=T;const x=T.applyToLocalDocumentSet(d,E);return l.documentOverlayCache.saveOverlays(m,T.batchId,x)})}).then(()=>({batchId:f.batchId,changes:cc(d)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,l){let u=o.Ru[o.currentUser.toKey()];u||(u=new Ze(Se)),u=u.insert(a,l),o.Ru[o.currentUser.toKey()]=u}(i,n.batchId,e),await er(i,n.changes),await hs(i.remoteStore)}catch(n){const r=zo(n,"Failed to persist write");e.reject(r)}}async function Wc(s,t){const e=Ee(s);try{const i=await Nm(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(Le(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?Le(o.lu,14607):n.removedDocuments.size>0&&(Le(o.lu,42227),o.lu=!1))}),await er(e,i,t)}catch(i){await cn(i)}}function Kl(s,t,e){const i=Ee(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const l=Ee(o);l.onlineState=a;let u=!1;l.queries.forEach((h,d)=>{for(const f of d.wa)f.va(a)&&(u=!0)}),u&&Ho(l)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function Iv(s,t,e){const i=Ee(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new Ze(pe.comparator);o=o.insert(r,_t.newNoDocument(r,Te.min()));const a=Ae().add(r),l=new ls(Te.min(),new Map,new Ze(Se),o,a);await Wc(i,l),i.du=i.du.remove(r),i.Eu.delete(t),jo(i)}else await so(i.localStore,t,!1).then(()=>lo(i,t,e)).catch(cn)}async function Av(s,t){const e=Ee(s),i=t.batch.batchId;try{const n=await Lm(e.localStore,t);qc(e,i,null),Gc(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await er(e,n)}catch(n){await cn(n)}}async function Dv(s,t,e){const i=Ee(s);try{const n=await function(o,a){const l=Ee(o);return l.persistence.runTransaction("Reject batch","readwrite-primary",u=>{let h;return l.mutationQueue.lookupMutationBatch(u,a).next(d=>(Le(d!==null,37113),h=d.keys(),l.mutationQueue.removeMutationBatch(u,d))).next(()=>l.mutationQueue.performConsistencyCheck(u)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(u,h,a)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(u,h)).next(()=>l.localDocuments.getDocuments(u,h))})}(i.localStore,t);qc(i,t,e),Gc(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await er(i,n)}catch(n){await cn(n)}}function Gc(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function qc(s,t,e){const i=Ee(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function lo(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||Zc(s,i)})}function Zc(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&(Oo(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),jo(s))}function Yl(s,t,e){for(const i of e)i instanceof Hc?(s.Au.addReference(i.key,t),Mv(s,i)):i instanceof Uc?(ue(Uo,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||Zc(s,i.key)):we(19791,{yu:i})}function Mv(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(ue(Uo,"New document in limbo: "+e),s.Iu.add(i),jo(s))}function jo(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new pe(ze.fromString(t)),i=s.mu.next();s.Eu.set(i,new Tv(e)),s.du=s.du.insert(e,i),Oc(s.remoteStore,new si(zt(So(e.path)),i,"TargetPurposeLimboResolution",ts.ue))}}async function er(s,t,e){const i=Ee(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,l)=>{o.push(i.gu(l,t,e).then(u=>{var h;if((u||e)&&i.isPrimaryClient){const d=u?!u.fromCache:(h=e==null?void 0:e.targetChanges.get(l.targetId))===null||h===void 0?void 0:h.current;i.sharedClientState.updateQueryState(l.targetId,d?"current":"not-current")}if(u){n.push(u);const d=ko.Es(l.targetId,u);r.push(d)}}))}),await Promise.all(o),i.hu.J_(n),await async function(l,u){const h=Ee(l);try{await h.persistence.runTransaction("notifyLocalViewChanges","readwrite",d=>X.forEach(u,f=>X.forEach(f.Is,m=>h.persistence.referenceDelegate.addReference(d,f.targetId,m)).next(()=>X.forEach(f.ds,m=>h.persistence.referenceDelegate.removeReference(d,f.targetId,m)))))}catch(d){if(!hn(d))throw d;ue(Fo,"Failed to update sequence numbers: "+d)}for(const d of u){const f=d.targetId;if(!d.fromCache){const m=h.Fs.get(f),v=m.snapshotVersion,E=m.withLastLimboFreeSnapshotVersion(v);h.Fs=h.Fs.insert(f,E)}}}(i.localStore,r))}async function kv(s,t){const e=Ee(s);if(!e.currentUser.isEqual(t)){ue(Uo,"User change. New user:",t.toKey());const i=await Dc(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(l=>{l.reject(new le(q.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await er(e,i.Bs)}}function Fv(s,t){const e=Ee(s),i=e.Eu.get(t);if(i&&i.lu)return Ae().add(i.key);{let n=Ae();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function Xc(s){const t=Ee(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=Wc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Fv.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Iv.bind(null,t),t.hu.J_=mv.bind(null,t.eventManager),t.hu.pu=vv.bind(null,t.eventManager),t}function Ov(s){const t=Ee(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Av.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Dv.bind(null,t),t}class Qr{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=us(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return Vm(this.persistence,new km,t.initialUser,this.serializer)}Du(t){return new Ac(Mo.Vi,this.serializer)}bu(t){return new jm}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}Qr.provider={build:()=>new Qr};class Vv extends Qr{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){Le(this.persistence.referenceDelegate instanceof Kr,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new ym(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?St.withCacheSize(this.cacheSizeBytes):St.DEFAULT;return new Ac(i=>Kr.Vi(i,e),this.serializer)}}class uo{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>Kl(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=kv.bind(null,this.syncEngine),await hv(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new fv}()}createDatastore(t){const e=us(t.databaseInfo.databaseId),i=function(r){return new Xm(r)}(t.databaseInfo);return function(r,o,a,l){return new Jm(r,o,a,l)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new ev(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>Kl(this.syncEngine,e,0),function(){return jl.C()?new jl:new Wm}())}createSyncEngine(t,e){return function(n,r,o,a,l,u,h){const d=new Ev(n,r,o,a,l,u);return h&&(d.fu=!0),d}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=Ee(n);ue(Di,"RemoteStore shutting down."),r.Ia.add(5),await $n(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}uo.provider={build:()=>new uo};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lv{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):ei("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vi="FirestoreClient";class Nv{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=wt.UNAUTHENTICATED,this.clientId=wo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{ue(vi,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(ue(vi,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Ri;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=zo(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function Ls(s,t){s.asyncQueue.verifyOperationInProgress(),ue(vi,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await Dc(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{hi("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{ue("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{hi("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function Ql(s,t){s.asyncQueue.verifyOperationInProgress();const e=await Bv(s);ue(vi,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>Gl(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>Gl(t.remoteStore,n)),s._onlineComponents=t}async function Bv(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){ue(vi,"Using user provided OfflineComponentProvider");try{await Ls(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===q.FAILED_PRECONDITION||n.code===q.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;hi("Error using user provided cache. Falling back to memory cache: "+e),await Ls(s,new Qr)}}else ue(vi,"Using default OfflineComponentProvider"),await Ls(s,new Vv(void 0));return s._offlineComponents}async function Kc(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(ue(vi,"Using user provided OnlineComponentProvider"),await Ql(s,s._uninitializedComponentsProvider._online)):(ue(vi,"Using default OnlineComponentProvider"),await Ql(s,new uo))),s._onlineComponents}function zv(s){return Kc(s).then(t=>t.syncEngine)}async function Jl(s){const t=await Kc(s),e=t.eventManager;return e.onListen=bv.bind(null,t.syncEngine),e.onUnlisten=Pv.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=xv.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=Cv.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yc(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $l=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qc="firestore.googleapis.com",eu=!0;class tu{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new le(q.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Qc,this.ssl=eu}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:eu;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=Ic;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<mm)throw new le(q.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}tg("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Yc((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new le(q.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new le(q.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new le(q.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class ds{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new tu({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new le(q.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new le(q.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new tu(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new qp;switch(i.type){case"firstParty":return new Yp(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new le(q.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=$l.get(e);i&&(ue("ComponentProvider","Removing Datastore"),$l.delete(e),i.terminate())}(this),Promise.resolve()}}function Hv(s,t,e,i={}){var n;s=ui(s,ds);const r=mo(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),l=`${t}:${e}`;r&&(Tf(`https://${l}`),Sf("Firestore",!0)),o.host!==Qc&&o.host!==l&&hi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const u=Object.assign(Object.assign({},o),{host:l,ssl:r,emulatorOptions:i});if(!Br(u,a)&&(s._setSettings(u),i.mockUserToken)){let h,d;if(typeof i.mockUserToken=="string")h=i.mockUserToken,d=wt.MOCK_USER;else{h=Ef(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const f=i.mockUserToken.sub||i.mockUserToken.user_id;if(!f)throw new le(q.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");d=new wt(f)}s._authCredentials=new Zp(new zu(h,d))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fi{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new Fi(this.firestore,t,this._query)}}class it{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ci(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new it(this.firestore,t,this._key)}toJSON(){return{type:it._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(Yn(e,it._jsonSchema))return new it(t,i||null,new pe(ze.fromString(e.referencePath)))}}it._jsonSchemaVersion="firestore/documentReference/1.0",it._jsonSchema={type:tt("string",it._jsonSchemaVersion),referencePath:tt("string")};class ci extends Fi{constructor(t,e,i){super(t,e,So(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new it(this.firestore,null,new pe(t))}withConverter(t){return new ci(this.firestore,t,this._path)}}function iu(s,t,...e){if(s=Gt(s),Uu("collection","path",t),s instanceof ds){const i=ze.fromString(t,...e);return fl(i),new ci(s,null,i)}{if(!(s instanceof it||s instanceof ci))throw new le(q.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(ze.fromString(t,...e));return fl(i),new ci(s.firestore,null,i)}}function co(s,t,...e){if(s=Gt(s),arguments.length===1&&(t=wo.newId()),Uu("doc","path",t),s instanceof ds){const i=ze.fromString(t,...e);return dl(i),new it(s,null,new pe(i))}{if(!(s instanceof it||s instanceof ci))throw new le(q.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(ze.fromString(t,...e));return dl(i),new it(s.firestore,s instanceof ci?s.converter:null,new pe(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nu="AsyncQueue";class ru{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new kc(this,"async_queue_retry"),this.oc=()=>{const i=Vs();i&&ue(nu,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=Vs();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=Vs();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new Ri;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!hn(t))throw t;ue(nu,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,ei("INTERNAL UNHANDLED ERROR: ",su(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=Bo.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&we(47125,{hc:su(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function su(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ou(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class an extends ds{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new ru,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new ru(t),this._firestoreClient=void 0,await t}}}function Uv(s,t){const e=typeof s=="object"?s:Op(),i=typeof s=="string"?s:jr,n=Ap(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=wf("firestore");r&&Hv(n,...r)}return n}function Jc(s){if(s._terminated)throw new le(q.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||jv(s),s._firestoreClient}function jv(s){var t,e,i;const n=s._freezeSettings(),r=function(a,l,u,h){return new dg(a,l,u,h.host,h.ssl,h.experimentalForceLongPolling,h.experimentalAutoDetectLongPolling,Yc(h.experimentalLongPollingOptions),h.useFetchStreams,h.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new Nv(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const l=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(l),_online:l}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dt{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Dt(ft.fromBase64String(t))}catch(e){throw new le(q.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new Dt(ft.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:Dt._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(Yn(t,Dt._jsonSchema))return Dt.fromBase64String(t.bytes)}}Dt._jsonSchemaVersion="firestore/bytes/1.0",Dt._jsonSchema={type:tt("string",Dt._jsonSchemaVersion),bytes:tt("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fs{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new le(q.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new dt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wo{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ut{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new le(q.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new le(q.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return Se(this._lat,t._lat)||Se(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:Ut._jsonSchemaVersion}}static fromJSON(t){if(Yn(t,Ut._jsonSchema))return new Ut(t.latitude,t.longitude)}}Ut._jsonSchemaVersion="firestore/geoPoint/1.0",Ut._jsonSchema={type:tt("string",Ut._jsonSchemaVersion),latitude:tt("number"),longitude:tt("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jt{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:jt._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(Yn(t,jt._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new jt(t.vectorValues);throw new le(q.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}jt._jsonSchemaVersion="firestore/vectorValue/1.0",jt._jsonSchema={type:tt("string",jt._jsonSchemaVersion),vectorValues:tt("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wv=/^__.*__$/;class Gv{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new Ti(t,this.data,this.fieldMask,e,this.fieldTransforms):new Qn(t,this.data,e,this.fieldTransforms)}}class $c{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new Ti(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function eh(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw we(40011,{Ec:s})}}class Go{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new Go(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return Jr(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(eh(this.Ec)&&Wv.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class qv{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||us(t)}Dc(t,e,i,n=!1){return new Go({Ec:t,methodName:e,bc:i,path:dt.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function qo(s){const t=s._freezeSettings(),e=us(s._databaseId);return new qv(s._databaseId,!!t.ignoreUndefinedProperties,e)}function Zv(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);Zo("Data must be an object, but it was:",o,i);const a=th(i,o);let l,u;if(r.merge)l=new It(o.fieldMask),u=o.fieldTransforms;else if(r.mergeFields){const h=[];for(const d of r.mergeFields){const f=ho(t,d,e);if(!o.contains(f))throw new le(q.INVALID_ARGUMENT,`Field '${f}' is specified in your field mask but missing from your input data.`);nh(h,f)||h.push(f)}l=new It(h),u=o.fieldTransforms.filter(d=>l.covers(d.field))}else l=null,u=o.fieldTransforms;return new Gv(new Pt(a),l,u)}class ps extends Wo{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof ps}}function Xv(s,t,e,i){const n=s.Dc(1,t,e);Zo("Data must be an object, but it was:",n,i);const r=[],o=Pt.empty();_i(i,(l,u)=>{const h=Xo(t,l,e);u=Gt(u);const d=n.gc(h);if(u instanceof ps)r.push(h);else{const f=tr(u,d);f!=null&&(r.push(h),o.set(h,f))}});const a=new It(r);return new $c(o,a,n.fieldTransforms)}function Kv(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[ho(t,i,e)],l=[n];if(r.length%2!=0)throw new le(q.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<r.length;f+=2)a.push(ho(t,r[f])),l.push(r[f+1]);const u=[],h=Pt.empty();for(let f=a.length-1;f>=0;--f)if(!nh(u,a[f])){const m=a[f];let v=l[f];v=Gt(v);const E=o.gc(m);if(v instanceof ps)u.push(m);else{const T=tr(v,E);T!=null&&(u.push(m),h.set(m,T))}}const d=new It(u);return new $c(h,d,o.fieldTransforms)}function Yv(s,t,e,i=!1){return tr(e,s.Dc(i?4:3,t))}function tr(s,t){if(ih(s=Gt(s)))return Zo("Unsupported field value:",t,s),th(s,t);if(s instanceof Wo)return function(i,n){if(!eh(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let l=tr(a,n.yc(o));l==null&&(l={nullValue:"NULL_VALUE"}),r.push(l),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=Gt(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return Og(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=je.fromDate(i);return{timestampValue:Xr(n.serializer,r)}}if(i instanceof je){const r=new je(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:Xr(n.serializer,r)}}if(i instanceof Ut)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof Dt)return{bytesValue:Ec(n.serializer,i._byteString)};if(i instanceof it){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:Ao(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof jt)return function(o,a){return{mapValue:{fields:{[Qu]:{stringValue:Ju},[Wr]:{arrayValue:{values:o.toArray().map(u=>{if(typeof u!="number")throw a.wc("VectorValues must only contain numeric values.");return Po(a.serializer,u)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${es(i)}`)}(s,t)}function th(s,t){const e={};return Gu(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):_i(s,(i,n)=>{const r=tr(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function ih(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof je||s instanceof Ut||s instanceof Dt||s instanceof it||s instanceof Wo||s instanceof jt)}function Zo(s,t,e){if(!ih(e)||!ju(e)){const i=es(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function ho(s,t,e){if((t=Gt(t))instanceof fs)return t._internalPath;if(typeof t=="string")return Xo(s,t);throw Jr("Field path arguments must be of type string or ",s,!1,void 0,e)}const Qv=new RegExp("[~\\*/\\[\\]]");function Xo(s,t,e){if(t.search(Qv)>=0)throw Jr(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new fs(...t.split("."))._internalPath}catch{throw Jr(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function Jr(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let l="";return(r||o)&&(l+=" (found",r&&(l+=` in field ${i}`),o&&(l+=` in document ${n}`),l+=")"),new le(q.INVALID_ARGUMENT,a+s+l)}function nh(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rh{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new it(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new Jv(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(gs("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class Jv extends rh{data(){return super.data()}}function gs(s,t){return typeof t=="string"?Xo(s,t):t instanceof fs?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $v(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new le(q.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Ko{}class sh extends Ko{}function ey(s,t,...e){let i=[];t instanceof Ko&&i.push(t),i=i.concat(e),function(r){const o=r.filter(l=>l instanceof Yo).length,a=r.filter(l=>l instanceof ms).length;if(o>1||o>0&&a>0)throw new le(q.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class ms extends sh{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new ms(t,e,i)}_apply(t){const e=this._parse(t);return oh(t._query,e),new Fi(t.firestore,t.converter,$s(t._query,e))}_parse(t){const e=qo(t.firestore);return function(r,o,a,l,u,h,d){let f;if(u.isKeyField()){if(h==="array-contains"||h==="array-contains-any")throw new le(q.INVALID_ARGUMENT,`Invalid Query. You can't perform '${h}' queries on documentId().`);if(h==="in"||h==="not-in"){lu(d,h);const v=[];for(const E of d)v.push(au(l,r,E));f={arrayValue:{values:v}}}else f=au(l,r,d)}else h!=="in"&&h!=="not-in"&&h!=="array-contains-any"||lu(d,h),f=Yv(a,o,d,h==="in"||h==="not-in");return et.create(u,h,f)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function ty(s,t,e){const i=t,n=gs("where",s);return ms._create(n,i,e)}class Yo extends Ko{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Yo(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:Lt.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const l of a)oh(o,l),o=$s(o,l)}(t._query,e),new Fi(t.firestore,t.converter,$s(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class Qo extends sh{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new Qo(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new le(q.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new le(q.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Gn(r,o)}(t._query,this._field,this._direction);return new Fi(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new dn(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function iy(s,t="asc"){const e=t,i=gs("orderBy",s);return Qo._create(i,e)}function au(s,t,e){if(typeof(e=Gt(e))=="string"){if(e==="")throw new le(q.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!oc(t)&&e.indexOf("/")!==-1)throw new le(q.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(ze.fromString(e));if(!pe.isDocumentKey(i))throw new le(q.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return Tl(s,new pe(i))}if(e instanceof it)return Tl(s,e._key);throw new le(q.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${es(e)}.`)}function lu(s,t){if(!Array.isArray(s)||s.length===0)throw new le(q.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function oh(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new le(q.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new le(q.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class ny{convertValue(t,e="none"){switch(gi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Ye(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(pi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw we(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return _i(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[Wr].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>Ye(o.doubleValue));return new jt(r)}convertGeoPoint(t){return new Ut(Ye(t.latitude),Ye(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=ns(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(Un(t));default:return null}}convertTimestamp(t){const e=fi(t);return new je(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=ze.fromString(t);Le(Rc(i),9688,{name:t});const n=new jn(i.get(1),i.get(3)),r=new pe(i.popFirst(5));return n.isEqual(e)||ei(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ry(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class In{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Ii extends rh{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Ar(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(gs("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new le(q.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=Ii._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}Ii._jsonSchemaVersion="firestore/documentSnapshot/1.0",Ii._jsonSchema={type:tt("string",Ii._jsonSchemaVersion),bundleSource:tt("string","DocumentSnapshot"),bundleName:tt("string"),bundle:tt("string")};class Ar extends Ii{data(t={}){return super.data(t)}}class en{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new In(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new Ar(this._firestore,this._userDataWriter,i.key,i,new In(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new le(q.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const l=new Ar(n._firestore,n._userDataWriter,a.doc.key,a.doc,new In(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:l,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const l=new Ar(n._firestore,n._userDataWriter,a.doc.key,a.doc,new In(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let u=-1,h=-1;return a.type!==0&&(u=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),h=o.indexOf(a.doc.key)),{type:sy(a.type),doc:l,oldIndex:u,newIndex:h}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new le(q.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=en._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=wo.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function sy(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return we(61501,{type:s})}}en._jsonSchemaVersion="firestore/querySnapshot/1.0",en._jsonSchema={type:tt("string",en._jsonSchemaVersion),bundleSource:tt("string","QuerySnapshot"),bundleName:tt("string"),bundle:tt("string")};class ah extends ny{constructor(t){super(),this.firestore=t}convertBytes(t){return new Dt(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new it(this.firestore,null,e)}}function oy(s,t,e,...i){s=ui(s,it);const n=ui(s.firestore,an),r=qo(n);let o;return o=typeof(t=Gt(t))=="string"||t instanceof fs?Kv(r,"updateDoc",s._key,t,e,i):Xv(r,"updateDoc",s._key,t),Jo(n,[o.toMutation(s._key,Vt.exists(!0))])}function ay(s){return Jo(ui(s.firestore,an),[new Co(s._key,Vt.none())])}function ly(s,t){const e=ui(s.firestore,an),i=co(s),n=ry(s.converter,t);return Jo(e,[Zv(qo(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,Vt.exists(!1))]).then(()=>i)}function uy(s,...t){var e,i,n;s=Gt(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||ou(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(ou(t[o])){const d=t[o];t[o]=(e=d.next)===null||e===void 0?void 0:e.bind(d),t[o+1]=(i=d.error)===null||i===void 0?void 0:i.bind(d),t[o+2]=(n=d.complete)===null||n===void 0?void 0:n.bind(d)}let l,u,h;if(s instanceof it)u=ui(s.firestore,an),h=So(s._key.path),l={next:d=>{t[o]&&t[o](cy(u,s,d))},error:t[o+1],complete:t[o+2]};else{const d=ui(s,Fi);u=ui(d.firestore,an),h=d._query;const f=new ah(u);l={next:m=>{t[o]&&t[o](new en(u,f,d,m))},error:t[o+1],complete:t[o+2]},$v(s._query)}return function(f,m,v,E){const T=new Lv(E),x=new yv(m,T,v);return f.asyncQueue.enqueueAndForget(async()=>pv(await Jl(f),x)),()=>{T.Ou(),f.asyncQueue.enqueueAndForget(async()=>gv(await Jl(f),x))}}(Jc(u),h,a,l)}function Jo(s,t){return function(i,n){const r=new Ri;return i.asyncQueue.enqueueAndForget(async()=>Rv(await zv(i),n,r)),r.promise}(Jc(s),t)}function cy(s,t,e){const i=e.docs.get(t._key),n=new ah(s);return new Ii(s,n,t._key,i,new In(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){un=n})(Fp),Hr(new Bn("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new an(new Xp(i.getProvider("auth-internal")),new Qp(o,i.getProvider("app-check-internal")),function(u,h){if(!Object.prototype.hasOwnProperty.apply(u.options,["projectId"]))throw new le(q.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new jn(u.options.projectId,h)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),Ji(al,ll,t),Ji(al,ll,"esm2017")})();var hy="firebase",dy="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Ji(hy,dy,"app");const fy={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},py=Au(fy),br=Uv(py);var gy=L('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),my=L("<div style=margin-bottom:12px;>"),vy=L('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;"> Add feedback'),yy=L("<div style=margin-top:16px;>"),wy=L('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),_y=L('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),Ty=L('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),Ey=L("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;>  </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),by=L("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),xy=L('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function uu({updateId:s,updateTitle:t}){const[e,i]=oe([]),[n,r]=oe(""),[o,a]=oe(null),[l,u]=oe(""),[h,d]=oe(!1),[f,m]=oe(localStorage.getItem("feedbackAuthor")||"Deji"),[v,E]=oe(!1),[T,x]=oe(!1),[O,V]=oe(!1);Gi(()=>{const S=ey(iu(br,"feedbacks"),ty("updateId","==",s),iy("timestamp","desc")),R=uy(S,M=>{const k=[];M.forEach(F=>{k.push({id:F.id,...F.data()})}),i(k)});return()=>R()});const G=async S=>{if(S.preventDefault(),!!n().trim()){d(!0);try{await ly(iu(br,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:f(),timestamp:new Date,edited:!1}),r(""),V(!1)}catch(R){console.error("Error adding feedback:",R)}d(!1)}},Y=async S=>{if(l().trim())try{await oy(co(br,"feedbacks",S),{text:l(),edited:!0,editedAt:new Date}),a(null),u("")}catch(R){console.error("Error editing feedback:",R)}},J=async S=>{if(confirm("Delete this feedback?"))try{await ay(co(br,"feedbacks",S))}catch(R){console.error("Error deleting feedback:",R)}},A=S=>{if(!S)return"";const R=S.toDate?S.toDate():new Date(S),k=new Date-R,F=Math.floor(k/(1e3*60*60));return F<1?"Just now":F<24?`${F} hour${F>1?"s":""} ago`:F<48?"Yesterday":R.toLocaleDateString()};return(()=>{var S=yy();return ee(S,he(Ve,{get when(){return e().length>0},get children(){var R=my();return ee(R,he(Vr,{get each(){return Ct(()=>!!T())()?e():e().slice(0,2)},children:M=>(()=>{var k=_y();return ee(k,he(Ve,{get when(){return o()===M.id},get fallback(){return[(()=>{var F=Ty();return ee(F,()=>M.text),F})(),(()=>{var F=Ey(),D=F.firstChild,xe=D.firstChild,Pe=D.nextSibling,te=Pe.firstChild,se=te.nextSibling;return ee(D,()=>M.author,xe),ee(D,()=>A(M.timestamp),null),ee(D,()=>M.edited&&" (edited)",null),te.$$click=()=>{a(M.id),u(M.text)},se.$$click=()=>J(M.id),F})()]},get children(){var F=wy(),D=F.firstChild,xe=D.nextSibling,Pe=xe.firstChild,te=Pe.nextSibling;return D.$$input=se=>u(se.target.value),Pe.$$click=()=>Y(M.id),te.$$click=()=>{a(null),u("")},Oe(()=>D.value=l()),F}})),k})()}),null),ee(R,he(Ve,{get when(){return e().length>2},get children(){var M=gy();return M.$$click=()=>x(!T()),ee(M,(()=>{var k=Ct(()=>!!T());return()=>k()?` Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),M}}),null),R}}),null),ee(S,he(Ve,{get when(){return!O()},get fallback(){return(()=>{var R=xy(),M=R.firstChild,k=M.firstChild,F=k.firstChild,D=F.nextSibling,xe=k.nextSibling,Pe=M.nextSibling,te=Pe.firstChild,se=te.nextSibling,W=se.firstChild,ne=W.nextSibling;return ee(D,f),xe.$$click=()=>E(!v()),ee(R,he(Ve,{get when(){return v()},get children(){var U=by(),fe=U.firstChild,re=fe.firstChild,K=re.nextSibling;return re.$$click=()=>{m("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),E(!1)},K.$$click=()=>{m("Deji"),localStorage.setItem("feedbackAuthor","Deji"),E(!1)},Oe(be=>{var ge=`background: ${f()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,ye=`background: ${f()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return be.e=An(re,ge,be.e),be.t=An(K,ye,be.t),be},{e:void 0,t:void 0}),U}}),Pe),Pe.addEventListener("submit",G),te.$$input=U=>r(U.target.value),ee(W,()=>h()?"Posting...":"Post"),ne.$$click=()=>{V(!1),r("")},Oe(U=>{var fe=h(),re=h()||!n().trim(),K=`background: ${h()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${h()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return fe!==U.e&&(te.disabled=U.e=fe),re!==U.t&&(W.disabled=U.t=re),U.a=An(W,K,U.a),U},{e:void 0,t:void 0,a:void 0}),Oe(()=>te.value=n()),R})()},get children(){var R=vy();return R.$$click=()=>V(!0),R}}),null),S})()}wi(["click","input"]);var Sy=L("<p>Added subtle variations to animations to make them feel more organic and hand-drawn. Each hotspot now reveals with its own unique character, preventing the repetitive feel of identical animations."),cu=L("<h4>What's new"),Py=L("<p><strong>Timing variations:</strong> Each animation has a slightly different speed (10% variation), making the reveals feel more natural.<br><strong>Curve adjustments:</strong> The animation curves are subtly varied for each hotspot, creating unique motion personalities.<br><strong>Organic feel:</strong> As you explore and hover over different hotspots, each one feels hand-drawn and unique rather than computer-generated."),Cy=L("<h4>Why it matters"),Ry=L("<p>When you hover over different hotspots throughout your exploration, each one now feels unique rather than repetitive. Every animation has its own rhythm and flow, creating a more artistic and engaging experience. It's a small detail that makes a big difference in how alive the artwork feels."),Iy=L('<p>These micro-variations are subtle enough to feel natural but significant enough to eliminate the "robot" feeling from animations.'),Ay=L("<p>Refined the button controls and zoom behavior based on user feedback. The viewing experience is now more intuitive and responsive across all devices."),Dy=L("<h4>Button improvements"),My=L("<p><strong>Better positioning:</strong> Buttons are now optimally placed on both landscape and portrait orientations.<br><strong>Visual refinements:</strong> Updated button styles for better visibility and a more modern look.<br><strong>Touch targets:</strong> Improved button sizes and spacing for easier interaction on mobile devices."),ky=L("<h4>Zoom enhancements"),Fy=L("<p><strong>Cinematic zoom:</strong> Smoother, more natural zoom animations when clicking on hotspots.<br><strong>Mouse wheel support:</strong> You can now zoom in and out using your mouse wheel or trackpad for precise control.<br><strong>Improved performance:</strong> Zoom operations are now more fluid, especially on mobile devices."),Oy=L("<p>These improvements make navigation feel more natural and give you better control over your viewing experience. The combination of refined buttons and enhanced zoom creates a more professional and polished interface."),Vy=L("<p>Completed a significant restructuring of the hotspot rendering system. The code is now much more organized and maintainable, which means faster improvements and easier bug fixes going forward."),Ly=L("<h4>What changed under the hood"),Ny=L("<p>Split the massive renderer file (over 3000 lines!) into smaller, focused modules. Each piece now handles one specific job - animations, Safari compatibility, performance optimization, etc. It's like organizing a cluttered workshop where every tool now has its proper place."),By=L("<h4>What this means for you"),zy=L("<p><strong>More reliable performance:</strong> The rendering system is now more efficient and predictable.<br><strong>Easier updates:</strong> Adding new features or fixing issues is now much simpler.<br><strong>Better stability:</strong> Less chance of one change breaking something else."),Hy=L("<p>Everything should work exactly as before - this was purely about making the code cleaner and more professional. If you notice any differences in behavior, please let me know!"),Uy=L("<p>Fixed the annoying flickering issue that occurred at the end of cinematic zoom animations. The zoom transitions are now smooth and stable across all platforms."),jy=L("<h4>What was happening"),Wy=L("<p>When zooming to a hotspot or expanding to full view, the animation would flicker between two zoom levels during the final moments. This was caused by conflicting optimization systems fighting for control."),Gy=L("<h4>The complete solution"),qy=L("<p>The flickering issue is now mostly resolved, but a complete fix still requires switching renderers once. This is a known initialization issue that we're investigating."),Zy=L(`<p><strong>Temporary workaround:</strong> If you still see flickering, press 'C' to open debug menu, click "Soft Glow" then "Sharp Outline" to fully eliminate the issue.`),Xy=L("<p><strong>Alternative:</strong> Type <code>fixFlickering()</code> in the browser console."),Ky=L("<ol><li><strong>Applied TileCascadeFix at startup</strong> - Prevents tile cascade issues</li><li><strong>Implemented CinematicZoomManager</strong> - Coordinates all zoom animations with proper damping</li><li><strong>Added forceRedraw() calls</strong> - Ensures the viewer refreshes properly after animations</li><li><strong>State reset after initialization</strong> - Attempts to clean up any initialization issues"),Yy=L("<h4>Technical improvements"),Qy=L("<p><strong>Desktop:</strong> 1.0s animation with 6.5 spring stiffness<br><strong>Mobile:</strong> 1.2s animation with 8.0 spring stiffness<br><strong>Cinematic mode:</strong> Temporarily disables tile optimizations during zoom"),Jy=L("<p><em>The difference is immediately noticeable - zoom animations now feel professional and polished, matching the quality of the rest of the viewer."),$y=L('<p>Removed the complex "Zoom Performance" section from the debug menu to simplify the interface.'),Ns=L("<h4>What changed"),ew=L("<p>The debug menu now focuses on essential controls for visual customization, interaction behavior, and hotspot discovery. Advanced zoom tuning parameters have been removed as they were rarely used and added unnecessary complexity."),tw=L("<p><em>The artwork already performs at 60 FPS with the default settings, making manual tuning unnecessary for most users."),iw=L("<p>Fixed the issue where Playwright manual tests weren't opening a visible browser window. The tests were running in headless mode by default."),nw=L("<p>Added the <code>--headed</code> option to all manual test scripts. Now when you run tests for Safari or mobile debugging, an actual browser window will open for visual inspection."),rw=L("<h4>Available test commands"),sw=L("<p><strong>Safari Desktop Manual Test:</strong><br><code>npm run test:safari-desktop</code><br>Opens webkit browser for desktop Safari testing with debug overlays."),ow=L("<p><strong>iOS Safari Manual Test:</strong><br><code>npm run test:ios-safari</code><br>Opens webkit browser for mobile Safari testing."),aw=L("<p><strong>Direct command with options:</strong><br><code>npx playwright test tests/safari-desktop-manual-test.spec.js --project=webkit --headed"),lw=L("<p><em>The test window stays open for 10 minutes to allow thorough manual testing. Press Ctrl+C to stop the test when done."),uw=L("<p>Fixed a visual issue where the artwork was displaying grainy artifacts. The monochrome drawings now render cleanly at all zoom levels."),cw=L("<p>The image had a noisy, pixelated appearance that was distracting. Adjusted the rendering settings to better handle black and white artwork - the difference is quite striking."),hw=L("<p>Fixed several mobile-specific issues that were affecting the zoom experience and made the debug controls more reliable across all devices."),dw=L("<h4>Mobile zoom improvements"),fw=L("<p><strong>Smoother zooming</strong><br>The cinematic zoom when tapping hotspots now performs better on phones and tablets. Reduced stuttering during the animation and improved frame rates on lower-end devices."),pw=L("<p><strong>Touch responsiveness</strong><br>Fixed an issue where hotspots would sometimes become unresponsive after zooming. Touch interactions now reset properly after each zoom animation completes."),gw=L("<h4>Debug panel refinements"),mw=L("<p>Made the mobile debug controls more stable - the slide-up panel now opens and closes more reliably, and the FPS counter updates consistently. Also improved the visual spacing on smaller screens."),vw=L("<p><em>Small but important fixes that should make the mobile experience feel more polished and responsive."),yw=L("<p>The debug controls (press 'C' to open) now work on phones and tablets."),ww=L("<p><strong>Mobile devices</strong><br>A compact bar at the bottom shows FPS and a settings icon. Tap it to reveal controls that slide up. Swipe down or tap outside to dismiss."),_w=L("<p><strong>Desktop</strong><br>The panel can now be minimized to a small floating button instead of closing completely."),Tw=L("<p><em>Small quality-of-life improvement, but it makes testing on different devices much more pleasant!"),Ew=L("<p>The experimental touch-hold system I mentioned yesterday is now more reliable. After testing, I found and fixed an issue where hotspots would sometimes stop responding after being activated once."),bw=L("<h4>What's improved"),xw=L(`<p>If you enable "Temporal" mode in the debug menu (press 'C'), the hold-to-interact system now works consistently. Hotspots stay visible while you hold them, and each interaction resets cleanly for the next one.`),Sw=L("<h4>Also tweaked"),Pw=L("<p>Added white color options to the border palette since you're working with black ink artwork. More importantly, <strong>temporal mode is now the default on mobile devices</strong> - meaning visitors will use the hold-to-interact system instead of direct taps. You can always switch back to standard tap-to-zoom in the debug menu if needed."),Cw=L("<p>With ~600 interactive zones hidden throughout your artwork, I've added a way to briefly reveal what's clickable without disrupting the visual experience."),Rw=L("<h4>How it works"),Iw=L("<p>Press 'H' (desktop) or triple-tap anywhere (mobile) to make all nearby hotspots gently pulse for 6 seconds. The effect uses contrast inversion to ensure visibility on your black ink artwork while staying subtle enough not to break immersion."),Aw=L("<h4>Also included: Alternative touch controls"),Dw=L(`<p>For mobile users, I've prepared an experimental hold-to-interact system that's currently tucked away in the debug menu. If you're curious, press 'C' to open debug options and switch from "Direct" to "Temporal" interaction. This changes how taps work - but the standard tap-to-zoom remains the default for now.`),Mw=L("<p>The reveal helper should make exploration feel less like guesswork and more like discovery. Let me know if the visibility needs adjusting - it's easy to make it bolder or more subtle based on your preference."),kw=L("<p><strong>Safari animations:</strong> Now working! Chrome/Firefox/Edge still have the edge visually, but Safari's functional. Requires Safari 13.1+ (2020 or newer)."),Fw=L("<p><strong>Smart zoom behavior:</strong> Following Google Arts & Culture's approach, animations now adapt to zoom level. Below 8x zoom = full animations. Above 8x = quick 150ms transitions only. When you're examining details up close, decorative animations would just distract."),Ow=L("<p><strong>Next:</strong> Making the cinematic zoom buttery smooth when clicking hotspots. Also thinking the stroke animation makes sense for desktop, but mobile needs something snappier."),Vw=L("<p><em>Personal note: Getting really excited - it's starting to take shape! :D"),Lw=L("<p><strong>Current status:</strong> While the hover animations now work on Safari, the visual effect isn't as pronounced as on Chrome/Firefox. I'm quite proud of the result on chrome at the moment. I think it's quite satisfying."),Nw=L("<p><strong>Recommendation:</strong> Use Chrome for now to see the intended visual impact. The difference is noticeable - Chrome displays richer glows and better depth."),Bw=L("<p><strong>What's next:</strong> Working on Safari-specific optimizations to improve the visual quality without compromising performance."),zw=L("<p><strong>Following up on July 7th:</strong> The Safari issue is fixed! The stroke reveal animation now works properly on Safari desktop where you can actually hover."),Hw=L("<p><strong>Next up</strong>: Making the animation more visible and impactful for desktop users, plus exploring touch-friendly animations for mobile devices."),Uw=L("<p><strong>Responding to your feedback:</strong> You mentioned the hover effect felt static with just the white border appearing. I've implemented a first animation to bring more life to the interactions."),jw=L(`<p><strong>What's new:</strong> A stroke reveal animation that progressively traces the hotspot outline when you hover. Instead of the border just "popping" into view, it now draws itself smoothly around the shape - like watching someone trace the contour with a pen.`),Ww=L("<p><strong>Current settings:</strong><br> White stroke with subtle shadow for visibility<br> 1.2 second drawing animation<br> Works on Chrome, Firefox, and Edge"),Gw=L("<p><strong>Needs refinement:</strong> The animation is quite subtle right now - you might have to look closely to see the progressive drawing effect. I'll be adjusting the timing and visibility to make it more noticeable and satisfying."),qw=L("<p><strong>Safari issue discovered:</strong> Just noticed the animation isn't working properly on Safari (There's always something with Safari ). Will fix this tomorrow along with the other refinements."),Zw=L("<p><strong>Note:</strong> This is one hover effect I wanted to try first. I'm planning to experiment with additional animations to find what feels best for your artwork. Let me know your thoughts!"),Xw=L("<p><strong>What's improved:</strong> The circular spotlight effect in Apple Mode (Safari/iOS) now adapts much better to different hotspot shapes."),Kw=L("<p><strong>What changed:</strong><br> Spotlights are now tighter and more focused around each hotspot (both mobile and desktop)<br> Better detection of when to use circles vs ellipses based on hotspot shape"),Yw=L("<p><strong>The result:</strong> Whether a hotspot is round, tall, wide, or irregular, the spotlight should now feel more natural and better frame the content the user is exploring."),Qw=L("<p>Try clicking on different shaped hotspots - the spotlight should feel more consistent and purposeful now!"),Jw=L("<p><strong>The issue:</strong> Some complex hotspots still extend outside the spotlight area after yesterday's improvements."),$w=L("<p><strong>Today's attempt:</strong> Since a single circular spotlight can't perfectly cover irregular shapes, I tried combining multiple circles at different positions to fill in the gaps. Unfortunately, Safari doesn't support this technique - it only displays one spotlight instead of blending them together like other browsers do."),e_=L("<p><strong>Next:</strong> Fine-tuning the spotlight sizing parameters to better fit each hotspot's unique shape."),t_=L("<p><strong>What's improved:</strong> The spotlight effect on Safari and iOS devices now much better matches the actual hotspot shapes, especially on desktop Safari!"),i_=L("<p><strong>Key changes:</strong><br> Spotlights now use elliptical shapes for elongated hotspots<br> Tighter, more precise spotlight coverage that follows the hotspot boundaries closely<br> Better visual consistency between the outline of the hotspot and the darkened area<br> Desktop Safari shows the most dramatic improvements, mobile iOS continues to be refined"),n_=L("<p><strong>Still fine-tuning:</strong> Some complex hotspots have small areas that peek slightly outside the spotlight. Mobile Safari needs additional optimization for the same precision as desktop."),r_=L("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),s_=L('<p><strong>How it works:</strong><br> Type your feedback in the text box below any update<br> Click "Post Feedback" to send<br> Edit or delete your comments anytime<br> Everything syncs in real-time between us'),o_=L('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),a_=L("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),l_=L("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),u_=L("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),c_=L("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),h_=L("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),d_=L("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),f_=L("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),p_=L("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br> Uses radial gradient masks instead of polygon cutouts<br> Provides a circular/elliptical spotlight effect around hotspots<br> Maintains smooth 60 FPS performance on all iOS devices"),g_=L("<p><strong>What's Different:</strong><br> <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br> <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),m_=L("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),v_=L("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),y_=L("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),w_=L("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br> iPhone (Safari & Chrome)<br> iPad (Safari & Chrome)<br> Mac (Safari only - Chrome works fine!)"),__=L("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),T_=L("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),E_=L("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),b_=L("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),x_=L("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),S_=L("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),P_=L(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now  `),C_=L("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),R_=L(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),I_=L("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),A_=L("<p>Hey Deji! "),D_=L("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),M_=L("<p>I totally relate to your potato mode confession  We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),k_=L("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable  I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),F_=L(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),O_=L("<p>Looking forward to showing you the improvements!<br>- Leonard"),V_=L('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),L_=L(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn></button></div><div class=update-section style="background:linear-gradient(135deg, #1a1f2e 0%, #1e2330 100%);border:1px solid rgba(0, 136, 204, 0.3);margin-bottom:20px;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);"><h4 style="color:#0088cc;margin:0 0 16px 0;font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px;"><span style=font-size:20px;></span> Communication Update</h4><p style="color:rgba(255, 255, 255, 0.85);margin:0 0 20px 0;font-size:14px;line-height:1.6;">Our Upwork channel is no longer available. I've reached out via your business contacts and remain fully committed to your project.</p><div style="background:rgba(0, 136, 204, 0.1);padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;"><a href=https://t.me/LeonardCote target=_blank style="display:inline-flex;align-items:center;gap:8px;background:#0088cc;color:white;padding:10px 24px;border-radius:6px;text-decoration:none;font-weight:500;font-size:15px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0, 136, 204, 0.3);"><svg width=16 height=16 viewBox="0 0 24 24"fill=currentColor><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.223-.548.223l.188-2.85 5.18-4.68c.223-.198-.054-.308-.346-.111l-6.4 4.02-2.76-.918c-.6-.187-.612-.6.125-.89l10.782-4.156c.5-.18.94.12.78.88z"></path></svg>Message me on Telegram</a><p style="color:rgba(255, 255, 255, 0.6);margin:12px 0 0 0;font-size:13px;text-align:center;">or email: <a href=mailto:leonard.cote08@gmail.com style=color:#0088cc;text-decoration:none;>leonard.cote08@gmail.com</a></p></div><p style="color:rgba(255, 255, 255, 0.7);margin:0;font-size:13px;line-height:1.5;">The project continues to progress. All updates are posted here.<br><em style=opacity:0.8;>Platform details can be discussed when we connect.</em></p></div><style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style><div class=message-toggle><button class=toggle-btn>`),hu=L("<div class=update-section><h4> (<!>)"),N_=L("<div class=app-container>"),B_=L("<div class=loading-screen><p>Loading Interactive Art Diary...");function z_({onClose:s}){const[t,e]=oe(!1);oe(!1);const i=[{id:"organic-animations-july26",date:"July 26",title:" Natural Animation Variations",content:[Sy(),cu(),Py(),Cy(),Ry(),Iy()]},{id:"button-zoom-improvements-july25",date:"July 25",title:" Button Controls & Zoom Improvements",content:[Ay(),Dy(),My(),ky(),Fy(),Oy()]},{id:"architecture-refactor-july24",date:"July 24",title:" Major Architecture Improvements",content:[Vy(),Ly(),Ny(),By(),zy(),Hy()]},{id:"cinematic-zoom-fix-july16",date:"July 16",title:" Cinematic Zoom Fixed - No More Flickering",content:[Uy(),jy(),Wy(),Gy(),qy(),Zy(),Xy(),Ky(),Yy(),Qy(),Jy()]},{id:"debug-menu-cleanup-july15",date:"July 15",title:" Debug Menu Simplified",content:[$y(),Ns(),ew(),tw()]},{id:"playwright-manual-tests-july15",date:"July 15",title:" Manual Test Window Fix for Playwright",content:[iw(),Ns(),nw(),rw(),sw(),ow(),aw(),lw()]},{id:"visual-artifacts-july15",date:"July 15",title:" Visual Quality Fix - No More Grain",content:[uw(),Ns(),cw()]},{id:"mobile-zoom-july14",date:"July 14",title:" Mobile Zoom Performance & Debug Improvements",content:[hw(),dw(),fw(),pw(),gw(),mw(),vw()]},{id:"debug-panel-july13",date:"July 13",title:" Control Panel Goes Mobile-Friendly",content:[yw(),cu(),ww(),_w(),Tw()]},{id:"temporal-polish-july12",date:"July 12",title:" Mobile Touch Controls Refined",content:[Ew(),bw(),xw(),Sw(),Pw()]},{id:"reveal-mode-july11",date:"July 11",title:" Easier Mobile Exploration",content:[Cw(),Rw(),Iw(),Aw(),Dw(),Mw()]},{id:"safari-compatibility-july10",date:"July 10",title:" Safari Compatibility & Smart Zoom Update",content:[kw(),Fw(),Ow(),Vw()]},{id:"safari-visual-july9",date:"July 9",title:"Visual Effects - Browser Differences",content:[Lw(),Nw(),Bw()]},{id:"safari-fix-july8",date:"July 8",title:" Safari Issue Resolved",content:[zw(),Hw()]},{id:"hover-animations-july7",date:"July 7 - night",title:" Hover Animation Update",content:[Uw(),jw(),Ww(),Gw(),qw(),Zw()]},{id:"spotlight-refinements-july7",date:"July 7",title:" Apple Mode Spotlight Improvements",content:[Xw(),Kw(),Yw(),Qw()]},{id:"spotlight-coverage-july5",date:"July 5",title:" Working on Complete Hotspot Coverage for Safari/iOS",content:[Jw(),$w(),e_()]},{id:"spotlight-improvements-july4",date:"July 4",title:" Spotlight Effect Improvements for Safari/iOS",content:[t_(),i_(),n_()]},{id:"feedback-system-july3",date:"July 3 - night",title:" New: Direct Feedback System",content:[r_(),s_(),o_(),a_()]},{id:"border-experiment-july3",date:"July 3",title:" Border Experiment for Apple Mode",content:[l_(),u_(),c_(),h_(),d_()]},{id:"safari-solution-july2",date:"July 2",title:" Safari/iOS Spotlight Solution Implemented",content:[f_(),p_(),g_(),m_(),v_()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:" Spotlight Effect - Browser Compatibility",content:[y_(),w_(),__(),T_(),E_(),b_()]},{id:"zoom-speed-july1",date:"July 1",title:" Zoom Speed Control & Performance Update",content:[x_(),S_(),P_(),C_()]},{id:"performance-june30",date:"June 30",title:" Performance Breakthrough",content:R_()},{id:"focus-mode-june29",date:"June 29",title:" New Feature",content:I_()},{id:"personal-june28",date:"June 28",title:" Personal Message",content:[A_(),D_(),M_(),k_(),F_(),O_()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=L_(),a=o.firstChild,l=a.firstChild,u=l.nextSibling,h=a.nextSibling,d=h.nextSibling,f=d.nextSibling,m=f.firstChild;return Gh(u,"click",s),ee(o,()=>n.map(v=>(()=>{var E=hu(),T=E.firstChild,x=T.firstChild,O=x.nextSibling;return O.nextSibling,ee(T,()=>v.title,x),ee(T,()=>v.date,O),ee(E,()=>v.content,null),ee(E,he(uu,{get updateId(){return v.id},get updateTitle(){return v.title}}),null),E})()),f),m.$$click=()=>e(!t()),ee(m,()=>t()?" Hide previous updates":"+ Show previous updates"),ee(o,he(Ve,{get when(){return t()},get children(){var v=V_();return v.firstChild,ee(v,()=>r.map(E=>(()=>{var T=hu(),x=T.firstChild,O=x.firstChild,V=O.nextSibling;return V.nextSibling,ee(x,()=>E.title,O),ee(x,()=>E.date,V),ee(T,()=>E.content,null),ee(T,he(uu,{get updateId(){return E.id},get updateTitle(){return E.title}}),null),T})()),null),v}}),null),o})()}function H_(){const[s,t]=oe(!1),[e]=oe("zebra"),[i,n]=oe(!0),r=()=>{n(!1)};return kr(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var o=N_();return ee(o,(()=>{var a=Ct(()=>!!i());return()=>a()&&he(z_,{onClose:r})})(),null),ee(o,(()=>{var a=Ct(()=>!!s());return()=>a()?he(lf,{get artworkId(){return e()}}):B_()})(),null),o})()}wi(["click"]);const U_=document.getElementById("root");Wh(()=>he(H_,{}),U_);export{X_ as E,Qt as O,Kh as _,q_ as a,K_ as b,Yh as c,Pi as d,po as e,j_ as g,$e as i,Z_ as r};
