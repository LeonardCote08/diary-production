const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/viewerEventHandlers-BgdH7enW.js","assets/main-C1EKgx4S.js","assets/main-DQBG4I_D.css"])))=>i.map(i=>d[i]);
var re=Object.defineProperty;var ne=(l,t,e)=>t in l?re(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var N=(l,t,e)=>ne(l,typeof t!="symbol"?t+"":t,e);import{c as B,O as z,i as oe,g as se,a as U,b as $,d as K,e as ae,_ as le,r as J}from"./main-C1EKgx4S.js";var I={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(l){(function(){var t=function(){this.init()};t.prototype={init:function(){var i=this||e;return i._counter=1e3,i._html5AudioPool=[],i.html5PoolSize=10,i._codecs={},i._howls=[],i._muted=!1,i._volume=1,i._canPlayEvent="canplaythrough",i._navigator=typeof window<"u"&&window.navigator?window.navigator:null,i.masterGain=null,i.noAudio=!1,i.usingWebAudio=!0,i.autoSuspend=!0,i.ctx=null,i.autoUnlock=!0,i._setup(),i},volume:function(i){var n=this||e;if(i=parseFloat(i),n.ctx||v(),typeof i<"u"&&i>=0&&i<=1){if(n._volume=i,n._muted)return n;n.usingWebAudio&&n.masterGain.gain.setValueAtTime(i,e.ctx.currentTime);for(var a=0;a<n._howls.length;a++)if(!n._howls[a]._webAudio)for(var c=n._howls[a]._getSoundIds(),p=0;p<c.length;p++){var u=n._howls[a]._soundById(c[p]);u&&u._node&&(u._node.volume=u._volume*i)}return n}return n._volume},mute:function(i){var n=this||e;n.ctx||v(),n._muted=i,n.usingWebAudio&&n.masterGain.gain.setValueAtTime(i?0:n._volume,e.ctx.currentTime);for(var a=0;a<n._howls.length;a++)if(!n._howls[a]._webAudio)for(var c=n._howls[a]._getSoundIds(),p=0;p<c.length;p++){var u=n._howls[a]._soundById(c[p]);u&&u._node&&(u._node.muted=i?!0:u._muted)}return n},stop:function(){for(var i=this||e,n=0;n<i._howls.length;n++)i._howls[n].stop();return i},unload:function(){for(var i=this||e,n=i._howls.length-1;n>=0;n--)i._howls[n].unload();return i.usingWebAudio&&i.ctx&&typeof i.ctx.close<"u"&&(i.ctx.close(),i.ctx=null,v()),i},codecs:function(i){return(this||e)._codecs[i.replace(/^x-/,"")]},_setup:function(){var i=this||e;if(i.state=i.ctx&&i.ctx.state||"suspended",i._autoSuspend(),!i.usingWebAudio)if(typeof Audio<"u")try{var n=new Audio;typeof n.oncanplaythrough>"u"&&(i._canPlayEvent="canplay")}catch{i.noAudio=!0}else i.noAudio=!0;try{var n=new Audio;n.muted&&(i.noAudio=!0)}catch{}return i.noAudio||i._setupCodecs(),i},_setupCodecs:function(){var i=this||e,n=null;try{n=typeof Audio<"u"?new Audio:null}catch{return i}if(!n||typeof n.canPlayType!="function")return i;var a=n.canPlayType("audio/mpeg;").replace(/^no$/,""),c=i._navigator?i._navigator.userAgent:"",p=c.match(/OPR\/(\d+)/g),u=p&&parseInt(p[0].split("/")[1],10)<33,h=c.indexOf("Safari")!==-1&&c.indexOf("Chrome")===-1,_=c.match(/Version\/(.*?) /),y=h&&_&&parseInt(_[1],10)<15;return i._codecs={mp3:!!(!u&&(a||n.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!a,opus:!!n.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(n.canPlayType('audio/wav; codecs="1"')||n.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!n.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!n.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(n.canPlayType("audio/x-m4a;")||n.canPlayType("audio/m4a;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(n.canPlayType("audio/x-m4b;")||n.canPlayType("audio/m4b;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(n.canPlayType("audio/x-mp4;")||n.canPlayType("audio/mp4;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!y&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!y&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!n.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(n.canPlayType("audio/x-flac;")||n.canPlayType("audio/flac;")).replace(/^no$/,"")},i},_unlockAudio:function(){var i=this||e;if(!(i._audioUnlocked||!i.ctx)){i._audioUnlocked=!1,i.autoUnlock=!1,!i._mobileUnloaded&&i.ctx.sampleRate!==44100&&(i._mobileUnloaded=!0,i.unload()),i._scratchBuffer=i.ctx.createBuffer(1,1,22050);var n=function(a){for(;i._html5AudioPool.length<i.html5PoolSize;)try{var c=new Audio;c._unlocked=!0,i._releaseHtml5Audio(c)}catch{i.noAudio=!0;break}for(var p=0;p<i._howls.length;p++)if(!i._howls[p]._webAudio)for(var u=i._howls[p]._getSoundIds(),h=0;h<u.length;h++){var _=i._howls[p]._soundById(u[h]);_&&_._node&&!_._node._unlocked&&(_._node._unlocked=!0,_._node.load())}i._autoResume();var y=i.ctx.createBufferSource();y.buffer=i._scratchBuffer,y.connect(i.ctx.destination),typeof y.start>"u"?y.noteOn(0):y.start(0),typeof i.ctx.resume=="function"&&i.ctx.resume(),y.onended=function(){y.disconnect(0),i._audioUnlocked=!0,document.removeEventListener("touchstart",n,!0),document.removeEventListener("touchend",n,!0),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0);for(var S=0;S<i._howls.length;S++)i._howls[S]._emit("unlock")}};return document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),i}},_obtainHtml5Audio:function(){var i=this||e;if(i._html5AudioPool.length)return i._html5AudioPool.pop();var n=new Audio().play();return n&&typeof Promise<"u"&&(n instanceof Promise||typeof n.then=="function")&&n.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(i){var n=this||e;return i._unlocked&&n._html5AudioPool.push(i),n},_autoSuspend:function(){var i=this;if(!(!i.autoSuspend||!i.ctx||typeof i.ctx.suspend>"u"||!e.usingWebAudio)){for(var n=0;n<i._howls.length;n++)if(i._howls[n]._webAudio){for(var a=0;a<i._howls[n]._sounds.length;a++)if(!i._howls[n]._sounds[a]._paused)return i}return i._suspendTimer&&clearTimeout(i._suspendTimer),i._suspendTimer=setTimeout(function(){if(i.autoSuspend){i._suspendTimer=null,i.state="suspending";var c=function(){i.state="suspended",i._resumeAfterSuspend&&(delete i._resumeAfterSuspend,i._autoResume())};i.ctx.suspend().then(c,c)}},3e4),i}},_autoResume:function(){var i=this;if(!(!i.ctx||typeof i.ctx.resume>"u"||!e.usingWebAudio))return i.state==="running"&&i.ctx.state!=="interrupted"&&i._suspendTimer?(clearTimeout(i._suspendTimer),i._suspendTimer=null):i.state==="suspended"||i.state==="running"&&i.ctx.state==="interrupted"?(i.ctx.resume().then(function(){i.state="running";for(var n=0;n<i._howls.length;n++)i._howls[n]._emit("resume")}),i._suspendTimer&&(clearTimeout(i._suspendTimer),i._suspendTimer=null)):i.state==="suspending"&&(i._resumeAfterSuspend=!0),i}};var e=new t,r=function(i){var n=this;if(!i.src||i.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}n.init(i)};r.prototype={init:function(i){var n=this;return e.ctx||v(),n._autoplay=i.autoplay||!1,n._format=typeof i.format!="string"?i.format:[i.format],n._html5=i.html5||!1,n._muted=i.mute||!1,n._loop=i.loop||!1,n._pool=i.pool||5,n._preload=typeof i.preload=="boolean"||i.preload==="metadata"?i.preload:!0,n._rate=i.rate||1,n._sprite=i.sprite||{},n._src=typeof i.src!="string"?i.src:[i.src],n._volume=i.volume!==void 0?i.volume:1,n._xhr={method:i.xhr&&i.xhr.method?i.xhr.method:"GET",headers:i.xhr&&i.xhr.headers?i.xhr.headers:null,withCredentials:i.xhr&&i.xhr.withCredentials?i.xhr.withCredentials:!1},n._duration=0,n._state="unloaded",n._sounds=[],n._endTimers={},n._queue=[],n._playLock=!1,n._onend=i.onend?[{fn:i.onend}]:[],n._onfade=i.onfade?[{fn:i.onfade}]:[],n._onload=i.onload?[{fn:i.onload}]:[],n._onloaderror=i.onloaderror?[{fn:i.onloaderror}]:[],n._onplayerror=i.onplayerror?[{fn:i.onplayerror}]:[],n._onpause=i.onpause?[{fn:i.onpause}]:[],n._onplay=i.onplay?[{fn:i.onplay}]:[],n._onstop=i.onstop?[{fn:i.onstop}]:[],n._onmute=i.onmute?[{fn:i.onmute}]:[],n._onvolume=i.onvolume?[{fn:i.onvolume}]:[],n._onrate=i.onrate?[{fn:i.onrate}]:[],n._onseek=i.onseek?[{fn:i.onseek}]:[],n._onunlock=i.onunlock?[{fn:i.onunlock}]:[],n._onresume=[],n._webAudio=e.usingWebAudio&&!n._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(n),n._autoplay&&n._queue.push({event:"play",action:function(){n.play()}}),n._preload&&n._preload!=="none"&&n.load(),n},load:function(){var i=this,n=null;if(e.noAudio){i._emit("loaderror",null,"No audio support.");return}typeof i._src=="string"&&(i._src=[i._src]);for(var a=0;a<i._src.length;a++){var c,p;if(i._format&&i._format[a])c=i._format[a];else{if(p=i._src[a],typeof p!="string"){i._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}c=/^data:audio\/([^;,]+);/i.exec(p),c||(c=/\.([^.]+)$/.exec(p.split("?",1)[0])),c&&(c=c[1].toLowerCase())}if(c||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),c&&e.codecs(c)){n=i._src[a];break}}if(!n){i._emit("loaderror",null,"No codec support for selected audio sources.");return}return i._src=n,i._state="loading",window.location.protocol==="https:"&&n.slice(0,5)==="http:"&&(i._html5=!0,i._webAudio=!1),new o(i),i._webAudio&&d(i),i},play:function(i,n){var a=this,c=null;if(typeof i=="number")c=i,i=null;else{if(typeof i=="string"&&a._state==="loaded"&&!a._sprite[i])return null;if(typeof i>"u"&&(i="__default",!a._playLock)){for(var p=0,u=0;u<a._sounds.length;u++)a._sounds[u]._paused&&!a._sounds[u]._ended&&(p++,c=a._sounds[u]._id);p===1?i=null:c=null}}var h=c?a._soundById(c):a._inactiveSound();if(!h)return null;if(c&&!i&&(i=h._sprite||"__default"),a._state!=="loaded"){h._sprite=i,h._ended=!1;var _=h._id;return a._queue.push({event:"play",action:function(){a.play(_)}}),_}if(c&&!h._paused)return n||a._loadQueue("play"),h._id;a._webAudio&&e._autoResume();var y=Math.max(0,h._seek>0?h._seek:a._sprite[i][0]/1e3),S=Math.max(0,(a._sprite[i][0]+a._sprite[i][1])/1e3-y),x=S*1e3/Math.abs(h._rate),P=a._sprite[i][0]/1e3,C=(a._sprite[i][0]+a._sprite[i][1])/1e3;h._sprite=i,h._ended=!1;var A=function(){h._paused=!1,h._seek=y,h._start=P,h._stop=C,h._loop=!!(h._loop||a._sprite[i][2])};if(y>=C){a._ended(h);return}var T=h._node;if(a._webAudio){var L=function(){a._playLock=!1,A(),a._refreshBuffer(h);var O=h._muted||a._muted?0:h._volume;T.gain.setValueAtTime(O,e.ctx.currentTime),h._playStart=e.ctx.currentTime,typeof T.bufferSource.start>"u"?h._loop?T.bufferSource.noteGrainOn(0,y,86400):T.bufferSource.noteGrainOn(0,y,S):h._loop?T.bufferSource.start(0,y,86400):T.bufferSource.start(0,y,S),x!==1/0&&(a._endTimers[h._id]=setTimeout(a._ended.bind(a,h),x)),n||setTimeout(function(){a._emit("play",h._id),a._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?L():(a._playLock=!0,a.once("resume",L),a._clearTimer(h._id))}else{var k=function(){T.currentTime=y,T.muted=h._muted||a._muted||e._muted||T.muted,T.volume=h._volume*e.volume(),T.playbackRate=h._rate;try{var O=T.play();if(O&&typeof Promise<"u"&&(O instanceof Promise||typeof O.then=="function")?(a._playLock=!0,A(),O.then(function(){a._playLock=!1,T._unlocked=!0,n?a._loadQueue():a._emit("play",h._id)}).catch(function(){a._playLock=!1,a._emit("playerror",h._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),h._ended=!0,h._paused=!0})):n||(a._playLock=!1,A(),a._emit("play",h._id)),T.playbackRate=h._rate,T.paused){a._emit("playerror",h._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}i!=="__default"||h._loop?a._endTimers[h._id]=setTimeout(a._ended.bind(a,h),x):(a._endTimers[h._id]=function(){a._ended(h),T.removeEventListener("ended",a._endTimers[h._id],!1)},T.addEventListener("ended",a._endTimers[h._id],!1))}catch(b){a._emit("playerror",h._id,b)}};T.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(T.src=a._src,T.load());var R=window&&window.ejecta||!T.readyState&&e._navigator.isCocoonJS;if(T.readyState>=3||R)k();else{a._playLock=!0,a._state="loading";var Z=function(){a._state="loaded",k(),T.removeEventListener(e._canPlayEvent,Z,!1)};T.addEventListener(e._canPlayEvent,Z,!1),a._clearTimer(h._id)}}return h._id},pause:function(i){var n=this;if(n._state!=="loaded"||n._playLock)return n._queue.push({event:"pause",action:function(){n.pause(i)}}),n;for(var a=n._getSoundIds(i),c=0;c<a.length;c++){n._clearTimer(a[c]);var p=n._soundById(a[c]);if(p&&!p._paused&&(p._seek=n.seek(a[c]),p._rateSeek=0,p._paused=!0,n._stopFade(a[c]),p._node))if(n._webAudio){if(!p._node.bufferSource)continue;typeof p._node.bufferSource.stop>"u"?p._node.bufferSource.noteOff(0):p._node.bufferSource.stop(0),n._cleanBuffer(p._node)}else(!isNaN(p._node.duration)||p._node.duration===1/0)&&p._node.pause();arguments[1]||n._emit("pause",p?p._id:null)}return n},stop:function(i,n){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"stop",action:function(){a.stop(i)}}),a;for(var c=a._getSoundIds(i),p=0;p<c.length;p++){a._clearTimer(c[p]);var u=a._soundById(c[p]);u&&(u._seek=u._start||0,u._rateSeek=0,u._paused=!0,u._ended=!0,a._stopFade(c[p]),u._node&&(a._webAudio?u._node.bufferSource&&(typeof u._node.bufferSource.stop>"u"?u._node.bufferSource.noteOff(0):u._node.bufferSource.stop(0),a._cleanBuffer(u._node)):(!isNaN(u._node.duration)||u._node.duration===1/0)&&(u._node.currentTime=u._start||0,u._node.pause(),u._node.duration===1/0&&a._clearSound(u._node))),n||a._emit("stop",u._id))}return a},mute:function(i,n){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"mute",action:function(){a.mute(i,n)}}),a;if(typeof n>"u")if(typeof i=="boolean")a._muted=i;else return a._muted;for(var c=a._getSoundIds(n),p=0;p<c.length;p++){var u=a._soundById(c[p]);u&&(u._muted=i,u._interval&&a._stopFade(u._id),a._webAudio&&u._node?u._node.gain.setValueAtTime(i?0:u._volume,e.ctx.currentTime):u._node&&(u._node.muted=e._muted?!0:i),a._emit("mute",u._id))}return a},volume:function(){var i=this,n=arguments,a,c;if(n.length===0)return i._volume;if(n.length===1||n.length===2&&typeof n[1]>"u"){var p=i._getSoundIds(),u=p.indexOf(n[0]);u>=0?c=parseInt(n[0],10):a=parseFloat(n[0])}else n.length>=2&&(a=parseFloat(n[0]),c=parseInt(n[1],10));var h;if(typeof a<"u"&&a>=0&&a<=1){if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"volume",action:function(){i.volume.apply(i,n)}}),i;typeof c>"u"&&(i._volume=a),c=i._getSoundIds(c);for(var _=0;_<c.length;_++)h=i._soundById(c[_]),h&&(h._volume=a,n[2]||i._stopFade(c[_]),i._webAudio&&h._node&&!h._muted?h._node.gain.setValueAtTime(a,e.ctx.currentTime):h._node&&!h._muted&&(h._node.volume=a*e.volume()),i._emit("volume",h._id))}else return h=c?i._soundById(c):i._sounds[0],h?h._volume:0;return i},fade:function(i,n,a,c){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"fade",action:function(){p.fade(i,n,a,c)}}),p;i=Math.min(Math.max(0,parseFloat(i)),1),n=Math.min(Math.max(0,parseFloat(n)),1),a=parseFloat(a),p.volume(i,c);for(var u=p._getSoundIds(c),h=0;h<u.length;h++){var _=p._soundById(u[h]);if(_){if(c||p._stopFade(u[h]),p._webAudio&&!_._muted){var y=e.ctx.currentTime,S=y+a/1e3;_._volume=i,_._node.gain.setValueAtTime(i,y),_._node.gain.linearRampToValueAtTime(n,S)}p._startFadeInterval(_,i,n,a,u[h],typeof c>"u")}}return p},_startFadeInterval:function(i,n,a,c,p,u){var h=this,_=n,y=a-n,S=Math.abs(y/.01),x=Math.max(4,S>0?c/S:c),P=Date.now();i._fadeTo=a,i._interval=setInterval(function(){var C=(Date.now()-P)/c;P=Date.now(),_+=y*C,_=Math.round(_*100)/100,y<0?_=Math.max(a,_):_=Math.min(a,_),h._webAudio?i._volume=_:h.volume(_,i._id,!0),u&&(h._volume=_),(a<n&&_<=a||a>n&&_>=a)&&(clearInterval(i._interval),i._interval=null,i._fadeTo=null,h.volume(a,i._id),h._emit("fade",i._id))},x)},_stopFade:function(i){var n=this,a=n._soundById(i);return a&&a._interval&&(n._webAudio&&a._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(a._interval),a._interval=null,n.volume(a._fadeTo,i),a._fadeTo=null,n._emit("fade",i)),n},loop:function(){var i=this,n=arguments,a,c,p;if(n.length===0)return i._loop;if(n.length===1)if(typeof n[0]=="boolean")a=n[0],i._loop=a;else return p=i._soundById(parseInt(n[0],10)),p?p._loop:!1;else n.length===2&&(a=n[0],c=parseInt(n[1],10));for(var u=i._getSoundIds(c),h=0;h<u.length;h++)p=i._soundById(u[h]),p&&(p._loop=a,i._webAudio&&p._node&&p._node.bufferSource&&(p._node.bufferSource.loop=a,a&&(p._node.bufferSource.loopStart=p._start||0,p._node.bufferSource.loopEnd=p._stop,i.playing(u[h])&&(i.pause(u[h],!0),i.play(u[h],!0)))));return i},rate:function(){var i=this,n=arguments,a,c;if(n.length===0)c=i._sounds[0]._id;else if(n.length===1){var p=i._getSoundIds(),u=p.indexOf(n[0]);u>=0?c=parseInt(n[0],10):a=parseFloat(n[0])}else n.length===2&&(a=parseFloat(n[0]),c=parseInt(n[1],10));var h;if(typeof a=="number"){if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"rate",action:function(){i.rate.apply(i,n)}}),i;typeof c>"u"&&(i._rate=a),c=i._getSoundIds(c);for(var _=0;_<c.length;_++)if(h=i._soundById(c[_]),h){i.playing(c[_])&&(h._rateSeek=i.seek(c[_]),h._playStart=i._webAudio?e.ctx.currentTime:h._playStart),h._rate=a,i._webAudio&&h._node&&h._node.bufferSource?h._node.bufferSource.playbackRate.setValueAtTime(a,e.ctx.currentTime):h._node&&(h._node.playbackRate=a);var y=i.seek(c[_]),S=(i._sprite[h._sprite][0]+i._sprite[h._sprite][1])/1e3-y,x=S*1e3/Math.abs(h._rate);(i._endTimers[c[_]]||!h._paused)&&(i._clearTimer(c[_]),i._endTimers[c[_]]=setTimeout(i._ended.bind(i,h),x)),i._emit("rate",h._id)}}else return h=i._soundById(c),h?h._rate:i._rate;return i},seek:function(){var i=this,n=arguments,a,c;if(n.length===0)i._sounds.length&&(c=i._sounds[0]._id);else if(n.length===1){var p=i._getSoundIds(),u=p.indexOf(n[0]);u>=0?c=parseInt(n[0],10):i._sounds.length&&(c=i._sounds[0]._id,a=parseFloat(n[0]))}else n.length===2&&(a=parseFloat(n[0]),c=parseInt(n[1],10));if(typeof c>"u")return 0;if(typeof a=="number"&&(i._state!=="loaded"||i._playLock))return i._queue.push({event:"seek",action:function(){i.seek.apply(i,n)}}),i;var h=i._soundById(c);if(h)if(typeof a=="number"&&a>=0){var _=i.playing(c);_&&i.pause(c,!0),h._seek=a,h._ended=!1,i._clearTimer(c),!i._webAudio&&h._node&&!isNaN(h._node.duration)&&(h._node.currentTime=a);var y=function(){_&&i.play(c,!0),i._emit("seek",c)};if(_&&!i._webAudio){var S=function(){i._playLock?setTimeout(S,0):y()};setTimeout(S,0)}else y()}else if(i._webAudio){var x=i.playing(c)?e.ctx.currentTime-h._playStart:0,P=h._rateSeek?h._rateSeek-h._seek:0;return h._seek+(P+x*Math.abs(h._rate))}else return h._node.currentTime;return i},playing:function(i){var n=this;if(typeof i=="number"){var a=n._soundById(i);return a?!a._paused:!1}for(var c=0;c<n._sounds.length;c++)if(!n._sounds[c]._paused)return!0;return!1},duration:function(i){var n=this,a=n._duration,c=n._soundById(i);return c&&(a=n._sprite[c._sprite][1]/1e3),a},state:function(){return this._state},unload:function(){for(var i=this,n=i._sounds,a=0;a<n.length;a++)n[a]._paused||i.stop(n[a]._id),i._webAudio||(i._clearSound(n[a]._node),n[a]._node.removeEventListener("error",n[a]._errorFn,!1),n[a]._node.removeEventListener(e._canPlayEvent,n[a]._loadFn,!1),n[a]._node.removeEventListener("ended",n[a]._endFn,!1),e._releaseHtml5Audio(n[a]._node)),delete n[a]._node,i._clearTimer(n[a]._id);var c=e._howls.indexOf(i);c>=0&&e._howls.splice(c,1);var p=!0;for(a=0;a<e._howls.length;a++)if(e._howls[a]._src===i._src||i._src.indexOf(e._howls[a]._src)>=0){p=!1;break}return s&&p&&delete s[i._src],e.noAudio=!1,i._state="unloaded",i._sounds=[],i=null,null},on:function(i,n,a,c){var p=this,u=p["_on"+i];return typeof n=="function"&&u.push(c?{id:a,fn:n,once:c}:{id:a,fn:n}),p},off:function(i,n,a){var c=this,p=c["_on"+i],u=0;if(typeof n=="number"&&(a=n,n=null),n||a)for(u=0;u<p.length;u++){var h=a===p[u].id;if(n===p[u].fn&&h||!n&&h){p.splice(u,1);break}}else if(i)c["_on"+i]=[];else{var _=Object.keys(c);for(u=0;u<_.length;u++)_[u].indexOf("_on")===0&&Array.isArray(c[_[u]])&&(c[_[u]]=[])}return c},once:function(i,n,a){var c=this;return c.on(i,n,a,1),c},_emit:function(i,n,a){for(var c=this,p=c["_on"+i],u=p.length-1;u>=0;u--)(!p[u].id||p[u].id===n||i==="load")&&(setTimeout((function(h){h.call(this,n,a)}).bind(c,p[u].fn),0),p[u].once&&c.off(i,p[u].fn,p[u].id));return c._loadQueue(i),c},_loadQueue:function(i){var n=this;if(n._queue.length>0){var a=n._queue[0];a.event===i&&(n._queue.shift(),n._loadQueue()),i||a.action()}return n},_ended:function(i){var n=this,a=i._sprite;if(!n._webAudio&&i._node&&!i._node.paused&&!i._node.ended&&i._node.currentTime<i._stop)return setTimeout(n._ended.bind(n,i),100),n;var c=!!(i._loop||n._sprite[a][2]);if(n._emit("end",i._id),!n._webAudio&&c&&n.stop(i._id,!0).play(i._id),n._webAudio&&c){n._emit("play",i._id),i._seek=i._start||0,i._rateSeek=0,i._playStart=e.ctx.currentTime;var p=(i._stop-i._start)*1e3/Math.abs(i._rate);n._endTimers[i._id]=setTimeout(n._ended.bind(n,i),p)}return n._webAudio&&!c&&(i._paused=!0,i._ended=!0,i._seek=i._start||0,i._rateSeek=0,n._clearTimer(i._id),n._cleanBuffer(i._node),e._autoSuspend()),!n._webAudio&&!c&&n.stop(i._id,!0),n},_clearTimer:function(i){var n=this;if(n._endTimers[i]){if(typeof n._endTimers[i]!="function")clearTimeout(n._endTimers[i]);else{var a=n._soundById(i);a&&a._node&&a._node.removeEventListener("ended",n._endTimers[i],!1)}delete n._endTimers[i]}return n},_soundById:function(i){for(var n=this,a=0;a<n._sounds.length;a++)if(i===n._sounds[a]._id)return n._sounds[a];return null},_inactiveSound:function(){var i=this;i._drain();for(var n=0;n<i._sounds.length;n++)if(i._sounds[n]._ended)return i._sounds[n].reset();return new o(i)},_drain:function(){var i=this,n=i._pool,a=0,c=0;if(!(i._sounds.length<n)){for(c=0;c<i._sounds.length;c++)i._sounds[c]._ended&&a++;for(c=i._sounds.length-1;c>=0;c--){if(a<=n)return;i._sounds[c]._ended&&(i._webAudio&&i._sounds[c]._node&&i._sounds[c]._node.disconnect(0),i._sounds.splice(c,1),a--)}}},_getSoundIds:function(i){var n=this;if(typeof i>"u"){for(var a=[],c=0;c<n._sounds.length;c++)a.push(n._sounds[c]._id);return a}else return[i]},_refreshBuffer:function(i){var n=this;return i._node.bufferSource=e.ctx.createBufferSource(),i._node.bufferSource.buffer=s[n._src],i._panner?i._node.bufferSource.connect(i._panner):i._node.bufferSource.connect(i._node),i._node.bufferSource.loop=i._loop,i._loop&&(i._node.bufferSource.loopStart=i._start||0,i._node.bufferSource.loopEnd=i._stop||0),i._node.bufferSource.playbackRate.setValueAtTime(i._rate,e.ctx.currentTime),n},_cleanBuffer:function(i){var n=this,a=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!i.bufferSource)return n;if(e._scratchBuffer&&i.bufferSource&&(i.bufferSource.onended=null,i.bufferSource.disconnect(0),a))try{i.bufferSource.buffer=e._scratchBuffer}catch{}return i.bufferSource=null,n},_clearSound:function(i){var n=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);n||(i.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var o=function(i){this._parent=i,this.init()};o.prototype={init:function(){var i=this,n=i._parent;return i._muted=n._muted,i._loop=n._loop,i._volume=n._volume,i._rate=n._rate,i._seek=0,i._paused=!0,i._ended=!0,i._sprite="__default",i._id=++e._counter,n._sounds.push(i),i.create(),i},create:function(){var i=this,n=i._parent,a=e._muted||i._muted||i._parent._muted?0:i._volume;return n._webAudio?(i._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),i._node.gain.setValueAtTime(a,e.ctx.currentTime),i._node.paused=!0,i._node.connect(e.masterGain)):e.noAudio||(i._node=e._obtainHtml5Audio(),i._errorFn=i._errorListener.bind(i),i._node.addEventListener("error",i._errorFn,!1),i._loadFn=i._loadListener.bind(i),i._node.addEventListener(e._canPlayEvent,i._loadFn,!1),i._endFn=i._endListener.bind(i),i._node.addEventListener("ended",i._endFn,!1),i._node.src=n._src,i._node.preload=n._preload===!0?"auto":n._preload,i._node.volume=a*e.volume(),i._node.load()),i},reset:function(){var i=this,n=i._parent;return i._muted=n._muted,i._loop=n._loop,i._volume=n._volume,i._rate=n._rate,i._seek=0,i._rateSeek=0,i._paused=!0,i._ended=!0,i._sprite="__default",i._id=++e._counter,i},_errorListener:function(){var i=this;i._parent._emit("loaderror",i._id,i._node.error?i._node.error.code:0),i._node.removeEventListener("error",i._errorFn,!1)},_loadListener:function(){var i=this,n=i._parent;n._duration=Math.ceil(i._node.duration*10)/10,Object.keys(n._sprite).length===0&&(n._sprite={__default:[0,n._duration*1e3]}),n._state!=="loaded"&&(n._state="loaded",n._emit("load"),n._loadQueue()),i._node.removeEventListener(e._canPlayEvent,i._loadFn,!1)},_endListener:function(){var i=this,n=i._parent;n._duration===1/0&&(n._duration=Math.ceil(i._node.duration*10)/10,n._sprite.__default[1]===1/0&&(n._sprite.__default[1]=n._duration*1e3),n._ended(i)),i._node.removeEventListener("ended",i._endFn,!1)}};var s={},d=function(i){var n=i._src;if(s[n]){i._duration=s[n].duration,g(i);return}if(/^data:[^;]+;base64,/.test(n)){for(var a=atob(n.split(",")[1]),c=new Uint8Array(a.length),p=0;p<a.length;++p)c[p]=a.charCodeAt(p);f(c.buffer,i)}else{var u=new XMLHttpRequest;u.open(i._xhr.method,n,!0),u.withCredentials=i._xhr.withCredentials,u.responseType="arraybuffer",i._xhr.headers&&Object.keys(i._xhr.headers).forEach(function(h){u.setRequestHeader(h,i._xhr.headers[h])}),u.onload=function(){var h=(u.status+"")[0];if(h!=="0"&&h!=="2"&&h!=="3"){i._emit("loaderror",null,"Failed loading audio file with status: "+u.status+".");return}f(u.response,i)},u.onerror=function(){i._webAudio&&(i._html5=!0,i._webAudio=!1,i._sounds=[],delete s[n],i.load())},m(u)}},m=function(i){try{i.send()}catch{i.onerror()}},f=function(i,n){var a=function(){n._emit("loaderror",null,"Decoding audio data failed.")},c=function(p){p&&n._sounds.length>0?(s[n._src]=p,g(n,p)):a()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(i).then(c).catch(a):e.ctx.decodeAudioData(i,c,a)},g=function(i,n){n&&!i._duration&&(i._duration=n.duration),Object.keys(i._sprite).length===0&&(i._sprite={__default:[0,i._duration*1e3]}),i._state!=="loaded"&&(i._state="loaded",i._emit("load"),i._loadQueue())},v=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var i=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),n=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),a=n?parseInt(n[1],10):null;if(i&&a&&a<9){var c=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!c&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};l.Howler=e,l.Howl=r,typeof B<"u"?(B.HowlerGlobal=t,B.Howler=e,B.Howl=r,B.Sound=o):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=r,window.Sound=o)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var r=this;if(!r.ctx||!r.ctx.listener)return r;for(var o=r._howls.length-1;o>=0;o--)r._howls[o].stereo(e);return r},HowlerGlobal.prototype.pos=function(e,r,o){var s=this;if(!s.ctx||!s.ctx.listener)return s;if(r=typeof r!="number"?s._pos[1]:r,o=typeof o!="number"?s._pos[2]:o,typeof e=="number")s._pos=[e,r,o],typeof s.ctx.listener.positionX<"u"?(s.ctx.listener.positionX.setTargetAtTime(s._pos[0],Howler.ctx.currentTime,.1),s.ctx.listener.positionY.setTargetAtTime(s._pos[1],Howler.ctx.currentTime,.1),s.ctx.listener.positionZ.setTargetAtTime(s._pos[2],Howler.ctx.currentTime,.1)):s.ctx.listener.setPosition(s._pos[0],s._pos[1],s._pos[2]);else return s._pos;return s},HowlerGlobal.prototype.orientation=function(e,r,o,s,d,m){var f=this;if(!f.ctx||!f.ctx.listener)return f;var g=f._orientation;if(r=typeof r!="number"?g[1]:r,o=typeof o!="number"?g[2]:o,s=typeof s!="number"?g[3]:s,d=typeof d!="number"?g[4]:d,m=typeof m!="number"?g[5]:m,typeof e=="number")f._orientation=[e,r,o,s,d,m],typeof f.ctx.listener.forwardX<"u"?(f.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),f.ctx.listener.forwardY.setTargetAtTime(r,Howler.ctx.currentTime,.1),f.ctx.listener.forwardZ.setTargetAtTime(o,Howler.ctx.currentTime,.1),f.ctx.listener.upX.setTargetAtTime(s,Howler.ctx.currentTime,.1),f.ctx.listener.upY.setTargetAtTime(d,Howler.ctx.currentTime,.1),f.ctx.listener.upZ.setTargetAtTime(m,Howler.ctx.currentTime,.1)):f.ctx.listener.setOrientation(e,r,o,s,d,m);else return g;return f},Howl.prototype.init=function(e){return function(r){var o=this;return o._orientation=r.orientation||[1,0,0],o._stereo=r.stereo||null,o._pos=r.pos||null,o._pannerAttr={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:360,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:360,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:0,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:"inverse",maxDistance:typeof r.maxDistance<"u"?r.maxDistance:1e4,panningModel:typeof r.panningModel<"u"?r.panningModel:"HRTF",refDistance:typeof r.refDistance<"u"?r.refDistance:1,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:1},o._onstereo=r.onstereo?[{fn:r.onstereo}]:[],o._onpos=r.onpos?[{fn:r.onpos}]:[],o._onorientation=r.onorientation?[{fn:r.onorientation}]:[],e.call(this,r)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"stereo",action:function(){o.stereo(e,r)}}),o;var s=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof r>"u")if(typeof e=="number")o._stereo=e,o._pos=[e,0,0];else return o._stereo;for(var d=o._getSoundIds(r),m=0;m<d.length;m++){var f=o._soundById(d[m]);if(f)if(typeof e=="number")f._stereo=e,f._pos=[e,0,0],f._node&&(f._pannerAttr.panningModel="equalpower",(!f._panner||!f._panner.pan)&&t(f,s),s==="spatial"?typeof f._panner.positionX<"u"?(f._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),f._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),f._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):f._panner.setPosition(e,0,0):f._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),o._emit("stereo",f._id);else return f._stereo}return o},Howl.prototype.pos=function(e,r,o,s){var d=this;if(!d._webAudio)return d;if(d._state!=="loaded")return d._queue.push({event:"pos",action:function(){d.pos(e,r,o,s)}}),d;if(r=typeof r!="number"?0:r,o=typeof o!="number"?-.5:o,typeof s>"u")if(typeof e=="number")d._pos=[e,r,o];else return d._pos;for(var m=d._getSoundIds(s),f=0;f<m.length;f++){var g=d._soundById(m[f]);if(g)if(typeof e=="number")g._pos=[e,r,o],g._node&&((!g._panner||g._panner.pan)&&t(g,"spatial"),typeof g._panner.positionX<"u"?(g._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),g._panner.positionY.setValueAtTime(r,Howler.ctx.currentTime),g._panner.positionZ.setValueAtTime(o,Howler.ctx.currentTime)):g._panner.setPosition(e,r,o)),d._emit("pos",g._id);else return g._pos}return d},Howl.prototype.orientation=function(e,r,o,s){var d=this;if(!d._webAudio)return d;if(d._state!=="loaded")return d._queue.push({event:"orientation",action:function(){d.orientation(e,r,o,s)}}),d;if(r=typeof r!="number"?d._orientation[1]:r,o=typeof o!="number"?d._orientation[2]:o,typeof s>"u")if(typeof e=="number")d._orientation=[e,r,o];else return d._orientation;for(var m=d._getSoundIds(s),f=0;f<m.length;f++){var g=d._soundById(m[f]);if(g)if(typeof e=="number")g._orientation=[e,r,o],g._node&&(g._panner||(g._pos||(g._pos=d._pos||[0,0,-.5]),t(g,"spatial")),typeof g._panner.orientationX<"u"?(g._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),g._panner.orientationY.setValueAtTime(r,Howler.ctx.currentTime),g._panner.orientationZ.setValueAtTime(o,Howler.ctx.currentTime)):g._panner.setOrientation(e,r,o)),d._emit("orientation",g._id);else return g._orientation}return d},Howl.prototype.pannerAttr=function(){var e=this,r=arguments,o,s,d;if(!e._webAudio)return e;if(r.length===0)return e._pannerAttr;if(r.length===1)if(typeof r[0]=="object")o=r[0],typeof s>"u"&&(o.pannerAttr||(o.pannerAttr={coneInnerAngle:o.coneInnerAngle,coneOuterAngle:o.coneOuterAngle,coneOuterGain:o.coneOuterGain,distanceModel:o.distanceModel,maxDistance:o.maxDistance,refDistance:o.refDistance,rolloffFactor:o.rolloffFactor,panningModel:o.panningModel}),e._pannerAttr={coneInnerAngle:typeof o.pannerAttr.coneInnerAngle<"u"?o.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof o.pannerAttr.coneOuterAngle<"u"?o.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof o.pannerAttr.coneOuterGain<"u"?o.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof o.pannerAttr.distanceModel<"u"?o.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof o.pannerAttr.maxDistance<"u"?o.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof o.pannerAttr.refDistance<"u"?o.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof o.pannerAttr.rolloffFactor<"u"?o.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof o.pannerAttr.panningModel<"u"?o.pannerAttr.panningModel:e._panningModel});else return d=e._soundById(parseInt(r[0],10)),d?d._pannerAttr:e._pannerAttr;else r.length===2&&(o=r[0],s=parseInt(r[1],10));for(var m=e._getSoundIds(s),f=0;f<m.length;f++)if(d=e._soundById(m[f]),d){var g=d._pannerAttr;g={coneInnerAngle:typeof o.coneInnerAngle<"u"?o.coneInnerAngle:g.coneInnerAngle,coneOuterAngle:typeof o.coneOuterAngle<"u"?o.coneOuterAngle:g.coneOuterAngle,coneOuterGain:typeof o.coneOuterGain<"u"?o.coneOuterGain:g.coneOuterGain,distanceModel:typeof o.distanceModel<"u"?o.distanceModel:g.distanceModel,maxDistance:typeof o.maxDistance<"u"?o.maxDistance:g.maxDistance,refDistance:typeof o.refDistance<"u"?o.refDistance:g.refDistance,rolloffFactor:typeof o.rolloffFactor<"u"?o.rolloffFactor:g.rolloffFactor,panningModel:typeof o.panningModel<"u"?o.panningModel:g.panningModel};var v=d._panner;v||(d._pos||(d._pos=e._pos||[0,0,-.5]),t(d,"spatial"),v=d._panner),v.coneInnerAngle=g.coneInnerAngle,v.coneOuterAngle=g.coneOuterAngle,v.coneOuterGain=g.coneOuterGain,v.distanceModel=g.distanceModel,v.maxDistance=g.maxDistance,v.refDistance=g.refDistance,v.rolloffFactor=g.rolloffFactor,v.panningModel=g.panningModel}return e},Sound.prototype.init=function(e){return function(){var r=this,o=r._parent;r._orientation=o._orientation,r._stereo=o._stereo,r._pos=o._pos,r._pannerAttr=o._pannerAttr,e.call(this),r._stereo?o.stereo(r._stereo):r._pos&&o.pos(r._pos[0],r._pos[1],r._pos[2],r._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var r=this,o=r._parent;return r._orientation=o._orientation,r._stereo=o._stereo,r._pos=o._pos,r._pannerAttr=o._pannerAttr,r._stereo?o.stereo(r._stereo):r._pos?o.pos(r._pos[0],r._pos[1],r._pos[2],r._id):r._panner&&(r._panner.disconnect(0),r._panner=void 0,o._refreshBuffer(r)),e.call(this)}}(Sound.prototype.reset);var t=function(e,r){r=r||"spatial",r==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(I);class ce{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,I.Howler.autoUnlock=!0,I.Howler.html5PoolSize=10,I.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(I.Howler.ctx&&I.Howler.ctx.state==="suspended")try{await I.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(t){console.error("Failed to resume AudioContext:",t)}}async preloadHotspots(t){const e=t.filter(r=>r.audioUrl).map(r=>({id:r.id,url:r.audioUrl}));this.preloadQueue.push(...e),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:t,url:e}=this.preloadQueue.shift();this.sounds.has(t)||(await this.loadSound(t,e),this.preloadedCount++)}this.isPreloading=!1}async loadSound(t,e){return new Promise(r=>{const o=new Audio;o.addEventListener("error",()=>{console.log(`Audio not found for ${t}, using placeholder`),this.createSound(t,this.placeholderUrl,!0),r()}),o.addEventListener("canplaythrough",()=>{this.createSound(t,e,!1),r()}),o.src=e})}createSound(t,e,r=!1){const o=new I.Howl({src:[e],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${t} (placeholder: ${r})`)},onend:()=>this.handlePlaybackEnd(t),onloaderror:(s,d)=>{console.error(`Failed to load sound ${t}:`,d),this.onError&&this.onError(t,d)},onplayerror:(s,d)=>{console.error(`Failed to play sound ${t}:`,d),this.onError&&this.onError(t,d)}});this.sounds.set(t,{howl:o,isPlaceholder:r,duration:r?this.placeholderDuration:null})}async play(t){if(await this.resumeContext(),this.currentHotspotId===t&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(t)||(this.state="loading",await this.loadSound(t,`/audio/hotspot_${t}.mp3`));const e=this.sounds.get(t);if(!e){console.error(`No sound found for hotspot: ${t}`);return}const r=e.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,r,t):(this.currentSound&&this.currentSound.stop(),this.currentSound=r,this.currentHotspotId=t,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(t),this.startProgressTracking())}crossfade(t,e,r){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${r}`),this.isCrossfading=!0,this.state="crossfading";const o=this.crossfadeDuration,s=20,d=o/s;let m=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,r),e.volume(0),e.play();const f=setInterval(()=>{m++;const g=m/s;t.volume(this.masterVolume*(1-g)),e.volume(this.masterVolume*g),m>=s&&(clearInterval(f),t.stop(),t.volume(this.masterVolume),this.previousSound=t,this.currentSound=e,this.currentHotspotId=r,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(r),this.startProgressTracking())},d)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(t){if(this.currentSound&&this.currentSound.playing()){const e=this.currentSound.seek()||0,r=this.currentSound.duration(),o=Math.max(0,Math.min(r,e+t));this.currentSound.seek(o),console.log(`Skipped to ${o.toFixed(1)}s`)}}setVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),I.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,I.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const t=this.currentSound.seek()||0,e=this.sounds.get(this.currentHotspotId),r=e!=null&&e.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,o=r>0?t/r*100:0;return{current:t,duration:r,percent:o}}seekTo(t){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(t)}seekToPercent(t){if(this.currentSound){const e=this.currentSound.duration(),r=t/100*e;this.seekTo(r)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const t=this.getProgress();this.onProgress(t)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(t){console.log(`Playback ended for hotspot: ${t}`),t===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(t))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(t,e=500){this.crossfadeEnabled=t,this.crossfadeDuration=Math.max(100,Math.min(2e3,e)),console.log(`Crossfade ${t?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(t){const e=this.sounds.get(t);e&&(e.howl.unload(),this.sounds.delete(t),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(t=>{t.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}playTemporalSound(t,e,r=50){(!e||isNaN(e)||!isFinite(e))&&(console.warn(`Invalid frequency for temporal sound: ${e}`),e=1e3),(!r||isNaN(r)||r<=0)&&(r=50),this.resumeContext(),this.uiAudioContext||(this.uiAudioContext=new(window.AudioContext||window.webkitAudioContext));try{const o=this.uiAudioContext,s=o.createOscillator(),d=o.createGain(),m=o.createBiquadFilter();m.type="lowpass",m.frequency.value=Math.min(e*1.5,2e3),s.connect(m),m.connect(d),d.connect(o.destination),s.type="sine",s.frequency.value=e;const f=o.currentTime,g=.01,v=r/1e3,i=e>1500?.05:.08;d.gain.setValueAtTime(0,f),d.gain.linearRampToValueAtTime(i,f+g),d.gain.exponentialRampToValueAtTime(.001,f+v),s.start(f),s.stop(f+v),console.log(`Temporal sound played: ${t} at ${e}Hz for ${r}ms`)}catch(o){console.error("Error playing temporal sound:",o)}}playTemporalTick(t=.5){const r=1200+400*(!isNaN(t)&&isFinite(t)?Math.min(1,Math.max(0,t)):.5);this.playTemporalSound("explore",r,40)}playTemporalBoop(){this.playTemporalSound("preview",600,80)}playTemporalThunk(t=.5){const r=150+100*(1-(!isNaN(t)&&isFinite(t)?Math.min(1,Math.max(0,t)):.5));this.playTemporalSound("activate",r,120)}}class de{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(t){t.forEach(e=>{e.image_url_1&&this.overlays.set(e.id,{hotspotId:e.id,imageUrls:[e.image_url_1],autoReveal:e.overlay_auto_reveal||!1,displayMode:e.overlay_display_mode||"modal",showButton:e.show_images_button!==!1,access:e.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(t){const e=[];t.forEach(r=>{const o=this.overlays.get(r);o&&!o.isLoaded&&o.imageUrls.forEach(s=>{this.preloadedImages.has(s)||e.push({url:s,hotspotId:r})})}),this.preloadQueue.push(...e),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:t,hotspotId:e}=this.preloadQueue.shift();try{await this.loadImage(t,e)}catch(r){console.error(`Failed to preload image: ${t}`,r)}}this.isPreloading=!1}loadImage(t,e){return new Promise((r,o)=>{const s=new Image;s.onload=()=>{this.preloadedImages.set(t,s);const d=this.overlays.get(e);d&&(d.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(t,e),console.log(`Image loaded: ${t}`),r(s)},s.onerror=d=>{this.onImageError&&this.onImageError(t,e,d),console.error(`Failed to load image: ${t}`),o(d)},s.crossOrigin="anonymous",s.src=t})}shouldAutoReveal(t){const e=this.overlays.get(t);return e?e.autoReveal:!1}shouldShowButton(t){const e=this.overlays.get(t);return e?e.showButton:!0}getOverlay(t){return this.overlays.get(t)}openOverlay(t){const e=this.overlays.get(t);if(!e)return console.warn(`No overlay found for hotspot: ${t}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=t,!e.isLoaded){const r=e.imageUrls[0];this.loadImage(r,t).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(t,e),e}closeOverlay(){if(this.activeOverlay){const t=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(t)}}getImage(t){return this.preloadedImages.get(t)}hasAccess(t,e="free"){const r=this.overlays.get(t);if(!r)return!1;const o={free:0,gated:1,supporter:2},s=o[r.access]||0;return(o[e]||0)>=s}unloadImages(t){t.forEach(e=>{const r=this.overlays.get(e);r&&(r.imageUrls.forEach(o=>{this.preloadedImages.delete(o)}),r.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class me{constructor(t,e=!1){this.viewer=t,this.isMobile=e,this.isActive=!0,this.isZooming=!1,this.lastZoomLevel=null,this.zoomStartTime=null,this.cinematicMode=!1,this.LOW_ZOOM_THRESHOLD=2,this.CRITICAL_ZOOM_THRESHOLD=1,this.originalSettings={},this.isOptimizing=!1,console.log("🚀 PERFORMANCE FIXED: Simplified LowZoomOptimizer initialized for",e?"mobile":"desktop"),this.setupEventHandlers()}setupEventHandlers(){this.viewer&&(this.viewer.addHandler("zoom",t=>{this.isActive&&this.handleZoomChange(t)}),this.viewer.addHandler("pan",t=>{this.isActive&&this.handlePanAtLowZoom(t)}),this.viewer.addHandler("animation-start",()=>{this.isActive&&this.handleAnimationStart()}),this.viewer.addHandler("animation-finish",()=>{this.isActive&&this.handleAnimationFinish()}),this.viewer.drawer&&this.viewer.drawer.getType()!=="webgl"&&this.setupTileDrawingOptimization())}handleZoomChange(t){const e=t.zoom||this.viewer.viewport.getZoom();if(this.lastZoomLevel=e,this.cinematicMode){console.log("LowZoomOptimizer: Skipping zoom optimization - cinematic mode active");return}e<this.CRITICAL_ZOOM_THRESHOLD?this.applyCriticalZoomOptimization():e<this.LOW_ZOOM_THRESHOLD?this.applyLowZoomOptimization():this.restoreNormalOptimization()}handlePanAtLowZoom(t){if(this.viewer.viewport.getZoom()<this.LOW_ZOOM_THRESHOLD&&this.viewer.imageLoader){const r=this.viewer.imageLoader.jobLimit;this.viewer.imageLoader.jobLimit=this.isMobile?1:2,setTimeout(()=>{this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=r)},50)}}handleAnimationStart(){if(this.isZooming=!0,this.zoomStartTime=performance.now(),this.cinematicMode){console.log("LowZoomOptimizer: Skipping animation optimization - cinematic mode active");return}if(!this.isActive){console.log("LowZoomOptimizer: Skipping optimization - disabled");return}this.viewer.viewport.getZoom()<this.LOW_ZOOM_THRESHOLD&&(this.viewer.imageLoader&&this.viewer.imageLoader.clear(),this.storeOriginalSpringSettings(),this.optimizeSpringSettings())}handleAnimationFinish(){if(this.isZooming=!1,this.zoomStartTime){const t=performance.now()-this.zoomStartTime;console.log(`🚀 PERFORMANCE FIXED: Animation duration: ${t.toFixed(1)}ms`),this.zoomStartTime=null}if(this.cinematicMode){console.log("LowZoomOptimizer: Skipping spring restoration - cinematic mode active");return}if(!this.isActive){console.log("LowZoomOptimizer: Skipping spring restoration - disabled");return}this.restoreOriginalSpringSettings()}applyCriticalZoomOptimization(){this.isOptimizing||(this.isOptimizing=!0,console.log("LowZoomOptimizer: Applying CRITICAL zoom optimization"),Object.keys(this.originalSettings).length===0&&this.storeOriginalSettings(),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),this.viewer.imageSmoothingEnabled=!1,this.viewer.immediateRender=!0,this.isMobile&&(this.viewer.maxTilesPerFrame=1,this.viewer.blendTime=0,this.viewer.alwaysBlend=!1))}applyLowZoomOptimization(){this.isOptimizing||(this.isOptimizing=!0,console.log("LowZoomOptimizer: Applying LOW zoom optimization"),Object.keys(this.originalSettings).length===0&&this.storeOriginalSettings(),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=this.isMobile?1:2),this.isMobile?(this.viewer.maxTilesPerFrame=1,this.viewer.blendTime=0):(this.viewer.maxTilesPerFrame=2,this.viewer.blendTime=0))}restoreNormalOptimization(){this.isOptimizing&&(console.log("LowZoomOptimizer: Restoring normal optimization"),this.restoreOriginalSettings(),this.isOptimizing=!1)}setupTileDrawingOptimization(){let t=0;this.viewer.addHandler("tile-drawing",e=>{if(!this.isActive)return;const r=this.viewer.viewport.getZoom();e.tile;const o=e.tile.level;if(r<this.LOW_ZOOM_THRESHOLD){t++;const s=r<this.CRITICAL_ZOOM_THRESHOLD?2:1;if(s>0&&t%(s+1)!==0){e.preventDefaultAction=!0;return}if(e.tile.size*r<(this.isMobile?32:24)){e.preventDefaultAction=!0;return}}if(this.isZooming){const s=Math.floor(Math.log2(r));if(Math.abs(o-s)>2){e.preventDefaultAction=!0;return}}})}storeOriginalSettings(){var t;this.originalSettings={imageLoaderLimit:(t=this.viewer.imageLoader)==null?void 0:t.jobLimit,maxTilesPerFrame:this.viewer.maxTilesPerFrame,blendTime:this.viewer.blendTime,alwaysBlend:this.viewer.alwaysBlend,imageSmoothingEnabled:this.viewer.imageSmoothingEnabled,immediateRender:this.viewer.immediateRender}}restoreOriginalSettings(){Object.keys(this.originalSettings).length!==0&&Object.keys(this.originalSettings).forEach(t=>{const e=this.originalSettings[t];e!==void 0&&(t==="imageLoaderLimit"&&this.viewer.imageLoader?this.viewer.imageLoader.jobLimit=e:this.viewer[t]!==void 0&&(this.viewer[t]=e))})}storeOriginalSpringSettings(){this.originalSpringSettings||(this.originalSpringSettings={animationTime:this.viewer.animationTime,springStiffness:this.viewer.springStiffness,centerXAnimationTime:this.viewer.viewport.centerSpringX.animationTime,centerYAnimationTime:this.viewer.viewport.centerSpringY.animationTime,zoomAnimationTime:this.viewer.viewport.zoomSpring.animationTime,centerXStiffness:this.viewer.viewport.centerSpringX.springStiffness,centerYStiffness:this.viewer.viewport.centerSpringY.springStiffness,zoomStiffness:this.viewer.viewport.zoomSpring.springStiffness})}optimizeSpringSettings(){if(this.cinematicMode){console.log("LowZoomOptimizer: Preserving springs - cinematic mode active");return}const t=this.isMobile?.25:.2,e=this.isMobile?15:18;this.viewer.animationTime=t,this.viewer.springStiffness=e,this.viewer.viewport.centerSpringX.animationTime=t,this.viewer.viewport.centerSpringY.animationTime=t,this.viewer.viewport.zoomSpring.animationTime=t,this.viewer.viewport.centerSpringX.springStiffness=e,this.viewer.viewport.centerSpringY.springStiffness=e,this.viewer.viewport.zoomSpring.springStiffness=e,console.log(`🚀 PERFORMANCE FIXED: Ultra-fast springs applied - ${t*1e3}ms`)}restoreOriginalSpringSettings(){if(!this.originalSpringSettings)return;const t=this.originalSpringSettings;this.viewer.animationTime=t.animationTime,this.viewer.springStiffness=t.springStiffness,this.viewer.viewport.centerSpringX.animationTime=t.centerXAnimationTime,this.viewer.viewport.centerSpringY.animationTime=t.centerYAnimationTime,this.viewer.viewport.zoomSpring.animationTime=t.zoomAnimationTime,this.viewer.viewport.centerSpringX.springStiffness=t.centerXStiffness,this.viewer.viewport.centerSpringY.springStiffness=t.centerYStiffness,this.viewer.viewport.zoomSpring.springStiffness=t.zoomStiffness,this.originalSpringSettings=null}monitorPerformance(t){this._lastEmergencyTime||(this._lastEmergencyTime=0);const e=Date.now(),r=5e3,s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&!/iPad|iPhone|iPod/.test(navigator.userAgent)?10:this.isMobile?20:25;t<s&&t>0&&e-this._lastEmergencyTime>r&&(console.warn(`LowZoomOptimizer: Low FPS detected (${t}), applying emergency optimization`),this._lastEmergencyTime=e,this.applyEmergencyOptimization())}applyEmergencyOptimization(){console.warn("LowZoomOptimizer: Applying EMERGENCY optimization");const t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),e=t&&!/iPad|iPhone|iPod/.test(navigator.userAgent);if(this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=e?2:1,t||this.viewer.imageLoader.clear()),this.viewer.maxTilesPerFrame=e?2:1,this.viewer.blendTime=t?.1:0,this.viewer.alwaysBlend=!1,this.viewer.immediateRender=!0,!t&&this.viewer.world){const r=this.viewer.world.getItemCount();for(let o=0;o<r;o++){const s=this.viewer.world.getItemAt(o);s&&s._tileCache&&setTimeout(()=>{s._tileCache.clearTilesFor(s)},0)}}}enable(){this.isActive=!0,console.log("LowZoomOptimizer: Enabled")}disable(){this.isActive=!1,this.restoreNormalOptimization(),console.log("LowZoomOptimizer: Disabled")}destroy(){this.disable(),this.viewer&&(this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("pan"),this.viewer.removeAllHandlers("animation-start"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("tile-drawing")),console.log("🚀 PERFORMANCE FIXED: LowZoomOptimizer destroyed")}setCinematicMode(t){this.cinematicMode=t,console.log(`LowZoomOptimizer: Cinematic mode ${t?"ENABLED":"DISABLED"}`),t&&this.restoreNormalOptimization()}getStatus(){return{isActive:this.isActive,isOptimizing:this.isOptimizing,currentZoom:this.lastZoomLevel,isMobile:this.isMobile,cinematicMode:this.cinematicMode,optimizationLevel:this.isOptimizing?this.lastZoomLevel<this.CRITICAL_ZOOM_THRESHOLD?"critical":"low":"normal",fixed:"PERFORMANCE_OPTIMIZED"}}}class he{constructor(t){N(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});N(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const t=performance.memory.usedJSHeapSize/1048576,e=performance.memory.jsHeapSizeLimit/1048576,r=t/e*100;this.metrics.currentUsage=t,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,t);const o=this.state.memoryPressure;if(t>this.config.criticalThreshold||r>80?this.state.memoryPressure="critical":t>this.config.highThreshold||r>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==o)switch(console.log(`Memory pressure changed: ${o} → ${this.state.memoryPressure} (${t.toFixed(0)}MB, ${r.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const t=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==t.tiles&&(this.viewer.maxImageCacheCount=t.tiles,console.log(`Adjusted tile cache limit to ${t.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var e;console.warn("CRITICAL: Emergency memory cleanup");const t=(e=this.viewer.world)==null?void 0:e.getItemAt(0);t&&(t._tileCache&&t._tileCache.clearTilesFor(t),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(t=!1){var s,d;const e=(s=this.viewer.world)==null?void 0:s.getItemAt(0);if(!(e!=null&&e._tileCache))return;const r=e._tileCache,o=((d=r._tilesLoaded)==null?void 0:d.length)||r._imagesLoadedCount||0;if(t||o>this.config.cacheLimits[this.state.memoryPressure].tiles){const m=t?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,f=o-m;f>0&&(console.log(`Removing ${f} tiles from cache (current: ${o})`),r.clearTilesFor(e))}}clearUnusedImages(){const t=document.querySelectorAll("img");let e=0;t.forEach(r=>{!this.isElementVisible(r)&&r.src&&(r.removeAttribute("src"),e++)}),e>0&&console.log(`Cleared ${e} unused images`)}isElementVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const t={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const e=performance.memory.jsHeapSizeLimit/1048576;t.usagePercentage=(this.metrics.currentUsage/e*100).toFixed(1)+"%",t.totalLimit=e.toFixed(0)+"MB"}return t}destroy(){this.stop(),this.viewer=null}}class ue{constructor(t,e={}){this.viewer=t,this.config={throttleMs:e.throttleMs||16,zoomStep:e.zoomStep||.02,enabled:e.enabled!==!1,...e},this.lastEventTime=0,this.pendingZoom=0,this.throttleTimeout=null,this.isEnabled=this.config.enabled,this.init()}init(){!this.viewer||!this.isEnabled||(this.viewer.addHandler("canvas-scroll",this.handleScroll.bind(this)),console.log("Mouse wheel smoothing initialized:",{throttleMs:this.config.throttleMs,zoomStep:this.config.zoomStep}))}handleScroll(t){if(!this.isEnabled)return;t.preventDefault=!0;const e=performance.now(),r=this.normalizeWheelDelta(t.originalEvent),o=Math.sign(-r),s=this.config.zoomStep*Math.abs(o);this.pendingZoom+=s*o,e-this.lastEventTime>=this.config.throttleMs?(this.applyPendingZoom(),this.lastEventTime=e):(this.throttleTimeout&&clearTimeout(this.throttleTimeout),this.throttleTimeout=setTimeout(()=>{this.applyPendingZoom(),this.lastEventTime=performance.now()},this.config.throttleMs))}normalizeWheelDelta(t){let r=0;return"deltaY"in t?r=t.deltaY:"wheelDelta"in t&&(r=-t.wheelDelta/120*40),t.deltaMode===1&&(r*=40),r}applyPendingZoom(){if(Math.abs(this.pendingZoom)<.001){this.pendingZoom=0;return}const e=this.viewer.viewport.getZoom()*(1+this.pendingZoom),r=Math.max(this.viewer.viewport.getMinZoom(),Math.min(this.viewer.viewport.getMaxZoom(),e));this.viewer.viewport.zoomTo(r),this.viewer.viewport.applyConstraints(),this.pendingZoom=0}updateConfig(t){this.config={...this.config,...t},console.log("Mouse wheel smoothing config updated:",this.config)}enable(){this.isEnabled=!0,console.log("Mouse wheel smoothing enabled")}disable(){this.isEnabled=!1,this.throttleTimeout&&(clearTimeout(this.throttleTimeout),this.throttleTimeout=null),console.log("Mouse wheel smoothing disabled")}destroy(){this.disable()}}class fe{constructor(t){this.viewer=t,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[],this.thresholds={fps:{target:60,good:50,acceptable:35,poor:25,critical:15},frameTime:{target:16.67,warning:33},memory:{warning:300,critical:400}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const t={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(t).forEach(([e,r])=>this.viewer.addHandler(e,r.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(t=>this.viewer.removeAllHandlers(t))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const t=performance.now(),e=t-this.lastTime;this.updateFrameMetrics(e),this.lastTime=t,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(t){if(this.frameTimes.push(t),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),t>0){const e=1e3/t;this.fpsHistory.push(e),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=e,t>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const t=this.viewer.drawer.canvas;t&&(this.metrics.canvasSize=`${t.width}×${t.height}`);const r=this.viewer.viewport.getBounds(),o=this.viewer.world.getHomeBounds(),s=r.width*r.height/(o.width*o.height);this.metrics.viewportCoverage=Math.min(100,s*100).toFixed(1)}updateTileMetrics(){var r,o;const t=this.viewer.world;if(t.getItemCount()===0)return;const e=t.getItemAt(0);if(e){if(this.metrics.visibleTiles=((r=e._tilesToDraw)==null?void 0:r.length)||0,e._tileCache){const s=e._tileCache;this.metrics.cachedTiles=((o=s._tilesLoaded)==null?void 0:o.length)||s._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:t,frameTime:e,memory:r}=this.thresholds,o={fps:Math.min(100,this.metrics.averageFPS/t.target*100)*.5,frameTime:Math.min(100,e.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(o).reduce((s,d)=>s+d,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const t=Date.now();if(t-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:e}=this.thresholds,r=this.metrics.averageFPS,o=this.metrics.performanceScore,s=this.getPerformanceTrend(),d=[{condition:r<e.critical||o<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:r<e.poor||o<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:r<e.good||o<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:r>e.target&&o>90&&(s==="improving"||s==="stable"),action:this.restoreQualitySettings,log:null}];for(const m of d)if(m.condition){m.log&&console[m.log==="CRITICAL"?"error":"warn"](`${m.log} performance: Score ${o}, FPS: ${r}`),m.action.call(this),this.lastOptimization=t;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const t=this.performanceHistory.slice(-10),e=this.performanceHistory.slice(-20,-10),r=this.average(t.map(d=>d.score)),o=this.average(e.map(d=>d.score)),s=r-o;return s>5?"improving":s<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var r;const t=(r=window.performanceConfig)==null?void 0:r.viewer;if(!t)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:o,delta:s,op:d})=>{const m=this.viewer[o],f=t[o];d==="increase"&&m<f?this.viewer[o]=Math.min(f,m+s):d==="decrease"&&m>f&&(this.viewer[o]=Math.max(f,m-s))})}onTileLoaded(t){var e;(e=t.tile)!=null&&e.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+t.tile.loadTime*.1)}onTileLoadFailed(t){console.warn("Tile load failed:",t.tile)}trackLoadTime(t){this.loadTimes.push(t),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const t=this.getPerformanceLevel();return{...this.metrics,instantFPS:this.metrics.currentFPS,performanceLevel:t,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:t,performanceScore:e}=this.metrics,{fps:r}=this.thresholds;return[{name:"excellent",condition:t>=r.target&&e>=90},{name:"good",condition:t>=r.good&&e>=80},{name:"acceptable",condition:t>=r.acceptable&&e>=60},{name:"poor",condition:t>=r.poor&&e>=40},{name:"critical",condition:!0}].find(s=>s.condition).name}getWarnings(){const t=this.metrics,e=this.thresholds;return[{condition:t.averageFPS<e.fps.poor,message:`Low FPS: ${t.averageFPS} (target: ${e.fps.target})`},{condition:t.droppedFrames>200,message:`Dropped frames: ${t.droppedFrames}`},{condition:parseFloat(t.frameTime)>e.frameTime.warning,message:`High frame time: ${t.frameTime}ms`},{condition:t.memoryUsage>e.memory.critical,message:`High memory: ${t.memoryUsage}MB`},{condition:t.cachedTiles>3e3,message:`Large cache: ${t.cachedTiles} tiles`},{condition:t.tileLoadTime>500,message:`Slow tile loading: ${Math.round(t.tileLoadTime)}ms`}].filter(o=>o.condition).map(o=>o.message)}getRecommendations(){const t=[],e=this.metrics,r=this.thresholds;return e.averageFPS<r.fps.acceptable&&(e.renderMode==="animating"&&t.push("Reduce animation time for smoother transitions"),e.cachedTiles>1e3&&t.push("Clear tile cache to free memory"),e.visibleTiles>50&&t.push("Zoom in to reduce visible tiles")),e.memoryUsage>r.memory.warning&&t.push("Consider reloading the page to clear memory"),e.tileLoadTime>200&&t.push("Check network connection or reduce concurrent tile loads"),t}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const t=this.getMetrics(),e={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},r=t.currentFPS<55?"#FF9800":"#4CAF50",o=t.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${e[t.performanceLevel]};">
                    ${t.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${r};">
                    ${t.currentFPS.toFixed(0)} (avg: ${t.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${t.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${o};">
                    ${t.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${e[t.performanceLevel]}; font-weight: 500;">
                    ${t.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(t){return t.reduce((e,r)=>e+r,0)/t.length}trimArray(t,e){for(;t.length>e;)t.shift()}}class pe{constructor(t){this.viewer=t,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([e,r])=>this.viewer.addHandler(e,r))}applyInitialOptimizations(){const t=this.viewer.container;t&&Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const t=performance.now(),e=t-this.state.lastFrameTime;if(this.state.lastFrameTime=t,this.viewer.viewport.getZoom()<3&&e>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let t=null,e=!1;this.viewer.addHandler("zoom",()=>{if(!e){if(e=!0,this.viewer.drawer&&this.viewer.drawer.context){const r=this.viewer.drawer.context;r.imageSmoothingEnabled=!1,r.globalAlpha=1}this.viewer.skipTileDrawing=!0}t&&clearTimeout(t),t=setTimeout(()=>{if(e=!1,this.viewer.drawer&&this.viewer.drawer.context){const r=this.viewer.drawer.context;r.imageSmoothingEnabled=!0,r.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),t=null},150)})}handleViewportChange(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const r=Math.abs(t-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+r*.3,this.state.isZooming=r>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const r=Math.sqrt(Math.pow(e.x-this.lastCenter.x,2)+Math.pow(e.y-this.lastCenter.y,2));this.state.isPanning=r>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=t,this.lastCenter=e}applyZoomOptimizations(t){var r,o;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((o=(r=window.performanceConfig)==null?void 0:r.renderOptimization)!=null&&o.zoomOptimizations))){if(t&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const s=this.viewer.world.getItemAt(0);s&&(this.state.lastBlendTime=0,s.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!t&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const s=this.viewer.world.getItemAt(0);s&&(s.blendTime=0)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(t){var r;this.lastInteraction=Date.now();const e={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(r=e[t])==null||r.call(e)}setRenderMode(t){var r,o;if(this.state.renderMode===t)return;const e=this.state.renderMode;this.state.renderMode=t,t==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):t==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(o=(r=window.performanceConfig)==null?void 0:r.debug)!=null&&o.logPerformance&&console.log(`Render mode: ${e} → ${t}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var o,s;const t=Date.now();if(t-this.lastOptimizationTime<this.config.optimizationCooldown)return;const e=(o=this.viewer.drawer)==null?void 0:o.canvas,r=(s=this.viewer.drawer)==null?void 0:s.context;!e||!r||(Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(r,!0),r.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=t)}removeCanvasOptimizations(){var e;const t=(e=this.viewer.drawer)==null?void 0:e.context;t&&(this.setContextSmoothing(t,!0),t.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(t,e){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(o=>{o in t&&(t[o]=e)})}clearTimers(){Object.entries(this.timers).forEach(([t,e])=>{clearTimeout(e),delete this.timers[t]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(t){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(r=>Object.assign(r.style,t))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(t){Object.assign(this.config,t)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var t,e;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((e=(t=window.performanceConfig)==null?void 0:t.viewer)==null?void 0:e.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(t=>this.viewer.removeAllHandlers(t)),this.removeCanvasOptimizations(),this.viewer=null}}class ge{constructor(t){this.viewer=t,this.isInteracting=!1,this.highQualityTimeout=null,this.basePixelRatio=window.devicePixelRatio||1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.lastInteractionStart=0,this.interactionCount=0,this.averageFPS=60,this.scalingFactor=.2,this.restoreDelay=800,console.log("SafariPerformanceOptimizer initialized:",{isSafari:this.isSafari,isIOS:this.isIOS,basePixelRatio:this.basePixelRatio,scalingFactor:this.scalingFactor}),this.isSafari&&(this.setupEventHandlers(),this.applyInitialOptimizations())}setupEventHandlers(){let t=null;const e=()=>{t&&clearTimeout(t),t=setTimeout(()=>{this.startInteraction()},16)};this.viewer.addHandler("animation-start",e),this.viewer.addHandler("pan",e),this.viewer.addHandler("zoom",e),this.isIOS&&this.viewer.addHandler("canvas-pinch",e),this.viewer.addHandler("animation-finish",()=>this.endInteraction());const r=this.viewer.canvas;r&&(r.addEventListener("touchstart",e,{passive:!0}),r.addEventListener("mousedown",e,{passive:!0}))}applyInitialOptimizations(){if(this.viewer.drawer&&this.viewer.drawer.canvas){const t=this.viewer.drawer.canvas;t.style.transform="translateZ(0)",t.style.willChange="transform",t.style.backfaceVisibility="hidden",t.style.webkitBackfaceVisibility="hidden",t.style.outline="none"}if(this.viewer.drawer&&this.viewer.drawer.context){const t=this.viewer.drawer.context;t.imageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1}}startInteraction(){var e;if(!this.isSafari||this.isInteracting)return;this.isInteracting=!0,this.lastInteractionStart=performance.now(),this.interactionCount++,clearTimeout(this.highQualityTimeout),!this.originalPixelRatio&&this.viewer.drawer&&(this.originalPixelRatio=this.viewer.drawer.pixelRatio||this.basePixelRatio);const t=this.originalPixelRatio*this.scalingFactor;if(console.log("Safari: Reducing render quality for interaction",{from:this.originalPixelRatio,to:t,scalingFactor:this.scalingFactor}),this.viewer.drawer&&(this.viewer.drawer.pixelRatio=t,this.viewer.drawer.canvas)){const r=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=r.x*t,this.viewer.drawer.canvas.height=r.y*t}if(this.viewer.drawer&&(this.viewer.drawer.context&&(this.viewer.drawer.context.imageSmoothingEnabled=!1,this.viewer.drawer.context.webkitImageSmoothingEnabled=!1),this.viewer.immediateRender=!0,this.viewer.blendTime=0,this.viewer.alwaysBlend=!1,this.originalSettings={immediateRender:this.viewer.immediateRender,blendTime:this.viewer.blendTime,alwaysBlend:this.viewer.alwaysBlend,imageLoaderLimit:(e=this.viewer.imageLoader)==null?void 0:e.jobLimit}),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),this.viewer.world){const r=this.viewer.world.getItemAt(0);r&&(r.skipLevelIfLargerThan=.9)}if(this.averageFPS<15&&this.scalingFactor<=.2&&(console.log("Safari: ULTRA PERFORMANCE MODE activated"),this.viewer.minPixelRatio=2,this.viewer.maxTilesPerFrame=1,this.viewer.visibilityRatio=1,window.nativeHotspotRenderer&&(window.nativeHotspotRenderer.performanceMode=!0)),this.viewer.tileCache){const r=this.viewer.tileCache;this.originalCacheSize=r._maxImageCacheCount,r._maxImageCacheCount=Math.floor(this.originalCacheSize*.3)}this.viewer.forceRedraw()}endInteraction(){if(!this.isSafari||!this.isInteracting)return;this.isInteracting=!1;const t=performance.now()-this.lastInteractionStart;console.log(`Safari: Interaction ended (duration: ${t.toFixed(0)}ms)`),this.highQualityTimeout=setTimeout(()=>{const e=this.originalPixelRatio||this.basePixelRatio;if(console.log("Safari: Restoring full render quality",{to:e}),this.viewer.drawer&&(this.viewer.drawer.pixelRatio=e,this.viewer.drawer.canvas)){const r=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=r.x*e,this.viewer.drawer.canvas.height=r.y*e}if(this.originalSettings&&(this.viewer.immediateRender=this.originalSettings.immediateRender!==void 0?this.originalSettings.immediateRender:!1,this.viewer.blendTime=this.originalSettings.blendTime!==void 0?this.originalSettings.blendTime:.5,this.viewer.alwaysBlend=this.originalSettings.alwaysBlend!==void 0?this.originalSettings.alwaysBlend:!1,this.viewer.imageLoader&&this.originalSettings.imageLoaderLimit&&(this.viewer.imageLoader.jobLimit=this.originalSettings.imageLoaderLimit)),this.viewer.drawer&&this.viewer.drawer.context&&(this.viewer.drawer.context.imageSmoothingEnabled=!0,this.viewer.drawer.context.webkitImageSmoothingEnabled=!0),this.viewer.world){const r=this.viewer.world.getItemAt(0);r&&(r.skipLevelIfLargerThan=1/0)}this.viewer.tileCache&&this.originalCacheSize&&(this.viewer.tileCache._maxImageCacheCount=this.originalCacheSize),this.viewer.forceRedraw()},this.restoreDelay)}updatePerformanceMetrics(t){this.averageFPS=this.averageFPS*.9+t*.1,this.averageFPS<20&&this.scalingFactor>.15?(this.scalingFactor=.15,console.log(`Safari: EMERGENCY - Reduced scaling factor to ${this.scalingFactor} due to very low FPS`)):this.averageFPS<30&&this.scalingFactor>.25?(this.scalingFactor=Math.max(.25,this.scalingFactor-.1),console.log(`Safari: Reduced scaling factor to ${this.scalingFactor} due to low FPS`)):this.averageFPS>50&&this.scalingFactor<.5&&(this.scalingFactor=Math.min(.5,this.scalingFactor+.05),console.log(`Safari: Increased scaling factor to ${this.scalingFactor} due to good FPS`))}forceOptimization(t){t?(this.startInteraction(),clearTimeout(this.highQualityTimeout)):(this.isInteracting=!1,this.endInteraction())}getState(){const t=this.viewer.drawer?this.viewer.drawer.pixelRatio:this.basePixelRatio;return{isActive:this.isSafari,isInteracting:this.isInteracting,currentPixelRatio:t,basePixelRatio:this.basePixelRatio,scalingFactor:this.scalingFactor,averageFPS:this.averageFPS.toFixed(1),platform:this.isIOS?"iOS Safari":"Desktop Safari"}}destroy(){clearTimeout(this.highQualityTimeout)}}function te(l,t,e=0,r=l.length-1,o=ve){for(;r>e;){if(r-e>600){const f=r-e+1,g=t-e+1,v=Math.log(f),i=.5*Math.exp(2*v/3),n=.5*Math.sqrt(v*i*(f-i)/f)*(g-f/2<0?-1:1),a=Math.max(e,Math.floor(t-g*i/f+n)),c=Math.min(r,Math.floor(t+(f-g)*i/f+n));te(l,t,a,c,o)}const s=l[t];let d=e,m=r;for(V(l,e,t),o(l[r],s)>0&&V(l,e,r);d<m;){for(V(l,d,m),d++,m--;o(l[d],s)<0;)d++;for(;o(l[m],s)>0;)m--}o(l[e],s)===0?V(l,e,m):(m++,V(l,m,r)),m<=t&&(e=m+1),t<=m&&(r=m-1)}}function V(l,t,e){const r=l[t];l[t]=l[e],l[e]=r}function ve(l,t){return l<t?-1:l>t?1:0}class we{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const r=[];if(!G(t,e))return r;const o=this.toBBox,s=[];for(;e;){for(let d=0;d<e.children.length;d++){const m=e.children[d],f=e.leaf?o(m):m;G(t,f)&&(e.leaf?r.push(m):j(t,f)?this._all(m,r):s.push(m))}e=s.pop()}return r}collides(t){let e=this.data;if(!G(t,e))return!1;const r=[];for(;e;){for(let o=0;o<e.children.length;o++){const s=e.children[o],d=e.leaf?this.toBBox(s):s;if(G(t,d)){if(e.leaf||j(t,d))return!0;r.push(s)}}e=r.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let r=0;r<t.length;r++)this.insert(t[r]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const r=this.data;this.data=e,e=r}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=H([]),this}remove(t,e){if(!t)return this;let r=this.data;const o=this.toBBox(t),s=[],d=[];let m,f,g;for(;r||s.length;){if(r||(r=s.pop(),f=s[s.length-1],m=d.pop(),g=!0),r.leaf){const v=_e(t,r.children,e);if(v!==-1)return r.children.splice(v,1),s.push(r),this._condense(s),this}!g&&!r.leaf&&j(r,o)?(s.push(r),d.push(m),m=0,f=r,r=r.children[0]):f?(m++,r=f.children[m],g=!1):r=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const r=[];for(;t;)t.leaf?e.push(...t.children):r.push(...t.children),t=r.pop();return e}_build(t,e,r,o){const s=r-e+1;let d=this._maxEntries,m;if(s<=d)return m=H(t.slice(e,r+1)),F(m,this.toBBox),m;o||(o=Math.ceil(Math.log(s)/Math.log(d)),d=Math.ceil(s/Math.pow(d,o-1))),m=H([]),m.leaf=!1,m.height=o;const f=Math.ceil(s/d),g=f*Math.ceil(Math.sqrt(d));ee(t,e,r,g,this.compareMinX);for(let v=e;v<=r;v+=g){const i=Math.min(v+g-1,r);ee(t,v,i,f,this.compareMinY);for(let n=v;n<=i;n+=f){const a=Math.min(n+f-1,i);m.children.push(this._build(t,n,a,o-1))}}return F(m,this.toBBox),m}_chooseSubtree(t,e,r,o){for(;o.push(e),!(e.leaf||o.length-1===r);){let s=1/0,d=1/0,m;for(let f=0;f<e.children.length;f++){const g=e.children[f],v=Q(g),i=Se(t,g)-v;i<d?(d=i,s=v<s?v:s,m=g):i===d&&v<s&&(s=v,m=g)}e=m||e.children[0]}return e}_insert(t,e,r){const o=r?t:this.toBBox(t),s=[],d=this._chooseSubtree(o,this.data,e,s);for(d.children.push(t),q(d,o);e>=0&&s[e].children.length>this._maxEntries;)this._split(s,e),e--;this._adjustParentBBoxes(o,s,e)}_split(t,e){const r=t[e],o=r.children.length,s=this._minEntries;this._chooseSplitAxis(r,s,o);const d=this._chooseSplitIndex(r,s,o),m=H(r.children.splice(d,r.children.length-d));m.height=r.height,m.leaf=r.leaf,F(r,this.toBBox),F(m,this.toBBox),e?t[e-1].children.push(m):this._splitRoot(r,m)}_splitRoot(t,e){this.data=H([t,e]),this.data.height=t.height+1,this.data.leaf=!1,F(this.data,this.toBBox)}_chooseSplitIndex(t,e,r){let o,s=1/0,d=1/0;for(let m=e;m<=r-e;m++){const f=Y(t,0,m,this.toBBox),g=Y(t,m,r,this.toBBox),v=be(f,g),i=Q(f)+Q(g);v<s?(s=v,o=m,d=i<d?i:d):v===s&&i<d&&(d=i,o=m)}return o||r-e}_chooseSplitAxis(t,e,r){const o=t.leaf?this.compareMinX:ye,s=t.leaf?this.compareMinY:Te,d=this._allDistMargin(t,e,r,o),m=this._allDistMargin(t,e,r,s);d<m&&t.children.sort(o)}_allDistMargin(t,e,r,o){t.children.sort(o);const s=this.toBBox,d=Y(t,0,e,s),m=Y(t,r-e,r,s);let f=W(d)+W(m);for(let g=e;g<r-e;g++){const v=t.children[g];q(d,t.leaf?s(v):v),f+=W(d)}for(let g=r-e-1;g>=e;g--){const v=t.children[g];q(m,t.leaf?s(v):v),f+=W(m)}return f}_adjustParentBBoxes(t,e,r){for(let o=r;o>=0;o--)q(e[o],t)}_condense(t){for(let e=t.length-1,r;e>=0;e--)t[e].children.length===0?e>0?(r=t[e-1].children,r.splice(r.indexOf(t[e]),1)):this.clear():F(t[e],this.toBBox)}}function _e(l,t,e){if(!e)return t.indexOf(l);for(let r=0;r<t.length;r++)if(e(l,t[r]))return r;return-1}function F(l,t){Y(l,0,l.children.length,t,l)}function Y(l,t,e,r,o){o||(o=H(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(let s=t;s<e;s++){const d=l.children[s];q(o,l.leaf?r(d):d)}return o}function q(l,t){return l.minX=Math.min(l.minX,t.minX),l.minY=Math.min(l.minY,t.minY),l.maxX=Math.max(l.maxX,t.maxX),l.maxY=Math.max(l.maxY,t.maxY),l}function ye(l,t){return l.minX-t.minX}function Te(l,t){return l.minY-t.minY}function Q(l){return(l.maxX-l.minX)*(l.maxY-l.minY)}function W(l){return l.maxX-l.minX+(l.maxY-l.minY)}function Se(l,t){return(Math.max(t.maxX,l.maxX)-Math.min(t.minX,l.minX))*(Math.max(t.maxY,l.maxY)-Math.min(t.minY,l.minY))}function be(l,t){const e=Math.max(l.minX,t.minX),r=Math.max(l.minY,t.minY),o=Math.min(l.maxX,t.maxX),s=Math.min(l.maxY,t.maxY);return Math.max(0,o-e)*Math.max(0,s-r)}function j(l,t){return l.minX<=t.minX&&l.minY<=t.minY&&t.maxX<=l.maxX&&t.maxY<=l.maxY}function G(l,t){return t.minX<=l.maxX&&t.minY<=l.maxY&&t.maxX>=l.minX&&t.maxY>=l.minY}function H(l){return{children:l,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ee(l,t,e,r,o){const s=[t,e];for(;s.length;){if(e=s.pop(),t=s.pop(),e-t<=r)continue;const d=t+Math.ceil((e-t)/r/2)*r;te(l,d,t,e,o),s.push(t,d,d,e)}}class xe{constructor(){this.tree=new we(9),this.hotspots=new Map,this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(t){const e=performance.now();this.tree.clear(),this.hotspots.clear(),this.queryCache.clear();const r=[];t.forEach(s=>{const d=this.calculateBoundingBox(s.coordinates);this.hotspots.set(s.id,{...s,bbox:d}),r.push({minX:d.minX,minY:d.minY,maxX:d.maxX,maxY:d.maxY,id:s.id})}),this.tree.load(r);const o=performance.now()-e;console.log(`Spatial index built in ${o.toFixed(2)}ms for ${r.length} hotspots`)}queryViewport(t,e=1){const r=`${t.minX.toFixed(2)},${t.minY.toFixed(2)},${t.maxX.toFixed(2)},${t.maxY.toFixed(2)},${e.toFixed(2)}`;if(this.queryCache.has(r))return this.queryCache.get(r);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const s=this.tree.search({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY}).map(d=>this.hotspots.get(d.id));return this.queryCache.size<this.cacheSize&&this.queryCache.set(r,s),s}getHotspotAtPoint(t,e){const r=this.tree.search({minX:t,minY:e,maxX:t,maxY:e});for(const o of r){const s=this.hotspots.get(o.id);if(this.isPointInHotspot(t,e,s))return s}return null}calculateBoundingBox(t){let e=1/0,r=1/0,o=-1/0,s=-1/0;const d=m=>{for(const f of m)e=Math.min(e,f[0]),r=Math.min(r,f[1]),o=Math.max(o,f[0]),s=Math.max(s,f[1])};if(t.length>0&&typeof t[0][0]=="number")d(t);else for(const m of t)d(m);return{minX:e,minY:r,maxX:o,maxY:s}}isPointInHotspot(t,e,r){return r.shape==="polygon"?this.pointInPolygon(t,e,r.coordinates):r.shape==="multipolygon"?r.coordinates.some(o=>this.pointInPolygon(t,e,o)):!1}pointInPolygon(t,e,r){let o=!1;const s=r.length;let d=r[0][0],m=r[0][1];for(let f=1;f<=s;f++){const g=r[f%s][0],v=r[f%s][1];if(e>Math.min(m,v)&&e<=Math.max(m,v)&&t<=Math.max(d,g)&&m!==v){const i=(e-m)*(g-d)/(v-m)+d;(d===g||t<=i)&&(o=!o)}d=g,m=v}return o}getAllHotspots(){return Array.from(this.hotspots.values())}clear(){this.tree.clear(),this.hotspots.clear(),this.queryCache.clear()}}class Ae{constructor(t){this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:10}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(t){if(!t.tile)return;const e=this.getTileKey(t.tile);this.tileAccessTimes.set(e,Date.now())}handleViewportChange(){var r;const t=(r=this.viewer.world)==null?void 0:r.getItemAt(0);if(!t||!t._tilesToDraw)return;const e=Date.now();t._tilesToDraw.forEach(o=>{const s=this.getTileKey(o);this.tileAccessTimes.set(s,e)})}getTileKey(t){return`${t.level}_${t.x}_${t.y}`}monitorPerformance(){var o,s;const t=((s=(o=window.performanceMonitor)==null?void 0:o.getMetrics())==null?void 0:s.averageFPS)||60,e=this.state.currentPressure;/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?t<10?this.state.currentPressure="critical":t<15?this.state.currentPressure="high":t<25?this.state.currentPressure="elevated":this.state.currentPressure="normal":t<this.config.fpsThresholds.critical?this.state.currentPressure="critical":t<this.config.fpsThresholds.poor?this.state.currentPressure="high":t<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",e!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${e} → ${this.state.currentPressure} (FPS: ${t})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const e={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),e)}performCleanup(){var y;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const e=performance.now(),r=(y=this.viewer.world)==null?void 0:y.getItemAt(0);if(!r||!r._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const s=this.state.currentPressure,d=this.config.maxTileAge[s],m=this.config.cacheThresholds[s],f=this.config.keepDistance[s],g=Date.now(),i=this.viewer.viewport.getBounds(),n={x:i.x-i.width*(f-1)/2,y:i.y-i.height*(f-1)/2,width:i.width*f,height:i.height*f},c=r._tileCache._tilesLoaded||[],p=c.length;if(p===0)return;const u=new Set;r._tilesToDraw&&r._tilesToDraw.forEach(S=>{const x=this.getTileKey(S);u.add(x)});const h=[];if(c.forEach(S=>{const x=this.getTileKey(S);if(u.has(x))return;const P=this.tileAccessTimes.get(x)||0,C=g-P;let A=!1;if(C>d&&(A=!0),!A&&s!=="normal"){const T=S.bounds;T&&(!(T.x+T.width<n.x||T.x>n.x+n.width||T.y+T.height<n.y||T.y>n.y+n.height)||(A=!0))}A&&h.push(S)}),p>m){const S=p-m;if(S>h.length){const x=c.filter(C=>{const A=this.getTileKey(C);return!h.includes(C)&&!u.has(A)});x.sort((C,A)=>{const T=this.getTileKey(C),L=this.getTileKey(A),k=this.tileAccessTimes.get(T)||0,R=this.tileAccessTimes.get(L)||0;return k-R});const P=S-h.length;h.push(...x.slice(0,P))}}h.length>0&&(h.forEach(S=>{const x=this.getTileKey(S);this.tileAccessTimes.delete(x),S.unload&&S.unload()}),this.state.tilesRemoved+=h.length,this.metrics.totalCleaned+=h.length,console.log(`Cleaned ${h.length} tiles (pressure: ${s}, cache was: ${p}, kept ${u.size} visible)`));const _=performance.now()-e;this.metrics.lastCleanupDuration=_,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+_)/this.metrics.cleanupRuns,this.state.lastCleanup=g,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const e=performance.now(),r=Date.now(),o=3e5,s=[];this.tileAccessTimes.forEach((m,f)=>{r-m>o&&s.push(f)}),s.forEach(m=>this.tileAccessTimes.delete(m)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const d=performance.now()-e;this.state.lastDeepCleanup=r,console.log(`Deep cleanup completed in ${d.toFixed(2)}ms, cleared ${s.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var r,o,s;const t=(r=this.viewer.world)==null?void 0:r.getItemAt(0),e=((s=(o=t==null?void 0:t._tileCache)==null?void 0:o._tilesLoaded)==null?void 0:s.length)||0;return{...this.metrics,currentCacheSize:e,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(t){["normal","elevated","high","critical"].includes(t)&&(this.state.currentPressure=t,this.updateCleanupInterval())}pauseCleanup(t=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},t))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class Ce{constructor(t){this.viewer=t,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(t){throw console.error("Failed to initialize TileWorkerManager:",t),this.state.lastError=t,t}}async processTile(t,e=2){this.isInitialized||await this.initialize();const r=this.generateRequestId();return new Promise((o,s)=>{const d=setTimeout(()=>{this.state.pendingRequests.delete(r),this.metrics.requestsFailed++,s(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(r,{resolve:o,reject:s,timeout:d,startTime:performance.now(),tile:t}),this.worker.postMessage({type:"process-tile",requestId:r,data:{tile:this.serializeTile(t),priority:e}}),this.metrics.requestsSent++})}async processBatch(t,e=[]){this.isInitialized||await this.initialize();const r=this.generateRequestId();return new Promise((o,s)=>{const d=setTimeout(()=>{this.state.pendingRequests.delete(r),this.metrics.requestsFailed++,s(new Error("Batch processing timeout"))},this.config.requestTimeout*t.length);this.state.pendingRequests.set(r,{resolve:o,reject:s,timeout:d,startTime:performance.now(),tiles:t}),this.worker.postMessage({type:"batch-process",requestId:r,data:{tiles:t.map(m=>this.serializeTile(m)),priorities:e}}),this.metrics.requestsSent++})}async prioritizeTiles(t,e){if(this.isInitialized||await this.initialize(),t.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const o=t.map(s=>{const d=(s.bounds.minX+s.bounds.maxX)/2,m=(s.bounds.minY+s.bounds.maxY)/2,f=(e.bounds.minX+e.bounds.maxX)/2,g=(e.bounds.minY+e.bounds.maxY)/2,v=Math.sqrt(Math.pow(d-f,2)+Math.pow(m-g,2));return v<.5?0:v<1?1:2});return{tiles:t,priorities:o}}const r=this.generateRequestId();return new Promise((o,s)=>{const d=setTimeout(()=>{this.state.pendingRequests.delete(r),o({tiles:t,priorities:t.map(()=>1)})},50);this.state.pendingRequests.set(r,{resolve:o,reject:s,timeout:d}),this.worker.postMessage({type:"prioritize",requestId:r,data:{tiles:t.map(m=>this.serializeTile(m)),viewport:{bounds:e.bounds,zoom:e.zoom}}})})}clearCache(t=!1,e=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:t,maxAge:e}})}async getStats(){if(!this.isInitialized)return this.metrics;const t=this.generateRequestId();return new Promise(e=>{const r=setTimeout(()=>{this.state.pendingRequests.delete(t),e(this.metrics)},1e3);this.state.pendingRequests.set(t,{resolve:e,reject:()=>{},timeout:r}),this.worker.postMessage({type:"get-stats",requestId:t})})}handleWorkerMessage(t){const{type:e,requestId:r,data:o}=t.data;switch(e){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=o.capabilities,this.handleRequestComplete(r,o);break;case"tile-ready":this.handleTileReady(r,o);break;case"tile-error":this.handleTileError(r,o);break;case"batch-complete":this.handleRequestComplete(r,o);break;case"priorities-calculated":this.handleRequestComplete(r,o);break;case"stats":this.handleStatsReceived(r,o);break;case"cache-cleared":console.log("Worker cache cleared:",o);break;default:console.warn("Unknown worker message type:",e)}}handleWorkerError(t){console.error("Worker error:",t),this.state.lastError=t,this.state.pendingRequests.forEach((e,r)=>{clearTimeout(e.timeout),e.reject(t)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(t,e){const r=this.state.pendingRequests.get(t);if(!r)return;clearTimeout(r.timeout),this.state.pendingRequests.delete(t);const o=performance.now()-r.startTime;this.updateMetrics(o,e.cached),r.resolve({...e,processingTime:o})}handleTileError(t,e){const r=this.state.pendingRequests.get(t);r&&(clearTimeout(r.timeout),this.state.pendingRequests.delete(t),this.metrics.requestsFailed++,r.reject(new Error(e.error)))}handleRequestComplete(t,e){const r=this.state.pendingRequests.get(t);r&&(clearTimeout(r.timeout),this.state.pendingRequests.delete(t),r.resolve(e))}handleStatsReceived(t,e){const r=this.state.pendingRequests.get(t);if(!r)return;clearTimeout(r.timeout),this.state.pendingRequests.delete(t);const o={...this.metrics,worker:e};r.resolve(o)}updateMetrics(t,e){this.metrics.requestsCompleted++,e&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=t,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(t){return{level:t.level,x:t.x,y:t.y,bounds:t.bounds?{minX:t.bounds.x||t.bounds.minX,minY:t.bounds.y||t.bounds.minY,maxX:(t.bounds.x||t.bounds.minX)+(t.bounds.width||0),maxY:(t.bounds.y||t.bounds.minY)+(t.bounds.height||0)}:null,url:t.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(t=>{if(this.state.workerReady){t();return}const e=setInterval(()=>{this.state.workerReady&&(clearInterval(e),t())},100);setTimeout(()=>{clearInterval(e),t()},5e3)})}async sendToWorker(t,e){const r=this.generateRequestId();return new Promise((o,s)=>{const d=setTimeout(()=>{this.state.pendingRequests.delete(r),s(new Error(`Worker request timeout: ${t}`))},5e3);this.state.pendingRequests.set(r,{resolve:o,reject:s,timeout:d}),this.worker.postMessage({type:t,requestId:r,data:e})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(t=>{clearTimeout(t.timeout),t.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class Me{constructor(t){this.viewer=t,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new Ce(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(t){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",t),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const t=this.viewer.viewport,e=t.getBounds(),r={bounds:{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height},zoom:t.getZoom()},o=this.state.tileQueue.slice(0,50),s=await this.workerManager.prioritizeTiles(o,r);s.tiles&&s.priorities&&(s.tiles.forEach((d,m)=>{const f=s.priorities[m],g=this.state.tileQueue.find(v=>v.level===d.level&&v.x===d.x&&v.y===d.y);g&&(g.priority=f)}),this.sortQueue())}catch(t){console.warn("Failed to update worker priorities:",t)}}calculateTilePriority(t,e,r){const o=this.viewer.viewport,s=o.getBounds(),d=o.getCenter(),m=o.getZoom();if(m<2&&this.viewer.source.getTileWidth(t)*m<32)return 999;const f=this.viewer.source.getTileWidth(t),g=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):f,v=(e+.5)*f/this.viewer.source.width,i=(r+.5)*g/this.viewer.source.height,n=Math.sqrt(Math.pow(v-d.x,2)+Math.pow(i-d.y,2)),a={left:e*f/this.viewer.source.width,top:r*g/this.viewer.source.height,right:(e+1)*f/this.viewer.source.width,bottom:(r+1)*g/this.viewer.source.height};return a.right<s.x||a.left>s.x+s.width||a.bottom<s.y||a.top>s.y+s.height?n<s.width*this.config.predictiveRadius?1:2:m<3?Math.abs(v-d.x)+Math.abs(i-d.y)<.2?0:1:0}enqueueTile(t,e,r,o){const s=`${t}_${e}_${r}`;if(this.state.loadingTiles.has(s))return;const d=this.state.tileQueue.findIndex(f=>f.key===s);if(d>=0){o<this.state.tileQueue[d].priority&&(this.state.tileQueue[d].priority=o,this.sortQueue());return}const m={level:t,x:e,y:r,key:s,priority:o,timestamp:Date.now(),bounds:this.calculateTileBounds(t,e,r)};this.state.tileQueue.push(m),this.sortQueue()}calculateTileBounds(t,e,r){const o=this.viewer.source.getTileWidth(t),s=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):o,d=this.viewer.source.width,m=this.viewer.source.height;return{minX:e*o/d,minY:r*s/m,maxX:(e+1)*o/d,maxY:(r+1)*s/m}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const t=this.state.tileQueue.filter(e=>e.priority<=1).slice(0,this.config.workerBatchSize);if(t.length!==0)try{const e=t.map(s=>s.priority),r=performance.now();await this.workerManager.processBatch(t,e);const o=performance.now()-r;this.workerMetrics.tilesProcessedByWorker+=t.length,this.workerMetrics.workerProcessingTime+=o,t.forEach(s=>{const d=this.state.tileQueue.findIndex(m=>m.key===s.key);d>=0&&this.state.tileQueue.splice(d,1)})}catch(e){console.error("Worker batch processing failed:",e),this.workerMetrics.workerErrors++}}processQueue(){var e;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((e=this.viewer.world)!=null&&e.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const r=this.state.tileQueue.shift();Date.now()-r.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(r.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((t,e)=>t.priority!==e.priority?t.priority-e.priority:t.timestamp-e.timestamp)}predictiveLoad(){var n;if(this.shouldSkipPredictiveLoad()||!((n=this.viewer.world)==null?void 0:n.getItemAt(0))||!this.viewer.source)return;const e=this.viewer.viewport,r=e.getBounds(),o={x:r.x-r.width*(this.config.predictiveRadius-1)/2,y:r.y-r.height*(this.config.predictiveRadius-1)/2,width:r.width*this.config.predictiveRadius,height:r.height*this.config.predictiveRadius},s=e.getZoom(),d=Math.max(0,Math.min(Math.floor(Math.log2(s)),this.viewer.source.maxLevel||14)),m=this.viewer.source.getTileWidth(d),f=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(d):m,g=this.viewer.source.width,v=this.viewer.source.height,i={startX:Math.max(0,Math.floor(o.x*g/m)),endX:Math.min(Math.ceil(g/m)-1,Math.ceil((o.x+o.width)*g/m)),startY:Math.max(0,Math.floor(o.y*v/f)),endY:Math.min(Math.ceil(v/f)-1,Math.ceil((o.y+o.height)*v/f))};for(let a=i.startX;a<=i.endX;a++)for(let c=i.startY;c<=i.endY;c++){const p=this.calculateTilePriority(d,a,c);this.enqueueTile(d,a,c,p)}}trackLoadTime(t){this.state.loadTimes.push(t),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((e,r)=>e+r,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(t){this.state.loadingTiles.delete(t)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const t=this.state.averageLoadTime,e=this.config.maxConcurrentLoads;t>500&&e>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`)):t<200&&e<8&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`))}performCleanup(){const t=Date.now();this.state.tileQueue=this.state.tileQueue.filter(e=>t-e.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=t,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const t=document.createElement("canvas");t.width=t.height=1;const e=t.getContext("2d");e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,1,1);try{return t.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const t=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:t}}}class Pe{constructor(t,e){this.viewer=t,this.components=e,this.isAnimating=!1,this.animationEndHandlers=[],this.debugMode=!1,this.STABLE_SPRING_CONFIG={desktop:{animationTime:1,springStiffness:6.5,damping:.85},mobile:{animationTime:.8,springStiffness:8,damping:.9}},this.CONVERGENCE_THRESHOLD=.001,this.OSCILLATION_THRESHOLD=.01,this.setupDiagnostics()}setupDiagnostics(){if(!this.viewer)return;let t=0,e=[];this.viewer.addHandler("zoom",r=>{if(!this.isAnimating)return;const o=r.zoom;if(e.push(o),e.length>10&&e.shift(),e.length>=3){const[s,d,m]=e.slice(-3);(d>s&&m<d||d<s&&m>d)&&(t++,t>=2&&this.debugMode&&console.warn("🔴 Oscillation detected!",{pattern:[s,d,m],count:t}))}})}async performCinematicZoom(t,e={}){if(this.isAnimating){console.log("Cinematic zoom already in progress");return}const s={.../Android|iPhone|iPad/i.test(navigator.userAgent)?this.STABLE_SPRING_CONFIG.mobile:this.STABLE_SPRING_CONFIG.desktop,...e,onComplete:e.onComplete||(()=>{})};this.isAnimating=!0,this.disableInterferingComponents();const d=this.storeOriginalSettings();this.applyStableSpringConfig(s);const m=this.calculateZoomParameters(t);return this.debugMode&&console.log("🎯 Starting stable cinematic zoom:",{currentZoom:this.viewer.viewport.getZoom(),targetZoom:m.zoom,config:s}),this.executeStableZoom(m,s,d),new Promise(f=>{this.animationEndHandlers.push(f)})}disableInterferingComponents(){this.components.lowZoomOptimizer&&this.components.lowZoomOptimizer.setCinematicMode(!0),this.viewer.imageLoader&&this.viewer.imageLoader.clear(),this.components.tileCleanupManager&&this.components.tileCleanupManager.pauseCleanup(3e3),this.components.renderOptimizer&&this.components.renderOptimizer.startCinematicZoom()}storeOriginalSettings(){return{animationTime:this.viewer.animationTime,springStiffness:this.viewer.springStiffness,centerXTime:this.viewer.viewport.centerSpringX.animationTime,centerYTime:this.viewer.viewport.centerSpringY.animationTime,zoomTime:this.viewer.viewport.zoomSpring.animationTime,centerXStiffness:this.viewer.viewport.centerSpringX.springStiffness,centerYStiffness:this.viewer.viewport.centerSpringY.springStiffness,zoomStiffness:this.viewer.viewport.zoomSpring.springStiffness}}applyStableSpringConfig(t){this.viewer.animationTime=t.animationTime,this.viewer.springStiffness=t.springStiffness,[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].forEach(r=>{r.animationTime=t.animationTime,r.springStiffness=t.springStiffness,r.resetTo(r.current.value)}),this.viewer.viewport.applyConstraints()}calculateZoomParameters(t){const e=this.viewer.viewport,r=e.getZoom();let o;if(e.getZoomForBounds)o=e.getZoomForBounds(t);else{const d=e.getBounds(),m=d.width/t.width,f=d.height/t.height;o=Math.min(m,f)*r}const s=t.getCenter();return{zoom:o,center:new z.Point(s.x,s.y),currentZoom:r,zoomRatio:o/r}}executeStableZoom(t,e,r){const{zoom:o,center:s}=t;this.viewer.viewport.panTo(s),this.viewer.viewport.zoomTo(o);let d=0;const m=100,f=setInterval(()=>{d++;const v=[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].every(n=>Math.abs(n.current.value-n.target.value)<this.CONVERGENCE_THRESHOLD),i=d>=m;(v||i)&&(clearInterval(f),this.debugMode&&console.log("✅ Zoom stabilized:",{checkCount:d,timedOut:i,finalZoom:this.viewer.viewport.getZoom()}),setTimeout(()=>{this.completeAnimation(r,e)},100)),d>20&&!v&&this.applyEmergencyDamping()},50)}applyEmergencyDamping(){[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].forEach(e=>{e.springStiffness=Math.min(e.springStiffness*1.5,20),Math.abs(e.current.value-e.target.value)<this.OSCILLATION_THRESHOLD&&e.resetTo(e.target.value)}),this.debugMode&&console.log("🟡 Emergency damping applied")}completeAnimation(t,e){var r,o,s;this.isAnimating=!1,this.viewer.animationTime=t.animationTime,this.viewer.springStiffness=t.springStiffness,this.viewer.viewport.centerSpringX.animationTime=t.centerXTime,this.viewer.viewport.centerSpringY.animationTime=t.centerYTime,this.viewer.viewport.zoomSpring.animationTime=t.zoomTime,this.viewer.viewport.centerSpringX.springStiffness=t.centerXStiffness,this.viewer.viewport.centerSpringY.springStiffness=t.centerYStiffness,this.viewer.viewport.zoomSpring.springStiffness=t.zoomStiffness,this.components.lowZoomOptimizer&&this.components.lowZoomOptimizer.setCinematicMode(!1),this.components.renderOptimizer&&this.components.renderOptimizer.endCinematicZoom(),console.log("🔍 Checking renderer for reset:",{hasRenderer:!!this.components.renderer,rendererType:(o=(r=this.components.renderer)==null?void 0:r.constructor)==null?void 0:o.name,hasResetMethod:typeof((s=this.components.renderer)==null?void 0:s.resetAnimationState)=="function"}),this.components.renderer&&typeof this.components.renderer.resetAnimationState=="function"?(console.log("🎯 Safari Fix: Resetting renderer animation state after cinematic zoom"),this.components.renderer.resetAnimationState()):console.warn("⚠️ Cannot reset renderer animation state - method not available"),this.components.overlayManager&&typeof this.components.overlayManager.resetAnimationState=="function"&&(console.log("🎯 Safari Fix: Resetting overlay manager animation state"),this.components.overlayManager.resetAnimationState()),this.animationEndHandlers.forEach(d=>d()),this.animationEndHandlers=[],this.viewer.forceRedraw(),e.onComplete&&e.onComplete()}enableDebug(){this.debugMode=!0,console.log("🔍 CinematicZoomManager debug mode enabled")}getDiagnostics(){const t=[{name:"centerX",spring:this.viewer.viewport.centerSpringX},{name:"centerY",spring:this.viewer.viewport.centerSpringY},{name:"zoom",spring:this.viewer.viewport.zoomSpring}];return{isAnimating:this.isAnimating,currentZoom:this.viewer.viewport.getZoom(),springs:t.map(({name:e,spring:r})=>({name:e,current:r.current.value,target:r.target.value,velocity:Math.abs(r.current.value-r.target.value),animationTime:r.animationTime,stiffness:r.springStiffness}))}}}class Ie{constructor(t){this.viewer=t,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const t=performance.now();return this.cacheEnabled&&this.cachedViewport&&t-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const t=performance.now(),e=this.viewer.viewport,r=e.getBounds(),o=e.viewportToImageCoordinates(r.getTopLeft()),s=e.viewportToImageCoordinates(r.getBottomRight()),d=s.x-o.x,m=s.y-o.y,f=d*this.viewportPadding,g=m*this.viewportPadding,v=this.viewer.world.getItemAt(0),i=v?v.getContentSize():{x:1,y:1},a={bounds:{minX:Math.max(0,o.x-f),minY:Math.max(0,o.y-g),maxX:Math.min(i.x,s.x+f),maxY:Math.min(i.y,s.y+g)},zoom:e.getZoom(!0),center:e.getCenter(!0),rotation:e.getRotation(),containerSize:e.getContainerSize(),imageBounds:{minX:o.x,minY:o.y,maxX:s.x,maxY:s.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=a,this.lastUpdate=performance.now();const c=this.lastUpdate-t;return this.metrics.lastUpdateDuration=c,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+c)/this.metrics.totalUpdates,a}isPointInViewport(t,e,r=!1){const o=this.getCurrentViewport(),s=r?o.bounds:o.imageBounds;return t>=s.minX&&t<=s.maxX&&e>=s.minY&&e<=s.maxY}isBoxInViewport(t,e,r,o,s=!0){const d=this.getCurrentViewport(),m=s?d.bounds:d.imageBounds;return!(r<m.minX||t>m.maxX||o<m.minY||e>m.maxY)}imageToPixel(t,e){const r=this.viewer.viewport.imageToViewportCoordinates(new z.Point(t,e));return this.viewer.viewport.pixelFromPoint(r)}pixelToImage(t,e){const r=this.viewer.viewport.pointFromPixel(new z.Point(t,e));return this.viewer.viewport.viewportToImageCoordinates(r)}calculatePixelRatio(){const t=this.viewer.viewport,e=t.getContainerSize(),r=t.getBounds(),o=this.viewer.world.getItemAt(0);if(!o)return 1;const s=o.getContentSize(),d=r.width*s.x;return e.x/d}getLevelOfDetail(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getMaxZoom(),r=t/e;return r<.1?0:r<.3?1:r<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const t=this.getCurrentViewport(),e=this.viewer.world.getItemAt(0);if(!e)return 1;const r=e.getContentSize(),o=(t.imageBounds.maxX-t.imageBounds.minX)*(t.imageBounds.maxY-t.imageBounds.minY),s=r.x*r.y;return o/s}getMetrics(){const t=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:t.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const t=this.getCurrentViewport();return{x:t.imageBounds.minX,y:t.imageBounds.minY,width:t.imageBounds.maxX-t.imageBounds.minX,height:t.imageBounds.maxY-t.imageBounds.minY}}setCacheEnabled(t){this.cacheEnabled=t,t||(this.cachedViewport=null)}setCacheTimeout(t){this.cacheTimeout=Math.max(0,t)}setViewportPadding(t){this.viewportPadding=Math.max(0,Math.min(1,t))}destroy(){this.viewer=null,this.cachedViewport=null}}const w={qualityPreservation:{minVisibleAreaDesktop:600,minVisibleAreaMobile:400,maxZoomForQuality:15,adaptivePaddingEnabled:!0},viewer:{imageLoaderLimit:2,maxImageCacheCount:100,minPixelRatio:.8,minZoomImageRatio:.8,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:.8,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:null,animationTime:.2,springStiffness:8,blendTime:.5,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.1,zoomPerClick:1.5,minZoomLevel:.8,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:1.5,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:2,tileRetryMax:1,tileRetryDelay:50,minimumPixelsPerTile:24,artifactElimination:{enableTileCascadePrevention:!0,enableBlendingOptimization:!0,enableMouseWheelSmoothing:!0,enableProgressiveQuality:!0},compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},tiles:{tileSize:1024,overlap:2,jpegQuality:85,format:"jpeg",enableWebP:!1},hotspots:{batchSize:20,visibilityCheckInterval:150,renderDebounceTime:16,fadeInDuration:0,preloadPadding:.1,maxVisibleHotspots:20,minZoomForHotspots:4,animationBatchSize:10,animationFrameBudget:12,maxConcurrentAnimations:8},audio:{preloadCount:5,crossfadeDuration:150,bufferSize:5,html5PoolSize:5,autoUnlock:!0},viewport:{cacheEnabled:!0,cacheTimeout:8,updateDebounce:4,preloadPadding:.15},memory:{maxCachedImages:250,maxCachedAudio:8,gcInterval:2e4,lowMemoryThreshold:80,criticalMemoryThreshold:150},network:{maxConcurrentRequests:4,retryAttempts:1,retryDelay:50,timeout:45e3,useCDN:!0},mobile:{reduceQuality:!1,maxZoomLevel:20,touchSensitivity:1,doubleTapDelay:250,maxImageCacheCount:20,imageLoaderLimit:2,animationTime:.8,springStiffness:10,immediateRender:!0,blendTime:.1,maxTilesPerFrame:2,minPixelRatio:1,minZoomImageRatio:.9,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,debugMode:!1,preserveImageSizeOnResize:!0,maxZoomPixelRatio:1,constrainDuringPan:!0,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:150,flickMomentum:.05,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}},renderOptimization:{enableAdaptiveRendering:!0,animationEndDelay:25,pixelPerfectDelay:15,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:50,useWebGL:!1,forceIntegerPositions:!0,zoomOptimizations:{reduceBlendTime:!0,targetBlendTime:0,increaseStiffness:!0,targetStiffness:18,forceImmediateRender:!0,disableSmoothing:!0,reduceTilesPerFrame:!0,targetTilesPerFrame:2}},debug:{showFPS:!1,showMetrics:!0,logPerformance:!1,warnThreshold:{fps:45,renderTime:20,visibleHotspots:100}}},Oe=()=>{var e;const l=navigator.userAgent.toLowerCase(),t=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(l),isChrome:/chrome|crios/i.test(l)&&!/edge|edg/i.test(l),isFirefox:/firefox|fxios/i.test(l),isEdge:/edge|edg/i.test(l),isIOS:/ipad|iphone|ipod/.test(l)||t==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(l),isMac:/mac/.test(t),isWindows:/win/.test(t),isMobile:/android|iphone|ipad|ipod/i.test(l)||t==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(l)||t==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((e=navigator.connection)==null?void 0:e.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},ze=()=>{const l=Oe();return(l.isSafari||l.isIOS)&&(w.viewer.drawer="canvas",l.isSafari&&!l.isIOS&&(w.viewer.imageLoaderLimit=l.isHighEndDevice?4:2,w.viewer.maxImageCacheCount=100,w.viewer.maxTilesPerFrame=3,w.viewer.animationTime=1,w.viewer.springStiffness=7,w.viewer.blendTime=0,w.viewer.minPixelRatio=.5,w.viewer.immediateRender=!0),l.isIOS&&(w.viewer.imageLoaderLimit=1,w.viewer.maxImageCacheCount=50,w.viewer.maxTilesPerFrame=1,w.viewer.animationTime=.8,w.viewer.springStiffness=8,w.viewer.blendTime=0,w.viewer.minPixelRatio=.8,w.viewer.immediateRender=!0,w.viewer.alwaysBlend=!1,w.viewer.gestureSettingsTouch={flickEnabled:!0,flickMinSpeed:120,flickMomentum:.35,pinchRotate:!1}),w.viewer.imageSmoothingEnabled=!1,w.viewer.smoothTileEdgesMinZoom=1/0,w.viewer.updatePixelDensityRatio=!1,w.viewer.placeholderFillStyle=null,w.viewer.opacity=1,w.viewer.preload=!1,w.viewer.compositeOperation=null,w.viewer.subPixelRoundingForTransparency="NEVER",console.log("Safari detected - applied research-based 50-60 FPS optimizations",{platform:l.isIOS?"iOS":"Desktop",imageLoaderLimit:w.viewer.imageLoaderLimit,blendTime:w.viewer.blendTime})),l.isAndroid&&(w.viewer.drawer="canvas",w.viewer.imageSmoothingEnabled=!1,console.log("Android detected - applying STEP 4 optimizations")),l.isMobile&&(Object.assign(w.viewer,{drawer:"canvas",imageLoaderLimit:1,maxImageCacheCount:w.mobile.maxImageCacheCount,animationTime:.2,springStiffness:10,immediateRender:!0,blendTime:0,smoothImageZoom:!1,maxTilesPerFrame:1,visibilityRatio:1,minPixelRatio:1,minZoomImageRatio:.9,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,preserveImageSizeOnResize:!0,maxZoomPixelRatio:1,imageSmoothingEnabled:!1,updatePixelDensityRatio:!1,constrainDuringPan:!0,subPixelRendering:!1,minimumPixelsPerTile:40,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:150,flickMomentum:.05,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),w.hotspots.batchSize=15,w.hotspots.maxVisibleHotspots=15,w.hotspots.renderDebounceTime=8,w.memory.maxCachedImages=30,console.log("Mobile device detected - applied STEP 4 ultra-aggressive optimizations")),l.isLowEndDevice&&(w.viewer.animationTime=.15,w.viewer.springStiffness=18,w.viewer.maxImageCacheCount=Math.min(100,w.viewer.maxImageCacheCount),w.viewer.imageLoaderLimit=1,w.viewer.maxTilesPerFrame=1,w.memory.maxCachedImages=100,w.network.maxConcurrentRequests=2,w.hotspots.maxVisibleHotspots=30,w.viewer.minPixelRatio=.8,console.log("Low-end device detected - applied STEP 4 ultra-conservative settings")),l.isHighEndDevice&&!l.isMobile&&(w.viewer.maxImageCacheCount=600,w.viewer.imageLoaderLimit=6,w.viewer.maxTilesPerFrame=4,w.memory.maxCachedImages=400,w.network.maxConcurrentRequests=6,w.viewer.minPixelRatio=.4,w.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - applied STEP 4 balanced performance/quality")),l.isHighDPI&&!l.isMobile&&(w.viewer.minPixelRatio=Math.min(.5,w.viewer.minPixelRatio),w.viewer.maxZoomPixelRatio=Math.max(4,l.pixelRatio*2)),(l.connectionType==="slow-2g"||l.connectionType==="2g")&&(w.viewer.imageLoaderLimit=1,w.network.maxConcurrentRequests=1,w.viewer.timeout=9e4,console.log("Slow connection detected - applied STEP 4 minimal network usage")),l},X=ze();function Ze(l,t){const e=w,r=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent),o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),s=o&&!r;let d,m,f;if(s?(d=8,m=12,f=20):r?(d=10,m=15,f=25):(d=20,m=25,f=35),l<d&&l>0)return o?(e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=25,e.viewer.minPixelRatio=1.2,e.viewer.immediateRender=!0,e.viewer.animationTime=.5,e.viewer.springStiffness=10):(e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.animationTime=.1,e.viewer.springStiffness=20,e.viewer.immediateRender=!0,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=25,e.viewer.minPixelRatio=1),console.error("SAFARI FIX: Emergency performance mode activated"),"ultra-emergency";if(l<m&&l>0)return e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.animationTime=.4,e.viewer.springStiffness=12,e.viewer.immediateRender=!0,e.viewer.blendTime=.05,e.viewer.maxImageCacheCount=60,e.viewer.minPixelRatio=.8,console.warn("Critical performance mode activated"),"critical";if(l<f&&l>0)return e.viewer.imageLoaderLimit=Math.max(1,e.viewer.imageLoaderLimit-1),e.viewer.maxTilesPerFrame=Math.max(1,e.viewer.maxTilesPerFrame-1),e.viewer.animationTime=.25,e.viewer.springStiffness=12,"reduced";if(l>55){const g=X.isHighEndDevice?6:X.isMobile?1:4;return e.viewer.imageLoaderLimit<g&&(e.viewer.imageLoaderLimit=Math.min(g,e.viewer.imageLoaderLimit+1)),e.viewer.maxTilesPerFrame<3&&(e.viewer.maxTilesPerFrame=Math.min(3,e.viewer.maxTilesPerFrame+1)),e.viewer.animationTime=X.isMobile?.2:.3,e.viewer.springStiffness=X.isMobile?15:12,e.viewer.minPixelRatio=X.isMobile?.8:.5,"normal"}return t>e.memory.criticalMemoryThreshold?(e.viewer.maxImageCacheCount=Math.max(25,Math.floor(e.viewer.maxImageCacheCount*.4)),e.hotspots.maxVisibleHotspots=Math.max(10,Math.floor(e.hotspots.maxVisibleHotspots*.5)),console.warn(`STEP 4: High memory usage: ${t}MB - Applied aggressive reduction`),"memory-limited"):"normal"}const Le=(l,t,e,r,o=null)=>(r&&(l.animationTime=.2,l.springStiffness=8,l.blendTime=0,l.immediateRender=!0,l.imageLoaderLimit=2,l.maxImageCacheCount=50,l.visibilityRatio=.8,l.maxTilesPerFrame=2,l.alwaysBlend=!1,l.constrainDuringPan=!0,l.maxZoomPixelRatio=1.5,l.imageSmoothingEnabled=!1,l.updatePixelDensityRatio=!1,l.subPixelRendering=!1,l.minimumPixelsPerTile=32,console.log("Applied research-based mobile optimizations for zoom performance")),{tileSources:o||t,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:e,imageSmoothingEnabled:l.imageSmoothingEnabled,smoothTileEdgesMinZoom:l.smoothTileEdgesMinZoom,alwaysBlend:l.alwaysBlend,placeholderFillStyle:l.placeholderFillStyle,opacity:1,preload:l.preload,compositeOperation:l.compositeOperation,...l.drawer==="webgl"?{webglOptions:l.webglOptions}:{},immediateRender:l.immediateRender,imageLoaderLimit:l.imageLoaderLimit,maxImageCacheCount:l.maxImageCacheCount,timeout:l.timeout,loadTilesWithAjax:l.loadTilesWithAjax,ajaxHeaders:l.ajaxHeaders,visibilityRatio:l.visibilityRatio,minPixelRatio:l.minPixelRatio,defaultZoomLevel:l.defaultZoomLevel,minZoomLevel:l.minZoomLevel,maxZoomPixelRatio:l.maxZoomPixelRatio,constrainDuringPan:l.constrainDuringPan,wrapHorizontal:l.wrapHorizontal,wrapVertical:l.wrapVertical,animationTime:l.animationTime,springStiffness:l.springStiffness,blendTime:l.blendTime,zoomPerScroll:r?1.2:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:l.flickEnabled,flickMinSpeed:l.flickMinSpeed,flickMomentum:l.flickMomentum,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:l.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:l.preserveImageSizeOnResize,maxTilesPerFrame:l.maxTilesPerFrame,smoothImageZoom:l.smoothImageZoom,subPixelRendering:l.subPixelRendering!==void 0?l.subPixelRendering:!1,minimumPixelsPerTile:l.minimumPixelsPerTile||(r?32:24),updatePixelDensityRatio:l.updatePixelDensityRatio!==void 0?l.updatePixelDensityRatio:!1,smoothTileEdgesMinZoom:r?1/0:l.smoothTileEdgesMinZoom,imageSmoothingEnabled:l.imageSmoothingEnabled!==void 0?l.imageSmoothingEnabled:!r});let E=null;async function ke(){if(E)return E;try{return E=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${E.length} hotspots`),E}catch(l){return console.error("Failed to load hotspots:",l),E=[],E}}function ie(l){if(l){if(console.log("Forcing viewer state reset to fix flickering..."),l.world){const t=l.world.getItemCount();for(let e=0;e<t;e++){const r=l.world.getItemAt(e);r&&r.reset()}}l.viewport.centerSpringX.resetTo(l.viewport.centerSpringX.target.value),l.viewport.centerSpringY.resetTo(l.viewport.centerSpringY.target.value),l.viewport.zoomSpring.resetTo(l.viewport.zoomSpring.target.value),l.viewport.applyConstraints(!0),l.forceRedraw(),setTimeout(()=>l.forceRedraw(),50),setTimeout(()=>l.forceRedraw(),100),console.log("Viewer state reset completed")}}async function Ee(l,t,e,r){var C,A,T,L,k,R,Z,O;console.log("initializeViewer called with:",{viewerRef:l,props:t,state:!!e,handleHotspotClick:!!r});const o={};let s=null;const d=w.viewer,m=`/images/tiles/${t.artworkId}_1024/${t.artworkId}.dzi`,f={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${t.artworkId}_1024/${t.artworkId}_files/`,Format:"jpg",Overlap:"2",TileSize:"1024",Size:{Width:"11244",Height:"6543"}},minLevel:8,maxLevel:14},g=oe(),v=se(),i=Le(d,f,v,g,f);console.log("[viewerSetup] Creating viewer WITHOUT tileSources to ensure handlers attach first");const n=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),a=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;i.drawer="canvas",i.smoothTileEdgesMinZoom=1/0,i.immediateRender=!0,i.imageSmoothingEnabled=!0,i.updatePixelDensityRatio=!1,i.subPixelRendering=!1,i.blendTime=.5,i.alwaysBlend=!1,console.log("BALANCED: Canvas drawer with optimized smoothing management"),console.log("RESEARCH VERIFICATION: Creating viewer with settings:",{drawer:i.drawer,imageLoaderLimit:i.imageLoaderLimit,maxTilesPerFrame:i.maxTilesPerFrame,immediateRender:i.immediateRender,animationTime:i.animationTime,springStiffness:i.springStiffness,isMobile:g}),console.log("Creating OpenSeadragon viewer with config:",i);const c=z({element:l,...i,updatePixelDensityRatio:!1,drawer:g||n||a?"canvas":i.drawer});console.log("Applying TileCascadeFix for stable tile rendering..."),U(z),await new Promise(b=>setTimeout(b,50));const p={setIsLoading:b=>{console.log(`[viewerSetup] Calling setIsLoading(${b})`),e.setIsLoading(b)},setViewerReady:b=>{console.log(`[viewerSetup] Calling setViewerReady(${b})`),e.setViewerReady(b)}};console.log("[viewerSetup] Current state before open handler:",{isLoading:e.isLoading(),viewerReady:e.viewerReady()}),c.addHandler("open",()=>{console.log("[viewerSetup] OpenSeadragon open event fired!"),console.log("[viewerSetup] Current loading state in handler:",e.isLoading());try{const b=c.world.getItemAt(0);if(b){const M=b.getBounds();s=c.viewport.getHomeBounds(),console.log("[viewerSetup] Home viewport stored:",s),console.log("[viewerSetup] About to set isLoading to false"),b.getFullyLoaded()?(console.log("[viewerSetup] Tiles fully loaded - hiding loading screen immediately"),p.setIsLoading(!1),p.setViewerReady(!0)):(console.log("[viewerSetup] Waiting for tiles to fully load..."),b.addOnceHandler("fully-loaded-change",()=>{console.log("[viewerSetup] Tiles now fully loaded - hiding loading screen"),p.setIsLoading(!1),p.setViewerReady(!0)}),setTimeout(()=>{e.isLoading()&&(console.warn("[viewerSetup] Forcing loading screen hide after 2s wait"),p.setIsLoading(!1),p.setViewerReady(!0))},2e3))}else console.error("[viewerSetup] No tiled image found!"),p.setIsLoading(!1),p.setViewerReady(!0)}catch(b){console.error("[viewerSetup] Error in open handler:",b),p.setIsLoading(!1),p.setViewerReady(!0)}}),c.addHandler("open-failed",b=>{console.error("OpenSeadragon open-failed event:",b),e.setIsLoading(!1)}),c.addHandler("tile-load-failed",b=>{console.error("Tile load failed:",b.tile,b.message)}),c.drawer&&(c.drawer.imageSmoothingEnabled=!0,c.drawer.context&&(c.drawer.context.imageSmoothingEnabled=!0,c.drawer.context.webkitImageSmoothingEnabled=!0,c.drawer.context.mozImageSmoothingEnabled=!0,c.drawer.context.msImageSmoothingEnabled=!0));const u={spatialIndex:new xe,viewportManager:new Ie(c),audioEngine:new ce,performanceMonitor:new fe(c),renderOptimizer:new pe(c),tileOptimizer:new Me(c),memoryManager:new he(c),tileCleanupManager:new Ae(c),imageOverlayManager:new de,overlayManager:K.createWithOverride(c),lowZoomOptimizer:new me(c,g),safariPerformanceOptimizer:new ge(c),mouseWheelSmoothing:new ue(c,(C=$().enableMouseWheelSmoothing)!=null&&C.value?{throttleMs:((A=$().wheelEventThrottleMs)==null?void 0:A.value)||16,zoomStep:((T=$().wheelZoomStep)==null?void 0:T.value)||.02,enabled:((L=$().enableMouseWheelSmoothing)==null?void 0:L.value)!==!1}:{enabled:!1})};u.tileOptimizer.state.isActive=!1,setTimeout(()=>{u.tileOptimizer.state.isActive=!0},1e3);const h=new Pe(c,u);u.cinematicZoomManager=h,window.cinematicZoomManager=h,e.debugLevel()>=1&&h.enableDebug(),e.setComponents(u),window.performanceMetrics=e.performanceMetrics,console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!u.overlayManager),console.log("Does it have initialize method?",typeof((k=u.overlayManager)==null?void 0:k.initialize)),u.overlayManager.initialize(),console.log("Overlay manager initialized"),console.log("Is initialized flag:",(R=u.overlayManager)==null?void 0:R.isInitialized),console.log("Overlay element created?",!!((Z=u.overlayManager)!=null&&Z.overlayElement));const _=K.getCurrentType();_&&_!==e.currentOverlayType()&&(console.log("Updating overlay type signal to match actual:",_),e.setCurrentOverlayType(_)),window.overlayManager=u.overlayManager,console.log("Overlay manager set on window:",(O=window.overlayManager)==null?void 0:O.constructor.name),window.audioEngine=u.audioEngine,u.audioEngine.onPlaybackEnd=b=>{console.log(`Finished playing audio for hotspot ${b}`)};const y=await ke();u.spatialIndex.loadHotspots(y),u.imageOverlayManager.loadHotspots(y),window.viewer=c,window.performanceMonitor=u.performanceMonitor,window.tileOptimizer=u.tileOptimizer,window.tileCleanupManager=u.tileCleanupManager,window.lowZoomOptimizer=u.lowZoomOptimizer,window.safariPerformanceOptimizer=u.safariPerformanceOptimizer,window.performanceConfig=w,Re(c),ae(c,w),setTimeout(()=>{var M;const b=(M=c.drawer)!=null&&M.getType?c.drawer.getType():"unknown";console.log("RESEARCH VERIFICATION: Actual drawer in use:",b),(g||n||a)&&b!=="canvas"?console.error("CRITICAL: Canvas drawer not applied! Performance will be poor."):(g||n||a)&&b==="canvas"&&console.log("SUCCESS: Canvas drawer confirmed for mobile/Safari - performance should be optimal")},100),u.performanceMonitor.start(),u.memoryManager.start(),u.tileOptimizer.start(),u.tileCleanupManager.start(),u.lowZoomOptimizer.enable();const S=setInterval(()=>{var b;if(u.performanceMonitor&&u.performanceMonitor.isMonitoring){const M=u.performanceMonitor.getMetrics();if(e.setPerformanceMetrics(M),window.nativeHotspotRenderer&&typeof window.nativeHotspotRenderer.getPerformanceMetrics=="function")try{const D=window.nativeHotspotRenderer.getPerformanceMetrics();D&&window.nativeHotspotRenderer.constructor.name==="WebGLHotspotRenderer"&&(console.log("WebGL metrics update:",D),e.setSafariHybridMetrics(D))}catch(D){console.error("Error getting WebGL metrics:",D)}else((b=window.nativeHotspotRenderer)==null?void 0:b.constructor.name)!=="WebGLHotspotRenderer"&&e.setSafariHybridMetrics(null);u.lowZoomOptimizer&&M.averageFPS>0&&u.lowZoomOptimizer.monitorPerformance(M.averageFPS),u.safariPerformanceOptimizer&&M.averageFPS>0&&u.safariPerformanceOptimizer.updatePerformanceMetrics(M.averageFPS),M.averageFPS<30&&g?console.warn(`RESEARCH: Low mobile FPS detected (${M.averageFPS}). Verify canvas drawer is active.`):M.averageFPS>=50&&console.log(`RESEARCH: Good performance achieved (${M.averageFPS} FPS)`)}},500);o.performanceUpdate=S,u.performanceMonitor.disableDebugOverlay(),c.viewport.centerSpringX.animationTime=w.viewer.animationTime,c.viewport.centerSpringY.animationTime=w.viewer.animationTime,c.viewport.zoomSpring.animationTime=w.viewer.animationTime,c.viewport.centerSpringX.springStiffness=w.viewer.springStiffness,c.viewport.centerSpringY.springStiffness=w.viewer.springStiffness,c.viewport.zoomSpring.springStiffness=w.viewer.springStiffness;const x=await le(()=>import("./viewerEventHandlers-BgdH7enW.js"),__vite__mapDeps([0,1,2]));x.setupViewerEventHandlers(c,e,u,r,y),x.setupAdaptiveSprings(c,w);const P=x.setupKeyboardHandler(c,e,u);return o.handleKeyPress=P,x.setupResizeObserver(l,c,e),console.log("[viewerSetup] All handlers attached, now opening viewer with tileSources:",m),c.open(m),setTimeout(()=>{console.log("[viewerSetup] Forcing initial redraw to ensure clean state"),c.forceRedraw(),c.viewport.centerSpringX.resetTo(c.viewport.centerSpringX.target.value),c.viewport.centerSpringY.resetTo(c.viewport.centerSpringY.target.value),c.viewport.zoomSpring.resetTo(c.viewport.zoomSpring.target.value),c.forceRedraw()},500),setTimeout(()=>{console.log("[viewerSetup] Applying complete state reset to ensure no flickering"),ie(c)},1e3),console.log("Returning from initializeViewer:",{viewer:!!c,intervals:!!o,homeViewport:!!s}),{viewer:c,intervals:o,homeViewport:s}}function Re(l){window.forceSmoothingOn=function(){if(console.log("✅ FORCING SMOOTHING ON"),l&&l.drawer){if(l.drawer.imageSmoothingEnabled=!0,l.drawer.context){const t=l.drawer.context;t.imageSmoothingEnabled=!0,t.webkitImageSmoothingEnabled=!0,t.mozImageSmoothingEnabled=!0,t.msImageSmoothingEnabled=!0,console.log("✅ Canvas context smoothing enabled")}l.canvas&&(l.canvas.style.imageRendering="auto",console.log("✅ CSS rendering set to auto")),l.forceRedraw(),console.log("✅ Forced redraw with smoothing enabled"),l.drawer.context&&console.log("Current imageSmoothingEnabled:",l.drawer.context.imageSmoothingEnabled)}else console.error("❌ Viewer or drawer not available")},window.checkSmoothingState=function(){console.group("🧪 SMOOTHING STATE DIAGNOSTIC"),l&&l.drawer?(console.log("Drawer type:",l.drawer.getType?l.drawer.getType():"unknown"),console.log("Drawer imageSmoothingEnabled:",l.drawer.imageSmoothingEnabled),l.drawer.context?(console.log("Context imageSmoothingEnabled:",l.drawer.context.imageSmoothingEnabled),console.log("Context webkitImageSmoothingEnabled:",l.drawer.context.webkitImageSmoothingEnabled),console.log("Context mozImageSmoothingEnabled:",l.drawer.context.mozImageSmoothingEnabled),console.log("Context msImageSmoothingEnabled:",l.drawer.context.msImageSmoothingEnabled)):console.warn("No context available"),l.canvas&&console.log("Canvas style.imageRendering:",l.canvas.style.imageRendering),console.log(`
Configuration:`),console.log("imageSmoothingEnabled config:",l.imageSmoothingEnabled),console.log("smoothTileEdgesMinZoom:",l.smoothTileEdgesMinZoom),console.log("blendTime:",l.blendTime),console.log("alwaysBlend:",l.alwaysBlend),console.log("immediateRender:",l.immediateRender)):console.error("Viewer or drawer not available"),console.groupEnd()},window.toggleTileCascadeFix=function(t){t?(console.log("🔐 Enabling TileCascadeFix..."),U(z),console.log("✅ TileCascadeFix enabled - single tile level (may cause zoom artifacts)")):(console.log("🔓 Disabling TileCascadeFix..."),J(z),console.log("✅ TileCascadeFix disabled - smooth blending enabled")),l.forceRedraw()},window.applyBalancedSmoothingConfig=function(){console.group("🎯 APPLYING BALANCED SMOOTHING CONFIG"),console.log("1️⃣ Ensuring image smoothing is enabled..."),window.forceSmoothingOn(),console.log("2️⃣ Disabling TileCascadeFix for smooth zoom..."),window.toggleTileCascadeFix(!1),console.log("3️⃣ Checking blend time..."),l&&console.log("Current blendTime:",l.blendTime||.5),console.log("4️⃣ Verifying smoothing state..."),window.checkSmoothingState(),console.log(`
✅ BALANCED CONFIG APPLIED!`),console.log("🖼️ Smooth rendering with tile blending enabled"),console.log("🔍 Test by zooming in/out"),console.log("📊 If artifacts persist, try toggleTileCascadeFix(true)"),console.groupEnd()},window.getCinematicZoomDiagnostics=function(){return window.cinematicZoomManager?window.cinematicZoomManager.getDiagnostics():(console.error("CinematicZoomManager not initialized"),null)},window.fixFlickering=function(){console.log("Applying manual flickering fix..."),ie(l),J(z),setTimeout(()=>{U(z),l.forceRedraw(),console.log("Flickering fix applied")},100)},window.testSafariOptimizer=function(){if(!window.safariPerformanceOptimizer){console.error("SafariPerformanceOptimizer not initialized");return}const t=window.safariPerformanceOptimizer;console.group("🎯 SAFARI PERFORMANCE OPTIMIZER TEST");const e=t.getState();console.table(e),console.log(`
📊 Testing dynamic resolution scaling...`),console.log("1️⃣ Forcing optimization ON"),t.forceOptimization(!0),setTimeout(()=>{console.log("Current pixel ratio:",l.viewport.getPixelRatio()),console.log("Expected:",e.basePixelRatio*t.scalingFactor),console.log(`
2️⃣ Forcing optimization OFF`),t.forceOptimization(!1),setTimeout(()=>{console.log("Current pixel ratio:",l.viewport.getPixelRatio()),console.log("Expected:",e.basePixelRatio),console.log(`
✅ Test complete! Try zooming/panning to see dynamic scaling.`),console.groupEnd()},500)},100)},window.getSafariOptimizerState=function(){return window.safariPerformanceOptimizer?window.safariPerformanceOptimizer.getState():(console.error("SafariPerformanceOptimizer not initialized"),null)}}const De=Object.freeze(Object.defineProperty({__proto__:null,initializeViewer:Ee},Symbol.toStringTag,{value:"Module"}));export{Ze as a,w as p,De as v};
