var Du=Object.defineProperty;var Mu=(s,t,e)=>t in s?Du(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var eo=(s,t,e)=>Mu(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const ku=!1,Ou=(s,t)=>s===t,Fu=Symbol("solid-track"),us={equals:Ou};let xc=Pc;const $i=1,ds=2,Ec={owned:null,cleanups:null,context:null,owner:null};var yt=null;let to=null,Lu=null,pt=null,Ht=null,Di=null,Ds=0;function ns(s,t){const e=pt,i=yt,n=s.length===0,r=t===void 0?i:t,o=n?Ec:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>Mi(()=>yr(o)));yt=o,pt=null;try{return Rr(a,!0)}finally{pt=e,yt=i}}function de(s,t){t=t?Object.assign({},us,t):us;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),Sc(e,n));return[bc.bind(e),i]}function Je(s,t,e){const i=No(s,t,!1,$i);Ar(i)}function hn(s,t,e){xc=zu;const i=No(s,t,!1,$i);i.user=!0,Di?Di.push(i):Ar(i)}function dr(s,t,e){e=e?Object.assign({},us,e):us;const i=No(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,Ar(i),bc.bind(i)}function Mi(s){if(pt===null)return s();const t=pt;pt=null;try{return s()}finally{pt=t}}function Ho(s){hn(()=>Mi(s))}function Ln(s){return yt===null||(yt.cleanups===null?yt.cleanups=[s]:yt.cleanups.push(s)),s}function bc(){if(this.sources&&this.state)if(this.state===$i)Ar(this);else{const s=Ht;Ht=null,Rr(()=>ps(this),!1),Ht=s}if(pt){const s=this.observers?this.observers.length:0;pt.sources?(pt.sources.push(this),pt.sourceSlots.push(s)):(pt.sources=[this],pt.sourceSlots=[s]),this.observers?(this.observers.push(pt),this.observerSlots.push(pt.sources.length-1)):(this.observers=[pt],this.observerSlots=[pt.sources.length-1])}return this.value}function Sc(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&Rr(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=to&&to.running;o&&to.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?Ht.push(r):Di.push(r),r.observers&&Cc(r)),o||(r.state=$i)}if(Ht.length>1e6)throw Ht=[],new Error},!1)),t}function Ar(s){if(!s.fn)return;yr(s);const t=Ds;Vu(s,s.value,t)}function Vu(s,t,e){let i;const n=yt,r=pt;pt=yt=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=$i,s.owned&&s.owned.forEach(yr),s.owned=null),s.updatedAt=e+1,Ac(o)}finally{pt=r,yt=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?Sc(s,i):s.value=i,s.updatedAt=e)}function No(s,t,e,i=$i,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:yt,context:yt?yt.context:null,pure:e};return yt===null||yt!==Ec&&(yt.owned?yt.owned.push(r):yt.owned=[r]),r}function fs(s){if(s.state===0)return;if(s.state===ds)return ps(s);if(s.suspense&&Mi(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<Ds);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===$i)Ar(s);else if(s.state===ds){const i=Ht;Ht=null,Rr(()=>ps(s,t[0]),!1),Ht=i}}function Rr(s,t){if(Ht)return s();let e=!1;t||(Ht=[]),Di?e=!0:Di=[],Ds++;try{const i=s();return Bu(e),i}catch(i){e||(Di=null),Ht=null,Ac(i)}}function Bu(s){if(Ht&&(Pc(Ht),Ht=null),s)return;const t=Di;Di=null,t.length&&Rr(()=>xc(t),!1)}function Pc(s){for(let t=0;t<s.length;t++)fs(s[t])}function zu(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:fs(i)}for(t=0;t<e;t++)fs(s[t])}function ps(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===$i?i!==t&&(!i.updatedAt||i.updatedAt<Ds)&&fs(i):n===ds&&ps(i,t)}}}function Cc(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=ds,e.pure?Ht.push(e):Di.push(e),e.observers&&Cc(e))}}function yr(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)yr(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)yr(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function Hu(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function Ac(s,t=yt){throw Hu(s)}const Nu=Symbol("fallback");function Ja(s){for(let t=0;t<s.length;t++)s[t]()}function Uu(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return Ln(()=>Ja(r)),()=>{let c=s()||[],h=c.length,d,l;return c[Fu],Mi(()=>{let p,g,v,w,E,I,L,N,Z;if(h===0)o!==0&&(Ja(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[Nu],n[0]=ns(J=>(r[0]=J,e.fallback())),o=1);else if(o===0){for(n=new Array(h),l=0;l<h;l++)i[l]=c[l],n[l]=ns(f);o=h}else{for(v=new Array(h),w=new Array(h),a&&(E=new Array(h)),I=0,L=Math.min(o,h);I<L&&i[I]===c[I];I++);for(L=o-1,N=h-1;L>=I&&N>=I&&i[L]===c[N];L--,N--)v[N]=n[L],w[N]=r[L],a&&(E[N]=a[L]);for(p=new Map,g=new Array(N+1),l=N;l>=I;l--)Z=c[l],d=p.get(Z),g[l]=d===void 0?-1:d,p.set(Z,l);for(d=I;d<=L;d++)Z=i[d],l=p.get(Z),l!==void 0&&l!==-1?(v[l]=n[d],w[l]=r[d],a&&(E[l]=a[d]),l=g[l],p.set(Z,l)):r[d]();for(l=I;l<h;l++)l in v?(n[l]=v[l],r[l]=w[l],a&&(a[l]=E[l],a[l](l))):n[l]=ns(f);n=n.slice(0,o=h),i=c.slice(0)}return n});function f(p){if(r[l]=p,a){const[g,v]=de(l);return a[l]=v,t(c[l],g)}return t(c[l])}}}function _e(s,t){return Mi(()=>s(t||{}))}const ju=s=>`Stale read from <${s}>.`;function Wu(s){const t="fallback"in s&&{fallback:()=>s.fallback};return dr(Uu(()=>s.each,s.children,t||void 0))}function Ue(s){const t=s.keyed,e=dr(()=>s.when,void 0,void 0),i=t?e:dr(e,void 0,{equals:(n,r)=>!n==!r});return dr(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?Mi(()=>r(t?n:()=>{if(!Mi(i))throw ju("Show");return e()})):r}return s.fallback},void 0,void 0)}const Pt=s=>dr(()=>s());function qu(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,c=t[n-1].nextSibling,h=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const d=r<i?a?e[a-1].nextSibling:e[r-a]:c;for(;a<r;)s.insertBefore(e[a++],d)}else if(r===a)for(;o<n;)(!h||!h.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const d=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],d),t[n]=e[r]}else{if(!h){h=new Map;let l=a;for(;l<r;)h.set(e[l],l++)}const d=h.get(t[o]);if(d!=null)if(a<d&&d<r){let l=o,f=1,p;for(;++l<n&&l<r&&!((p=h.get(t[l]))==null||p!==d+f);)f++;if(f>d-a){const g=t[o];for(;a<d;)s.insertBefore(e[a++],g)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const $a="_$DX_DELEGATE";function Gu(s,t,e,i={}){let n;return ns(r=>{n=r,t===document?s():re(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function ee(s,t,e,i){let n;const r=()=>{const a=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return a.innerHTML=s,e?a.content.firstChild.firstChild:i?a.firstChild:a.content.firstChild},o=t?()=>Mi(()=>document.importNode(n||(n=r()),!0)):()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function jn(s,t=window.document){const e=t[$a]||(t[$a]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,Xu))}}function Gt(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function Mn(s,t){t==null?s.removeAttribute("class"):s.className=t}function Rc(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function rs(s,t,e){if(!t)return e?Gt(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function Zu(s,t,e){return Mi(()=>s(t,e))}function re(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return ms(s,t,i,e);Je(n=>ms(s,t(),n,e),i)}function Xu(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=c=>Object.defineProperty(s,"target",{configurable:!0,value:c}),o=()=>{const c=t[e];if(c&&!t.disabled){const h=t[`${e}Data`];if(h!==void 0?c.call(t,h,s):c.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const c=s.composedPath();r(c[0]);for(let h=0;h<c.length-2&&(t=c[h],!!o());h++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function ms(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=En(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=En(s,e,i);else{if(r==="function")return Je(()=>{let a=t();for(;typeof a=="function";)a=a();e=ms(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],c=e&&Array.isArray(e);if(mo(a,t,e,n))return Je(()=>e=ms(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=En(s,e,i),o)return e}else c?e.length===0?el(s,a,i):qu(s,e,a):(e&&En(s),el(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=En(s,e,i,t);En(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function mo(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],c=e&&e[s.length],h;if(!(a==null||a===!0||a===!1))if((h=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=mo(s,a,c)||n;else if(h==="function")if(i){for(;typeof a=="function";)a=a();n=mo(s,Array.isArray(a)?a:[a],Array.isArray(c)?c:[c])||n}else s.push(a),n=!0;else{const d=String(a);c&&c.nodeType===3&&c.data===d?s.push(c):s.push(document.createTextNode(d))}}return n}function el(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function En(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const c=a.parentNode===s;!r&&!o?c?s.replaceChild(n,a):s.insertBefore(n,e):c&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}var Pn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Yu(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Ic={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var c in o)a=c;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,c=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/c}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var c,h,d,l,f,p,g=arguments[0]||{},v=arguments.length,w=!1,E=1;for(typeof g=="boolean"&&(w=g,g=arguments[1]||{},E=2),typeof g!="object"&&!t.isFunction(g)&&(g={}),v===E&&(g=this,--E);E<v;E++)if(c=arguments[E],c!==null||c!==void 0)for(h in c){var I=Object.getOwnPropertyDescriptor(c,h);if(I!==void 0){if(I.get||I.set){Object.defineProperty(g,h,I);continue}l=I.value}else{e.console.warn('Could not copy inherited property "'+h+'".');continue}g!==l&&(w&&l&&(t.isPlainObject(l)||(f=t.isArray(l)))?(d=g[h],f?(f=!1,p=d&&t.isArray(d)?d:[]):p=d&&t.isPlainObject(d)?d:{},g[h]=t.extend(w,p,l)):l!==void 0&&(g[h]=l))}return g};var i=function(){if(typeof navigator!="object")return!1;var c=navigator.userAgent;return typeof c!="string"?!1:c.indexOf("iPhone")!==-1||c.indexOf("iPad")!==-1||c.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(c,h){return function(){var d=arguments;return d===void 0&&(d=[]),h.apply(c,d)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(c){return e._viewers.get(this.getElement(c))},getElement:function(c){return typeof c=="string"&&(c=document.getElementById(c)),c},getElementPosition:function(c){var h=new e.Point,d,l;for(c=e.getElement(c),d=e.getElementStyle(c).position==="fixed",l=a(c,d);l;)h.x+=c.offsetLeft,h.y+=c.offsetTop,d&&(h=h.plus(e.getPageScroll())),c=l,d=e.getElementStyle(c).position==="fixed",l=a(c,d);return h},getElementOffset:function(c){c=e.getElement(c);var h=c&&c.ownerDocument,d,l,f={top:0,left:0};return h?(d=h.documentElement,typeof c.getBoundingClientRect<"u"&&(f=c.getBoundingClientRect()),l=h===h.window?h:h.nodeType===9?h.defaultView||h.parentWindow:!1,new e.Point(f.left+(l.pageXOffset||d.scrollLeft)-(d.clientLeft||0),f.top+(l.pageYOffset||d.scrollTop)-(d.clientTop||0))):new e.Point},getElementSize:function(c){return c=e.getElement(c),new e.Point(c.clientWidth,c.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(c){return c=e.getElement(c),c.currentStyle}:function(c){return c=e.getElement(c),window.getComputedStyle(c,"")},getCssPropertyWithVendorPrefix:function(c){var h={};return e.getCssPropertyWithVendorPrefix=function(d){if(h[d]!==void 0)return h[d];var l=document.createElement("div").style,f=null;if(l[d]!==void 0)f=d;else for(var p=["Webkit","Moz","MS","O","webkit","moz","ms","o"],g=e.capitalizeFirstLetter(d),v=0;v<p.length;v++){var w=p[v]+g;if(l[w]!==void 0){f=w;break}}return h[d]=f,f},e.getCssPropertyWithVendorPrefix(c)},capitalizeFirstLetter:function(c){return c.charAt(0).toUpperCase()+c.slice(1)},positiveModulo:function(c,h){var d=c%h;return d<0&&(d+=h),d},pointInElement:function(c,h){c=e.getElement(c);var d=e.getElementOffset(c),l=e.getElementSize(c);return h.x>=d.x&&h.x<d.x+l.x&&h.y<d.y+l.y&&h.y>=d.y},getMousePosition:function(c){if(typeof c.pageX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.pageX,d.y=h.pageY,d};else if(typeof c.clientX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d.y=h.clientY+document.body.scrollTop+document.documentElement.scrollTop,d};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(c)},getPageScroll:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(h.scrollLeft||h.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(c.scrollLeft||c.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(c){if(typeof window.scrollTo<"u")e.setPageScroll=function(l){window.scrollTo(l.x,l.y)};else{var h=e.getPageScroll();if(h.x===c.x&&h.y===c.y)return;document.body.scrollLeft=c.x,document.body.scrollTop=c.y;var d=e.getPageScroll();if(d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.body.scrollLeft=l.x,document.body.scrollTop=l.y};return}if(document.documentElement.scrollLeft=c.x,document.documentElement.scrollTop=c.y,d=e.getPageScroll(),d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y};return}e.setPageScroll=function(l){}}e.setPageScroll(c)},getWindowSize:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(c.clientWidth||c.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(h.clientWidth||h.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(c){c=e.getElement(c);var h=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(h[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(h[1].style,{display:"table-row"}),e.extend(h[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),h[0].appendChild(h[1]),h[1].appendChild(h[2]),h[2].appendChild(c),h[0]},makeNeutralElement:function(c){var h=document.createElement(c),d=h.style;return d.background="transparent none",d.border="none",d.margin="0px",d.padding="0px",d.position="static",h},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(c){var h=e.makeNeutralElement("img");return h.src=c,h},setElementOpacity:function(c,h,d){var l,f;c=e.getElement(c),d&&!e.Browser.alpha&&(h=Math.round(h)),e.Browser.opacity?c.style.opacity=h<1?h:"":h<1?(l=Math.round(100*h),f="alpha(opacity="+l+")",c.style.filter=f):c.style.filter=""},setElementTouchActionNone:function(c){c=e.getElement(c),typeof c.style.touchAction<"u"?c.style.touchAction="none":typeof c.style.msTouchAction<"u"&&(c.style.msTouchAction="none")},setElementPointerEvents:function(c,h){c=e.getElement(c),typeof c.style<"u"&&typeof c.style.pointerEvents<"u"&&(c.style.pointerEvents=h)},setElementPointerEventsNone:function(c){e.setElementPointerEvents(c,"none")},addClass:function(c,h){c=e.getElement(c),c.className?(" "+c.className+" ").indexOf(" "+h+" ")===-1&&(c.className+=" "+h):c.className=h},indexOf:function(c,h,d){return Array.prototype.indexOf?this.indexOf=function(l,f,p){return l.indexOf(f,p)}:this.indexOf=function(l,f,p){var g,v=p||0,w;if(!l)throw new TypeError;if(w=l.length,w===0||v>=w)return-1;for(v<0&&(v=w-Math.abs(v)),g=v;g<w;g++)if(l[g]===f)return g;return-1},this.indexOf(c,h,d)},removeClass:function(c,h){var d,l=[],f;for(c=e.getElement(c),d=c.className.split(/\s+/),f=0;f<d.length;f++)d[f]&&d[f]!==h&&l.push(d[f]);c.className=l.join(" ")},normalizeEventListenerOptions:function(c){var h;return typeof c<"u"?typeof c=="boolean"?h=e.supportsEventListenerOptions?{capture:c}:c:h=e.supportsEventListenerOptions?c:typeof c.capture<"u"?c.capture:!1:h=e.supportsEventListenerOptions?{capture:!1}:!1,h},addEvent:function(){if(e.supportsAddEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.addEventListener(h,d,l)};if(document.documentElement.attachEvent&&document.attachEvent)return function(c,h,d){c=e.getElement(c),c.attachEvent("on"+h,d)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.removeEventListener(h,d,l)};if(document.documentElement.detachEvent&&document.detachEvent)return function(c,h,d){c=e.getElement(c),c.detachEvent("on"+h,d)};throw new Error("No known event model.")}(),cancelEvent:function(c){c.preventDefault()},eventIsCanceled:function(c){return c.defaultPrevented},stopEvent:function(c){c.stopPropagation()},createCallback:function(c,h){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var d=[],l;for(l=2;l<arguments.length;l++)d.push(arguments[l]);return function(){var f=d.concat([]),p;for(p=0;p<arguments.length;p++)f.push(arguments[p]);return h.apply(c,f)}},getUrlParameter:function(c){var h=o[c];return h||null},getUrlProtocol:function(c){var h=c.match(/^([a-z]+:)\/\//i);return h===null?window.location.protocol:h[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(c,h,d){var l,f,p,g;e.isPlainObject(c)&&(h=c.success,d=c.error,l=c.withCredentials,f=c.headers,p=c.responseType||null,g=c.postData||null,c=c.url);var v=e.getUrlProtocol(c),w=e.createAjaxRequest();if(!e.isFunction(h))throw new Error("makeAjaxRequest requires a success callback");w.onreadystatechange=function(){w.readyState===4&&(w.onreadystatechange=function(){},w.status>=200&&w.status<300||w.status===0&&v!=="http:"&&v!=="https:"?h(w):e.isFunction(d)?d(w):e.console.error("AJAX request returned %d: %s",w.status,c))};var E=g?"POST":"GET";try{if(w.open(E,c,!0),p&&(w.responseType=p),f)for(var I in f)Object.prototype.hasOwnProperty.call(f,I)&&f[I]&&w.setRequestHeader(I,f[I]);l&&(w.withCredentials=!0),w.send(g)}catch(L){e.console.error("%s while making AJAX request: %s",L.name,L.message),w.onreadystatechange=function(){},e.isFunction(d)&&d(w,L)}return w},jsonp:function(c){var h,d=c.url,l=document.head||document.getElementsByTagName("head")[0]||document.documentElement,f=c.callbackName||"openseadragon"+e.now(),p=window[f],g="$1"+f+"$2",v=c.param||"callback",w=c.callback;d=d.replace(/(=)\?(&|$)|\?\?/i,g),d+=(/\?/.test(d)?"&":"?")+v+"="+f,window[f]=function(E){if(p)window[f]=p;else try{delete window[f]}catch{}w&&e.isFunction(w)&&w(E)},h=document.createElement("script"),(c.async!==void 0||c.async!==!1)&&(h.async="async"),c.scriptCharset&&(h.charset=c.scriptCharset),h.src=d,h.onload=h.onreadystatechange=function(E,I){(I||!h.readyState||/loaded|complete/.test(h.readyState))&&(h.onload=h.onreadystatechange=null,l&&h.parentNode&&l.removeChild(h),h=void 0)},l.insertBefore(h,l.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(c){if(window.DOMParser)e.parseXml=function(h){var d=null,l;return l=new DOMParser,d=l.parseFromString(h,"text/xml"),d};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(c)},parseJSON:function(c){return e.parseJSON=window.JSON.parse,e.parseJSON(c)},imageFormatSupported:function(c){return c=c||"",!!r[c.toLowerCase()]},setImageFormatsSupported:function(c){e.extend(r,c)}});var n=function(c){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var c=navigator.appVersion,h=navigator.userAgent,d;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(h.substring(h.indexOf("MSIE")+5,h.indexOf(";",h.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(h.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edge")+5))):h.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edg")+4))):h.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(h.substring(h.indexOf("Firefox")+8))):h.indexOf("Safari")>=0?(e.Browser.vendor=h.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(h.substring(h.substring(0,h.indexOf("Safari")).lastIndexOf("/")+1,h.indexOf("Safari")))):(d=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),d.exec(h)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(c);break}var l=window.location.search.substring(1),f=l.split("&"),p,g,v;for(v=0;v<f.length;v++)if(p=f[v],g=p.indexOf("="),g>0){var w=p.substring(0,g),E=p.substring(g+1);try{o[w]=decodeURIComponent(E)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",w,E)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(c){var h=c.requestAnimationFrame||c.mozRequestAnimationFrame||c.webkitRequestAnimationFrame||c.msRequestAnimationFrame,d=c.cancelAnimationFrame||c.mozCancelAnimationFrame||c.webkitCancelAnimationFrame||c.msCancelAnimationFrame;if(h&&d)e.requestAnimationFrame=function(){return h.apply(c,arguments)},e.cancelAnimationFrame=function(){return d.apply(c,arguments)};else{var l=[],f=[],p=0,g;e.requestAnimationFrame=function(v){return l.push([++p,v]),g||(g=setInterval(function(){if(l.length){var w=e.now(),E=f;for(f=l,l=E;f.length;)f.shift()[1](w)}else clearInterval(g),g=void 0},1e3/50)),p},e.cancelAnimationFrame=function(v){var w,E;for(w=0,E=l.length;w<E;w+=1)if(l[w][0]===v){l.splice(w,1);return}for(w=0,E=f.length;w<E;w+=1)if(f[w][0]===v){f.splice(w,1);return}}}}(window);function a(c,h){return h&&c!==document.body?document.body:c.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(Pn,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var c=o[0*3+0],h=o[0*3+1],d=o[0*3+2],l=o[1*3+0],f=o[1*3+1],p=o[1*3+2],g=o[2*3+0],v=o[2*3+1],w=o[2*3+2],E=a[0*3+0],I=a[0*3+1],L=a[0*3+2],N=a[1*3+0],Z=a[1*3+1],J=a[1*3+2],k=a[2*3+0],A=a[2*3+1],P=a[2*3+2];return new i([E*c+I*l+L*g,E*h+I*f+L*v,E*d+I*p+L*w,N*c+Z*l+J*g,N*h+Z*f+J*v,N*d+Z*p+J*w,k*c+A*l+P*g,k*h+A*f+P*v,k*d+A*p+P*w])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var c=this;o=o||1;var h=0,d=function(l){return h++,h===o&&c.removeHandler(i,d),n(l)};return this.addHandler(i,d,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var c=a.length,h={handler:n,userData:r||null,priority:o||0};for(a[c]=h;c>0&&a[c-1].priority<a[c].priority;)a[c]=a[c-1],a[c-1]=h,c--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,c=n.length;for(a=0;a<c;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(x){var T=arguments;e.isPlainObject(x)||(x={element:T[0],clickTimeThreshold:T[1],clickDistThreshold:T[2]}),this.hash=Math.random(),this.element=e.getElement(x.element),this.clickTimeThreshold=x.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=x.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=x.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=x.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=x.userData||null,this.stopDelay=x.stopDelay||50,this.preProcessEventHandler=x.preProcessEventHandler||null,this.contextMenuHandler=x.contextMenuHandler||null,this.enterHandler=x.enterHandler||null,this.leaveHandler=x.leaveHandler||null,this.exitHandler=x.exitHandler||null,this.overHandler=x.overHandler||null,this.outHandler=x.outHandler||null,this.pressHandler=x.pressHandler||null,this.nonPrimaryPressHandler=x.nonPrimaryPressHandler||null,this.releaseHandler=x.releaseHandler||null,this.nonPrimaryReleaseHandler=x.nonPrimaryReleaseHandler||null,this.moveHandler=x.moveHandler||null,this.scrollHandler=x.scrollHandler||null,this.clickHandler=x.clickHandler||null,this.dblClickHandler=x.dblClickHandler||null,this.dragHandler=x.dragHandler||null,this.dragEndHandler=x.dragEndHandler||null,this.pinchHandler=x.pinchHandler||null,this.stopHandler=x.stopHandler||null,this.keyDownHandler=x.keyDownHandler||null,this.keyUpHandler=x.keyUpHandler||null,this.keyHandler=x.keyHandler||null,this.focusHandler=x.focusHandler||null,this.blurHandler=x.blurHandler||null;var S=this;i[this.hash]={click:function(R){L(S,R)},dblclick:function(R){N(S,R)},keydown:function(R){Z(S,R)},keyup:function(R){J(S,R)},keypress:function(R){k(S,R)},focus:function(R){A(S,R)},blur:function(R){P(S,R)},contextmenu:function(R){M(S,R)},wheel:function(R){F(S,R)},mousewheel:function(R){O(S,R)},DOMMouseScroll:function(R){O(S,R)},MozMousePixelScroll:function(R){O(S,R)},losecapture:function(R){B(S,R)},mouseenter:function(R){ne(S,R)},mouseleave:function(R){ct(S,R)},mouseover:function(R){et(S,R)},mouseout:function(R){Qt(S,R)},mousedown:function(R){_t(S,R)},mouseup:function(R){ri(S,R)},mousemove:function(R){bt(S,R)},touchstart:function(R){Ce(S,R)},touchend:function(R){Re(S,R)},touchmove:function(R){He(S,R)},touchcancel:function(R){ae(S,R)},gesturestart:function(R){Ee(S,R)},gesturechange:function(R){Pe(S,R)},gotpointercapture:function(R){Et(S,R)},lostpointercapture:function(R){Ze(S,R)},pointerenter:function(R){ne(S,R)},pointerleave:function(R){ct(S,R)},pointerover:function(R){et(S,R)},pointerout:function(R){Qt(S,R)},pointerdown:function(R){_t(S,R)},pointerup:function(R){ri(S,R)},pointermove:function(R){bt(S,R)},pointercancel:function(R){Ut(S,R)},pointerupcaptured:function(R){hi(S,R)},pointermovecaptured:function(R){It(S,R)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),x.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){c(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(x){return x?a(this):c(this),this},getActivePointersListByType:function(x){var T=i[this.hash],S,R=T?T.activePointersLists.length:0,U;for(S=0;S<R;S++)if(T.activePointersLists[S].type===x)return T.activePointersLists[S];return U=new e.MouseTracker.GesturePointList(x),T&&T.activePointersLists.push(U),U},getActivePointerCount:function(){var x=i[this.hash],T,S=x.activePointersLists.length,R=0;for(T=0;T<S;T++)R+=x.activePointersLists[T].getLength();return R},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(x){try{return x.addEventListener&&x.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var x=[],T=0,S=0,R=function(ze,ge){return ze.hash.toString()+ge.type+ge.id.toString()},U=function(){var ze,ge=x.length,ht,tt,Jt=e.now(),ui,Si,Pi;for(ui=Jt-S,S=Jt,ze=0;ze<ge;ze++)ht=x[ze],tt=ht.gPoint,tt.direction=Math.atan2(tt.currentPos.y-ht.lastPos.y,tt.currentPos.x-ht.lastPos.x),Si=ht.lastPos.distanceTo(tt.currentPos),ht.lastPos=tt.currentPos,Pi=1e3*Si/(ui+1),tt.speed=.75*Pi+.25*tt.speed},K=function(ze,ge){var ht=R(ze,ge);x.push({guid:ht,gPoint:ge,lastPos:ge.currentPos}),x.length===1&&(S=e.now(),T=window.setInterval(U,50))},pe=function(ze,ge){var ht=R(ze,ge),tt,Jt=x.length;for(tt=0;tt<Jt;tt++)if(x[tt].guid===ht){x.splice(tt,1),Jt--,Jt===0&&window.clearInterval(T);break}};return{addPoint:K,removePoint:pe}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var x=document.createElement("div");return e.isFunction(x.setPointerCapture)&&e.isFunction(x.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var x=document.createElement("div");return e.isFunction(x.setCapture)&&e.isFunction(x.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(x){this._gPoints=[],this.type=x,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(x){return this._gPoints.push(x)},removeById:function(x){var T,S=this._gPoints.length;for(T=0;T<S;T++)if(this._gPoints[T].id===x){this._gPoints.splice(T,1);break}return this._gPoints.length},getByIndex:function(x){return x<this._gPoints.length?this._gPoints[x]:null},getById:function(x){var T,S=this._gPoints.length;for(T=0;T<S;T++)if(this._gPoints[T].id===x)return this._gPoints[T];return null},getPrimary:function(x){var T,S=this._gPoints.length;for(T=0;T<S;T++)if(this._gPoints[T].isPrimary)return this._gPoints[T];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(x){var T=i[x.hash],S,R,U,K,pe,ze=T.activePointersLists.length;for(S=0;S<ze;S++)if(U=T.activePointersLists[S],U.getLength()>0){for(pe=[],K=U.asArray(),R=0;R<K.length;R++)pe.push(K[R]);for(R=0;R<pe.length;R++)Dt(x,U,pe[R])}for(S=0;S<ze;S++)T.activePointersLists.pop();T.sentDragEvent=!1}function a(x){var T=i[x.hash],S,R;if(!T.tracking){for(R=0;R<e.MouseTracker.subscribeEvents.length;R++)S=e.MouseTracker.subscribeEvents[R],e.addEvent(x.element,S,T[S],S===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(x),T.tracking=!0}}function c(x){var T=i[x.hash],S,R;if(T.tracking){for(R=0;R<e.MouseTracker.subscribeEvents.length;R++)S=e.MouseTracker.subscribeEvents[R],e.removeEvent(x.element,S,T[S],!1);o(x),T.tracking=!1}}function h(x,T){var S=i[x.hash];if(T==="pointerevent")return{upName:"pointerup",upHandler:S.pointerupcaptured,moveName:"pointermove",moveHandler:S.pointermovecaptured};if(T==="mouse")return{upName:"pointerup",upHandler:S.pointerupcaptured,moveName:"pointermove",moveHandler:S.pointermovecaptured};if(T==="touch")return{upName:"touchend",upHandler:S.touchendcaptured,moveName:"touchmove",moveHandler:S.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function d(x,T){var S;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{x.element.setPointerCapture(T.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else x.element.setCapture(!0);else S=h(x,e.MouseTracker.havePointerEvents?"pointerevent":T.type),n&&r(window.top)&&e.addEvent(window.top,S.upName,S.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,S.upName,S.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,S.moveName,S.moveHandler,!0);V(x,T,!0)}function l(x,T){var S,R,U;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(R=x.getActivePointersListByType(T.type),U=R.getById(T.id),!U||!U.captured)return;try{x.element.releasePointerCapture(T.id)}catch{}}else x.element.releaseCapture();else S=h(x,e.MouseTracker.havePointerEvents?"pointerevent":T.type),n&&r(window.top)&&e.removeEvent(window.top,S.upName,S.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,S.moveName,S.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,S.upName,S.upHandler,!0);V(x,T,!1)}function f(x){return e.MouseTracker.havePointerEvents?x.pointerId:e.MouseTracker.mousePointerId}function p(x){return e.MouseTracker.havePointerEvents&&x.pointerType?x.pointerType:"mouse"}function g(x){return e.MouseTracker.havePointerEvents?x.isPrimary:!0}function v(x){return e.getMousePosition(x)}function w(x,T){return E(v(x),T)}function E(x,T){var S=e.getElementOffset(T);return x.minus(S)}function I(x,T){return new e.Point((x.x+T.x)/2,(x.y+T.y)/2)}function L(x,T){var S={originalEvent:T,eventType:"click",pointerType:"mouse",isEmulated:!1};C(x,S),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(T),S.stopPropagation&&e.stopEvent(T)}function N(x,T){var S={originalEvent:T,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};C(x,S),S.preventDefault&&!S.defaultPrevented&&e.cancelEvent(T),S.stopPropagation&&e.stopEvent(T)}function Z(x,T){var S=null,R={originalEvent:T,eventType:"keydown",pointerType:"",isEmulated:!1};C(x,R),x.keyDownHandler&&!R.preventGesture&&!R.defaultPrevented&&(S={eventSource:x,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:R.preventDefault||R.defaultPrevented,userData:x.userData},x.keyDownHandler(S)),(S&&S.preventDefault||R.preventDefault&&!R.defaultPrevented)&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function J(x,T){var S=null,R={originalEvent:T,eventType:"keyup",pointerType:"",isEmulated:!1};C(x,R),x.keyUpHandler&&!R.preventGesture&&!R.defaultPrevented&&(S={eventSource:x,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:R.preventDefault||R.defaultPrevented,userData:x.userData},x.keyUpHandler(S)),(S&&S.preventDefault||R.preventDefault&&!R.defaultPrevented)&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function k(x,T){var S=null,R={originalEvent:T,eventType:"keypress",pointerType:"",isEmulated:!1};C(x,R),x.keyHandler&&!R.preventGesture&&!R.defaultPrevented&&(S={eventSource:x,keyCode:T.keyCode?T.keyCode:T.charCode,ctrl:T.ctrlKey,shift:T.shiftKey,alt:T.altKey,meta:T.metaKey,originalEvent:T,preventDefault:R.preventDefault||R.defaultPrevented,userData:x.userData},x.keyHandler(S)),(S&&S.preventDefault||R.preventDefault&&!R.defaultPrevented)&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function A(x,T){var S={originalEvent:T,eventType:"focus",pointerType:"",isEmulated:!1};C(x,S),x.focusHandler&&!S.preventGesture&&x.focusHandler({eventSource:x,originalEvent:T,userData:x.userData})}function P(x,T){var S={originalEvent:T,eventType:"blur",pointerType:"",isEmulated:!1};C(x,S),x.blurHandler&&!S.preventGesture&&x.blurHandler({eventSource:x,originalEvent:T,userData:x.userData})}function M(x,T){var S=null,R={originalEvent:T,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};C(x,R),x.contextMenuHandler&&!R.preventGesture&&!R.defaultPrevented&&(S={eventSource:x,position:E(v(T),x.element),originalEvent:R.originalEvent,preventDefault:R.preventDefault||R.defaultPrevented,userData:x.userData},x.contextMenuHandler(S)),(S&&S.preventDefault||R.preventDefault&&!R.defaultPrevented)&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function F(x,T){D(x,T,T)}function O(x,T){var S={target:T.target||T.srcElement,type:"wheel",shiftKey:T.shiftKey||!1,clientX:T.clientX,clientY:T.clientY,pageX:T.pageX?T.pageX:T.clientX,pageY:T.pageY?T.pageY:T.clientY,deltaMode:T.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?S.deltaY=-T.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:S.deltaY=T.detail,D(x,S,T)}function D(x,T,S){var R=0,U,K=null;R=T.deltaY?T.deltaY<0?1:-1:0,U={originalEvent:T,eventType:"wheel",pointerType:"mouse",isEmulated:T!==S},C(x,U),x.scrollHandler&&!U.preventGesture&&!U.defaultPrevented&&(K={eventSource:x,pointerType:"mouse",position:w(T,x.element),scroll:R,shift:T.shiftKey,isTouchEvent:!1,originalEvent:S,preventDefault:U.preventDefault||U.defaultPrevented,userData:x.userData},x.scrollHandler(K)),U.stopPropagation&&e.stopEvent(S),(K&&K.preventDefault||U.preventDefault&&!U.defaultPrevented)&&e.cancelEvent(S)}function B(x,T){var S={id:e.MouseTracker.mousePointerId,type:"mouse"},R={originalEvent:T,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};C(x,R),T.target===x.element&&V(x,S,!1),R.stopPropagation&&e.stopEvent(T)}function Ce(x,T){var S,R,U=T.changedTouches.length,K,pe=x.getActivePointersListByType("touch");S=e.now(),pe.getLength()>T.touches.length-U&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var ze={originalEvent:T,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(C(x,ze),R=0;R<U;R++)K={id:T.changedTouches[R].identifier,type:"touch",isPrimary:pe.getLength()===0,currentPos:v(T.changedTouches[R]),currentTime:S},q(x,ze,K),ye(x,ze,K,0),V(x,K,!0);ze.preventDefault&&!ze.defaultPrevented&&e.cancelEvent(T),ze.stopPropagation&&e.stopEvent(T)}function Re(x,T){var S,R,U=T.changedTouches.length,K;S=e.now();var pe={originalEvent:T,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(C(x,pe),R=0;R<U;R++)K={id:T.changedTouches[R].identifier,type:"touch",currentPos:v(T.changedTouches[R]),currentTime:S},Fe(x,pe,K,0),V(x,K,!1),$(x,pe,K);pe.preventDefault&&!pe.defaultPrevented&&e.cancelEvent(T),pe.stopPropagation&&e.stopEvent(T)}function He(x,T){var S,R,U=T.changedTouches.length,K;S=e.now();var pe={originalEvent:T,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(C(x,pe),R=0;R<U;R++)K={id:T.changedTouches[R].identifier,type:"touch",currentPos:v(T.changedTouches[R]),currentTime:S},be(x,pe,K);pe.preventDefault&&!pe.defaultPrevented&&e.cancelEvent(T),pe.stopPropagation&&e.stopEvent(T)}function ae(x,T){var S=T.changedTouches.length,R,U,K={originalEvent:T,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(C(x,K),R=0;R<S;R++)U={id:T.changedTouches[R].identifier,type:"touch"},he(x,K,U);K.stopPropagation&&e.stopEvent(T)}function Ee(x,T){return e.eventIsCanceled(T)||T.preventDefault(),!1}function Pe(x,T){return e.eventIsCanceled(T)||T.preventDefault(),!1}function Et(x,T){var S={originalEvent:T,eventType:"gotpointercapture",pointerType:p(T),isEmulated:!1};C(x,S),T.target===x.element&&V(x,{id:T.pointerId,type:p(T)},!0),S.stopPropagation&&e.stopEvent(T)}function Ze(x,T){var S={originalEvent:T,eventType:"lostpointercapture",pointerType:p(T),isEmulated:!1};C(x,S),T.target===x.element&&V(x,{id:T.pointerId,type:p(T)},!1),S.stopPropagation&&e.stopEvent(T)}function ne(x,T){var S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()},R={originalEvent:T,eventType:"pointerenter",pointerType:S.type,isEmulated:!1};C(x,R),q(x,R,S)}function ct(x,T){var S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()},R={originalEvent:T,eventType:"pointerleave",pointerType:S.type,isEmulated:!1};C(x,R),$(x,R,S)}function et(x,T){var S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()},R={originalEvent:T,eventType:"pointerover",pointerType:S.type,isEmulated:!1};C(x,R),ce(x,R,S),R.preventDefault&&!R.defaultPrevented&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function Qt(x,T){var S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()},R={originalEvent:T,eventType:"pointerout",pointerType:S.type,isEmulated:!1};C(x,R),G(x,R,S),R.preventDefault&&!R.defaultPrevented&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function _t(x,T){var S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()},R=e.MouseTracker.havePointerEvents&&S.type==="touch",U={originalEvent:T,eventType:"pointerdown",pointerType:S.type,isEmulated:!1};C(x,U),ye(x,U,S,T.button),U.preventDefault&&!U.defaultPrevented&&e.cancelEvent(T),U.stopPropagation&&e.stopEvent(T),U.shouldCapture&&(R?V(x,S,!0):d(x,S))}function ri(x,T){Xt(x,T)}function hi(x,T){var S=x.getActivePointersListByType(p(T));S.getById(T.pointerId)&&Xt(x,T),e.stopEvent(T)}function Xt(x,T){var S;S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()};var R={originalEvent:T,eventType:"pointerup",pointerType:S.type,isEmulated:!1};C(x,R),Fe(x,R,S,T.button),R.preventDefault&&!R.defaultPrevented&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T),R.shouldReleaseCapture&&(T.target===x.element?l(x,S):V(x,S,!1))}function bt(x,T){Nt(x,T)}function It(x,T){var S=x.getActivePointersListByType(p(T));S.getById(T.pointerId)&&Nt(x,T),e.stopEvent(T)}function Nt(x,T){var S={id:f(T),type:p(T),isPrimary:g(T),currentPos:v(T),currentTime:e.now()},R={originalEvent:T,eventType:"pointermove",pointerType:S.type,isEmulated:!1};C(x,R),be(x,R,S),R.preventDefault&&!R.defaultPrevented&&e.cancelEvent(T),R.stopPropagation&&e.stopEvent(T)}function Ut(x,T){var S={id:T.pointerId,type:p(T)},R={originalEvent:T,eventType:"pointercancel",pointerType:S.type,isEmulated:!1};C(x,R),he(x,R,S),R.stopPropagation&&e.stopEvent(T)}function Oe(x,T){return T.speed=0,T.direction=0,T.contactPos=T.currentPos,T.contactTime=T.currentTime,T.lastPos=T.currentPos,T.lastTime=T.currentTime,x.add(T)}function Dt(x,T,S){var R,U=T.getById(S.id);return U?(U.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),l(x,U)),T.removeContact(),R=T.removeById(S.id)):R=T.getLength(),R}function y(x,T){switch(T.eventType){case"pointermove":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"pointerdown":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasGestureHandlers,T.stopPropagation=!1;break;case"pointerup":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasGestureHandlers,T.stopPropagation=!1;break;case"wheel":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!1,T.preventGesture=!x.hasScrollHandler,T.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":T.isStoppable=!0,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break;case"click":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!x.clickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"dblclick":T.isStoppable=!0,T.isCancelable=!0,T.preventDefault=!!x.dblClickHandler,T.preventGesture=!1,T.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:T.isStoppable=!1,T.isCancelable=!1,T.preventDefault=!1,T.preventGesture=!1,T.stopPropagation=!1;break}}function C(x,T){T.eventSource=x,T.eventPhase=T.originalEvent&&typeof T.originalEvent.eventPhase<"u"?T.originalEvent.eventPhase:0,T.defaultPrevented=e.eventIsCanceled(T.originalEvent),T.shouldCapture=!1,T.shouldReleaseCapture=!1,T.userData=x.userData,y(x,T),x.preProcessEventHandler&&x.preProcessEventHandler(T)}function V(x,T,S){var R=x.getActivePointersListByType(T.type),U=R.getById(T.id);U?S&&!U.captured?(U.captured=!0,R.captureCount++):!S&&U.captured&&(U.captured=!1,R.captureCount--,R.captureCount<0&&(R.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function q(x,T,S){var R=x.getActivePointersListByType(S.type),U;U=R.getById(S.id),U?(U.insideElement=!0,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=S.currentPos,U.currentTime=S.currentTime,S=U):(S.captured=!1,S.insideElementPressed=!1,S.insideElement=!0,Oe(R,S)),x.enterHandler&&x.enterHandler({eventSource:x,pointerType:S.type,position:E(S.currentPos,x.element),buttons:R.buttons,pointers:x.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:R.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData})}function $(x,T,S){var R=x.getActivePointersListByType(S.type),U,K;U=R.getById(S.id),U?(U.captured?(U.insideElement=!1,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=S.currentPos,U.currentTime=S.currentTime):Dt(x,R,U),S=U):(S.captured=!1,S.insideElementPressed=!1),(x.leaveHandler||x.exitHandler)&&(K={eventSource:x,pointerType:S.type,position:S.currentPos&&E(S.currentPos,x.element),buttons:R.buttons,pointers:x.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:R.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData},x.leaveHandler&&x.leaveHandler(K),x.exitHandler&&x.exitHandler(K))}function ce(x,T,S){var R,U;R=x.getActivePointersListByType(S.type),U=R.getById(S.id),U?S=U:(S.captured=!1,S.insideElementPressed=!1),x.overHandler&&x.overHandler({eventSource:x,pointerType:S.type,position:E(S.currentPos,x.element),buttons:R.buttons,pointers:x.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:R.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData})}function G(x,T,S){var R,U;R=x.getActivePointersListByType(S.type),U=R.getById(S.id),U?S=U:(S.captured=!1,S.insideElementPressed=!1),x.outHandler&&x.outHandler({eventSource:x,pointerType:S.type,position:S.currentPos&&E(S.currentPos,x.element),buttons:R.buttons,pointers:x.getActivePointerCount(),insideElementPressed:S.insideElementPressed,buttonDownAny:R.buttons!==0,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData})}function ye(x,T,S,R){var U=i[x.hash],K=x.getActivePointersListByType(S.type),pe;if(typeof T.originalEvent.buttons<"u"?K.buttons=T.originalEvent.buttons:R===0?K.buttons|=1:R===1?K.buttons|=4:R===2?K.buttons|=2:R===3?K.buttons|=8:R===4?K.buttons|=16:R===5&&(K.buttons|=32),R!==0){T.shouldCapture=!1,T.shouldReleaseCapture=!1,x.nonPrimaryPressHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,x.nonPrimaryPressHandler({eventSource:x,pointerType:S.type,position:E(S.currentPos,x.element),button:R,buttons:K.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData}));return}pe=K.getById(S.id),pe?(pe.insideElementPressed=!0,pe.insideElement=!0,pe.originalTarget=T.originalEvent.target,pe.contactPos=S.currentPos,pe.contactTime=S.currentTime,pe.lastPos=pe.currentPos,pe.lastTime=pe.currentTime,pe.currentPos=S.currentPos,pe.currentTime=S.currentTime,S=pe):(S.captured=!1,S.insideElementPressed=!0,S.insideElement=!0,S.originalTarget=T.originalEvent.target,Oe(K,S)),K.addContact(),!T.preventGesture&&!T.defaultPrevented?(T.shouldCapture=!0,T.shouldReleaseCapture=!1,T.preventDefault=!0,(x.dragHandler||x.dragEndHandler||x.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(x,S),K.contacts===1?x.pressHandler&&!T.preventGesture&&x.pressHandler({eventSource:x,pointerType:S.type,position:E(S.contactPos,x.element),buttons:K.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData}):K.contacts===2&&x.pinchHandler&&S.type==="touch"&&(U.pinchGPoints=K.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=I(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(T.shouldCapture=!1,T.shouldReleaseCapture=!1)}function Fe(x,T,S,R){var U=i[x.hash],K=x.getActivePointersListByType(S.type),pe,ze,ge,ht=!1,tt;if(typeof T.originalEvent.buttons<"u"?K.buttons=T.originalEvent.buttons:R===0?K.buttons^=-2:R===1?K.buttons^=-5:R===2?K.buttons^=-3:R===3?K.buttons^=-9:R===4?K.buttons^=-17:R===5&&(K.buttons^=-33),T.shouldCapture=!1,R!==0){T.shouldReleaseCapture=!1,x.nonPrimaryReleaseHandler&&!T.preventGesture&&!T.defaultPrevented&&(T.preventDefault=!0,x.nonPrimaryReleaseHandler({eventSource:x,pointerType:S.type,position:E(S.currentPos,x.element),button:R,buttons:K.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData}));return}ge=K.getById(S.id),ge?(K.removeContact(),ge.captured&&(ht=!0),ge.lastPos=ge.currentPos,ge.lastTime=ge.currentTime,ge.currentPos=S.currentPos,ge.currentTime=S.currentTime,ge.insideElement||Dt(x,K,ge),pe=ge.currentPos,ze=ge.currentTime):(S.captured=!1,S.insideElementPressed=!1,S.insideElement=!0,Oe(K,S),ge=S),!T.preventGesture&&!T.defaultPrevented&&(ht?(T.shouldReleaseCapture=!0,T.preventDefault=!0,(x.dragHandler||x.dragEndHandler||x.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(x,ge),K.contacts===0?(x.releaseHandler&&pe&&x.releaseHandler({eventSource:x,pointerType:ge.type,position:E(pe,x.element),buttons:K.buttons,insideElementPressed:ge.insideElementPressed,insideElementReleased:ge.insideElement,isTouchEvent:ge.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),x.dragEndHandler&&U.sentDragEvent&&x.dragEndHandler({eventSource:x,pointerType:ge.type,position:E(ge.currentPos,x.element),speed:ge.speed,direction:ge.direction,shift:T.originalEvent.shiftKey,isTouchEvent:ge.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),U.sentDragEvent=!1,(x.clickHandler||x.dblClickHandler)&&ge.insideElement&&(tt=ze-ge.contactTime<=x.clickTimeThreshold&&ge.contactPos.distanceTo(pe)<=x.clickDistThreshold,x.clickHandler&&x.clickHandler({eventSource:x,pointerType:ge.type,position:E(ge.currentPos,x.element),quick:tt,shift:T.originalEvent.shiftKey,isTouchEvent:ge.type==="touch",originalEvent:T.originalEvent,originalTarget:ge.originalTarget,userData:x.userData}),x.dblClickHandler&&tt&&(K.clicks++,K.clicks===1?(U.lastClickPos=pe,U.dblClickTimeOut=setTimeout(function(){K.clicks=0},x.dblClickTimeThreshold)):K.clicks===2&&(clearTimeout(U.dblClickTimeOut),K.clicks=0,U.lastClickPos.distanceTo(pe)<=x.dblClickDistThreshold&&x.dblClickHandler({eventSource:x,pointerType:ge.type,position:E(ge.currentPos,x.element),shift:T.originalEvent.shiftKey,isTouchEvent:ge.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),U.lastClickPos=null)))):K.contacts===2&&x.pinchHandler&&ge.type==="touch"&&(U.pinchGPoints=K.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=I(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(T.shouldReleaseCapture=!1,x.releaseHandler&&pe&&(x.releaseHandler({eventSource:x,pointerType:ge.type,position:E(pe,x.element),buttons:K.buttons,insideElementPressed:ge.insideElementPressed,insideElementReleased:ge.insideElement,isTouchEvent:ge.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),T.preventDefault=!0)))}function be(x,T,S){var R=i[x.hash],U=x.getActivePointersListByType(S.type),K,pe,ze;if(typeof T.originalEvent.buttons<"u"&&(U.buttons=T.originalEvent.buttons),K=U.getById(S.id),K)K.lastPos=K.currentPos,K.lastTime=K.currentTime,K.currentPos=S.currentPos,K.currentTime=S.currentTime;else return;T.shouldCapture=!1,T.shouldReleaseCapture=!1,x.stopHandler&&S.type==="mouse"&&(clearTimeout(x.stopTimeOut),x.stopTimeOut=setTimeout(function(){Xe(x,T.originalEvent,S.type)},x.stopDelay)),U.contacts===0?x.moveHandler&&x.moveHandler({eventSource:x,pointerType:S.type,position:E(S.currentPos,x.element),buttons:U.buttons,isTouchEvent:S.type==="touch",originalEvent:T.originalEvent,userData:x.userData}):U.contacts===1?(x.moveHandler&&(K=U.asArray()[0],x.moveHandler({eventSource:x,pointerType:K.type,position:E(K.currentPos,x.element),buttons:U.buttons,isTouchEvent:K.type==="touch",originalEvent:T.originalEvent,userData:x.userData})),x.dragHandler&&!T.preventGesture&&!T.defaultPrevented&&(K=U.asArray()[0],ze=K.currentPos.minus(K.lastPos),x.dragHandler({eventSource:x,pointerType:K.type,position:E(K.currentPos,x.element),buttons:U.buttons,delta:ze,speed:K.speed,direction:K.direction,shift:T.originalEvent.shiftKey,isTouchEvent:K.type==="touch",originalEvent:T.originalEvent,userData:x.userData}),T.preventDefault=!0,R.sentDragEvent=!0)):U.contacts===2&&(x.moveHandler&&(pe=U.asArray(),x.moveHandler({eventSource:x,pointerType:pe[0].type,position:E(I(pe[0].currentPos,pe[1].currentPos),x.element),buttons:U.buttons,isTouchEvent:pe[0].type==="touch",originalEvent:T.originalEvent,userData:x.userData})),x.pinchHandler&&S.type==="touch"&&!T.preventGesture&&!T.defaultPrevented&&(ze=R.pinchGPoints[0].currentPos.distanceTo(R.pinchGPoints[1].currentPos),ze!==R.currentPinchDist&&(R.lastPinchDist=R.currentPinchDist,R.currentPinchDist=ze,R.lastPinchCenter=R.currentPinchCenter,R.currentPinchCenter=I(R.pinchGPoints[0].currentPos,R.pinchGPoints[1].currentPos),x.pinchHandler({eventSource:x,pointerType:"touch",gesturePoints:R.pinchGPoints,lastCenter:E(R.lastPinchCenter,x.element),center:E(R.currentPinchCenter,x.element),lastDistance:R.lastPinchDist,distance:R.currentPinchDist,shift:T.originalEvent.shiftKey,originalEvent:T.originalEvent,userData:x.userData}),T.preventDefault=!0)))}function he(x,T,S){var R=x.getActivePointersListByType(S.type),U;U=R.getById(S.id),U&&Dt(x,R,U)}function Xe(x,T,S){x.stopHandler&&x.stopHandler({eventSource:x,pointerType:S,position:w(T,x.element),buttons:x.getActivePointersListByType(S).buttons,isTouchEvent:S==="touch",originalEvent:T,userData:x.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(y){var C=arguments,V=this,q;e.isPlainObject(y)||(y={id:C[0],xmlPath:C.length>1?C[1]:void 0,prefixUrl:C.length>2?C[2]:void 0,controls:C.length>3?C[3]:void 0,overlays:C.length>4?C[4]:void 0}),y.config&&(e.extend(!0,y,y.config),delete y.config);let $=["useCanvas"];if(y.drawerOptions=Object.assign({},$.reduce((G,ye)=>(G[ye]=y[ye],delete y[ye],G),{}),y.drawerOptions),e.extend(!0,this,{id:y.id,hash:y.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,y),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(G){var ye=e.getString("Errors.OpenFailed",G.eventSource,G.message);V._showMessage(ye)}),e.ControlDock.call(this,y),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(G){G.width="100%",G.height="100%",G.overflow="hidden",G.position="absolute",G.top="0px",G.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),y.tabIndex!==""&&(this.canvas.tabIndex=y.tabIndex===void 0?0:y.tabIndex),this.container.className="openseadragon-container",function(G){G.width="100%",G.height="100%",G.position="relative",G.overflow="hidden",G.left="0px",G.top="0px",G.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,w),keyDownHandler:e.delegate(this,E),keyHandler:e.delegate(this,I),clickHandler:e.delegate(this,L),dblClickHandler:e.delegate(this,N),dragHandler:e.delegate(this,Z),dragEndHandler:e.delegate(this,J),enterHandler:e.delegate(this,k),leaveHandler:e.delegate(this,A),pressHandler:e.delegate(this,P),releaseHandler:e.delegate(this,M),nonPrimaryPressHandler:e.delegate(this,F),nonPrimaryReleaseHandler:e.delegate(this,O),scrollHandler:e.delegate(this,Re),pinchHandler:e.delegate(this,D),focusHandler:e.delegate(this,B),blurHandler:e.delegate(this,Ce)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,He),leaveHandler:e.delegate(this,ae)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[V.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(G){V.source=V.world.getItemAt(0).source,i[V.hash].forceRedraw=!0,V._updateRequestId||(V._updateRequestId=h(V,Ee))}),this.world.addHandler("remove-item",function(G){V.world.getItemCount()?V.source=V.world.getItemAt(0).source:V.source=null,i[V.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(G){V.viewport&&V.viewport._setContentBounds(V.world.getHomeBounds(),V.world.getContentFactor())}),this.world.addHandler("item-index-change",function(G){V.source=V.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:y.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let ce=Array.isArray(this.drawer)?this.drawer:[this.drawer];ce.length===0&&(ce=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const G of ce)if(this.requestDrawer(G,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(q=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(q,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(q=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(q,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),q=0;q<this.customControls.length;q++)this.addControl(this.customControls[q].id,{anchor:this.customControls[q].anchor});e.requestAnimationFrame(function(){l(V)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(y){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(y)},openTileSource:function(y){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(y)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(y,C){var V=this;if(this.close(),!y)return this;if(this.sequenceMode&&e.isArray(y))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof C<"u"&&!isNaN(C)&&(this.initialPage=C),this.tileSources=y,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(y)||(y=[y]),!y.length)return this;this._opening=!0;for(var q=y.length,$=0,ce=0,G,ye=function(){if($+ce===q)if($){(V._firstOpen||!V.preserveViewport)&&(V.viewport.goHome(!0),V.viewport.update()),V._firstOpen=!1;var he=y[0];if(he.tileSource&&(he=he.tileSource),V.overlays&&!V.preserveOverlays)for(var Xe=0;Xe<V.overlays.length;Xe++)V.currentOverlays[Xe]=a(V,V.overlays[Xe]);V._drawOverlays(),V._opening=!1,V.raiseEvent("open",{source:he})}else V._opening=!1,V.raiseEvent("open-failed",G)},Fe=function(he){(!e.isPlainObject(he)||!he.tileSource)&&(he={tileSource:he}),he.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete he.index),he.collectionImmediately===void 0&&(he.collectionImmediately=!0);var Xe=he.success;he.success=function(T){if($++,he.tileSource.overlays)for(var S=0;S<he.tileSource.overlays.length;S++)V.addOverlay(he.tileSource.overlays[S]);Xe&&Xe(T),ye()};var x=he.error;he.error=function(T){ce++,G||(G=T),x&&x(T),ye()},V.addTiledImage(he)},be=0;be<y.length;be++)Fe(y[be]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(y,C){const V={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};C=e.extend(!0,V,C);const q=C.mainDrawer,$=C.redrawImmediately,ce=C.drawerOptions,G=this.drawer;let ye=null;if(y&&y.prototype instanceof e.DrawerBase?(ye=y,y="custom"):typeof y=="string"&&(ye=e.determineDrawer(y)),ye||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),ye&&ye.isSupported()){G&&q&&G.destroy();const Fe=new ye({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:ce||this.drawerOptions[y]});return q&&(this.drawer=Fe,$&&this.forceRedraw()),Fe}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(y){return this.innerTracker.setTracking(y),this.outerTracker.setTracking(y),this.raiseEvent("mouse-enabled",{enabled:y}),this},areControlsEnabled:function(){var y=this.controls.length,C;for(C=0;C<this.controls.length;C++)y=y&&this.controls[C].isVisible();return y},setControlsEnabled:function(y){return y?p(this):l(this),this.raiseEvent("controls-enabled",{enabled:y}),this},setDebugMode:function(y){for(var C=0;C<this.world.getItemCount();C++)this.world.getItemAt(C).debugMode=y;this.debugMode=y,this.forceRedraw()},setAjaxHeaders:function(y,C){if(y===null&&(y={}),!e.isPlainObject(y)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(C===void 0&&(C=!0),this.ajaxHeaders=y,C){for(var V=0;V<this.world.getItemCount();V++)this.world.getItemAt(V)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var q in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[q].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(y){this.buttonGroup.addButton(y)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(y){var C=document.body,V=C.style,q=document.documentElement.style,$=this,ce,G;if(y===this.isFullPage())return this;var ye={fullPage:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",ye),ye.preventDefaultAction)return this;if(y&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=V.margin,this.docMargin=q.margin,V.margin="0",q.margin="0",this.bodyPadding=V.padding,this.docPadding=q.padding,V.padding="0",q.padding="0",this.bodyWidth=V.width,this.docWidth=q.width,V.width="100%",q.width="100%",this.bodyHeight=V.height,this.docHeight=q.height,V.height="100%",q.height="100%",this.bodyDisplay=V.display,V.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,ce=C.childNodes.length,G=0;G<ce;G++)this.previousBody.push(C.childNodes[0]),C.removeChild(C.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,C.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),C.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,He)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,V.margin=this.bodyMargin,q.margin=this.docMargin,V.padding=this.bodyPadding,q.padding=this.docPadding,V.width=this.bodyWidth,q.width=this.docWidth,V.height=this.bodyHeight,q.height=this.docHeight,V.display=this.bodyDisplay,C.removeChild(this.element),ce=this.previousBody.length,G=0;G<ce;G++)C.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(C.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var Fe=0,be=function(){e.setPageScroll($.pageScroll);var he=e.getPageScroll();Fe++,Fe<10&&(he.x!==$.pageScroll.x||he.y!==$.pageScroll.y)&&e.requestAnimationFrame(be)};e.requestAnimationFrame(be),i[this.hash].fullPage=!1,e.delegate(this,ae)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:y}),this},setFullScreen:function(y){var C=this;if(!e.supportsFullScreen)return this.setFullPage(y);if(e.isFullScreen()===y)return this;var V={fullScreen:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",V),V.preventDefaultAction)return this;if(y){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var q=function(){var $=e.isFullScreen();$||(e.removeEvent(document,e.fullScreenEventName,q),e.removeEvent(document,e.fullScreenErrorEventName,q),C.setFullPage(!1),C.isFullPage()&&(C.element.style.width=C.fullPageStyleWidth,C.element.style.height=C.fullPageStyleHeight)),C.navigator&&C.viewport&&setTimeout(function(){C.navigator.update(C.viewport)}),C.raiseEvent("full-screen",{fullScreen:$})};e.addEvent(document,e.fullScreenEventName,q),e.addEvent(document,e.fullScreenErrorEventName,q),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(y){return this.container.style.visibility=y?"":"hidden",this.raiseEvent("visible",{visible:y}),this},addTiledImage:function(y){e.console.assert(y,"[Viewer.addTiledImage] options is required"),e.console.assert(y.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!y.replace||y.index>-1&&y.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var C=this;y.replace&&(y.replaceItem=C.world.getItemAt(y.index)),this._hideMessage(),y.placeholderFillStyle===void 0&&(y.placeholderFillStyle=this.placeholderFillStyle),y.opacity===void 0&&(y.opacity=this.opacity),y.preload===void 0&&(y.preload=this.preload),y.compositeOperation===void 0&&(y.compositeOperation=this.compositeOperation),y.crossOriginPolicy===void 0&&(y.crossOriginPolicy=y.tileSource.crossOriginPolicy!==void 0?y.tileSource.crossOriginPolicy:this.crossOriginPolicy),y.ajaxWithCredentials===void 0&&(y.ajaxWithCredentials=this.ajaxWithCredentials),y.loadTilesWithAjax===void 0&&(y.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(y.ajaxHeaders)||(y.ajaxHeaders={});var V={options:y};function q(G){for(var ye=0;ye<C._loadQueue.length;ye++)if(C._loadQueue[ye]===V){C._loadQueue.splice(ye,1);break}C._loadQueue.length===0&&$(V),C.raiseEvent("add-item-failed",G),y.error&&y.error(G)}function $(G){C.collectionMode&&(C.world.arrange({immediately:G.options.collectionImmediately,rows:C.collectionRows,columns:C.collectionColumns,layout:C.collectionLayout,tileSize:C.collectionTileSize,tileMargin:C.collectionTileMargin}),C.world.setAutoRefigureSizes(!0))}if(e.isArray(y.tileSource)){setTimeout(function(){q({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:y.tileSource,options:y})});return}this._loadQueue.push(V);function ce(){for(var G,ye,Fe;C._loadQueue.length&&(G=C._loadQueue[0],!!G.tileSource);){if(C._loadQueue.splice(0,1),G.options.replace){var be=C.world.getIndexOfItem(G.options.replaceItem);be!==-1&&(G.options.index=be),C.world.removeItem(G.options.replaceItem)}ye=new e.TiledImage({viewer:C,source:G.tileSource,viewport:C.viewport,drawer:C.drawer,tileCache:C.tileCache,imageLoader:C.imageLoader,x:G.options.x,y:G.options.y,width:G.options.width,height:G.options.height,fitBounds:G.options.fitBounds,fitBoundsPlacement:G.options.fitBoundsPlacement,clip:G.options.clip,placeholderFillStyle:G.options.placeholderFillStyle,opacity:G.options.opacity,preload:G.options.preload,degrees:G.options.degrees,flipped:G.options.flipped,compositeOperation:G.options.compositeOperation,springStiffness:C.springStiffness,animationTime:C.animationTime,minZoomImageRatio:C.minZoomImageRatio,wrapHorizontal:C.wrapHorizontal,wrapVertical:C.wrapVertical,maxTilesPerFrame:C.maxTilesPerFrame,immediateRender:C.immediateRender,blendTime:C.blendTime,alwaysBlend:C.alwaysBlend,minPixelRatio:C.minPixelRatio,smoothTileEdgesMinZoom:C.smoothTileEdgesMinZoom,iOSDevice:C.iOSDevice,crossOriginPolicy:G.options.crossOriginPolicy,ajaxWithCredentials:G.options.ajaxWithCredentials,loadTilesWithAjax:G.options.loadTilesWithAjax,ajaxHeaders:G.options.ajaxHeaders,debugMode:C.debugMode,subPixelRoundingForTransparency:C.subPixelRoundingForTransparency}),C.collectionMode&&C.world.setAutoRefigureSizes(!1),C.navigator&&(Fe=e.extend({},G.options,{replace:!1,originalTiledImage:ye,tileSource:G.tileSource}),C.navigator.addTiledImage(Fe)),C.world.addItem(ye,{index:G.options.index}),C._loadQueue.length===0&&$(G),C.world.getItemCount()===1&&!C.preserveViewport&&C.viewport.goHome(!0),G.options.success&&G.options.success({item:ye})}}o(this,y.tileSource,y,function(G){V.tileSource=G,ce()},function(G){G.options=y,q(G),ce()})},addSimpleImage:function(y){e.console.assert(y,"[Viewer.addSimpleImage] options is required"),e.console.assert(y.url,"[Viewer.addSimpleImage] options.url is required");var C=e.extend({},y,{tileSource:{type:"image",url:y.url}});delete C.url,this.addTiledImage(C)},addLayer:function(y){var C=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var V=e.extend({},y,{success:function(q){C.raiseEvent("add-layer",{options:y,drawer:q.item})},error:function(q){C.raiseEvent("add-layer-failed",q)}});return this.addTiledImage(V),this},getLayerAtLevel:function(y){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(y)},getLevelOfLayer:function(y){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(y)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(y,C){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(y,C)},removeLayer:function(y){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(y)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var y=e.delegate(this,g),C=e.delegate(this,v),V=e.delegate(this,this.goToNextPage),q=e.delegate(this,this.goToPreviousPage),$=this.navImages,ce=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(ce=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:ne(this.prefixUrl,$.previous.REST),srcGroup:ne(this.prefixUrl,$.previous.GROUP),srcHover:ne(this.prefixUrl,$.previous.HOVER),srcDown:ne(this.prefixUrl,$.previous.DOWN),onRelease:q,onFocus:y,onBlur:C}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:ne(this.prefixUrl,$.next.REST),srcGroup:ne(this.prefixUrl,$.next.GROUP),srcHover:ne(this.prefixUrl,$.next.HOVER),srcDown:ne(this.prefixUrl,$.next.DOWN),onRelease:V,onFocus:y,onBlur:C}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),ce&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var y=e.delegate(this,ct),C=e.delegate(this,Qt),V=e.delegate(this,hi),q=e.delegate(this,et),$=e.delegate(this,Xt),ce=e.delegate(this,It),G=e.delegate(this,Nt),ye=e.delegate(this,Ut),Fe=e.delegate(this,Oe),be=e.delegate(this,Dt),he=e.delegate(this,g),Xe=e.delegate(this,v),x=this.navImages,T=[],S=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(S=!1),this.showZoomControl&&(T.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:ne(this.prefixUrl,x.zoomIn.REST),srcGroup:ne(this.prefixUrl,x.zoomIn.GROUP),srcHover:ne(this.prefixUrl,x.zoomIn.HOVER),srcDown:ne(this.prefixUrl,x.zoomIn.DOWN),onPress:y,onRelease:C,onClick:V,onEnter:y,onExit:C,onFocus:he,onBlur:Xe})),T.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:ne(this.prefixUrl,x.zoomOut.REST),srcGroup:ne(this.prefixUrl,x.zoomOut.GROUP),srcHover:ne(this.prefixUrl,x.zoomOut.HOVER),srcDown:ne(this.prefixUrl,x.zoomOut.DOWN),onPress:q,onRelease:C,onClick:$,onEnter:q,onExit:C,onFocus:he,onBlur:Xe}))),this.showHomeControl&&T.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:ne(this.prefixUrl,x.home.REST),srcGroup:ne(this.prefixUrl,x.home.GROUP),srcHover:ne(this.prefixUrl,x.home.HOVER),srcDown:ne(this.prefixUrl,x.home.DOWN),onRelease:ce,onFocus:he,onBlur:Xe})),this.showFullPageControl&&T.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:ne(this.prefixUrl,x.fullpage.REST),srcGroup:ne(this.prefixUrl,x.fullpage.GROUP),srcHover:ne(this.prefixUrl,x.fullpage.HOVER),srcDown:ne(this.prefixUrl,x.fullpage.DOWN),onRelease:G,onFocus:he,onBlur:Xe})),this.showRotationControl&&(T.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:ne(this.prefixUrl,x.rotateleft.REST),srcGroup:ne(this.prefixUrl,x.rotateleft.GROUP),srcHover:ne(this.prefixUrl,x.rotateleft.HOVER),srcDown:ne(this.prefixUrl,x.rotateleft.DOWN),onRelease:ye,onFocus:he,onBlur:Xe})),T.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:ne(this.prefixUrl,x.rotateright.REST),srcGroup:ne(this.prefixUrl,x.rotateright.GROUP),srcHover:ne(this.prefixUrl,x.rotateright.HOVER),srcDown:ne(this.prefixUrl,x.rotateright.DOWN),onRelease:Fe,onFocus:he,onBlur:Xe}))),this.showFlipControl&&T.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:ne(this.prefixUrl,x.flip.REST),srcGroup:ne(this.prefixUrl,x.flip.GROUP),srcHover:ne(this.prefixUrl,x.flip.HOVER),srcDown:ne(this.prefixUrl,x.flip.DOWN),onRelease:be,onFocus:he,onBlur:Xe})),S?(this.buttonGroup=new e.ButtonGroup({buttons:T,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,bt)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=T),this},currentPage:function(){return this._sequenceIndex},goToPage:function(y){return this.tileSources&&y>=0&&y<this.tileSources.length&&(this._sequenceIndex=y,this._updateSequenceButtons(y),this.open(this.tileSources[y]),this.referenceStrip&&this.referenceStrip.setFocus(y),this.raiseEvent("page",{page:y})),this},addOverlay:function(y,C,V,q){var $;if(e.isPlainObject(y)?$=y:$={element:y,location:C,placement:V,onDraw:q},y=e.getElement($.element),c(this.currentOverlays,y)>=0)return this;var ce=a(this,$);return this.currentOverlays.push(ce),ce.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:y,location:$.location,placement:$.placement}),this},updateOverlay:function(y,C,V){var q;return y=e.getElement(y),q=c(this.currentOverlays,y),q>=0&&(this.currentOverlays[q].update(C,V),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:y,location:C,placement:V})),this},removeOverlay:function(y){var C;return y=e.getElement(y),C=c(this.currentOverlays,y),C>=0&&(this.currentOverlays[C].destroy(),this.currentOverlays.splice(C,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:y})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(y){var C;return y=e.getElement(y),C=c(this.currentOverlays,y),C>=0?this.currentOverlays[C]:null},_updateSequenceButtons:function(y){this.nextButton&&(!this.tileSources||this.tileSources.length-1===y?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(y>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(y){this._hideMessage();var C=e.makeNeutralElement("div");C.appendChild(document.createTextNode(y)),this.messageDiv=e.makeCenteredNode(C),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var y=this.messageDiv;y&&(y.parentNode.removeChild(y),delete this.messageDiv)},gestureSettingsByDeviceType:function(y){switch(y){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var y,C=this.currentOverlays.length;for(y=0;y<C;y++)this.currentOverlays[y].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var y=e.pixelDensityRatio,C=e.getCurrentPixelDensityRatio();y!==C&&(e.pixelDensityRatio=C,this.forceResize())},goToPreviousPage:function(){var y=this._sequenceIndex-1;this.navPrevNextWrap&&y<0&&(y+=this.tileSources.length),this.goToPage(y)},goToNextPage:function(){var y=this._sequenceIndex+1;this.navPrevNextWrap&&y>=this.tileSources.length&&(y=0),this.goToPage(y)},isAnimating:function(){return i[this.hash].animating}});function r(y){return y=e.getElement(y),new e.Point(y.clientWidth===0?1:y.clientWidth,y.clientHeight===0?1:y.clientHeight)}function o(y,C,V,q,$){var ce=y;if(e.type(C)==="string"){if(C.match(/^\s*<.*>\s*$/))C=e.parseXml(C);else if(C.match(/^\s*[{[].*[}\]]\s*$/))try{var G=e.parseJSON(C);C=G}catch{}}function ye(Fe,be){Fe.ready?q(Fe):(Fe.addHandler("ready",function(){q(Fe)}),Fe.addHandler("open-failed",function(he){$({message:he.message,source:be})}))}setTimeout(function(){if(e.type(C)==="string")C=new e.TileSource({url:C,crossOriginPolicy:V.crossOriginPolicy!==void 0?V.crossOriginPolicy:y.crossOriginPolicy,ajaxWithCredentials:y.ajaxWithCredentials,ajaxHeaders:V.ajaxHeaders?V.ajaxHeaders:y.ajaxHeaders,splitHashDataForPost:y.splitHashDataForPost,success:function(Xe){q(Xe.tileSource)}}),C.addHandler("open-failed",function(Xe){$(Xe)});else if(e.isPlainObject(C)||C.nodeType)if(C.crossOriginPolicy===void 0&&(V.crossOriginPolicy!==void 0||y.crossOriginPolicy!==void 0)&&(C.crossOriginPolicy=V.crossOriginPolicy!==void 0?V.crossOriginPolicy:y.crossOriginPolicy),C.ajaxWithCredentials===void 0&&(C.ajaxWithCredentials=y.ajaxWithCredentials),e.isFunction(C.getTileUrl)){var Fe=new e.TileSource(C);Fe.getTileUrl=C.getTileUrl,q(Fe)}else{var be=e.TileSource.determineType(ce,C);if(!be){$({message:"Unable to load TileSource",source:C});return}var he=be.prototype.configure.apply(ce,[C]);ye(new be(he),C)}else ye(C,C)})}function a(y,C){if(C instanceof e.Overlay)return C;var V=null;if(C.element)V=e.getElement(C.element);else{var q=C.id?C.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);V=e.getElement(C.id),V||(V=document.createElement("a"),V.href="#/overlay/"+q),V.id=q,e.addClass(V,C.className?C.className:"openseadragon-overlay")}var $=C.location,ce=C.width,G=C.height;if(!$){var ye=C.x,Fe=C.y;if(C.px!==void 0){var be=y.viewport.imageToViewportRectangle(new e.Rect(C.px,C.py,ce||0,G||0));ye=be.x,Fe=be.y,ce=ce!==void 0?be.width:void 0,G=G!==void 0?be.height:void 0}$=new e.Point(ye,Fe)}var he=C.placement;return he&&e.type(he)==="string"&&(he=e.Placement[C.placement.toUpperCase()]),new e.Overlay({element:V,location:$,placement:he,onDraw:C.onDraw,checkResize:C.checkResize,width:ce,height:G,rotationMode:C.rotationMode})}function c(y,C){var V;for(V=y.length-1;V>=0;V--)if(y[V].element===C)return V;return-1}function h(y,C){return e.requestAnimationFrame(function(){C(y)})}function d(y){e.requestAnimationFrame(function(){f(y)})}function l(y){y.autoHideControls&&(y.controlsShouldFade=!0,y.controlsFadeBeginTime=e.now()+y.controlsFadeDelay,window.setTimeout(function(){d(y)},y.controlsFadeDelay))}function f(y){var C,V,q,$;if(y.controlsShouldFade){for(C=e.now(),V=C-y.controlsFadeBeginTime,q=1-V/y.controlsFadeLength,q=Math.min(1,q),q=Math.max(0,q),$=y.controls.length-1;$>=0;$--)y.controls[$].autoFade&&y.controls[$].setOpacity(q);q>0&&d(y)}}function p(y){var C;for(y.controlsShouldFade=!1,C=y.controls.length-1;C>=0;C--)y.controls[C].setOpacity(1)}function g(){p(this)}function v(){l(this)}function w(y){var C={tracker:y.eventSource,position:y.position,originalEvent:y.originalEvent,preventDefault:y.preventDefault};this.raiseEvent("canvas-contextmenu",C),y.preventDefault=C.preventDefault}function E(y){var C={originalEvent:y.originalEvent,preventDefaultAction:!1,preventVerticalPan:y.preventVerticalPan||!this.panVertical,preventHorizontalPan:y.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",C),!C.preventDefaultAction&&!y.ctrl&&!y.alt&&!y.meta)switch(y.keyCode){case 38:C.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 40:C.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 37:C.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 39:C.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 87:C.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 83:C.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 65:C.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 68:C.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 82:y.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),y.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:y.preventDefault=!1;break}else y.preventDefault=!1}function I(y){var C={originalEvent:y.originalEvent};this.raiseEvent("canvas-key-press",C)}function L(y){var C,V=document.activeElement===this.canvas;V||this.canvas.focus(),this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x);var q={tracker:y.eventSource,position:y.position,quick:y.quick,shift:y.shift,originalEvent:y.originalEvent,originalTarget:y.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",q),!q.preventDefaultAction&&this.viewport&&y.quick&&(C=this.gestureSettingsByDeviceType(y.pointerType),C.clickToZoom===!0&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,C.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()),C.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function N(y){var C,V={tracker:y.eventSource,position:y.position,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",V),!V.preventDefaultAction&&this.viewport&&(C=this.gestureSettingsByDeviceType(y.pointerType),C.dblClickToZoom&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,C.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()))}function Z(y){var C,V={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,delta:y.delta,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",V),C=this.gestureSettingsByDeviceType(y.pointerType),!V.preventDefaultAction&&this.viewport){if(C.dblClickDragToZoom&&i[this.hash].draggingToZoom){var q=Math.pow(this.zoomPerDblClickDrag,y.delta.y/50);this.viewport.zoomBy(q)}else if(C.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(y.delta.x=0),this.panVertical||(y.delta.y=0),this.viewport.flipped&&(y.delta.x=-y.delta.x),this.constrainDuringPan){var $=this.viewport.deltaPointsFromPixels(y.delta.negate());this.viewport.centerSpringX.target.value+=$.x,this.viewport.centerSpringY.target.value+=$.y;var ce=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=$.x,this.viewport.centerSpringY.target.value-=$.y,ce.xConstrained&&(y.delta.x=0),ce.yConstrained&&(y.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(y.delta.negate()),C.flickEnabled&&!this.constrainDuringPan)}}}function J(y){var C,V={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",V),C=this.gestureSettingsByDeviceType(y.pointerType),!V.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&C.dragToPan&&C.flickEnabled&&y.speed>=C.flickMinSpeed){var q=0;this.panHorizontal&&(q=C.flickMomentum*y.speed*Math.cos(y.direction));var $=0;this.panVertical&&($=C.flickMomentum*y.speed*Math.sin(y.direction));var ce=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),G=this.viewport.pointFromPixel(new e.Point(ce.x-q,ce.y-$));this.viewport.panTo(G,!1)}this.viewport.applyConstraints()}C.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function k(y){this.raiseEvent("canvas-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function A(y){this.raiseEvent("canvas-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function P(y){var C;if(this.raiseEvent("canvas-press",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent}),C=this.gestureSettingsByDeviceType(y.pointerType),C.dblClickDragToZoom){var V=i[this.hash].lastClickTime,q=e.now();if(V===null)return;q-V<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function M(y){this.raiseEvent("canvas-release",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent})}function F(y){this.raiseEvent("canvas-nonprimary-press",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function O(y){this.raiseEvent("canvas-nonprimary-release",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function D(y){var C,V,q,$,ce={tracker:y.eventSource,pointerType:y.pointerType,gesturePoints:y.gesturePoints,lastCenter:y.lastCenter,center:y.center,lastDistance:y.lastDistance,distance:y.distance,shift:y.shift,originalEvent:y.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",ce),this.viewport&&(C=this.gestureSettingsByDeviceType(y.pointerType),C.pinchToZoom&&(!ce.preventDefaultPanAction||!ce.preventDefaultZoomAction)&&(V=this.viewport.pointFromPixel(y.center,!0),C.zoomToRefPoint&&!ce.preventDefaultPanAction&&(q=this.viewport.pointFromPixel(y.lastCenter,!0),$=q.minus(V),this.panHorizontal||($.x=0),this.panVertical||($.y=0),this.viewport.panBy($,!0)),ce.preventDefaultZoomAction||this.viewport.zoomBy(y.distance/y.lastDistance,V,!0),this.viewport.applyConstraints()),C.pinchRotate&&!ce.preventDefaultRotateAction)){var G=Math.atan2(y.gesturePoints[0].currentPos.y-y.gesturePoints[1].currentPos.y,y.gesturePoints[0].currentPos.x-y.gesturePoints[1].currentPos.x),ye=Math.atan2(y.gesturePoints[0].lastPos.y-y.gesturePoints[1].lastPos.y,y.gesturePoints[0].lastPos.x-y.gesturePoints[1].lastPos.x);V=this.viewport.pointFromPixel(y.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(G-ye)*(180/Math.PI),V,!0)}}function B(y){this.raiseEvent("canvas-focus",{tracker:y.eventSource,originalEvent:y.originalEvent})}function Ce(y){this.raiseEvent("canvas-blur",{tracker:y.eventSource,originalEvent:y.originalEvent})}function Re(y){var C,V,q,$,ce;$=e.now(),ce=$-this._lastScrollTime,ce>this.minScrollDeltaTime?(this._lastScrollTime=$,C={tracker:y.eventSource,position:y.position,scroll:y.scroll,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",C),!C.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x),V=this.gestureSettingsByDeviceType(y.pointerType),V.scrollToZoom&&(q=Math.pow(this.zoomPerScroll,y.scroll),this.viewport.zoomBy(q,V.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints())),y.preventDefault=C.preventDefault):y.preventDefault=!0}function He(y){i[this.hash].mouseInside=!0,p(this),this.raiseEvent("container-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function ae(y){y.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||l(this)),this.raiseEvent("container-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function Ee(y){Et(y),y.isOpen()?y._updateRequestId=h(y,Ee):y._updateRequestId=!1}function Pe(y,C){var V=y.viewport,q=V.getZoom(),$=V.getCenter();V.resize(C,y.preserveImageSizeOnResize),V.panTo($,!0);var ce;if(y.preserveImageSizeOnResize)ce=i[y.hash].prevContainerSize.x/C.x;else{var G=new e.Point(0,0),ye=new e.Point(i[y.hash].prevContainerSize.x,i[y.hash].prevContainerSize.y).distanceTo(G),Fe=new e.Point(C.x,C.y).distanceTo(G);ce=Fe/ye*i[y.hash].prevContainerSize.x/C.x}V.zoomTo(q*ce,null,!0),i[y.hash].prevContainerSize=C,i[y.hash].forceRedraw=!0,i[y.hash].needsResize=!1,i[y.hash].forceResize=!1}function Et(y){if(!(y._opening||!i[y.hash])){if(y.autoResize||i[y.hash].forceResize){var C;if(y._autoResizePolling){C=r(y.container);var V=i[y.hash].prevContainerSize;C.equals(V)||(i[y.hash].needsResize=!0)}i[y.hash].needsResize&&Pe(y,C||r(y.container))}var q=y.viewport.update(),$=y.world.update(q)||q;q&&y.raiseEvent("viewport-change"),y.referenceStrip&&($=y.referenceStrip.update(y.viewport)||$);var ce=i[y.hash].animating;!ce&&$&&(y.raiseEvent("animation-start"),p(y));var G=ce&&!$;G&&(i[y.hash].animating=!1),($||G||i[y.hash].forceRedraw||y.world.needsDraw())&&(Ze(y),y._drawOverlays(),y.navigator&&y.navigator.update(y.viewport),i[y.hash].forceRedraw=!1,$&&y.raiseEvent("animation")),G&&(y.raiseEvent("animation-finish"),i[y.hash].mouseInside||l(y)),i[y.hash].animating=$}}function Ze(y){y.imageLoader.clear(),y.world.draw(),y.raiseEvent("update-viewport",{})}function ne(y,C){return y?y+C:C}function ct(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,_t(this)}function et(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,_t(this)}function Qt(){i[this.hash].zooming=!1}function _t(y){e.requestAnimationFrame(e.delegate(y,ri))}function ri(){var y,C,V;i[this.hash].zooming&&this.viewport&&(y=e.now(),C=y-i[this.hash].lastZoomTime,V=Math.pow(i[this.hash].zoomFactor,C/1e3),this.viewport.zoomBy(V),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=y,_t(this))}function hi(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function Xt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function bt(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function It(){this.viewport&&this.viewport.goHome()}function Nt(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function Ut(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y+=this.rotationIncrement:y-=this.rotationIncrement,this.viewport.setRotation(y)}}function Oe(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y-=this.rotationIncrement:y+=this.rotationIncrement,this.viewport.setRotation(y)}}function Dt(){this.viewport.toggleFlip()}e.determineDrawer=function(y){for(let C in t){const V=t[C],q=V.prototype;if(q&&q instanceof t.DrawerBase&&e.isFunction(q.getType)&&q.getType.call(V)===y)return V}return null}}(t),function(e){e.Navigator=function(h){var d=h.viewer,l=this,f,p;h.element||h.id?(h.element?(h.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),h.element.id?h.id=h.element.id:h.id="navigator-"+e.now(),this.element=h.element):this.element=document.getElementById(h.id),h.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(h.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),h.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:h.autoFade},h.position&&(h.position==="BOTTOM_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:h.position==="BOTTOM_LEFT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:h.position==="TOP_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:h.position==="TOP_LEFT"?h.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:h.position==="ABSOLUTE"&&(h.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,h.controlOptions.top=h.top,h.controlOptions.left=h.left,h.controlOptions.height=h.height,h.controlOptions.width=h.width))),this.element.id=h.id,this.element.className+=" navigator",h=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},h,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:h.animationTime,autoResize:!1,minZoomImageRatio:1,background:h.background,opacity:h.opacity,borderColor:h.borderColor,displayRegionColor:h.displayRegionColor}),h.minPixelRatio=this.minPixelRatio=d.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),h.controlOptions.anchor!==e.ControlAnchor.NONE&&function(w,E){w.margin="0px",w.border=E+"px solid "+h.borderColor,w.padding="0px",w.background=h.background,w.opacity=h.opacity,w.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(w,E){w.position="relative",w.top="0px",w.left="0px",w.fontSize="0px",w.overflow="hidden",w.border=E+"px solid "+h.displayRegionColor,w.margin="0px",w.padding="0px",w.background="transparent",w.float="left",w.cssFloat="left",w.zIndex=999999999,w.cursor="default",w.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),d.addControl(this.element,h.controlOptions),this._resizeWithViewer=h.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&h.controlOptions.anchor!==e.ControlAnchor.NONE,h.width&&h.height?(this.setWidth(h.width),this.setHeight(h.height)):this._resizeWithViewer&&(f=e.getElementSize(d.element),this.element.style.height=Math.round(f.y*h.sizeRatio)+"px",this.element.style.width=Math.round(f.x*h.sizeRatio)+"px",this.oldViewerSize=f,p=e.getElementSize(this.element),this.elementArea=p.x*p.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[h]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function g(w,E){a(l.displayRegionContainer,w),a(l.displayRegion,-w),l.viewport.setRotation(w,E)}if(h.navigatorRotate){var v=h.viewer.viewport?h.viewer.viewport.getRotation():h.viewer.degrees||0;g(v,!0),h.viewer.addHandler("rotate",function(w){g(w.degrees,w.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(w){w.eventType==="wheel"&&(w.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){l.viewport&&l.viewport.goHome(!0)}),d.world.addHandler("item-index-change",function(w){window.setTimeout(function(){var E=l.world.getItemAt(w.previousIndex);l.world.setItemIndex(E,w.newIndex)},1)}),d.world.addHandler("remove-item",function(w){var E=w.item,I=l._getMatchingItem(E);I&&l.world.removeItem(I)}),this.update(d.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var h=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);h.equals(this.oldContainerSize)||(this.viewport.resize(h,!0),this.viewport.goHome(!0),this.oldContainerSize=h,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(h){this.width=h,this.element.style.width=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(h){this.height=h,this.element.style.height=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(h){return this.viewport.setFlip(h),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(h){c(this.canvas,h),c(this.element,h)},update:function(h){var d,l,f,p,g,v;if(h||(h=this.viewer.viewport),d=e.getElementSize(this.viewer.element),this._resizeWithViewer&&d.x&&d.y&&!d.equals(this.oldViewerSize)&&(this.oldViewerSize=d,this.maintainSizeRatio||!this.elementArea?(l=d.x*this.sizeRatio,f=d.y*this.sizeRatio):(l=Math.sqrt(this.elementArea*(d.x/d.y)),f=this.elementArea/l),this.element.style.width=Math.round(l)+"px",this.element.style.height=Math.round(f)+"px",this.elementArea||(this.elementArea=l*f),this.updateSize()),h&&this.viewport){if(p=h.getBoundsNoRotate(!0),g=this.viewport.pixelFromPointNoRotate(p.getTopLeft(),!1),v=this.viewport.pixelFromPointNoRotate(p.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var w=h.getRotation(!0);a(this.displayRegion,-w)}var E=this.displayRegion.style;E.display=this.world.getItemCount()?"block":"none",E.top=g.y.toFixed(2)+"px",E.left=g.x.toFixed(2)+"px";var I=v.x-g.x,L=v.y-g.y;E.width=Math.round(Math.max(I,0))+"px",E.height=Math.round(Math.max(L,0))+"px"}},addTiledImage:function(h){var d=this,l=h.originalTiledImage;delete h.original;var f=e.extend({},h,{success:function(p){var g=p.item;g._originalForNavigator=l,d._matchBounds(g,l,!0),d._matchOpacity(g,l),d._matchCompositeOperation(g,l);function v(){d._matchBounds(g,l)}function w(){d._matchOpacity(g,l)}function E(){d._matchCompositeOperation(g,l)}l.addHandler("bounds-change",v),l.addHandler("clip-change",v),l.addHandler("opacity-change",w),l.addHandler("composite-operation-change",E)}});return e.Viewer.prototype.addTiledImage.apply(this,[f])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(h){for(var d=this.world.getItemCount(),l,f=0;f<d;f++)if(l=this.world.getItemAt(f),l._originalForNavigator===h)return l;return null},_matchBounds:function(h,d,l){var f=d.getBoundsNoRotate();h.setPosition(f.getTopLeft(),l),h.setWidth(f.width,l),h.setRotation(d.getRotation(),l),h.setClip(d.getClip()),h.setFlip(d.getFlip())},_matchOpacity:function(h,d){h.setOpacity(d.opacity)},_matchCompositeOperation:function(h,d){h.setCompositeOperation(d.compositeOperation)}});function i(h){var d={tracker:h.eventSource,position:h.position,quick:h.quick,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",d),!d.preventDefaultAction&&h.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(h.position.x=this.viewport.getContainerSize().x-h.position.x);var l=this.viewport.pointFromPixel(h.position);this.panVertical?this.panHorizontal||(l.x=this.viewer.viewport.getCenter(!0).x):l.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(l),this.viewer.viewport.applyConstraints()}}function n(h){var d={tracker:h.eventSource,position:h.position,delta:h.delta,speed:h.speed,direction:h.direction,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",d),!d.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(h.delta.x=0),this.panVertical||(h.delta.y=0),this.viewer.viewport.flipped&&(h.delta.x=-h.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(h.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(h){h.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(h){var d={tracker:h.eventSource,position:h.position,scroll:h.scroll,shift:h.shift,originalEvent:h.originalEvent,preventDefault:h.preventDefault};this.viewer.raiseEvent("navigator-scroll",d),h.preventDefault=d.preventDefault}function a(h,d){c(h,"rotate("+d+"deg)")}function c(h,d){h.style.webkitTransform=d,h.style.mozTransform=d,h.style.msTransform=d,h.style.oTransform=d,h.style.transform=d}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,c=i,h;for(h=0;h<r.length-1;h++)c=c[r[h]]||{};return o=c[r[h]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(d){var l=parseInt(d.match(/\d+/),10)+1;return l<a.length?a[l]:""})},setString:function(n,r){var o=n.split("."),a=i,c;for(c=0;c<o.length-1;c++)a[o[c]]||(a[o[c]]={}),a=a[o[c]];a[o[c]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var c=i*Math.PI/180;r=Math.cos(c),o=Math.sin(c)}var h=r*(this.x-n.x)-o*(this.y-n.y)+n.x,d=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(h,d)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,c,h){var d=this,l=arguments,f,p;if(e.isPlainObject(n)?f=n:f={width:l[0],height:l[1],tileSize:l[2],tileOverlap:l[3],minLevel:l[4],maxLevel:l[5]},e.EventSource.call(this),e.extend(!0,this,f),!this.success){for(p=0;p<arguments.length;p++)if(e.isFunction(arguments[p])){this.success=arguments[p];break}}this.success&&this.addHandler("ready",function(g){d.success(g)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=f.width&&f.height?f.width/f.height:1,this.dimensions=new e.Point(f.width,f.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=f.tileOverlap?f.tileOverlap:0,this.minLevel=f.minLevel?f.minLevel:0,this.maxLevel=f.maxLevel!==void 0&&f.maxLevel!==null?f.maxLevel:f.width&&f.height?Math.ceil(Math.log(Math.max(f.width,f.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),c=r.x*a,h=r.y*a,d=Math.floor(c/this.getTileWidth(n)),l=Math.floor(h/this.getTileHeight(n));r.x>=1&&(d=this.getNumTiles(n).x-1);var f=1e-15;return r.y>=1/this.aspectRatio-f&&(l=this.getNumTiles(n).y-1),new e.Point(d,l)},getTileBounds:function(n,r,o,a){var c=this.dimensions.times(this.getLevelScale(n)),h=this.getTileWidth(n),d=this.getTileHeight(n),l=r===0?0:h*r-this.tileOverlap,f=o===0?0:d*o-this.tileOverlap,p=h+(r===0?1:2)*this.tileOverlap,g=d+(o===0?1:2)*this.tileOverlap,v=1/c.x;return p=Math.min(p,c.x-l),g=Math.min(g,c.y-f),a?new e.Rect(0,0,p,g):new e.Rect(l*v,f*v,p*v,g*v)},getImageInfo:function(n){var r=this,o,a,c,h,d,l,f;n&&(d=n.split("/"),l=d[d.length-1],f=l.lastIndexOf("."),f>-1&&(d[d.length-1]=l.slice(0,f)));var p=null;if(this.splitHashDataForPost){var g=n.indexOf("#");g!==-1&&(p=n.substring(g+1),n=n.substr(0,g))}a=function(v){typeof v=="string"&&(v=e.parseXml(v));var w=e.TileSource.determineType(r,v,n);if(!w){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}h=w.prototype.configure.apply(r,[v,n,p]),h.ajaxWithCredentials===void 0&&(h.ajaxWithCredentials=r.ajaxWithCredentials),c=new w(h),r.ready=!0,r.raiseEvent("ready",{tileSource:c})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:p,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(v){var w=i(v);a(w)},error:function(v,w){var E;try{E="HTTP "+v.status+" attempting to load TileSource: "+n}catch{var I;typeof w>"u"||!w.toString?I="Unknown error":I=w.toString(),E=I+" attempting to load TileSource: "+n}e.console.error(E),r.raiseEvent("open-failed",{message:E,source:n,postData:p})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,c,h){function d(l){return c?l+"+"+JSON.stringify(c):l}return d(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(c){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(c?null:o,r.request,c)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(c){var h;try{h=new window.Blob([c.response])}catch(f){var d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(f.name==="TypeError"&&d){var l=new d;l.append(c.response),h=l.getBlob()}}h.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(h)},error:function(c){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,c;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{c=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{c=n.responseText}else if(r.match(/\s*[{[].*/))try{c=e.parseJSON(r)}catch{c=r}else c=r;return c}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,c,h,d,l,f,p){var g,v,w,E;if(e.isPlainObject(r)?E=r:E={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=E.tilesUrl,this.fileFormat=E.fileFormat,this.displayRects=E.displayRects,this.displayRects)for(g=this.displayRects.length-1;g>=0;g--)for(v=this.displayRects[g],w=v.minLevel;w<=v.maxLevel;w++)this._levelRects[w]||(this._levelRects[w]=[]),this._levelRects[w].push(v);e.TileSource.apply(this,[E])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var c;return e.isPlainObject(r)?c=n(this,r):c=i(this,r),o&&!c.tilesUrl&&(c.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?c.queryParams=o.match(/\?.*/):c.queryParams=""),c},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var c=this._levelRects[r],h,d,l,f,p,g,v;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!c||!c.length)return!0;for(v=c.length-1;v>=0;v--)if(h=c[v],!(r<h.minLevel||r>h.maxLevel)&&(d=this.getLevelScale(r),l=h.x*d,f=h.y*d,p=l+h.width*d,g=f+h.height*d,l=Math.floor(l/this._tileWidth),f=Math.floor(f/this._tileWidth),p=Math.ceil(p/this._tileWidth),g=Math.ceil(g/this._tileWidth),l<=o&&o<p&&f<=a&&a<g))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,c=a.localName||a.tagName,h=o.documentElement.namespaceURI,d=null,l=[],f,p,g,v,w;if(c==="Image")try{if(v=a.getElementsByTagName("Size")[0],v===void 0&&(v=a.getElementsByTagNameNS(h,"Size")[0]),d={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(v.getAttribute("Height"),10),Width:parseInt(v.getAttribute("Width"),10)}}},!e.imageFormatSupported(d.Image.Format))throw new Error(e.getString("Errors.ImageFormat",d.Image.Format.toUpperCase()));for(f=a.getElementsByTagName("DisplayRect"),f===void 0&&(f=a.getElementsByTagNameNS(h,"DisplayRect")[0]),w=0;w<f.length;w++)p=f[w],g=p.getElementsByTagName("Rect")[0],g===void 0&&(g=p.getElementsByTagNameNS(h,"Rect")[0]),l.push({Rect:{X:parseInt(g.getAttribute("X"),10),Y:parseInt(g.getAttribute("Y"),10),Width:parseInt(g.getAttribute("Width"),10),Height:parseInt(g.getAttribute("Height"),10),MinLevel:parseInt(p.getAttribute("MinLevel"),10),MaxLevel:parseInt(p.getAttribute("MaxLevel"),10)}});return l.length&&(d.Image.DisplayRect=l),n(r,d)}catch(L){throw L instanceof Error?L:new Error(e.getString("Errors.Dzi"))}else{if(c==="Collection")throw new Error(e.getString("Errors.Dzc"));if(c==="Error"){var E=a.getElementsByTagName("Message")[0],I=E.firstChild.nodeValue;throw new Error(I)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,c=a.Url,h=a.Format,d=a.Size,l=a.DisplayRect||[],f=parseInt(d.Width,10),p=parseInt(d.Height,10),g=parseInt(a.TileSize,10),v=parseInt(a.Overlap,10),w=[],E,I;for(I=0;I<l.length;I++)E=l[I].Rect,w.push(new e.DisplayRect(parseInt(E.X,10),parseInt(E.Y,10),parseInt(E.Width,10),parseInt(E.Height,10),parseInt(E.MinLevel,10),parseInt(E.MaxLevel,10)));return e.extend(!0,{width:f,height:p,tileSize:g,tileOverlap:v,minLevel:null,maxLevel:null,tilesUrl:c,fileFormat:h,displayRects:w},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var c=0;c<this.tiles.length;c++)for(var h=0;h<this.tiles[c].scaleFactors.length;h++){var d=this.tiles[c].scaleFactors[h];this.scale_factors.push(d),a.tileSizePerScaleFactor[d]={width:this.tiles[c].width,height:this.tiles[c].height||this.tiles[c].width}}}else if(i(a)){for(var l=Math.min(this.height,this.width),f=[256,512,1024],p=[],g=0;g<f.length;g++)f[g]<=l&&p.push(f[g]);p.length>0?a.tileSize=Math.max.apply(null,p):a.tileSize=l}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var v=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(v)*Math.LOG2E)}if(this.sizes){var w=this.sizes.length;(w===a.maxLevel||w===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((E,I)=>E.width-I.width),w===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,c){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,c,h){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=c.replace("/info.json",""),a.version=1;else{var l=a["@context"];if(Array.isArray(l)){for(var f=0;f<l.length;f++)if(typeof l[f]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(l[f])||l[f]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){l=l[f];break}}switch(l){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var p=0;p<a.preferredFormats.length;p++)if(t.imageFormatSupported(a.preferredFormats[p])){a.tileFormat=a.preferredFormats[p];break}}return a}else{var d=r(a);return d["@context"]="http://iiif.io/api/image/1.0/context.json",d["@id"]=c.replace("/info.xml",""),d.version=1,d}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var c=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(c=this.levels[a].width/this.levels[this.maxLevel].width),c}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var c=this.getLevelScale(a);return c?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var h=this.levelSizes[a],d=Math.ceil(h.width/this.getTileWidth(a)),l=Math.ceil(h.height/this.getTileHeight(a));return new e.Point(d,l)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,c){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var h=c.x>=0&&c.x<=1&&c.y>=0&&c.y<=1/this.aspectRatio;e.console.assert(h,"[TileSource.getTileAtPoint] must be called with a valid point.");var d=this.levelSizes[a].width,l=c.x*d,f=c.y*d,p=Math.floor(l/this.getTileWidth(a)),g=Math.floor(f/this.getTileHeight(a));c.x>=1&&(p=this.getNumTiles(a).x-1);var v=1e-15;return c.y>=1/this.aspectRatio-v&&(g=this.getNumTiles(a).y-1),new e.Point(p,g)}return e.TileSource.prototype.getTileAtPoint.call(this,a,c)},getTileUrl:function(a,c,h){if(this.emulateLegacyImagePyramid){var d=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(d=this.levels[a].url),d}var l="0",f=Math.pow(.5,this.maxLevel-a),p,g,v,w,E,I,L,N,Z,J,k,A,P,M,F,O;return this.levelSizes?(p=this.levelSizes[a].width,g=this.levelSizes[a].height):(p=Math.ceil(this.width*f),g=Math.ceil(this.height*f)),v=this.getTileWidth(a),w=this.getTileHeight(a),E=Math.round(v/f),I=Math.round(w/f),this.version===1?F="native."+this.tileFormat:F="default."+this.tileFormat,p<v&&g<w?(this.version===2&&p===this.width?A="full":this.version===3&&p===this.width&&g===this.height?A="max":this.version===3?A=p+","+g:A=p+",",L="full"):(N=c*E,Z=h*I,J=Math.min(E,this.width-N),k=Math.min(I,this.height-Z),c===0&&h===0&&J===this.width&&k===this.height?L="full":L=[N,Z,J,k].join(","),P=Math.min(v,p-c*v),M=Math.min(w,g-h*w),this.version===2&&P===this.width?A="full":this.version===3&&P===this.width&&M===this.height?A="max":this.version===3?A=P+","+M:A=P+","),O=[this._id,L,A,l,F].join("/"),O},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var c=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],h=Array.isArray(a.profile)?a.profile[0]:a.profile,d=c.indexOf(h)!==-1,l=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(l=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(l=a.extraFeatures.indexOf("sizeByWh")!==-1),!d||l}function n(a){for(var c=[],h=0;h<a.sizes.length;h++)c.push({url:a._id+"/full/"+a.sizes[h].width+","+(a.version===3?a.sizes[h].height:"")+"/0/default."+a.tileFormat,width:a.sizes[h].width,height:a.sizes[h].height});return c.sort(function(d,l){return d.width-l.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null;if(h==="info")try{return d={},o(c,d),d}catch(l){throw l instanceof Error?l:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,c,h){var d,l;if(a.nodeType===3&&h)l=a.nodeValue.trim(),l.match(/^\d*$/)&&(l=Number(l)),c[h]?(e.isArray(c[h])||(c[h]=[c[h]]),c[h].push(l)):c[h]=l;else if(a.nodeType===1)for(d=0;d<a.childNodes.length;d++)o(a.childNodes[d],c,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!c.width||!c.height)&&(c.width=65572864,c.height=65572864),c.tileSize||(c.tileSize=256,c.tileOverlap=0),c.tilesUrl||(c.tilesUrl="http://tile.openstreetmap.org/"),c.minLevel=8,e.TileSource.apply(this,[c])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var h=Math.ceil(c.width/256)*256,d=Math.ceil(c.height/256)*256,l;h>d?l=h/256:l=d/256,c.maxLevel=Math.ceil(Math.log(l)/Math.log(2))-1,c.tileSize=256,c.width=h,c.height=d,e.TileSource.apply(this,[c])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},c=0;c<i;c++)a=this.gridSize[c],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,c,h;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(c=a.levels[a.levels.length-1].width,h=a.levels[a.levels.length-1].height):(c=0,h=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:c,height:h,tileSize:Math.max(h,c),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,c){var h;return e.isPlainObject(o)?h=r(this,o):h=n(this,o),h},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,c){var h=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(h=this.levels[o].url),h}});function i(o){var a=[],c,h;for(h=0;h<o.length;h++)c=o[h],c.height&&c.width&&c.url?a.push({url:c.url,width:Number(c.width),height:Number(c.height)}):e.console.error("Unsupported image format: %s",c.url?c.url:"<no URL>");return a.sort(function(d,l){return d.height-l.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null,l=[],f,p;if(h==="image")try{for(d={type:c.getAttribute("type"),levels:[]},l=c.getElementsByTagName("level"),p=0;p<l.length;p++)f=l[p],d.levels.push({url:f.getAttribute("url"),width:parseInt(f.getAttribute("width"),10),height:parseInt(f.getAttribute("height"),10)});return r(o,d)}catch(g){throw g instanceof Error?g:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(h==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(h==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+h)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var c=document.createElement("canvas"),h=c.getContext("2d");c.width=n,c.height=r,h.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:h,width:n,height:r}),o=c,a=h}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(h){var d=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},h),this.element=h.element||e.makeNeutralElement("div"),h.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(l){l.insideElementPressed?(a(d,e.ButtonState.DOWN),d.raiseEvent("enter",{originalEvent:l.originalEvent})):l.buttonDownAny||a(d,e.ButtonState.HOVER)},focusHandler:function(l){d.tracker.enterHandler(l),d.raiseEvent("focus",{originalEvent:l.originalEvent})},leaveHandler:function(l){c(d,e.ButtonState.GROUP),l.insideElementPressed&&d.raiseEvent("exit",{originalEvent:l.originalEvent})},blurHandler:function(l){d.tracker.leaveHandler(l),d.raiseEvent("blur",{originalEvent:l.originalEvent})},pressHandler:function(l){a(d,e.ButtonState.DOWN),d.raiseEvent("press",{originalEvent:l.originalEvent})},releaseHandler:function(l){l.insideElementPressed&&l.insideElementReleased?(c(d,e.ButtonState.HOVER),d.raiseEvent("release",{originalEvent:l.originalEvent})):l.insideElementPressed?c(d,e.ButtonState.GROUP):a(d,e.ButtonState.HOVER)},clickHandler:function(l){l.quick&&d.raiseEvent("click",{originalEvent:l.originalEvent})},keyHandler:function(l){l.keyCode===13?(d.raiseEvent("click",{originalEvent:l.originalEvent}),d.raiseEvent("release",{originalEvent:l.originalEvent}),l.preventDefault=!0):l.preventDefault=!1}}),c(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){c(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(h){e.requestAnimationFrame(function(){n(h)})}function n(h){var d,l,f;h.shouldFade&&(d=e.now(),l=d-h.fadeBeginTime,f=1-l/h.fadeLength,f=Math.min(1,f),f=Math.max(0,f),h.imgGroup&&e.setElementOpacity(h.imgGroup,f,!0),f>0&&i(h))}function r(h){h.shouldFade=!0,h.fadeBeginTime=e.now()+h.fadeDelay,window.setTimeout(function(){i(h)},h.fadeDelay)}function o(h){h.shouldFade=!1,h.imgGroup&&e.setElementOpacity(h.imgGroup,1,!0)}function a(h,d){h.element.disabled||(d>=e.ButtonState.GROUP&&h.currentState===e.ButtonState.REST&&(o(h),h.currentState=e.ButtonState.GROUP),d>=e.ButtonState.HOVER&&h.currentState===e.ButtonState.GROUP&&(h.imgHover&&(h.imgHover.style.visibility=""),h.currentState=e.ButtonState.HOVER),d>=e.ButtonState.DOWN&&h.currentState===e.ButtonState.HOVER&&(h.imgDown&&(h.imgDown.style.visibility=""),h.currentState=e.ButtonState.DOWN))}function c(h,d){h.element.disabled||(d<=e.ButtonState.HOVER&&h.currentState===e.ButtonState.DOWN&&(h.imgDown&&(h.imgDown.style.visibility="hidden"),h.currentState=e.ButtonState.HOVER),d<=e.ButtonState.GROUP&&h.currentState===e.ButtonState.HOVER&&(h.imgHover&&(h.imgHover.style.visibility="hidden"),h.currentState=e.ButtonState.GROUP),d<=e.ButtonState.REST&&h.currentState===e.ButtonState.GROUP&&(r(h),h.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var c;for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupEnter()},leaveHandler:function(a){var c;if(!a.insideElementPressed)for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var c,h;this.degrees>=270?(c=this.getTopRight(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=270):this.degrees>=180?(c=this.getBottomRight(),this.x=c.x,this.y=c.y,this.degrees-=180):this.degrees>=90&&(c=this.getBottomLeft(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),c=n.minus(i),h=Math.atan(c.y/c.x);return c.x<0?h+=Math.PI:c.y<0&&(h+=2*Math.PI),new e.Rect(i.x,i.y,o,a,h/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),c=Math.max(n.x+n.width,r.x+r.width),h=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,c-o,h-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var c=this.getBottomLeft();i.containsPoint(c,n)&&r.push(c);var h=this.getBottomRight();i.containsPoint(h,n)&&r.push(h);var d=i.getTopLeft();this.containsPoint(d,n)&&r.push(d);var l=i.getTopRight();this.containsPoint(l,n)&&r.push(l);var f=i.getBottomLeft();this.containsPoint(f,n)&&r.push(f);var p=i.getBottomRight();this.containsPoint(p,n)&&r.push(p);for(var g=this._getSegments(),v=i._getSegments(),w=0;w<g.length;w++)for(var E=g[w],I=0;I<v.length;I++){var L=v[I],N=Z(E[0],E[1],L[0],L[1]);N&&r.push(N)}function Z(O,D,B,Ce){var Re=D.minus(O),He=Ce.minus(B),ae=-He.x*Re.y+Re.x*He.y;if(ae===0)return null;var Ee=(Re.x*(O.y-B.y)-Re.y*(O.x-B.x))/ae,Pe=(He.x*(O.y-B.y)-He.y*(O.x-B.x))/ae;return-n<=Ee&&Ee<=1-n&&-n<=Pe&&Pe<=1-n?new e.Point(O.x+Pe*Re.x,O.y+Pe*Re.y):null}if(r.length===0)return null;for(var J=r[0].x,k=r[0].x,A=r[0].y,P=r[0].y,M=1;M<r.length;M++){var F=r[M];F.x<J&&(J=F.x),F.x>k&&(k=F.x),F.y<A&&(A=F.y),F.y>P&&(P=F.y)}return new e.Rect(J,A,k-J,P-A)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(h){var d=1e-15;return Math.abs(h)<d?0:h});var c=Math.atan(a.y/a.x);return a.x<0?c+=Math.PI:a.y<0&&(c+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,c/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),c=Math.max(i.x,n.x,r.x,o.x),h=Math.min(i.y,n.y,r.y,o.y),d=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,h,c-a,d-h)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),c=o.minus(r),h=a.minus(r);return(i.x-r.x)*c.x+(i.y-r.y)*c.y>=-n&&(i.x-o.x)*c.x+(i.y-o.y)*c.y<=n&&(i.x-r.x)*h.x+(i.y-r.y)*h.y>=-n&&(i.x-a.x)*h.x+(i.y-a.y)*h.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(f){var p=this,g=f.viewer,v=e.getElementSize(g.element),w,E,I;for(f.id||(f.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=f.id,this.element.className="referencestrip"),f=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},f,{element:this.element}),e.extend(this,f),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,E=this.element.style,E.marginTop="0px",E.marginRight="0px",E.marginBottom="0px",E.marginLeft="0px",E.left="0px",E.bottom="0px",E.border="0px",E.background="#000",E.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=g,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,c),leaveHandler:e.delegate(this,h),keyDownHandler:e.delegate(this,d),keyHandler:e.delegate(this,l),preProcessEventHandler:function(L){L.eventType==="wheel"&&(L.preventDefault=!0)}}),f.width&&f.height?(this.element.style.width=f.width+"px",this.element.style.height=f.height+"px",g.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):f.scroll==="horizontal"?(this.element.style.width=v.x*f.sizeRatio*g.tileSources.length+12*g.tileSources.length+"px",this.element.style.height=v.y*f.sizeRatio+"px",g.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=v.y*f.sizeRatio*g.tileSources.length+12*g.tileSources.length+"px",this.element.style.width=v.x*f.sizeRatio+"px",g.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=v.x*this.sizeRatio+8,this.panelHeight=v.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},I=0;I<g.tileSources.length;I++)w=e.makeNeutralElement("div"),w.id=this.element.id+"-"+I,w.style.width=p.panelWidth+"px",w.style.height=p.panelHeight+"px",w.style.display="inline",w.style.float="left",w.style.cssFloat="left",w.style.padding="2px",e.setElementTouchActionNone(w),e.setElementPointerEventsNone(w),this.element.appendChild(w),w.activePanel=!1,this.panels.push(w);a(this,this.scroll==="vertical"?v.y:v.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(f){var p=this.element.querySelector("#"+this.element.id+"-"+f),g=e.getElementSize(this.viewer.canvas),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),E=-Number(this.element.style.marginLeft.replace("px","")),I=-Number(this.element.style.marginTop.replace("px","")),L;this.currentSelected!==p&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=p,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(L=Number(f)*(this.panelWidth+3),L>E+g.x-this.panelWidth?(L=Math.min(L,v-g.x),this.element.style.marginLeft=-L+"px",a(this,g.x,-L)):L<E&&(L=Math.max(0,L-g.x/2),this.element.style.marginLeft=-L+"px",a(this,g.x,-L))):(L=Number(f)*(this.panelHeight+3),L>I+g.y-this.panelHeight?(L=Math.min(L,w-g.y),this.element.style.marginTop=-L+"px",a(this,g.y,-L)):L<I&&(L=Math.max(0,L-g.y/2),this.element.style.marginTop=-L+"px",a(this,g.y,-L))),this.currentPage=f,c.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var f in this.miniViewers)this.miniViewers[f].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(f){if(f.quick){var p;this.scroll==="horizontal"?p=Math.floor(f.position.x/(this.panelWidth+4)):p=Math.floor(f.position.y/this.panelHeight),this.viewer.goToPage(p)}this.element.focus()}function r(f){if(this.dragging=!0,this.element){var p=Number(this.element.style.marginLeft.replace("px","")),g=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),E=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-f.delta.x>0?p>-(v-E.x)&&(this.element.style.marginLeft=p+f.delta.x*2+"px",a(this,E.x,p+f.delta.x*2)):-f.delta.x<0&&p<0&&(this.element.style.marginLeft=p+f.delta.x*2+"px",a(this,E.x,p+f.delta.x*2)):-f.delta.y>0?g>-(w-E.y)&&(this.element.style.marginTop=g+f.delta.y*2+"px",a(this,E.y,g+f.delta.y*2)):-f.delta.y<0&&g<0&&(this.element.style.marginTop=g+f.delta.y*2+"px",a(this,E.y,g+f.delta.y*2))}}function o(f){if(this.element){var p=Number(this.element.style.marginLeft.replace("px","")),g=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),E=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?f.scroll>0?p>-(v-E.x)&&(this.element.style.marginLeft=p-f.scroll*60+"px",a(this,E.x,p-f.scroll*60)):f.scroll<0&&p<0&&(this.element.style.marginLeft=p-f.scroll*60+"px",a(this,E.x,p-f.scroll*60)):f.scroll<0?g>E.y-w&&(this.element.style.marginTop=g+f.scroll*60+"px",a(this,E.y,g+f.scroll*60)):f.scroll>0&&g<0&&(this.element.style.marginTop=g+f.scroll*60+"px",a(this,E.y,g+f.scroll*60)),f.preventDefault=!0}}function a(f,p,g){var v,w,E,I,L,N;for(f.scroll==="horizontal"?v=f.panelWidth:v=f.panelHeight,w=Math.ceil(p/v)+5,E=Math.ceil((Math.abs(g)+p)/v)+1,w=E-w,w=w<0?0:w,L=w;L<E&&L<f.panels.length;L++)if(N=f.panels[L],!N.activePanel){var Z,J=f.viewer.tileSources[L];J.referenceStripThumbnailUrl?Z={type:"image",url:J.referenceStripThumbnailUrl}:Z=J,I=new e.Viewer({id:N.id,tileSources:[Z],element:N,navigatorSizeRatio:f.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:f.viewer.loadTilesWithAjax,ajaxHeaders:f.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(I.canvas),e.setElementPointerEventsNone(I.container),I.innerTracker.setTracking(!1),I.outerTracker.setTracking(!1),f.miniViewers[N.id]=I,N.activePanel=!0}}function c(f){var p=f.eventSource.element;this.scroll==="horizontal"?p.style.marginBottom="0px":p.style.marginLeft="0px"}function h(f){var p=f.eventSource.element;this.scroll==="horizontal"?p.style.marginBottom="-"+e.getElementSize(p).y/2+"px":p.style.marginLeft="-"+e.getElementSize(p).x/2+"px"}function d(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}function l(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,c){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=c},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(d){i(o,d,n.callback)},c={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},h=new e.ImageJob(c);!this.jobLimit||this.jobsInProgress<this.jobLimit?(h.start(),this.jobsInProgress++):this.jobQueue.push(h)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,c,h,d,l,f,p,g){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=f,this.exists=a,this._url=c,this.postData=p,this.context2D=h,this.loadWithAjax=d,this.ajaxHeaders=l,g===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),g=e.TileSource.prototype.getTileHashKey(i,n,r,c,l,p)),this.cacheKey=g,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(c){return c%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,c=this.size=o.size,h="";n.overlayPreserveContentDirection&&(h=n.flipped?" scaleX(-1)":" scaleX(1)");var d=n.flipped?-o.rotate:o.rotate,l=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,c,this.element);else{var f=this.style,p=this.element.style;p.display="block",f.left=a.x+"px",f.top=a.y+"px",this.width!==null&&(p.width=c.x+"px"),this.height!==null&&(p.height=c.y+"px");var g=e.getCssPropertyWithVendorPrefix("transformOrigin"),v=e.getCssPropertyWithVendorPrefix("transform");g&&v&&(d&&!n.flipped?(p[v]="",f[g]=this._getTransformOrigin(),f[v]="rotate("+d+"deg)"):!d&&n.flipped?(p[v]=h,f[g]=this._getTransformOrigin(),f[v]=l):d&&n.flipped?(p[v]=h,f[g]=this._getTransformOrigin(),f[v]="rotate("+d+"deg)"+l):(p[v]="",f[g]="",f[v]="")),f.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),c=this._getBoundingBox(a,i.getRotation(!0));n=c.getTopLeft(),r=c.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(c){c.opacity!==0&&a._drawTiles(c)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(d=>d.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var c=a.length-1;c>=0;c--){var h=a[c];this._drawTile(h),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:h})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var c=o.getImage();if(!c)return;o.element=e.makeNeutralElement("div"),o.imgElement=c.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(d){super(d),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let d=e.makeNeutralElement("canvas"),l=this._calculateCanvasSize();return d.width=l.x,d.height=l.y,d}draw(d){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const l of d)l.opacity!==0&&this._drawTiles(l)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(d){return!0}setImageSmoothingEnabled(d){this._imageSmoothingEnabled=!!d,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(d){var l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.strokeStyle=this.debugGridColor[0],l.fillStyle=this.debugGridColor[0],l.strokeRect(d.x*e.pixelDensityRatio,d.y*e.pixelDensityRatio,d.width*e.pixelDensityRatio,d.height*e.pixelDensityRatio),l.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(d,l,f,p){this.viewer.raiseEvent("tile-drawing",{tiledImage:d,context:l,tile:f,rendered:p})}_prepareNewFrame(){var d=this._calculateCanvasSize();if((this.canvas.width!==d.x||this.canvas.height!==d.y)&&(this.canvas.width=d.x,this.canvas.height=d.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var l=this._calculateSketchCanvasSize();this.sketchCanvas.width=l.x,this.sketchCanvas.height=l.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(d,l){var f=this._getContext(d);if(l)f.clearRect(l.x,l.y,l.width,l.height);else{var p=f.canvas;f.clearRect(0,0,p.width,p.height)}}_drawTiles(d){var l=d.getTilesToDraw().map(O=>O.tile);if(!(d.opacity===0||l.length===0&&!d.placeholderFillStyle)){var f=l[0],p;f&&(p=d.opacity<1||d.compositeOperation&&d.compositeOperation!=="source-over"||!d._isBottomItem()&&d.source.hasTransparency(f.context2D,f.getUrl(),f.ajaxHeaders,f.postData));var g,v,w=this.viewport.getZoom(!0),E=d.viewportToImageZoom(w);l.length>1&&E>d.smoothTileEdgesMinZoom&&!d.iOSDevice&&d.getRotation(!0)%360===0&&(p=!0,g=f.getScaleForEdgeSmoothing(),v=f.getTranslationForEdgeSmoothing(g,this._getCanvasSize(!1),this._getCanvasSize(!0)));var I;p&&(g||(I=this.viewport.viewportToViewerElementRectangle(d.getClippedBounds(!0)).getIntegerBoundingBox(),I=I.times(e.pixelDensityRatio)),this._clear(!0,I)),g||this._setRotations(d,p);var L=!1;if(d._clip){this._saveContext(p);var N=d.imageToViewportRectangle(d._clip,!0);N=N.rotate(-d.getRotation(!0),d._getRotationPoint(!0));var Z=this.viewportToDrawerRectangle(N);g&&(Z=Z.times(g)),v&&(Z=Z.translate(v)),this._setClip(Z,p),L=!0}if(d._croppingPolygons){var J=this;L||this._saveContext(p);try{var k=d._croppingPolygons.map(function(O){return O.map(function(D){var B=d.imageToViewportCoordinates(D.x,D.y,!0).rotate(-d.getRotation(!0),d._getRotationPoint(!0)),Ce=J.viewportCoordToDrawerCoord(B);return g&&(Ce=Ce.times(g)),v&&(Ce=Ce.plus(v)),Ce})});this._clipWithPolygons(k,p)}catch(O){e.console.error(O)}L=!0}if(d._hasOpaqueTile=!1,d.placeholderFillStyle&&d._hasOpaqueTile===!1){let O=this.viewportToDrawerRectangle(d.getBoundsNoRotate(!0));g&&(O=O.times(g)),v&&(O=O.translate(v));let D=null;typeof d.placeholderFillStyle=="function"?D=d.placeholderFillStyle(d,this.context):D=d.placeholderFillStyle,this._drawRectangle(O,D,p)}var A=c(d.subPixelRoundingForTransparency),P=!1;if(A===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)P=!0;else if(A===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var M=this.viewer&&this.viewer.isAnimating();P=!M}for(var F=0;F<l.length;F++)f=l[F],this._drawTile(f,d,p,g,v,P,d.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:d,tile:f});L&&this._restoreContext(p),g||(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(p),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(p)),p&&(g&&this._setRotations(d),this.blendSketch({opacity:d.opacity,scale:g,translate:v,compositeOperation:d.compositeOperation,bounds:I}),g&&(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(d,l),this._raiseTiledImageDrawnEvent(d,l)}}_drawDebugInfo(d,l){if(d.debugMode)for(var f=l.length-1;f>=0;f--){var p=l[f];try{this._drawDebugInfoOnTile(p,l.length,f,d)}catch(g){e.console.error(g)}}}_clipWithPolygons(d,l){var f=this._getContext(l);f.beginPath();for(const p of d)for(const[g,v]of p.entries())f[g===0?"moveTo":"lineTo"](v.x,v.y);f.clip()}_drawTile(d,l,f,p,g,v,w){e.console.assert(d,"[Drawer._drawTile] tile is required"),e.console.assert(l,"[Drawer._drawTile] drawingHandler is required");var E=this._getContext(f);p=p||1,this._drawTileToCanvas(d,E,l,p,g,v,w)}_drawTileToCanvas(d,l,f,p,g,v,w){var E=d.position.times(e.pixelDensityRatio),I=d.size.times(e.pixelDensityRatio),L;if(!d.context2D&&!d.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",d.toString());return}if(L=d.getCanvasContext(),!d.loaded||!L){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",d.toString());return}l.save(),typeof p=="number"&&p!==1&&(E=E.times(p),I=I.times(p)),g instanceof e.Point&&(E=E.plus(g)),l.globalAlpha===1&&d.hasTransparency&&(v&&(E.x=Math.round(E.x),E.y=Math.round(E.y),I.x=Math.round(I.x),I.y=Math.round(I.y)),l.clearRect(E.x,E.y,I.x,I.y)),this._raiseTileDrawingEvent(f,l,d,L);var N,Z;d.sourceBounds?(N=Math.min(d.sourceBounds.width,L.canvas.width),Z=Math.min(d.sourceBounds.height,L.canvas.height)):(N=L.canvas.width,Z=L.canvas.height),l.translate(E.x+I.x/2,0),d.flipped&&l.scale(-1,1),l.drawImage(L.canvas,0,0,N,Z,-I.x/2,E.y,I.x,I.y),l.restore()}_getContext(d){var l=this.context;if(d){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var f=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=f.x,this.sketchCanvas.height=f.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var p=this;this.viewer.addHandler("rotate",function g(){if(p.viewport.getRotation()!==0){p.viewer.removeHandler("rotate",g);var v=p._calculateSketchCanvasSize();p.sketchCanvas.width=v.x,p.sketchCanvas.height=v.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}l=this.sketchContext}return l}_saveContext(d){this._getContext(d).save()}_restoreContext(d){this._getContext(d).restore()}_setClip(d,l){var f=this._getContext(l);f.beginPath(),f.rect(d.x,d.y,d.width,d.height),f.clip()}_drawRectangle(d,l,f){var p=this._getContext(f);p.save(),p.fillStyle=l,p.fillRect(d.x,d.y,d.width,d.height),p.restore()}blendSketch(d,l,f,p){var g=d;e.isPlainObject(g)||(g={opacity:d,scale:l,translate:f,compositeOperation:p}),d=g.opacity,p=g.compositeOperation;var v=g.bounds;if(this.context.save(),this.context.globalAlpha=d,p&&(this.context.globalCompositeOperation=p),v)v.x<0&&(v.width+=v.x,v.x=0),v.x+v.width>this.canvas.width&&(v.width=this.canvas.width-v.x),v.y<0&&(v.height+=v.y,v.y=0),v.y+v.height>this.canvas.height&&(v.height=this.canvas.height-v.y),this.context.drawImage(this.sketchCanvas,v.x,v.y,v.width,v.height,v.x,v.y,v.width,v.height);else{l=g.scale||1,f=g.translate;var w=f instanceof e.Point?f:new e.Point(0,0),E=0,I=0;if(f){var L=this.sketchCanvas.width-this.canvas.width,N=this.sketchCanvas.height-this.canvas.height;E=Math.round(L/2),I=Math.round(N/2)}this.context.drawImage(this.sketchCanvas,w.x-E*l,w.y-I*l,(this.canvas.width+2*E)*l,(this.canvas.height+2*I)*l,-E,-I,this.canvas.width+2*E,this.canvas.height+2*I)}this.context.restore()}_drawDebugInfoOnTile(d,l,f,p){var g=this.viewer.world.getIndexOfItem(p)%this.debugGridColor.length,v=this.context;v.save(),v.lineWidth=2*e.pixelDensityRatio,v.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",v.strokeStyle=this.debugGridColor[g],v.fillStyle=this.debugGridColor[g],this._setRotations(p),this._viewportFlipped&&this._flip({point:d.position.plus(d.size.divide(2))}),v.strokeRect(d.position.x*e.pixelDensityRatio,d.position.y*e.pixelDensityRatio,d.size.x*e.pixelDensityRatio,d.size.y*e.pixelDensityRatio);var w=(d.position.x+d.size.x/2)*e.pixelDensityRatio,E=(d.position.y+d.size.y/2)*e.pixelDensityRatio;v.translate(w,E);const I=this.viewport.getRotation(!0);v.rotate(Math.PI/180*-I),v.translate(-w,-E),d.x===0&&d.y===0&&(v.fillText("Zoom: "+this.viewport.getZoom(),d.position.x*e.pixelDensityRatio,(d.position.y-30)*e.pixelDensityRatio),v.fillText("Pan: "+this.viewport.getBounds().toString(),d.position.x*e.pixelDensityRatio,(d.position.y-20)*e.pixelDensityRatio)),v.fillText("Level: "+d.level,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+20)*e.pixelDensityRatio),v.fillText("Column: "+d.x,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+30)*e.pixelDensityRatio),v.fillText("Row: "+d.y,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+40)*e.pixelDensityRatio),v.fillText("Order: "+f+" of "+l,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+50)*e.pixelDensityRatio),v.fillText("Size: "+d.size.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+60)*e.pixelDensityRatio),v.fillText("Position: "+d.position.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),p.getRotation(!0)%360!==0&&this._restoreRotationChanges(),v.restore()}_updateImageSmoothingEnabled(d){d.msImageSmoothingEnabled=this._imageSmoothingEnabled,d.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(d){var l=this._getContext(d).canvas;return new e.Point(l.width,l.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(d,l=!1){var f=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:l,saveContext:f}),f=!1),d.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:d.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(d._getRotationPoint(!0),!0),useSketch:l,saveContext:f})}_offsetForRotation(d){var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(d.useSketch);f.save(),f.translate(l.x,l.y),f.rotate(Math.PI/180*d.degrees),f.translate(-l.x,-l.y)}_flip(d){d=d||{};var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(d.useSketch);f.translate(l.x,0),f.scale(-1,1),f.translate(-l.x,0)}_restoreRotationChanges(d){var l=this._getContext(d);l.restore()}_calculateCanvasSize(){var d=e.pixelDensityRatio,l=this.viewport.getContainerSize();return{x:Math.round(l.x*d),y:Math.round(l.y*d)}}_calculateSketchCanvasSize(){var d=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return d;var l=Math.ceil(Math.sqrt(d.x*d.x+d.y*d.y));return{x:l,y:l}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(h){return h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(h){return o(h)?r:h}function c(h){if(typeof h=="number")return a(h);if(!h||!e.Browser)return r;var d=h[e.Browser.vendor];return o(d)&&(d=h["*"]),a(d)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let c=0;c<o;++c)r.activeTexture(r.TEXTURE0+c),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let c={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},h=this.viewport.flipped?-1:1,d=e.Mat3.makeTranslation(-c.center.x,-c.center.y),l=e.Mat3.makeScaling(2/c.bounds.width*h,-2/c.bounds.height),f=e.Mat3.makeRotation(-c.rotation),p=l.multiply(f).multiply(d);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let g=!1;r.forEach((v,w)=>{if(v.isTainted()){g&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),g=!1);const E=this._getBackupCanvasDrawer();E.draw([v]),this._outputContext.drawImage(E.canvas,0,0)}else{let E=v.getTilesToDraw();if(v.placeholderFillStyle&&v._hasOpaqueTile===!1&&this._drawPlaceholder(v),E.length===0||v.getOpacity()===0)return;let I=E[0],L=v.compositeOperation||this.viewer.compositeOperation||v._clip||v._croppingPolygons||v.debugMode,N=L||v.opacity<1||I.hasTransparency;L&&(g&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),N?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let Z=p,J=v.getRotation(!0);if(J%360!==0){let O=e.Mat3.makeRotation(-J*Math.PI/180),D=v.getBoundsNoRotate(!0).getCenter(),B=e.Mat3.makeTranslation(D.x,D.y),Ce=e.Mat3.makeTranslation(-D.x,-D.y),Re=B.multiply(O).multiply(Ce);Z=p.multiply(Re)}let k=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(k<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${k}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let A=new Float32Array(k*12),P=new Array(k),M=new Array(k),F=new Array(k);for(let O=0;O<E.length;O++){let D=E[O].tile,B=O%k,Ce=B+1,Re=D.getCanvasContext(),He=Re?this._TextureMap.get(Re.canvas):null;if(He||(this._tileReadyHandler({tile:D,tiledImage:v}),He=Re?this._TextureMap.get(Re.canvas):null),He&&this._getTileData(D,v,He,Z,B,A,P,M,F),Ce===k||O===E.length-1){for(let ae=0;ae<=Ce;ae++)o.activeTexture(o.TEXTURE0+ae),o.bindTexture(o.TEXTURE_2D,P[ae]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,A,o.DYNAMIC_DRAW),M.forEach((ae,Ee)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[Ee],!1,ae)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(F)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*Ce)}}N&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,v.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),g=!0,L&&(this._applyContext2dPipeline(v,E,w),g=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),w===0&&this._raiseTiledImageDrawnEvent(v,E.map(O=>O.tile))}}),g&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const c=this.viewer.viewport.getFlip();c&&this._flip(),this._drawDebugInfo(o,r,c),c&&this._flip()}}_getTileData(r,o,a,c,h,d,l,f,p){let g=a.texture,v=a.position;d.set(v,h*12);let w=this._calculateOverlapFraction(r,o),E=r.positionedBounds.width*w.x,I=r.positionedBounds.height*w.y,L=r.positionedBounds.x+(r.x===0?0:E),N=r.positionedBounds.y+(r.y===0?0:I),Z=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:E),J=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:I),k=Z-L,A=J-N,P=new e.Mat3([k,0,0,0,A,0,L,N,1]);if(r.flipped){let F=e.Mat3.makeTranslation(.5,0),O=e.Mat3.makeTranslation(-.5,0),D=F.multiply(e.Mat3.makeScaling(-1,1)).multiply(O);P=P.multiply(D)}let M=c.multiply(P);p[h]=r.opacity,l[h]=g,f[h]=M.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(g=>`uniform mat3 u_matrix_${g};`).join(`
`),a=()=>[...Array(r).keys()].map(g=>`${g>0?"else ":""}if(int(a_index) == ${g}) { transform_matrix = u_matrix_${g}; }`).join(`
`);const c=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,h=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let d=this._gl,l=this.constructor.initShaderProgram(d,c,h);d.useProgram(l),this._firstPass={shaderProgram:l,aOutputPosition:d.getAttribLocation(l,"a_output_position"),aTexturePosition:d.getAttribLocation(l,"a_texture_position"),aIndex:d.getAttribLocation(l,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(g=>d.getUniformLocation(l,`u_matrix_${g}`)),uImages:d.getUniformLocation(l,"u_images"),uOpacities:d.getUniformLocation(l,"u_opacities"),bufferOutputPosition:d.createBuffer(),bufferTexturePosition:d.createBuffer(),bufferIndex:d.createBuffer()},d.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let f=new Float32Array(r*12);for(let g=0;g<r;++g)f.set(Float32Array.from(this._unitQuad),g*12);d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),d.bufferData(d.ARRAY_BUFFER,f,d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aOutputPosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),d.enableVertexAttribArray(this._firstPass.aTexturePosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferIndex);let p=[...Array(this._glNumTextures).keys()].map(g=>Array(6).fill(g)).flat();d.bufferData(d.ARRAY_BUFFER,new Float32Array(p),d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,c=this.constructor.initShaderProgram(a,r,o);a.useProgram(c),this._secondPass={shaderProgram:c,aOutputPosition:a.getAttribLocation(c,"a_output_position"),aTexturePosition:a.getAttribLocation(c,"a_texture_position"),uMatrix:a.getUniformLocation(c,"u_matrix"),uImage:a.getUniformLocation(c,"u_image"),uOpacityMultiplier:a.getUniformLocation(c,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let h=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,h.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,c){return new Float32Array([r,c,o,c,r,a,r,a,o,c,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let c=o.getCanvasContext(),h=c&&c.canvas;if(!h||e.isCanvasTainted(h)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(h)){let l=this._gl,f=l.createTexture(),p,g=a.source.tileOverlap,v,w;if(o.sourceBounds?(v=Math.min(o.sourceBounds.width,h.width)/h.width,w=Math.min(o.sourceBounds.height,h.height)/h.height):(v=1,w=1),g>0){let I=this._calculateOverlapFraction(o,a),L=(o.x===0?0:I.x)*v,N=(o.y===0?0:I.y)*w,Z=(o.isRightMost?1:1-I.x)*v,J=(o.isBottomMost?1:1-I.y)*w;p=this._makeQuadVertexBuffer(L,Z,N,J)}else v===1&&w===1?p=this._unitQuad:p=this._makeQuadVertexBuffer(0,v,0,w);let E={texture:f,position:p};this._TextureMap.set(h,E),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,f),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,this._textureFilter()),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(c)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,c=r.sourceBounds.width,h=r.sourceBounds.height,d=(r.x===0?0:a)+(r.isRightMost?0:a),l=(r.y===0?0:a)+(r.isBottomMost?0:a),f=a/(c+d),p=a/(h+l);return{x:f,y:p}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(c){e.console.error("Error uploading image data to WebGL",c)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)});this._clippingContext.beginPath(),a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var c=r.length-1;c>=0;c--){var h=r[c].tile;try{this._drawDebugInfoOnTile(h,r.length,c,o,a)}catch(d){e.console.error(d)}}}_drawDebugInfoOnTile(r,o,a,c,h){var d=this.viewer.world.getIndexOfItem(c)%this.debugGridColor.length,l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",l.strokeStyle=this.debugGridColor[d],l.fillStyle=this.debugGridColor[d],this._setRotations(c),h&&this._flip({point:r.position.plus(r.size.divide(2))}),l.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var f=(r.position.x+r.size.x/2)*e.pixelDensityRatio,p=(r.position.y+r.size.y/2)*e.pixelDensityRatio;l.translate(f,p);const g=this.viewport.getRotation(!0);l.rotate(Math.PI/180*-g),l.translate(-f,-p),r.x===0&&r.y===0&&(l.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),l.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),l.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),l.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),l.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),l.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),l.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),l.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),c.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),c=this._outputContext;let h;typeof r.placeholderFillStyle=="function"?h=r.placeholderFillStyle(r,c):h=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),c.fillStyle=h,c.translate(a.x,a.y),c.rotate(Math.PI/180*o.degrees),c.translate(-a.x,-a.y),c.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function c(f,p,g){const v=f.createShader(p);return f.shaderSource(v,g),f.compileShader(v),f.getShaderParameter(v,f.COMPILE_STATUS)?v:(e.console.error(`An error occurred compiling the shaders: ${f.getShaderInfoLog(v)}`),f.deleteShader(v),null)}const h=c(r,r.VERTEX_SHADER,o),d=c(r,r.FRAGMENT_SHADER,a),l=r.createProgram();return r.attachShader(l,h),r.attachShader(l,d),r.linkProgram(l),r.getProgramParameter(l,r.LINK_STATUS)?l:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(l)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,c,h,d,l,f,p;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),c=1/a,h=c/this.getAspectRatio(),d=new e.Rect(n.x-c/2,n.y-h/2,c,h),l=this._pixelFromPoint(this.zoomPoint,d),f=l.minus(o).rotate(-this.getRotation(!0)),p=f.divide(this._containerInnerSize.x*a),r.plus(p)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var c=n.x+n.width,h=r.x+r.width,d,l,f;n.width>r.width?d=this.visibilityRatio*r.width:d=this.visibilityRatio*n.width,l=r.x-c+d,f=h-n.x-d,d>r.width?(n.x+=(l+f)/2,o=!0):f<0?(n.x+=f,o=!0):l>0&&(n.x+=l,o=!0)}if(!this.wrapVertical){var p=n.y+n.height,g=r.y+r.height,v,w,E;n.height>r.height?v=this.visibilityRatio*r.height:v=this.visibilityRatio*n.height,w=r.y-p+v,E=g-n.y-v,v>r.height?(n.y+=(w+E)/2,a=!0):E<0?(n.y+=E,a=!0):w>0&&(n.y+=w,a=!0)}var I=o||a,L=I?this.viewerElementToViewportRectangle(n):i.clone();return L.xConstrained=o,L.yConstrained=a,L.constraintApplied=I,L},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),c=i.getCenter(),h=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();h.getAspectRatio()>=a?h.height=h.width/a:h.width=h.height*a,h.x=c.x-h.width/2,h.y=c.y-h.height/2;var d=1/h.width;if(r)return this.panTo(c,!0),this.zoomTo(d,null,!0),o&&this.applyConstraints(!0),this;var l=this.getCenter(!0),f=this.getZoom(!0);this.panTo(l,!0),this.zoomTo(f,null,!0);var p=this.getBounds(),g=this.getZoom();if(g===0||Math.abs(d/g-1)<1e-8)return this.zoomTo(d,null,!0),this.panTo(c,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(c,!1),d=this._applyZoomConstraints(d),this.zoomTo(d,null,!1);var v=this.getConstrainedBounds();this.panTo(l,!0),this.zoomTo(f,null,!0),this.fitBounds(v)}else{var w=h.rotate(-this.getRotation()),E=w.getTopLeft().times(d).minus(p.getTopLeft().times(g)).divide(d-g);this.zoomTo(d,E,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),c=e.positiveModulo(i,360),h=c-a;h>180?c-=360:h<-180&&(c+=360);var d=a-c;this.degreesSpring.resetTo(i+d),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var c=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),c},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.imageToViewportRectangle(i,n,r,o,!0)}}var d=this.imageToViewportCoordinates(a.x,a.y),l=this._imageToViewportDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.viewportToImageRectangle(i,n,r,o,!0)}}var d=this.viewportToImageCoordinates(a.x,a.y),l=this._viewportToImageDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=a/o*c;return i*h},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=o/a/c;return i*h},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var c=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var h=i.degrees||0;delete i.degrees;var d=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:h,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,c,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(d,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),c=n||r||o||a||this._needsUpdate;if(c||i||!this._fullyLoaded){let h=this._updateLevelsForViewport();this._setFullyLoaded(h)}return this._needsUpdate=!1,c?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,c=(o.y+r%o.y)%o.y,h=this.source.getTileBounds(i,a,c);return this.getFlip()&&(h.x=Math.max(0,1-h.x-h.width)),h.x+=(n-a)/o.x,h.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-c)/o.y),h},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var c=i;c instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.imageToViewportCoordinates(c.getTopLeft(),a),d=this._imageToViewportDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var c=i;i instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.viewportToImageCoordinates(c.getTopLeft(),a),d=this._viewportToImageDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,c=0,h=0,d=1,l=1;if(this._clip&&(a=this._clip.getAspectRatio(),d=this._clip.width/this.source.dimensions.x,l=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(c=this._clip.x/this._clip.height*i.height,h=this._clip.y/this._clip.height*i.height):(c=this._clip.x/this._clip.width*i.width,h=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var f=i.height/l,p=0;o.isHorizontallyCentered?p=(i.width-i.height*a)/2:o.isRight&&(p=i.width-i.height*a),this.setPosition(new e.Point(i.x-c+p,i.y-h),r),this.setHeight(f,r)}else{var g=i.width/d,v=0;o.isVerticallyCentered?v=(i.height-i.width/a)/2:o.isBottom&&(v=i.height-i.width/a),this.setPosition(new e.Point(i.x-c,i.y-h+v),r),this.setWidth(g,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var c in this.tilesMatrix){n=this.source.getNumTiles(c);for(var h in this.tilesMatrix[c]){r=(n.x+h%n.x)%n.x;for(var d in this.tilesMatrix[c][h])if(o=(n.y+d%n.y)%n.y,a=this.tilesMatrix[c][h][d],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var l=this.source.getTileAjaxHeaders(c,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,l)}else a.ajaxHeaders=null}}for(var f=0;f<this._imageLoader.jobQueue.length;f++){var p=this._imageLoader.jobQueue[f];p.loadWithAjax=p.tile.loadWithAjax,p.ajaxHeaders=p.tile.loadWithAjax?p.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),c=e.now();if(this._lastDrawn.forEach(Z=>{Z.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var h=new Array(r-n+1);for(let Z=0,J=r;J>=n;J--,Z++)h[Z]=J;for(let Z=r+1;Z<=this.source.maxLevel;Z++){var d=this.tilesMatrix[Z]&&this.tilesMatrix[Z][0]&&this.tilesMatrix[Z][0][0];if(d&&d.isBottomMost&&d.isRightMost&&d.loaded){h.push(Z);break}}let l=!1;for(let Z=0;Z<h.length;Z++){let J=h[Z];var f=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!0).x*this._scaleSpring.current.value;if(Z===h.length-1||f>=this.minPixelRatio)l=!0;else if(!l)continue;var p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!1).x*this._scaleSpring.current.value,g=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,v=this.immediateRender?1:g,w=Math.min(1,(f-.5)/.5),E=v/Math.abs(v-p),I=this._updateLevel(J,w,E,a,c,o);o=I.bestTiles;var L=I.updatedTiles.filter(k=>k.loaded),N=function(k,A,P){return function(M){return{tile:M,level:k,levelOpacity:A,currentTime:P}}}(J,w,c);if(this._tilesToDraw[J]=L.map(N),this._providesCoverage(this.coverage,J))break}return o&&o.length>0?(o.forEach(function(Z){Z&&!Z.context2D&&this._loadTile(Z,c)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function c(d){let l=d.tile;if(l&&l.loaded){let f=r._blendTile(l,l.x,l.y,d.level,d.levelOpacity,n,o);r._isBlending=r._isBlending||f,r._needsDraw=r._needsDraw||f||r._wasBlending}}let h=0;for(let d=0;d<i.length;d++){let l=i[d];c(l),this._providesCoverage(this.coverage,l.level)&&(h=Math.max(h,l.level))}if(h>0)for(let d in this._tilesToDraw)d<h&&delete this._tilesToDraw[d]},_blendTile:function(i,n,r,o,a,c,h){let d=1e3*this.blendTime,l,f;return i.blendStart||(i.blendStart=c),l=c-i.blendStart,f=d?Math.min(1,l/d):1,o===h&&(f=1,l=d),this.alwaysBlend&&(f*=a),i.opacity=f,f===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),l<d},_updateLevel:function(i,n,r,o,a,c){var h=o.getBoundingBox().getTopLeft(),d=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:h,bottomright:d,currenttime:a,best:c}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var l=this._getCornerTiles(i,h,d),f=l.topLeft,p=l.bottomRight,g=this.source.getNumTiles(i),v=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(p.x+=1,this.wrapHorizontal||(p.x=Math.min(p.x,g.x-1)));for(var w=Math.max(0,(p.x-f.x)*(p.y-f.y)),E=new Array(w),I=0,L=f.x;L<=p.x;L++)for(var N=f.y;N<=p.y;N++){var Z;if(this.getFlip()){var J=(g.x+L%g.x)%g.x;Z=L+g.x-J-J-1}else Z=L;if(o.intersection(this.getTileBounds(i,Z,N))!==null){var k=this._updateTile(Z,N,i,r,v,g,a,c);c=k.bestTiles,E[I]=k.tile,I+=1}}return{bestTiles:c,updatedTiles:E}},_positionTile:function(i,n,r,o,a){var c=i.bounds.getTopLeft();c.x*=this._scaleSpring.current.value,c.y*=this._scaleSpring.current.value,c.x+=this._xSpring.current.value,c.y+=this._ySpring.current.value;var h=i.bounds.getSize();h.x*=this._scaleSpring.current.value,h.y*=this._scaleSpring.current.value,i.positionedBounds.x=c.x,i.positionedBounds.y=c.y,i.positionedBounds.width=h.x,i.positionedBounds.height=h.y;var d=r.pixelFromPointNoRotate(c,!0),l=r.pixelFromPointNoRotate(c,!1),f=r.deltaPixelsFromPointsNoRotate(h,!0),p=r.deltaPixelsFromPointsNoRotate(h,!1),g=l.plus(p.divide(2)),v=o.squaredDistanceTo(g);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(f=f.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(f.x+=.75),i.isBottomMost&&this.wrapVertical&&(f.y+=.75)),i.position=d,i.size=f,i.squaredDistance=v,i.visibility=a},_updateTile:function(i,n,r,o,a,c,h,d){var l=this._getTile(i,n,r,h,c);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:l}),this._setCoverage(this.coverage,r,i,n,!1);var f=l.loaded||l.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,f),!l.exists)return{bestTiles:d,tile:l};if(l.loaded&&l.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(l,this.source.tileOverlap,this.viewport,a,o),!l.loaded)if(l.context2D)this._setTileLoaded(l);else{var p=this._tileCache.getImageRecord(l.cacheKey);p&&this._setTileLoaded(l,p.getData())}return l.loading?this._tilesLoading++:f||(d=this._compareTiles(d,l,this.maxTilesPerFrame)),{bestTiles:d,tile:l}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var c,h,d=1/this.source.aspectRatio;this.wrapVertical?(c=e.positiveModulo(n.y,d),h=e.positiveModulo(r.y,d)):(c=Math.max(0,n.y),h=Math.min(d,r.y));var l=this.source.getTileAtPoint(i,new e.Point(o,c)),f=this.source.getTileAtPoint(i,new e.Point(a,h)),p=this.source.getNumTiles(i);return this.wrapHorizontal&&(l.x+=p.x*Math.floor(n.x),f.x+=p.x*Math.floor(r.x)),this.wrapVertical&&(l.y+=p.y*Math.floor(n.y/d),f.y+=p.y*Math.floor(r.y/d)),{topLeft:l,bottomRight:f}},_getTile:function(i,n,r,o,a){var c,h,d,l,f,p,g,v,w,E,I=this.tilesMatrix,L=this.source;return I[r]||(I[r]={}),I[r][i]||(I[r][i]={}),(!I[r][i][n]||!I[r][i][n].flipped!=!this.flipped)&&(c=(a.x+i%a.x)%a.x,h=(a.y+n%a.y)%a.y,d=this.getTileBounds(r,i,n),l=L.getTileBounds(r,c,h,!0),f=L.tileExists(r,c,h),p=L.getTileUrl(r,c,h),g=L.getTilePostData(r,c,h),this.loadTilesWithAjax?(v=L.getTileAjaxHeaders(r,c,h),e.isPlainObject(this.ajaxHeaders)&&(v=e.extend({},this.ajaxHeaders,v))):v=null,w=L.getContext2D?L.getContext2D(r,c,h):void 0,E=new e.Tile(r,i,n,d,f,p,w,this.loadTilesWithAjax,v,l,g,L.getTileHashKey(r,c,h,p,v,g)),this.getFlip()?c===0&&(E.isRightMost=!0):c===a.x-1&&(E.isRightMost=!0),h===a.y-1&&(E.isBottomMost=!0),E.flipped=this.flipped,I[r][i][n]=E),E=I[r][i][n],E.lastTouchTime=o,E},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,c){r._onTileLoad(i,n,o,a,c)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var c=this,h=function(){var d=c.source,l=d.getClosestLevel();c._setTileLoaded(i,r,l,a)};h()},_setTileLoaded:function(i,n,r,o){var a=0,c=!1,h=this;function d(){return c&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,l}function l(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=h.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||h._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:h}),h.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:h,tileRequest:o}),h._needsDraw=!0)}var f=d();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:d}),c=!0,f()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,c,h,d;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(h in a)if(Object.prototype.hasOwnProperty.call(a,h)){c=a[h];for(d in c)if(Object.prototype.hasOwnProperty.call(c,d)&&!c[d])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,c=this._imagesLoaded[r.tile.cacheKey];if(c||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),c=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),c.addTile(r.tile),r.tile.cacheImageRecord=c,this._imagesLoadedCount>this._maxImageCacheCount){for(var h=null,d=-1,l=null,f,p,g,v,w,E,I=this._tilesLoaded.length-1;I>=0;I--)if(E=this._tilesLoaded[I],f=E.tile,!(f.level<=o||f.beingDrawn)){if(!h){h=f,d=I,l=E;continue}v=f.lastTouchTime,p=h.lastTouchTime,w=f.level,g=h.level,(v<p||v===p&&w>g)&&(h=f,d=I,l=E)}h&&d>=0&&(this._unloadTile(l),a=d)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let c=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var h=this._imagesLoaded[o.cacheKey];h&&(h.removeTile(o),h.getTileCount()||(h.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,c&&(c.canvas.width=0,c.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:c,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,c=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,h=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,d=c+h,l;!i.rows&&a?l=a:l=Math.ceil(this._items.length/o);var f=0,p=0,g,v,w,E,I;this.setAutoRefigureSizes(!1);for(var L=0;L<this._items.length;L++)L&&L%l===0&&(r==="horizontal"?(p+=d,f=0):(f+=d,p=0)),g=this._items[L],v=g.getBounds(),v.width>v.height?w=c:w=c*(v.width/v.height),E=w*(v.height/v.width),I=new e.Point(f+(c-w)/2,p+(c-E)/2),g.setPosition(I,n),g.setWidth(w,n),r==="horizontal"?f+=d:p+=d;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var c=o.getClippedBounds().getBoundingBox(),h=c.x,d=c.y,l=c.x+c.width,f=c.y+c.height,p=1;p<this._items.length;p++)o=this._items[p],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),c=o.getClippedBounds().getBoundingBox(),h=Math.min(h,c.x),d=Math.min(d,c.y),l=Math.max(l,c.x+c.width),f=Math.max(f,c.y+c.height);this._homeBounds=new e.Rect(h,d,l-h,f-d),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(Ic);var Ku=Ic.exports;const ot=Yu(Ku);var vi={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(s){(function(){var t=function(){this.init()};t.prototype={init:function(){var l=this||e;return l._counter=1e3,l._html5AudioPool=[],l.html5PoolSize=10,l._codecs={},l._howls=[],l._muted=!1,l._volume=1,l._canPlayEvent="canplaythrough",l._navigator=typeof window<"u"&&window.navigator?window.navigator:null,l.masterGain=null,l.noAudio=!1,l.usingWebAudio=!0,l.autoSuspend=!0,l.ctx=null,l.autoUnlock=!0,l._setup(),l},volume:function(l){var f=this||e;if(l=parseFloat(l),f.ctx||d(),typeof l<"u"&&l>=0&&l<=1){if(f._volume=l,f._muted)return f;f.usingWebAudio&&f.masterGain.gain.setValueAtTime(l,e.ctx.currentTime);for(var p=0;p<f._howls.length;p++)if(!f._howls[p]._webAudio)for(var g=f._howls[p]._getSoundIds(),v=0;v<g.length;v++){var w=f._howls[p]._soundById(g[v]);w&&w._node&&(w._node.volume=w._volume*l)}return f}return f._volume},mute:function(l){var f=this||e;f.ctx||d(),f._muted=l,f.usingWebAudio&&f.masterGain.gain.setValueAtTime(l?0:f._volume,e.ctx.currentTime);for(var p=0;p<f._howls.length;p++)if(!f._howls[p]._webAudio)for(var g=f._howls[p]._getSoundIds(),v=0;v<g.length;v++){var w=f._howls[p]._soundById(g[v]);w&&w._node&&(w._node.muted=l?!0:w._muted)}return f},stop:function(){for(var l=this||e,f=0;f<l._howls.length;f++)l._howls[f].stop();return l},unload:function(){for(var l=this||e,f=l._howls.length-1;f>=0;f--)l._howls[f].unload();return l.usingWebAudio&&l.ctx&&typeof l.ctx.close<"u"&&(l.ctx.close(),l.ctx=null,d()),l},codecs:function(l){return(this||e)._codecs[l.replace(/^x-/,"")]},_setup:function(){var l=this||e;if(l.state=l.ctx&&l.ctx.state||"suspended",l._autoSuspend(),!l.usingWebAudio)if(typeof Audio<"u")try{var f=new Audio;typeof f.oncanplaythrough>"u"&&(l._canPlayEvent="canplay")}catch{l.noAudio=!0}else l.noAudio=!0;try{var f=new Audio;f.muted&&(l.noAudio=!0)}catch{}return l.noAudio||l._setupCodecs(),l},_setupCodecs:function(){var l=this||e,f=null;try{f=typeof Audio<"u"?new Audio:null}catch{return l}if(!f||typeof f.canPlayType!="function")return l;var p=f.canPlayType("audio/mpeg;").replace(/^no$/,""),g=l._navigator?l._navigator.userAgent:"",v=g.match(/OPR\/(\d+)/g),w=v&&parseInt(v[0].split("/")[1],10)<33,E=g.indexOf("Safari")!==-1&&g.indexOf("Chrome")===-1,I=g.match(/Version\/(.*?) /),L=E&&I&&parseInt(I[1],10)<15;return l._codecs={mp3:!!(!w&&(p||f.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!p,opus:!!f.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(f.canPlayType('audio/wav; codecs="1"')||f.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!f.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!f.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(f.canPlayType("audio/x-m4a;")||f.canPlayType("audio/m4a;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(f.canPlayType("audio/x-m4b;")||f.canPlayType("audio/m4b;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(f.canPlayType("audio/x-mp4;")||f.canPlayType("audio/mp4;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!L&&f.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!L&&f.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!f.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(f.canPlayType("audio/x-flac;")||f.canPlayType("audio/flac;")).replace(/^no$/,"")},l},_unlockAudio:function(){var l=this||e;if(!(l._audioUnlocked||!l.ctx)){l._audioUnlocked=!1,l.autoUnlock=!1,!l._mobileUnloaded&&l.ctx.sampleRate!==44100&&(l._mobileUnloaded=!0,l.unload()),l._scratchBuffer=l.ctx.createBuffer(1,1,22050);var f=function(p){for(;l._html5AudioPool.length<l.html5PoolSize;)try{var g=new Audio;g._unlocked=!0,l._releaseHtml5Audio(g)}catch{l.noAudio=!0;break}for(var v=0;v<l._howls.length;v++)if(!l._howls[v]._webAudio)for(var w=l._howls[v]._getSoundIds(),E=0;E<w.length;E++){var I=l._howls[v]._soundById(w[E]);I&&I._node&&!I._node._unlocked&&(I._node._unlocked=!0,I._node.load())}l._autoResume();var L=l.ctx.createBufferSource();L.buffer=l._scratchBuffer,L.connect(l.ctx.destination),typeof L.start>"u"?L.noteOn(0):L.start(0),typeof l.ctx.resume=="function"&&l.ctx.resume(),L.onended=function(){L.disconnect(0),l._audioUnlocked=!0,document.removeEventListener("touchstart",f,!0),document.removeEventListener("touchend",f,!0),document.removeEventListener("click",f,!0),document.removeEventListener("keydown",f,!0);for(var N=0;N<l._howls.length;N++)l._howls[N]._emit("unlock")}};return document.addEventListener("touchstart",f,!0),document.addEventListener("touchend",f,!0),document.addEventListener("click",f,!0),document.addEventListener("keydown",f,!0),l}},_obtainHtml5Audio:function(){var l=this||e;if(l._html5AudioPool.length)return l._html5AudioPool.pop();var f=new Audio().play();return f&&typeof Promise<"u"&&(f instanceof Promise||typeof f.then=="function")&&f.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(l){var f=this||e;return l._unlocked&&f._html5AudioPool.push(l),f},_autoSuspend:function(){var l=this;if(!(!l.autoSuspend||!l.ctx||typeof l.ctx.suspend>"u"||!e.usingWebAudio)){for(var f=0;f<l._howls.length;f++)if(l._howls[f]._webAudio){for(var p=0;p<l._howls[f]._sounds.length;p++)if(!l._howls[f]._sounds[p]._paused)return l}return l._suspendTimer&&clearTimeout(l._suspendTimer),l._suspendTimer=setTimeout(function(){if(l.autoSuspend){l._suspendTimer=null,l.state="suspending";var g=function(){l.state="suspended",l._resumeAfterSuspend&&(delete l._resumeAfterSuspend,l._autoResume())};l.ctx.suspend().then(g,g)}},3e4),l}},_autoResume:function(){var l=this;if(!(!l.ctx||typeof l.ctx.resume>"u"||!e.usingWebAudio))return l.state==="running"&&l.ctx.state!=="interrupted"&&l._suspendTimer?(clearTimeout(l._suspendTimer),l._suspendTimer=null):l.state==="suspended"||l.state==="running"&&l.ctx.state==="interrupted"?(l.ctx.resume().then(function(){l.state="running";for(var f=0;f<l._howls.length;f++)l._howls[f]._emit("resume")}),l._suspendTimer&&(clearTimeout(l._suspendTimer),l._suspendTimer=null)):l.state==="suspending"&&(l._resumeAfterSuspend=!0),l}};var e=new t,i=function(l){var f=this;if(!l.src||l.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}f.init(l)};i.prototype={init:function(l){var f=this;return e.ctx||d(),f._autoplay=l.autoplay||!1,f._format=typeof l.format!="string"?l.format:[l.format],f._html5=l.html5||!1,f._muted=l.mute||!1,f._loop=l.loop||!1,f._pool=l.pool||5,f._preload=typeof l.preload=="boolean"||l.preload==="metadata"?l.preload:!0,f._rate=l.rate||1,f._sprite=l.sprite||{},f._src=typeof l.src!="string"?l.src:[l.src],f._volume=l.volume!==void 0?l.volume:1,f._xhr={method:l.xhr&&l.xhr.method?l.xhr.method:"GET",headers:l.xhr&&l.xhr.headers?l.xhr.headers:null,withCredentials:l.xhr&&l.xhr.withCredentials?l.xhr.withCredentials:!1},f._duration=0,f._state="unloaded",f._sounds=[],f._endTimers={},f._queue=[],f._playLock=!1,f._onend=l.onend?[{fn:l.onend}]:[],f._onfade=l.onfade?[{fn:l.onfade}]:[],f._onload=l.onload?[{fn:l.onload}]:[],f._onloaderror=l.onloaderror?[{fn:l.onloaderror}]:[],f._onplayerror=l.onplayerror?[{fn:l.onplayerror}]:[],f._onpause=l.onpause?[{fn:l.onpause}]:[],f._onplay=l.onplay?[{fn:l.onplay}]:[],f._onstop=l.onstop?[{fn:l.onstop}]:[],f._onmute=l.onmute?[{fn:l.onmute}]:[],f._onvolume=l.onvolume?[{fn:l.onvolume}]:[],f._onrate=l.onrate?[{fn:l.onrate}]:[],f._onseek=l.onseek?[{fn:l.onseek}]:[],f._onunlock=l.onunlock?[{fn:l.onunlock}]:[],f._onresume=[],f._webAudio=e.usingWebAudio&&!f._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(f),f._autoplay&&f._queue.push({event:"play",action:function(){f.play()}}),f._preload&&f._preload!=="none"&&f.load(),f},load:function(){var l=this,f=null;if(e.noAudio){l._emit("loaderror",null,"No audio support.");return}typeof l._src=="string"&&(l._src=[l._src]);for(var p=0;p<l._src.length;p++){var g,v;if(l._format&&l._format[p])g=l._format[p];else{if(v=l._src[p],typeof v!="string"){l._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}g=/^data:audio\/([^;,]+);/i.exec(v),g||(g=/\.([^.]+)$/.exec(v.split("?",1)[0])),g&&(g=g[1].toLowerCase())}if(g||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),g&&e.codecs(g)){f=l._src[p];break}}if(!f){l._emit("loaderror",null,"No codec support for selected audio sources.");return}return l._src=f,l._state="loading",window.location.protocol==="https:"&&f.slice(0,5)==="http:"&&(l._html5=!0,l._webAudio=!1),new n(l),l._webAudio&&o(l),l},play:function(l,f){var p=this,g=null;if(typeof l=="number")g=l,l=null;else{if(typeof l=="string"&&p._state==="loaded"&&!p._sprite[l])return null;if(typeof l>"u"&&(l="__default",!p._playLock)){for(var v=0,w=0;w<p._sounds.length;w++)p._sounds[w]._paused&&!p._sounds[w]._ended&&(v++,g=p._sounds[w]._id);v===1?l=null:g=null}}var E=g?p._soundById(g):p._inactiveSound();if(!E)return null;if(g&&!l&&(l=E._sprite||"__default"),p._state!=="loaded"){E._sprite=l,E._ended=!1;var I=E._id;return p._queue.push({event:"play",action:function(){p.play(I)}}),I}if(g&&!E._paused)return f||p._loadQueue("play"),E._id;p._webAudio&&e._autoResume();var L=Math.max(0,E._seek>0?E._seek:p._sprite[l][0]/1e3),N=Math.max(0,(p._sprite[l][0]+p._sprite[l][1])/1e3-L),Z=N*1e3/Math.abs(E._rate),J=p._sprite[l][0]/1e3,k=(p._sprite[l][0]+p._sprite[l][1])/1e3;E._sprite=l,E._ended=!1;var A=function(){E._paused=!1,E._seek=L,E._start=J,E._stop=k,E._loop=!!(E._loop||p._sprite[l][2])};if(L>=k){p._ended(E);return}var P=E._node;if(p._webAudio){var M=function(){p._playLock=!1,A(),p._refreshBuffer(E);var B=E._muted||p._muted?0:E._volume;P.gain.setValueAtTime(B,e.ctx.currentTime),E._playStart=e.ctx.currentTime,typeof P.bufferSource.start>"u"?E._loop?P.bufferSource.noteGrainOn(0,L,86400):P.bufferSource.noteGrainOn(0,L,N):E._loop?P.bufferSource.start(0,L,86400):P.bufferSource.start(0,L,N),Z!==1/0&&(p._endTimers[E._id]=setTimeout(p._ended.bind(p,E),Z)),f||setTimeout(function(){p._emit("play",E._id),p._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?M():(p._playLock=!0,p.once("resume",M),p._clearTimer(E._id))}else{var F=function(){P.currentTime=L,P.muted=E._muted||p._muted||e._muted||P.muted,P.volume=E._volume*e.volume(),P.playbackRate=E._rate;try{var B=P.play();if(B&&typeof Promise<"u"&&(B instanceof Promise||typeof B.then=="function")?(p._playLock=!0,A(),B.then(function(){p._playLock=!1,P._unlocked=!0,f?p._loadQueue():p._emit("play",E._id)}).catch(function(){p._playLock=!1,p._emit("playerror",E._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),E._ended=!0,E._paused=!0})):f||(p._playLock=!1,A(),p._emit("play",E._id)),P.playbackRate=E._rate,P.paused){p._emit("playerror",E._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}l!=="__default"||E._loop?p._endTimers[E._id]=setTimeout(p._ended.bind(p,E),Z):(p._endTimers[E._id]=function(){p._ended(E),P.removeEventListener("ended",p._endTimers[E._id],!1)},P.addEventListener("ended",p._endTimers[E._id],!1))}catch(Ce){p._emit("playerror",E._id,Ce)}};P.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(P.src=p._src,P.load());var O=window&&window.ejecta||!P.readyState&&e._navigator.isCocoonJS;if(P.readyState>=3||O)F();else{p._playLock=!0,p._state="loading";var D=function(){p._state="loaded",F(),P.removeEventListener(e._canPlayEvent,D,!1)};P.addEventListener(e._canPlayEvent,D,!1),p._clearTimer(E._id)}}return E._id},pause:function(l){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"pause",action:function(){f.pause(l)}}),f;for(var p=f._getSoundIds(l),g=0;g<p.length;g++){f._clearTimer(p[g]);var v=f._soundById(p[g]);if(v&&!v._paused&&(v._seek=f.seek(p[g]),v._rateSeek=0,v._paused=!0,f._stopFade(p[g]),v._node))if(f._webAudio){if(!v._node.bufferSource)continue;typeof v._node.bufferSource.stop>"u"?v._node.bufferSource.noteOff(0):v._node.bufferSource.stop(0),f._cleanBuffer(v._node)}else(!isNaN(v._node.duration)||v._node.duration===1/0)&&v._node.pause();arguments[1]||f._emit("pause",v?v._id:null)}return f},stop:function(l,f){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"stop",action:function(){p.stop(l)}}),p;for(var g=p._getSoundIds(l),v=0;v<g.length;v++){p._clearTimer(g[v]);var w=p._soundById(g[v]);w&&(w._seek=w._start||0,w._rateSeek=0,w._paused=!0,w._ended=!0,p._stopFade(g[v]),w._node&&(p._webAudio?w._node.bufferSource&&(typeof w._node.bufferSource.stop>"u"?w._node.bufferSource.noteOff(0):w._node.bufferSource.stop(0),p._cleanBuffer(w._node)):(!isNaN(w._node.duration)||w._node.duration===1/0)&&(w._node.currentTime=w._start||0,w._node.pause(),w._node.duration===1/0&&p._clearSound(w._node))),f||p._emit("stop",w._id))}return p},mute:function(l,f){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"mute",action:function(){p.mute(l,f)}}),p;if(typeof f>"u")if(typeof l=="boolean")p._muted=l;else return p._muted;for(var g=p._getSoundIds(f),v=0;v<g.length;v++){var w=p._soundById(g[v]);w&&(w._muted=l,w._interval&&p._stopFade(w._id),p._webAudio&&w._node?w._node.gain.setValueAtTime(l?0:w._volume,e.ctx.currentTime):w._node&&(w._node.muted=e._muted?!0:l),p._emit("mute",w._id))}return p},volume:function(){var l=this,f=arguments,p,g;if(f.length===0)return l._volume;if(f.length===1||f.length===2&&typeof f[1]>"u"){var v=l._getSoundIds(),w=v.indexOf(f[0]);w>=0?g=parseInt(f[0],10):p=parseFloat(f[0])}else f.length>=2&&(p=parseFloat(f[0]),g=parseInt(f[1],10));var E;if(typeof p<"u"&&p>=0&&p<=1){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"volume",action:function(){l.volume.apply(l,f)}}),l;typeof g>"u"&&(l._volume=p),g=l._getSoundIds(g);for(var I=0;I<g.length;I++)E=l._soundById(g[I]),E&&(E._volume=p,f[2]||l._stopFade(g[I]),l._webAudio&&E._node&&!E._muted?E._node.gain.setValueAtTime(p,e.ctx.currentTime):E._node&&!E._muted&&(E._node.volume=p*e.volume()),l._emit("volume",E._id))}else return E=g?l._soundById(g):l._sounds[0],E?E._volume:0;return l},fade:function(l,f,p,g){var v=this;if(v._state!=="loaded"||v._playLock)return v._queue.push({event:"fade",action:function(){v.fade(l,f,p,g)}}),v;l=Math.min(Math.max(0,parseFloat(l)),1),f=Math.min(Math.max(0,parseFloat(f)),1),p=parseFloat(p),v.volume(l,g);for(var w=v._getSoundIds(g),E=0;E<w.length;E++){var I=v._soundById(w[E]);if(I){if(g||v._stopFade(w[E]),v._webAudio&&!I._muted){var L=e.ctx.currentTime,N=L+p/1e3;I._volume=l,I._node.gain.setValueAtTime(l,L),I._node.gain.linearRampToValueAtTime(f,N)}v._startFadeInterval(I,l,f,p,w[E],typeof g>"u")}}return v},_startFadeInterval:function(l,f,p,g,v,w){var E=this,I=f,L=p-f,N=Math.abs(L/.01),Z=Math.max(4,N>0?g/N:g),J=Date.now();l._fadeTo=p,l._interval=setInterval(function(){var k=(Date.now()-J)/g;J=Date.now(),I+=L*k,I=Math.round(I*100)/100,L<0?I=Math.max(p,I):I=Math.min(p,I),E._webAudio?l._volume=I:E.volume(I,l._id,!0),w&&(E._volume=I),(p<f&&I<=p||p>f&&I>=p)&&(clearInterval(l._interval),l._interval=null,l._fadeTo=null,E.volume(p,l._id),E._emit("fade",l._id))},Z)},_stopFade:function(l){var f=this,p=f._soundById(l);return p&&p._interval&&(f._webAudio&&p._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(p._interval),p._interval=null,f.volume(p._fadeTo,l),p._fadeTo=null,f._emit("fade",l)),f},loop:function(){var l=this,f=arguments,p,g,v;if(f.length===0)return l._loop;if(f.length===1)if(typeof f[0]=="boolean")p=f[0],l._loop=p;else return v=l._soundById(parseInt(f[0],10)),v?v._loop:!1;else f.length===2&&(p=f[0],g=parseInt(f[1],10));for(var w=l._getSoundIds(g),E=0;E<w.length;E++)v=l._soundById(w[E]),v&&(v._loop=p,l._webAudio&&v._node&&v._node.bufferSource&&(v._node.bufferSource.loop=p,p&&(v._node.bufferSource.loopStart=v._start||0,v._node.bufferSource.loopEnd=v._stop,l.playing(w[E])&&(l.pause(w[E],!0),l.play(w[E],!0)))));return l},rate:function(){var l=this,f=arguments,p,g;if(f.length===0)g=l._sounds[0]._id;else if(f.length===1){var v=l._getSoundIds(),w=v.indexOf(f[0]);w>=0?g=parseInt(f[0],10):p=parseFloat(f[0])}else f.length===2&&(p=parseFloat(f[0]),g=parseInt(f[1],10));var E;if(typeof p=="number"){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"rate",action:function(){l.rate.apply(l,f)}}),l;typeof g>"u"&&(l._rate=p),g=l._getSoundIds(g);for(var I=0;I<g.length;I++)if(E=l._soundById(g[I]),E){l.playing(g[I])&&(E._rateSeek=l.seek(g[I]),E._playStart=l._webAudio?e.ctx.currentTime:E._playStart),E._rate=p,l._webAudio&&E._node&&E._node.bufferSource?E._node.bufferSource.playbackRate.setValueAtTime(p,e.ctx.currentTime):E._node&&(E._node.playbackRate=p);var L=l.seek(g[I]),N=(l._sprite[E._sprite][0]+l._sprite[E._sprite][1])/1e3-L,Z=N*1e3/Math.abs(E._rate);(l._endTimers[g[I]]||!E._paused)&&(l._clearTimer(g[I]),l._endTimers[g[I]]=setTimeout(l._ended.bind(l,E),Z)),l._emit("rate",E._id)}}else return E=l._soundById(g),E?E._rate:l._rate;return l},seek:function(){var l=this,f=arguments,p,g;if(f.length===0)l._sounds.length&&(g=l._sounds[0]._id);else if(f.length===1){var v=l._getSoundIds(),w=v.indexOf(f[0]);w>=0?g=parseInt(f[0],10):l._sounds.length&&(g=l._sounds[0]._id,p=parseFloat(f[0]))}else f.length===2&&(p=parseFloat(f[0]),g=parseInt(f[1],10));if(typeof g>"u")return 0;if(typeof p=="number"&&(l._state!=="loaded"||l._playLock))return l._queue.push({event:"seek",action:function(){l.seek.apply(l,f)}}),l;var E=l._soundById(g);if(E)if(typeof p=="number"&&p>=0){var I=l.playing(g);I&&l.pause(g,!0),E._seek=p,E._ended=!1,l._clearTimer(g),!l._webAudio&&E._node&&!isNaN(E._node.duration)&&(E._node.currentTime=p);var L=function(){I&&l.play(g,!0),l._emit("seek",g)};if(I&&!l._webAudio){var N=function(){l._playLock?setTimeout(N,0):L()};setTimeout(N,0)}else L()}else if(l._webAudio){var Z=l.playing(g)?e.ctx.currentTime-E._playStart:0,J=E._rateSeek?E._rateSeek-E._seek:0;return E._seek+(J+Z*Math.abs(E._rate))}else return E._node.currentTime;return l},playing:function(l){var f=this;if(typeof l=="number"){var p=f._soundById(l);return p?!p._paused:!1}for(var g=0;g<f._sounds.length;g++)if(!f._sounds[g]._paused)return!0;return!1},duration:function(l){var f=this,p=f._duration,g=f._soundById(l);return g&&(p=f._sprite[g._sprite][1]/1e3),p},state:function(){return this._state},unload:function(){for(var l=this,f=l._sounds,p=0;p<f.length;p++)f[p]._paused||l.stop(f[p]._id),l._webAudio||(l._clearSound(f[p]._node),f[p]._node.removeEventListener("error",f[p]._errorFn,!1),f[p]._node.removeEventListener(e._canPlayEvent,f[p]._loadFn,!1),f[p]._node.removeEventListener("ended",f[p]._endFn,!1),e._releaseHtml5Audio(f[p]._node)),delete f[p]._node,l._clearTimer(f[p]._id);var g=e._howls.indexOf(l);g>=0&&e._howls.splice(g,1);var v=!0;for(p=0;p<e._howls.length;p++)if(e._howls[p]._src===l._src||l._src.indexOf(e._howls[p]._src)>=0){v=!1;break}return r&&v&&delete r[l._src],e.noAudio=!1,l._state="unloaded",l._sounds=[],l=null,null},on:function(l,f,p,g){var v=this,w=v["_on"+l];return typeof f=="function"&&w.push(g?{id:p,fn:f,once:g}:{id:p,fn:f}),v},off:function(l,f,p){var g=this,v=g["_on"+l],w=0;if(typeof f=="number"&&(p=f,f=null),f||p)for(w=0;w<v.length;w++){var E=p===v[w].id;if(f===v[w].fn&&E||!f&&E){v.splice(w,1);break}}else if(l)g["_on"+l]=[];else{var I=Object.keys(g);for(w=0;w<I.length;w++)I[w].indexOf("_on")===0&&Array.isArray(g[I[w]])&&(g[I[w]]=[])}return g},once:function(l,f,p){var g=this;return g.on(l,f,p,1),g},_emit:function(l,f,p){for(var g=this,v=g["_on"+l],w=v.length-1;w>=0;w--)(!v[w].id||v[w].id===f||l==="load")&&(setTimeout((function(E){E.call(this,f,p)}).bind(g,v[w].fn),0),v[w].once&&g.off(l,v[w].fn,v[w].id));return g._loadQueue(l),g},_loadQueue:function(l){var f=this;if(f._queue.length>0){var p=f._queue[0];p.event===l&&(f._queue.shift(),f._loadQueue()),l||p.action()}return f},_ended:function(l){var f=this,p=l._sprite;if(!f._webAudio&&l._node&&!l._node.paused&&!l._node.ended&&l._node.currentTime<l._stop)return setTimeout(f._ended.bind(f,l),100),f;var g=!!(l._loop||f._sprite[p][2]);if(f._emit("end",l._id),!f._webAudio&&g&&f.stop(l._id,!0).play(l._id),f._webAudio&&g){f._emit("play",l._id),l._seek=l._start||0,l._rateSeek=0,l._playStart=e.ctx.currentTime;var v=(l._stop-l._start)*1e3/Math.abs(l._rate);f._endTimers[l._id]=setTimeout(f._ended.bind(f,l),v)}return f._webAudio&&!g&&(l._paused=!0,l._ended=!0,l._seek=l._start||0,l._rateSeek=0,f._clearTimer(l._id),f._cleanBuffer(l._node),e._autoSuspend()),!f._webAudio&&!g&&f.stop(l._id,!0),f},_clearTimer:function(l){var f=this;if(f._endTimers[l]){if(typeof f._endTimers[l]!="function")clearTimeout(f._endTimers[l]);else{var p=f._soundById(l);p&&p._node&&p._node.removeEventListener("ended",f._endTimers[l],!1)}delete f._endTimers[l]}return f},_soundById:function(l){for(var f=this,p=0;p<f._sounds.length;p++)if(l===f._sounds[p]._id)return f._sounds[p];return null},_inactiveSound:function(){var l=this;l._drain();for(var f=0;f<l._sounds.length;f++)if(l._sounds[f]._ended)return l._sounds[f].reset();return new n(l)},_drain:function(){var l=this,f=l._pool,p=0,g=0;if(!(l._sounds.length<f)){for(g=0;g<l._sounds.length;g++)l._sounds[g]._ended&&p++;for(g=l._sounds.length-1;g>=0;g--){if(p<=f)return;l._sounds[g]._ended&&(l._webAudio&&l._sounds[g]._node&&l._sounds[g]._node.disconnect(0),l._sounds.splice(g,1),p--)}}},_getSoundIds:function(l){var f=this;if(typeof l>"u"){for(var p=[],g=0;g<f._sounds.length;g++)p.push(f._sounds[g]._id);return p}else return[l]},_refreshBuffer:function(l){var f=this;return l._node.bufferSource=e.ctx.createBufferSource(),l._node.bufferSource.buffer=r[f._src],l._panner?l._node.bufferSource.connect(l._panner):l._node.bufferSource.connect(l._node),l._node.bufferSource.loop=l._loop,l._loop&&(l._node.bufferSource.loopStart=l._start||0,l._node.bufferSource.loopEnd=l._stop||0),l._node.bufferSource.playbackRate.setValueAtTime(l._rate,e.ctx.currentTime),f},_cleanBuffer:function(l){var f=this,p=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!l.bufferSource)return f;if(e._scratchBuffer&&l.bufferSource&&(l.bufferSource.onended=null,l.bufferSource.disconnect(0),p))try{l.bufferSource.buffer=e._scratchBuffer}catch{}return l.bufferSource=null,f},_clearSound:function(l){var f=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);f||(l.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var n=function(l){this._parent=l,this.init()};n.prototype={init:function(){var l=this,f=l._parent;return l._muted=f._muted,l._loop=f._loop,l._volume=f._volume,l._rate=f._rate,l._seek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,f._sounds.push(l),l.create(),l},create:function(){var l=this,f=l._parent,p=e._muted||l._muted||l._parent._muted?0:l._volume;return f._webAudio?(l._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),l._node.gain.setValueAtTime(p,e.ctx.currentTime),l._node.paused=!0,l._node.connect(e.masterGain)):e.noAudio||(l._node=e._obtainHtml5Audio(),l._errorFn=l._errorListener.bind(l),l._node.addEventListener("error",l._errorFn,!1),l._loadFn=l._loadListener.bind(l),l._node.addEventListener(e._canPlayEvent,l._loadFn,!1),l._endFn=l._endListener.bind(l),l._node.addEventListener("ended",l._endFn,!1),l._node.src=f._src,l._node.preload=f._preload===!0?"auto":f._preload,l._node.volume=p*e.volume(),l._node.load()),l},reset:function(){var l=this,f=l._parent;return l._muted=f._muted,l._loop=f._loop,l._volume=f._volume,l._rate=f._rate,l._seek=0,l._rateSeek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,l},_errorListener:function(){var l=this;l._parent._emit("loaderror",l._id,l._node.error?l._node.error.code:0),l._node.removeEventListener("error",l._errorFn,!1)},_loadListener:function(){var l=this,f=l._parent;f._duration=Math.ceil(l._node.duration*10)/10,Object.keys(f._sprite).length===0&&(f._sprite={__default:[0,f._duration*1e3]}),f._state!=="loaded"&&(f._state="loaded",f._emit("load"),f._loadQueue()),l._node.removeEventListener(e._canPlayEvent,l._loadFn,!1)},_endListener:function(){var l=this,f=l._parent;f._duration===1/0&&(f._duration=Math.ceil(l._node.duration*10)/10,f._sprite.__default[1]===1/0&&(f._sprite.__default[1]=f._duration*1e3),f._ended(l)),l._node.removeEventListener("ended",l._endFn,!1)}};var r={},o=function(l){var f=l._src;if(r[f]){l._duration=r[f].duration,h(l);return}if(/^data:[^;]+;base64,/.test(f)){for(var p=atob(f.split(",")[1]),g=new Uint8Array(p.length),v=0;v<p.length;++v)g[v]=p.charCodeAt(v);c(g.buffer,l)}else{var w=new XMLHttpRequest;w.open(l._xhr.method,f,!0),w.withCredentials=l._xhr.withCredentials,w.responseType="arraybuffer",l._xhr.headers&&Object.keys(l._xhr.headers).forEach(function(E){w.setRequestHeader(E,l._xhr.headers[E])}),w.onload=function(){var E=(w.status+"")[0];if(E!=="0"&&E!=="2"&&E!=="3"){l._emit("loaderror",null,"Failed loading audio file with status: "+w.status+".");return}c(w.response,l)},w.onerror=function(){l._webAudio&&(l._html5=!0,l._webAudio=!1,l._sounds=[],delete r[f],l.load())},a(w)}},a=function(l){try{l.send()}catch{l.onerror()}},c=function(l,f){var p=function(){f._emit("loaderror",null,"Decoding audio data failed.")},g=function(v){v&&f._sounds.length>0?(r[f._src]=v,h(f,v)):p()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(l).then(g).catch(p):e.ctx.decodeAudioData(l,g,p)},h=function(l,f){f&&!l._duration&&(l._duration=f.duration),Object.keys(l._sprite).length===0&&(l._sprite={__default:[0,l._duration*1e3]}),l._state!=="loaded"&&(l._state="loaded",l._emit("load"),l._loadQueue())},d=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var l=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),f=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),p=f?parseInt(f[1],10):null;if(l&&p&&p<9){var g=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!g&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};s.Howler=e,s.Howl=i,typeof Pn<"u"?(Pn.HowlerGlobal=t,Pn.Howler=e,Pn.Howl=i,Pn.Sound=n):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=i,window.Sound=n)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var n=i._howls.length-1;n>=0;n--)i._howls[n].stereo(e);return i},HowlerGlobal.prototype.pos=function(e,i,n){var r=this;if(!r.ctx||!r.ctx.listener)return r;if(i=typeof i!="number"?r._pos[1]:i,n=typeof n!="number"?r._pos[2]:n,typeof e=="number")r._pos=[e,i,n],typeof r.ctx.listener.positionX<"u"?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]);else return r._pos;return r},HowlerGlobal.prototype.orientation=function(e,i,n,r,o,a){var c=this;if(!c.ctx||!c.ctx.listener)return c;var h=c._orientation;if(i=typeof i!="number"?h[1]:i,n=typeof n!="number"?h[2]:n,r=typeof r!="number"?h[3]:r,o=typeof o!="number"?h[4]:o,a=typeof a!="number"?h[5]:a,typeof e=="number")c._orientation=[e,i,n,r,o,a],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(e,i,n,r,o,a);else return h;return c},Howl.prototype.init=function(e){return function(i){var n=this;return n._orientation=i.orientation||[1,0,0],n._stereo=i.stereo||null,n._pos=i.pos||null,n._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},n._onstereo=i.onstereo?[{fn:i.onstereo}]:[],n._onpos=i.onpos?[{fn:i.onpos}]:[],n._onorientation=i.onorientation?[{fn:i.onorientation}]:[],e.call(this,i)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,i){var n=this;if(!n._webAudio)return n;if(n._state!=="loaded")return n._queue.push({event:"stereo",action:function(){n.stereo(e,i)}}),n;var r=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof e=="number")n._stereo=e,n._pos=[e,0,0];else return n._stereo;for(var o=n._getSoundIds(i),a=0;a<o.length;a++){var c=n._soundById(o[a]);if(c)if(typeof e=="number")c._stereo=e,c._pos=[e,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&t(c,r),r==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(e,0,0):c._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),n._emit("stereo",c._id);else return c._stereo}return n},Howl.prototype.pos=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(e,i,n,r)}}),o;if(i=typeof i!="number"?0:i,n=typeof n!="number"?-.5:n,typeof r>"u")if(typeof e=="number")o._pos=[e,i,n];else return o._pos;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._pos=[e,i,n],h._node&&((!h._panner||h._panner.pan)&&t(h,"spatial"),typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setPosition(e,i,n)),o._emit("pos",h._id);else return h._pos}return o},Howl.prototype.orientation=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(e,i,n,r)}}),o;if(i=typeof i!="number"?o._orientation[1]:i,n=typeof n!="number"?o._orientation[2]:n,typeof r>"u")if(typeof e=="number")o._orientation=[e,i,n];else return o._orientation;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._orientation=[e,i,n],h._node&&(h._panner||(h._pos||(h._pos=o._pos||[0,0,-.5]),t(h,"spatial")),typeof h._panner.orientationX<"u"?(h._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setOrientation(e,i,n)),o._emit("orientation",h._id);else return h._orientation}return o},Howl.prototype.pannerAttr=function(){var e=this,i=arguments,n,r,o;if(!e._webAudio)return e;if(i.length===0)return e._pannerAttr;if(i.length===1)if(typeof i[0]=="object")n=i[0],typeof r>"u"&&(n.pannerAttr||(n.pannerAttr={coneInnerAngle:n.coneInnerAngle,coneOuterAngle:n.coneOuterAngle,coneOuterGain:n.coneOuterGain,distanceModel:n.distanceModel,maxDistance:n.maxDistance,refDistance:n.refDistance,rolloffFactor:n.rolloffFactor,panningModel:n.panningModel}),e._pannerAttr={coneInnerAngle:typeof n.pannerAttr.coneInnerAngle<"u"?n.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof n.pannerAttr.coneOuterAngle<"u"?n.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof n.pannerAttr.coneOuterGain<"u"?n.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof n.pannerAttr.distanceModel<"u"?n.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof n.pannerAttr.maxDistance<"u"?n.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof n.pannerAttr.refDistance<"u"?n.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof n.pannerAttr.rolloffFactor<"u"?n.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof n.pannerAttr.panningModel<"u"?n.pannerAttr.panningModel:e._panningModel});else return o=e._soundById(parseInt(i[0],10)),o?o._pannerAttr:e._pannerAttr;else i.length===2&&(n=i[0],r=parseInt(i[1],10));for(var a=e._getSoundIds(r),c=0;c<a.length;c++)if(o=e._soundById(a[c]),o){var h=o._pannerAttr;h={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:h.coneOuterAngle,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:h.coneOuterGain,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:h.distanceModel,maxDistance:typeof n.maxDistance<"u"?n.maxDistance:h.maxDistance,refDistance:typeof n.refDistance<"u"?n.refDistance:h.refDistance,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:h.rolloffFactor,panningModel:typeof n.panningModel<"u"?n.panningModel:h.panningModel};var d=o._panner;d||(o._pos||(o._pos=e._pos||[0,0,-.5]),t(o,"spatial"),d=o._panner),d.coneInnerAngle=h.coneInnerAngle,d.coneOuterAngle=h.coneOuterAngle,d.coneOuterGain=h.coneOuterGain,d.distanceModel=h.distanceModel,d.maxDistance=h.maxDistance,d.refDistance=h.refDistance,d.rolloffFactor=h.rolloffFactor,d.panningModel=h.panningModel}return e},Sound.prototype.init=function(e){return function(){var i=this,n=i._parent;i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,e.call(this),i._stereo?n.stereo(i._stereo):i._pos&&n.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var i=this,n=i._parent;return i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,i._stereo?n.stereo(i._stereo):i._pos?n.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,n._refreshBuffer(i)),e.call(this)}}(Sound.prototype.reset);var t=function(e,i){i=i||"spatial",i==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(vi);class Qu{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,vi.Howler.autoUnlock=!0,vi.Howler.html5PoolSize=10,vi.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(vi.Howler.ctx&&vi.Howler.ctx.state==="suspended")try{await vi.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(t){console.error("Failed to resume AudioContext:",t)}}async preloadHotspots(t){const e=t.filter(i=>i.audioUrl).map(i=>({id:i.id,url:i.audioUrl}));this.preloadQueue.push(...e),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:t,url:e}=this.preloadQueue.shift();this.sounds.has(t)||(await this.loadSound(t,e),this.preloadedCount++)}this.isPreloading=!1}async loadSound(t,e){return new Promise(i=>{const n=new Audio;n.addEventListener("error",()=>{console.log(`Audio not found for ${t}, using placeholder`),this.createSound(t,this.placeholderUrl,!0),i()}),n.addEventListener("canplaythrough",()=>{this.createSound(t,e,!1),i()}),n.src=e})}createSound(t,e,i=!1){const n=new vi.Howl({src:[e],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${t} (placeholder: ${i})`)},onend:()=>this.handlePlaybackEnd(t),onloaderror:(r,o)=>{console.error(`Failed to load sound ${t}:`,o),this.onError&&this.onError(t,o)},onplayerror:(r,o)=>{console.error(`Failed to play sound ${t}:`,o),this.onError&&this.onError(t,o)}});this.sounds.set(t,{howl:n,isPlaceholder:i,duration:i?this.placeholderDuration:null})}async play(t){if(await this.resumeContext(),this.currentHotspotId===t&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(t)||(this.state="loading",await this.loadSound(t,`/audio/hotspot_${t}.mp3`));const e=this.sounds.get(t);if(!e){console.error(`No sound found for hotspot: ${t}`);return}const i=e.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,i,t):(this.currentSound&&this.currentSound.stop(),this.currentSound=i,this.currentHotspotId=t,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(t),this.startProgressTracking())}crossfade(t,e,i){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${i}`),this.isCrossfading=!0,this.state="crossfading";const n=this.crossfadeDuration,r=20,o=n/r;let a=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,i),e.volume(0),e.play();const c=setInterval(()=>{a++;const h=a/r;t.volume(this.masterVolume*(1-h)),e.volume(this.masterVolume*h),a>=r&&(clearInterval(c),t.stop(),t.volume(this.masterVolume),this.previousSound=t,this.currentSound=e,this.currentHotspotId=i,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(i),this.startProgressTracking())},o)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(t){if(this.currentSound&&this.currentSound.playing()){const e=this.currentSound.seek()||0,i=this.currentSound.duration(),n=Math.max(0,Math.min(i,e+t));this.currentSound.seek(n),console.log(`Skipped to ${n.toFixed(1)}s`)}}setVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),vi.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,vi.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const t=this.currentSound.seek()||0,e=this.sounds.get(this.currentHotspotId),i=e!=null&&e.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,n=i>0?t/i*100:0;return{current:t,duration:i,percent:n}}seekTo(t){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(t)}seekToPercent(t){if(this.currentSound){const e=this.currentSound.duration(),i=t/100*e;this.seekTo(i)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const t=this.getProgress();this.onProgress(t)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(t){console.log(`Playback ended for hotspot: ${t}`),t===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(t))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(t,e=500){this.crossfadeEnabled=t,this.crossfadeDuration=Math.max(100,Math.min(2e3,e)),console.log(`Crossfade ${t?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(t){const e=this.sounds.get(t);e&&(e.howl.unload(),this.sounds.delete(t),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(t=>{t.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}}class Ju{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(t){t.forEach(e=>{e.image_url_1&&this.overlays.set(e.id,{hotspotId:e.id,imageUrls:[e.image_url_1],autoReveal:e.overlay_auto_reveal||!1,displayMode:e.overlay_display_mode||"modal",showButton:e.show_images_button!==!1,access:e.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(t){const e=[];t.forEach(i=>{const n=this.overlays.get(i);n&&!n.isLoaded&&n.imageUrls.forEach(r=>{this.preloadedImages.has(r)||e.push({url:r,hotspotId:i})})}),this.preloadQueue.push(...e),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:t,hotspotId:e}=this.preloadQueue.shift();try{await this.loadImage(t,e)}catch(i){console.error(`Failed to preload image: ${t}`,i)}}this.isPreloading=!1}loadImage(t,e){return new Promise((i,n)=>{const r=new Image;r.onload=()=>{this.preloadedImages.set(t,r);const o=this.overlays.get(e);o&&(o.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(t,e),console.log(`Image loaded: ${t}`),i(r)},r.onerror=o=>{this.onImageError&&this.onImageError(t,e,o),console.error(`Failed to load image: ${t}`),n(o)},r.crossOrigin="anonymous",r.src=t})}shouldAutoReveal(t){const e=this.overlays.get(t);return e?e.autoReveal:!1}shouldShowButton(t){const e=this.overlays.get(t);return e?e.showButton:!0}getOverlay(t){return this.overlays.get(t)}openOverlay(t){const e=this.overlays.get(t);if(!e)return console.warn(`No overlay found for hotspot: ${t}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=t,!e.isLoaded){const i=e.imageUrls[0];this.loadImage(i,t).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(t,e),e}closeOverlay(){if(this.activeOverlay){const t=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(t)}}getImage(t){return this.preloadedImages.get(t)}hasAccess(t,e="free"){const i=this.overlays.get(t);if(!i)return!1;const n={free:0,gated:1,supporter:2},r=n[i.access]||0;return(n[e]||0)>=r}unloadImages(t){t.forEach(e=>{const i=this.overlays.get(e);i&&(i.imageUrls.forEach(n=>{this.preloadedImages.delete(n)}),i.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class $u{constructor(t){eo(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});eo(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const t=performance.memory.usedJSHeapSize/1048576,e=performance.memory.jsHeapSizeLimit/1048576,i=t/e*100;this.metrics.currentUsage=t,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,t);const n=this.state.memoryPressure;if(t>this.config.criticalThreshold||i>80?this.state.memoryPressure="critical":t>this.config.highThreshold||i>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==n)switch(console.log(`Memory pressure changed: ${n}  ${this.state.memoryPressure} (${t.toFixed(0)}MB, ${i.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const t=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==t.tiles&&(this.viewer.maxImageCacheCount=t.tiles,console.log(`Adjusted tile cache limit to ${t.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var e;console.warn("CRITICAL: Emergency memory cleanup");const t=(e=this.viewer.world)==null?void 0:e.getItemAt(0);t&&(t._tileCache&&t._tileCache.clearTilesFor(t),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(t=!1){var r,o;const e=(r=this.viewer.world)==null?void 0:r.getItemAt(0);if(!(e!=null&&e._tileCache))return;const i=e._tileCache,n=((o=i._tilesLoaded)==null?void 0:o.length)||i._imagesLoadedCount||0;if(t||n>this.config.cacheLimits[this.state.memoryPressure].tiles){const a=t?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,c=n-a;c>0&&(console.log(`Removing ${c} tiles from cache (current: ${n})`),i.clearTilesFor(e))}}clearUnusedImages(){const t=document.querySelectorAll("img");let e=0;t.forEach(i=>{!this.isElementVisible(i)&&i.src&&(i.removeAttribute("src"),e++)}),e>0&&console.log(`Cleared ${e} unused images`)}isElementVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const t={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const e=performance.memory.jsHeapSizeLimit/1048576;t.usagePercentage=(this.metrics.currentUsage/e*100).toFixed(1)+"%",t.totalLimit=e.toFixed(0)+"MB"}return t}destroy(){this.stop(),this.viewer=null}}class ed{constructor(t={}){Object.assign(this,{viewer:t.viewer,spatialIndex:t.spatialIndex,onHotspotHover:t.onHotspotHover||(()=>{}),onHotspotClick:t.onHotspotClick||(()=>{}),visibilityCheckInterval:t.visibilityCheckInterval||100,batchSize:t.batchSize||50,renderDebounceTime:t.renderDebounceTime||16,debugMode:t.debugMode||!1}),this.lastViewportBounds=null,this.lastViewportZoom=null,this.significantChangeThreshold=.1,this.overlays=new Map,this.visibleOverlays=new Set,this.hoveredHotspot=null,this.selectedHotspot=null,this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.clickTimeThreshold=300,this.clickDistThreshold=this.isMobile?12:8,this.hotspotAreas=new Map,this.activePointers=new Map,this.primaryPointerId=null,this.lastPointerDownTime=0,this.lastPointerDownPoint=null,this.isPinching=!1,this.isAnimationInProgress=!1,this.pendingVisibilityUpdate=!1,this.initStyles(),this.init()}initStyles(){const t={strokeWidth:.5,hoverStrokeWidth:1,selectedStrokeWidth:1.5},e={audio_only:{fill:[0,203,244],stroke:"#00cbf4"},audio_link:{fill:[73,243,0],stroke:"#49f300"},audio_image:{fill:[255,5,247],stroke:"#ff05f7"},audio_image_link:{fill:[255,93,0],stroke:"#ff5d00"},audio_sound:{fill:[255,176,0],stroke:"#ffb000"}};this.styles={},this.debugMode?Object.entries(e).forEach(([i])=>{this.styles[i]={...t,stroke:"rgba(255, 255, 255, 0)",fill:"rgba(0, 0, 0, 0)",hoverFill:"rgba(0, 0, 0, 0)",hoverStroke:"rgba(255, 255, 255, 0.8)",selectedFill:"rgba(0, 0, 0, 0)",selectedStroke:"rgba(255, 255, 255, 1)"}}):Object.entries(e).forEach(([i])=>{this.styles[i]={...t,stroke:"rgba(255, 255, 255, 0)",fill:"rgba(0, 0, 0, 0)",hoverFill:"rgba(0, 0, 0, 0)",hoverStroke:"rgba(255, 255, 255, 0.8)",selectedFill:"rgba(0, 0, 0, 0)",selectedStroke:"rgba(255, 255, 255, 1)"}})}async init(){if(!this.viewer.world.getItemCount()){this.viewer.addOnceHandler("open",()=>this.init());return}const e=this.viewer.world.getItemAt(0).getContentSize();this.svg=this.createSVG(e),this.viewer.addOverlay({element:this.svg,location:new ot.Rect(0,0,1,e.y/e.x),placement:ot.Placement.TOP_LEFT}),await this.loadHotspotsInBatches(),this.setupMouseTracking(),this.setupDragDetection(),this.viewer.addHandler("zoom",()=>{if(this.hoveredHotspot){const i=this.overlays.get(this.hoveredHotspot.id);i&&this.applyStyle(i.element,this.hoveredHotspot.type,"hover")}if(this.selectedHotspot&&this.selectedHotspot!==this.hoveredHotspot){const i=this.overlays.get(this.selectedHotspot.id);i&&this.applyStyle(i.element,this.selectedHotspot.type,"selected")}}),this.startVisibilityTracking(),window.nativeHotspotRenderer=this}createSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
               width="${t.x}" height="${t.y}" 
               viewBox="0 0 ${t.x} ${t.y}"
               style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
        </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}async loadHotspotsInBatches(){const t=this.spatialIndex.getAllHotspots(),e=Math.ceil(t.length/this.batchSize);for(let i=0;i<e;i++)t.slice(i*this.batchSize,(i+1)*this.batchSize).forEach(r=>this.createHotspotOverlay(r)),i<e-1&&await new Promise(r=>setTimeout(r,0));console.log(`Loaded ${t.length} hotspots in ${e} batches`)}createHotspotOverlay(t){const e=this.createGroup(t);(t.shape==="polygon"?[this.createPath(t.coordinates)]:t.coordinates.map(o=>this.createPath(o))).forEach(o=>e.appendChild(o)),this.applyStyle(e,t.type,"normal"),this.svg.appendChild(e);const n=this.calculateBounds(t.coordinates),r=this.calculateArea(n);this.overlays.set(t.id,{element:e,hotspot:t,bounds:n,area:r,isVisible:!1}),this.hotspotAreas.set(t.id,r)}createGroup(t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return Object.assign(e.style,{cursor:"pointer",pointerEvents:"fill",opacity:this.debugMode?"1":"0",transition:"opacity 0.2s ease-out","-webkit-tap-highlight-color":"transparent"}),e.setAttribute("data-hotspot-id",t.id),e}createPath(t){const e=document.createElementNS("http://www.w3.org/2000/svg","path"),i=t.reduce((n,[r,o],a)=>n+(a===0?"M":"L")+`${Math.round(r)},${Math.round(o)}`,"")+"Z";return e.setAttribute("d",i),e.setAttribute("vector-effect","non-scaling-stroke"),e.style.pointerEvents="fill",e}setupDragDetection(){this.viewer.addHandler("canvas-drag",()=>{this.isDragging=!0}),this.viewer.addHandler("canvas-drag-end",()=>{this.isDragging=!1})}setupMouseTracking(){this.svg.style.pointerEvents="auto";const t=this.viewer.container;t.addEventListener("pointerdown",this.handlePointerDown.bind(this)),t.addEventListener("pointermove",this.handlePointerMove.bind(this)),t.addEventListener("pointerup",this.handlePointerUp.bind(this)),t.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.svg.addEventListener("mousemove",e=>{const i=this.viewer.element.getBoundingClientRect(),n=new ot.Point(e.clientX-i.left,e.clientY-i.top),r=this.viewer.viewport.pointFromPixel(n),o=this.viewer.viewport.viewportToImageCoordinates(r),a=this.findSmallestHotspotAtPoint(o);if(a!==this.hoveredHotspot){if(this.hoveredHotspot){const c=this.overlays.get(this.hoveredHotspot.id);c&&this.applyStyle(c.element,this.hoveredHotspot.type,this.hoveredHotspot===this.selectedHotspot?"selected":"normal")}if(this.hoveredHotspot=a,this.onHotspotHover(a),a){const c=this.overlays.get(a.id);c&&this.applyStyle(c.element,a.type,"hover")}}this.svg.style.cursor=a?"pointer":"default"})}handlePointerDown(t){this.updatesPaused&&(console.warn("Updates were paused during interaction - forcing resume"),this.resumeUpdates()),console.log("handlePointerDown",{pointerId:t.pointerId,activePointersBefore:this.activePointers.size}),this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Date.now()}),this.isMobile&&t.preventDefault(),this.activePointers.size===1&&(this.primaryPointerId=t.pointerId,this.lastPointerDownTime=Date.now(),this.lastPointerDownPoint={x:t.clientX,y:t.clientY})}handlePointerMove(t){if(this.activePointers.has(t.pointerId)){const e=this.activePointers.get(t.pointerId);e.x=t.clientX,e.y=t.clientY,this.activePointers.size>=2&&(this.isPinching=!0)}}handlePointerUp(t){if(console.log("handlePointerUp start",{pointerId:t.pointerId,hasPointer:this.activePointers.has(t.pointerId),activePointers:this.activePointers.size}),!this.activePointers.has(t.pointerId))return;const e=this.activePointers.get(t.pointerId),i=Date.now()-e.startTime,n=Math.sqrt(Math.pow(t.clientX-e.startX,2)+Math.pow(t.clientY-e.startY,2));console.log("handlePointerUp checks",{isPrimary:t.pointerId===this.primaryPointerId,primaryPointerId:this.primaryPointerId,activePointers:this.activePointers.size,isPinching:this.isPinching,isDragging:this.isDragging,duration:i,clickTimeThreshold:this.clickTimeThreshold,distance:n,clickDistThreshold:this.clickDistThreshold}),t.pointerId===this.primaryPointerId&&this.activePointers.size===1&&!this.isPinching&&!this.isDragging&&i<this.clickTimeThreshold&&n<this.clickDistThreshold?(console.log("Conditions passed, calling handleClick"),this.handleClick(t)):console.log("Click conditions NOT met"),this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handlePointerCancel(t){this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handleClick(t){if(console.log("handleClick called",{isDragging:this.isDragging,isPinching:this.isPinching,activePointers:this.activePointers.size,timestamp:Date.now()}),t.target.closest(".openseadragon-controls"))return;if(this.isMobile&&this.hoveredHotspot){console.log("Using cached hover hotspot for mobile click"),t.stopPropagation(),t.preventDefault(),this.activateHotspot(this.hoveredHotspot);return}const e=this.viewer.element.getBoundingClientRect(),i=new ot.Point(t.clientX-e.left,t.clientY-e.top),n=this.viewer.viewport.pointFromPixel(i),r=this.viewer.viewport.viewportToImageCoordinates(n),o=this.findSmallestHotspotAtPoint(r);o?(t.stopPropagation(),t.preventDefault(),this.activateHotspot(o)):this.selectedHotspot&&(this.deselectHotspot(),this.onHotspotClick&&this.onHotspotClick(null))}activateHotspot(t){console.log("Activating hotspot:",t.id,Date.now()),this.selectedHotspot=t,this.selectionTimestamp=Date.now(),this.onHotspotClick(t),this.overlays.forEach((e,i)=>{var r;const n=i===t.id?"selected":i===((r=this.hoveredHotspot)==null?void 0:r.id)?"hover":"normal";this.applyStyle(e.element,e.hotspot.type,n)})}deselectHotspot(){console.log("Deselecting hotspot"),this.selectedHotspot=null,this.selectionTimestamp=null,this.overlays.forEach((t,e)=>{var n;const i=e===((n=this.hoveredHotspot)==null?void 0:n.id)?"hover":"normal";this.applyStyle(t.element,t.hotspot.type,i)})}instantDeselect(){var t;if(console.log("Instant deselecting hotspot"),this.selectedHotspot){const e=this.overlays.get(this.selectedHotspot.id);if(e&&e.element){const i=e.element.getElementsByTagName("path");for(let n of i)n.style.filter="none",n.style.stroke="rgba(255, 255, 255, 0)",n.style.strokeWidth="0",n.style.opacity="0",n.style.transition="none",n.style.animation="none";e.element.style.opacity="0",e.element.style.transition="none",e.element.style.animation="none",e.element.style.filter="none"}((t=this.hoveredHotspot)==null?void 0:t.id)===this.selectedHotspot.id&&(this.hoveredHotspot=null)}this.selectedHotspot=null,this.selectionTimestamp=null}findSmallestHotspotAtPoint(t){const e=[];return this.overlays.forEach((i,n)=>{i.isVisible&&this.isPointInHotspot(t,i)&&e.push({hotspot:i.hotspot,area:i.area})}),e.length===0?null:(e.sort((i,n)=>i.area-n.area),e[0].hotspot)}isPointInHotspot(t,e){const i=e.hotspot,n=e.bounds;return t.x<n.minX||t.x>n.maxX||t.y<n.minY||t.y>n.maxY?!1:i.shape==="polygon"?this.pointInPolygon(t.x,t.y,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(r=>this.pointInPolygon(t.x,t.y,r)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}applyStyle(t,e,i){const n=this.styles[e]||this.styles.audio_only,r=t.getElementsByTagName("path"),o=this.calculateGlowIntensity();t.setAttribute("class",`hotspot-${e} hotspot-${i}`);for(let a of r)if(this.debugMode)Object.assign(a.style,{fill:n[`${i}Fill`]||n.fill,stroke:n.stroke,strokeWidth:n[`${i}StrokeWidth`]+"px"||n.strokeWidth+"px",filter:i==="hover"?`drop-shadow(0 0 8px ${n.stroke})`:"",opacity:"1"});else{const c=i==="hover",h=i==="selected";let d=0;if((c||h)&&(o>.7?d=1.5:o>.5?d=1:d=.5),Object.assign(a.style,{fill:n[`${i}Fill`]||n.fill,stroke:c||h?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0)",strokeWidth:d+"px",strokeOpacity:o,transition:"all 0.2s ease",filter:"none",opacity:c||h?"1":"0"}),(c||h)&&o>.3){const l=Math.max(1,3*o),f=o*.3;a.style.filter=`drop-shadow(0 0 ${l}px rgba(255, 255, 255, ${f}))`}}this.debugMode?t.style.opacity="1":(t.style.opacity=i==="hover"||i==="selected"?"1":"0",i==="hover"&&o>.5?t.style.animation="hotspotPulse 1.5s ease-in-out infinite":t.style.animation="")}calculateBounds(t){let e={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};const i=n=>{n.forEach(([r,o])=>{e.minX=Math.min(e.minX,r),e.minY=Math.min(e.minY,o),e.maxX=Math.max(e.maxX,r),e.maxY=Math.max(e.maxY,o)})};return Array.isArray(t[0])&&typeof t[0][0]=="number"?i(t):t.forEach(i),e}calculateArea(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}calculateGlowIntensity(){if(!this.viewer||!this.viewer.viewport)return 1;const t=this.viewer.viewport.getZoom(),e=1,i=10;if(t<=e)return 1;if(t>=i)return .3;const n=(t-e)/(i-e);return .3+(1-Math.pow(n,.5))*.7}createSimpleSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
           width="${t.x}" height="${t.y}" 
           viewBox="0 0 ${t.x} ${t.y}"
           style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
    </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}startVisibilityTracking(){let t=null,e=0;this.isMobile;const i=()=>{if(t&&clearTimeout(t),this.isAnimationInProgress||this.viewer.isAnimating()){this.pendingVisibilityUpdate=!0;return}const r=Date.now()-e,o=this.viewer.viewport.getZoom()<5?100:50;if(r<o){t=setTimeout(()=>{i()},o-r);return}t=setTimeout(()=>{e=Date.now(),this.updateVisibility()},this.renderDebounceTime)};this.viewer.addHandler("animation",i),this.viewer.addHandler("animation-finish",()=>{!this.updatesPaused&&!this.isAnimationInProgress&&this.updateVisibility()}),this.isMobile||this.viewer.addHandler("viewport-change",i),this.updateVisibility()}updateVisibility(){var p,g;if(this.updatesPaused||this.isAnimationInProgress){console.log("updateVisibility BLOCKED - animation in progress"),this.pendingVisibilityUpdate=!0;return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.zoomSpring.target.value;if(Math.abs(t-e)>.001){console.log("updateVisibility SKIPPED - viewer is zooming"),this.pendingVisibilityUpdate=!0;return}if(this.viewer.isAnimating()){console.log("updateVisibility SKIPPED - viewer is animating"),this.pendingVisibilityUpdate=!0;return}const n=this.viewer.viewport.getBounds();if(this.lastViewportBounds&&this.lastViewportZoom){const v=Math.abs(n.x-this.lastViewportBounds.x)>this.significantChangeThreshold||Math.abs(n.y-this.lastViewportBounds.y)>this.significantChangeThreshold||Math.abs(n.width-this.lastViewportBounds.width)>this.significantChangeThreshold||Math.abs(n.height-this.lastViewportBounds.height)>this.significantChangeThreshold,w=Math.abs(t-this.lastViewportZoom)>.1;if(!v&&!w)return}this.lastViewportBounds=n,this.lastViewportZoom=t;const r=this.viewer.viewport;if(r.getZoom()<1.5){const v=(p=this.selectedHotspot)==null?void 0:p.id,w=(g=this.hoveredHotspot)==null?void 0:g.id;requestAnimationFrame(()=>{this.overlays.forEach(E=>{const I=E.hotspot.id===v||E.hotspot.id===w;E.element.style.opacity=I?"1":"0",E.isVisible=!0})});return}const a=r.viewportToImageCoordinates(n.getTopLeft()),c=r.viewportToImageCoordinates(n.getBottomRight()),h={minX:a.x,minY:a.y,maxX:c.x,maxY:c.y},d=(h.maxX-h.minX)*.2;h.minX-=d,h.minY-=d,h.maxX+=d,h.maxY+=d;const l=[];let f=0;this.overlays.forEach((v,w)=>{v.bounds.maxX<h.minX||v.bounds.minX>h.maxX||v.bounds.maxY<h.minY||v.bounds.minY>h.maxY?v.isVisible&&(l.push({element:v.element,opacity:"0"}),v.isVisible=!1,this.visibleOverlays.delete(w)):(f++,v.isVisible||(l.push({element:v.element,opacity:"1"}),v.isVisible=!0,this.visibleOverlays.add(w)))}),l.length>0&&requestAnimationFrame(()=>{l.forEach(v=>{v.element.style.opacity=v.opacity})}),Math.abs(t-this.lastViewportZoom)>.5&&requestAnimationFrame(()=>{this.viewer.world.getItemCount()>0&&this.viewer.updateOverlay(this.svg)}),f>100&&console.log(`Performance note: ${f} hotspots visible`)}updateVisibilityLazy(){if(this.updatesPaused){console.log("updateVisibilityLazy SKIPPED - updates are paused");return}console.log("updateVisibilityLazy starting - mobile optimized");const t=this.viewer.viewport;if(t.getZoom(),this.viewer.isAnimating()){console.log("updateVisibilityLazy deferred - still animating"),setTimeout(()=>this.updateVisibilityLazy(),100);return}const e=t.getBounds(),i=t.viewportToImageCoordinates(e.getTopLeft()),n=t.viewportToImageCoordinates(e.getBottomRight()),r={minX:i.x,minY:i.y,maxX:n.x,maxY:n.y},o=(r.maxX-r.minX)*.2;Object.keys(r).forEach(f=>{r[f]+=f.startsWith("min")?-o:o});const a=Array.from(this.overlays.entries());let c=0,h=0;const d=30,l=()=>{const f=performance.now();for(h=0;c<a.length&&h<d&&performance.now()-f<8;){const[p,g]=a[c],v=this.boundsIntersect(g.bounds,r);v!==g.isVisible&&(g.element.style.opacity=v?"1":"0",g.isVisible=v,v?this.visibleOverlays.add(p):this.visibleOverlays.delete(p)),c++,h++}c<a.length?"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:50}):requestAnimationFrame(l):this.viewer.world.getItemCount()>0&&requestAnimationFrame(()=>{this.viewer.updateOverlay(this.svg),console.log("updateVisibilityLazy complete")})};"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:100}):setTimeout(()=>requestAnimationFrame(l),50)}boundsIntersect(t,e){return!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)}zoomToHotspot(t){const e=this.overlays.get(t.id);if(!e)return;const i=e.bounds,n=this.viewer.world.getItemAt(0).getContentSize(),r=new ot.Rect(i.minX/n.x,i.minY/n.y,(i.maxX-i.minX)/n.x,(i.maxY-i.minY)/n.y),o=e.area,a=n.x*n.y,c=o/a,h=c<.01?1:c<.05?.7:c<.1?.5:.3,d=r.width*h,l=r.height*h,f=new ot.Rect(r.x-d,r.y-l,r.width+d*2,r.height+l*2);this.viewer.viewport.fitBounds(f,!1)}getOverlapMetrics(){const t=[],e=Array.from(this.overlays.values());for(let i=0;i<e.length;i++)for(let n=i+1;n<e.length;n++)this.boundsIntersect(e[i].bounds,e[n].bounds)&&t.push({hotspot1:e[i].hotspot.id,hotspot2:e[n].hotspot.id,area1:e[i].area,area2:e[n].area});return{totalOverlaps:t.length,overlaps:t}}setDebugMode(t){this.debugMode=t,this.initStyles(),this.overlays.forEach((e,i)=>{var r,o;const n=i===((r=this.selectedHotspot)==null?void 0:r.id)?"selected":i===((o=this.hoveredHotspot)==null?void 0:o.id)?"hover":"normal";this.applyStyle(e.element,e.hotspot.type,n)})}pauseUpdates(){console.log("pauseUpdates called - blocking all visibility updates"),this.updatesPaused=!0,this.isAnimationInProgress=!0,this.selectedHotspot&&this.overlays.forEach((t,e)=>{var i;e!==this.selectedHotspot.id&&e!==((i=this.hoveredHotspot)==null?void 0:i.id)&&(t.element.style.visibility="hidden")})}resumeUpdates(){console.log("resumeUpdates called - unblocking updates"),this.updatesPaused=!1,this.isAnimationInProgress=!1,this.overlays.forEach(t=>{t.element.style.visibility="visible"}),this.pendingVisibilityUpdate&&(this.pendingVisibilityUpdate=!1,this.isMobile?this.updateVisibilityLazy():this.updateVisibility())}hideOverlay(){console.log("Hiding entire SVG overlay"),this.svg&&(this.svg.style.display="none")}showOverlay(){console.log("Showing SVG overlay"),this.svg&&(this.svg.style.display="")}destroy(){this.mouseTracker&&this.mouseTracker.destroy(),this.viewer.removeAllHandlers("animation"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("animation-update"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeHandler("canvas-drag"),this.viewer.removeHandler("canvas-drag-end"),this.viewer.removeHandler("zoom"),this.svg&&(this.svg.removeEventListener("pointerdown",this.handlePointerDown),this.svg.removeEventListener("pointermove",this.handlePointerMove),this.svg.removeEventListener("pointerup",this.handlePointerUp),this.svg.removeEventListener("pointercancel",this.handlePointerCancel),this.viewer.removeOverlay(this.svg)),this.overlays.clear(),this.visibleOverlays.clear(),this.hotspotAreas.clear(),this.viewer=null,window.nativeHotspotRenderer===this&&(window.nativeHotspotRenderer=null)}}class td{constructor(t){this.viewer=t,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[],this.thresholds={fps:{target:60,good:55,acceptable:45,poor:30,critical:20},frameTime:{target:16.67,warning:20},memory:{warning:250,critical:300}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const t={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(t).forEach(([e,i])=>this.viewer.addHandler(e,i.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(t=>this.viewer.removeAllHandlers(t))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const t=performance.now(),e=t-this.lastTime;this.updateFrameMetrics(e),this.lastTime=t,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(t){if(this.frameTimes.push(t),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),t>0){const e=1e3/t;this.fpsHistory.push(e),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=e,t>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const t=this.viewer.drawer.canvas;t&&(this.metrics.canvasSize=`${t.width}${t.height}`);const i=this.viewer.viewport.getBounds(),n=this.viewer.world.getHomeBounds(),r=i.width*i.height/(n.width*n.height);this.metrics.viewportCoverage=Math.min(100,r*100).toFixed(1)}updateTileMetrics(){var i,n;const t=this.viewer.world;if(t.getItemCount()===0)return;const e=t.getItemAt(0);if(e){if(this.metrics.visibleTiles=((i=e._tilesToDraw)==null?void 0:i.length)||0,e._tileCache){const r=e._tileCache;this.metrics.cachedTiles=((n=r._tilesLoaded)==null?void 0:n.length)||r._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:t,frameTime:e,memory:i}=this.thresholds,n={fps:Math.min(100,this.metrics.averageFPS/t.target*100)*.5,frameTime:Math.min(100,e.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(n).reduce((r,o)=>r+o,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const t=Date.now();if(t-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:e}=this.thresholds,i=this.metrics.averageFPS,n=this.metrics.performanceScore,r=this.getPerformanceTrend(),o=[{condition:i<e.critical||n<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:i<e.poor||n<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:i<e.good||n<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:i>e.target&&n>90&&(r==="improving"||r==="stable"),action:this.restoreQualitySettings,log:null}];for(const a of o)if(a.condition){a.log&&console[a.log==="CRITICAL"?"error":"warn"](`${a.log} performance: Score ${n}, FPS: ${i}`),a.action.call(this),this.lastOptimization=t;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const t=this.performanceHistory.slice(-10),e=this.performanceHistory.slice(-20,-10),i=this.average(t.map(o=>o.score)),n=this.average(e.map(o=>o.score)),r=i-n;return r>5?"improving":r<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var i;const t=(i=window.performanceConfig)==null?void 0:i.viewer;if(!t)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:n,delta:r,op:o})=>{const a=this.viewer[n],c=t[n];o==="increase"&&a<c?this.viewer[n]=Math.min(c,a+r):o==="decrease"&&a>c&&(this.viewer[n]=Math.max(c,a-r))})}onTileLoaded(t){var e;(e=t.tile)!=null&&e.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+t.tile.loadTime*.1)}onTileLoadFailed(t){console.warn("Tile load failed:",t.tile)}trackLoadTime(t){this.loadTimes.push(t),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const t=this.getPerformanceLevel();return{...this.metrics,performanceLevel:t,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:t,performanceScore:e}=this.metrics,{fps:i}=this.thresholds;return[{name:"excellent",condition:t>=i.target&&e>=90},{name:"good",condition:t>=i.good&&e>=80},{name:"acceptable",condition:t>=i.acceptable&&e>=60},{name:"poor",condition:t>=i.poor&&e>=40},{name:"critical",condition:!0}].find(r=>r.condition).name}getWarnings(){const t=this.metrics,e=this.thresholds;return[{condition:t.averageFPS<e.fps.acceptable,message:`Low FPS: ${t.averageFPS} (target: ${e.fps.target})`},{condition:t.droppedFrames>100,message:`Dropped frames: ${t.droppedFrames}`},{condition:parseFloat(t.frameTime)>e.frameTime.warning,message:`High frame time: ${t.frameTime}ms`},{condition:t.memoryUsage>e.memory.critical,message:`High memory: ${t.memoryUsage}MB`},{condition:t.cachedTiles>2e3,message:`Large cache: ${t.cachedTiles} tiles`},{condition:t.tileLoadTime>300,message:`Slow tile loading: ${Math.round(t.tileLoadTime)}ms`}].filter(n=>n.condition).map(n=>n.message)}getRecommendations(){const t=[],e=this.metrics,i=this.thresholds;return e.averageFPS<i.fps.acceptable&&(e.renderMode==="animating"&&t.push("Reduce animation time for smoother transitions"),e.cachedTiles>1e3&&t.push("Clear tile cache to free memory"),e.visibleTiles>50&&t.push("Zoom in to reduce visible tiles")),e.memoryUsage>i.memory.warning&&t.push("Consider reloading the page to clear memory"),e.tileLoadTime>200&&t.push("Check network connection or reduce concurrent tile loads"),t}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const t=this.getMetrics(),e={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},i=t.currentFPS<55?"#FF9800":"#4CAF50",n=t.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${e[t.performanceLevel]};">
                    ${t.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${i};">
                    ${t.currentFPS.toFixed(0)} (avg: ${t.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${t.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${n};">
                    ${t.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${e[t.performanceLevel]}; font-weight: 500;">
                    ${t.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(t){return t.reduce((e,i)=>e+i,0)/t.length}trimArray(t,e){for(;t.length>e;)t.shift()}}class id{constructor(t){this.viewer=t,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([e,i])=>this.viewer.addHandler(e,i))}applyInitialOptimizations(){const t=this.viewer.container;t&&Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const t=performance.now(),e=t-this.state.lastFrameTime;if(this.state.lastFrameTime=t,this.viewer.viewport.getZoom()<3&&e>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let t=null,e=!1;this.viewer.addHandler("zoom",()=>{if(!e){if(e=!0,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!1,i.globalAlpha=1}this.viewer.skipTileDrawing=!0}t&&clearTimeout(t),t=setTimeout(()=>{if(e=!1,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!0,i.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),t=null},150)})}handleViewportChange(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const i=Math.abs(t-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+i*.3,this.state.isZooming=i>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const i=Math.sqrt(Math.pow(e.x-this.lastCenter.x,2)+Math.pow(e.y-this.lastCenter.y,2));this.state.isPanning=i>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=t,this.lastCenter=e}applyZoomOptimizations(t){var i,n;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((n=(i=window.performanceConfig)==null?void 0:i.renderOptimization)!=null&&n.zoomOptimizations))){if(t&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&(this.state.lastBlendTime=r.blendTime,r.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!t&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&this.state.lastBlendTime!==null&&(r.blendTime=this.state.lastBlendTime)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(t){var i;this.lastInteraction=Date.now();const e={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(i=e[t])==null||i.call(e)}setRenderMode(t){var i,n;if(this.state.renderMode===t)return;const e=this.state.renderMode;this.state.renderMode=t,t==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):t==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(n=(i=window.performanceConfig)==null?void 0:i.debug)!=null&&n.logPerformance&&console.log(`Render mode: ${e}  ${t}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var n,r;const t=Date.now();if(t-this.lastOptimizationTime<this.config.optimizationCooldown)return;const e=(n=this.viewer.drawer)==null?void 0:n.canvas,i=(r=this.viewer.drawer)==null?void 0:r.context;!e||!i||(Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(i,!0),i.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=t)}removeCanvasOptimizations(){var e;const t=(e=this.viewer.drawer)==null?void 0:e.context;t&&(this.setContextSmoothing(t,!0),t.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(t,e){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(n=>{n in t&&(t[n]=e)})}clearTimers(){Object.entries(this.timers).forEach(([t,e])=>{clearTimeout(e),delete this.timers[t]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(t){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(i=>Object.assign(i.style,t))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(t){Object.assign(this.config,t)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var t,e;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((e=(t=window.performanceConfig)==null?void 0:t.viewer)==null?void 0:e.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(t=>this.viewer.removeAllHandlers(t)),this.removeCanvasOptimizations(),this.viewer=null}}function Dc(s,t,e=0,i=s.length-1,n=nd){for(;i>e;){if(i-e>600){const c=i-e+1,h=t-e+1,d=Math.log(c),l=.5*Math.exp(2*d/3),f=.5*Math.sqrt(d*l*(c-l)/c)*(h-c/2<0?-1:1),p=Math.max(e,Math.floor(t-h*l/c+f)),g=Math.min(i,Math.floor(t+(c-h)*l/c+f));Dc(s,t,p,g,n)}const r=s[t];let o=e,a=i;for(sr(s,e,t),n(s[i],r)>0&&sr(s,e,i);o<a;){for(sr(s,o,a),o++,a--;n(s[o],r)<0;)o++;for(;n(s[a],r)>0;)a--}n(s[e],r)===0?sr(s,e,a):(a++,sr(s,a,i)),a<=t&&(e=a+1),t<=a&&(i=a-1)}}function sr(s,t,e){const i=s[t];s[t]=s[e],s[e]=i}function nd(s,t){return s<t?-1:s>t?1:0}class rd{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const i=[];if(!Xr(t,e))return i;const n=this.toBBox,r=[];for(;e;){for(let o=0;o<e.children.length;o++){const a=e.children[o],c=e.leaf?n(a):a;Xr(t,c)&&(e.leaf?i.push(a):no(t,c)?this._all(a,i):r.push(a))}e=r.pop()}return i}collides(t){let e=this.data;if(!Xr(t,e))return!1;const i=[];for(;e;){for(let n=0;n<e.children.length;n++){const r=e.children[n],o=e.leaf?this.toBBox(r):r;if(Xr(t,o)){if(e.leaf||no(t,o))return!0;i.push(r)}}e=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const i=this.data;this.data=e,e=i}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Cn([]),this}remove(t,e){if(!t)return this;let i=this.data;const n=this.toBBox(t),r=[],o=[];let a,c,h;for(;i||r.length;){if(i||(i=r.pop(),c=r[r.length-1],a=o.pop(),h=!0),i.leaf){const d=sd(t,i.children,e);if(d!==-1)return i.children.splice(d,1),r.push(i),this._condense(r),this}!h&&!i.leaf&&no(i,n)?(r.push(i),o.push(a),a=0,c=i,i=i.children[0]):c?(a++,i=c.children[a],h=!1):i=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,n){const r=i-e+1;let o=this._maxEntries,a;if(r<=o)return a=Cn(t.slice(e,i+1)),bn(a,this.toBBox),a;n||(n=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,n-1))),a=Cn([]),a.leaf=!1,a.height=n;const c=Math.ceil(r/o),h=c*Math.ceil(Math.sqrt(o));tl(t,e,i,h,this.compareMinX);for(let d=e;d<=i;d+=h){const l=Math.min(d+h-1,i);tl(t,d,l,c,this.compareMinY);for(let f=d;f<=l;f+=c){const p=Math.min(f+c-1,l);a.children.push(this._build(t,f,p,n-1))}}return bn(a,this.toBBox),a}_chooseSubtree(t,e,i,n){for(;n.push(e),!(e.leaf||n.length-1===i);){let r=1/0,o=1/0,a;for(let c=0;c<e.children.length;c++){const h=e.children[c],d=io(h),l=ld(t,h)-d;l<o?(o=l,r=d<r?d:r,a=h):l===o&&d<r&&(r=d,a=h)}e=a||e.children[0]}return e}_insert(t,e,i){const n=i?t:this.toBBox(t),r=[],o=this._chooseSubtree(n,this.data,e,r);for(o.children.push(t),ar(o,n);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(n,r,e)}_split(t,e){const i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);const o=this._chooseSplitIndex(i,r,n),a=Cn(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,bn(i,this.toBBox),bn(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)}_splitRoot(t,e){this.data=Cn([t,e]),this.data.height=t.height+1,this.data.leaf=!1,bn(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let n,r=1/0,o=1/0;for(let a=e;a<=i-e;a++){const c=or(t,0,a,this.toBBox),h=or(t,a,i,this.toBBox),d=cd(c,h),l=io(c)+io(h);d<r?(r=d,n=a,o=l<o?l:o):d===r&&l<o&&(o=l,n=a)}return n||i-e}_chooseSplitAxis(t,e,i){const n=t.leaf?this.compareMinX:od,r=t.leaf?this.compareMinY:ad,o=this._allDistMargin(t,e,i,n),a=this._allDistMargin(t,e,i,r);o<a&&t.children.sort(n)}_allDistMargin(t,e,i,n){t.children.sort(n);const r=this.toBBox,o=or(t,0,e,r),a=or(t,i-e,i,r);let c=Zr(o)+Zr(a);for(let h=e;h<i-e;h++){const d=t.children[h];ar(o,t.leaf?r(d):d),c+=Zr(o)}for(let h=i-e-1;h>=e;h--){const d=t.children[h];ar(a,t.leaf?r(d):d),c+=Zr(a)}return c}_adjustParentBBoxes(t,e,i){for(let n=i;n>=0;n--)ar(e[n],t)}_condense(t){for(let e=t.length-1,i;e>=0;e--)t[e].children.length===0?e>0?(i=t[e-1].children,i.splice(i.indexOf(t[e]),1)):this.clear():bn(t[e],this.toBBox)}}function sd(s,t,e){if(!e)return t.indexOf(s);for(let i=0;i<t.length;i++)if(e(s,t[i]))return i;return-1}function bn(s,t){or(s,0,s.children.length,t,s)}function or(s,t,e,i,n){n||(n=Cn(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let r=t;r<e;r++){const o=s.children[r];ar(n,s.leaf?i(o):o)}return n}function ar(s,t){return s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY),s}function od(s,t){return s.minX-t.minX}function ad(s,t){return s.minY-t.minY}function io(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function Zr(s){return s.maxX-s.minX+(s.maxY-s.minY)}function ld(s,t){return(Math.max(t.maxX,s.maxX)-Math.min(t.minX,s.minX))*(Math.max(t.maxY,s.maxY)-Math.min(t.minY,s.minY))}function cd(s,t){const e=Math.max(s.minX,t.minX),i=Math.max(s.minY,t.minY),n=Math.min(s.maxX,t.maxX),r=Math.min(s.maxY,t.maxY);return Math.max(0,n-e)*Math.max(0,r-i)}function no(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function Xr(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function Cn(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function tl(s,t,e,i,n){const r=[t,e];for(;r.length;){if(e=r.pop(),t=r.pop(),e-t<=i)continue;const o=t+Math.ceil((e-t)/i/2)*i;Dc(s,o,t,e,n),r.push(t,o,o,e)}}class hd{constructor(){this.tree=new rd(9),this.hotspots=new Map,this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(t){const e=performance.now();this.tree.clear(),this.hotspots.clear(),this.queryCache.clear();const i=[];t.forEach(r=>{const o=this.calculateBoundingBox(r.coordinates);this.hotspots.set(r.id,{...r,bbox:o}),i.push({minX:o.minX,minY:o.minY,maxX:o.maxX,maxY:o.maxY,id:r.id})}),this.tree.load(i);const n=performance.now()-e;console.log(`Spatial index built in ${n.toFixed(2)}ms for ${i.length} hotspots`)}queryViewport(t,e=1){const i=`${t.minX.toFixed(2)},${t.minY.toFixed(2)},${t.maxX.toFixed(2)},${t.maxY.toFixed(2)},${e.toFixed(2)}`;if(this.queryCache.has(i))return this.queryCache.get(i);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const r=this.tree.search({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY}).map(o=>this.hotspots.get(o.id));return this.queryCache.size<this.cacheSize&&this.queryCache.set(i,r),r}getHotspotAtPoint(t,e){const i=this.tree.search({minX:t,minY:e,maxX:t,maxY:e});for(const n of i){const r=this.hotspots.get(n.id);if(this.isPointInHotspot(t,e,r))return r}return null}calculateBoundingBox(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{for(const c of a)e=Math.min(e,c[0]),i=Math.min(i,c[1]),n=Math.max(n,c[0]),r=Math.max(r,c[1])};if(t.length>0&&typeof t[0][0]=="number")o(t);else for(const a of t)o(a);return{minX:e,minY:i,maxX:n,maxY:r}}isPointInHotspot(t,e,i){return i.shape==="polygon"?this.pointInPolygon(t,e,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(n=>this.pointInPolygon(t,e,n)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}getAllHotspots(){return Array.from(this.hotspots.values())}clear(){this.tree.clear(),this.hotspots.clear(),this.queryCache.clear()}}class ud{constructor(t){this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:15}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(t){if(!t.tile)return;const e=this.getTileKey(t.tile);this.tileAccessTimes.set(e,Date.now())}handleViewportChange(){var i;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0);if(!t||!t._tilesToDraw)return;const e=Date.now();t._tilesToDraw.forEach(n=>{const r=this.getTileKey(n);this.tileAccessTimes.set(r,e)})}getTileKey(t){return`${t.level}_${t.x}_${t.y}`}monitorPerformance(){var i,n;const t=((n=(i=window.performanceMonitor)==null?void 0:i.getMetrics())==null?void 0:n.averageFPS)||60,e=this.state.currentPressure;t<this.config.fpsThresholds.critical?this.state.currentPressure="critical":t<this.config.fpsThresholds.poor?this.state.currentPressure="high":t<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",e!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${e}  ${this.state.currentPressure} (FPS: ${t})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const e={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),e)}performCleanup(){var L;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const e=performance.now(),i=(L=this.viewer.world)==null?void 0:L.getItemAt(0);if(!i||!i._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const r=this.state.currentPressure,o=this.config.maxTileAge[r],a=this.config.cacheThresholds[r],c=this.config.keepDistance[r],h=Date.now(),l=this.viewer.viewport.getBounds(),f={x:l.x-l.width*(c-1)/2,y:l.y-l.height*(c-1)/2,width:l.width*c,height:l.height*c},g=i._tileCache._tilesLoaded||[],v=g.length;if(v===0)return;const w=new Set;i._tilesToDraw&&i._tilesToDraw.forEach(N=>{const Z=this.getTileKey(N);w.add(Z)});const E=[];if(g.forEach(N=>{const Z=this.getTileKey(N);if(w.has(Z))return;const J=this.tileAccessTimes.get(Z)||0,k=h-J;let A=!1;if(k>o&&(A=!0),!A&&r!=="normal"){const P=N.bounds;P&&(!(P.x+P.width<f.x||P.x>f.x+f.width||P.y+P.height<f.y||P.y>f.y+f.height)||(A=!0))}A&&E.push(N)}),v>a){const N=v-a;if(N>E.length){const Z=g.filter(k=>{const A=this.getTileKey(k);return!E.includes(k)&&!w.has(A)});Z.sort((k,A)=>{const P=this.getTileKey(k),M=this.getTileKey(A),F=this.tileAccessTimes.get(P)||0,O=this.tileAccessTimes.get(M)||0;return F-O});const J=N-E.length;E.push(...Z.slice(0,J))}}E.length>0&&(E.forEach(N=>{const Z=this.getTileKey(N);this.tileAccessTimes.delete(Z),N.unload&&N.unload()}),this.state.tilesRemoved+=E.length,this.metrics.totalCleaned+=E.length,console.log(`Cleaned ${E.length} tiles (pressure: ${r}, cache was: ${v}, kept ${w.size} visible)`));const I=performance.now()-e;this.metrics.lastCleanupDuration=I,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+I)/this.metrics.cleanupRuns,this.state.lastCleanup=h,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const e=performance.now(),i=Date.now(),n=3e5,r=[];this.tileAccessTimes.forEach((a,c)=>{i-a>n&&r.push(c)}),r.forEach(a=>this.tileAccessTimes.delete(a)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const o=performance.now()-e;this.state.lastDeepCleanup=i,console.log(`Deep cleanup completed in ${o.toFixed(2)}ms, cleared ${r.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var i,n,r;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0),e=((r=(n=t==null?void 0:t._tileCache)==null?void 0:n._tilesLoaded)==null?void 0:r.length)||0;return{...this.metrics,currentCacheSize:e,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(t){["normal","elevated","high","critical"].includes(t)&&(this.state.currentPressure=t,this.updateCleanupInterval())}pauseCleanup(t=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},t))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class dd{constructor(t){this.viewer=t,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(t){throw console.error("Failed to initialize TileWorkerManager:",t),this.state.lastError=t,t}}async processTile(t,e=2){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tile:t}),this.worker.postMessage({type:"process-tile",requestId:i,data:{tile:this.serializeTile(t),priority:e}}),this.metrics.requestsSent++})}async processBatch(t,e=[]){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Batch processing timeout"))},this.config.requestTimeout*t.length);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tiles:t}),this.worker.postMessage({type:"batch-process",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),priorities:e}}),this.metrics.requestsSent++})}async prioritizeTiles(t,e){if(this.isInitialized||await this.initialize(),t.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const n=t.map(r=>{const o=(r.bounds.minX+r.bounds.maxX)/2,a=(r.bounds.minY+r.bounds.maxY)/2,c=(e.bounds.minX+e.bounds.maxX)/2,h=(e.bounds.minY+e.bounds.maxY)/2,d=Math.sqrt(Math.pow(o-c,2)+Math.pow(a-h,2));return d<.5?0:d<1?1:2});return{tiles:t,priorities:n}}const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),n({tiles:t,priorities:t.map(()=>1)})},50);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:"prioritize",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),viewport:{bounds:e.bounds,zoom:e.zoom}}})})}clearCache(t=!1,e=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:t,maxAge:e}})}async getStats(){if(!this.isInitialized)return this.metrics;const t=this.generateRequestId();return new Promise(e=>{const i=setTimeout(()=>{this.state.pendingRequests.delete(t),e(this.metrics)},1e3);this.state.pendingRequests.set(t,{resolve:e,reject:()=>{},timeout:i}),this.worker.postMessage({type:"get-stats",requestId:t})})}handleWorkerMessage(t){const{type:e,requestId:i,data:n}=t.data;switch(e){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=n.capabilities,this.handleRequestComplete(i,n);break;case"tile-ready":this.handleTileReady(i,n);break;case"tile-error":this.handleTileError(i,n);break;case"batch-complete":this.handleRequestComplete(i,n);break;case"priorities-calculated":this.handleRequestComplete(i,n);break;case"stats":this.handleStatsReceived(i,n);break;case"cache-cleared":console.log("Worker cache cleared:",n);break;default:console.warn("Unknown worker message type:",e)}}handleWorkerError(t){console.error("Worker error:",t),this.state.lastError=t,this.state.pendingRequests.forEach((e,i)=>{clearTimeout(e.timeout),e.reject(t)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n=performance.now()-i.startTime;this.updateMetrics(n,e.cached),i.resolve({...e,processingTime:n})}handleTileError(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),this.metrics.requestsFailed++,i.reject(new Error(e.error)))}handleRequestComplete(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),i.resolve(e))}handleStatsReceived(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n={...this.metrics,worker:e};i.resolve(n)}updateMetrics(t,e){this.metrics.requestsCompleted++,e&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=t,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(t){return{level:t.level,x:t.x,y:t.y,bounds:t.bounds?{minX:t.bounds.x||t.bounds.minX,minY:t.bounds.y||t.bounds.minY,maxX:(t.bounds.x||t.bounds.minX)+(t.bounds.width||0),maxY:(t.bounds.y||t.bounds.minY)+(t.bounds.height||0)}:null,url:t.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(t=>{if(this.state.workerReady){t();return}const e=setInterval(()=>{this.state.workerReady&&(clearInterval(e),t())},100);setTimeout(()=>{clearInterval(e),t()},5e3)})}async sendToWorker(t,e){const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),r(new Error(`Worker request timeout: ${t}`))},5e3);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:t,requestId:i,data:e})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(t=>{clearTimeout(t.timeout),t.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class fd{constructor(t){this.viewer=t,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new dd(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(t){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",t),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const t=this.viewer.viewport,e=t.getBounds(),i={bounds:{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height},zoom:t.getZoom()},n=this.state.tileQueue.slice(0,50),r=await this.workerManager.prioritizeTiles(n,i);r.tiles&&r.priorities&&(r.tiles.forEach((o,a)=>{const c=r.priorities[a],h=this.state.tileQueue.find(d=>d.level===o.level&&d.x===o.x&&d.y===o.y);h&&(h.priority=c)}),this.sortQueue())}catch(t){console.warn("Failed to update worker priorities:",t)}}calculateTilePriority(t,e,i){const n=this.viewer.viewport,r=n.getBounds(),o=n.getCenter(),a=n.getZoom();if(a<2&&this.viewer.source.getTileWidth(t)*a<32)return 999;const c=this.viewer.source.getTileWidth(t),h=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):c,d=(e+.5)*c/this.viewer.source.width,l=(i+.5)*h/this.viewer.source.height,f=Math.sqrt(Math.pow(d-o.x,2)+Math.pow(l-o.y,2)),p={left:e*c/this.viewer.source.width,top:i*h/this.viewer.source.height,right:(e+1)*c/this.viewer.source.width,bottom:(i+1)*h/this.viewer.source.height};return p.right<r.x||p.left>r.x+r.width||p.bottom<r.y||p.top>r.y+r.height?f<r.width*this.config.predictiveRadius?1:2:a<3?Math.abs(d-o.x)+Math.abs(l-o.y)<.2?0:1:0}enqueueTile(t,e,i,n){const r=`${t}_${e}_${i}`;if(this.state.loadingTiles.has(r))return;const o=this.state.tileQueue.findIndex(c=>c.key===r);if(o>=0){n<this.state.tileQueue[o].priority&&(this.state.tileQueue[o].priority=n,this.sortQueue());return}const a={level:t,x:e,y:i,key:r,priority:n,timestamp:Date.now(),bounds:this.calculateTileBounds(t,e,i)};this.state.tileQueue.push(a),this.sortQueue()}calculateTileBounds(t,e,i){const n=this.viewer.source.getTileWidth(t),r=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):n,o=this.viewer.source.width,a=this.viewer.source.height;return{minX:e*n/o,minY:i*r/a,maxX:(e+1)*n/o,maxY:(i+1)*r/a}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const t=this.state.tileQueue.filter(e=>e.priority<=1).slice(0,this.config.workerBatchSize);if(t.length!==0)try{const e=t.map(r=>r.priority),i=performance.now();await this.workerManager.processBatch(t,e);const n=performance.now()-i;this.workerMetrics.tilesProcessedByWorker+=t.length,this.workerMetrics.workerProcessingTime+=n,t.forEach(r=>{const o=this.state.tileQueue.findIndex(a=>a.key===r.key);o>=0&&this.state.tileQueue.splice(o,1)})}catch(e){console.error("Worker batch processing failed:",e),this.workerMetrics.workerErrors++}}processQueue(){var e;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((e=this.viewer.world)!=null&&e.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const i=this.state.tileQueue.shift();Date.now()-i.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(i.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((t,e)=>t.priority!==e.priority?t.priority-e.priority:t.timestamp-e.timestamp)}predictiveLoad(){var f;if(this.shouldSkipPredictiveLoad()||!((f=this.viewer.world)==null?void 0:f.getItemAt(0))||!this.viewer.source)return;const e=this.viewer.viewport,i=e.getBounds(),n={x:i.x-i.width*(this.config.predictiveRadius-1)/2,y:i.y-i.height*(this.config.predictiveRadius-1)/2,width:i.width*this.config.predictiveRadius,height:i.height*this.config.predictiveRadius},r=e.getZoom(),o=Math.max(0,Math.min(Math.floor(Math.log2(r)),this.viewer.source.maxLevel||14)),a=this.viewer.source.getTileWidth(o),c=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(o):a,h=this.viewer.source.width,d=this.viewer.source.height,l={startX:Math.max(0,Math.floor(n.x*h/a)),endX:Math.min(Math.ceil(h/a)-1,Math.ceil((n.x+n.width)*h/a)),startY:Math.max(0,Math.floor(n.y*d/c)),endY:Math.min(Math.ceil(d/c)-1,Math.ceil((n.y+n.height)*d/c))};for(let p=l.startX;p<=l.endX;p++)for(let g=l.startY;g<=l.endY;g++){const v=this.calculateTilePriority(o,p,g);this.enqueueTile(o,p,g,v)}}trackLoadTime(t){this.state.loadTimes.push(t),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((e,i)=>e+i,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(t){this.state.loadingTiles.delete(t)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const t=this.state.averageLoadTime,e=this.config.maxConcurrentLoads;t>500&&e>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`)):t<200&&e<8&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`))}performCleanup(){const t=Date.now();this.state.tileQueue=this.state.tileQueue.filter(e=>t-e.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=t,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const t=document.createElement("canvas");t.width=t.height=1;const e=t.getContext("2d");e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,1,1);try{return t.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const t=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:t}}}let Yr=new Map,Kr=null,ro=null;function pd(s){if(console.log("=== APPLYING OPTIMIZED TILE CASCADE FIX ==="),/Android|iPhone|iPad/i.test(navigator.userAgent)){console.log("TileCascadeFix disabled on mobile for testing");return}if(!s){console.error("OpenSeadragon not provided - cannot apply tile cascade fix");return}const e=s.TiledImage.prototype._getLevelsInterval,i=s.TiledImage.prototype._updateLevels;if(!e){console.error("_getLevelsInterval method not found - cannot apply fix");return}s.TiledImage.prototype._getLevelsInterval=function(){const n=this.viewer.viewport.getZoom();if(Kr!==null&&Math.abs(n-Kr)<.01&&Yr.has(this))return Yr.get(this);const r=e.call(this);if(!r||typeof r.lowestLevel>"u")return r;let o=r;if(n<3){const a=/Android|iPhone|iPad/i.test(navigator.userAgent),c=Math.floor(Math.log2(n*1024/256)),h=Math.max(8,Math.min(12,c+11)),d=a?4:3;o={lowestLevel:Math.max(8,h-Math.floor(d/2)),highestLevel:Math.min(14,h+Math.floor(d/2))},o.highestLevel-o.lowestLevel>d-1&&(o.lowestLevel=o.highestLevel-(d-1))}return Yr.set(this,o),Kr=n,ro&&clearTimeout(ro),ro=setTimeout(()=>{Yr.clear(),Kr=null},100),o},i&&(s.TiledImage.prototype._updateLevels=function(){if(this.viewer.isAnimating())return;const n=i.call(this);if(this.viewer.viewport.getZoom()<3&&this._tilesToDraw){const o=this._getLevelsInterval();this._tilesToDraw=this._tilesToDraw.filter(a=>a.level>=o.lowestLevel&&a.level<=o.highestLevel)}return n}),console.log("=== OPTIMIZED TILE CASCADE FIX APPLIED ===")}class md{constructor(t){this.viewer=t,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const t=performance.now();return this.cacheEnabled&&this.cachedViewport&&t-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const t=performance.now(),e=this.viewer.viewport,i=e.getBounds(),n=e.viewportToImageCoordinates(i.getTopLeft()),r=e.viewportToImageCoordinates(i.getBottomRight()),o=r.x-n.x,a=r.y-n.y,c=o*this.viewportPadding,h=a*this.viewportPadding,d=this.viewer.world.getItemAt(0),l=d?d.getContentSize():{x:1,y:1},p={bounds:{minX:Math.max(0,n.x-c),minY:Math.max(0,n.y-h),maxX:Math.min(l.x,r.x+c),maxY:Math.min(l.y,r.y+h)},zoom:e.getZoom(!0),center:e.getCenter(!0),rotation:e.getRotation(),containerSize:e.getContainerSize(),imageBounds:{minX:n.x,minY:n.y,maxX:r.x,maxY:r.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=p,this.lastUpdate=performance.now();const g=this.lastUpdate-t;return this.metrics.lastUpdateDuration=g,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+g)/this.metrics.totalUpdates,p}isPointInViewport(t,e,i=!1){const n=this.getCurrentViewport(),r=i?n.bounds:n.imageBounds;return t>=r.minX&&t<=r.maxX&&e>=r.minY&&e<=r.maxY}isBoxInViewport(t,e,i,n,r=!0){const o=this.getCurrentViewport(),a=r?o.bounds:o.imageBounds;return!(i<a.minX||t>a.maxX||n<a.minY||e>a.maxY)}imageToPixel(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(t,e));return this.viewer.viewport.pixelFromPoint(i)}pixelToImage(t,e){const i=this.viewer.viewport.pointFromPixel(new ot.Point(t,e));return this.viewer.viewport.viewportToImageCoordinates(i)}calculatePixelRatio(){const t=this.viewer.viewport,e=t.getContainerSize(),i=t.getBounds(),n=this.viewer.world.getItemAt(0);if(!n)return 1;const r=n.getContentSize(),o=i.width*r.x;return e.x/o}getLevelOfDetail(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getMaxZoom(),i=t/e;return i<.1?0:i<.3?1:i<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const t=this.getCurrentViewport(),e=this.viewer.world.getItemAt(0);if(!e)return 1;const i=e.getContentSize(),n=(t.imageBounds.maxX-t.imageBounds.minX)*(t.imageBounds.maxY-t.imageBounds.minY),r=i.x*i.y;return n/r}getMetrics(){const t=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:t.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const t=this.getCurrentViewport();return{x:t.imageBounds.minX,y:t.imageBounds.minY,width:t.imageBounds.maxX-t.imageBounds.minX,height:t.imageBounds.maxY-t.imageBounds.minY}}setCacheEnabled(t){this.cacheEnabled=t,t||(this.cachedViewport=null)}setCacheTimeout(t){this.cacheTimeout=Math.max(0,t)}setViewportPadding(t){this.viewportPadding=Math.max(0,Math.min(1,t))}destroy(){this.viewer=null,this.cachedViewport=null}}class il{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],c=t[(r+1)%n],h=Math.atan2(a[1]-o[1],a[0]-o[0]);let l=Math.atan2(c[1]-a[1],c[0]-a[0])-h;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const f=Math.sqrt(Math.pow(c[0]-a[0],2)+Math.pow(c[1]-a[1],2)),p=Math.abs(l)/(f+1e-10);e+=p,i=Math.max(i,p)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let d=0;d<e;d++){const l=t[(d+1)%e];n+=Math.sqrt(Math.pow(t[d][0]-l[0],2)+Math.pow(t[d][1]-l[1],2))}const o=n/e*3;for(let d=0;d<e;d++)for(let l=0;l<e;l++){if(d===l)continue;Math.sqrt(Math.pow(t[d][0]-t[l][0],2)+Math.pow(t[d][1]-t[l][1],2))<o&&i[d]++}const a=Math.max(...i),c=i.reduce((d,l)=>d+l,0)/e,h=i.reduce((d,l)=>d+Math.pow(l-c,2),0)/e;return{maxDensity:a,avgDensity:c,variance:h,uniformityScore:1-Math.sqrt(h)/(c+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation()):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation()))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.viewer.container.getBoundingClientRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const r=this.calculateAdaptivePolygonExpansion(i),o=this.expandPolygon(i,r),a=[];let c=0,h=0;o.forEach(([l,f])=>{const p=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(l,f)),g=this.viewer.viewport.viewportToWindowCoordinates(p);c+=g.x,h+=g.y}),c/=o.length,h/=o.length;let d=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(d=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([l,f])=>{const p=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(l,f)),g=this.viewer.viewport.viewportToWindowCoordinates(p),v=c+(g.x-c)*d,w=h+(g.y-h)*d;a.push(`${v},${w}`)}),a.length>0)if(this.useClipPath){const l=e.width,f=e.height,p=`0,0 ${l},0 ${l},${f} 0,${f} 0,0`,g=a.slice().reverse().join(" "),v=`polygon(${p} ${g})`;this.overlayElement.style.clipPath=v,this.overlayElement.style.webkitClipPath=v}else{const l=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,p=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(l)))}`;this.overlayElement.style.mask=`url("${p}")`,this.overlayElement.style.webkitMask=`url("${p}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,c=o*this.viewer.container.clientHeight,d=Math.max(a,c)*.75;return Math.max(50,Math.min(500,d))}trackFocusReference(){if(!this.state.selectedHotspot)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.8?n=1:i<=.3?n=0:n=(i-.3)/(.8-.3);let r=1;if(this.state.selectedHotspot&&e){const o=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0],a=this.viewer.viewport.viewportToImageCoordinates(e),c={x:a.x,y:a.y};if(this.isPointInPolygon(c,o))r=1;else{const h=this.calculateDistanceToPolygon(c,o),d=this.getHotspotBounds(this.state.selectedHotspot),l=(d.width+d.height)/2,f=h/l,p=.1,g=.3;f<=p?r=1:f>=g?r=0:r=1-(f-p)/(g-p)}}return r<.1?r:Math.min(n,r)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const c=e[o][0],h=e[o][1],d=e[a][0],l=e[a][1];h>n!=l>n&&i<(d-c)*(n-h)/(l-h)+c&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const c=e.x+a*n,h=e.y+a*r;return Math.sqrt(Math.pow(t.x-c,2)+Math.pow(t.y-h,2))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t);this.calculateZunicRosinConvexity(t);const i=this.calculateDiscreteRoughness(t);let n=0;return i.maxCurvature>10&&(n=Math.max(n,.5)),(e.aspectRatio>3||e.aspectRatio<.33)&&(n=Math.max(n,.4)),1+n*.1}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const c=o-n,h=a-r;return[n+c*e,r+h*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class nl{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.85,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.25,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.zoomConfig={fadeStartZoom:2,fadeEndZoom:4,minCoverageRatio:1,enableZoomFade:!1},this.borderColors={"electric-yellow":{r:255,g:255,b:0},"vibrant-orange":{r:255,g:124,b:0},"pure-red":{r:255,g:0,b:0},"soft-cyan":{r:0,g:200,b:255},"muted-blue":{r:0,g:123,b:255},"warm-gray":{r:180,g:180,b:180}},this.borderConfig={color:"electric-yellow",opacity:.6,strokeWidth:2,blurAmount:3},this.useEllipse=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0},this.tuningParams={circleMultiplier:.22,ellipseMultiplierX:1.2,ellipseMultiplierY:1.15,gradientMultiplier:1.5,pixelRadiusMultiplier:1,adaptivePaddingMultiplier:1.3,offsetX:0,offsetY:0},window.safariTuning=this.tuningParams,this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.zoomUpdateTimeout=null,this.lastUpdateTime=0,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[c,h]=i,d=n*(a-h)-r*(o-c)+o*h-c*a;if(Math.abs(d)<1e-10)return this.minCircleTrivial([t,e]);const l=(n*n+r*r)*(h-a)+(o*o+a*a)*(r-h)+(c*c+h*h)*(a-r),f=(n*n+r*r)*(o-c)+(o*o+a*a)*(c-n)+(c*c+h*h)*(n-o),p=-l/(2*d),g=-f/(2*d),v=n-p,w=r-g,E=Math.sqrt(v*v+w*w);return{x:p,y:g,r:E}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonArea(t),r=i.width*i.height,o=n/r,a=this.calculateConvexHull(t),c=this.calculatePolygonArea(a),h=n/c;let d=1;return h<.6?d=1.4:o<.7?d=1.3:d=1.2,this.isMobile&&(d*=.8),e*d*this.tuningParams.adaptivePaddingMultiplier}calculateEllipseFromPolygon(t){var h,d;const e=((h=this.state.selectedHotspot)==null?void 0:h.id)||`${t.length}_${JSON.stringify(t.slice(0,3))}`;if(this.ellipseCache.has(e)){const l=this.ellipseCache.get(e);return this.useEllipse=l.useEllipse,l.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=i.width/i.height,r=(Math.max(i.width,i.height)-Math.min(i.width,i.height))/(i.width+i.height);let o=!1;if(n<=1.5&&r<=.3?o=!1:n>2||r>.5?o=!0:o=Math.abs(i.width-i.height)/Math.max(i.width,i.height)>.3,console.log("Shape decision:",{hotspotId:(d=this.state.selectedHotspot)==null?void 0:d.id,aspectRatio:n.toFixed(2),elongationIndex:r.toFixed(2),useEllipse:o}),!o)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const a=1.2,c={radiusX:i.width/2*a*this.tuningParams.ellipseMultiplierX,radiusY:i.height/2*a*this.tuningParams.ellipseMultiplierY,rotation:0,aspectRatio:n,centerX:i.centerX,centerY:i.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:c}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.ellipseCache.clear()},5e3),c}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],c=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const h=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);c*h<0&&e++}}return Math.min(e/(i*.5),1)}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height,o=this.calculateElongationIndex(n);return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,elongationIndex:o,vertexDensity:t.length/i}}calculateElongationIndex(t){const e=Math.max(t.width,t.height),i=Math.min(t.width,t.height);return(e-i)/(e+i)}calculateZoomAwareOpacity(t){if(!this.viewer||!this.zoomConfig.enableZoomFade)return t;const e=this.viewer.viewport.getZoom();if(e<=this.zoomConfig.fadeStartZoom)return t;if(e>=this.zoomConfig.fadeEndZoom)return 0;const i=this.zoomConfig.fadeEndZoom-this.zoomConfig.fadeStartZoom,n=(e-this.zoomConfig.fadeStartZoom)/i,r=1-Math.pow(1-n,2);return t*(1-r)}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement)),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}updateBorderConfig(t){this.borderConfig={...this.borderConfig,...t},this.state.selectedHotspot&&this.hotspotHighlight&&this.highlightHotspotShape(this.state.selectedHotspot)}applyInitialStyles(){const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"none","-webkit-mask-image":this.createGradientMask(50,50,100,1),"mask-image":this.createGradientMask(50,50,100,1),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const l=o.radiusX*n*this.tuningParams.ellipseMultiplierX,f=o.radiusY*n*this.tuningParams.ellipseMultiplierY,g=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(v=>{const w=l*v.position,E=f*v.position,I=(w+E)/2;return`rgba(0,0,0,${v.opacity}) ${I*this.tuningParams.gradientMultiplier}px`}).join(", ");return`radial-gradient(ellipse ${l*this.tuningParams.gradientMultiplier}px ${f*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%, 
        rgba(0,0,0,0) 0px,
        ${g})`}const c=i*n*this.tuningParams.circleMultiplier,d=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(l=>{const f=c+c*this.tuningParams.gradientMultiplier*.8*l.position;return`rgba(0,0,0,${l.opacity}) ${f}px`}).join(", ");return`radial-gradient(circle ${c*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%,
    rgba(0,0,0,0) 0px,
    rgba(0,0,0,0) ${c}px,
    ${d})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&(this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.zoomUpdateTimeout=setTimeout(()=>{this.updateSpotlightPosition(),this.applySpotlightStyles()},16))})}selectHotspot(t){var e,i;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(e=this.state.selectedHotspot)==null?void 0:e.id}),((i=this.state.selectedHotspot)==null?void 0:i.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.highlightHotspotShape(t),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),setTimeout(()=>{this.trackFocusReference()},800),console.log("Starting animation..."),this.startAnimation()):(console.log("Deselecting hotspot"),this.highlightHotspotShape(null),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation())}highlightHotspotShape(t){if(this.hotspotHighlight&&(this.hotspotHighlight.remove(),this.hotspotHighlight=null),!t)return;const e=this.borderConfig.color,i=this.borderColors[e]||this.borderColors["soft-cyan"],n=this.borderConfig.opacity,r=this.borderConfig.strokeWidth,o=this.borderConfig.blurAmount,a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 999;
    `;const d=`M ${(t.shape==="polygon"?t.coordinates:t.coordinates[0]).map(([g,v])=>{const w=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(g,v)),E=this.viewer.viewport.viewportToWindowCoordinates(w);return`${E.x},${E.y}`}).join(" L ")} Z`,l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d",d),l.style.cssText=`
        fill: none;
        stroke: rgba(255, 255, 255, ${n*.3});
        stroke-width: ${r*2}px;
        filter: blur(${o*3}px);
    `,a.appendChild(l);const f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("d",d),f.style.cssText=`
        fill: none;
        stroke: rgba(${i.r}, ${i.g}, ${i.b}, ${n});
        stroke-width: ${r*1.25}px;
        filter: blur(${o}px);
    `,a.appendChild(f);const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",d),p.style.cssText=`
        fill: none;
        stroke: rgba(${i.r}, ${i.g}, ${i.b}, ${Math.min(1,n*1.3)});
        stroke-width: ${r*.6}px;
        opacity: 0.9;
    `,a.appendChild(p),this.viewer.container.appendChild(a),this.hotspotHighlight=a}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getPerformanceMode();let i="full",n;if(e==="reduced"){const v=t.shape==="polygon"?t.coordinates:t.coordinates[0],w=this.simplifyPolygon(v,.5),E={...t,coordinates:t.shape==="polygon"?w:[w]};n=this.calculateSpotlightGeometry(E),i="simplified"}else n=this.calculateSpotlightGeometry(t);const r=this.viewer.container.getBoundingClientRect(),o=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(n.center.x,n.center.y)),a=this.viewer.viewport.viewportToWindowCoordinates(o);console.log("Coordinate conversion debug:",{imageCenter:n.center,viewportPoint:{x:o.x,y:o.y},windowPoint:{x:a.x,y:a.y},viewerSize:{width:this.viewer.container.clientWidth,height:this.viewer.container.clientHeight}});const c=a.x/r.width*100+this.tuningParams.offsetX,h=a.y/r.height*100+this.tuningParams.offsetY;this.state.targetPosition={x:c,y:h};const d=this.viewer.world.getItemAt(0).getContentSize(),l=n.radius/d.x,f=this.viewer.viewport.getZoom(),p=l*r.width*f,g=this.getHotspotBounds(t);if(g){const v=g.width/d.x*r.width*f,w=g.height/d.y*r.height*f,I=Math.max(v,w)/2*this.zoomConfig.minCoverageRatio;this.state.targetRadius=Math.max(I,p*this.tuningParams.pixelRadiusMultiplier)}else this.state.targetRadius=Math.max(80,Math.min(400,p*this.tuningParams.pixelRadiusMultiplier));if(console.log("Zoom-aware radius:",{currentZoom:f.toFixed(2),targetRadius:this.state.targetRadius.toFixed(0),willFade:f>this.zoomConfig.fadeStartZoom}),n.ellipseData){const v=n.ellipseData.radiusX/d.x*r.width*f,w=n.ellipseData.radiusY/d.y*r.height*f;this.useEllipse||(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:n.ellipseData.rotation}),this.ellipseData.targetRadiusX=v,this.ellipseData.targetRadiusY=w,this.ellipseData.rotation=n.ellipseData.rotation,this.useEllipse=!0}else this.useEllipse&&(this.ellipseData.targetRadiusX=this.state.targetRadius,this.ellipseData.targetRadiusY=this.state.targetRadius),this.useEllipse=!1;console.log("Spotlight position debug:",{hotspotId:t.id,hotspotCenter:n.center,windowPoint:a,viewportRect:{width:r.width,height:r.height},percentages:{x:c,y:h},radius:{geometric:n.radius,inViewport:l,inPixels:p,final:this.state.targetRadius},currentState:{x:this.state.currentPosition.x,y:this.state.currentPosition.y,radius:this.state.currentRadius},ellipseData:this.ellipseData,useEllipse:this.useEllipse,geometryQuality:i}),this.aspectRatio=n.aspectRatio,this.state.isAnimating||this.applySpotlightStyles(),this.hotspotHighlight&&this.state.selectedHotspot&&this.highlightHotspotShape(this.state.selectedHotspot)}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateEllipseFromPolygon(e);if(n&&this.useEllipse)return{center:{x:n.centerX,y:n.centerY},radius:Math.max(n.radiusX,n.radiusY),aspectRatio:n.aspectRatio,bounds:i,ellipseData:n,useEllipse:!0};{const r=this.calculateMinimumEnclosingCircle(e);r.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),r.r=Math.max(i.width,i.height)/2);const o=this.calculateAdaptivePadding(e,r.r);return{center:{x:r.x,y:r.y},radius:r.r+o,aspectRatio:i.width/i.height,bounds:i,ellipseData:null,useEllipse:!1}}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let h=0,d=o-1;h<o;d=h++){const l=e[h][0],f=e[h][1],p=e[d][0],g=e[d][1],v=l*g-p*f;i+=v,n+=(l+p)*v,r+=(f+g)*v}i*=.5;const a=n/(6*i),c=r/(6*i);if(!isFinite(a)||!isFinite(c)){let h=0,d=0;return e.forEach(([l,f])=>{h+=l,d+=f}),{x:h/e.length,y:d/e.length}}return{x:a,y:c}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<2e3)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return console.log("calculateFocusScore: Missing data, returning 1.0"),1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new ot.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y));if(this.useEllipse&&this.ellipseData){const a=this.viewer.world.getItemAt(0).getContentSize();this.viewer.container.getBoundingClientRect(),this.viewer.viewport.getZoom();const c=this.ellipseData.radiusX/a.x,h=this.ellipseData.radiusY/a.y,d=this.calculateEllipseDistance(o.x,o.y,e.x,e.y,c,h,this.ellipseData.rotation),l=.5,f=.2;d<=l?r=1:d>=l+f?r=0:r=1-(d-l)/f}else{const a=e.x-o.x,c=e.y-o.y,h=Math.sqrt(a*a+c*c),d=.01,l=.02;h<=d?r=1:h>=d+l?r=0:r=1-(h-d)/l}}return r<.1?r:i>=.8&&r>.9?1:Math.min(n,r)}calculateEllipseDistance(t,e,i,n,r,o,a){const c=a*Math.PI/180,h=Math.cos(c),d=Math.sin(c),l=i-t,f=n-e,p=l*h+f*d,g=-l*d+f*h;return Math.sqrt(p*p/(r*r)+g*g/(o*o))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.hotspotHighlight&&(this.hotspotHighlight.remove(),this.hotspotHighlight=null),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity*this.config.maxOpacity,i=this.calculateZoomAwareOpacity(e),n=i-this.state.opacity,r=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(n)>.001?(this.state.opacity+=n*r,this.state.opacity=Math.max(0,Math.min(this.config.maxOpacity,this.state.opacity))):this.state.opacity=i;const o=this.state.targetScale-this.state.scale;Math.abs(o)>.01?this.state.scale+=o*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const a=this.state.targetPosition.x-this.state.currentPosition.x,c=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(a)>.1||Math.abs(c)>.1?(this.state.currentPosition.x+=a*this.config.positionSpeed,this.state.currentPosition.y+=c*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const h=this.state.targetRadius-this.state.currentRadius;if(Math.abs(h)>1?this.state.currentRadius+=h*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const l=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,f=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(l)>1||Math.abs(f)>1?(this.ellipseData.radiusX+=l*this.config.radiusSpeed,this.ellipseData.radiusY+=f*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(n)<=.001&&Math.abs(a)<=.1&&Math.abs(c)<=.1&&Math.abs(h)<=1&&Math.abs(o)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}forceRecalculation(){this.state.selectedHotspot&&(this.ellipseCache.clear(),this.updateSpotlightPosition(),!this.state.isAnimating&&this.applySpotlightStyles())}destroy(){this.hotspotHighlight&&this.hotspotHighlight.remove(),this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const c=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=c,t.style.webkitMaskImage=c,o++,requestAnimationFrame(a)}else{const c=performance.now()-r,h=o/c*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${h.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){if(!(!this.state.selectedHotspot||!this.useEllipse)&&window.performanceMonitor){const t=window.performanceMonitor.getMetrics();t.averageFPS<45&&this.useEllipse&&(console.warn("Disabling ellipses due to low FPS:",t.averageFPS),this.useEllipse=!1,this.config.useEllipse=!1,setTimeout(()=>{this.config.useEllipse=!0},1e4))}}}class ii{static create(t){const e=this.detectBrowser();return console.log("Browser detection:",{isSafari:e.isSafari,isIOS:e.isIOS,isWebKit:e.isWebKit,userAgent:navigator.userAgent}),e.isSafari||e.isIOS?(console.log("Using SafariOverlayManager for WebKit-based browser"),new nl(t)):(console.log("Using CSSOverlayManager (default)"),new il(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r="WebkitAppearance"in document.documentElement.style&&!window.chrome,o=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:r,isIOSChrome:o,isWebKitBased:n||i||o}}static setPreference(t){return t==="css"||t==="safari"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css' or 'safari'.`),!1)}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t){const e=this.getCurrentType();return e==="safari"?(console.log("Creating SafariOverlayManager (forced)"),new nl(t)):e==="css"?(console.log("Creating CSSOverlayManager (forced)"),new il(t)):this.create(t)}}var gd=ee('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),vd=ee('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),yd=ee('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),wd=ee('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),_d=ee('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),Td=ee('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),xd=ee('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),Ed=ee("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),bd=ee('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+)">'),Sd=ee('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+)">'),Pd=ee("<input type=range class=volume-slider min=0 max=100>"),Cd=ee("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+: Skip</span><span>M: Mute</span><span>Esc: Minimize"),Ad=ee('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),Rd=ee("<div>");const rl=()=>gd(),sl=()=>vd(),Id=()=>yd(),Dd=()=>wd(),Md=()=>_d(),kd=()=>Td(),Od=()=>xd();function Fd(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=de(!0),[r,o]=de(!1),[a,c]=de(0),[h,d]=de(0),[l,f]=de(0),[p,g]=de(80),[v,w]=de(!1),[E,I]=de(!1),[L,N]=de(!0),[Z,J]=de(!1);hn(()=>{e()&&r()&&i()&&(J(!0),setTimeout(()=>J(!1),500))});const k=()=>window.innerWidth<=768;hn(()=>{t&&(t.onProgress=ae=>{E()||(c(ae.percent),d(ae.current),f(ae.duration))},t.onPlaybackStart=()=>{o(!0),i()&&L()?(n(!1),N(!1)):i()||N(!1)},t.onPlaybackEnd=()=>{o(!1),c(0),d(0)},t.setVolume(p()/100))}),hn(()=>{const ae=Ee=>{if(e()&&Ee.target.tagName!=="INPUT")switch(Ee.key){case" ":i()||(Ee.preventDefault(),A());break;case"ArrowLeft":Ee.shiftKey&&!i()&&(Ee.preventDefault(),M());break;case"ArrowRight":Ee.shiftKey&&!i()&&(Ee.preventDefault(),P());break;case"m":case"M":i()||F();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",ae),Ln(()=>window.removeEventListener("keydown",ae))}),hn(()=>{if(t){const ae=t.getState();o(ae.isPlaying),w(ae.isMuted)}});const A=()=>{!t||!e()||(r()?t.pause():t.resume())},P=()=>{t&&t.skip(15)},M=()=>{t&&t.skip(-15)},F=()=>{if(!t)return;const ae=t.toggleMute();w(ae)},O=ae=>{if(!t)return;const Ee=ae.currentTarget.getBoundingClientRect(),Pe=(ae.clientX-Ee.left)/Ee.width*100;t.seekToPercent(Pe),c(Pe)},D=ae=>{if(!E())return;const Ee=ae.currentTarget.getBoundingClientRect(),Pe=Math.max(0,Math.min(100,(ae.clientX-Ee.left)/Ee.width*100));c(Pe)},B=()=>{E()&&t&&(t.seekToPercent(a()),I(!1))},Ce=ae=>{const Ee=parseInt(ae.target.value);g(Ee),t&&(t.setVolume(Ee/100),Ee>0&&v()&&(t.toggleMute(),w(!1)))},Re=ae=>{if(!ae||isNaN(ae))return"0:00";const Ee=Math.floor(ae/60),Pe=Math.floor(ae%60);return`${Ee}:${Pe.toString().padStart(2,"0")}`},He=()=>{const ae=e();return ae?ae.narrationTitle||`Hotspot ${ae.id}`:""};return _e(Ue,{get when(){return e()},get children(){var ae=Rd();return ae.addEventListener("mouseleave",B),ae.$$mouseup=B,re(ae,_e(Ue,{get when(){return i()},get children(){var Ee=Ed(),Pe=Ee.firstChild,Et=Pe.nextSibling,Ze=Et.firstChild;return Pe.$$click=()=>{r()?A():n(!1)},re(Pe,(()=>{var ne=Pt(()=>!!r());return()=>ne()?_e(sl,{}):_e(rl,{})})()),re(Ze,He),Je(ne=>{var ct=`btn-play-mini ${r()?"playing":""} ${Z()?"changing":""}`,et=r()?"Pause":"Play";return ct!==ne.e&&Mn(Pe,ne.e=ct),et!==ne.t&&Gt(Pe,"title",ne.t=et),ne},{e:void 0,t:void 0}),Ee}}),null),re(ae,_e(Ue,{get when(){return!i()},get children(){var Ee=Ad(),Pe=Ee.firstChild,Et=Pe.firstChild,Ze=Et.nextSibling,ne=Pe.nextSibling,ct=ne.firstChild,et=ct.nextSibling,Qt=et.firstChild,_t=Qt.firstChild,ri=_t.nextSibling,hi=et.nextSibling,Xt=ne.nextSibling,bt=Xt.firstChild,It=bt.firstChild,Nt=bt.nextSibling,Ut=Nt.firstChild;return re(Et,He),Ze.$$click=()=>n(!0),re(Ze,_e(Od,{})),re(ct,()=>Re(h())),et.$$mousemove=D,et.$$mousedown=()=>I(!0),et.$$click=O,re(hi,()=>Re(l())),re(bt,_e(Ue,{get when(){return!k()},get children(){var Oe=bd();return Oe.$$click=M,re(Oe,_e(Id,{})),Oe}}),It),It.$$click=A,re(It,_e(Ue,{get when(){return!r()},get children(){return _e(rl,{})}}),null),re(It,_e(Ue,{get when(){return r()},get children(){return _e(sl,{})}}),null),re(bt,_e(Ue,{get when(){return!k()},get children(){var Oe=Sd();return Oe.$$click=P,re(Oe,_e(Dd,{})),Oe}}),null),Ut.$$click=F,re(Ut,_e(Ue,{get when(){return Pt(()=>!v())()&&p()>0},get children(){return _e(Md,{})}}),null),re(Ut,_e(Ue,{get when(){return v()||p()===0},get children(){return _e(kd,{})}}),null),re(Nt,_e(Ue,{get when(){return!k()},get children(){var Oe=Pd();return Oe.$$input=Ce,Je(()=>Gt(Oe,"title",`Volume: ${p()}%`)),Je(()=>Oe.value=p()),Oe}}),null),re(Ee,_e(Ue,{when:!1,get children(){return Cd()}}),null),Je(Oe=>{var Dt=`${a()}%`,y=`${a()}%`,C=`btn-play ${r()?"playing":""}`,V=r()?"Pause (Space)":"Play (Space)",q=v()?"Unmute (M)":"Mute (M)";return Dt!==Oe.e&&((Oe.e=Dt)!=null?_t.style.setProperty("width",Dt):_t.style.removeProperty("width")),y!==Oe.t&&((Oe.t=y)!=null?ri.style.setProperty("left",y):ri.style.removeProperty("left")),C!==Oe.a&&Mn(It,Oe.a=C),V!==Oe.o&&Gt(It,"title",Oe.o=V),q!==Oe.i&&Gt(Ut,"title",Oe.i=q),Oe},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),Ee}}),null),Je(()=>Mn(ae,`audio-player ${i()?"minimized":""} ${k()?"mobile":"desktop"}`)),ae}})}jn(["mouseup","click","mousedown","mousemove","input"]);var Ld=ee('<div><button><svg class=media-button-icon width=16 height=16 viewBox="0 0 16 16"fill=none><path d="M2 4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4Z"stroke=currentColor stroke-width=1.5></path><circle cx=8 cy=8 r=2.5 stroke=currentColor stroke-width=1.5></circle><path d="M2 11L5 8L7 10L10 7L14 11"stroke=currentColor stroke-width=1.5 stroke-linecap=round stroke-linejoin=round></path></svg><span class=media-button-text>');function Vd(s){const{hotspotId:t,onClick:e,isVisible:i=!0,position:n={x:0,y:0},isMobile:r=!1}=s,[o,a]=de(!1),[c,h]=de(!1),d=()=>"View Image",l=f=>{f.stopPropagation(),h(!0),e&&e(t),setTimeout(()=>h(!1),300)};return _e(Ue,{when:i,get children(){var f=Ld(),p=f.firstChild,g=p.firstChild,v=g.nextSibling;return Mn(f,`media-button-container ${r?"mobile":"desktop"}`),p.addEventListener("mouseleave",()=>a(!1)),p.addEventListener("mouseenter",()=>a(!0)),p.$$click=l,re(v,d),Je(w=>{var E=`media-button ${o()?"hovered":""} ${c()?"clicked":""}`,I=d();return E!==w.e&&Mn(p,w.e=E),I!==w.t&&Gt(p,"title",w.t=I),w},{e:void 0,t:void 0}),f}})}jn(["click"]);var Bd=ee("<h3 class=modal-title>"),zd=ee('<div class=modal-overlay-backdrop><div><button class=modal-close-button title="Close (Esc)"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M18 6L6 18M6 6l12 12"stroke=currentColor stroke-width=2 stroke-linecap=round></path></svg></button><div class=modal-image-container><img class=modal-image loading=lazy>',!0,!1,!1);function Hd(s){const{imageUrl:t,isVisible:e,onClose:i,hotspotTitle:n}=s,r=o=>{o.target===o.currentTarget&&i()};return _e(Ue,{when:e,get children(){var o=zd(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=h.firstChild;return o.$$click=r,Rc(c,"click",i),re(a,_e(Ue,{when:n,get children(){var l=Bd();return re(l,n),l}}),h),Gt(d,"src",t),Gt(d,"alt",n||"Hotspot image"),Je(()=>Mn(a,`modal-overlay-content ${s.isLoading?"loading":""} ${s.hasError?"error":""}`)),o}})}jn(["click"]);function Nd(s){const{imageOverlayManager:t,currentHotspot:e}=s,[i,n]=de(!1),[r,o]=de(null),[a,c]=de("modal"),[h,d]=de(!1),[l,f]=de(!1);let p=null,g=null;Ho(()=>{t&&(p=(w,E)=>{console.log("Opening overlay for:",w);const I=E.imageUrls[0];I&&(o(I),c(E.displayMode||"modal"),d(!0),f(!1),n(!0),t.getImage(I)?d(!1):t.loadImage(I,w).then(()=>d(!1)).catch(()=>{f(!0),d(!1)}))},g=()=>{n(!1),o(null),t.closeOverlay()},t.onOverlayOpen=p,t.onOverlayClose=g,Ln(()=>{t&&(t.onOverlayOpen=null,t.onOverlayClose=null)}))}),hn(()=>{if(!i())return;document.body.classList.add("modal-open");const w=E=>{E.key==="Escape"&&v()};window.addEventListener("keydown",w),Ln(()=>{window.removeEventListener("keydown",w),document.body.classList.remove("modal-open")})});const v=()=>{g&&g()};return _e(Ue,{get when(){return Pt(()=>a()==="modal")()&&i()},get children(){return _e(Hd,{get imageUrl(){return r()},isVisible:!0,onClose:v,get hotspotTitle(){var w;return((w=e==null?void 0:e())==null?void 0:w.title)||"Image"},get isLoading(){return h()},get hasError(){return l()}})}})}const ue={viewer:{imageLoaderLimit:4,maxImageCacheCount:2e3,minPixelRatio:.5,minZoomImageRatio:.5,smoothTileEdgesMinZoom:3,alwaysBlend:!0,immediateRender:!1,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:1,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:null,animationTime:.3,springStiffness:6,blendTime:.18,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.2,zoomPerClick:2,minZoomLevel:.5,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:6,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:6,tileRetryMax:1,tileRetryDelay:100,minimumPixelsPerTile:12,compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},hotspots:{batchSize:50,visibilityCheckInterval:100,renderDebounceTime:16,maxVisibleHotspots:100,minZoomForHotspots:3},viewport:{updateDebounce:8},memory:{maxCachedImages:300,criticalMemoryThreshold:200},network:{maxConcurrentRequests:6},mobile:{maxImageCacheCount:50,imageLoaderLimit:2,animationTime:.2,springStiffness:12,immediateRender:!1,blendTime:.1,maxTilesPerFrame:3,minPixelRatio:.5,minZoomImageRatio:.9,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!0,preserveImageSizeOnResize:!1,maxZoomPixelRatio:2},debug:{warnThreshold:{fps:45}}},Ud=()=>{var e;const s=navigator.userAgent.toLowerCase(),t=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(s),isChrome:/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),isFirefox:/firefox|fxios/i.test(s),isEdge:/edge|edg/i.test(s),isIOS:/ipad|iphone|ipod/.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(s),isMac:/mac/.test(t),isWindows:/win/.test(t),isMobile:/android|iphone|ipad|ipod/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((e=navigator.connection)==null?void 0:e.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},jd=()=>{const s=Ud();return(s.isSafari||s.isIOS)&&(ue.viewer.drawer="canvas",ue.viewer.maxImageCacheCount=200,console.log("Safari/iOS detected - forcing canvas drawer and limiting cache")),s.isAndroid&&(ue.viewer.drawer="canvas",console.log("Android detected - forcing canvas drawer for compatibility")),s.isMobile&&(Object.assign(ue.viewer,{drawer:"canvas",imageLoaderLimit:ue.mobile.imageLoaderLimit,maxImageCacheCount:ue.mobile.maxImageCacheCount,animationTime:ue.mobile.animationTime,springStiffness:ue.mobile.springStiffness,immediateRender:ue.mobile.immediateRender,blendTime:ue.mobile.blendTime,smoothImageZoom:!1,maxTilesPerFrame:ue.mobile.maxTilesPerFrame,visibilityRatio:ue.mobile.visibilityRatio,minPixelRatio:ue.mobile.minPixelRatio,minZoomImageRatio:ue.mobile.minZoomImageRatio,smoothTileEdgesMinZoom:ue.mobile.smoothTileEdgesMinZoom,alwaysBlend:ue.mobile.alwaysBlend,preserveImageSizeOnResize:ue.mobile.preserveImageSizeOnResize,maxZoomPixelRatio:ue.mobile.maxZoomPixelRatio,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),ue.hotspots.batchSize=25,ue.hotspots.maxVisibleHotspots=50,ue.hotspots.renderDebounceTime=32,ue.memory.maxCachedImages=50,console.log("Mobile device detected - applied aggressive performance optimizations")),s.isLowEndDevice&&(ue.viewer.animationTime=.2,ue.viewer.springStiffness=12,ue.viewer.maxImageCacheCount=Math.min(150,ue.viewer.maxImageCacheCount),ue.viewer.imageLoaderLimit=2,ue.viewer.maxTilesPerFrame=2,ue.memory.maxCachedImages=150,ue.network.maxConcurrentRequests=3,ue.hotspots.maxVisibleHotspots=50,ue.viewer.minPixelRatio=.7,console.log("Low-end device detected - reduced resource usage but maintained quality settings")),s.isHighEndDevice&&!s.isMobile&&(ue.viewer.maxImageCacheCount=800,ue.viewer.imageLoaderLimit=8,ue.viewer.maxTilesPerFrame=6,ue.memory.maxCachedImages=500,ue.network.maxConcurrentRequests=8,ue.viewer.minPixelRatio=.4,ue.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - increased resource limits and quality")),s.isHighDPI&&!s.isMobile&&(ue.viewer.minPixelRatio=Math.min(.5,ue.viewer.minPixelRatio),ue.viewer.maxZoomPixelRatio=Math.max(4,s.pixelRatio*2)),(s.connectionType==="slow-2g"||s.connectionType==="2g")&&(ue.viewer.imageLoaderLimit=1,ue.network.maxConcurrentRequests=2,ue.viewer.timeout=12e4,console.log("Slow connection detected - reduced concurrent requests")),s},so=jd();function Wd(s,t){const e=ue;if(s<20&&s>0)return e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.animationTime=.1,e.viewer.springStiffness=15,e.viewer.immediateRender=!0,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=50,e.viewer.minPixelRatio=.8,console.error("Emergency performance mode activated"),"emergency";if(s<30&&s>0)return e.viewer.imageLoaderLimit=2,e.viewer.maxTilesPerFrame=2,e.viewer.animationTime=.2,e.viewer.springStiffness=12,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=100,e.viewer.minPixelRatio=.7,console.warn("Critical performance mode activated"),"critical";if(s<45&&s>0)return e.viewer.imageLoaderLimit=Math.max(3,e.viewer.imageLoaderLimit-1),e.viewer.maxTilesPerFrame=Math.max(3,e.viewer.maxTilesPerFrame-1),"reduced";if(s>55){const i=so.isHighEndDevice?8:so.isMobile?2:6;return e.viewer.imageLoaderLimit<i&&(e.viewer.imageLoaderLimit=Math.min(i,e.viewer.imageLoaderLimit+1)),e.viewer.maxTilesPerFrame<4&&(e.viewer.maxTilesPerFrame=Math.min(4,e.viewer.maxTilesPerFrame+1)),e.viewer.minPixelRatio=so.isMobile?.8:.5,"normal"}return t>e.memory.criticalMemoryThreshold?(e.viewer.maxImageCacheCount=Math.max(50,Math.floor(e.viewer.maxImageCacheCount*.5)),console.warn(`High memory usage: ${t}MB - Reduced cache to ${e.viewer.maxImageCacheCount}`),"memory-limited"):"normal"}const qd=(s,t,e,i,n=null)=>(i&&(s.animationTime=.2,s.springStiffness=12,s.blendTime=0,s.immediateRender=!0,s.imageLoaderLimit=2,s.maxImageCacheCount=50,s.visibilityRatio=1,s.maxTilesPerFrame=2),{tileSources:n||t,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:e,imageSmoothingEnabled:s.imageSmoothingEnabled,smoothTileEdgesMinZoom:s.smoothTileEdgesMinZoom,alwaysBlend:s.alwaysBlend,placeholderFillStyle:s.placeholderFillStyle,opacity:1,preload:s.preload,compositeOperation:s.compositeOperation,...s.drawer==="webgl"?{webglOptions:s.webglOptions}:{},immediateRender:s.immediateRender,imageLoaderLimit:s.imageLoaderLimit,maxImageCacheCount:s.maxImageCacheCount,timeout:s.timeout,loadTilesWithAjax:s.loadTilesWithAjax,ajaxHeaders:s.ajaxHeaders,visibilityRatio:s.visibilityRatio,minPixelRatio:s.minPixelRatio,defaultZoomLevel:s.defaultZoomLevel,minZoomLevel:s.minZoomLevel,maxZoomPixelRatio:s.maxZoomPixelRatio,constrainDuringPan:s.constrainDuringPan,wrapHorizontal:s.wrapHorizontal,wrapVertical:s.wrapVertical,animationTime:s.animationTime,springStiffness:s.springStiffness,blendTime:s.blendTime,zoomPerScroll:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:s.flickEnabled,flickMinSpeed:s.flickMinSpeed,flickMomentum:s.flickMomentum,pinchToZoom:!0,dragToPan:!0},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:s.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:s.preserveImageSizeOnResize,maxTilesPerFrame:s.maxTilesPerFrame,smoothImageZoom:s.smoothImageZoom,subPixelRendering:!1,minimumPixelsPerTile:s.minimumPixelsPerTile||12}),Gd=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream;if(/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||t||e)return console.log("Mobile/Safari detected - forcing canvas drawer for performance"),"canvas";const n=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),r=/firefox|fxios/i.test(s);return n||r?(console.log("Desktop Chrome/Firefox detected - using webgl drawer"),"webgl"):(console.log("Default browser detected - using canvas drawer"),"canvas")},De=()=>{const s=navigator.userAgent.toLowerCase();if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(s))return!0;const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<=768;return e&&i},Zd=(s,t,e)=>{let i;if(s.coordinates){let E=1/0,I=1/0,L=-1/0,N=-1/0;(J=>{Array.isArray(J[0])&&typeof J[0][0]=="number"?J.forEach(([k,A])=>{E=Math.min(E,k),I=Math.min(I,A),L=Math.max(L,k),N=Math.max(N,A)}):J.forEach(k=>{k.forEach(([A,P])=>{E=Math.min(E,A),I=Math.min(I,P),L=Math.max(L,A),N=Math.max(N,P)})})})(s.coordinates),i={minX:E,minY:I,maxX:L,maxY:N}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new ot.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new ot.Point(i.maxX,i.maxY)),a=o.x-r.x,c=o.y-r.y,h=r.x+a/2,d=r.y+c/2,l=t.viewport.getAspectRatio(),f=a/c,p=e?.85:.8;let g,v;f>l?(g=a/p,v=g/l):(v=c/p,g=v*l);const w=new ot.Rect(h-g/2,d-v/2,g,v);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:h,y:d},dimensions:{width:g,height:v},aspectRatios:{hotspot:f.toFixed(2),viewport:l.toFixed(2)},paddingFactor:p,zoomBounds:w}),w};var Xd=ee('<img class=preview-image alt="Loading preview">'),Yd=ee("<div class=viewer-loading><p>Loading high-resolution artwork..."),Kd=ee('<div style=margin-bottom:12px;><button style="width:100%;padding:10px;font-size:11px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.7);font-weight:500;transition:all 0.2s;">Fine-Tuning'),Qd=ee('<div><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Border Style</div><div style=font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:10px;></div><button style="width:100%;padding:8px;font-size:11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Next Style'),Jd=ee('<div class=debug-info><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Performance</div><div style=color:rgba(255,255,255,0.9);font-size:11px;line-height:1.7;><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Hovered</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Selected</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Type</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Total hotspots</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Renderer</span><span style=color:rgba(255,255,255,0.9);></span></div></div></div><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Zoom Control</div><div class=zoom-speed-control><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Speed: <!>x</label><input type=range min=0.5 max=2.5 step=0.1 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;><div style=font-size:10px;color:rgba(255,255,255,0.4);margin-top:6px;>Duration: <!>s</div></div></div><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Overlay System</div><div style=font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:10px;></div><button style="width:100%;padding:8px;font-size:11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Switch Mode'),$d=ee('<div><div><div style=font-size:12px;color:#FFFFFF;font-weight:600;letter-spacing:0.5px;text-align:center;>SPOTLIGHT FINE-TUNING</div><button></button></div><div class=floating-panel-scrollable><div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Circle Size: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Ellipse X: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Ellipse Y: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Gradient Spread: </label><input type=range max=5.0 step=0.1 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Offset X: <!>%</label><input type=range min=-10 max=10 step=0.5 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Offset Y: <!>%</label><input type=range min=-10 max=10 step=0.5 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><button style="margin-top:16px;padding:10px;font-size:11px;width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Copy Current Values'),ef=ee("<div class=expand-button-container><button class=expand-button><span class=expand-icon></span><span>Full View"),tf=ee("<div class=fullscreen-button-container><button class=fullscreen-button>"),nf=ee("<div class=viewer-container><div class=openseadragon-viewer>"),rf=ee('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3">'),sf=ee('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">');let Sn=[];function of(s){var Si,Pi,di,Kn,nn,Qn;let t,e=null,i={};const[n,r]=de(!0),[o,a]=de(null),[c,h]=de(null),[d,l]=de(!1),[f,p]=de(!1),[g,v]=de(!1),[w,E]=de(!1),[I,L]=de(!1),[N,Z]=de(!1),[J,k]=de(null),[A,P]=de(!1),[M,F]=de({x:0,y:0}),[O,D]=de(null),[B,Ce]=de({}),[Re,He]=de(parseInt(localStorage.getItem("debugLevel")??(De()?"0":"1"))),[ae,Ee]=de(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[Pe,Et]=de(0),Ze=[{name:"Electric Yellow",color:"electric-yellow",opacity:.6,strokeWidth:2,blurAmount:3},{name:"Vibrant Orange",color:"vibrant-orange",opacity:.5,strokeWidth:2.5,blurAmount:2},{name:"Pure Red",color:"pure-red",opacity:.4,strokeWidth:2,blurAmount:2},{name:"Soft Cyan",color:"soft-cyan",opacity:.35,strokeWidth:2,blurAmount:2},{name:"Muted Blue",color:"muted-blue",opacity:.4,strokeWidth:1.5,blurAmount:2},{name:"Warm Gray",color:"warm-gray",opacity:.5,strokeWidth:1.5,blurAmount:1}],[ne,ct]=de(((Si=window.safariTuning)==null?void 0:Si.circleMultiplier)||(De()?.8:1.2)),[et,Qt]=de(((Pi=window.safariTuning)==null?void 0:Pi.ellipseMultiplierX)||(De()?.8:1.15)),[_t,ri]=de(((di=window.safariTuning)==null?void 0:di.ellipseMultiplierY)||(De()?.8:1.15)),[hi,Xt]=de(((Kn=window.safariTuning)==null?void 0:Kn.gradientMultiplier)||(De()?1:1.5)),[bt,It]=de(((nn=window.safariTuning)==null?void 0:nn.offsetX)||0),[Nt,Ut]=de(((Qn=window.safariTuning)==null?void 0:Qn.offsetY)||0),[Oe,Dt]=de(!1),[y,C]=de({x:0,y:0}),[V,q]=de(!1),[$,ce]=de({x:0,y:0}),[G,ye]=de(0),[Fe,be]=de(null),he=()=>{i.handleKeyPress&&window.removeEventListener("keydown",i.handleKeyPress),Object.values(i).forEach(Y=>{typeof Y=="number"&&clearInterval(Y)}),B().resizeObserver&&t&&B().resizeObserver.disconnect(),Object.values(B()).forEach(Y=>{Y&&typeof Y.destroy=="function"&&Y.destroy()}),e&&e.destroy(),["performanceMonitor","viewer","tileOptimizer"].forEach(Y=>{(window[Y]===B()[Y]||window[Y]===e)&&delete window[Y]})};Ho(async()=>{var rt,Tt,ut,dt,it;try{Sn=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${Sn.length} hotspots`)}catch(Me){console.error("Failed to load hotspots:",Me),Sn=[]}const Y=new Image;Y.onload=()=>p(!0),Y.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`;const fe=ue.viewer;`${s.artworkId}${s.artworkId}`;const te={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${s.artworkId}_1024/${s.artworkId}_files/`,Format:"jpg",Overlap:"2",TileSize:"1024",Size:{Width:"11244",Height:"6543"}},minLevel:8,maxLevel:14},X=De(),se=Gd(),ve=qd(fe,te,se,X,te);e=ot({element:t,...ve,updatePixelDensityRatio:!1});const Q={spatialIndex:new hd,viewportManager:new md(e),audioEngine:new Qu,performanceMonitor:new td(e),renderOptimizer:new id(e),tileOptimizer:new fd(e),memoryManager:new $u(e),tileCleanupManager:new ud(e),imageOverlayManager:new Ju,overlayManager:ii.createWithOverride(e)};console.log("Creating overlay manager..."),console.log("Overlay manager type:",(rt=Q.overlayManager)==null?void 0:rt.constructor.name),console.log("Overlay manager instance:",Q.overlayManager),Q.tileOptimizer.state.isActive=!1,setTimeout(()=>{Q.tileOptimizer.state.isActive=!0},1e3),Ce(Q),console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!Q.overlayManager),console.log("Does it have initialize method?",typeof((Tt=Q.overlayManager)==null?void 0:Tt.initialize)),Q.overlayManager.initialize(),console.log("Overlay manager initialized"),console.log("Is initialized flag:",(ut=Q.overlayManager)==null?void 0:ut.isInitialized),console.log("Overlay element created?",!!((dt=Q.overlayManager)!=null&&dt.overlayElement)),window.overlayManager=Q.overlayManager,console.log("Overlay manager set on window:",(it=window.overlayManager)==null?void 0:it.constructor.name),window.audioEngine=Q.audioEngine,Q.audioEngine.onPlaybackEnd=Me=>{console.log(`Finished playing audio for hotspot ${Me}`)},Q.spatialIndex.loadHotspots(Sn),Q.imageOverlayManager.loadHotspots(Sn),window.viewer=e,window.performanceMonitor=Q.performanceMonitor,window.tileOptimizer=Q.tileOptimizer,window.tileCleanupManager=Q.tileCleanupManager,Q.performanceMonitor.start(),Q.memoryManager.start(),Q.tileOptimizer.start(),Q.tileCleanupManager.start(),Re()>=1?Q.performanceMonitor.enableDebugOverlay():Q.performanceMonitor.disableDebugOverlay(),U(),R(),K(),pe(),document.addEventListener("fullscreenchange",()=>{E(!!document.fullscreenElement)}),document.addEventListener("fullscreenchange",()=>{E(!!document.fullscreenElement)});const Ie=Me=>{if(V()){const jt=Me.touches?Me.touches[0].clientX:Me.clientX,$t=Me.touches?Me.touches[0].clientY:Me.clientY;C({x:jt-$().x,y:$t-$().y})}},We=Me=>{V()&&(Me.preventDefault(),Ie(Me))},qe=()=>{q(!1)};window.addEventListener("mousemove",Ie),window.addEventListener("mouseup",qe),window.addEventListener("touchmove",We,{passive:!1}),window.addEventListener("touchend",qe),Ln(()=>{window.removeEventListener("mousemove",Ie),window.removeEventListener("mouseup",qe),window.removeEventListener("touchmove",We),window.removeEventListener("touchend",qe)}),Ln(he)});const Xe=()=>{let Y=null,fe=null,te="idle",X=0,se=null;e.addHandler("zoom",ve=>{const Q=e.viewport.getZoom();if(X++,se&&clearTimeout(se),!fe||Math.abs(Q-fe)>.01){const Ie=fe?Q-fe:0,We=Math.abs(Ie);te==="idle"?(te="accelerating",Y=performance.now(),e.viewport.centerSpringX.animationTime=.4,e.viewport.centerSpringY.animationTime=.4,e.viewport.zoomSpring.animationTime=.4,e.imageLoader&&X>3&&(e.imageLoader.jobLimit=Math.max(1,e.imageLoader.jobLimit-1))):te==="accelerating"&&X>5&&(te="cruising",e.viewport.zoomSpring.animationTime=.2,e.imageLoader&&(e.imageLoader.jobLimit=1,We>.1&&e.imageLoader.clear())),fe=Q}se=setTimeout(()=>{te!=="idle"&&(te="decelerating",e.viewport.centerSpringX.animationTime=.3,e.viewport.centerSpringY.animationTime=.3,e.viewport.zoomSpring.animationTime=.3,e.imageLoader&&(e.imageLoader.jobLimit=3),setTimeout(()=>{te="idle",X=0,e.imageLoader&&(e.imageLoader.jobLimit=ue.viewer.imageLoaderLimit),e.forceRedraw(),Y&&(performance.now()-Y,Y=null)},200))},100)})},x=()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(Y=>clearTimeout(Y)),window.expandToFullViewTimeouts=[])},T=()=>{let Y=1,fe=null;e.addHandler("zoom",te=>{const X=e.viewport.getZoom();te.speed,fe&&clearTimeout(fe);let se=1;X<2?se=.6:X<3.5?se=.8:se=1;const ve=se-Y;if(Y+=ve*.3,e.drawer){e.drawer.imageSmoothingEnabled=Y>.7;const Q=Math.floor((1-Y)*3);e.skipTileRatio=Q}fe=setTimeout(()=>{const Q=setInterval(()=>{Y+=.1,Y>=1&&(Y=1,e.drawer.imageSmoothingEnabled=!0,e.skipTileRatio=0,e.forceRedraw(),clearInterval(Q))},50)},200)})},S=Y=>{"requestIdleCallback"in window?requestIdleCallback(Y,{timeout:200}):setTimeout(Y,50)},R=()=>{const Y={centerX:e.viewport.centerSpringX.springStiffness,centerY:e.viewport.centerSpringY.springStiffness,zoom:e.viewport.zoomSpring.springStiffness};e.addHandler("zoom-click",fe=>{if(fe.quick)return;const te=e.viewport.getZoom(),X=fe.zoom,se=Math.abs(Math.log2(X)-Math.log2(te)),ve=Math.min(.8,.3+se*.15);e.viewport.zoomSpring.animationTime=ve;const Q=Math.max(4,8-se);e.viewport.zoomSpring.springStiffness=Q,setTimeout(()=>{e.viewport.zoomSpring.animationTime=ue.viewer.animationTime,e.viewport.zoomSpring.springStiffness=Y.zoom},ve*1e3+100)})},U=()=>{if(e.drawer&&e.drawer.getType&&e.drawer.getType()!=="webgl"){let te=0;e.addHandler("tile-drawing",X=>{const se=e.viewport.getZoom();X.tile;const ve=X.tile.size,Q=X.tile.level,Ie=e.skipTileRatio||0;if(Ie>0&&(te++,te%(Ie+1)!==0)){X.preventDefaultAction=!0;return}if(se<2&&ve*se<24){X.preventDefaultAction=!0;return}const We=Math.floor(Math.log2(se));Math.abs(Q-We)>2&&e.skipTileRatio>0&&(X.preventDefaultAction=!0)})}e.addHandler("open",()=>{if(De()){let se=0;const ve=33;e.addHandler("update-viewport",Q=>{const Ie=performance.now();if(e.isAnimating()&&Ie-se<ve){Q.preventDefaultAction=!0;return}se=Ie})}e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,De()&&(e.viewport.minZoomLevel=.5,e.viewport.minZoomImageRatio=.3),T(),Xe(),pd(ot),e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,console.log("Viewer ready - initializing systems"),console.log("Using drawer:",e.drawer.getType?e.drawer.getType():"canvas"),l(!0),r(!1);const X=e.world.getItemAt(0).getBounds();e.viewport.fitBounds(X,!0),e.viewport.applyConstraints(!0),De()&&setTimeout(()=>{const se=e.world.getItemAt(0);if(se){const ve=se.getBounds();e.viewport.fitBoundsWithConstraints(ve,!1)}},100),e.viewport.getHomeBounds(),setTimeout(()=>ze(),100)}),e.addHandler("zoom",()=>{B().tileCleanupManager&&B().tileCleanupManager.setPressure("normal"),I()&&e.imageLoader&&e.imageLoader.clear()}),e.addHandler("pan",()=>{B().tileCleanupManager&&B().tileCleanupManager.setPressure("normal")}),e.addHandler("tile-loaded",te=>{var X;if(te.tile&&B().tileOptimizer){const se=te.tile.loadTime||((X=te.tiledImage)==null?void 0:X.lastResetTime)||100;B().tileOptimizer.trackLoadTime(se);const ve=`${te.tile.level||0}_${te.tile.x||0}_${te.tile.y||0}`;B().tileOptimizer.loadingTiles.delete(ve)}}),e.addHandler("animation",()=>{if(B().performanceMonitor){const te=B().performanceMonitor.getMetrics();if(te.averageFPS<ue.debug.warnThreshold.fps){const X=Wd(te.averageFPS,te.memoryUsage);if(B().tileCleanupManager){const se={emergency:"critical",critical:"critical",reduced:"high","memory-limited":"high",normal:"normal"};B().tileCleanupManager.setPressure(se[X]||"normal")}}}}),e.addHandler("animation-finish",()=>{console.log("animation-finish fired",{isZoomingToHotspot:I(),isExpandingToFullView:N()}),I()&&(console.log("animation-finish: Setting isZoomingToHotspot to false"),L(!1),B().renderer&&(console.log("animation-finish: Calling resumeUpdates"),B().renderer.resumeUpdates(),B().renderer.updateVisibility()),B().renderOptimizer&&B().renderOptimizer.endCinematicZoom())}),e.addHandler("animation-start",te=>{I()&&B().tileCleanupManager&&B().tileCleanupManager.pauseCleanup(3e3)});const Y=()=>{i.updateTimer&&clearTimeout(i.updateTimer),i.updateTimer=setTimeout(()=>{S(()=>{const{viewportManager:te,spatialIndex:X,audioEngine:se}=B();if(!te||!X||!se)return;const ve=te.getCurrentViewport(),Q=X.queryViewport(ve.bounds,ve.zoom);se.preloadHotspots(Q)})},ue.viewport.updateDebounce)};e.addHandler("viewport-change",Y);let fe=!1;e.addHandler("animation-start",()=>{De()&&(I()||N())&&(fe=!0,e.removeHandler("viewport-change",Y))}),e.addHandler("animation-finish",()=>{fe&&(fe=!1,e.addHandler("viewport-change",Y),setTimeout(Y,100))}),e.addHandler("canvas-click",te=>{!te.preventDefaultAction&&B().renderer&&te.quick&&B().renderer.selectedHotspot&&(B().renderer.selectedHotspot=null,h(null),B().overlayManager&&B().overlayManager.selectHotspot(null))}),De()&&e.addHandler("canvas-click",te=>{const X=e.container.clientWidth,se=e.container.clientHeight,ve=100,Q=te.position.x<ve&&te.position.y<ve,Ie=te.position.x>X-ve&&te.position.y<ve,We=te.position.x<ve&&te.position.y>se-ve,qe=te.position.x>X-ve&&te.position.y>se-ve;if(Q||Ie||We||qe){const rt=G()+1;if(ye(rt),Fe()&&clearTimeout(Fe()),rt>=3){const ut=Re()===0?1:0;if(He(ut),localStorage.setItem("debugLevel",ut.toString()),B().performanceMonitor)if(ut===1)B().performanceMonitor.enableDebugOverlay(),B().performanceMonitor.start();else{B().performanceMonitor.disableDebugOverlay();const dt=document.querySelector(".performance-overlay");dt&&(dt.style.display="none")}console.log(`Debug mode: ${ut===1?"ON":"OFF"}`),ye(0)}else be(setTimeout(()=>{ye(0)},1e3))}})},K=()=>{const Y={"+":()=>e.viewport.zoomBy(ue.viewer.zoomPerScroll),"=":()=>e.viewport.zoomBy(ue.viewer.zoomPerScroll),"-":()=>e.viewport.zoomBy(1/ue.viewer.zoomPerScroll),_:()=>e.viewport.zoomBy(1/ue.viewer.zoomPerScroll),0:()=>Jt(),f:()=>e.viewport.fitBounds(e.world.getHomeBounds()),F:()=>e.viewport.fitBounds(e.world.getHomeBounds()),c:()=>{if(De())return;const te=Re()===0?1:0;He(te),localStorage.setItem("debugLevel",te.toString()),B().performanceMonitor&&(te===1?B().performanceMonitor.enableDebugOverlay():B().performanceMonitor.disableDebugOverlay()),B().renderer&&B().renderer.setDebugMode(te===1),console.log(`Debug mode: ${te===1?"ON":"OFF"}`)}};i.handleKeyPress=fe=>{const te=document.activeElement;if(te&&(te.tagName==="INPUT"||te.tagName==="TEXTAREA"||te.contentEditable==="true"))return;const X=Y[fe.key];X&&e&&(fe.preventDefault(),X(),e.viewport.applyConstraints())},window.addEventListener("keydown",i.handleKeyPress)},pe=()=>{const Y=new ResizeObserver(fe=>{if(!(!(e!=null&&e.viewport)||!e.isOpen()))for(let te of fe){const{width:X,height:se}=te.contentRect;X>0&&se>0&&requestAnimationFrame(()=>{try{e&&e.viewport&&e.isOpen()&&(e.viewport.resize(),e.viewport.applyConstraints(),e.forceRedraw())}catch(ve){ve.message&&!ve.message.includes("undefined")&&console.warn("Resize error:",ve)}})}});Y.observe(t),Ce(fe=>({...fe,resizeObserver:Y}))},ze=()=>{if(!e)return;const Y=new ed({viewer:e,spatialIndex:B().spatialIndex,onHotspotHover:a,onHotspotClick:ht,visibilityCheckInterval:ue.hotspots.visibilityCheckInterval,batchSize:ue.hotspots.batchSize,renderDebounceTime:ue.hotspots.renderDebounceTime,maxVisibleHotspots:ue.hotspots.maxVisibleHotspots,minZoomForHotspots:ue.hotspots.minZoomForHotspots,debugMode:Re()===2});Ce(fe=>({...fe,renderer:Y})),console.log("Using NativeHotspotRenderer for all platforms")},ge=async Y=>{if(console.log("zoomToHotspot called",{hotspotId:Y.id,isZoomingToHotspot:I(),viewer:!!e}),!e||I()||N()){console.log("zoomToHotspot BLOCKED",{noViewer:!e,isZoomingToHotspot:I(),isExpandingToFullView:N()});return}const fe=Zd(Y,e,De());if(!fe)return;const te=De()?2.8:1.8,X=De()?1.5:te*ae(),se=4/ae();let ve;L(!0),console.log("Starting cinematic zoom to hotspot:",Y.id),ve=setTimeout(()=>{console.log("Safety timeout: forcing isZoomingToHotspot to false"),L(!1),B().renderer&&B().renderer.resumeUpdates()},X*1e3+500);const Q={animationTime:e.animationTime,springStiffness:e.springStiffness};if(B().tileCleanupManager&&B().tileCleanupManager.pauseCleanup(X*1e3+500),e.imageLoader&&e.imageLoader.clear(),B().renderOptimizer&&B().renderOptimizer.startCinematicZoom(),B().performanceMonitor&&De()&&B().performanceMonitor.pauseMonitoring(),B().renderer&&(De()||B().renderer.pauseUpdates(),De()&&B().renderer.hideOverlay()),De()){console.log("DEBUG: Mobile animation with preload");try{let it;if(e.viewport.getZoomForBounds)it=e.viewport.getZoomForBounds(fe);else{const Mt=e.viewport.getBounds(),kt=Mt.width/fe.width,si=Mt.height/fe.height;it=Math.min(kt,si)*e.viewport.getZoom()}const Me=fe.getCenter();console.log("DEBUG: Mobile animation params",{currentZoom:e.viewport.getZoom(),targetZoom:it,center:Me});const jt=e.viewport.getZoom(),$t=5;if(it/jt>$t){console.log("DEBUG: Large zoom jump detected, using stepped approach");const Mt=jt*$t;e.viewport.zoomTo(Mt,Me,!0),e.forceRedraw(),setTimeout(()=>{e.viewport.panTo(Me),e.viewport.zoomTo(it);let kt=0;const si=setInterval(()=>{e.forceRedraw(),kt++,kt>10&&clearInterval(si)},100)},200)}else{e.viewport.centerSpringX.animationTime=X,e.viewport.centerSpringY.animationTime=X,e.viewport.zoomSpring.animationTime=X;const Mt=new ot.Point(Me.x,Me.y);e.viewport.panTo(Mt),e.viewport.zoomTo(it);const kt=setInterval(()=>{e.forceRedraw()},100);setTimeout(()=>{clearInterval(kt)},X*1e3+200)}}catch(it){console.error("Mobile animation error:",it),e.viewport.fitBounds(fe,!1)}setTimeout(()=>{v(!0),console.log("Full View button should now be visible on mobile")},X*1e3+200);return}setTimeout(()=>{v(!0),console.log("Full View button should now be visible")},X*1e3+200),e.animationTime=X,e.springStiffness=se,e.viewport.centerSpringX.animationTime=X,e.viewport.centerSpringY.animationTime=X,e.viewport.zoomSpring.animationTime=X,e.viewport.centerSpringX.springStiffness=se,e.viewport.centerSpringY.springStiffness=se,e.viewport.zoomSpring.springStiffness=se,e.viewport.applyConstraints(),console.log("Springs configured with animTime:",X),B().viewportManager&&B().viewportManager.setCacheEnabled(!1);const Ie=e.viewport.getBounds();console.log("DEBUG: Manual zoom attempt",{from:Ie,to:fe});const We=e.viewport.getBounds(),qe=We.width/fe.width,rt=We.height/fe.height,Tt=Math.min(qe,rt)*e.viewport.getZoom(),ut=fe.getCenter();console.log("Manual zoom calculation:",{currentZoom:e.viewport.getZoom(),targetZoom:Tt,animTime:X,center:ut}),e.viewport.panTo(ut,!1),e.viewport.zoomTo(Tt,null,!1),console.log("DEBUG: Zoom animation started",{currentZoom:e.viewport.getZoom(),targetBounds:fe,springValues:{centerX:e.viewport.centerSpringX.target.value,centerY:e.viewport.centerSpringY.target.value,zoom:e.viewport.zoomSpring.target.value},animationTime:e.animationTime,isAnimating:e.isAnimating()});const dt=setInterval(()=>{console.log("DEBUG: Animation progress",{isAnimating:e.isAnimating(),currentZoom:e.viewport.getZoom(),zoomSpringCurrent:e.viewport.zoomSpring.current.value,zoomSpringTarget:e.viewport.zoomSpring.target.value})},100);setTimeout(()=>clearInterval(dt),2e3),setTimeout(()=>{B().viewportManager&&B().viewportManager.setCacheEnabled(!0)},X*1e3),setTimeout(()=>{clearTimeout(ve),console.log("Setting isZoomingToHotspot to false"),L(!1),e.animationTime=Q.animationTime,e.springStiffness=Q.springStiffness,e.viewport.centerSpringX.animationTime=Q.animationTime,e.viewport.centerSpringY.animationTime=Q.animationTime,e.viewport.zoomSpring.animationTime=Q.animationTime,e.viewport.centerSpringX.springStiffness=Q.springStiffness,e.viewport.centerSpringY.springStiffness=Q.springStiffness,e.viewport.zoomSpring.springStiffness=Q.springStiffness,B().renderOptimizer&&B().renderOptimizer.endCinematicZoom(),B().performanceMonitor&&De()&&B().performanceMonitor.resumeMonitoring()},X*1e3+1e3),setTimeout(()=>{B().renderer&&(console.log("Animation complete - restoring hotspots"),De()?(B().renderer.showOverlay(),setTimeout(()=>{"requestIdleCallback"in window?requestIdleCallback(()=>{B().renderer.resumeUpdates(),B().renderer.updateVisibilityLazy()},{timeout:1e3}):setTimeout(()=>{B().renderer.resumeUpdates(),B().renderer.updateVisibilityLazy()},300)},200)):(B().renderer.resumeUpdates(),setTimeout(()=>{B().renderer.updateVisibility(),e.forceRedraw()},100)))},X*1e3+300)},ht=async Y=>{var te,X,se,ve,Q,Ie,We,qe;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:Y?Y.id:"null (deselecting)",isZoomingToHotspot:I(),isExpandingToFullView:N(),timestamp:Date.now()}),console.log("Components available?",!!B()),console.log("OverlayManager available?",!!((te=B())!=null&&te.overlayManager)),console.log("OverlayManager type:",(se=(X=B())==null?void 0:X.overlayManager)==null?void 0:se.constructor.name),console.log("OverlayManager initialized?",(Q=(ve=B())==null?void 0:ve.overlayManager)==null?void 0:Q.isInitialized),!Y){h(null),P(!1),k(null),D(null),B().overlayManager?(console.log("Calling overlayManager.clearSelection()"),B().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(N()&&(console.log("Interrupting Full View animation for hotspot click"),e.viewport.stopAnimation(),x(),Z(!1),B().renderOptimizer&&B().renderOptimizer.endCinematicZoom(),B().renderer&&(B().renderer.resumeUpdates(),De()&&B().renderer.showOverlay()),await new Promise(rt=>setTimeout(rt,50))),I()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),L(!1)),P(!1),h(Y),k(Y),(Ie=B())!=null&&Ie.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(Y==null?void 0:Y.id)||"null"),console.log("Hotspot data being passed:",Y),console.log("OverlayManager method exists?",typeof B().overlayManager.selectHotspot);try{B().overlayManager.selectHotspot(Y),console.log("selectHotspot call completed")}catch(rt){console.error("Error calling selectHotspot:",rt)}console.log("Hotspot data being passed:",{id:Y.id,shape:Y.shape,hasCoordinates:!!Y.coordinates,coordinatesLength:(We=Y.coordinates)==null?void 0:We.length}),B().overlayManager.selectHotspot(Y)}else console.error("No overlay manager available in components!"),console.error("Components object:",B());(Y.image_url_1||((qe=B().imageOverlayManager)==null?void 0:qe.getOverlay(Y.id)))&&(B().imageOverlayManager.shouldAutoReveal(Y.id)?tt(Y.id):B().imageOverlayManager.shouldShowButton(Y.id)&&(D(Y),P(!0))),console.log("Zooming to hotspot:",Y.id),await ge(Y)};window.artworkViewerHandleHotspotClick=ht;const tt=Y=>{console.log("Media button clicked for:",Y),P(!1),B().imageOverlayManager&&B().imageOverlayManager.openOverlay(Y)},Jt=()=>{if(console.log("expandToFullView START",{isExpandingToFullView:N(),isZoomingToHotspot:I()}),window.expandToFullViewTimeouts||(window.expandToFullViewTimeouts=[]),!e||N())return;I()&&(console.log("Force resetting isZoomingToHotspot in expandToFullView"),L(!1),B().renderOptimizer&&B().renderOptimizer.endCinematicZoom(),B().renderer&&B().renderer.resumeUpdates()),v(!1),Z(!0);const Y=e.world.getItemAt(0);if(!Y){Z(!1);return}const fe=Y.getBounds(),X=e.viewport.getBounds().getCenter(),se=fe.getCenter(),ve=Math.sqrt(Math.pow(se.x-X.x,2)+Math.pow(se.y-X.y,2)),Q=Math.min(1.5,Math.max(1.2,ve*.4+1)),Ie=Math.max(6,10-ve*1.5),We=setTimeout(()=>{console.log("Safety timeout: forcing isExpandingToFullView to false (was:",N(),")"),Z(!1)},Q*1e3+500);window.expandToFullViewTimeouts.push(We);const qe={animationTime:e.animationTime,springStiffness:e.springStiffness};if(console.log("expandToFullView animation params:",{distance:ve,animTime:Q,stiffness:Ie,currentAnimationTime:e.animationTime,currentStiffness:e.springStiffness}),B().tileCleanupManager&&B().tileCleanupManager.pauseCleanup(Q*1e3+500),e.imageLoader&&e.imageLoader.clear(),B().renderOptimizer&&B().renderOptimizer.startCinematicZoom(),B().renderer&&(B().renderer.pauseUpdates(),De()&&B().renderer.hideOverlay()),e.animationTime=Q,e.springStiffness=Ie,e.viewport.centerSpringX.animationTime=Q,e.viewport.centerSpringY.animationTime=Q,e.viewport.zoomSpring.animationTime=Q,e.viewport.centerSpringX.springStiffness=Ie,e.viewport.centerSpringY.springStiffness=Ie,e.viewport.zoomSpring.springStiffness=Ie*.85,e.viewport.centerSpringX.resetTo(e.viewport.centerSpringX.current.value),e.viewport.centerSpringY.resetTo(e.viewport.centerSpringY.current.value),e.viewport.zoomSpring.resetTo(e.viewport.zoomSpring.current.value),console.log("expandToFullView executing fitBounds"),console.log("Springs after reset:",{centerXTime:e.viewport.centerSpringX.animationTime,zoomTime:e.viewport.zoomSpring.animationTime}),De())e.viewport.fitBounds(fe,!1);else{const dt=fe.x+fe.width/2,it=fe.y+fe.height/2,Me=new ot.Rect(dt-fe.width*1.01/2,it-fe.height*1.01/2,fe.width*1.01,fe.height*1.01);e.viewport.fitBounds(Me,!1)}console.log("expandToFullView animation started",{actualAnimTime:e.animationTime,actualStiffness:e.springStiffness,timestamp:Date.now()});const rt=setTimeout(()=>{clearTimeout(We),Z(!1),e.animationTime=qe.animationTime,e.springStiffness=qe.springStiffness,e.viewport.centerSpringX.animationTime=qe.animationTime,e.viewport.centerSpringY.animationTime=qe.animationTime,e.viewport.zoomSpring.animationTime=qe.animationTime,e.viewport.centerSpringX.springStiffness=qe.springStiffness,e.viewport.centerSpringY.springStiffness=qe.springStiffness,e.viewport.zoomSpring.springStiffness=qe.springStiffness,B().renderOptimizer&&B().renderOptimizer.endCinematicZoom()},Q*1e3+200);window.expandToFullViewTimeouts.push(rt);const Tt=setTimeout(()=>{B().renderer&&(De()&&B().renderer.showOverlay(),setTimeout(()=>{B().renderer.resumeUpdates(),B().renderer.updateVisibility(),e.forceRedraw()},200))},Q*1e3+100);window.expandToFullViewTimeouts.push(Tt)},ui=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(Y=>{console.log(`Error attempting to enable fullscreen: ${Y.message}`)})};return[(()=>{var Y=nf(),fe=Y.firstChild;re(Y,_e(Ue,{get when(){return Pt(()=>!!f())()&&!d()},get children(){var X=Xd();return Je(()=>Gt(X,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),X}}),fe);var te=t;return typeof te=="function"?Zu(te,fe):t=fe,re(Y,_e(Ue,{get when(){return n()},get children(){return Yd()}}),null),re(Y,_e(Ue,{get when(){return Pt(()=>!!d())()&&Re()===1},get children(){var X=Jd(),se=X.firstChild,ve=se.firstChild,Q=ve.nextSibling,Ie=Q.firstChild,We=Ie.firstChild,qe=We.nextSibling,rt=Ie.nextSibling,Tt=rt.firstChild,ut=Tt.nextSibling,dt=rt.nextSibling,it=dt.firstChild,Me=it.nextSibling,jt=dt.nextSibling,$t=jt.firstChild,Mt=$t.nextSibling,kt=jt.nextSibling,si=kt.firstChild,Li=si.nextSibling,wn=se.nextSibling,Ci=wn.firstChild,rn=Ci.nextSibling,fi=rn.firstChild,oi=fi.firstChild,ei=oi.nextSibling;ei.nextSibling;var pi=fi.nextSibling,sn=pi.nextSibling,Vi=sn.firstChild,we=Vi.nextSibling;we.nextSibling;var Ge=wn.nextSibling,Ai=Ge.firstChild,mi=Ai.nextSibling,gi=mi.nextSibling;return re(qe,()=>{var ke;return((ke=o())==null?void 0:ke.id)||"none"}),re(ut,()=>{var ke;return((ke=c())==null?void 0:ke.id)||"none"}),re(Me,()=>{var ke;return((ke=o())==null?void 0:ke.type)||"none"}),re(Mt,()=>Sn.length),re(Li,(()=>{var ke=Pt(()=>{var at;return!!((at=e==null?void 0:e.drawer)!=null&&at.getType)});return()=>ke()?e.drawer.getType():"canvas"})()),re(fi,()=>ae().toFixed(1),ei),pi.$$input=ke=>{const at=parseFloat(ke.target.value);Ee(at),localStorage.setItem("zoomSpeedMultiplier",at.toString())},re(sn,()=>((De()?2.8:1.8)*ae()).toFixed(1),we),re(mi,()=>{const ke=ii.getCurrentType(),at=ii.detectBrowser(),Ot=!!ke;return`${ke==="safari"||!ke&&(at.isSafari||at.isIOS)?"Apple Mode":"Standard Mode"}  ${Ot?"Manual":"Auto"}`}),gi.$$click=()=>{const at=(ii.getCurrentType()||(ii.detectBrowser().isWebKitBased?"safari":"css"))==="css"?"safari":"css";ii.setPreference(at),window.location.reload()},gi.addEventListener("mouseleave",ke=>{ke.target.style.background="rgba(255,255,255,0.05)",ke.target.style.borderColor="rgba(255,255,255,0.1)"}),gi.addEventListener("mouseenter",ke=>{ke.target.style.background="rgba(255,255,255,0.1)",ke.target.style.borderColor="rgba(255,255,255,0.2)"}),re(X,_e(Ue,{get when(){return ii.getCurrentType()==="safari"||ii.detectBrowser().isWebKitBased&&!ii.getCurrentType()},get children(){return[(()=>{var ke=Kd(),at=ke.firstChild;return at.$$click=()=>{const ti=De()?window.innerHeight*.8:500,Wt=(window.innerWidth-240)/2,on=De()?(window.innerHeight-ti)/2:(window.innerHeight-500)/2;C({x:Wt,y:Math.max(De()?20:50,on)}),Dt(!0)},at.addEventListener("mouseleave",Ot=>{Ot.target.style.background="rgba(255,255,255,0.03)",Ot.target.style.borderColor="rgba(255,255,255,0.08)"}),at.addEventListener("mouseenter",Ot=>{Ot.target.style.background="rgba(255,255,255,0.05)",Ot.target.style.borderColor="rgba(255,255,255,0.15)"}),ke})(),(()=>{var ke=Qd(),at=ke.firstChild,Ot=at.nextSibling,ti=Ot.nextSibling;return re(Ot,()=>Ze[Pe()].name),ti.$$click=()=>{var on;const Wt=(Pe()+1)%Ze.length;Et(Wt),(on=B().overlayManager)!=null&&on.updateBorderConfig&&B().overlayManager.updateBorderConfig(Ze[Wt])},ti.addEventListener("mouseleave",Wt=>{Wt.target.style.background="rgba(255,255,255,0.05)",Wt.target.style.borderColor="rgba(255,255,255,0.1)"}),ti.addEventListener("mouseenter",Wt=>{Wt.target.style.background="rgba(255,255,255,0.1)",Wt.target.style.borderColor="rgba(255,255,255,0.2)"}),ke})()]}}),null),Je(ke=>rs(X,`
    background: rgba(20,20,20,0.95); 
    padding: ${De()?"12px":"16px"}; 
    border-radius: 12px; 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border: 1px solid rgba(255,255,255,0.1); 
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    ${De()?"max-height: 70vh; overflow-y: auto; width: 90%; max-width: 300px;":""}
`,ke)),Je(()=>pi.value=ae()),X}}),null),re(Y,_e(Ue,{get when(){return Pt(()=>!!Oe())()&&(ii.getCurrentType()==="safari"||ii.detectBrowser().isWebKitBased&&!ii.getCurrentType())},get children(){var X=$d(),se=X.firstChild,ve=se.firstChild,Q=ve.nextSibling,Ie=se.nextSibling,We=Ie.firstChild,qe=We.firstChild;qe.firstChild;var rt=qe.nextSibling,Tt=We.nextSibling,ut=Tt.firstChild;ut.firstChild;var dt=ut.nextSibling,it=Tt.nextSibling,Me=it.firstChild;Me.firstChild;var jt=Me.nextSibling,$t=it.nextSibling,Mt=$t.firstChild;Mt.firstChild;var kt=Mt.nextSibling,si=$t.nextSibling,Li=si.firstChild,wn=Li.firstChild,Ci=wn.nextSibling;Ci.nextSibling;var rn=Li.nextSibling,fi=si.nextSibling,oi=fi.firstChild,ei=oi.firstChild,pi=ei.nextSibling;pi.nextSibling;var sn=oi.nextSibling,Vi=fi.nextSibling;return X.style.setProperty("position","fixed"),X.style.setProperty("width","220px"),X.style.setProperty("background","rgba(20,20,20,0.85)"),X.style.setProperty("border","1px solid rgba(255,255,255,0.2)"),X.style.setProperty("borderRadius","12px"),X.style.setProperty("boxShadow","0 8px 32px rgba(0,0,0,0.6)"),X.style.setProperty("zIndex","10000"),X.style.setProperty("userSelect","none"),X.style.setProperty("backdropFilter","blur(20px)"),X.style.setProperty("-webkit-backdrop-filter","blur(20px)"),X.style.setProperty("display","flex"),X.style.setProperty("flexDirection","column"),X.style.setProperty("overflowY","auto"),X.style.setProperty("overflowX","hidden"),se.$$touchstart=we=>{const Ge=we.touches[0];q(!0),ce({x:Ge.clientX-y().x,y:Ge.clientY-y().y})},se.$$mousedown=we=>{q(!0),ce({x:we.clientX-y().x,y:we.clientY-y().y})},se.style.setProperty("position","relative"),se.style.setProperty("padding","12px 40px 12px 16px"),se.style.setProperty("borderBottom","1px solid rgba(255,255,255,0.1)"),se.style.setProperty("cursor","grab"),se.style.setProperty("background","rgba(255,255,255,0.03)"),se.style.setProperty("borderRadius","12px 12px 0 0"),Q.$$click=()=>Dt(!1),Q.addEventListener("mouseleave",we=>{we.target.style.background="transparent",we.target.style.color="rgba(255,255,255,0.5)"}),Q.addEventListener("mouseenter",we=>{we.target.style.background="rgba(255,255,255,0.1)",we.target.style.color="rgba(255,255,255,0.8)"}),Q.style.setProperty("position","absolute"),Q.style.setProperty("top","8px"),Q.style.setProperty("right","8px"),Q.style.setProperty("background","transparent"),Q.style.setProperty("border","none"),Q.style.setProperty("color","rgba(255,255,255,0.5)"),Q.style.setProperty("fontSize","16px"),Q.style.setProperty("cursor","pointer"),Q.style.setProperty("padding","4px"),Q.style.setProperty("width","24px"),Q.style.setProperty("height","24px"),Q.style.setProperty("display","flex"),Q.style.setProperty("alignItems","center"),Q.style.setProperty("justifyContent","center"),Q.style.setProperty("borderRadius","4px"),Q.style.setProperty("transition","all 0.2s"),Ie.style.setProperty("padding","16px"),Ie.style.setProperty("overflowY","auto"),Ie.style.setProperty("overflowX","hidden"),Ie.style.setProperty("flex","1"),Ie.style.setProperty("WebkitOverflowScrolling","touch"),Ie.style.setProperty("scrollbarWidth","thin"),Ie.style.setProperty("scrollbarColor","rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05)"),re(qe,()=>ne().toFixed(2),null),rt.$$input=we=>{const Ge=parseFloat(we.target.value);ct(Ge),window.safariTuning&&(window.safariTuning.circleMultiplier=Ge,B().overlayManager&&c()&&B().overlayManager.forceRecalculation())},re(ut,()=>et().toFixed(2),null),dt.$$input=we=>{const Ge=parseFloat(we.target.value);Qt(Ge),window.safariTuning&&(window.safariTuning.ellipseMultiplierX=Ge,B().overlayManager&&c()&&B().overlayManager.forceRecalculation())},re(Me,()=>_t().toFixed(2),null),jt.$$input=we=>{const Ge=parseFloat(we.target.value);ri(Ge),window.safariTuning&&(window.safariTuning.ellipseMultiplierY=Ge,B().overlayManager&&c()&&B().overlayManager.forceRecalculation())},re(Mt,()=>hi().toFixed(2),null),kt.$$input=we=>{const Ge=parseFloat(we.target.value);Xt(Ge),window.safariTuning&&(window.safariTuning.gradientMultiplier=Ge,B().overlayManager&&c()&&B().overlayManager.forceRecalculation())},re(Li,()=>bt().toFixed(1),Ci),rn.$$input=we=>{const Ge=parseFloat(we.target.value);It(Ge),window.safariTuning&&(window.safariTuning.offsetX=Ge,B().overlayManager&&c()&&B().overlayManager.forceRecalculation())},re(oi,()=>Nt().toFixed(1),pi),sn.$$input=we=>{const Ge=parseFloat(we.target.value);Ut(Ge),window.safariTuning&&(window.safariTuning.offsetY=Ge,B().overlayManager&&c()&&B().overlayManager.forceRecalculation())},Vi.$$click=()=>{console.log("Current tuning values:",window.safariTuning),navigator.clipboard.writeText(JSON.stringify(window.safariTuning,null,2)),alert("Tuning values copied to clipboard!")},Vi.addEventListener("mouseleave",we=>{we.target.style.background="rgba(255,255,255,0.05)",we.target.style.borderColor="rgba(255,255,255,0.1)"}),Vi.addEventListener("mouseenter",we=>{we.target.style.background="rgba(255,255,255,0.1)",we.target.style.borderColor="rgba(255,255,255,0.2)"}),Je(we=>{var Ge=`${y().x}px`,Ai=`${y().y}px`,mi=V()?"grabbing":"default",gi=De()?"80vh":"none",ke=De()?"0.2":"0.1",at=De()?"0.2":"0.5",Ot=De()?"0.2":"0.5",ti=De()?"0.1":"0.3";return Ge!==we.e&&((we.e=Ge)!=null?X.style.setProperty("left",Ge):X.style.removeProperty("left")),Ai!==we.t&&((we.t=Ai)!=null?X.style.setProperty("top",Ai):X.style.removeProperty("top")),mi!==we.a&&((we.a=mi)!=null?X.style.setProperty("cursor",mi):X.style.removeProperty("cursor")),gi!==we.o&&((we.o=gi)!=null?X.style.setProperty("maxHeight",gi):X.style.removeProperty("maxHeight")),ke!==we.i&&Gt(rt,"min",we.i=ke),at!==we.n&&Gt(dt,"min",we.n=at),Ot!==we.s&&Gt(jt,"min",we.s=Ot),ti!==we.h&&Gt(kt,"min",we.h=ti),we},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),Je(()=>rt.value=ne()),Je(()=>dt.value=et()),Je(()=>jt.value=_t()),Je(()=>kt.value=hi()),Je(()=>rn.value=bt()),Je(()=>sn.value=Nt()),X}}),null),re(Y,_e(Ue,{get when(){return Pt(()=>!!d())()&&g()},get children(){var X=ef(),se=X.firstChild;return se.$$click=Jt,X}}),null),re(Y,_e(Ue,{get when(){return Pt(()=>!!d())()&&De()},get children(){var X=tf(),se=X.firstChild;return se.$$click=ui,re(se,(()=>{var ve=Pt(()=>!!w());return()=>ve()?rf():sf()})()),Je(()=>Gt(se,"title",w()?"Exit fullscreen":"Enter fullscreen")),X}}),null),re(Y,_e(Ue,{get when(){return Pt(()=>!!A())()&&O()},get children(){return _e(Vd,{get hotspotId(){var X;return(X=O())==null?void 0:X.id},onClick:tt,get position(){return M()},get isMobile(){return De()}})}}),null),re(Y,_e(Ue,{get when(){return Pt(()=>!!d())()&&B().imageOverlayManager},get children(){return _e(Nd,{get imageOverlayManager(){return B().imageOverlayManager},currentHotspot:O})}}),null),Y})(),_e(Ue,{get when(){return Pt(()=>!!d())()&&B().audioEngine},get children(){return _e(Fd,{get audioEngine(){return B().audioEngine},currentHotspot:J})}})]}jn(["input","click","mousedown","touchstart"]);const af=()=>{};var ol={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mc=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},lf=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],c=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(c>>10)),t[i++]=String.fromCharCode(56320+(c&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},kc={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,c=n+2<s.length,h=c?s[n+2]:0,d=r>>2,l=(r&3)<<4|a>>4;let f=(a&15)<<2|h>>6,p=h&63;c||(p=64,o||(f=64)),i.push(e[d],e[l],e[f],e[p])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(Mc(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):lf(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const h=n<s.length?e[s.charAt(n)]:64;++n;const l=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||h==null||l==null)throw new cf;const f=r<<2|a>>4;if(i.push(f),h!==64){const p=a<<4&240|h>>2;if(i.push(p),l!==64){const g=h<<6&192|l;i.push(g)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class cf extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const hf=function(s){const t=Mc(s);return kc.encodeByteArray(t,!0)},gs=function(s){return hf(s).replace(/\./g,"")},uf=function(s){try{return kc.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function df(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ff=()=>df().__FIREBASE_DEFAULTS__,pf=()=>{if(typeof process>"u"||typeof ol>"u")return;const s=ol.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},mf=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&uf(s[1]);return t&&JSON.parse(t)},Uo=()=>{try{return af()||ff()||pf()||mf()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},gf=s=>{var t,e;return(e=(t=Uo())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},vf=s=>{const t=gf(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},Oc=()=>{var s;return(s=Uo())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yf{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function jo(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function wf(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _f(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[gs(JSON.stringify(e)),gs(JSON.stringify(o)),""].join(".")}const fr={};function Tf(){const s={prod:[],emulator:[]};for(const t of Object.keys(fr))fr[t]?s.emulator.push(t):s.prod.push(t);return s}function xf(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let al=!1;function Ef(s,t){if(typeof window>"u"||typeof document>"u"||!jo(window.location.host)||fr[s]===t||fr[s]||al)return;fr[s]=t;function e(f){return`__firebase__banner__${f}`}const i="__firebase__banner",r=Tf().prod.length>0;function o(){const f=document.getElementById(i);f&&f.remove()}function a(f){f.style.display="flex",f.style.background="#7faaf0",f.style.position="fixed",f.style.bottom="5px",f.style.left="5px",f.style.padding=".5em",f.style.borderRadius="5px",f.style.alignItems="center"}function c(f,p){f.setAttribute("width","24"),f.setAttribute("id",p),f.setAttribute("height","24"),f.setAttribute("viewBox","0 0 24 24"),f.setAttribute("fill","none"),f.style.marginLeft="-6px"}function h(){const f=document.createElement("span");return f.style.cursor="pointer",f.style.marginLeft="16px",f.style.fontSize="24px",f.innerHTML=" &times;",f.onclick=()=>{al=!0,o()},f}function d(f,p){f.setAttribute("id",p),f.innerText="Learn more",f.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",f.setAttribute("target","__blank"),f.style.paddingLeft="5px",f.style.textDecoration="underline"}function l(){const f=xf(i),p=e("text"),g=document.getElementById(p)||document.createElement("span"),v=e("learnmore"),w=document.getElementById(v)||document.createElement("a"),E=e("preprendIcon"),I=document.getElementById(E)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(f.created){const L=f.element;a(L),d(w,v);const N=h();c(I,E),L.append(I,g,w,N),document.body.appendChild(L)}r?(g.innerText="Preview backend disconnected.",I.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(I.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,g.innerText="Preview backend running in this workspace."),g.setAttribute("id",p)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",l):l()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bf(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Sf(){var s;const t=(s=Uo())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function Pf(){return!Sf()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function Cf(){try{return typeof indexedDB=="object"}catch{return!1}}function Af(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Rf="FirebaseError";class Wn extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=Rf,Object.setPrototypeOf(this,Wn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Fc.prototype.create)}}class Fc{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?If(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new Wn(n,a,i)}}function If(s,t){return s.replace(Df,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const Df=/\{\$([^}]+)}/g;function vs(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if(ll(r)&&ll(o)){if(!vs(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function ll(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ei(s){return s&&s._delegate?s._delegate:s}class wr{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cn="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mf{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new yf;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(Of(t))try{this.getOrInitializeService({instanceIdentifier:cn})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=cn){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=cn){return this.instances.has(t)}getOptions(t=cn){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:kf(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=cn){return this.component?this.component.multipleInstances?t:cn:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function kf(s){return s===cn?void 0:s}function Of(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ff{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new Mf(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Be;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(Be||(Be={}));const Lf={debug:Be.DEBUG,verbose:Be.VERBOSE,info:Be.INFO,warn:Be.WARN,error:Be.ERROR,silent:Be.SILENT},Vf=Be.INFO,Bf={[Be.DEBUG]:"log",[Be.VERBOSE]:"log",[Be.INFO]:"info",[Be.WARN]:"warn",[Be.ERROR]:"error"},zf=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=Bf[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class Lc{constructor(t){this.name=t,this._logLevel=Vf,this._logHandler=zf,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Be))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?Lf[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Be.DEBUG,...t),this._logHandler(this,Be.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Be.VERBOSE,...t),this._logHandler(this,Be.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Be.INFO,...t),this._logHandler(this,Be.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Be.WARN,...t),this._logHandler(this,Be.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Be.ERROR,...t),this._logHandler(this,Be.ERROR,...t)}}const Hf=(s,t)=>t.some(e=>s instanceof e);let cl,hl;function Nf(){return cl||(cl=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Uf(){return hl||(hl=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Vc=new WeakMap,go=new WeakMap,Bc=new WeakMap,oo=new WeakMap,Wo=new WeakMap;function jf(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(Ni(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Vc.set(e,s)}).catch(()=>{}),Wo.set(t,s),t}function Wf(s){if(go.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});go.set(s,t)}let vo={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return go.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Bc.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Ni(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function qf(s){vo=s(vo)}function Gf(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(ao(this),t,...e);return Bc.set(i,t.sort?t.sort():[t]),Ni(i)}:Uf().includes(s)?function(...t){return s.apply(ao(this),t),Ni(Vc.get(this))}:function(...t){return Ni(s.apply(ao(this),t))}}function Zf(s){return typeof s=="function"?Gf(s):(s instanceof IDBTransaction&&Wf(s),Hf(s,Nf())?new Proxy(s,vo):s)}function Ni(s){if(s instanceof IDBRequest)return jf(s);if(oo.has(s))return oo.get(s);const t=Zf(s);return t!==s&&(oo.set(s,t),Wo.set(t,s)),t}const ao=s=>Wo.get(s);function Xf(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=Ni(o);return i&&o.addEventListener("upgradeneeded",c=>{i(Ni(o.result),c.oldVersion,c.newVersion,Ni(o.transaction),c)}),e&&o.addEventListener("blocked",c=>e(c.oldVersion,c.newVersion,c)),a.then(c=>{r&&c.addEventListener("close",()=>r()),n&&c.addEventListener("versionchange",h=>n(h.oldVersion,h.newVersion,h))}).catch(()=>{}),a}const Yf=["get","getKey","getAll","getAllKeys","count"],Kf=["put","add","delete","clear"],lo=new Map;function ul(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(lo.get(t))return lo.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=Kf.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||Yf.includes(e)))return;const r=async function(o,...a){const c=this.transaction(o,n?"readwrite":"readonly");let h=c.store;return i&&(h=h.index(a.shift())),(await Promise.all([h[e](...a),n&&c.done]))[0]};return lo.set(t,r),r}qf(s=>({...s,get:(t,e,i)=>ul(t,e)||s.get(t,e,i),has:(t,e)=>!!ul(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qf{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(Jf(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function Jf(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const yo="@firebase/app",dl="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ki=new Lc("@firebase/app"),$f="@firebase/app-compat",ep="@firebase/analytics-compat",tp="@firebase/analytics",ip="@firebase/app-check-compat",np="@firebase/app-check",rp="@firebase/auth",sp="@firebase/auth-compat",op="@firebase/database",ap="@firebase/data-connect",lp="@firebase/database-compat",cp="@firebase/functions",hp="@firebase/functions-compat",up="@firebase/installations",dp="@firebase/installations-compat",fp="@firebase/messaging",pp="@firebase/messaging-compat",mp="@firebase/performance",gp="@firebase/performance-compat",vp="@firebase/remote-config",yp="@firebase/remote-config-compat",wp="@firebase/storage",_p="@firebase/storage-compat",Tp="@firebase/firestore",xp="@firebase/ai",Ep="@firebase/firestore-compat",bp="firebase",Sp="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wo="[DEFAULT]",Pp={[yo]:"fire-core",[$f]:"fire-core-compat",[tp]:"fire-analytics",[ep]:"fire-analytics-compat",[np]:"fire-app-check",[ip]:"fire-app-check-compat",[rp]:"fire-auth",[sp]:"fire-auth-compat",[op]:"fire-rtdb",[ap]:"fire-data-connect",[lp]:"fire-rtdb-compat",[cp]:"fire-fn",[hp]:"fire-fn-compat",[up]:"fire-iid",[dp]:"fire-iid-compat",[fp]:"fire-fcm",[pp]:"fire-fcm-compat",[mp]:"fire-perf",[gp]:"fire-perf-compat",[vp]:"fire-rc",[yp]:"fire-rc-compat",[wp]:"fire-gcs",[_p]:"fire-gcs-compat",[Tp]:"fire-fst",[Ep]:"fire-fst-compat",[xp]:"fire-vertex","fire-js":"fire-js",[bp]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ys=new Map,Cp=new Map,_o=new Map;function fl(s,t){try{s.container.addComponent(t)}catch(e){ki.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function ws(s){const t=s.name;if(_o.has(t))return ki.debug(`There were multiple attempts to register component ${t}.`),!1;_o.set(t,s);for(const e of ys.values())fl(e,s);for(const e of Cp.values())fl(e,s);return!0}function Ap(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function Rp(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ip={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Ui=new Fc("app","Firebase",Ip);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dp{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new wr("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw Ui.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mp=Sp;function zc(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:wo,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw Ui.create("bad-app-name",{appName:String(n)});if(e||(e=Oc()),!e)throw Ui.create("no-options");const r=ys.get(n);if(r){if(vs(e,r.options)&&vs(i,r.config))return r;throw Ui.create("duplicate-app",{appName:n})}const o=new Ff(n);for(const c of _o.values())o.addComponent(c);const a=new Dp(e,i,o);return ys.set(n,a),a}function kp(s=wo){const t=ys.get(s);if(!t&&s===wo&&Oc())return zc();if(!t)throw Ui.create("no-app",{appName:s});return t}function kn(s,t,e){var i;let n=(i=Pp[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),ki.warn(a.join(" "));return}ws(new wr(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Op="firebase-heartbeat-database",Fp=1,_r="firebase-heartbeat-store";let co=null;function Hc(){return co||(co=Xf(Op,Fp,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(_r)}catch(e){console.warn(e)}}}}).catch(s=>{throw Ui.create("idb-open",{originalErrorMessage:s.message})})),co}async function Lp(s){try{const e=(await Hc()).transaction(_r),i=await e.objectStore(_r).get(Nc(s));return await e.done,i}catch(t){if(t instanceof Wn)ki.warn(t.message);else{const e=Ui.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});ki.warn(e.message)}}}async function pl(s,t){try{const i=(await Hc()).transaction(_r,"readwrite");await i.objectStore(_r).put(t,Nc(s)),await i.done}catch(e){if(e instanceof Wn)ki.warn(e.message);else{const i=Ui.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});ki.warn(i.message)}}}function Nc(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vp=1024,Bp=30;class zp{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new Np(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=ml();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>Bp){const o=Up(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){ki.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=ml(),{heartbeatsToSend:i,unsentEntries:n}=Hp(this._heartbeatsCache.heartbeats),r=gs(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return ki.warn(e),""}}}function ml(){return new Date().toISOString().substring(0,10)}function Hp(s,t=Vp){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),gl(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),gl(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class Np{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Cf()?Af().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await Lp(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return pl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return pl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function gl(s){return gs(JSON.stringify({version:2,heartbeats:s})).length}function Up(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function jp(s){ws(new wr("platform-logger",t=>new Qf(t),"PRIVATE")),ws(new wr("heartbeat",t=>new zp(t),"PRIVATE")),kn(yo,dl,s),kn(yo,dl,"esm2017"),kn("fire-js","")}jp("");var vl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var ji,Uc;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(k,A){function P(){}P.prototype=A.prototype,k.D=A.prototype,k.prototype=new P,k.prototype.constructor=k,k.C=function(M,F,O){for(var D=Array(arguments.length-2),B=2;B<arguments.length;B++)D[B-2]=arguments[B];return A.prototype[F].apply(M,D)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(k,A,P){P||(P=0);var M=Array(16);if(typeof A=="string")for(var F=0;16>F;++F)M[F]=A.charCodeAt(P++)|A.charCodeAt(P++)<<8|A.charCodeAt(P++)<<16|A.charCodeAt(P++)<<24;else for(F=0;16>F;++F)M[F]=A[P++]|A[P++]<<8|A[P++]<<16|A[P++]<<24;A=k.g[0],P=k.g[1],F=k.g[2];var O=k.g[3],D=A+(O^P&(F^O))+M[0]+3614090360&4294967295;A=P+(D<<7&4294967295|D>>>25),D=O+(F^A&(P^F))+M[1]+3905402710&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(P^O&(A^P))+M[2]+606105819&4294967295,F=O+(D<<17&4294967295|D>>>15),D=P+(A^F&(O^A))+M[3]+3250441966&4294967295,P=F+(D<<22&4294967295|D>>>10),D=A+(O^P&(F^O))+M[4]+4118548399&4294967295,A=P+(D<<7&4294967295|D>>>25),D=O+(F^A&(P^F))+M[5]+1200080426&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(P^O&(A^P))+M[6]+2821735955&4294967295,F=O+(D<<17&4294967295|D>>>15),D=P+(A^F&(O^A))+M[7]+4249261313&4294967295,P=F+(D<<22&4294967295|D>>>10),D=A+(O^P&(F^O))+M[8]+1770035416&4294967295,A=P+(D<<7&4294967295|D>>>25),D=O+(F^A&(P^F))+M[9]+2336552879&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(P^O&(A^P))+M[10]+4294925233&4294967295,F=O+(D<<17&4294967295|D>>>15),D=P+(A^F&(O^A))+M[11]+2304563134&4294967295,P=F+(D<<22&4294967295|D>>>10),D=A+(O^P&(F^O))+M[12]+1804603682&4294967295,A=P+(D<<7&4294967295|D>>>25),D=O+(F^A&(P^F))+M[13]+4254626195&4294967295,O=A+(D<<12&4294967295|D>>>20),D=F+(P^O&(A^P))+M[14]+2792965006&4294967295,F=O+(D<<17&4294967295|D>>>15),D=P+(A^F&(O^A))+M[15]+1236535329&4294967295,P=F+(D<<22&4294967295|D>>>10),D=A+(F^O&(P^F))+M[1]+4129170786&4294967295,A=P+(D<<5&4294967295|D>>>27),D=O+(P^F&(A^P))+M[6]+3225465664&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^P&(O^A))+M[11]+643717713&4294967295,F=O+(D<<14&4294967295|D>>>18),D=P+(O^A&(F^O))+M[0]+3921069994&4294967295,P=F+(D<<20&4294967295|D>>>12),D=A+(F^O&(P^F))+M[5]+3593408605&4294967295,A=P+(D<<5&4294967295|D>>>27),D=O+(P^F&(A^P))+M[10]+38016083&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^P&(O^A))+M[15]+3634488961&4294967295,F=O+(D<<14&4294967295|D>>>18),D=P+(O^A&(F^O))+M[4]+3889429448&4294967295,P=F+(D<<20&4294967295|D>>>12),D=A+(F^O&(P^F))+M[9]+568446438&4294967295,A=P+(D<<5&4294967295|D>>>27),D=O+(P^F&(A^P))+M[14]+3275163606&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^P&(O^A))+M[3]+4107603335&4294967295,F=O+(D<<14&4294967295|D>>>18),D=P+(O^A&(F^O))+M[8]+1163531501&4294967295,P=F+(D<<20&4294967295|D>>>12),D=A+(F^O&(P^F))+M[13]+2850285829&4294967295,A=P+(D<<5&4294967295|D>>>27),D=O+(P^F&(A^P))+M[2]+4243563512&4294967295,O=A+(D<<9&4294967295|D>>>23),D=F+(A^P&(O^A))+M[7]+1735328473&4294967295,F=O+(D<<14&4294967295|D>>>18),D=P+(O^A&(F^O))+M[12]+2368359562&4294967295,P=F+(D<<20&4294967295|D>>>12),D=A+(P^F^O)+M[5]+4294588738&4294967295,A=P+(D<<4&4294967295|D>>>28),D=O+(A^P^F)+M[8]+2272392833&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^P)+M[11]+1839030562&4294967295,F=O+(D<<16&4294967295|D>>>16),D=P+(F^O^A)+M[14]+4259657740&4294967295,P=F+(D<<23&4294967295|D>>>9),D=A+(P^F^O)+M[1]+2763975236&4294967295,A=P+(D<<4&4294967295|D>>>28),D=O+(A^P^F)+M[4]+1272893353&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^P)+M[7]+4139469664&4294967295,F=O+(D<<16&4294967295|D>>>16),D=P+(F^O^A)+M[10]+3200236656&4294967295,P=F+(D<<23&4294967295|D>>>9),D=A+(P^F^O)+M[13]+681279174&4294967295,A=P+(D<<4&4294967295|D>>>28),D=O+(A^P^F)+M[0]+3936430074&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^P)+M[3]+3572445317&4294967295,F=O+(D<<16&4294967295|D>>>16),D=P+(F^O^A)+M[6]+76029189&4294967295,P=F+(D<<23&4294967295|D>>>9),D=A+(P^F^O)+M[9]+3654602809&4294967295,A=P+(D<<4&4294967295|D>>>28),D=O+(A^P^F)+M[12]+3873151461&4294967295,O=A+(D<<11&4294967295|D>>>21),D=F+(O^A^P)+M[15]+530742520&4294967295,F=O+(D<<16&4294967295|D>>>16),D=P+(F^O^A)+M[2]+3299628645&4294967295,P=F+(D<<23&4294967295|D>>>9),D=A+(F^(P|~O))+M[0]+4096336452&4294967295,A=P+(D<<6&4294967295|D>>>26),D=O+(P^(A|~F))+M[7]+1126891415&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~P))+M[14]+2878612391&4294967295,F=O+(D<<15&4294967295|D>>>17),D=P+(O^(F|~A))+M[5]+4237533241&4294967295,P=F+(D<<21&4294967295|D>>>11),D=A+(F^(P|~O))+M[12]+1700485571&4294967295,A=P+(D<<6&4294967295|D>>>26),D=O+(P^(A|~F))+M[3]+2399980690&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~P))+M[10]+4293915773&4294967295,F=O+(D<<15&4294967295|D>>>17),D=P+(O^(F|~A))+M[1]+2240044497&4294967295,P=F+(D<<21&4294967295|D>>>11),D=A+(F^(P|~O))+M[8]+1873313359&4294967295,A=P+(D<<6&4294967295|D>>>26),D=O+(P^(A|~F))+M[15]+4264355552&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~P))+M[6]+2734768916&4294967295,F=O+(D<<15&4294967295|D>>>17),D=P+(O^(F|~A))+M[13]+1309151649&4294967295,P=F+(D<<21&4294967295|D>>>11),D=A+(F^(P|~O))+M[4]+4149444226&4294967295,A=P+(D<<6&4294967295|D>>>26),D=O+(P^(A|~F))+M[11]+3174756917&4294967295,O=A+(D<<10&4294967295|D>>>22),D=F+(A^(O|~P))+M[2]+718787259&4294967295,F=O+(D<<15&4294967295|D>>>17),D=P+(O^(F|~A))+M[9]+3951481745&4294967295,k.g[0]=k.g[0]+A&4294967295,k.g[1]=k.g[1]+(F+(D<<21&4294967295|D>>>11))&4294967295,k.g[2]=k.g[2]+F&4294967295,k.g[3]=k.g[3]+O&4294967295}i.prototype.u=function(k,A){A===void 0&&(A=k.length);for(var P=A-this.blockSize,M=this.B,F=this.h,O=0;O<A;){if(F==0)for(;O<=P;)n(this,k,O),O+=this.blockSize;if(typeof k=="string"){for(;O<A;)if(M[F++]=k.charCodeAt(O++),F==this.blockSize){n(this,M),F=0;break}}else for(;O<A;)if(M[F++]=k[O++],F==this.blockSize){n(this,M),F=0;break}}this.h=F,this.o+=A},i.prototype.v=function(){var k=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);k[0]=128;for(var A=1;A<k.length-8;++A)k[A]=0;var P=8*this.o;for(A=k.length-8;A<k.length;++A)k[A]=P&255,P/=256;for(this.u(k),k=Array(16),A=P=0;4>A;++A)for(var M=0;32>M;M+=8)k[P++]=this.g[A]>>>M&255;return k};function r(k,A){var P=a;return Object.prototype.hasOwnProperty.call(P,k)?P[k]:P[k]=A(k)}function o(k,A){this.h=A;for(var P=[],M=!0,F=k.length-1;0<=F;F--){var O=k[F]|0;M&&O==A||(P[F]=O,M=!1)}this.g=P}var a={};function c(k){return-128<=k&&128>k?r(k,function(A){return new o([A|0],0>A?-1:0)}):new o([k|0],0>k?-1:0)}function h(k){if(isNaN(k)||!isFinite(k))return l;if(0>k)return w(h(-k));for(var A=[],P=1,M=0;k>=P;M++)A[M]=k/P|0,P*=4294967296;return new o(A,0)}function d(k,A){if(k.length==0)throw Error("number format error: empty string");if(A=A||10,2>A||36<A)throw Error("radix out of range: "+A);if(k.charAt(0)=="-")return w(d(k.substring(1),A));if(0<=k.indexOf("-"))throw Error('number format error: interior "-" character');for(var P=h(Math.pow(A,8)),M=l,F=0;F<k.length;F+=8){var O=Math.min(8,k.length-F),D=parseInt(k.substring(F,F+O),A);8>O?(O=h(Math.pow(A,O)),M=M.j(O).add(h(D))):(M=M.j(P),M=M.add(h(D)))}return M}var l=c(0),f=c(1),p=c(16777216);s=o.prototype,s.m=function(){if(v(this))return-w(this).m();for(var k=0,A=1,P=0;P<this.g.length;P++){var M=this.i(P);k+=(0<=M?M:4294967296+M)*A,A*=4294967296}return k},s.toString=function(k){if(k=k||10,2>k||36<k)throw Error("radix out of range: "+k);if(g(this))return"0";if(v(this))return"-"+w(this).toString(k);for(var A=h(Math.pow(k,6)),P=this,M="";;){var F=N(P,A).g;P=E(P,F.j(A));var O=((0<P.g.length?P.g[0]:P.h)>>>0).toString(k);if(P=F,g(P))return O+M;for(;6>O.length;)O="0"+O;M=O+M}},s.i=function(k){return 0>k?0:k<this.g.length?this.g[k]:this.h};function g(k){if(k.h!=0)return!1;for(var A=0;A<k.g.length;A++)if(k.g[A]!=0)return!1;return!0}function v(k){return k.h==-1}s.l=function(k){return k=E(this,k),v(k)?-1:g(k)?0:1};function w(k){for(var A=k.g.length,P=[],M=0;M<A;M++)P[M]=~k.g[M];return new o(P,~k.h).add(f)}s.abs=function(){return v(this)?w(this):this},s.add=function(k){for(var A=Math.max(this.g.length,k.g.length),P=[],M=0,F=0;F<=A;F++){var O=M+(this.i(F)&65535)+(k.i(F)&65535),D=(O>>>16)+(this.i(F)>>>16)+(k.i(F)>>>16);M=D>>>16,O&=65535,D&=65535,P[F]=D<<16|O}return new o(P,P[P.length-1]&-2147483648?-1:0)};function E(k,A){return k.add(w(A))}s.j=function(k){if(g(this)||g(k))return l;if(v(this))return v(k)?w(this).j(w(k)):w(w(this).j(k));if(v(k))return w(this.j(w(k)));if(0>this.l(p)&&0>k.l(p))return h(this.m()*k.m());for(var A=this.g.length+k.g.length,P=[],M=0;M<2*A;M++)P[M]=0;for(M=0;M<this.g.length;M++)for(var F=0;F<k.g.length;F++){var O=this.i(M)>>>16,D=this.i(M)&65535,B=k.i(F)>>>16,Ce=k.i(F)&65535;P[2*M+2*F]+=D*Ce,I(P,2*M+2*F),P[2*M+2*F+1]+=O*Ce,I(P,2*M+2*F+1),P[2*M+2*F+1]+=D*B,I(P,2*M+2*F+1),P[2*M+2*F+2]+=O*B,I(P,2*M+2*F+2)}for(M=0;M<A;M++)P[M]=P[2*M+1]<<16|P[2*M];for(M=A;M<2*A;M++)P[M]=0;return new o(P,0)};function I(k,A){for(;(k[A]&65535)!=k[A];)k[A+1]+=k[A]>>>16,k[A]&=65535,A++}function L(k,A){this.g=k,this.h=A}function N(k,A){if(g(A))throw Error("division by zero");if(g(k))return new L(l,l);if(v(k))return A=N(w(k),A),new L(w(A.g),w(A.h));if(v(A))return A=N(k,w(A)),new L(w(A.g),A.h);if(30<k.g.length){if(v(k)||v(A))throw Error("slowDivide_ only works with positive integers.");for(var P=f,M=A;0>=M.l(k);)P=Z(P),M=Z(M);var F=J(P,1),O=J(M,1);for(M=J(M,2),P=J(P,2);!g(M);){var D=O.add(M);0>=D.l(k)&&(F=F.add(P),O=D),M=J(M,1),P=J(P,1)}return A=E(k,F.j(A)),new L(F,A)}for(F=l;0<=k.l(A);){for(P=Math.max(1,Math.floor(k.m()/A.m())),M=Math.ceil(Math.log(P)/Math.LN2),M=48>=M?1:Math.pow(2,M-48),O=h(P),D=O.j(A);v(D)||0<D.l(k);)P-=M,O=h(P),D=O.j(A);g(O)&&(O=f),F=F.add(O),k=E(k,D)}return new L(F,k)}s.A=function(k){return N(this,k).h},s.and=function(k){for(var A=Math.max(this.g.length,k.g.length),P=[],M=0;M<A;M++)P[M]=this.i(M)&k.i(M);return new o(P,this.h&k.h)},s.or=function(k){for(var A=Math.max(this.g.length,k.g.length),P=[],M=0;M<A;M++)P[M]=this.i(M)|k.i(M);return new o(P,this.h|k.h)},s.xor=function(k){for(var A=Math.max(this.g.length,k.g.length),P=[],M=0;M<A;M++)P[M]=this.i(M)^k.i(M);return new o(P,this.h^k.h)};function Z(k){for(var A=k.g.length+1,P=[],M=0;M<A;M++)P[M]=k.i(M)<<1|k.i(M-1)>>>31;return new o(P,k.h)}function J(k,A){var P=A>>5;A%=32;for(var M=k.g.length-P,F=[],O=0;O<M;O++)F[O]=0<A?k.i(O+P)>>>A|k.i(O+P+1)<<32-A:k.i(O+P);return new o(F,k.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,Uc=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=h,o.fromString=d,ji=o}).apply(typeof vl<"u"?vl:typeof self<"u"?self:typeof window<"u"?window:{});var Qr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var jc,lr,Wc,ss,To,qc,Gc,Zc;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(u,m,_){return u==Array.prototype||u==Object.prototype||(u[m]=_.value),u};function e(u){u=[typeof globalThis=="object"&&globalThis,u,typeof window=="object"&&window,typeof self=="object"&&self,typeof Qr=="object"&&Qr];for(var m=0;m<u.length;++m){var _=u[m];if(_&&_.Math==Math)return _}throw Error("Cannot find global object")}var i=e(this);function n(u,m){if(m)e:{var _=i;u=u.split(".");for(var b=0;b<u.length-1;b++){var z=u[b];if(!(z in _))break e;_=_[z]}u=u[u.length-1],b=_[u],m=m(b),m!=b&&m!=null&&t(_,u,{configurable:!0,writable:!0,value:m})}}function r(u,m){u instanceof String&&(u+="");var _=0,b=!1,z={next:function(){if(!b&&_<u.length){var H=_++;return{value:m(H,u[H]),done:!1}}return b=!0,{done:!0,value:void 0}}};return z[Symbol.iterator]=function(){return z},z}n("Array.prototype.values",function(u){return u||function(){return r(this,function(m,_){return _})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function c(u){var m=typeof u;return m=m!="object"?m:u?Array.isArray(u)?"array":m:"null",m=="array"||m=="object"&&typeof u.length=="number"}function h(u){var m=typeof u;return m=="object"&&u!=null||m=="function"}function d(u,m,_){return u.call.apply(u.bind,arguments)}function l(u,m,_){if(!u)throw Error();if(2<arguments.length){var b=Array.prototype.slice.call(arguments,2);return function(){var z=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(z,b),u.apply(m,z)}}return function(){return u.apply(m,arguments)}}function f(u,m,_){return f=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:l,f.apply(null,arguments)}function p(u,m){var _=Array.prototype.slice.call(arguments,1);return function(){var b=_.slice();return b.push.apply(b,arguments),u.apply(this,b)}}function g(u,m){function _(){}_.prototype=m.prototype,u.aa=m.prototype,u.prototype=new _,u.prototype.constructor=u,u.Qb=function(b,z,H){for(var ie=Array(arguments.length-2),Ye=2;Ye<arguments.length;Ye++)ie[Ye-2]=arguments[Ye];return m.prototype[z].apply(b,ie)}}function v(u){const m=u.length;if(0<m){const _=Array(m);for(let b=0;b<m;b++)_[b]=u[b];return _}return[]}function w(u,m){for(let _=1;_<arguments.length;_++){const b=arguments[_];if(c(b)){const z=u.length||0,H=b.length||0;u.length=z+H;for(let ie=0;ie<H;ie++)u[z+ie]=b[ie]}else u.push(b)}}class E{constructor(m,_){this.i=m,this.j=_,this.h=0,this.g=null}get(){let m;return 0<this.h?(this.h--,m=this.g,this.g=m.next,m.next=null):m=this.i(),m}}function I(u){return/^[\s\xa0]*$/.test(u)}function L(){var u=a.navigator;return u&&(u=u.userAgent)?u:""}function N(u){return N[" "](u),u}N[" "]=function(){};var Z=L().indexOf("Gecko")!=-1&&!(L().toLowerCase().indexOf("webkit")!=-1&&L().indexOf("Edge")==-1)&&!(L().indexOf("Trident")!=-1||L().indexOf("MSIE")!=-1)&&L().indexOf("Edge")==-1;function J(u,m,_){for(const b in u)m.call(_,u[b],b,u)}function k(u,m){for(const _ in u)m.call(void 0,u[_],_,u)}function A(u){const m={};for(const _ in u)m[_]=u[_];return m}const P="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function M(u,m){let _,b;for(let z=1;z<arguments.length;z++){b=arguments[z];for(_ in b)u[_]=b[_];for(let H=0;H<P.length;H++)_=P[H],Object.prototype.hasOwnProperty.call(b,_)&&(u[_]=b[_])}}function F(u){var m=1;u=u.split(":");const _=[];for(;0<m&&u.length;)_.push(u.shift()),m--;return u.length&&_.push(u.join(":")),_}function O(u){a.setTimeout(()=>{throw u},0)}function D(){var u=Ee;let m=null;return u.g&&(m=u.g,u.g=u.g.next,u.g||(u.h=null),m.next=null),m}class B{constructor(){this.h=this.g=null}add(m,_){const b=Ce.get();b.set(m,_),this.h?this.h.next=b:this.g=b,this.h=b}}var Ce=new E(()=>new Re,u=>u.reset());class Re{constructor(){this.next=this.g=this.h=null}set(m,_){this.h=m,this.g=_,this.next=null}reset(){this.next=this.g=this.h=null}}let He,ae=!1,Ee=new B,Pe=()=>{const u=a.Promise.resolve(void 0);He=()=>{u.then(Et)}};var Et=()=>{for(var u;u=D();){try{u.h.call(u.g)}catch(_){O(_)}var m=Ce;m.j(u),100>m.h&&(m.h++,u.next=m.g,m.g=u)}ae=!1};function Ze(){this.s=this.s,this.C=this.C}Ze.prototype.s=!1,Ze.prototype.ma=function(){this.s||(this.s=!0,this.N())},Ze.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function ne(u,m){this.type=u,this.g=this.target=m,this.defaultPrevented=!1}ne.prototype.h=function(){this.defaultPrevented=!0};var ct=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var u=!1,m=Object.defineProperty({},"passive",{get:function(){u=!0}});try{const _=()=>{};a.addEventListener("test",_,m),a.removeEventListener("test",_,m)}catch{}return u}();function et(u,m){if(ne.call(this,u?u.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,u){var _=this.type=u.type,b=u.changedTouches&&u.changedTouches.length?u.changedTouches[0]:null;if(this.target=u.target||u.srcElement,this.g=m,m=u.relatedTarget){if(Z){e:{try{N(m.nodeName);var z=!0;break e}catch{}z=!1}z||(m=null)}}else _=="mouseover"?m=u.fromElement:_=="mouseout"&&(m=u.toElement);this.relatedTarget=m,b?(this.clientX=b.clientX!==void 0?b.clientX:b.pageX,this.clientY=b.clientY!==void 0?b.clientY:b.pageY,this.screenX=b.screenX||0,this.screenY=b.screenY||0):(this.clientX=u.clientX!==void 0?u.clientX:u.pageX,this.clientY=u.clientY!==void 0?u.clientY:u.pageY,this.screenX=u.screenX||0,this.screenY=u.screenY||0),this.button=u.button,this.key=u.key||"",this.ctrlKey=u.ctrlKey,this.altKey=u.altKey,this.shiftKey=u.shiftKey,this.metaKey=u.metaKey,this.pointerId=u.pointerId||0,this.pointerType=typeof u.pointerType=="string"?u.pointerType:Qt[u.pointerType]||"",this.state=u.state,this.i=u,u.defaultPrevented&&et.aa.h.call(this)}}g(et,ne);var Qt={2:"touch",3:"pen",4:"mouse"};et.prototype.h=function(){et.aa.h.call(this);var u=this.i;u.preventDefault?u.preventDefault():u.returnValue=!1};var _t="closure_listenable_"+(1e6*Math.random()|0),ri=0;function hi(u,m,_,b,z){this.listener=u,this.proxy=null,this.src=m,this.type=_,this.capture=!!b,this.ha=z,this.key=++ri,this.da=this.fa=!1}function Xt(u){u.da=!0,u.listener=null,u.proxy=null,u.src=null,u.ha=null}function bt(u){this.src=u,this.g={},this.h=0}bt.prototype.add=function(u,m,_,b,z){var H=u.toString();u=this.g[H],u||(u=this.g[H]=[],this.h++);var ie=Nt(u,m,b,z);return-1<ie?(m=u[ie],_||(m.fa=!1)):(m=new hi(m,this.src,H,!!b,z),m.fa=_,u.push(m)),m};function It(u,m){var _=m.type;if(_ in u.g){var b=u.g[_],z=Array.prototype.indexOf.call(b,m,void 0),H;(H=0<=z)&&Array.prototype.splice.call(b,z,1),H&&(Xt(m),u.g[_].length==0&&(delete u.g[_],u.h--))}}function Nt(u,m,_,b){for(var z=0;z<u.length;++z){var H=u[z];if(!H.da&&H.listener==m&&H.capture==!!_&&H.ha==b)return z}return-1}var Ut="closure_lm_"+(1e6*Math.random()|0),Oe={};function Dt(u,m,_,b,z){if(Array.isArray(m)){for(var H=0;H<m.length;H++)Dt(u,m[H],_,b,z);return null}return _=Fe(_),u&&u[_t]?u.K(m,_,h(b)?!!b.capture:!1,z):y(u,m,_,!1,b,z)}function y(u,m,_,b,z,H){if(!m)throw Error("Invalid event type");var ie=h(z)?!!z.capture:!!z,Ye=G(u);if(Ye||(u[Ut]=Ye=new bt(u)),_=Ye.add(m,_,b,ie,H),_.proxy)return _;if(b=C(),_.proxy=b,b.src=u,b.listener=_,u.addEventListener)ct||(z=ie),z===void 0&&(z=!1),u.addEventListener(m.toString(),b,z);else if(u.attachEvent)u.attachEvent($(m.toString()),b);else if(u.addListener&&u.removeListener)u.addListener(b);else throw Error("addEventListener and attachEvent are unavailable.");return _}function C(){function u(_){return m.call(u.src,u.listener,_)}const m=ce;return u}function V(u,m,_,b,z){if(Array.isArray(m))for(var H=0;H<m.length;H++)V(u,m[H],_,b,z);else b=h(b)?!!b.capture:!!b,_=Fe(_),u&&u[_t]?(u=u.i,m=String(m).toString(),m in u.g&&(H=u.g[m],_=Nt(H,_,b,z),-1<_&&(Xt(H[_]),Array.prototype.splice.call(H,_,1),H.length==0&&(delete u.g[m],u.h--)))):u&&(u=G(u))&&(m=u.g[m.toString()],u=-1,m&&(u=Nt(m,_,b,z)),(_=-1<u?m[u]:null)&&q(_))}function q(u){if(typeof u!="number"&&u&&!u.da){var m=u.src;if(m&&m[_t])It(m.i,u);else{var _=u.type,b=u.proxy;m.removeEventListener?m.removeEventListener(_,b,u.capture):m.detachEvent?m.detachEvent($(_),b):m.addListener&&m.removeListener&&m.removeListener(b),(_=G(m))?(It(_,u),_.h==0&&(_.src=null,m[Ut]=null)):Xt(u)}}}function $(u){return u in Oe?Oe[u]:Oe[u]="on"+u}function ce(u,m){if(u.da)u=!0;else{m=new et(m,this);var _=u.listener,b=u.ha||u.src;u.fa&&q(u),u=_.call(b,m)}return u}function G(u){return u=u[Ut],u instanceof bt?u:null}var ye="__closure_events_fn_"+(1e9*Math.random()>>>0);function Fe(u){return typeof u=="function"?u:(u[ye]||(u[ye]=function(m){return u.handleEvent(m)}),u[ye])}function be(){Ze.call(this),this.i=new bt(this),this.M=this,this.F=null}g(be,Ze),be.prototype[_t]=!0,be.prototype.removeEventListener=function(u,m,_,b){V(this,u,m,_,b)};function he(u,m){var _,b=u.F;if(b)for(_=[];b;b=b.F)_.push(b);if(u=u.M,b=m.type||m,typeof m=="string")m=new ne(m,u);else if(m instanceof ne)m.target=m.target||u;else{var z=m;m=new ne(b,u),M(m,z)}if(z=!0,_)for(var H=_.length-1;0<=H;H--){var ie=m.g=_[H];z=Xe(ie,b,!0,m)&&z}if(ie=m.g=u,z=Xe(ie,b,!0,m)&&z,z=Xe(ie,b,!1,m)&&z,_)for(H=0;H<_.length;H++)ie=m.g=_[H],z=Xe(ie,b,!1,m)&&z}be.prototype.N=function(){if(be.aa.N.call(this),this.i){var u=this.i,m;for(m in u.g){for(var _=u.g[m],b=0;b<_.length;b++)Xt(_[b]);delete u.g[m],u.h--}}this.F=null},be.prototype.K=function(u,m,_,b){return this.i.add(String(u),m,!1,_,b)},be.prototype.L=function(u,m,_,b){return this.i.add(String(u),m,!0,_,b)};function Xe(u,m,_,b){if(m=u.i.g[String(m)],!m)return!0;m=m.concat();for(var z=!0,H=0;H<m.length;++H){var ie=m[H];if(ie&&!ie.da&&ie.capture==_){var Ye=ie.listener,St=ie.ha||ie.src;ie.fa&&It(u.i,ie),z=Ye.call(St,b)!==!1&&z}}return z&&!b.defaultPrevented}function x(u,m,_){if(typeof u=="function")_&&(u=f(u,_));else if(u&&typeof u.handleEvent=="function")u=f(u.handleEvent,u);else throw Error("Invalid listener argument");return 2147483647<Number(m)?-1:a.setTimeout(u,m||0)}function T(u){u.g=x(()=>{u.g=null,u.i&&(u.i=!1,T(u))},u.l);const m=u.h;u.h=null,u.m.apply(null,m)}class S extends Ze{constructor(m,_){super(),this.m=m,this.l=_,this.h=null,this.i=!1,this.g=null}j(m){this.h=arguments,this.g?this.i=!0:T(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function R(u){Ze.call(this),this.h=u,this.g={}}g(R,Ze);var U=[];function K(u){J(u.g,function(m,_){this.g.hasOwnProperty(_)&&q(m)},u),u.g={}}R.prototype.N=function(){R.aa.N.call(this),K(this)},R.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var pe=a.JSON.stringify,ze=a.JSON.parse,ge=class{stringify(u){return a.JSON.stringify(u,void 0)}parse(u){return a.JSON.parse(u,void 0)}};function ht(){}ht.prototype.h=null;function tt(u){return u.h||(u.h=u.i())}function Jt(){}var ui={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Si(){ne.call(this,"d")}g(Si,ne);function Pi(){ne.call(this,"c")}g(Pi,ne);var di={},Kn=null;function nn(){return Kn=Kn||new be}di.La="serverreachability";function Qn(u){ne.call(this,di.La,u)}g(Qn,ne);function Y(u){const m=nn();he(m,new Qn(m))}di.STAT_EVENT="statevent";function fe(u,m){ne.call(this,di.STAT_EVENT,u),this.stat=m}g(fe,ne);function te(u){const m=nn();he(m,new fe(m,u))}di.Ma="timingevent";function X(u,m){ne.call(this,di.Ma,u),this.size=m}g(X,ne);function se(u,m){if(typeof u!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){u()},m)}function ve(){this.g=!0}ve.prototype.xa=function(){this.g=!1};function Q(u,m,_,b,z,H){u.info(function(){if(u.g)if(H)for(var ie="",Ye=H.split("&"),St=0;St<Ye.length;St++){var Ne=Ye[St].split("=");if(1<Ne.length){var Ft=Ne[0];Ne=Ne[1];var Lt=Ft.split("_");ie=2<=Lt.length&&Lt[1]=="type"?ie+(Ft+"="+Ne+"&"):ie+(Ft+"=redacted&")}}else ie=null;else ie=H;return"XMLHTTP REQ ("+b+") [attempt "+z+"]: "+m+`
`+_+`
`+ie})}function Ie(u,m,_,b,z,H,ie){u.info(function(){return"XMLHTTP RESP ("+b+") [ attempt "+z+"]: "+m+`
`+_+`
`+H+" "+ie})}function We(u,m,_,b){u.info(function(){return"XMLHTTP TEXT ("+m+"): "+rt(u,_)+(b?" "+b:"")})}function qe(u,m){u.info(function(){return"TIMEOUT: "+m})}ve.prototype.info=function(){};function rt(u,m){if(!u.g)return m;if(!m)return null;try{var _=JSON.parse(m);if(_){for(u=0;u<_.length;u++)if(Array.isArray(_[u])){var b=_[u];if(!(2>b.length)){var z=b[1];if(Array.isArray(z)&&!(1>z.length)){var H=z[0];if(H!="noop"&&H!="stop"&&H!="close")for(var ie=1;ie<z.length;ie++)z[ie]=""}}}}return pe(_)}catch{return m}}var Tt={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},ut={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},dt;function it(){}g(it,ht),it.prototype.g=function(){return new XMLHttpRequest},it.prototype.i=function(){return{}},dt=new it;function Me(u,m,_,b){this.j=u,this.i=m,this.l=_,this.R=b||1,this.U=new R(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new jt}function jt(){this.i=null,this.g="",this.h=!1}var $t={},Mt={};function kt(u,m,_){u.L=1,u.v=Br(Ri(m)),u.m=_,u.P=!0,si(u,null)}function si(u,m){u.F=Date.now(),Ci(u),u.A=Ri(u.v);var _=u.A,b=u.R;Array.isArray(b)||(b=[String(b)]),Ia(_.i,"t",b),u.C=0,_=u.j.J,u.h=new jt,u.g=Xa(u.j,_?m:null,!u.m),0<u.O&&(u.M=new S(f(u.Y,u,u.g),u.O)),m=u.U,_=u.g,b=u.ca;var z="readystatechange";Array.isArray(z)||(z&&(U[0]=z.toString()),z=U);for(var H=0;H<z.length;H++){var ie=Dt(_,z[H],b||m.handleEvent,!1,m.h||m);if(!ie)break;m.g[ie.key]=ie}m=u.H?A(u.H):{},u.m?(u.u||(u.u="POST"),m["Content-Type"]="application/x-www-form-urlencoded",u.g.ea(u.A,u.u,u.m,m)):(u.u="GET",u.g.ea(u.A,u.u,null,m)),Y(),Q(u.i,u.u,u.A,u.l,u.R,u.m)}Me.prototype.ca=function(u){u=u.target;const m=this.M;m&&Ii(u)==3?m.j():this.Y(u)},Me.prototype.Y=function(u){try{if(u==this.g)e:{const Lt=Ii(this.g);var m=this.g.Ba();const xn=this.g.Z();if(!(3>Lt)&&(Lt!=3||this.g&&(this.h.h||this.g.oa()||Va(this.g)))){this.J||Lt!=4||m==7||(m==8||0>=xn?Y(3):Y(2)),fi(this);var _=this.g.Z();this.X=_;t:if(Li(this)){var b=Va(this.g);u="";var z=b.length,H=Ii(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){ei(this),oi(this);var ie="";break t}this.h.i=new a.TextDecoder}for(m=0;m<z;m++)this.h.h=!0,u+=this.h.i.decode(b[m],{stream:!(H&&m==z-1)});b.length=0,this.h.g+=u,this.C=0,ie=this.h.g}else ie=this.g.oa();if(this.o=_==200,Ie(this.i,this.u,this.A,this.l,this.R,Lt,_),this.o){if(this.T&&!this.K){t:{if(this.g){var Ye,St=this.g;if((Ye=St.g?St.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!I(Ye)){var Ne=Ye;break t}}Ne=null}if(_=Ne)We(this.i,this.l,_,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,pi(this,_);else{this.o=!1,this.s=3,te(12),ei(this),oi(this);break e}}if(this.P){_=!0;let ai;for(;!this.J&&this.C<ie.length;)if(ai=wn(this,ie),ai==Mt){Lt==4&&(this.s=4,te(14),_=!1),We(this.i,this.l,null,"[Incomplete Response]");break}else if(ai==$t){this.s=4,te(15),We(this.i,this.l,ie,"[Invalid Chunk]"),_=!1;break}else We(this.i,this.l,ai,null),pi(this,ai);if(Li(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Lt!=4||ie.length!=0||this.h.h||(this.s=1,te(16),_=!1),this.o=this.o&&_,!_)We(this.i,this.l,ie,"[Invalid Chunked Response]"),ei(this),oi(this);else if(0<ie.length&&!this.W){this.W=!0;var Ft=this.j;Ft.g==this&&Ft.ba&&!Ft.M&&(Ft.j.info("Great, no buffering proxy detected. Bytes received: "+ie.length),Js(Ft),Ft.M=!0,te(11))}}else We(this.i,this.l,ie,null),pi(this,ie);Lt==4&&ei(this),this.o&&!this.J&&(Lt==4?Wa(this.j,this):(this.o=!1,Ci(this)))}else Ru(this.g),_==400&&0<ie.indexOf("Unknown SID")?(this.s=3,te(12)):(this.s=0,te(13)),ei(this),oi(this)}}}catch{}finally{}};function Li(u){return u.g?u.u=="GET"&&u.L!=2&&u.j.Ca:!1}function wn(u,m){var _=u.C,b=m.indexOf(`
`,_);return b==-1?Mt:(_=Number(m.substring(_,b)),isNaN(_)?$t:(b+=1,b+_>m.length?Mt:(m=m.slice(b,b+_),u.C=b+_,m)))}Me.prototype.cancel=function(){this.J=!0,ei(this)};function Ci(u){u.S=Date.now()+u.I,rn(u,u.I)}function rn(u,m){if(u.B!=null)throw Error("WatchDog timer not null");u.B=se(f(u.ba,u),m)}function fi(u){u.B&&(a.clearTimeout(u.B),u.B=null)}Me.prototype.ba=function(){this.B=null;const u=Date.now();0<=u-this.S?(qe(this.i,this.A),this.L!=2&&(Y(),te(17)),ei(this),this.s=2,oi(this)):rn(this,this.S-u)};function oi(u){u.j.G==0||u.J||Wa(u.j,u)}function ei(u){fi(u);var m=u.M;m&&typeof m.ma=="function"&&m.ma(),u.M=null,K(u.U),u.g&&(m=u.g,u.g=null,m.abort(),m.ma())}function pi(u,m){try{var _=u.j;if(_.G!=0&&(_.g==u||Ai(_.h,u))){if(!u.K&&Ai(_.h,u)&&_.G==3){try{var b=_.Da.g.parse(m)}catch{b=null}if(Array.isArray(b)&&b.length==3){var z=b;if(z[0]==0){e:if(!_.u){if(_.g)if(_.g.F+3e3<u.F)Wr(_),Ur(_);else break e;Qs(_),te(18)}}else _.za=z[1],0<_.za-_.T&&37500>z[2]&&_.F&&_.v==0&&!_.C&&(_.C=se(f(_.Za,_),6e3));if(1>=Ge(_.h)&&_.ca){try{_.ca()}catch{}_.ca=void 0}}else ln(_,11)}else if((u.K||_.g==u)&&Wr(_),!I(m))for(z=_.Da.g.parse(m),m=0;m<z.length;m++){let Ne=z[m];if(_.T=Ne[0],Ne=Ne[1],_.G==2)if(Ne[0]=="c"){_.K=Ne[1],_.ia=Ne[2];const Ft=Ne[3];Ft!=null&&(_.la=Ft,_.j.info("VER="+_.la));const Lt=Ne[4];Lt!=null&&(_.Aa=Lt,_.j.info("SVER="+_.Aa));const xn=Ne[5];xn!=null&&typeof xn=="number"&&0<xn&&(b=1.5*xn,_.L=b,_.j.info("backChannelRequestTimeoutMs_="+b)),b=_;const ai=u.g;if(ai){const Gr=ai.g?ai.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Gr){var H=b.h;H.g||Gr.indexOf("spdy")==-1&&Gr.indexOf("quic")==-1&&Gr.indexOf("h2")==-1||(H.j=H.l,H.g=new Set,H.h&&(mi(H,H.h),H.h=null))}if(b.D){const $s=ai.g?ai.g.getResponseHeader("X-HTTP-Session-Id"):null;$s&&(b.ya=$s,Qe(b.I,b.D,$s))}}_.G=3,_.l&&_.l.ua(),_.ba&&(_.R=Date.now()-u.F,_.j.info("Handshake RTT: "+_.R+"ms")),b=_;var ie=u;if(b.qa=Za(b,b.J?b.ia:null,b.W),ie.K){gi(b.h,ie);var Ye=ie,St=b.L;St&&(Ye.I=St),Ye.B&&(fi(Ye),Ci(Ye)),b.g=ie}else Ua(b);0<_.i.length&&jr(_)}else Ne[0]!="stop"&&Ne[0]!="close"||ln(_,7);else _.G==3&&(Ne[0]=="stop"||Ne[0]=="close"?Ne[0]=="stop"?ln(_,7):Ks(_):Ne[0]!="noop"&&_.l&&_.l.ta(Ne),_.v=0)}}Y(4)}catch{}}var sn=class{constructor(u,m){this.g=u,this.map=m}};function Vi(u){this.l=u||10,a.PerformanceNavigationTiming?(u=a.performance.getEntriesByType("navigation"),u=0<u.length&&(u[0].nextHopProtocol=="hq"||u[0].nextHopProtocol=="h2")):u=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=u?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function we(u){return u.h?!0:u.g?u.g.size>=u.j:!1}function Ge(u){return u.h?1:u.g?u.g.size:0}function Ai(u,m){return u.h?u.h==m:u.g?u.g.has(m):!1}function mi(u,m){u.g?u.g.add(m):u.h=m}function gi(u,m){u.h&&u.h==m?u.h=null:u.g&&u.g.has(m)&&u.g.delete(m)}Vi.prototype.cancel=function(){if(this.i=ke(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const u of this.g.values())u.cancel();this.g.clear()}};function ke(u){if(u.h!=null)return u.i.concat(u.h.D);if(u.g!=null&&u.g.size!==0){let m=u.i;for(const _ of u.g.values())m=m.concat(_.D);return m}return v(u.i)}function at(u){if(u.V&&typeof u.V=="function")return u.V();if(typeof Map<"u"&&u instanceof Map||typeof Set<"u"&&u instanceof Set)return Array.from(u.values());if(typeof u=="string")return u.split("");if(c(u)){for(var m=[],_=u.length,b=0;b<_;b++)m.push(u[b]);return m}m=[],_=0;for(b in u)m[_++]=u[b];return m}function Ot(u){if(u.na&&typeof u.na=="function")return u.na();if(!u.V||typeof u.V!="function"){if(typeof Map<"u"&&u instanceof Map)return Array.from(u.keys());if(!(typeof Set<"u"&&u instanceof Set)){if(c(u)||typeof u=="string"){var m=[];u=u.length;for(var _=0;_<u;_++)m.push(_);return m}m=[],_=0;for(const b in u)m[_++]=b;return m}}}function ti(u,m){if(u.forEach&&typeof u.forEach=="function")u.forEach(m,void 0);else if(c(u)||typeof u=="string")Array.prototype.forEach.call(u,m,void 0);else for(var _=Ot(u),b=at(u),z=b.length,H=0;H<z;H++)m.call(void 0,b[H],_&&_[H],u)}var Wt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function on(u,m){if(u){u=u.split("&");for(var _=0;_<u.length;_++){var b=u[_].indexOf("="),z=null;if(0<=b){var H=u[_].substring(0,b);z=u[_].substring(b+1)}else H=u[_];m(H,z?decodeURIComponent(z.replace(/\+/g," ")):"")}}}function an(u){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,u instanceof an){this.h=u.h,Lr(this,u.j),this.o=u.o,this.g=u.g,Vr(this,u.s),this.l=u.l;var m=u.i,_=new er;_.i=m.i,m.g&&(_.g=new Map(m.g),_.h=m.h),Pa(this,_),this.m=u.m}else u&&(m=String(u).match(Wt))?(this.h=!1,Lr(this,m[1]||"",!0),this.o=Jn(m[2]||""),this.g=Jn(m[3]||"",!0),Vr(this,m[4]),this.l=Jn(m[5]||"",!0),Pa(this,m[6]||"",!0),this.m=Jn(m[7]||"")):(this.h=!1,this.i=new er(null,this.h))}an.prototype.toString=function(){var u=[],m=this.j;m&&u.push($n(m,Ca,!0),":");var _=this.g;return(_||m=="file")&&(u.push("//"),(m=this.o)&&u.push($n(m,Ca,!0),"@"),u.push(encodeURIComponent(String(_)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),_=this.s,_!=null&&u.push(":",String(_))),(_=this.l)&&(this.g&&_.charAt(0)!="/"&&u.push("/"),u.push($n(_,_.charAt(0)=="/"?wu:yu,!0))),(_=this.i.toString())&&u.push("?",_),(_=this.m)&&u.push("#",$n(_,Tu)),u.join("")};function Ri(u){return new an(u)}function Lr(u,m,_){u.j=_?Jn(m,!0):m,u.j&&(u.j=u.j.replace(/:$/,""))}function Vr(u,m){if(m){if(m=Number(m),isNaN(m)||0>m)throw Error("Bad port number "+m);u.s=m}else u.s=null}function Pa(u,m,_){m instanceof er?(u.i=m,xu(u.i,u.h)):(_||(m=$n(m,_u)),u.i=new er(m,u.h))}function Qe(u,m,_){u.i.set(m,_)}function Br(u){return Qe(u,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),u}function Jn(u,m){return u?m?decodeURI(u.replace(/%25/g,"%2525")):decodeURIComponent(u):""}function $n(u,m,_){return typeof u=="string"?(u=encodeURI(u).replace(m,vu),_&&(u=u.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),u):null}function vu(u){return u=u.charCodeAt(0),"%"+(u>>4&15).toString(16)+(u&15).toString(16)}var Ca=/[#\/\?@]/g,yu=/[#\?:]/g,wu=/[#\?]/g,_u=/[#\?@]/g,Tu=/#/g;function er(u,m){this.h=this.g=null,this.i=u||null,this.j=!!m}function Bi(u){u.g||(u.g=new Map,u.h=0,u.i&&on(u.i,function(m,_){u.add(decodeURIComponent(m.replace(/\+/g," ")),_)}))}s=er.prototype,s.add=function(u,m){Bi(this),this.i=null,u=_n(this,u);var _=this.g.get(u);return _||this.g.set(u,_=[]),_.push(m),this.h+=1,this};function Aa(u,m){Bi(u),m=_n(u,m),u.g.has(m)&&(u.i=null,u.h-=u.g.get(m).length,u.g.delete(m))}function Ra(u,m){return Bi(u),m=_n(u,m),u.g.has(m)}s.forEach=function(u,m){Bi(this),this.g.forEach(function(_,b){_.forEach(function(z){u.call(m,z,b,this)},this)},this)},s.na=function(){Bi(this);const u=Array.from(this.g.values()),m=Array.from(this.g.keys()),_=[];for(let b=0;b<m.length;b++){const z=u[b];for(let H=0;H<z.length;H++)_.push(m[b])}return _},s.V=function(u){Bi(this);let m=[];if(typeof u=="string")Ra(this,u)&&(m=m.concat(this.g.get(_n(this,u))));else{u=Array.from(this.g.values());for(let _=0;_<u.length;_++)m=m.concat(u[_])}return m},s.set=function(u,m){return Bi(this),this.i=null,u=_n(this,u),Ra(this,u)&&(this.h-=this.g.get(u).length),this.g.set(u,[m]),this.h+=1,this},s.get=function(u,m){return u?(u=this.V(u),0<u.length?String(u[0]):m):m};function Ia(u,m,_){Aa(u,m),0<_.length&&(u.i=null,u.g.set(_n(u,m),v(_)),u.h+=_.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const u=[],m=Array.from(this.g.keys());for(var _=0;_<m.length;_++){var b=m[_];const H=encodeURIComponent(String(b)),ie=this.V(b);for(b=0;b<ie.length;b++){var z=H;ie[b]!==""&&(z+="="+encodeURIComponent(String(ie[b]))),u.push(z)}}return this.i=u.join("&")};function _n(u,m){return m=String(m),u.j&&(m=m.toLowerCase()),m}function xu(u,m){m&&!u.j&&(Bi(u),u.i=null,u.g.forEach(function(_,b){var z=b.toLowerCase();b!=z&&(Aa(this,b),Ia(this,z,_))},u)),u.j=m}function Eu(u,m){const _=new ve;if(a.Image){const b=new Image;b.onload=p(zi,_,"TestLoadImage: loaded",!0,m,b),b.onerror=p(zi,_,"TestLoadImage: error",!1,m,b),b.onabort=p(zi,_,"TestLoadImage: abort",!1,m,b),b.ontimeout=p(zi,_,"TestLoadImage: timeout",!1,m,b),a.setTimeout(function(){b.ontimeout&&b.ontimeout()},1e4),b.src=u}else m(!1)}function bu(u,m){const _=new ve,b=new AbortController,z=setTimeout(()=>{b.abort(),zi(_,"TestPingServer: timeout",!1,m)},1e4);fetch(u,{signal:b.signal}).then(H=>{clearTimeout(z),H.ok?zi(_,"TestPingServer: ok",!0,m):zi(_,"TestPingServer: server error",!1,m)}).catch(()=>{clearTimeout(z),zi(_,"TestPingServer: error",!1,m)})}function zi(u,m,_,b,z){try{z&&(z.onload=null,z.onerror=null,z.onabort=null,z.ontimeout=null),b(_)}catch{}}function Su(){this.g=new ge}function Pu(u,m,_){const b=_||"";try{ti(u,function(z,H){let ie=z;h(z)&&(ie=pe(z)),m.push(b+H+"="+encodeURIComponent(ie))})}catch(z){throw m.push(b+"type="+encodeURIComponent("_badmap")),z}}function zr(u){this.l=u.Ub||null,this.j=u.eb||!1}g(zr,ht),zr.prototype.g=function(){return new Hr(this.l,this.j)},zr.prototype.i=function(u){return function(){return u}}({});function Hr(u,m){be.call(this),this.D=u,this.o=m,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}g(Hr,be),s=Hr.prototype,s.open=function(u,m){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=u,this.A=m,this.readyState=1,ir(this)},s.send=function(u){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const m={headers:this.u,method:this.B,credentials:this.m,cache:void 0};u&&(m.body=u),(this.D||a).fetch(new Request(this.A,m)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,tr(this)),this.readyState=0},s.Sa=function(u){if(this.g&&(this.l=u,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=u.headers,this.readyState=2,ir(this)),this.g&&(this.readyState=3,ir(this),this.g)))if(this.responseType==="arraybuffer")u.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in u){if(this.j=u.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Da(this)}else u.text().then(this.Ra.bind(this),this.ga.bind(this))};function Da(u){u.j.read().then(u.Pa.bind(u)).catch(u.ga.bind(u))}s.Pa=function(u){if(this.g){if(this.o&&u.value)this.response.push(u.value);else if(!this.o){var m=u.value?u.value:new Uint8Array(0);(m=this.v.decode(m,{stream:!u.done}))&&(this.response=this.responseText+=m)}u.done?tr(this):ir(this),this.readyState==3&&Da(this)}},s.Ra=function(u){this.g&&(this.response=this.responseText=u,tr(this))},s.Qa=function(u){this.g&&(this.response=u,tr(this))},s.ga=function(){this.g&&tr(this)};function tr(u){u.readyState=4,u.l=null,u.j=null,u.v=null,ir(u)}s.setRequestHeader=function(u,m){this.u.append(u,m)},s.getResponseHeader=function(u){return this.h&&this.h.get(u.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const u=[],m=this.h.entries();for(var _=m.next();!_.done;)_=_.value,u.push(_[0]+": "+_[1]),_=m.next();return u.join(`\r
`)};function ir(u){u.onreadystatechange&&u.onreadystatechange.call(u)}Object.defineProperty(Hr.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(u){this.m=u?"include":"same-origin"}});function Ma(u){let m="";return J(u,function(_,b){m+=b,m+=":",m+=_,m+=`\r
`}),m}function Ys(u,m,_){e:{for(b in _){var b=!1;break e}b=!0}b||(_=Ma(_),typeof u=="string"?_!=null&&encodeURIComponent(String(_)):Qe(u,m,_))}function st(u){be.call(this),this.headers=new Map,this.o=u||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}g(st,be);var Cu=/^https?$/i,Au=["POST","PUT"];s=st.prototype,s.Ha=function(u){this.J=u},s.ea=function(u,m,_,b){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+u);m=m?m.toUpperCase():"GET",this.D=u,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():dt.g(),this.v=this.o?tt(this.o):tt(dt),this.g.onreadystatechange=f(this.Ea,this);try{this.B=!0,this.g.open(m,String(u),!0),this.B=!1}catch(H){ka(this,H);return}if(u=_||"",_=new Map(this.headers),b)if(Object.getPrototypeOf(b)===Object.prototype)for(var z in b)_.set(z,b[z]);else if(typeof b.keys=="function"&&typeof b.get=="function")for(const H of b.keys())_.set(H,b.get(H));else throw Error("Unknown input type for opt_headers: "+String(b));b=Array.from(_.keys()).find(H=>H.toLowerCase()=="content-type"),z=a.FormData&&u instanceof a.FormData,!(0<=Array.prototype.indexOf.call(Au,m,void 0))||b||z||_.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[H,ie]of _)this.g.setRequestHeader(H,ie);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{La(this),this.u=!0,this.g.send(u),this.u=!1}catch(H){ka(this,H)}};function ka(u,m){u.h=!1,u.g&&(u.j=!0,u.g.abort(),u.j=!1),u.l=m,u.m=5,Oa(u),Nr(u)}function Oa(u){u.A||(u.A=!0,he(u,"complete"),he(u,"error"))}s.abort=function(u){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=u||7,he(this,"complete"),he(this,"abort"),Nr(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Nr(this,!0)),st.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?Fa(this):this.bb())},s.bb=function(){Fa(this)};function Fa(u){if(u.h&&typeof o<"u"&&(!u.v[1]||Ii(u)!=4||u.Z()!=2)){if(u.u&&Ii(u)==4)x(u.Ea,0,u);else if(he(u,"readystatechange"),Ii(u)==4){u.h=!1;try{const ie=u.Z();e:switch(ie){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var m=!0;break e;default:m=!1}var _;if(!(_=m)){var b;if(b=ie===0){var z=String(u.D).match(Wt)[1]||null;!z&&a.self&&a.self.location&&(z=a.self.location.protocol.slice(0,-1)),b=!Cu.test(z?z.toLowerCase():"")}_=b}if(_)he(u,"complete"),he(u,"success");else{u.m=6;try{var H=2<Ii(u)?u.g.statusText:""}catch{H=""}u.l=H+" ["+u.Z()+"]",Oa(u)}}finally{Nr(u)}}}}function Nr(u,m){if(u.g){La(u);const _=u.g,b=u.v[0]?()=>{}:null;u.g=null,u.v=null,m||he(u,"ready");try{_.onreadystatechange=b}catch{}}}function La(u){u.I&&(a.clearTimeout(u.I),u.I=null)}s.isActive=function(){return!!this.g};function Ii(u){return u.g?u.g.readyState:0}s.Z=function(){try{return 2<Ii(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(u){if(this.g){var m=this.g.responseText;return u&&m.indexOf(u)==0&&(m=m.substring(u.length)),ze(m)}};function Va(u){try{if(!u.g)return null;if("response"in u.g)return u.g.response;switch(u.H){case"":case"text":return u.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in u.g)return u.g.mozResponseArrayBuffer}return null}catch{return null}}function Ru(u){const m={};u=(u.g&&2<=Ii(u)&&u.g.getAllResponseHeaders()||"").split(`\r
`);for(let b=0;b<u.length;b++){if(I(u[b]))continue;var _=F(u[b]);const z=_[0];if(_=_[1],typeof _!="string")continue;_=_.trim();const H=m[z]||[];m[z]=H,H.push(_)}k(m,function(b){return b.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function nr(u,m,_){return _&&_.internalChannelParams&&_.internalChannelParams[u]||m}function Ba(u){this.Aa=0,this.i=[],this.j=new ve,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=nr("failFast",!1,u),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=nr("baseRetryDelayMs",5e3,u),this.cb=nr("retryDelaySeedMs",1e4,u),this.Wa=nr("forwardChannelMaxRetries",2,u),this.wa=nr("forwardChannelRequestTimeoutMs",2e4,u),this.pa=u&&u.xmlHttpFactory||void 0,this.Xa=u&&u.Tb||void 0,this.Ca=u&&u.useFetchStreams||!1,this.L=void 0,this.J=u&&u.supportsCrossDomainXhr||!1,this.K="",this.h=new Vi(u&&u.concurrentRequestLimit),this.Da=new Su,this.P=u&&u.fastHandshake||!1,this.O=u&&u.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=u&&u.Rb||!1,u&&u.xa&&this.j.xa(),u&&u.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&u&&u.detectBufferingProxy||!1,this.ja=void 0,u&&u.longPollingTimeout&&0<u.longPollingTimeout&&(this.ja=u.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=Ba.prototype,s.la=8,s.G=1,s.connect=function(u,m,_,b){te(0),this.W=u,this.H=m||{},_&&b!==void 0&&(this.H.OSID=_,this.H.OAID=b),this.F=this.X,this.I=Za(this,null,this.W),jr(this)};function Ks(u){if(za(u),u.G==3){var m=u.U++,_=Ri(u.I);if(Qe(_,"SID",u.K),Qe(_,"RID",m),Qe(_,"TYPE","terminate"),rr(u,_),m=new Me(u,u.j,m),m.L=2,m.v=Br(Ri(_)),_=!1,a.navigator&&a.navigator.sendBeacon)try{_=a.navigator.sendBeacon(m.v.toString(),"")}catch{}!_&&a.Image&&(new Image().src=m.v,_=!0),_||(m.g=Xa(m.j,null),m.g.ea(m.v)),m.F=Date.now(),Ci(m)}Ga(u)}function Ur(u){u.g&&(Js(u),u.g.cancel(),u.g=null)}function za(u){Ur(u),u.u&&(a.clearTimeout(u.u),u.u=null),Wr(u),u.h.cancel(),u.s&&(typeof u.s=="number"&&a.clearTimeout(u.s),u.s=null)}function jr(u){if(!we(u.h)&&!u.s){u.s=!0;var m=u.Ga;He||Pe(),ae||(He(),ae=!0),Ee.add(m,u),u.B=0}}function Iu(u,m){return Ge(u.h)>=u.h.j-(u.s?1:0)?!1:u.s?(u.i=m.D.concat(u.i),!0):u.G==1||u.G==2||u.B>=(u.Va?0:u.Wa)?!1:(u.s=se(f(u.Ga,u,m),qa(u,u.B)),u.B++,!0)}s.Ga=function(u){if(this.s)if(this.s=null,this.G==1){if(!u){this.U=Math.floor(1e5*Math.random()),u=this.U++;const z=new Me(this,this.j,u);let H=this.o;if(this.S&&(H?(H=A(H),M(H,this.S)):H=this.S),this.m!==null||this.O||(z.H=H,H=null),this.P)e:{for(var m=0,_=0;_<this.i.length;_++){t:{var b=this.i[_];if("__data__"in b.map&&(b=b.map.__data__,typeof b=="string")){b=b.length;break t}b=void 0}if(b===void 0)break;if(m+=b,4096<m){m=_;break e}if(m===4096||_===this.i.length-1){m=_+1;break e}}m=1e3}else m=1e3;m=Na(this,z,m),_=Ri(this.I),Qe(_,"RID",u),Qe(_,"CVER",22),this.D&&Qe(_,"X-HTTP-Session-Id",this.D),rr(this,_),H&&(this.O?m="headers="+encodeURIComponent(String(Ma(H)))+"&"+m:this.m&&Ys(_,this.m,H)),mi(this.h,z),this.Ua&&Qe(_,"TYPE","init"),this.P?(Qe(_,"$req",m),Qe(_,"SID","null"),z.T=!0,kt(z,_,null)):kt(z,_,m),this.G=2}}else this.G==3&&(u?Ha(this,u):this.i.length==0||we(this.h)||Ha(this))};function Ha(u,m){var _;m?_=m.l:_=u.U++;const b=Ri(u.I);Qe(b,"SID",u.K),Qe(b,"RID",_),Qe(b,"AID",u.T),rr(u,b),u.m&&u.o&&Ys(b,u.m,u.o),_=new Me(u,u.j,_,u.B+1),u.m===null&&(_.H=u.o),m&&(u.i=m.D.concat(u.i)),m=Na(u,_,1e3),_.I=Math.round(.5*u.wa)+Math.round(.5*u.wa*Math.random()),mi(u.h,_),kt(_,b,m)}function rr(u,m){u.H&&J(u.H,function(_,b){Qe(m,b,_)}),u.l&&ti({},function(_,b){Qe(m,b,_)})}function Na(u,m,_){_=Math.min(u.i.length,_);var b=u.l?f(u.l.Na,u.l,u):null;e:{var z=u.i;let H=-1;for(;;){const ie=["count="+_];H==-1?0<_?(H=z[0].g,ie.push("ofs="+H)):H=0:ie.push("ofs="+H);let Ye=!0;for(let St=0;St<_;St++){let Ne=z[St].g;const Ft=z[St].map;if(Ne-=H,0>Ne)H=Math.max(0,z[St].g-100),Ye=!1;else try{Pu(Ft,ie,"req"+Ne+"_")}catch{b&&b(Ft)}}if(Ye){b=ie.join("&");break e}}}return u=u.i.splice(0,_),m.D=u,b}function Ua(u){if(!u.g&&!u.u){u.Y=1;var m=u.Fa;He||Pe(),ae||(He(),ae=!0),Ee.add(m,u),u.v=0}}function Qs(u){return u.g||u.u||3<=u.v?!1:(u.Y++,u.u=se(f(u.Fa,u),qa(u,u.v)),u.v++,!0)}s.Fa=function(){if(this.u=null,ja(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var u=2*this.R;this.j.info("BP detection timer enabled: "+u),this.A=se(f(this.ab,this),u)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,te(10),Ur(this),ja(this))};function Js(u){u.A!=null&&(a.clearTimeout(u.A),u.A=null)}function ja(u){u.g=new Me(u,u.j,"rpc",u.Y),u.m===null&&(u.g.H=u.o),u.g.O=0;var m=Ri(u.qa);Qe(m,"RID","rpc"),Qe(m,"SID",u.K),Qe(m,"AID",u.T),Qe(m,"CI",u.F?"0":"1"),!u.F&&u.ja&&Qe(m,"TO",u.ja),Qe(m,"TYPE","xmlhttp"),rr(u,m),u.m&&u.o&&Ys(m,u.m,u.o),u.L&&(u.g.I=u.L);var _=u.g;u=u.ia,_.L=1,_.v=Br(Ri(m)),_.m=null,_.P=!0,si(_,u)}s.Za=function(){this.C!=null&&(this.C=null,Ur(this),Qs(this),te(19))};function Wr(u){u.C!=null&&(a.clearTimeout(u.C),u.C=null)}function Wa(u,m){var _=null;if(u.g==m){Wr(u),Js(u),u.g=null;var b=2}else if(Ai(u.h,m))_=m.D,gi(u.h,m),b=1;else return;if(u.G!=0){if(m.o)if(b==1){_=m.m?m.m.length:0,m=Date.now()-m.F;var z=u.B;b=nn(),he(b,new X(b,_)),jr(u)}else Ua(u);else if(z=m.s,z==3||z==0&&0<m.X||!(b==1&&Iu(u,m)||b==2&&Qs(u)))switch(_&&0<_.length&&(m=u.h,m.i=m.i.concat(_)),z){case 1:ln(u,5);break;case 4:ln(u,10);break;case 3:ln(u,6);break;default:ln(u,2)}}}function qa(u,m){let _=u.Ta+Math.floor(Math.random()*u.cb);return u.isActive()||(_*=2),_*m}function ln(u,m){if(u.j.info("Error code "+m),m==2){var _=f(u.fb,u),b=u.Xa;const z=!b;b=new an(b||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||Lr(b,"https"),Br(b),z?Eu(b.toString(),_):bu(b.toString(),_)}else te(2);u.G=0,u.l&&u.l.sa(m),Ga(u),za(u)}s.fb=function(u){u?(this.j.info("Successfully pinged google.com"),te(2)):(this.j.info("Failed to ping google.com"),te(1))};function Ga(u){if(u.G=0,u.ka=[],u.l){const m=ke(u.h);(m.length!=0||u.i.length!=0)&&(w(u.ka,m),w(u.ka,u.i),u.h.i.length=0,v(u.i),u.i.length=0),u.l.ra()}}function Za(u,m,_){var b=_ instanceof an?Ri(_):new an(_);if(b.g!="")m&&(b.g=m+"."+b.g),Vr(b,b.s);else{var z=a.location;b=z.protocol,m=m?m+"."+z.hostname:z.hostname,z=+z.port;var H=new an(null);b&&Lr(H,b),m&&(H.g=m),z&&Vr(H,z),_&&(H.l=_),b=H}return _=u.D,m=u.ya,_&&m&&Qe(b,_,m),Qe(b,"VER",u.la),rr(u,b),b}function Xa(u,m,_){if(m&&!u.J)throw Error("Can't create secondary domain capable XhrIo object.");return m=u.Ca&&!u.pa?new st(new zr({eb:_})):new st(u.pa),m.Ha(u.J),m}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function Ya(){}s=Ya.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function qr(){}qr.prototype.g=function(u,m){return new Yt(u,m)};function Yt(u,m){be.call(this),this.g=new Ba(m),this.l=u,this.h=m&&m.messageUrlParams||null,u=m&&m.messageHeaders||null,m&&m.clientProtocolHeaderRequired&&(u?u["X-Client-Protocol"]="webchannel":u={"X-Client-Protocol":"webchannel"}),this.g.o=u,u=m&&m.initMessageHeaders||null,m&&m.messageContentType&&(u?u["X-WebChannel-Content-Type"]=m.messageContentType:u={"X-WebChannel-Content-Type":m.messageContentType}),m&&m.va&&(u?u["X-WebChannel-Client-Profile"]=m.va:u={"X-WebChannel-Client-Profile":m.va}),this.g.S=u,(u=m&&m.Sb)&&!I(u)&&(this.g.m=u),this.v=m&&m.supportsCrossDomainXhr||!1,this.u=m&&m.sendRawJson||!1,(m=m&&m.httpSessionIdParam)&&!I(m)&&(this.g.D=m,u=this.h,u!==null&&m in u&&(u=this.h,m in u&&delete u[m])),this.j=new Tn(this)}g(Yt,be),Yt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Yt.prototype.close=function(){Ks(this.g)},Yt.prototype.o=function(u){var m=this.g;if(typeof u=="string"){var _={};_.__data__=u,u=_}else this.u&&(_={},_.__data__=pe(u),u=_);m.i.push(new sn(m.Ya++,u)),m.G==3&&jr(m)},Yt.prototype.N=function(){this.g.l=null,delete this.j,Ks(this.g),delete this.g,Yt.aa.N.call(this)};function Ka(u){Si.call(this),u.__headers__&&(this.headers=u.__headers__,this.statusCode=u.__status__,delete u.__headers__,delete u.__status__);var m=u.__sm__;if(m){e:{for(const _ in m){u=_;break e}u=void 0}(this.i=u)&&(u=this.i,m=m!==null&&u in m?m[u]:void 0),this.data=m}else this.data=u}g(Ka,Si);function Qa(){Pi.call(this),this.status=1}g(Qa,Pi);function Tn(u){this.g=u}g(Tn,Ya),Tn.prototype.ua=function(){he(this.g,"a")},Tn.prototype.ta=function(u){he(this.g,new Ka(u))},Tn.prototype.sa=function(u){he(this.g,new Qa)},Tn.prototype.ra=function(){he(this.g,"b")},qr.prototype.createWebChannel=qr.prototype.g,Yt.prototype.send=Yt.prototype.o,Yt.prototype.open=Yt.prototype.m,Yt.prototype.close=Yt.prototype.close,Zc=function(){return new qr},Gc=function(){return nn()},qc=di,To={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Tt.NO_ERROR=0,Tt.TIMEOUT=8,Tt.HTTP_ERROR=6,ss=Tt,ut.COMPLETE="complete",Wc=ut,Jt.EventType=ui,ui.OPEN="a",ui.CLOSE="b",ui.ERROR="c",ui.MESSAGE="d",be.prototype.listen=be.prototype.K,lr=Jt,st.prototype.listenOnce=st.prototype.L,st.prototype.getLastError=st.prototype.Ka,st.prototype.getLastErrorCode=st.prototype.Ba,st.prototype.getStatus=st.prototype.Z,st.prototype.getResponseJson=st.prototype.Oa,st.prototype.getResponseText=st.prototype.oa,st.prototype.send=st.prototype.ea,st.prototype.setWithCredentials=st.prototype.Ha,jc=st}).apply(typeof Qr<"u"?Qr:typeof self<"u"?self:typeof window<"u"?window:{});const yl="@firebase/firestore",wl="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bt{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Bt.UNAUTHENTICATED=new Bt(null),Bt.GOOGLE_CREDENTIALS=new Bt("google-credentials-uid"),Bt.FIRST_PARTY=new Bt("first-party-uid"),Bt.MOCK_USER=new Bt("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let qn="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pn=new Lc("@firebase/firestore");function An(){return pn.logLevel}function le(s,...t){if(pn.logLevel<=Be.DEBUG){const e=t.map(qo);pn.debug(`Firestore (${qn}): ${s}`,...e)}}function Oi(s,...t){if(pn.logLevel<=Be.ERROR){const e=t.map(qo);pn.error(`Firestore (${qn}): ${s}`,...e)}}function Gi(s,...t){if(pn.logLevel<=Be.WARN){const e=t.map(qo);pn.warn(`Firestore (${qn}): ${s}`,...e)}}function qo(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Te(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,Xc(s,i,e)}function Xc(s,t,e){let i=`FIRESTORE (${qn}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw Oi(i),new Error(i)}function je(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||Xc(t,n,i)}function Se(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const j={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class oe extends Wn{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dn{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yc{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Wp{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(Bt.UNAUTHENTICATED))}shutdown(){}}class qp{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class Gp{constructor(t){this.t=t,this.currentUser=Bt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){je(this.o===void 0,42304);let i=this.i;const n=c=>this.i!==i?(i=this.i,e(c)):Promise.resolve();let r=new dn;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new dn,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const c=r;t.enqueueRetryable(async()=>{await c.promise,await n(this.currentUser)})},a=c=>{le("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(c=>a(c)),setTimeout(()=>{if(!this.auth){const c=this.t.getImmediate({optional:!0});c?a(c):(le("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new dn)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(le("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(je(typeof i.accessToken=="string",31837,{l:i}),new Yc(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return je(t===null||typeof t=="string",2055,{h:t}),new Bt(t)}}class Zp{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=Bt.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Xp{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new Zp(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(Bt.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class _l{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Yp{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,Rp(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){je(this.o===void 0,3512);const i=r=>{r.error!=null&&le("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,le("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{le("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):le("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new _l(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(je(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new _l(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Kp(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Kc(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Go{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=Kp(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function Ae(s,t){return s<t?-1:s>t?1:0}function xo(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return Ae(i,n);{const r=Kc(),o=Qp(r.encode(Tl(s,e)),r.encode(Tl(t,e)));return o!==0?o:Ae(i,n)}}e+=i>65535?2:1}return Ae(s.length,t.length)}function Tl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function Qp(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return Ae(s[e],t[e]);return Ae(s.length,t.length)}function Vn(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xl="__name__";class yi{constructor(t,e,i){e===void 0?e=0:e>t.length&&Te(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&Te(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return yi.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof yi?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=yi.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return Ae(t.length,e.length)}static compareSegments(t,e){const i=yi.isNumericId(t),n=yi.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?yi.extractNumericId(t).compare(yi.extractNumericId(e)):xo(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return ji.fromString(t.substring(4,t.length-2))}}class Ke extends yi{construct(t,e,i){return new Ke(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new oe(j.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new Ke(e)}static emptyPath(){return new Ke([])}}const Jp=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class At extends yi{construct(t,e,i){return new At(t,e,i)}static isValidIdentifier(t){return Jp.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),At.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===xl}static keyField(){return new At([xl])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new oe(j.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new oe(j.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const c=t[n+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new oe(j.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=c,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new oe(j.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new At(e)}static emptyPath(){return new At([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class me{constructor(t){this.path=t}static fromPath(t){return new me(Ke.fromString(t))}static fromName(t){return new me(Ke.fromString(t).popFirst(5))}static empty(){return new me(Ke.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Ke.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Ke.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new me(new Ke(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Qc(s,t,e){if(!e)throw new oe(j.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function $p(s,t,e,i){if(t===!0&&i===!0)throw new oe(j.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function El(s){if(!me.isDocumentKey(s))throw new oe(j.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function bl(s){if(me.isDocumentKey(s))throw new oe(j.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function Jc(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function Ms(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":Te(12329,{type:typeof s})}function Wi(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new oe(j.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=Ms(s);throw new oe(j.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gt(s,t){const e={typeString:s};return t&&(e.value=t),e}function Ir(s,t){if(!Jc(s))throw new oe(j.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new oe(j.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Sl=-62135596800,Pl=1e6;class $e{static now(){return $e.fromMillis(Date.now())}static fromDate(t){return $e.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*Pl);return new $e(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new oe(j.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new oe(j.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<Sl)throw new oe(j.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new oe(j.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Pl}_compareTo(t){return this.seconds===t.seconds?Ae(this.nanoseconds,t.nanoseconds):Ae(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:$e._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(Ir(t,$e._jsonSchema))return new $e(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-Sl;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}$e._jsonSchemaVersion="firestore/timestamp/1.0",$e._jsonSchema={type:gt("string",$e._jsonSchemaVersion),seconds:gt("number"),nanoseconds:gt("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xe{static fromTimestamp(t){return new xe(t)}static min(){return new xe(new $e(0,0))}static max(){return new xe(new $e(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tr=-1;function em(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=xe.fromTimestamp(i===1e9?new $e(e+1,0):new $e(e,i));return new Zi(n,me.empty(),t)}function tm(s){return new Zi(s.readTime,s.key,Tr)}class Zi{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new Zi(xe.min(),me.empty(),Tr)}static max(){return new Zi(xe.max(),me.empty(),Tr)}}function im(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=me.comparator(s.documentKey,t.documentKey),e!==0?e:Ae(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nm="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class rm{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Gn(s){if(s.code!==j.FAILED_PRECONDITION||s.message!==nm)throw s;le("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class W{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Te(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new W((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof W?e:W.resolve(e)}catch(e){return W.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):W.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):W.reject(e)}static resolve(t){return new W((e,i)=>{e(t)})}static reject(t){return new W((e,i)=>{i(t)})}static waitFor(t){return new W((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},c=>i(c))}),o=!0,r===n&&e()})}static or(t){let e=W.resolve(!1);for(const i of t)e=e.next(n=>n?W.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new W((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let c=0;c<r;c++){const h=c;e(t[h]).next(d=>{o[h]=d,++a,a===r&&i(o)},d=>n(d))}})}static doWhile(t,e){return new W((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function sm(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function Zn(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ks{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}ks.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zo=-1;function Os(s){return s==null}function _s(s){return s===0&&1/s==-1/0}function om(s){return typeof s=="number"&&Number.isInteger(s)&&!_s(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $c="";function am(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=Cl(t)),t=lm(s.get(e),t);return Cl(t)}function lm(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case $c:e+="";break;default:e+=r}}return e}function Cl(s){return s+$c+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Al(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function en(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function eh(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nt{constructor(t,e){this.comparator=t,this.root=e||Ct.EMPTY}insert(t,e){return new nt(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ct.BLACK,null,null))}remove(t){return new nt(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ct.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Jr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Jr(this.root,t,this.comparator,!1)}getReverseIterator(){return new Jr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Jr(this.root,t,this.comparator,!0)}}class Jr{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Ct{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??Ct.RED,this.left=n??Ct.EMPTY,this.right=r??Ct.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new Ct(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return Ct.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return Ct.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Ct.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Ct.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Te(43730,{key:this.key,value:this.value});if(this.right.isRed())throw Te(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw Te(27949);return t+(this.isRed()?0:1)}}Ct.EMPTY=null,Ct.RED=!0,Ct.BLACK=!1;Ct.EMPTY=new class{constructor(){this.size=0}get key(){throw Te(57766)}get value(){throw Te(16141)}get color(){throw Te(16727)}get left(){throw Te(29726)}get right(){throw Te(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new Ct(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wt{constructor(t){this.comparator=t,this.data=new nt(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Rl(this.data.getIterator())}getIteratorFrom(t){return new Rl(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof wt)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new wt(this.comparator);return e.data=t,e}}class Rl{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kt{constructor(t){this.fields=t,t.sort(At.comparator)}static empty(){return new Kt([])}unionWith(t){let e=new wt(At.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new Kt(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Vn(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class th extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rt{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new th("Invalid base64 string: "+r):r}}(t);return new Rt(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new Rt(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Ae(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Rt.EMPTY_BYTE_STRING=new Rt("");const cm=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Xi(s){if(je(!!s,39018),typeof s=="string"){let t=0;const e=cm.exec(s);if(je(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:lt(s.seconds),nanos:lt(s.nanos)}}function lt(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function Yi(s){return typeof s=="string"?Rt.fromBase64String(s):Rt.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ih="server_timestamp",nh="__type__",rh="__previous_value__",sh="__local_write_time__";function Xo(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[nh])===null||e===void 0?void 0:e.stringValue)===ih}function Fs(s){const t=s.mapValue.fields[rh];return Xo(t)?Fs(t):t}function xr(s){const t=Xi(s.mapValue.fields[sh].timestampValue);return new $e(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hm{constructor(t,e,i,n,r,o,a,c,h,d){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=c,this.useFetchStreams=h,this.isUsingEmulator=d}}const Ts="(default)";class Er{constructor(t,e){this.projectId=t,this.database=e||Ts}static empty(){return new Er("","")}get isDefaultDatabase(){return this.database===Ts}isEqual(t){return t instanceof Er&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oh="__type__",um="__max__",$r={mapValue:{}},ah="__vector__",xs="value";function Ki(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?Xo(s)?4:fm(s)?9007199254740991:dm(s)?10:11:Te(28295,{value:s})}function bi(s,t){if(s===t)return!0;const e=Ki(s);if(e!==Ki(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return xr(s).isEqual(xr(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=Xi(n.timestampValue),a=Xi(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return Yi(n.bytesValue).isEqual(Yi(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return lt(n.geoPointValue.latitude)===lt(r.geoPointValue.latitude)&&lt(n.geoPointValue.longitude)===lt(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return lt(n.integerValue)===lt(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=lt(n.doubleValue),a=lt(r.doubleValue);return o===a?_s(o)===_s(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return Vn(s.arrayValue.values||[],t.arrayValue.values||[],bi);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(Al(o)!==Al(a))return!1;for(const c in o)if(o.hasOwnProperty(c)&&(a[c]===void 0||!bi(o[c],a[c])))return!1;return!0}(s,t);default:return Te(52216,{left:s})}}function br(s,t){return(s.values||[]).find(e=>bi(e,t))!==void 0}function Bn(s,t){if(s===t)return 0;const e=Ki(s),i=Ki(t);if(e!==i)return Ae(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return Ae(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=lt(r.integerValue||r.doubleValue),c=lt(o.integerValue||o.doubleValue);return a<c?-1:a>c?1:a===c?0:isNaN(a)?isNaN(c)?0:-1:1}(s,t);case 3:return Il(s.timestampValue,t.timestampValue);case 4:return Il(xr(s),xr(t));case 5:return xo(s.stringValue,t.stringValue);case 6:return function(r,o){const a=Yi(r),c=Yi(o);return a.compareTo(c)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),c=o.split("/");for(let h=0;h<a.length&&h<c.length;h++){const d=Ae(a[h],c[h]);if(d!==0)return d}return Ae(a.length,c.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=Ae(lt(r.latitude),lt(o.latitude));return a!==0?a:Ae(lt(r.longitude),lt(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return Dl(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,c,h,d;const l=r.fields||{},f=o.fields||{},p=(a=l[xs])===null||a===void 0?void 0:a.arrayValue,g=(c=f[xs])===null||c===void 0?void 0:c.arrayValue,v=Ae(((h=p==null?void 0:p.values)===null||h===void 0?void 0:h.length)||0,((d=g==null?void 0:g.values)===null||d===void 0?void 0:d.length)||0);return v!==0?v:Dl(p,g)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===$r.mapValue&&o===$r.mapValue)return 0;if(r===$r.mapValue)return 1;if(o===$r.mapValue)return-1;const a=r.fields||{},c=Object.keys(a),h=o.fields||{},d=Object.keys(h);c.sort(),d.sort();for(let l=0;l<c.length&&l<d.length;++l){const f=xo(c[l],d[l]);if(f!==0)return f;const p=Bn(a[c[l]],h[d[l]]);if(p!==0)return p}return Ae(c.length,d.length)}(s.mapValue,t.mapValue);default:throw Te(23264,{le:e})}}function Il(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return Ae(s,t);const e=Xi(s),i=Xi(t),n=Ae(e.seconds,i.seconds);return n!==0?n:Ae(e.nanos,i.nanos)}function Dl(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=Bn(e[n],i[n]);if(r)return r}return Ae(e.length,i.length)}function zn(s){return Eo(s)}function Eo(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=Xi(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return Yi(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return me.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=Eo(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${Eo(e.fields[o])}`;return n+"}"}(s.mapValue):Te(61005,{value:s})}function os(s){switch(Ki(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=Fs(s);return t?16+os(t):16;case 5:return 2*s.stringValue.length;case 6:return Yi(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+os(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return en(i.fields,(r,o)=>{n+=r.length+os(o)}),n}(s.mapValue);default:throw Te(13486,{value:s})}}function Ml(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function bo(s){return!!s&&"integerValue"in s}function Yo(s){return!!s&&"arrayValue"in s}function kl(s){return!!s&&"nullValue"in s}function Ol(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function as(s){return!!s&&"mapValue"in s}function dm(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[oh])===null||e===void 0?void 0:e.stringValue)===ah}function pr(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return en(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=pr(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=pr(s.arrayValue.values[e]);return t}return Object.assign({},s)}function fm(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===um}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zt{constructor(t){this.value=t}static empty(){return new Zt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!as(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=pr(e)}setAll(t){let e=At.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const c=this.getFieldsMap(e);this.applyChanges(c,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=pr(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());as(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return bi(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];as(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){en(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Zt(pr(this.value))}}function lh(s){const t=[];return en(s.fields,(e,i)=>{const n=new At([e]);if(as(i)){const r=lh(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new Kt(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zt{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new zt(t,0,xe.min(),xe.min(),xe.min(),Zt.empty(),0)}static newFoundDocument(t,e,i,n){return new zt(t,1,e,xe.min(),i,n,0)}static newNoDocument(t,e){return new zt(t,2,e,xe.min(),xe.min(),Zt.empty(),0)}static newUnknownDocument(t,e){return new zt(t,3,e,xe.min(),xe.min(),Zt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(xe.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Zt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Zt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=xe.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof zt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new zt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Es{constructor(t,e){this.position=t,this.inclusive=e}}function Fl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=me.comparator(me.fromName(o.referenceValue),e.key):i=Bn(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function Ll(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!bi(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sr{constructor(t,e="asc"){this.field=t,this.dir=e}}function pm(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ch{}class mt extends ch{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new gm(t,e,i):e==="array-contains"?new wm(t,i):e==="in"?new _m(t,i):e==="not-in"?new Tm(t,i):e==="array-contains-any"?new xm(t,i):new mt(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new vm(t,i):new ym(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(Bn(e,this.value)):e!==null&&Ki(this.value)===Ki(e)&&this.matchesComparison(Bn(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return Te(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class ci extends ch{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new ci(t,e)}matches(t){return hh(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function hh(s){return s.op==="and"}function uh(s){return mm(s)&&hh(s)}function mm(s){for(const t of s.filters)if(t instanceof ci)return!1;return!0}function So(s){if(s instanceof mt)return s.field.canonicalString()+s.op.toString()+zn(s.value);if(uh(s))return s.filters.map(t=>So(t)).join(",");{const t=s.filters.map(e=>So(e)).join(",");return`${s.op}(${t})`}}function dh(s,t){return s instanceof mt?function(i,n){return n instanceof mt&&i.op===n.op&&i.field.isEqual(n.field)&&bi(i.value,n.value)}(s,t):s instanceof ci?function(i,n){return n instanceof ci&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&dh(o,n.filters[a]),!0):!1}(s,t):void Te(19439)}function fh(s){return s instanceof mt?function(e){return`${e.field.canonicalString()} ${e.op} ${zn(e.value)}`}(s):s instanceof ci?function(e){return e.op.toString()+" {"+e.getFilters().map(fh).join(" ,")+"}"}(s):"Filter"}class gm extends mt{constructor(t,e,i){super(t,e,i),this.key=me.fromName(i.referenceValue)}matches(t){const e=me.comparator(t.key,this.key);return this.matchesComparison(e)}}class vm extends mt{constructor(t,e){super(t,"in",e),this.keys=ph("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class ym extends mt{constructor(t,e){super(t,"not-in",e),this.keys=ph("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function ph(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>me.fromName(i.referenceValue))}class wm extends mt{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Yo(e)&&br(e.arrayValue,this.value)}}class _m extends mt{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&br(this.value.arrayValue,e)}}class Tm extends mt{constructor(t,e){super(t,"not-in",e)}matches(t){if(br(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!br(this.value.arrayValue,e)}}class xm extends mt{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Yo(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>br(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Em{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function Vl(s,t=null,e=[],i=[],n=null,r=null,o=null){return new Em(s,t,e,i,n,r,o)}function Ko(s){const t=Se(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>So(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),Os(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>zn(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>zn(i)).join(",")),t.Pe=e}return t.Pe}function Qo(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!pm(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!dh(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!Ll(s.startAt,t.startAt)&&Ll(s.endAt,t.endAt)}function Po(s){return me.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xn{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=c,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function bm(s,t,e,i,n,r,o,a){return new Xn(s,t,e,i,n,r,o,a)}function Jo(s){return new Xn(s)}function Bl(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function mh(s){return s.collectionGroup!==null}function mr(s){const t=Se(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new wt(At.comparator);return o.filters.forEach(c=>{c.getFlattenedFilters().forEach(h=>{h.isInequality()&&(a=a.add(h.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new Sr(r,i))}),e.has(At.keyField().canonicalString())||t.Te.push(new Sr(At.keyField(),i))}return t.Te}function wi(s){const t=Se(s);return t.Ie||(t.Ie=Sm(t,mr(s))),t.Ie}function Sm(s,t){if(s.limitType==="F")return Vl(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new Sr(n.field,r)});const e=s.endAt?new Es(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new Es(s.startAt.position,s.startAt.inclusive):null;return Vl(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function Co(s,t){const e=s.filters.concat([t]);return new Xn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function Ao(s,t,e){return new Xn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function Ls(s,t){return Qo(wi(s),wi(t))&&s.limitType===t.limitType}function gh(s){return`${Ko(wi(s))}|lt:${s.limitType}`}function Rn(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>fh(n)).join(", ")}]`),Os(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>zn(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>zn(n)).join(",")),`Target(${i})`}(wi(s))}; limitType=${s.limitType})`}function Vs(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):me.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of mr(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,c){const h=Fl(o,a,c);return o.inclusive?h<=0:h<0}(i.startAt,mr(i),n)||i.endAt&&!function(o,a,c){const h=Fl(o,a,c);return o.inclusive?h>=0:h>0}(i.endAt,mr(i),n))}(s,t)}function Pm(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function vh(s){return(t,e)=>{let i=!1;for(const n of mr(s)){const r=Cm(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function Cm(s,t,e){const i=s.field.isKeyField()?me.comparator(t.key,e.key):function(r,o,a){const c=o.data.field(r),h=a.data.field(r);return c!==null&&h!==null?Bn(c,h):Te(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return Te(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gn{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){en(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return eh(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Am=new nt(me.comparator);function Fi(){return Am}const yh=new nt(me.comparator);function cr(...s){let t=yh;for(const e of s)t=t.insert(e.key,e);return t}function wh(s){let t=yh;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function un(){return gr()}function _h(){return gr()}function gr(){return new gn(s=>s.toString(),(s,t)=>s.isEqual(t))}const Rm=new nt(me.comparator),Im=new wt(me.comparator);function Le(...s){let t=Im;for(const e of s)t=t.add(e);return t}const Dm=new wt(Ae);function Mm(){return Dm}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $o(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:_s(t)?"-0":t}}function Th(s){return{integerValue:""+s}}function km(s,t){return om(t)?Th(t):$o(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bs{constructor(){this._=void 0}}function Om(s,t,e){return s instanceof bs?function(n,r){const o={fields:{[nh]:{stringValue:ih},[sh]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&Xo(r)&&(r=Fs(r)),r&&(o.fields[rh]=r),{mapValue:o}}(e,t):s instanceof Pr?Eh(s,t):s instanceof Cr?bh(s,t):function(n,r){const o=xh(n,r),a=zl(o)+zl(n.Ee);return bo(o)&&bo(n.Ee)?Th(a):$o(n.serializer,a)}(s,t)}function Fm(s,t,e){return s instanceof Pr?Eh(s,t):s instanceof Cr?bh(s,t):e}function xh(s,t){return s instanceof Ss?function(i){return bo(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class bs extends Bs{}class Pr extends Bs{constructor(t){super(),this.elements=t}}function Eh(s,t){const e=Sh(t);for(const i of s.elements)e.some(n=>bi(n,i))||e.push(i);return{arrayValue:{values:e}}}class Cr extends Bs{constructor(t){super(),this.elements=t}}function bh(s,t){let e=Sh(t);for(const i of s.elements)e=e.filter(n=>!bi(n,i));return{arrayValue:{values:e}}}class Ss extends Bs{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function zl(s){return lt(s.integerValue||s.doubleValue)}function Sh(s){return Yo(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function Lm(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof Pr&&n instanceof Pr||i instanceof Cr&&n instanceof Cr?Vn(i.elements,n.elements,bi):i instanceof Ss&&n instanceof Ss?bi(i.Ee,n.Ee):i instanceof bs&&n instanceof bs}(s.transform,t.transform)}class Vm{constructor(t,e){this.version=t,this.transformResults=e}}class li{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new li}static exists(t){return new li(void 0,t)}static updateTime(t){return new li(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function ls(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class zs{}function Ph(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new ea(s.key,li.none()):new Dr(s.key,s.data,li.none());{const e=s.data,i=Zt.empty();let n=new wt(At.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new tn(s.key,i,new Kt(n.toArray()),li.none())}}function Bm(s,t,e){s instanceof Dr?function(n,r,o){const a=n.value.clone(),c=Nl(n.fieldTransforms,r,o.transformResults);a.setAll(c),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof tn?function(n,r,o){if(!ls(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=Nl(n.fieldTransforms,r,o.transformResults),c=r.data;c.setAll(Ch(n)),c.setAll(a),r.convertToFoundDocument(o.version,c).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function vr(s,t,e,i){return s instanceof Dr?function(r,o,a,c){if(!ls(r.precondition,o))return a;const h=r.value.clone(),d=Ul(r.fieldTransforms,c,o);return h.setAll(d),o.convertToFoundDocument(o.version,h).setHasLocalMutations(),null}(s,t,e,i):s instanceof tn?function(r,o,a,c){if(!ls(r.precondition,o))return a;const h=Ul(r.fieldTransforms,c,o),d=o.data;return d.setAll(Ch(r)),d.setAll(h),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(l=>l.field))}(s,t,e,i):function(r,o,a){return ls(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function zm(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=xh(i.transform,n||null);r!=null&&(e===null&&(e=Zt.empty()),e.set(i.field,r))}return e||null}function Hl(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&Vn(i,n,(r,o)=>Lm(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class Dr extends zs{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class tn extends zs{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Ch(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function Nl(s,t,e){const i=new Map;je(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,Fm(o,a,e[n]))}return i}function Ul(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,Om(r,o,t))}return i}class ea extends zs{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Hm extends zs{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nm{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&Bm(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=vr(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=vr(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=_h();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const c=Ph(o,a);c!==null&&i.set(n.key,c),o.isValidDocument()||o.convertToNoDocument(xe.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Le())}isEqual(t){return this.batchId===t.batchId&&Vn(this.mutations,t.mutations,(e,i)=>Hl(e,i))&&Vn(this.baseMutations,t.baseMutations,(e,i)=>Hl(e,i))}}class ta{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){je(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return Rm}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new ta(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Um{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jm{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ft,Ve;function Wm(s){switch(s){case j.OK:return Te(64938);case j.CANCELLED:case j.UNKNOWN:case j.DEADLINE_EXCEEDED:case j.RESOURCE_EXHAUSTED:case j.INTERNAL:case j.UNAVAILABLE:case j.UNAUTHENTICATED:return!1;case j.INVALID_ARGUMENT:case j.NOT_FOUND:case j.ALREADY_EXISTS:case j.PERMISSION_DENIED:case j.FAILED_PRECONDITION:case j.ABORTED:case j.OUT_OF_RANGE:case j.UNIMPLEMENTED:case j.DATA_LOSS:return!0;default:return Te(15467,{code:s})}}function Ah(s){if(s===void 0)return Oi("GRPC error has no .code"),j.UNKNOWN;switch(s){case ft.OK:return j.OK;case ft.CANCELLED:return j.CANCELLED;case ft.UNKNOWN:return j.UNKNOWN;case ft.DEADLINE_EXCEEDED:return j.DEADLINE_EXCEEDED;case ft.RESOURCE_EXHAUSTED:return j.RESOURCE_EXHAUSTED;case ft.INTERNAL:return j.INTERNAL;case ft.UNAVAILABLE:return j.UNAVAILABLE;case ft.UNAUTHENTICATED:return j.UNAUTHENTICATED;case ft.INVALID_ARGUMENT:return j.INVALID_ARGUMENT;case ft.NOT_FOUND:return j.NOT_FOUND;case ft.ALREADY_EXISTS:return j.ALREADY_EXISTS;case ft.PERMISSION_DENIED:return j.PERMISSION_DENIED;case ft.FAILED_PRECONDITION:return j.FAILED_PRECONDITION;case ft.ABORTED:return j.ABORTED;case ft.OUT_OF_RANGE:return j.OUT_OF_RANGE;case ft.UNIMPLEMENTED:return j.UNIMPLEMENTED;case ft.DATA_LOSS:return j.DATA_LOSS;default:return Te(39323,{code:s})}}(Ve=ft||(ft={}))[Ve.OK=0]="OK",Ve[Ve.CANCELLED=1]="CANCELLED",Ve[Ve.UNKNOWN=2]="UNKNOWN",Ve[Ve.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ve[Ve.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ve[Ve.NOT_FOUND=5]="NOT_FOUND",Ve[Ve.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ve[Ve.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ve[Ve.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ve[Ve.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ve[Ve.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ve[Ve.ABORTED=10]="ABORTED",Ve[Ve.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ve[Ve.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ve[Ve.INTERNAL=13]="INTERNAL",Ve[Ve.UNAVAILABLE=14]="UNAVAILABLE",Ve[Ve.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const qm=new ji([4294967295,4294967295],0);function jl(s){const t=Kc().encode(s),e=new Uc;return e.update(t),new Uint8Array(e.digest())}function Wl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new ji([e,i],0),new ji([n,r],0)]}class ia{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new hr(`Invalid padding: ${e}`);if(i<0)throw new hr(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new hr(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new hr(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=ji.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(ji.fromNumber(i)));return n.compare(qm)===1&&(n=new ji([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=jl(t),[i,n]=Wl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new ia(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=jl(t),[i,n]=Wl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class hr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hs{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,Mr.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new Hs(xe.min(),n,new nt(Ae),Fi(),Le())}}class Mr{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new Mr(i,e,Le(),Le(),Le())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cs{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class Rh{constructor(t,e){this.targetId=t,this.De=e}}class Ih{constructor(t,e,i=Rt.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class ql{constructor(){this.ve=0,this.Ce=Gl(),this.Fe=Rt.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Le(),e=Le(),i=Le();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:Te(38017,{changeType:r})}}),new Mr(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Gl()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,je(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class Gm{constructor(t){this.We=t,this.Ge=new Map,this.ze=Fi(),this.je=es(),this.Je=es(),this.He=new nt(Ae)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:Te(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(Po(r))if(i===0){const o=new me(r.path);this.Xe(e,o,zt.newNoDocument(o,xe.min()))}else je(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),c=a?this.ut(a,t,o):1;if(c!==0){this.rt(e);const h=c===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,h)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=Yi(i).toUint8Array()}catch(c){if(c instanceof th)return Gi("Decoding the base64 bloom filter in existence filter failed ("+c.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw c}try{a=new ia(o,n,r)}catch(c){return Gi(c instanceof hr?"BloomFilter error: ":"Applying bloom filter failed: ",c),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&Po(a.target)){const c=new me(a.target.path);this.Tt(c).has(o)||this.It(o,c)||this.Xe(o,c,zt.newNoDocument(c,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Le();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(c=>{const h=this.st(c);return!h||h.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new Hs(t,e,this.He,this.ze,i);return this.ze=Fi(),this.je=es(),this.Je=es(),this.He=new nt(Ae),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new ql,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new wt(Ae),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new wt(Ae),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||le("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new ql),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function es(){return new nt(me.comparator)}function Gl(){return new nt(me.comparator)}const Zm={asc:"ASCENDING",desc:"DESCENDING"},Xm={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Ym={and:"AND",or:"OR"};class Km{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Ro(s,t){return s.useProto3Json||Os(t)?t:{value:t}}function Ps(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Dh(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function Qm(s,t){return Ps(s,t.toTimestamp())}function _i(s){return je(!!s,49232),xe.fromTimestamp(function(e){const i=Xi(e);return new $e(i.seconds,i.nanos)}(s))}function na(s,t){return Io(s,t).canonicalString()}function Io(s,t){const e=function(n){return new Ke(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function Mh(s){const t=Ke.fromString(s);return je(Vh(t),10190,{key:t.toString()}),t}function Do(s,t){return na(s.databaseId,t.path)}function ho(s,t){const e=Mh(t);if(e.get(1)!==s.databaseId.projectId)throw new oe(j.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new oe(j.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new me(Oh(e))}function kh(s,t){return na(s.databaseId,t)}function Jm(s){const t=Mh(s);return t.length===4?Ke.emptyPath():Oh(t)}function Mo(s){return new Ke(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function Oh(s){return je(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Zl(s,t,e){return{name:Do(s,t),fields:e.value.mapValue.fields}}function $m(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(h){return h==="NO_CHANGE"?0:h==="ADD"?1:h==="REMOVE"?2:h==="CURRENT"?3:h==="RESET"?4:Te(39313,{state:h})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(h,d){return h.useProto3Json?(je(d===void 0||typeof d=="string",58123),Rt.fromBase64String(d||"")):(je(d===void 0||d instanceof Buffer||d instanceof Uint8Array,16193),Rt.fromUint8Array(d||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(h){const d=h.code===void 0?j.UNKNOWN:Ah(h.code);return new oe(d,h.message||"")}(o);e=new Ih(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=ho(s,i.document.name),r=_i(i.document.updateTime),o=i.document.createTime?_i(i.document.createTime):xe.min(),a=new Zt({mapValue:{fields:i.document.fields}}),c=zt.newFoundDocument(n,r,o,a),h=i.targetIds||[],d=i.removedTargetIds||[];e=new cs(h,d,c.key,c)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=ho(s,i.document),r=i.readTime?_i(i.readTime):xe.min(),o=zt.newNoDocument(n,r),a=i.removedTargetIds||[];e=new cs([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=ho(s,i.document),r=i.removedTargetIds||[];e=new cs([],r,n,null)}else{if(!("filter"in t))return Te(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new jm(n,r),a=i.targetId;e=new Rh(a,o)}}return e}function eg(s,t){let e;if(t instanceof Dr)e={update:Zl(s,t.key,t.value)};else if(t instanceof ea)e={delete:Do(s,t.key)};else if(t instanceof tn)e={update:Zl(s,t.key,t.data),updateMask:cg(t.fieldMask)};else{if(!(t instanceof Hm))return Te(16599,{Rt:t.type});e={verify:Do(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof bs)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof Pr)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Cr)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof Ss)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw Te(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:Qm(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:Te(27497)}(s,t.precondition)),e}function tg(s,t){return s&&s.length>0?(je(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?_i(n.updateTime):_i(r);return o.isEqual(xe.min())&&(o=_i(r)),new Vm(o,n.transformResults||[])}(e,t))):[]}function ig(s,t){return{documents:[kh(s,t.path)]}}function ng(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=kh(s,n);const r=function(h){if(h.length!==0)return Lh(ci.create(h,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(h){if(h.length!==0)return h.map(d=>function(f){return{field:In(f.field),direction:og(f.dir)}}(d))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=Ro(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(h){return{before:h.inclusive,values:h.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(h){return{before:!h.inclusive,values:h.position}}(t.endAt)),{Vt:e,parent:n}}function rg(s){let t=Jm(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){je(i===1,65062);const d=e.from[0];d.allDescendants?n=d.collectionId:t=t.child(d.collectionId)}let r=[];e.where&&(r=function(l){const f=Fh(l);return f instanceof ci&&uh(f)?f.getFilters():[f]}(e.where));let o=[];e.orderBy&&(o=function(l){return l.map(f=>function(g){return new Sr(Dn(g.field),function(w){switch(w){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(g.direction))}(f))}(e.orderBy));let a=null;e.limit&&(a=function(l){let f;return f=typeof l=="object"?l.value:l,Os(f)?null:f}(e.limit));let c=null;e.startAt&&(c=function(l){const f=!!l.before,p=l.values||[];return new Es(p,f)}(e.startAt));let h=null;return e.endAt&&(h=function(l){const f=!l.before,p=l.values||[];return new Es(p,f)}(e.endAt)),bm(t,n,o,r,a,"F",c,h)}function sg(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Te(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Fh(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=Dn(e.unaryFilter.field);return mt.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=Dn(e.unaryFilter.field);return mt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Dn(e.unaryFilter.field);return mt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Dn(e.unaryFilter.field);return mt.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return Te(61313);default:return Te(60726)}}(s):s.fieldFilter!==void 0?function(e){return mt.create(Dn(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return Te(58110);default:return Te(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return ci.create(e.compositeFilter.filters.map(i=>Fh(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return Te(1026)}}(e.compositeFilter.op))}(s):Te(30097,{filter:s})}function og(s){return Zm[s]}function ag(s){return Xm[s]}function lg(s){return Ym[s]}function In(s){return{fieldPath:s.canonicalString()}}function Dn(s){return At.fromServerFormat(s.fieldPath)}function Lh(s){return s instanceof mt?function(e){if(e.op==="=="){if(Ol(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NAN"}};if(kl(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Ol(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NOT_NAN"}};if(kl(e.value))return{unaryFilter:{field:In(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:In(e.field),op:ag(e.op),value:e.value}}}(s):s instanceof ci?function(e){const i=e.getFilters().map(n=>Lh(n));return i.length===1?i[0]:{compositeFilter:{op:lg(e.op),filters:i}}}(s):Te(54877,{filter:s})}function cg(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Vh(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hi{constructor(t,e,i,n,r=xe.min(),o=xe.min(),a=Rt.EMPTY_BYTE_STRING,c=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=c}withSequenceNumber(t){return new Hi(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new Hi(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new Hi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new Hi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hg{constructor(t){this.gt=t}}function ug(s){const t=rg({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?Ao(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dg{constructor(){this.Dn=new fg}addToCollectionParentIndex(t,e){return this.Dn.add(e),W.resolve()}getCollectionParents(t,e){return W.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return W.resolve()}deleteFieldIndex(t,e){return W.resolve()}deleteAllFieldIndexes(t){return W.resolve()}createTargetIndexes(t,e){return W.resolve()}getDocumentsMatchingTarget(t,e){return W.resolve(null)}getIndexType(t,e){return W.resolve(0)}getFieldIndexes(t,e){return W.resolve([])}getNextCollectionGroupToUpdate(t){return W.resolve(null)}getMinOffset(t,e){return W.resolve(Zi.min())}getMinOffsetFromCollectionGroup(t,e){return W.resolve(Zi.min())}updateCollectionGroup(t,e,i){return W.resolve()}updateIndexEntries(t,e){return W.resolve()}}class fg{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new wt(Ke.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new wt(Ke.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Xl={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Bh=41943040;class qt{static withCacheSize(t){return new qt(t,qt.DEFAULT_COLLECTION_PERCENTILE,qt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */qt.DEFAULT_COLLECTION_PERCENTILE=10,qt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,qt.DEFAULT=new qt(Bh,qt.DEFAULT_COLLECTION_PERCENTILE,qt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),qt.DISABLED=new qt(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hn{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new Hn(0)}static ur(){return new Hn(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yl="LruGarbageCollector",pg=1048576;function Kl([s,t],[e,i]){const n=Ae(s,e);return n===0?Ae(t,i):n}class mg{constructor(t){this.Tr=t,this.buffer=new wt(Kl),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();Kl(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class gg{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){le(Yl,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Zn(e)?le(Yl,"Ignoring IndexedDB error during garbage collection: ",e):await Gn(e)}await this.Rr(3e5)})}}class vg{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return W.resolve(ks.ue);const i=new mg(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(le("LruGarbageCollector","Garbage collection skipped; disabled"),W.resolve(Xl)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(le("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Xl):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,c,h;const d=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(l=>(l>this.params.maximumSequenceNumbersToCollect?(le("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${l}`),n=this.params.maximumSequenceNumbersToCollect):n=l,o=Date.now(),this.nthSequenceNumber(t,n))).next(l=>(i=l,a=Date.now(),this.removeTargets(t,i,e))).next(l=>(r=l,c=Date.now(),this.removeOrphanedDocuments(t,i))).next(l=>(h=Date.now(),An()<=Be.DEBUG&&le("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(c-a)+`ms
	Removed ${l} documents in `+(h-c)+`ms
Total Duration: ${h-d}ms`),W.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:l})))}}function yg(s,t){return new vg(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wg{constructor(){this.changes=new gn(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,zt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?W.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _g{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tg{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&vr(i.mutation,n,Kt.empty(),$e.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Le()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Le()){const n=un();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=cr();return r.forEach((a,c)=>{o=o.insert(a,c.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=un();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Le()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=Fi();const o=gr(),a=function(){return gr()}();return e.forEach((c,h)=>{const d=i.get(h.key);n.has(h.key)&&(d===void 0||d.mutation instanceof tn)?r=r.insert(h.key,h):d!==void 0?(o.set(h.key,d.mutation.getFieldMask()),vr(d.mutation,h,d.mutation.getFieldMask(),$e.now())):o.set(h.key,Kt.empty())}),this.recalculateAndSaveOverlays(t,r).next(c=>(c.forEach((h,d)=>o.set(h,d)),e.forEach((h,d)=>{var l;return a.set(h,new _g(d,(l=o.get(h))!==null&&l!==void 0?l:null))}),a))}recalculateAndSaveOverlays(t,e){const i=gr();let n=new nt((o,a)=>o-a),r=Le();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(c=>{const h=e.get(c);if(h===null)return;let d=i.get(c)||Kt.empty();d=a.applyToLocalView(h,d),i.set(c,d);const l=(n.get(a.batchId)||Le()).add(c);n=n.insert(a.batchId,l)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const c=a.getNext(),h=c.key,d=c.value,l=_h();d.forEach(f=>{if(!r.has(f)){const p=Ph(e.get(f),i.get(f));p!==null&&l.set(f,p),r=r.add(f)}}),o.push(this.documentOverlayCache.saveOverlays(t,h,l))}return W.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return me.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):mh(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):W.resolve(un());let a=Tr,c=r;return o.next(h=>W.forEach(h,(d,l)=>(a<l.largestBatchId&&(a=l.largestBatchId),r.get(d)?W.resolve():this.remoteDocumentCache.getEntry(t,d).next(f=>{c=c.insert(d,f)}))).next(()=>this.populateOverlays(t,h,r)).next(()=>this.computeViews(t,c,h,Le())).next(d=>({batchId:a,changes:wh(d)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new me(e)).next(i=>{let n=cr();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=cr();return this.indexManager.getCollectionParents(t,r).next(a=>W.forEach(a,c=>{const h=function(l,f){return new Xn(f,null,l.explicitOrderBy.slice(),l.filters.slice(),l.limit,l.limitType,l.startAt,l.endAt)}(e,c.child(r));return this.getDocumentsMatchingCollectionQuery(t,h,i,n).next(d=>{d.forEach((l,f)=>{o=o.insert(l,f)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((c,h)=>{const d=h.getKey();o.get(d)===null&&(o=o.insert(d,zt.newInvalidDocument(d)))});let a=cr();return o.forEach((c,h)=>{const d=r.get(c);d!==void 0&&vr(d.mutation,h,Kt.empty(),$e.now()),Vs(e,h)&&(a=a.insert(c,h))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xg{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return W.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:_i(n.createTime)}}(e)),W.resolve()}getNamedQuery(t,e){return W.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:ug(n.bundledQuery),readTime:_i(n.readTime)}}(e)),W.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Eg{constructor(){this.overlays=new nt(me.comparator),this.kr=new Map}getOverlay(t,e){return W.resolve(this.overlays.get(e))}getOverlays(t,e){const i=un();return W.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),W.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),W.resolve()}getOverlaysForCollection(t,e,i){const n=un(),r=e.length+1,o=new me(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const c=a.getNext().value,h=c.getKey();if(!e.isPrefixOf(h.path))break;h.path.length===r&&c.largestBatchId>i&&n.set(c.getKey(),c)}return W.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new nt((h,d)=>h-d);const o=this.overlays.getIterator();for(;o.hasNext();){const h=o.getNext().value;if(h.getKey().getCollectionGroup()===e&&h.largestBatchId>i){let d=r.get(h.largestBatchId);d===null&&(d=un(),r=r.insert(h.largestBatchId,d)),d.set(h.getKey(),h)}}const a=un(),c=r.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((h,d)=>a.set(h,d)),!(a.size()>=n)););return W.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new Um(e,i));let r=this.kr.get(e);r===void 0&&(r=Le(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bg{constructor(){this.sessionToken=Rt.EMPTY_BYTE_STRING}getSessionToken(t){return W.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,W.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ra{constructor(){this.qr=new wt(xt.Qr),this.$r=new wt(xt.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new xt(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new xt(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new me(new Ke([])),i=new xt(e,t),n=new xt(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new me(new Ke([])),i=new xt(e,t),n=new xt(e,t+1);let r=Le();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new xt(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class xt{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return me.comparator(t.key,e.key)||Ae(t.Hr,e.Hr)}static Ur(t,e){return Ae(t.Hr,e.Hr)||me.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sg{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new wt(xt.Qr)}checkEmpty(t){return W.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new Nm(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new xt(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return W.resolve(o)}lookupMutationBatch(t,e){return W.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return W.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return W.resolve(this.mutationQueue.length===0?Zo:this.er-1)}getAllMutationBatches(t){return W.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new xt(e,0),n=new xt(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),W.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new wt(Ae);return e.forEach(n=>{const r=new xt(n,0),o=new xt(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),W.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;me.isDocumentKey(r)||(r=r.child(""));const o=new xt(new me(r),0);let a=new wt(Ae);return this.Yr.forEachWhile(c=>{const h=c.key.path;return!!i.isPrefixOf(h)&&(h.length===n&&(a=a.add(c.Hr)),!0)},o),W.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){je(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return W.forEach(e.mutations,n=>{const r=new xt(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new xt(e,0),n=this.Yr.firstAfterOrEqual(i);return W.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,W.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pg{constructor(t){this.ni=t,this.docs=function(){return new nt(me.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return W.resolve(i?i.document.mutableCopy():zt.newInvalidDocument(e))}getEntries(t,e){let i=Fi();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():zt.newInvalidDocument(n))}),W.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=Fi();const o=e.path,a=new me(o.child("__id-9223372036854775808__")),c=this.docs.getIteratorFrom(a);for(;c.hasNext();){const{key:h,value:{document:d}}=c.getNext();if(!o.isPrefixOf(h.path))break;h.path.length>o.length+1||im(tm(d),i)<=0||(n.has(d.key)||Vs(e,d))&&(r=r.insert(d.key,d.mutableCopy()))}return W.resolve(r)}getAllFromCollectionGroup(t,e,i,n){Te(9500)}ri(t,e){return W.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new Cg(this)}getSize(t){return W.resolve(this.size)}}class Cg extends wg{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),W.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ag{constructor(t){this.persistence=t,this.ii=new gn(e=>Ko(e),Qo),this.lastRemoteSnapshotVersion=xe.min(),this.highestTargetId=0,this.si=0,this.oi=new ra,this.targetCount=0,this._i=Hn.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),W.resolve()}getLastRemoteSnapshotVersion(t){return W.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return W.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),W.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),W.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new Hn(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,W.resolve()}updateTargetData(t,e){return this.hr(e),W.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,W.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),W.waitFor(r).next(()=>n)}getTargetCount(t){return W.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return W.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),W.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),W.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),W.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return W.resolve(i)}containsKey(t,e){return W.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zh{constructor(t,e){this.ai={},this.overlays={},this.ui=new ks(0),this.ci=!1,this.ci=!0,this.li=new bg,this.referenceDelegate=t(this),this.hi=new Ag(this),this.indexManager=new dg,this.remoteDocumentCache=function(n){return new Pg(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new hg(e),this.Ti=new xg(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Eg,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new Sg(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){le("MemoryPersistence","Starting transaction:",t);const n=new Rg(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return W.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class Rg extends rm{constructor(t){super(),this.currentSequenceNumber=t}}class sa{constructor(t){this.persistence=t,this.Ai=new ra,this.Ri=null}static Vi(t){return new sa(t)}get mi(){if(this.Ri)return this.Ri;throw Te(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),W.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),W.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),W.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return W.forEach(this.mi,i=>{const n=me.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,xe.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return W.or([()=>W.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class Cs{constructor(t,e){this.persistence=t,this.gi=new gn(i=>am(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=yg(this,e)}static Vi(t,e){return new Cs(t,e)}Ii(){}di(t){return W.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return W.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?W.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,xe.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),W.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),W.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),W.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),W.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=os(t.data.value)),e}Sr(t,e,i){return W.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return W.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oa{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Le(),n=Le();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new oa(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ig{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dg{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return Pf()?8:sm(bf())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new Ig;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(An()<=Be.DEBUG&&le("QueryEngine","SDK will not create cache indexes for query:",Rn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),W.resolve()):(An()<=Be.DEBUG&&le("QueryEngine","Query:",Rn(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(An()<=Be.DEBUG&&le("QueryEngine","The SDK decides to create cache indexes for query:",Rn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,wi(e))):W.resolve())}ps(t,e){if(Bl(e))return W.resolve(null);let i=wi(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=Ao(e,null,"F"),i=wi(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Le(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(c=>{const h=this.bs(e,a);return this.Ds(e,h,o,c.readTime)?this.ps(t,Ao(e,null,"F")):this.vs(t,h,e,c)}))})))}ys(t,e,i,n){return Bl(e)||n.isEqual(xe.min())?W.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?W.resolve(null):(An()<=Be.DEBUG&&le("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Rn(e)),this.vs(t,o,e,em(n,Tr)).next(a=>a))})}bs(t,e){let i=new wt(vh(t));return e.forEach((n,r)=>{Vs(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return An()<=Be.DEBUG&&le("QueryEngine","Using full collection scan to execute query:",Rn(e)),this.gs.getDocumentsMatchingQuery(t,e,Zi.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const aa="LocalStore",Mg=3e8;class kg{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new nt(Ae),this.Ms=new gn(r=>Ko(r),Qo),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Tg(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function Og(s,t,e,i){return new kg(s,t,e,i)}async function Hh(s,t){const e=Se(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let c=Le();for(const h of n){o.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}for(const h of r){a.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}return e.localDocuments.getDocuments(i,c).next(h=>({Bs:h,removedBatchIds:o,addedBatchIds:a}))})})}function Fg(s,t){const e=Se(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,c,h,d){const l=h.batch,f=l.keys();let p=W.resolve();return f.forEach(g=>{p=p.next(()=>d.getEntry(c,g)).next(v=>{const w=h.docVersions.get(g);je(w!==null,48541),v.version.compareTo(w)<0&&(l.applyToRemoteDocument(v,h),v.isValidDocument()&&(v.setReadTime(h.commitVersion),d.addEntry(v)))})}),p.next(()=>a.mutationQueue.removeMutationBatch(c,l))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let c=Le();for(let h=0;h<a.mutationResults.length;++h)a.mutationResults[h].transformResults.length>0&&(c=c.add(a.batch.mutations[h].key));return c}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function Nh(s){const t=Se(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function Lg(s,t){const e=Se(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((d,l)=>{const f=n.get(l);if(!f)return;a.push(e.hi.removeMatchingKeys(r,d.removedDocuments,l).next(()=>e.hi.addMatchingKeys(r,d.addedDocuments,l)));let p=f.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(l)!==null?p=p.withResumeToken(Rt.EMPTY_BYTE_STRING,xe.min()).withLastLimboFreeSnapshotVersion(xe.min()):d.resumeToken.approximateByteSize()>0&&(p=p.withResumeToken(d.resumeToken,i)),n=n.insert(l,p),function(v,w,E){return v.resumeToken.approximateByteSize()===0||w.snapshotVersion.toMicroseconds()-v.snapshotVersion.toMicroseconds()>=Mg?!0:E.addedDocuments.size+E.modifiedDocuments.size+E.removedDocuments.size>0}(f,p,d)&&a.push(e.hi.updateTargetData(r,p))});let c=Fi(),h=Le();if(t.documentUpdates.forEach(d=>{t.resolvedLimboDocuments.has(d)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,d))}),a.push(Vg(r,o,t.documentUpdates).next(d=>{c=d.Ls,h=d.ks})),!i.isEqual(xe.min())){const d=e.hi.getLastRemoteSnapshotVersion(r).next(l=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(d)}return W.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,c,h)).next(()=>c)}).then(r=>(e.Fs=n,r))}function Vg(s,t,e){let i=Le(),n=Le();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=Fi();return e.forEach((a,c)=>{const h=r.get(a);c.isFoundDocument()!==h.isFoundDocument()&&(n=n.add(a)),c.isNoDocument()&&c.version.isEqual(xe.min())?(t.removeEntry(a,c.readTime),o=o.insert(a,c)):!h.isValidDocument()||c.version.compareTo(h.version)>0||c.version.compareTo(h.version)===0&&h.hasPendingWrites?(t.addEntry(c),o=o.insert(a,c)):le(aa,"Ignoring outdated watch update for ",a,". Current version:",h.version," Watch version:",c.version)}),{Ls:o,ks:n}})}function Bg(s,t){const e=Se(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=Zo),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function zg(s,t){const e=Se(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,W.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new Hi(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function ko(s,t,e){const i=Se(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!Zn(o))throw o;le(aa,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function Ql(s,t,e){const i=Se(s);let n=xe.min(),r=Le();return i.persistence.runTransaction("Execute query","readwrite",o=>function(c,h,d){const l=Se(c),f=l.Ms.get(d);return f!==void 0?W.resolve(l.Fs.get(f)):l.hi.getTargetData(h,d)}(i,o,wi(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(c=>{r=c})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:xe.min(),e?r:Le())).next(a=>(Hg(i,Pm(t),a),{documents:a,qs:r})))}function Hg(s,t,e){let i=s.xs.get(t)||xe.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class Jl{constructor(){this.activeTargetIds=Mm()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Ng{constructor(){this.Fo=new Jl,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new Jl,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ug{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $l="ConnectivityMonitor";class ec{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){le($l,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){le($l,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ts=null;function Oo(){return ts===null?ts=function(){return 268435456+Math.round(2147483648*Math.random())}():ts++,"0x"+ts.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const uo="RestConnection",jg={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Wg{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===Ts?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=Oo(),a=this.Go(t,e.toUriEncodedString());le(uo,`Sending RPC '${t}' ${o}:`,a,i);const c={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(c,n,r);const{host:h}=new URL(a),d=jo(h);return this.jo(t,a,c,i,d).then(l=>(le(uo,`Received RPC '${t}' ${o}: `,l),l),l=>{throw Gi(uo,`RPC '${t}' ${o} failed with error: `,l,"url: ",a,"request:",i),l})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+qn}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=jg[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qg{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vt="WebChannelConnection";class Gg extends Wg{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=Oo();return new Promise((a,c)=>{const h=new jc;h.setWithCredentials(!0),h.listenOnce(Wc.COMPLETE,()=>{try{switch(h.getLastErrorCode()){case ss.NO_ERROR:const l=h.getResponseJson();le(Vt,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(l)),a(l);break;case ss.TIMEOUT:le(Vt,`RPC '${t}' ${o} timed out`),c(new oe(j.DEADLINE_EXCEEDED,"Request time out"));break;case ss.HTTP_ERROR:const f=h.getStatus();if(le(Vt,`RPC '${t}' ${o} failed with status:`,f,"response text:",h.getResponseText()),f>0){let p=h.getResponseJson();Array.isArray(p)&&(p=p[0]);const g=p==null?void 0:p.error;if(g&&g.status&&g.message){const v=function(E){const I=E.toLowerCase().replace(/_/g,"-");return Object.values(j).indexOf(I)>=0?I:j.UNKNOWN}(g.status);c(new oe(v,g.message))}else c(new oe(j.UNKNOWN,"Server responded with status "+h.getStatus()))}else c(new oe(j.UNAVAILABLE,"Connection failed."));break;default:Te(9055,{c_:t,streamId:o,l_:h.getLastErrorCode(),h_:h.getLastError()})}}finally{le(Vt,`RPC '${t}' ${o} completed.`)}});const d=JSON.stringify(n);le(Vt,`RPC '${t}' ${o} sending request:`,n),h.send(e,"POST",d,i,15)})}P_(t,e,i){const n=Oo(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=Zc(),a=Gc(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},h=this.longPollingOptions.timeoutSeconds;h!==void 0&&(c.longPollingTimeout=Math.round(1e3*h)),this.useFetchStreams&&(c.useFetchStreams=!0),this.zo(c.initMessageHeaders,e,i),c.encodeInitMessageHeaders=!0;const d=r.join("");le(Vt,`Creating RPC '${t}' stream ${n}: ${d}`,c);const l=o.createWebChannel(d,c);this.T_(l);let f=!1,p=!1;const g=new qg({Ho:w=>{p?le(Vt,`Not sending because RPC '${t}' stream ${n} is closed:`,w):(f||(le(Vt,`Opening RPC '${t}' stream ${n} transport.`),l.open(),f=!0),le(Vt,`RPC '${t}' stream ${n} sending:`,w),l.send(w))},Yo:()=>l.close()}),v=(w,E,I)=>{w.listen(E,L=>{try{I(L)}catch(N){setTimeout(()=>{throw N},0)}})};return v(l,lr.EventType.OPEN,()=>{p||(le(Vt,`RPC '${t}' stream ${n} transport opened.`),g.s_())}),v(l,lr.EventType.CLOSE,()=>{p||(p=!0,le(Vt,`RPC '${t}' stream ${n} transport closed`),g.__(),this.I_(l))}),v(l,lr.EventType.ERROR,w=>{p||(p=!0,Gi(Vt,`RPC '${t}' stream ${n} transport errored. Name:`,w.name,"Message:",w.message),g.__(new oe(j.UNAVAILABLE,"The operation could not be completed")))}),v(l,lr.EventType.MESSAGE,w=>{var E;if(!p){const I=w.data[0];je(!!I,16349);const L=I,N=(L==null?void 0:L.error)||((E=L[0])===null||E===void 0?void 0:E.error);if(N){le(Vt,`RPC '${t}' stream ${n} received error:`,N);const Z=N.status;let J=function(P){const M=ft[P];if(M!==void 0)return Ah(M)}(Z),k=N.message;J===void 0&&(J=j.INTERNAL,k="Unknown error status: "+Z+" with message "+N.message),p=!0,g.__(new oe(J,k)),l.close()}else le(Vt,`RPC '${t}' stream ${n} received:`,I),g.a_(I)}}),v(a,qc.STAT_EVENT,w=>{w.stat===To.PROXY?le(Vt,`RPC '${t}' stream ${n} detected buffering proxy`):w.stat===To.NOPROXY&&le(Vt,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{g.o_()},0),g}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function fo(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ns(s){return new Km(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Uh{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&le("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tc="PersistentStream";class jh{constructor(t,e,i,n,r,o,a,c){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=c,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new Uh(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===j.RESOURCE_EXHAUSTED?(Oi(e.toString()),Oi("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===j.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new oe(j.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return le(tc,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(le(tc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Zg extends jh{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=$m(this.serializer,t),i=function(r){if(!("targetChange"in r))return xe.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?xe.min():o.readTime?_i(o.readTime):xe.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=Mo(this.serializer),e.addTarget=function(r,o){let a;const c=o.target;if(a=Po(c)?{documents:ig(r,c)}:{query:ng(r,c).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Dh(r,o.resumeToken);const h=Ro(r,o.expectedCount);h!==null&&(a.expectedCount=h)}else if(o.snapshotVersion.compareTo(xe.min())>0){a.readTime=Ps(r,o.snapshotVersion.toTimestamp());const h=Ro(r,o.expectedCount);h!==null&&(a.expectedCount=h)}return a}(this.serializer,t);const i=sg(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=Mo(this.serializer),e.removeTarget=t,this.k_(e)}}class Xg extends jh{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return je(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,je(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){je(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=tg(t.writeResults,t.commitTime),i=_i(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=Mo(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>eg(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yg{}class Kg extends Yg{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new oe(j.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,Io(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===j.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new oe(j.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,Io(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===j.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new oe(j.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class Qg{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?(Oi(e),this._a=!1):le("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mn="RemoteStore";class Jg{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{vn(this)&&(le(mn,"Restarting streams for network reachability change."),await async function(c){const h=Se(c);h.Ia.add(4),await kr(h),h.Aa.set("Unknown"),h.Ia.delete(4),await Us(h)}(this))})}),this.Aa=new Qg(i,n)}}async function Us(s){if(vn(s))for(const t of s.da)await t(!0)}async function kr(s){for(const t of s.da)await t(!1)}function Wh(s,t){const e=Se(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),ua(e)?ha(e):Yn(e).x_()&&ca(e,t))}function la(s,t){const e=Se(s),i=Yn(e);e.Ta.delete(t),i.x_()&&qh(e,t),e.Ta.size===0&&(i.x_()?i.B_():vn(e)&&e.Aa.set("Unknown"))}function ca(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(xe.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}Yn(s).H_(t)}function qh(s,t){s.Ra.$e(t),Yn(s).Y_(t)}function ha(s){s.Ra=new Gm({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),Yn(s).start(),s.Aa.aa()}function ua(s){return vn(s)&&!Yn(s).M_()&&s.Ta.size>0}function vn(s){return Se(s).Ia.size===0}function Gh(s){s.Ra=void 0}async function $g(s){s.Aa.set("Online")}async function ev(s){s.Ta.forEach((t,e)=>{ca(s,t)})}async function tv(s,t){Gh(s),ua(s)?(s.Aa.la(t),ha(s)):s.Aa.set("Unknown")}async function iv(s,t,e){if(s.Aa.set("Online"),t instanceof Ih&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){le(mn,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await As(s,i)}else if(t instanceof cs?s.Ra.Ye(t):t instanceof Rh?s.Ra.it(t):s.Ra.et(t),!e.isEqual(xe.min()))try{const i=await Nh(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((c,h)=>{if(c.resumeToken.approximateByteSize()>0){const d=r.Ta.get(h);d&&r.Ta.set(h,d.withResumeToken(c.resumeToken,o))}}),a.targetMismatches.forEach((c,h)=>{const d=r.Ta.get(c);if(!d)return;r.Ta.set(c,d.withResumeToken(Rt.EMPTY_BYTE_STRING,d.snapshotVersion)),qh(r,c);const l=new Hi(d.target,c,h,d.sequenceNumber);ca(r,l)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){le(mn,"Failed to raise snapshot:",i),await As(s,i)}}async function As(s,t,e){if(!Zn(t))throw t;s.Ia.add(1),await kr(s),s.Aa.set("Offline"),e||(e=()=>Nh(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{le(mn,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await Us(s)})}function Zh(s,t){return t().catch(e=>As(s,e,t))}async function js(s){const t=Se(s),e=Qi(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:Zo;for(;nv(t);)try{const n=await Bg(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,rv(t,n)}catch(n){await As(t,n)}Xh(t)&&Yh(t)}function nv(s){return vn(s)&&s.Pa.length<10}function rv(s,t){s.Pa.push(t);const e=Qi(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function Xh(s){return vn(s)&&!Qi(s).M_()&&s.Pa.length>0}function Yh(s){Qi(s).start()}async function sv(s){Qi(s).na()}async function ov(s){const t=Qi(s);for(const e of s.Pa)t.X_(e.mutations)}async function av(s,t,e){const i=s.Pa.shift(),n=ta.from(i,t,e);await Zh(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await js(s)}async function lv(s,t){t&&Qi(s).Z_&&await async function(i,n){if(function(o){return Wm(o)&&o!==j.ABORTED}(n.code)){const r=i.Pa.shift();Qi(i).N_(),await Zh(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await js(i)}}(s,t),Xh(s)&&Yh(s)}async function ic(s,t){const e=Se(s);e.asyncQueue.verifyOperationInProgress(),le(mn,"RemoteStore received new credentials");const i=vn(e);e.Ia.add(3),await kr(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await Us(e)}async function cv(s,t){const e=Se(s);t?(e.Ia.delete(2),await Us(e)):t||(e.Ia.add(2),await kr(e),e.Aa.set("Unknown"))}function Yn(s){return s.Va||(s.Va=function(e,i,n){const r=Se(e);return r.ia(),new Zg(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:$g.bind(null,s),e_:ev.bind(null,s),n_:tv.bind(null,s),J_:iv.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),ua(s)?ha(s):s.Aa.set("Unknown")):(await s.Va.stop(),Gh(s))})),s.Va}function Qi(s){return s.ma||(s.ma=function(e,i,n){const r=Se(e);return r.ia(),new Xg(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:sv.bind(null,s),n_:lv.bind(null,s),ea:ov.bind(null,s),ta:av.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await js(s)):(await s.ma.stop(),s.Pa.length>0&&(le(mn,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class da{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new dn,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new da(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new oe(j.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function fa(s,t){if(Oi("AsyncQueue",`${t}: ${s}`),Zn(s))return new oe(j.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class On{static emptySet(t){return new On(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||me.comparator(e.key,i.key):(e,i)=>me.comparator(e.key,i.key),this.keyedMap=cr(),this.sortedSet=new nt(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof On)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new On;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nc{constructor(){this.fa=new nt(me.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):Te(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class Nn{constructor(t,e,i,n,r,o,a,c,h){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=c,this.hasCachedResults=h}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new Nn(t,e,On.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ls(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hv{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class uv{constructor(){this.queries=rc(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=Se(e),r=n.queries;n.queries=rc(),r.forEach((o,a)=>{for(const c of a.wa)c.onError(i)})})(this,new oe(j.ABORTED,"Firestore shutting down"))}}function rc(){return new gn(s=>gh(s),Ls)}async function dv(s,t){const e=Se(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new hv,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=fa(o,`Initialization of query '${Rn(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&pa(e)}async function fv(s,t){const e=Se(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function pv(s,t){const e=Se(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&pa(e)}function mv(s,t,e){const i=Se(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function pa(s){s.Da.forEach(t=>{t.next()})}var Fo,sc;(sc=Fo||(Fo={})).Fa="default",sc.Cache="cache";class gv{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new Nn(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=Nn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==Fo.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kh{constructor(t){this.key=t}}class Qh{constructor(t){this.key=t}}class vv{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Le(),this.mutatedKeys=Le(),this.Xa=vh(t),this.eu=new On(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new nc,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const c=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,h=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((d,l)=>{const f=n.get(d),p=Vs(this.query,l)?l:null,g=!!f&&this.mutatedKeys.has(f.key),v=!!p&&(p.hasLocalMutations||this.mutatedKeys.has(p.key)&&p.hasCommittedMutations);let w=!1;f&&p?f.data.isEqual(p.data)?g!==v&&(i.track({type:3,doc:p}),w=!0):this.iu(f,p)||(i.track({type:2,doc:p}),w=!0,(c&&this.Xa(p,c)>0||h&&this.Xa(p,h)<0)&&(a=!0)):!f&&p?(i.track({type:0,doc:p}),w=!0):f&&!p&&(i.track({type:1,doc:f}),w=!0,(c||h)&&(a=!0)),w&&(p?(o=o.add(p),r=v?r.add(d):r.delete(d)):(o=o.delete(d),r=r.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),r=r.delete(d.key),i.track({type:1,doc:d})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((d,l)=>function(p,g){const v=w=>{switch(w){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Te(20277,{At:w})}};return v(p)-v(g)}(d.type,l.type)||this.Xa(d.doc,l.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],c=this.Za.size===0&&this.current&&!n?1:0,h=c!==this.Ya;return this.Ya=c,o.length!==0||h?{snapshot:new Nn(this.query,t.eu,r,o,t.mutatedKeys,c===0,h,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new nc,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Le(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new Qh(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new Kh(i))}),e}uu(t){this.Ha=t.qs,this.Za=Le();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return Nn.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const ma="SyncEngine";class yv{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class wv{constructor(t){this.key=t,this.lu=!1}}class _v{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new gn(a=>gh(a),Ls),this.Tu=new Map,this.Iu=new Set,this.du=new nt(me.comparator),this.Eu=new Map,this.Au=new ra,this.Ru={},this.Vu=new Map,this.mu=Hn.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function Tv(s,t,e=!0){const i=nu(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await Jh(i,t,e,!0),n}async function xv(s,t){const e=nu(s);await Jh(e,t,!0,!1)}async function Jh(s,t,e,i){const n=await zg(s.localStore,wi(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await Ev(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&Wh(s.remoteStore,n),a}async function Ev(s,t,e,i,n){s.gu=(l,f,p)=>async function(v,w,E,I){let L=w.view.nu(E);L.Ds&&(L=await Ql(v.localStore,w.query,!1).then(({documents:k})=>w.view.nu(k,L)));const N=I&&I.targetChanges.get(w.targetId),Z=I&&I.targetMismatches.get(w.targetId)!=null,J=w.view.applyChanges(L,v.isPrimaryClient,N,Z);return ac(v,w.targetId,J._u),J.snapshot}(s,l,f,p);const r=await Ql(s.localStore,t,!0),o=new vv(t,r.qs),a=o.nu(r.documents),c=Mr.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),h=o.applyChanges(a,s.isPrimaryClient,c);ac(s,e,h._u);const d=new yv(t,e,o);return s.Pu.set(t,d),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),h.snapshot}async function bv(s,t,e){const i=Se(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!Ls(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await ko(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&la(i.remoteStore,n.targetId),Lo(i,n.targetId)}).catch(Gn)):(Lo(i,n.targetId),await ko(i.localStore,n.targetId,!0))}async function Sv(s,t){const e=Se(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),la(e.remoteStore,i.targetId))}async function Pv(s,t,e){const i=kv(s);try{const n=await function(o,a){const c=Se(o),h=$e.now(),d=a.reduce((p,g)=>p.add(g.key),Le());let l,f;return c.persistence.runTransaction("Locally write mutations","readwrite",p=>{let g=Fi(),v=Le();return c.Os.getEntries(p,d).next(w=>{g=w,g.forEach((E,I)=>{I.isValidDocument()||(v=v.add(E))})}).next(()=>c.localDocuments.getOverlayedDocuments(p,g)).next(w=>{l=w;const E=[];for(const I of a){const L=zm(I,l.get(I.key).overlayedDocument);L!=null&&E.push(new tn(I.key,L,lh(L.value.mapValue),li.exists(!0)))}return c.mutationQueue.addMutationBatch(p,h,E,a)}).next(w=>{f=w;const E=w.applyToLocalDocumentSet(l,v);return c.documentOverlayCache.saveOverlays(p,w.batchId,E)})}).then(()=>({batchId:f.batchId,changes:wh(l)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,c){let h=o.Ru[o.currentUser.toKey()];h||(h=new nt(Ae)),h=h.insert(a,c),o.Ru[o.currentUser.toKey()]=h}(i,n.batchId,e),await Or(i,n.changes),await js(i.remoteStore)}catch(n){const r=fa(n,"Failed to persist write");e.reject(r)}}async function $h(s,t){const e=Se(s);try{const i=await Lg(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(je(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?je(o.lu,14607):n.removedDocuments.size>0&&(je(o.lu,42227),o.lu=!1))}),await Or(e,i,t)}catch(i){await Gn(i)}}function oc(s,t,e){const i=Se(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const c=Se(o);c.onlineState=a;let h=!1;c.queries.forEach((d,l)=>{for(const f of l.wa)f.va(a)&&(h=!0)}),h&&pa(c)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function Cv(s,t,e){const i=Se(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new nt(me.comparator);o=o.insert(r,zt.newNoDocument(r,xe.min()));const a=Le().add(r),c=new Hs(xe.min(),new Map,new nt(Ae),o,a);await $h(i,c),i.du=i.du.remove(r),i.Eu.delete(t),ga(i)}else await ko(i.localStore,t,!1).then(()=>Lo(i,t,e)).catch(Gn)}async function Av(s,t){const e=Se(s),i=t.batch.batchId;try{const n=await Fg(e.localStore,t);tu(e,i,null),eu(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await Or(e,n)}catch(n){await Gn(n)}}async function Rv(s,t,e){const i=Se(s);try{const n=await function(o,a){const c=Se(o);return c.persistence.runTransaction("Reject batch","readwrite-primary",h=>{let d;return c.mutationQueue.lookupMutationBatch(h,a).next(l=>(je(l!==null,37113),d=l.keys(),c.mutationQueue.removeMutationBatch(h,l))).next(()=>c.mutationQueue.performConsistencyCheck(h)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(h,d,a)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(h,d)).next(()=>c.localDocuments.getDocuments(h,d))})}(i.localStore,t);tu(i,t,e),eu(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await Or(i,n)}catch(n){await Gn(n)}}function eu(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function tu(s,t,e){const i=Se(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function Lo(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||iu(s,i)})}function iu(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&(la(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),ga(s))}function ac(s,t,e){for(const i of e)i instanceof Kh?(s.Au.addReference(i.key,t),Iv(s,i)):i instanceof Qh?(le(ma,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||iu(s,i.key)):Te(19791,{yu:i})}function Iv(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(le(ma,"New document in limbo: "+e),s.Iu.add(i),ga(s))}function ga(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new me(Ke.fromString(t)),i=s.mu.next();s.Eu.set(i,new wv(e)),s.du=s.du.insert(e,i),Wh(s.remoteStore,new Hi(wi(Jo(e.path)),i,"TargetPurposeLimboResolution",ks.ue))}}async function Or(s,t,e){const i=Se(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,c)=>{o.push(i.gu(c,t,e).then(h=>{var d;if((h||e)&&i.isPrimaryClient){const l=h?!h.fromCache:(d=e==null?void 0:e.targetChanges.get(c.targetId))===null||d===void 0?void 0:d.current;i.sharedClientState.updateQueryState(c.targetId,l?"current":"not-current")}if(h){n.push(h);const l=oa.Es(c.targetId,h);r.push(l)}}))}),await Promise.all(o),i.hu.J_(n),await async function(c,h){const d=Se(c);try{await d.persistence.runTransaction("notifyLocalViewChanges","readwrite",l=>W.forEach(h,f=>W.forEach(f.Is,p=>d.persistence.referenceDelegate.addReference(l,f.targetId,p)).next(()=>W.forEach(f.ds,p=>d.persistence.referenceDelegate.removeReference(l,f.targetId,p)))))}catch(l){if(!Zn(l))throw l;le(aa,"Failed to update sequence numbers: "+l)}for(const l of h){const f=l.targetId;if(!l.fromCache){const p=d.Fs.get(f),g=p.snapshotVersion,v=p.withLastLimboFreeSnapshotVersion(g);d.Fs=d.Fs.insert(f,v)}}}(i.localStore,r))}async function Dv(s,t){const e=Se(s);if(!e.currentUser.isEqual(t)){le(ma,"User change. New user:",t.toKey());const i=await Hh(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(c=>{c.reject(new oe(j.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await Or(e,i.Bs)}}function Mv(s,t){const e=Se(s),i=e.Eu.get(t);if(i&&i.lu)return Le().add(i.key);{let n=Le();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function nu(s){const t=Se(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=$h.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Mv.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Cv.bind(null,t),t.hu.J_=pv.bind(null,t.eventManager),t.hu.pu=mv.bind(null,t.eventManager),t}function kv(s){const t=Se(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Av.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Rv.bind(null,t),t}class Rs{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=Ns(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return Og(this.persistence,new Dg,t.initialUser,this.serializer)}Du(t){return new zh(sa.Vi,this.serializer)}bu(t){return new Ng}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}Rs.provider={build:()=>new Rs};class Ov extends Rs{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){je(this.persistence.referenceDelegate instanceof Cs,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new gg(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?qt.withCacheSize(this.cacheSizeBytes):qt.DEFAULT;return new zh(i=>Cs.Vi(i,e),this.serializer)}}class Vo{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>oc(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=Dv.bind(null,this.syncEngine),await cv(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new uv}()}createDatastore(t){const e=Ns(t.databaseInfo.databaseId),i=function(r){return new Gg(r)}(t.databaseInfo);return function(r,o,a,c){return new Kg(r,o,a,c)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new Jg(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>oc(this.syncEngine,e,0),function(){return ec.C()?new ec:new Ug}())}createSyncEngine(t,e){return function(n,r,o,a,c,h,d){const l=new _v(n,r,o,a,c,h);return d&&(l.fu=!0),l}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=Se(n);le(mn,"RemoteStore shutting down."),r.Ia.add(5),await kr(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}Vo.provider={build:()=>new Vo};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fv{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):Oi("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ji="FirestoreClient";class Lv{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=Bt.UNAUTHENTICATED,this.clientId=Go.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{le(Ji,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(le(Ji,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new dn;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=fa(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function po(s,t){s.asyncQueue.verifyOperationInProgress(),le(Ji,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await Hh(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{Gi("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{le("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{Gi("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function lc(s,t){s.asyncQueue.verifyOperationInProgress();const e=await Vv(s);le(Ji,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>ic(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>ic(t.remoteStore,n)),s._onlineComponents=t}async function Vv(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){le(Ji,"Using user provided OfflineComponentProvider");try{await po(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===j.FAILED_PRECONDITION||n.code===j.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;Gi("Error using user provided cache. Falling back to memory cache: "+e),await po(s,new Rs)}}else le(Ji,"Using default OfflineComponentProvider"),await po(s,new Ov(void 0));return s._offlineComponents}async function ru(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(le(Ji,"Using user provided OnlineComponentProvider"),await lc(s,s._uninitializedComponentsProvider._online)):(le(Ji,"Using default OnlineComponentProvider"),await lc(s,new Vo))),s._onlineComponents}function Bv(s){return ru(s).then(t=>t.syncEngine)}async function cc(s){const t=await ru(s),e=t.eventManager;return e.onListen=Tv.bind(null,t.syncEngine),e.onUnlisten=bv.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=xv.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=Sv.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function su(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hc=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ou="firestore.googleapis.com",uc=!0;class dc{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new oe(j.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=ou,this.ssl=uc}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:uc;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=Bh;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<pg)throw new oe(j.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}$p("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=su((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new oe(j.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new oe(j.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new oe(j.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Ws{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new dc({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new oe(j.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new oe(j.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new dc(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new Wp;switch(i.type){case"firstParty":return new Xp(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new oe(j.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=hc.get(e);i&&(le("ComponentProvider","Removing Datastore"),hc.delete(e),i.terminate())}(this),Promise.resolve()}}function zv(s,t,e,i={}){var n;s=Wi(s,Ws);const r=jo(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),c=`${t}:${e}`;r&&(wf(`https://${c}`),Ef("Firestore",!0)),o.host!==ou&&o.host!==c&&Gi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const h=Object.assign(Object.assign({},o),{host:c,ssl:r,emulatorOptions:i});if(!vs(h,a)&&(s._setSettings(h),i.mockUserToken)){let d,l;if(typeof i.mockUserToken=="string")d=i.mockUserToken,l=Bt.MOCK_USER;else{d=_f(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const f=i.mockUserToken.sub||i.mockUserToken.user_id;if(!f)throw new oe(j.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new Bt(f)}s._authCredentials=new qp(new Yc(d,l))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yn{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new yn(this.firestore,t,this._query)}}class vt{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new qi(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new vt(this.firestore,t,this._key)}toJSON(){return{type:vt._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(Ir(e,vt._jsonSchema))return new vt(t,i||null,new me(Ke.fromString(e.referencePath)))}}vt._jsonSchemaVersion="firestore/documentReference/1.0",vt._jsonSchema={type:gt("string",vt._jsonSchemaVersion),referencePath:gt("string")};class qi extends yn{constructor(t,e,i){super(t,e,Jo(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new vt(this.firestore,null,new me(t))}withConverter(t){return new qi(this.firestore,t,this._path)}}function fc(s,t,...e){if(s=Ei(s),Qc("collection","path",t),s instanceof Ws){const i=Ke.fromString(t,...e);return bl(i),new qi(s,null,i)}{if(!(s instanceof vt||s instanceof qi))throw new oe(j.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ke.fromString(t,...e));return bl(i),new qi(s.firestore,null,i)}}function Bo(s,t,...e){if(s=Ei(s),arguments.length===1&&(t=Go.newId()),Qc("doc","path",t),s instanceof Ws){const i=Ke.fromString(t,...e);return El(i),new vt(s,null,new me(i))}{if(!(s instanceof vt||s instanceof qi))throw new oe(j.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ke.fromString(t,...e));return El(i),new vt(s.firestore,s instanceof qi?s.converter:null,new me(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pc="AsyncQueue";class mc{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new Uh(this,"async_queue_retry"),this.oc=()=>{const i=fo();i&&le(pc,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=fo();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=fo();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new dn;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!Zn(t))throw t;le(pc,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,Oi("INTERNAL UNHANDLED ERROR: ",gc(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=da.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&Te(47125,{hc:gc(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function gc(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vc(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class Un extends Ws{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new mc,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new mc(t),this._firestoreClient=void 0,await t}}}function Hv(s,t){const e=typeof s=="object"?s:kp(),i=typeof s=="string"?s:Ts,n=Ap(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=vf("firestore");r&&zv(n,...r)}return n}function au(s){if(s._terminated)throw new oe(j.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||Nv(s),s._firestoreClient}function Nv(s){var t,e,i;const n=s._freezeSettings(),r=function(a,c,h,d){return new hm(a,c,h,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,su(d.experimentalLongPollingOptions),d.useFetchStreams,d.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new Lv(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const c=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(c),_online:c}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ni{constructor(t){this._byteString=t}static fromBase64String(t){try{return new ni(Rt.fromBase64String(t))}catch(e){throw new oe(j.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new ni(Rt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:ni._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(Ir(t,ni._jsonSchema))return ni.fromBase64String(t.bytes)}}ni._jsonSchemaVersion="firestore/bytes/1.0",ni._jsonSchema={type:gt("string",ni._jsonSchemaVersion),bytes:gt("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qs{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new oe(j.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new At(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class va{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ti{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new oe(j.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new oe(j.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return Ae(this._lat,t._lat)||Ae(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:Ti._jsonSchemaVersion}}static fromJSON(t){if(Ir(t,Ti._jsonSchema))return new Ti(t.latitude,t.longitude)}}Ti._jsonSchemaVersion="firestore/geoPoint/1.0",Ti._jsonSchema={type:gt("string",Ti._jsonSchemaVersion),latitude:gt("number"),longitude:gt("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xi{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:xi._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(Ir(t,xi._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new xi(t.vectorValues);throw new oe(j.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}xi._jsonSchemaVersion="firestore/vectorValue/1.0",xi._jsonSchema={type:gt("string",xi._jsonSchemaVersion),vectorValues:gt("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Uv=/^__.*__$/;class jv{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new tn(t,this.data,this.fieldMask,e,this.fieldTransforms):new Dr(t,this.data,e,this.fieldTransforms)}}class lu{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new tn(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function cu(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Te(40011,{Ec:s})}}class ya{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new ya(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return Is(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(cu(this.Ec)&&Uv.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class Wv{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||Ns(t)}Dc(t,e,i,n=!1){return new ya({Ec:t,methodName:e,bc:i,path:At.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function wa(s){const t=s._freezeSettings(),e=Ns(s._databaseId);return new Wv(s._databaseId,!!t.ignoreUndefinedProperties,e)}function qv(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);_a("Data must be an object, but it was:",o,i);const a=hu(i,o);let c,h;if(r.merge)c=new Kt(o.fieldMask),h=o.fieldTransforms;else if(r.mergeFields){const d=[];for(const l of r.mergeFields){const f=zo(t,l,e);if(!o.contains(f))throw new oe(j.INVALID_ARGUMENT,`Field '${f}' is specified in your field mask but missing from your input data.`);du(d,f)||d.push(f)}c=new Kt(d),h=o.fieldTransforms.filter(l=>c.covers(l.field))}else c=null,h=o.fieldTransforms;return new jv(new Zt(a),c,h)}class Gs extends va{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Gs}}function Gv(s,t,e,i){const n=s.Dc(1,t,e);_a("Data must be an object, but it was:",n,i);const r=[],o=Zt.empty();en(i,(c,h)=>{const d=Ta(t,c,e);h=Ei(h);const l=n.gc(d);if(h instanceof Gs)r.push(d);else{const f=Fr(h,l);f!=null&&(r.push(d),o.set(d,f))}});const a=new Kt(r);return new lu(o,a,n.fieldTransforms)}function Zv(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[zo(t,i,e)],c=[n];if(r.length%2!=0)throw new oe(j.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<r.length;f+=2)a.push(zo(t,r[f])),c.push(r[f+1]);const h=[],d=Zt.empty();for(let f=a.length-1;f>=0;--f)if(!du(h,a[f])){const p=a[f];let g=c[f];g=Ei(g);const v=o.gc(p);if(g instanceof Gs)h.push(p);else{const w=Fr(g,v);w!=null&&(h.push(p),d.set(p,w))}}const l=new Kt(h);return new lu(d,l,o.fieldTransforms)}function Xv(s,t,e,i=!1){return Fr(e,s.Dc(i?4:3,t))}function Fr(s,t){if(uu(s=Ei(s)))return _a("Unsupported field value:",t,s),hu(s,t);if(s instanceof va)return function(i,n){if(!cu(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let c=Fr(a,n.yc(o));c==null&&(c={nullValue:"NULL_VALUE"}),r.push(c),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=Ei(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return km(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=$e.fromDate(i);return{timestampValue:Ps(n.serializer,r)}}if(i instanceof $e){const r=new $e(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:Ps(n.serializer,r)}}if(i instanceof Ti)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof ni)return{bytesValue:Dh(n.serializer,i._byteString)};if(i instanceof vt){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:na(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof xi)return function(o,a){return{mapValue:{fields:{[oh]:{stringValue:ah},[xs]:{arrayValue:{values:o.toArray().map(h=>{if(typeof h!="number")throw a.wc("VectorValues must only contain numeric values.");return $o(a.serializer,h)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${Ms(i)}`)}(s,t)}function hu(s,t){const e={};return eh(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):en(s,(i,n)=>{const r=Fr(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function uu(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof $e||s instanceof Ti||s instanceof ni||s instanceof vt||s instanceof va||s instanceof xi)}function _a(s,t,e){if(!uu(e)||!Jc(e)){const i=Ms(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function zo(s,t,e){if((t=Ei(t))instanceof qs)return t._internalPath;if(typeof t=="string")return Ta(s,t);throw Is("Field path arguments must be of type string or ",s,!1,void 0,e)}const Yv=new RegExp("[~\\*/\\[\\]]");function Ta(s,t,e){if(t.search(Yv)>=0)throw Is(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new qs(...t.split("."))._internalPath}catch{throw Is(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function Is(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(r||o)&&(c+=" (found",r&&(c+=` in field ${i}`),o&&(c+=` in document ${n}`),c+=")"),new oe(j.INVALID_ARGUMENT,a+s+c)}function du(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fu{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new vt(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new Kv(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Zs("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class Kv extends fu{data(){return super.data()}}function Zs(s,t){return typeof t=="string"?Ta(s,t):t instanceof qs?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Qv(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new oe(j.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class xa{}class pu extends xa{}function Jv(s,t,...e){let i=[];t instanceof xa&&i.push(t),i=i.concat(e),function(r){const o=r.filter(c=>c instanceof Ea).length,a=r.filter(c=>c instanceof Xs).length;if(o>1||o>0&&a>0)throw new oe(j.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class Xs extends pu{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new Xs(t,e,i)}_apply(t){const e=this._parse(t);return mu(t._query,e),new yn(t.firestore,t.converter,Co(t._query,e))}_parse(t){const e=wa(t.firestore);return function(r,o,a,c,h,d,l){let f;if(h.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new oe(j.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){wc(l,d);const g=[];for(const v of l)g.push(yc(c,r,v));f={arrayValue:{values:g}}}else f=yc(c,r,l)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||wc(l,d),f=Xv(a,o,l,d==="in"||d==="not-in");return mt.create(h,d,f)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function $v(s,t,e){const i=t,n=Zs("where",s);return Xs._create(n,i,e)}class Ea extends xa{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Ea(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:ci.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const c of a)mu(o,c),o=Co(o,c)}(t._query,e),new yn(t.firestore,t.converter,Co(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class ba extends pu{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new ba(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new oe(j.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new oe(j.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Sr(r,o)}(t._query,this._field,this._direction);return new yn(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new Xn(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function ey(s,t="asc"){const e=t,i=Zs("orderBy",s);return ba._create(i,e)}function yc(s,t,e){if(typeof(e=Ei(e))=="string"){if(e==="")throw new oe(j.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!mh(t)&&e.indexOf("/")!==-1)throw new oe(j.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(Ke.fromString(e));if(!me.isDocumentKey(i))throw new oe(j.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return Ml(s,new me(i))}if(e instanceof vt)return Ml(s,e._key);throw new oe(j.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ms(e)}.`)}function wc(s,t){if(!Array.isArray(s)||s.length===0)throw new oe(j.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function mu(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new oe(j.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new oe(j.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class ty{convertValue(t,e="none"){switch(Ki(t)){case 0:return null;case 1:return t.booleanValue;case 2:return lt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Yi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw Te(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return en(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[xs].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>lt(o.doubleValue));return new xi(r)}convertGeoPoint(t){return new Ti(lt(t.latitude),lt(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=Fs(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(xr(t));default:return null}}convertTimestamp(t){const e=Xi(t);return new $e(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=Ke.fromString(t);je(Vh(i),9688,{name:t});const n=new Er(i.get(1),i.get(3)),r=new me(i.popFirst(5));return n.isEqual(e)||Oi(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function iy(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class ur{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class fn extends fu{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new hs(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(Zs("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new oe(j.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=fn._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}fn._jsonSchemaVersion="firestore/documentSnapshot/1.0",fn._jsonSchema={type:gt("string",fn._jsonSchemaVersion),bundleSource:gt("string","DocumentSnapshot"),bundleName:gt("string"),bundle:gt("string")};class hs extends fn{data(t={}){return super.data(t)}}class Fn{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new ur(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new hs(this._firestore,this._userDataWriter,i.key,i,new ur(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new oe(j.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const c=new hs(n._firestore,n._userDataWriter,a.doc.key,a.doc,new ur(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:c,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const c=new hs(n._firestore,n._userDataWriter,a.doc.key,a.doc,new ur(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let h=-1,d=-1;return a.type!==0&&(h=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),d=o.indexOf(a.doc.key)),{type:ny(a.type),doc:c,oldIndex:h,newIndex:d}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new oe(j.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=Fn._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=Go.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function ny(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Te(61501,{type:s})}}Fn._jsonSchemaVersion="firestore/querySnapshot/1.0",Fn._jsonSchema={type:gt("string",Fn._jsonSchemaVersion),bundleSource:gt("string","QuerySnapshot"),bundleName:gt("string"),bundle:gt("string")};class gu extends ty{constructor(t){super(),this.firestore=t}convertBytes(t){return new ni(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new vt(this.firestore,null,e)}}function ry(s,t,e,...i){s=Wi(s,vt);const n=Wi(s.firestore,Un),r=wa(n);let o;return o=typeof(t=Ei(t))=="string"||t instanceof qs?Zv(r,"updateDoc",s._key,t,e,i):Gv(r,"updateDoc",s._key,t),Sa(n,[o.toMutation(s._key,li.exists(!0))])}function sy(s){return Sa(Wi(s.firestore,Un),[new ea(s._key,li.none())])}function oy(s,t){const e=Wi(s.firestore,Un),i=Bo(s),n=iy(s.converter,t);return Sa(e,[qv(wa(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,li.exists(!1))]).then(()=>i)}function ay(s,...t){var e,i,n;s=Ei(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||vc(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(vc(t[o])){const l=t[o];t[o]=(e=l.next)===null||e===void 0?void 0:e.bind(l),t[o+1]=(i=l.error)===null||i===void 0?void 0:i.bind(l),t[o+2]=(n=l.complete)===null||n===void 0?void 0:n.bind(l)}let c,h,d;if(s instanceof vt)h=Wi(s.firestore,Un),d=Jo(s._key.path),c={next:l=>{t[o]&&t[o](ly(h,s,l))},error:t[o+1],complete:t[o+2]};else{const l=Wi(s,yn);h=Wi(l.firestore,Un),d=l._query;const f=new gu(h);c={next:p=>{t[o]&&t[o](new Fn(h,f,l,p))},error:t[o+1],complete:t[o+2]},Qv(s._query)}return function(f,p,g,v){const w=new Fv(v),E=new gv(p,w,g);return f.asyncQueue.enqueueAndForget(async()=>dv(await cc(f),E)),()=>{w.Ou(),f.asyncQueue.enqueueAndForget(async()=>fv(await cc(f),E))}}(au(h),d,a,c)}function Sa(s,t){return function(i,n){const r=new dn;return i.asyncQueue.enqueueAndForget(async()=>Pv(await Bv(i),n,r)),r.promise}(au(s),t)}function ly(s,t,e){const i=e.docs.get(t._key),n=new gu(s);return new fn(s,n,t._key,i,new ur(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){qn=n})(Mp),ws(new wr("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new Un(new Gp(i.getProvider("auth-internal")),new Yp(o,i.getProvider("app-check-internal")),function(h,d){if(!Object.prototype.hasOwnProperty.apply(h.options,["projectId"]))throw new oe(j.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Er(h.options.projectId,d)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),kn(yl,wl,t),kn(yl,wl,"esm2017")})();var cy="firebase",hy="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */kn(cy,hy,"app");const uy={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},dy=zc(uy),is=Hv(dy);var fy=ee('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),py=ee("<div style=margin-bottom:12px;>"),my=ee('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;"> Add feedback'),gy=ee("<div style=margin-top:16px;>"),vy=ee('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),yy=ee('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),wy=ee('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),_y=ee("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;>  </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),Ty=ee("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),xy=ee('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function _c({updateId:s,updateTitle:t}){const[e,i]=de([]),[n,r]=de(""),[o,a]=de(null),[c,h]=de(""),[d,l]=de(!1),[f,p]=de(localStorage.getItem("feedbackAuthor")||"Deji"),[g,v]=de(!1),[w,E]=de(!1),[I,L]=de(!1);hn(()=>{const A=Jv(fc(is,"feedbacks"),$v("updateId","==",s),ey("timestamp","desc")),P=ay(A,M=>{const F=[];M.forEach(O=>{F.push({id:O.id,...O.data()})}),i(F)});return()=>P()});const N=async A=>{if(A.preventDefault(),!!n().trim()){l(!0);try{await oy(fc(is,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:f(),timestamp:new Date,edited:!1}),r(""),L(!1)}catch(P){console.error("Error adding feedback:",P)}l(!1)}},Z=async A=>{if(c().trim())try{await ry(Bo(is,"feedbacks",A),{text:c(),edited:!0,editedAt:new Date}),a(null),h("")}catch(P){console.error("Error editing feedback:",P)}},J=async A=>{if(confirm("Delete this feedback?"))try{await sy(Bo(is,"feedbacks",A))}catch(P){console.error("Error deleting feedback:",P)}},k=A=>{if(!A)return"";const P=A.toDate?A.toDate():new Date(A),F=new Date-P,O=Math.floor(F/(1e3*60*60));return O<1?"Just now":O<24?`${O} hour${O>1?"s":""} ago`:O<48?"Yesterday":P.toLocaleDateString()};return(()=>{var A=gy();return re(A,_e(Ue,{get when(){return e().length>0},get children(){var P=py();return re(P,_e(Wu,{get each(){return Pt(()=>!!w())()?e():e().slice(0,2)},children:M=>(()=>{var F=yy();return re(F,_e(Ue,{get when(){return o()===M.id},get fallback(){return[(()=>{var O=wy();return re(O,()=>M.text),O})(),(()=>{var O=_y(),D=O.firstChild,B=D.firstChild,Ce=D.nextSibling,Re=Ce.firstChild,He=Re.nextSibling;return re(D,()=>M.author,B),re(D,()=>k(M.timestamp),null),re(D,()=>M.edited&&" (edited)",null),Re.$$click=()=>{a(M.id),h(M.text)},He.$$click=()=>J(M.id),O})()]},get children(){var O=vy(),D=O.firstChild,B=D.nextSibling,Ce=B.firstChild,Re=Ce.nextSibling;return D.$$input=He=>h(He.target.value),Ce.$$click=()=>Z(M.id),Re.$$click=()=>{a(null),h("")},Je(()=>D.value=c()),O}})),F})()}),null),re(P,_e(Ue,{get when(){return e().length>2},get children(){var M=fy();return M.$$click=()=>E(!w()),re(M,(()=>{var F=Pt(()=>!!w());return()=>F()?` Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),M}}),null),P}}),null),re(A,_e(Ue,{get when(){return!I()},get fallback(){return(()=>{var P=xy(),M=P.firstChild,F=M.firstChild,O=F.firstChild,D=O.nextSibling,B=F.nextSibling,Ce=M.nextSibling,Re=Ce.firstChild,He=Re.nextSibling,ae=He.firstChild,Ee=ae.nextSibling;return re(D,f),B.$$click=()=>v(!g()),re(P,_e(Ue,{get when(){return g()},get children(){var Pe=Ty(),Et=Pe.firstChild,Ze=Et.firstChild,ne=Ze.nextSibling;return Ze.$$click=()=>{p("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),v(!1)},ne.$$click=()=>{p("Deji"),localStorage.setItem("feedbackAuthor","Deji"),v(!1)},Je(ct=>{var et=`background: ${f()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,Qt=`background: ${f()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return ct.e=rs(Ze,et,ct.e),ct.t=rs(ne,Qt,ct.t),ct},{e:void 0,t:void 0}),Pe}}),Ce),Ce.addEventListener("submit",N),Re.$$input=Pe=>r(Pe.target.value),re(ae,()=>d()?"Posting...":"Post"),Ee.$$click=()=>{L(!1),r("")},Je(Pe=>{var Et=d(),Ze=d()||!n().trim(),ne=`background: ${d()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${d()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return Et!==Pe.e&&(Re.disabled=Pe.e=Et),Ze!==Pe.t&&(ae.disabled=Pe.t=Ze),Pe.a=rs(ae,ne,Pe.a),Pe},{e:void 0,t:void 0,a:void 0}),Je(()=>Re.value=n()),P})()},get children(){var P=my();return P.$$click=()=>L(!0),P}}),null),A})()}jn(["click","input"]);var Ey=ee("<p><strong>What's improved:</strong> The circular spotlight effect in Apple Mode (Safari/iOS) now adapts much better to different hotspot shapes."),by=ee("<p><strong>What changed:</strong><br> Spotlights are now tighter and more focused around each hotspot (both mobile and desktop)<br> Better detection of when to use circles vs ellipses based on hotspot shape"),Sy=ee("<p><strong>The result:</strong> Whether a hotspot is round, tall, wide, or irregular, the spotlight should now feel more natural and better frame the content the use is exploring."),Py=ee("<p>Try clicking on different shaped hotspots - the spotlight should feel more consistent and purposeful now!"),Cy=ee("<p><strong>The issue:</strong> Some complex hotspots still extend outside the spotlight area after yesterday's improvements."),Ay=ee("<p><strong>Today's attempt:</strong> Since a single circular spotlight can't perfectly cover irregular shapes, I tried combining multiple circles at different positions to fill in the gaps. Unfortunately, Safari doesn't support this technique - it only displays one spotlight instead of blending them together like other browsers do."),Ry=ee("<p><strong>Next:</strong> Fine-tuning the spotlight sizing parameters to better fit each hotspot's unique shape."),Iy=ee("<p><strong>What's improved:</strong> The spotlight effect on Safari and iOS devices now much better matches the actual hotspot shapes, especially on desktop Safari!"),Dy=ee("<p><strong>Key changes:</strong><br> Spotlights now use elliptical shapes for elongated hotspots<br> Tighter, more precise spotlight coverage that follows the hotspot boundaries closely<br> Better visual consistency between the outline of the hotspot and the darkened area<br> Desktop Safari shows the most dramatic improvements, mobile iOS continues to be refined"),My=ee("<p><strong>Still fine-tuning:</strong> Some complex hotspots have small areas that peek slightly outside the spotlight. Mobile Safari needs additional optimization for the same precision as desktop."),ky=ee("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),Oy=ee('<p><strong>How it works:</strong><br> Type your feedback in the text box below any update<br> Click "Post Feedback" to send<br> Edit or delete your comments anytime<br> Everything syncs in real-time between us'),Fy=ee('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),Ly=ee("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),Vy=ee("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),By=ee("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),zy=ee("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),Hy=ee("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),Ny=ee("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),Uy=ee("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),jy=ee("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br> Uses radial gradient masks instead of polygon cutouts<br> Provides a circular/elliptical spotlight effect around hotspots<br> Maintains smooth 60 FPS performance on all iOS devices"),Wy=ee("<p><strong>What's Different:</strong><br> <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br> <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),qy=ee("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),Gy=ee("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),Zy=ee("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),Xy=ee("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br> iPhone (Safari & Chrome)<br> iPad (Safari & Chrome)<br> Mac (Safari only - Chrome works fine!)"),Yy=ee("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),Ky=ee("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),Qy=ee("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),Jy=ee("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),$y=ee("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),ew=ee("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),tw=ee(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now  `),iw=ee("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),nw=ee(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),rw=ee("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),sw=ee("<p>Hey Deji! "),ow=ee("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),aw=ee("<p>I totally relate to your potato mode confession  We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),lw=ee("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable  I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),cw=ee(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),hw=ee("<p>Looking forward to showing you the improvements!<br>- Leonard"),uw=ee('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),dw=ee(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn></button></div><div class=update-section style="background:linear-gradient(135deg, #1a1f2e 0%, #1e2330 100%);border:1px solid rgba(0, 136, 204, 0.3);margin-bottom:20px;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);"><h4 style="color:#0088cc;margin:0 0 16px 0;font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px;"><span style=font-size:20px;></span> Communication Update</h4><p style="color:rgba(255, 255, 255, 0.85);margin:0 0 20px 0;font-size:14px;line-height:1.6;">Our Upwork channel is no longer available. I've reached out via your business contacts and remain fully committed to your project.</p><div style="background:rgba(0, 136, 204, 0.1);padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;"><a href=https://t.me/LeonardCote target=_blank style="display:inline-flex;align-items:center;gap:8px;background:#0088cc;color:white;padding:10px 24px;border-radius:6px;text-decoration:none;font-weight:500;font-size:15px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0, 136, 204, 0.3);"><svg width=16 height=16 viewBox="0 0 24 24"fill=currentColor><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.223-.548.223l.188-2.85 5.18-4.68c.223-.198-.054-.308-.346-.111l-6.4 4.02-2.76-.918c-.6-.187-.612-.6.125-.89l10.782-4.156c.5-.18.94.12.78.88z"></path></svg>Message me on Telegram</a><p style="color:rgba(255, 255, 255, 0.6);margin:12px 0 0 0;font-size:13px;text-align:center;">or email: <a href=mailto:leonard.cote08@gmail.com style=color:#0088cc;text-decoration:none;>leonard.cote08@gmail.com</a></p></div><p style="color:rgba(255, 255, 255, 0.7);margin:0;font-size:13px;line-height:1.5;">The project continues to progress. All updates are posted here.<br><em style=opacity:0.8;>Platform details can be discussed when we connect.</em></p></div><div class=message-toggle><button class=toggle-btn>`),Tc=ee("<div class=update-section><h4> (<!>)"),fw=ee("<div class=app-container>"),pw=ee("<div class=loading-screen><p>Loading Interactive Art Diary...");function mw({onClose:s}){const[t,e]=de(!1),i=[{id:"spotlight-refinements-july7",date:"July 7",title:" Apple Mode Spotlight Improvements",content:[Ey(),by(),Sy(),Py()]},{id:"spotlight-coverage-july5",date:"July 5",title:" Working on Complete Hotspot Coverage for Safari/iOS",content:[Cy(),Ay(),Ry()]},{id:"spotlight-improvements-july4",date:"July 4",title:" Spotlight Effect Improvements for Safari/iOS",content:[Iy(),Dy(),My()]},{id:"feedback-system-july3",date:"July 3 - night",title:" New: Direct Feedback System",content:[ky(),Oy(),Fy(),Ly()]},{id:"border-experiment-july3",date:"July 3",title:" Border Experiment for Apple Mode",content:[Vy(),By(),zy(),Hy(),Ny()]},{id:"safari-solution-july2",date:"July 2",title:" Safari/iOS Spotlight Solution Implemented",content:[Uy(),jy(),Wy(),qy(),Gy()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:" Spotlight Effect - Browser Compatibility",content:[Zy(),Xy(),Yy(),Ky(),Qy(),Jy()]},{id:"zoom-speed-july1",date:"July 1",title:" Zoom Speed Control & Performance Update",content:[$y(),ew(),tw(),iw()]},{id:"performance-june30",date:"June 30",title:" Performance Breakthrough",content:nw()},{id:"focus-mode-june29",date:"June 29",title:" New Feature",content:rw()},{id:"personal-june28",date:"June 28",title:" Personal Message",content:[sw(),ow(),aw(),lw(),cw(),hw()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=dw(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=a.nextSibling,l=d.nextSibling,f=l.firstChild;return Rc(h,"click",s),re(o,()=>n.map(p=>(()=>{var g=Tc(),v=g.firstChild,w=v.firstChild,E=w.nextSibling;return E.nextSibling,re(v,()=>p.title,w),re(v,()=>p.date,E),re(g,()=>p.content,null),re(g,_e(_c,{get updateId(){return p.id},get updateTitle(){return p.title}}),null),g})()),l),f.$$click=()=>e(!t()),re(f,()=>t()?" Hide previous updates":"+ Show previous updates"),re(o,_e(Ue,{get when(){return t()},get children(){var p=uw();return p.firstChild,re(p,()=>r.map(g=>(()=>{var v=Tc(),w=v.firstChild,E=w.firstChild,I=E.nextSibling;return I.nextSibling,re(w,()=>g.title,E),re(w,()=>g.date,I),re(v,()=>g.content,null),re(v,_e(_c,{get updateId(){return g.id},get updateTitle(){return g.title}}),null),v})()),null),p}}),null),o})()}function gw(){const[s,t]=de(!1),[e]=de("zebra"),[i,n]=de(!0),r=()=>{n(!1)};return Ho(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var o=fw();return re(o,(()=>{var a=Pt(()=>!!i());return()=>a()&&_e(mw,{onClose:r})})(),null),re(o,(()=>{var a=Pt(()=>!!s());return()=>a()?_e(of,{get artworkId(){return e()}}):pw()})(),null),o})()}jn(["click"]);const vw=document.getElementById("root");Gu(()=>_e(gw,{}),vw);
