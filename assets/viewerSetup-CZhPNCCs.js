const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/viewerEventHandlers-CnqD_1Bt.js","assets/main-BkAym_hz.js","assets/main-BhNn0mhR.css"])))=>i.map(i=>d[i]);
var we=Object.defineProperty;var ve=(m,e,t)=>e in m?we(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var W=(m,e,t)=>ve(m,typeof e!="symbol"?e+"":e,t);import{c as H,i as Y,O as P,_ as U,g as ye,a as X,b as N,d as me,e as Te,r as de}from"./main-BkAym_hz.js";var F={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(m){(function(){var e=function(){this.init()};e.prototype={init:function(){var s=this||t;return s._counter=1e3,s._html5AudioPool=[],s.html5PoolSize=10,s._codecs={},s._howls=[],s._muted=!1,s._volume=1,s._canPlayEvent="canplaythrough",s._navigator=typeof window<"u"&&window.navigator?window.navigator:null,s.masterGain=null,s.noAudio=!1,s.usingWebAudio=!0,s.autoSuspend=!0,s.ctx=null,s.autoUnlock=!0,s._setup(),s},volume:function(s){var o=this||t;if(s=parseFloat(s),o.ctx||p(),typeof s<"u"&&s>=0&&s<=1){if(o._volume=s,o._muted)return o;o.usingWebAudio&&o.masterGain.gain.setValueAtTime(s,t.ctx.currentTime);for(var c=0;c<o._howls.length;c++)if(!o._howls[c]._webAudio)for(var u=o._howls[c]._getSoundIds(),d=0;d<u.length;d++){var w=o._howls[c]._soundById(u[d]);w&&w._node&&(w._node.volume=w._volume*s)}return o}return o._volume},mute:function(s){var o=this||t;o.ctx||p(),o._muted=s,o.usingWebAudio&&o.masterGain.gain.setValueAtTime(s?0:o._volume,t.ctx.currentTime);for(var c=0;c<o._howls.length;c++)if(!o._howls[c]._webAudio)for(var u=o._howls[c]._getSoundIds(),d=0;d<u.length;d++){var w=o._howls[c]._soundById(u[d]);w&&w._node&&(w._node.muted=s?!0:w._muted)}return o},stop:function(){for(var s=this||t,o=0;o<s._howls.length;o++)s._howls[o].stop();return s},unload:function(){for(var s=this||t,o=s._howls.length-1;o>=0;o--)s._howls[o].unload();return s.usingWebAudio&&s.ctx&&typeof s.ctx.close<"u"&&(s.ctx.close(),s.ctx=null,p()),s},codecs:function(s){return(this||t)._codecs[s.replace(/^x-/,"")]},_setup:function(){var s=this||t;if(s.state=s.ctx&&s.ctx.state||"suspended",s._autoSuspend(),!s.usingWebAudio)if(typeof Audio<"u")try{var o=new Audio;typeof o.oncanplaythrough>"u"&&(s._canPlayEvent="canplay")}catch{s.noAudio=!0}else s.noAudio=!0;try{var o=new Audio;o.muted&&(s.noAudio=!0)}catch{}return s.noAudio||s._setupCodecs(),s},_setupCodecs:function(){var s=this||t,o=null;try{o=typeof Audio<"u"?new Audio:null}catch{return s}if(!o||typeof o.canPlayType!="function")return s;var c=o.canPlayType("audio/mpeg;").replace(/^no$/,""),u=s._navigator?s._navigator.userAgent:"",d=u.match(/OPR\/(\d+)/g),w=d&&parseInt(d[0].split("/")[1],10)<33,f=u.indexOf("Safari")!==-1&&u.indexOf("Chrome")===-1,v=u.match(/Version\/(.*?) /),T=f&&v&&parseInt(v[1],10)<15;return s._codecs={mp3:!!(!w&&(c||o.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!c,opus:!!o.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(o.canPlayType('audio/wav; codecs="1"')||o.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!o.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!o.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(o.canPlayType("audio/x-m4a;")||o.canPlayType("audio/m4a;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(o.canPlayType("audio/x-m4b;")||o.canPlayType("audio/m4b;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(o.canPlayType("audio/x-mp4;")||o.canPlayType("audio/mp4;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!T&&o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!T&&o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!o.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(o.canPlayType("audio/x-flac;")||o.canPlayType("audio/flac;")).replace(/^no$/,"")},s},_unlockAudio:function(){var s=this||t;if(!(s._audioUnlocked||!s.ctx)){s._audioUnlocked=!1,s.autoUnlock=!1,!s._mobileUnloaded&&s.ctx.sampleRate!==44100&&(s._mobileUnloaded=!0,s.unload()),s._scratchBuffer=s.ctx.createBuffer(1,1,22050);var o=function(c){for(;s._html5AudioPool.length<s.html5PoolSize;)try{var u=new Audio;u._unlocked=!0,s._releaseHtml5Audio(u)}catch{s.noAudio=!0;break}for(var d=0;d<s._howls.length;d++)if(!s._howls[d]._webAudio)for(var w=s._howls[d]._getSoundIds(),f=0;f<w.length;f++){var v=s._howls[d]._soundById(w[f]);v&&v._node&&!v._node._unlocked&&(v._node._unlocked=!0,v._node.load())}s._autoResume();var T=s.ctx.createBufferSource();T.buffer=s._scratchBuffer,T.connect(s.ctx.destination),typeof T.start>"u"?T.noteOn(0):T.start(0),typeof s.ctx.resume=="function"&&s.ctx.resume(),T.onended=function(){T.disconnect(0),s._audioUnlocked=!0,document.removeEventListener("touchstart",o,!0),document.removeEventListener("touchend",o,!0),document.removeEventListener("click",o,!0),document.removeEventListener("keydown",o,!0);for(var _=0;_<s._howls.length;_++)s._howls[_]._emit("unlock")}};return document.addEventListener("touchstart",o,!0),document.addEventListener("touchend",o,!0),document.addEventListener("click",o,!0),document.addEventListener("keydown",o,!0),s}},_obtainHtml5Audio:function(){var s=this||t;if(s._html5AudioPool.length)return s._html5AudioPool.pop();var o=new Audio().play();return o&&typeof Promise<"u"&&(o instanceof Promise||typeof o.then=="function")&&o.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(s){var o=this||t;return s._unlocked&&o._html5AudioPool.push(s),o},_autoSuspend:function(){var s=this;if(!(!s.autoSuspend||!s.ctx||typeof s.ctx.suspend>"u"||!t.usingWebAudio)){for(var o=0;o<s._howls.length;o++)if(s._howls[o]._webAudio){for(var c=0;c<s._howls[o]._sounds.length;c++)if(!s._howls[o]._sounds[c]._paused)return s}return s._suspendTimer&&clearTimeout(s._suspendTimer),s._suspendTimer=setTimeout(function(){if(s.autoSuspend){s._suspendTimer=null,s.state="suspending";var u=function(){s.state="suspended",s._resumeAfterSuspend&&(delete s._resumeAfterSuspend,s._autoResume())};s.ctx.suspend().then(u,u)}},3e4),s}},_autoResume:function(){var s=this;if(!(!s.ctx||typeof s.ctx.resume>"u"||!t.usingWebAudio))return s.state==="running"&&s.ctx.state!=="interrupted"&&s._suspendTimer?(clearTimeout(s._suspendTimer),s._suspendTimer=null):s.state==="suspended"||s.state==="running"&&s.ctx.state==="interrupted"?(s.ctx.resume().then(function(){s.state="running";for(var o=0;o<s._howls.length;o++)s._howls[o]._emit("resume")}),s._suspendTimer&&(clearTimeout(s._suspendTimer),s._suspendTimer=null)):s.state==="suspending"&&(s._resumeAfterSuspend=!0),s}};var t=new e,i=function(s){var o=this;if(!s.src||s.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}o.init(s)};i.prototype={init:function(s){var o=this;return t.ctx||p(),o._autoplay=s.autoplay||!1,o._format=typeof s.format!="string"?s.format:[s.format],o._html5=s.html5||!1,o._muted=s.mute||!1,o._loop=s.loop||!1,o._pool=s.pool||5,o._preload=typeof s.preload=="boolean"||s.preload==="metadata"?s.preload:!0,o._rate=s.rate||1,o._sprite=s.sprite||{},o._src=typeof s.src!="string"?s.src:[s.src],o._volume=s.volume!==void 0?s.volume:1,o._xhr={method:s.xhr&&s.xhr.method?s.xhr.method:"GET",headers:s.xhr&&s.xhr.headers?s.xhr.headers:null,withCredentials:s.xhr&&s.xhr.withCredentials?s.xhr.withCredentials:!1},o._duration=0,o._state="unloaded",o._sounds=[],o._endTimers={},o._queue=[],o._playLock=!1,o._onend=s.onend?[{fn:s.onend}]:[],o._onfade=s.onfade?[{fn:s.onfade}]:[],o._onload=s.onload?[{fn:s.onload}]:[],o._onloaderror=s.onloaderror?[{fn:s.onloaderror}]:[],o._onplayerror=s.onplayerror?[{fn:s.onplayerror}]:[],o._onpause=s.onpause?[{fn:s.onpause}]:[],o._onplay=s.onplay?[{fn:s.onplay}]:[],o._onstop=s.onstop?[{fn:s.onstop}]:[],o._onmute=s.onmute?[{fn:s.onmute}]:[],o._onvolume=s.onvolume?[{fn:s.onvolume}]:[],o._onrate=s.onrate?[{fn:s.onrate}]:[],o._onseek=s.onseek?[{fn:s.onseek}]:[],o._onunlock=s.onunlock?[{fn:s.onunlock}]:[],o._onresume=[],o._webAudio=t.usingWebAudio&&!o._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(o),o._autoplay&&o._queue.push({event:"play",action:function(){o.play()}}),o._preload&&o._preload!=="none"&&o.load(),o},load:function(){var s=this,o=null;if(t.noAudio){s._emit("loaderror",null,"No audio support.");return}typeof s._src=="string"&&(s._src=[s._src]);for(var c=0;c<s._src.length;c++){var u,d;if(s._format&&s._format[c])u=s._format[c];else{if(d=s._src[c],typeof d!="string"){s._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}u=/^data:audio\/([^;,]+);/i.exec(d),u||(u=/\.([^.]+)$/.exec(d.split("?",1)[0])),u&&(u=u[1].toLowerCase())}if(u||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),u&&t.codecs(u)){o=s._src[c];break}}if(!o){s._emit("loaderror",null,"No codec support for selected audio sources.");return}return s._src=o,s._state="loading",window.location.protocol==="https:"&&o.slice(0,5)==="http:"&&(s._html5=!0,s._webAudio=!1),new r(s),s._webAudio&&a(s),s},play:function(s,o){var c=this,u=null;if(typeof s=="number")u=s,s=null;else{if(typeof s=="string"&&c._state==="loaded"&&!c._sprite[s])return null;if(typeof s>"u"&&(s="__default",!c._playLock)){for(var d=0,w=0;w<c._sounds.length;w++)c._sounds[w]._paused&&!c._sounds[w]._ended&&(d++,u=c._sounds[w]._id);d===1?s=null:u=null}}var f=u?c._soundById(u):c._inactiveSound();if(!f)return null;if(u&&!s&&(s=f._sprite||"__default"),c._state!=="loaded"){f._sprite=s,f._ended=!1;var v=f._id;return c._queue.push({event:"play",action:function(){c.play(v)}}),v}if(u&&!f._paused)return o||c._loadQueue("play"),f._id;c._webAudio&&t._autoResume();var T=Math.max(0,f._seek>0?f._seek:c._sprite[s][0]/1e3),_=Math.max(0,(c._sprite[s][0]+c._sprite[s][1])/1e3-T),x=_*1e3/Math.abs(f._rate),A=c._sprite[s][0]/1e3,M=(c._sprite[s][0]+c._sprite[s][1])/1e3;f._sprite=s,f._ended=!1;var C=function(){f._paused=!1,f._seek=T,f._start=A,f._stop=M,f._loop=!!(f._loop||c._sprite[s][2])};if(T>=M){c._ended(f);return}var b=f._node;if(c._webAudio){var E=function(){c._playLock=!1,C(),c._refreshBuffer(f);var z=f._muted||c._muted?0:f._volume;b.gain.setValueAtTime(z,t.ctx.currentTime),f._playStart=t.ctx.currentTime,typeof b.bufferSource.start>"u"?f._loop?b.bufferSource.noteGrainOn(0,T,86400):b.bufferSource.noteGrainOn(0,T,_):f._loop?b.bufferSource.start(0,T,86400):b.bufferSource.start(0,T,_),x!==1/0&&(c._endTimers[f._id]=setTimeout(c._ended.bind(c,f),x)),o||setTimeout(function(){c._emit("play",f._id),c._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?E():(c._playLock=!0,c.once("resume",E),c._clearTimer(f._id))}else{var k=function(){b.currentTime=T,b.muted=f._muted||c._muted||t._muted||b.muted,b.volume=f._volume*t.volume(),b.playbackRate=f._rate;try{var z=b.play();if(z&&typeof Promise<"u"&&(z instanceof Promise||typeof z.then=="function")?(c._playLock=!0,C(),z.then(function(){c._playLock=!1,b._unlocked=!0,o?c._loadQueue():c._emit("play",f._id)}).catch(function(){c._playLock=!1,c._emit("playerror",f._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),f._ended=!0,f._paused=!0})):o||(c._playLock=!1,C(),c._emit("play",f._id)),b.playbackRate=f._rate,b.paused){c._emit("playerror",f._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}s!=="__default"||f._loop?c._endTimers[f._id]=setTimeout(c._ended.bind(c,f),x):(c._endTimers[f._id]=function(){c._ended(f),b.removeEventListener("ended",c._endTimers[f._id],!1)},b.addEventListener("ended",c._endTimers[f._id],!1))}catch($){c._emit("playerror",f._id,$)}};b.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(b.src=c._src,b.load());var D=window&&window.ejecta||!b.readyState&&t._navigator.isCocoonJS;if(b.readyState>=3||D)k();else{c._playLock=!0,c._state="loading";var R=function(){c._state="loaded",k(),b.removeEventListener(t._canPlayEvent,R,!1)};b.addEventListener(t._canPlayEvent,R,!1),c._clearTimer(f._id)}}return f._id},pause:function(s){var o=this;if(o._state!=="loaded"||o._playLock)return o._queue.push({event:"pause",action:function(){o.pause(s)}}),o;for(var c=o._getSoundIds(s),u=0;u<c.length;u++){o._clearTimer(c[u]);var d=o._soundById(c[u]);if(d&&!d._paused&&(d._seek=o.seek(c[u]),d._rateSeek=0,d._paused=!0,o._stopFade(c[u]),d._node))if(o._webAudio){if(!d._node.bufferSource)continue;typeof d._node.bufferSource.stop>"u"?d._node.bufferSource.noteOff(0):d._node.bufferSource.stop(0),o._cleanBuffer(d._node)}else(!isNaN(d._node.duration)||d._node.duration===1/0)&&d._node.pause();arguments[1]||o._emit("pause",d?d._id:null)}return o},stop:function(s,o){var c=this;if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"stop",action:function(){c.stop(s)}}),c;for(var u=c._getSoundIds(s),d=0;d<u.length;d++){c._clearTimer(u[d]);var w=c._soundById(u[d]);w&&(w._seek=w._start||0,w._rateSeek=0,w._paused=!0,w._ended=!0,c._stopFade(u[d]),w._node&&(c._webAudio?w._node.bufferSource&&(typeof w._node.bufferSource.stop>"u"?w._node.bufferSource.noteOff(0):w._node.bufferSource.stop(0),c._cleanBuffer(w._node)):(!isNaN(w._node.duration)||w._node.duration===1/0)&&(w._node.currentTime=w._start||0,w._node.pause(),w._node.duration===1/0&&c._clearSound(w._node))),o||c._emit("stop",w._id))}return c},mute:function(s,o){var c=this;if(c._state!=="loaded"||c._playLock)return c._queue.push({event:"mute",action:function(){c.mute(s,o)}}),c;if(typeof o>"u")if(typeof s=="boolean")c._muted=s;else return c._muted;for(var u=c._getSoundIds(o),d=0;d<u.length;d++){var w=c._soundById(u[d]);w&&(w._muted=s,w._interval&&c._stopFade(w._id),c._webAudio&&w._node?w._node.gain.setValueAtTime(s?0:w._volume,t.ctx.currentTime):w._node&&(w._node.muted=t._muted?!0:s),c._emit("mute",w._id))}return c},volume:function(){var s=this,o=arguments,c,u;if(o.length===0)return s._volume;if(o.length===1||o.length===2&&typeof o[1]>"u"){var d=s._getSoundIds(),w=d.indexOf(o[0]);w>=0?u=parseInt(o[0],10):c=parseFloat(o[0])}else o.length>=2&&(c=parseFloat(o[0]),u=parseInt(o[1],10));var f;if(typeof c<"u"&&c>=0&&c<=1){if(s._state!=="loaded"||s._playLock)return s._queue.push({event:"volume",action:function(){s.volume.apply(s,o)}}),s;typeof u>"u"&&(s._volume=c),u=s._getSoundIds(u);for(var v=0;v<u.length;v++)f=s._soundById(u[v]),f&&(f._volume=c,o[2]||s._stopFade(u[v]),s._webAudio&&f._node&&!f._muted?f._node.gain.setValueAtTime(c,t.ctx.currentTime):f._node&&!f._muted&&(f._node.volume=c*t.volume()),s._emit("volume",f._id))}else return f=u?s._soundById(u):s._sounds[0],f?f._volume:0;return s},fade:function(s,o,c,u){var d=this;if(d._state!=="loaded"||d._playLock)return d._queue.push({event:"fade",action:function(){d.fade(s,o,c,u)}}),d;s=Math.min(Math.max(0,parseFloat(s)),1),o=Math.min(Math.max(0,parseFloat(o)),1),c=parseFloat(c),d.volume(s,u);for(var w=d._getSoundIds(u),f=0;f<w.length;f++){var v=d._soundById(w[f]);if(v){if(u||d._stopFade(w[f]),d._webAudio&&!v._muted){var T=t.ctx.currentTime,_=T+c/1e3;v._volume=s,v._node.gain.setValueAtTime(s,T),v._node.gain.linearRampToValueAtTime(o,_)}d._startFadeInterval(v,s,o,c,w[f],typeof u>"u")}}return d},_startFadeInterval:function(s,o,c,u,d,w){var f=this,v=o,T=c-o,_=Math.abs(T/.01),x=Math.max(4,_>0?u/_:u),A=Date.now();s._fadeTo=c,s._interval=setInterval(function(){var M=(Date.now()-A)/u;A=Date.now(),v+=T*M,v=Math.round(v*100)/100,T<0?v=Math.max(c,v):v=Math.min(c,v),f._webAudio?s._volume=v:f.volume(v,s._id,!0),w&&(f._volume=v),(c<o&&v<=c||c>o&&v>=c)&&(clearInterval(s._interval),s._interval=null,s._fadeTo=null,f.volume(c,s._id),f._emit("fade",s._id))},x)},_stopFade:function(s){var o=this,c=o._soundById(s);return c&&c._interval&&(o._webAudio&&c._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(c._interval),c._interval=null,o.volume(c._fadeTo,s),c._fadeTo=null,o._emit("fade",s)),o},loop:function(){var s=this,o=arguments,c,u,d;if(o.length===0)return s._loop;if(o.length===1)if(typeof o[0]=="boolean")c=o[0],s._loop=c;else return d=s._soundById(parseInt(o[0],10)),d?d._loop:!1;else o.length===2&&(c=o[0],u=parseInt(o[1],10));for(var w=s._getSoundIds(u),f=0;f<w.length;f++)d=s._soundById(w[f]),d&&(d._loop=c,s._webAudio&&d._node&&d._node.bufferSource&&(d._node.bufferSource.loop=c,c&&(d._node.bufferSource.loopStart=d._start||0,d._node.bufferSource.loopEnd=d._stop,s.playing(w[f])&&(s.pause(w[f],!0),s.play(w[f],!0)))));return s},rate:function(){var s=this,o=arguments,c,u;if(o.length===0)u=s._sounds[0]._id;else if(o.length===1){var d=s._getSoundIds(),w=d.indexOf(o[0]);w>=0?u=parseInt(o[0],10):c=parseFloat(o[0])}else o.length===2&&(c=parseFloat(o[0]),u=parseInt(o[1],10));var f;if(typeof c=="number"){if(s._state!=="loaded"||s._playLock)return s._queue.push({event:"rate",action:function(){s.rate.apply(s,o)}}),s;typeof u>"u"&&(s._rate=c),u=s._getSoundIds(u);for(var v=0;v<u.length;v++)if(f=s._soundById(u[v]),f){s.playing(u[v])&&(f._rateSeek=s.seek(u[v]),f._playStart=s._webAudio?t.ctx.currentTime:f._playStart),f._rate=c,s._webAudio&&f._node&&f._node.bufferSource?f._node.bufferSource.playbackRate.setValueAtTime(c,t.ctx.currentTime):f._node&&(f._node.playbackRate=c);var T=s.seek(u[v]),_=(s._sprite[f._sprite][0]+s._sprite[f._sprite][1])/1e3-T,x=_*1e3/Math.abs(f._rate);(s._endTimers[u[v]]||!f._paused)&&(s._clearTimer(u[v]),s._endTimers[u[v]]=setTimeout(s._ended.bind(s,f),x)),s._emit("rate",f._id)}}else return f=s._soundById(u),f?f._rate:s._rate;return s},seek:function(){var s=this,o=arguments,c,u;if(o.length===0)s._sounds.length&&(u=s._sounds[0]._id);else if(o.length===1){var d=s._getSoundIds(),w=d.indexOf(o[0]);w>=0?u=parseInt(o[0],10):s._sounds.length&&(u=s._sounds[0]._id,c=parseFloat(o[0]))}else o.length===2&&(c=parseFloat(o[0]),u=parseInt(o[1],10));if(typeof u>"u")return 0;if(typeof c=="number"&&(s._state!=="loaded"||s._playLock))return s._queue.push({event:"seek",action:function(){s.seek.apply(s,o)}}),s;var f=s._soundById(u);if(f)if(typeof c=="number"&&c>=0){var v=s.playing(u);v&&s.pause(u,!0),f._seek=c,f._ended=!1,s._clearTimer(u),!s._webAudio&&f._node&&!isNaN(f._node.duration)&&(f._node.currentTime=c);var T=function(){v&&s.play(u,!0),s._emit("seek",u)};if(v&&!s._webAudio){var _=function(){s._playLock?setTimeout(_,0):T()};setTimeout(_,0)}else T()}else if(s._webAudio){var x=s.playing(u)?t.ctx.currentTime-f._playStart:0,A=f._rateSeek?f._rateSeek-f._seek:0;return f._seek+(A+x*Math.abs(f._rate))}else return f._node.currentTime;return s},playing:function(s){var o=this;if(typeof s=="number"){var c=o._soundById(s);return c?!c._paused:!1}for(var u=0;u<o._sounds.length;u++)if(!o._sounds[u]._paused)return!0;return!1},duration:function(s){var o=this,c=o._duration,u=o._soundById(s);return u&&(c=o._sprite[u._sprite][1]/1e3),c},state:function(){return this._state},unload:function(){for(var s=this,o=s._sounds,c=0;c<o.length;c++)o[c]._paused||s.stop(o[c]._id),s._webAudio||(s._clearSound(o[c]._node),o[c]._node.removeEventListener("error",o[c]._errorFn,!1),o[c]._node.removeEventListener(t._canPlayEvent,o[c]._loadFn,!1),o[c]._node.removeEventListener("ended",o[c]._endFn,!1),t._releaseHtml5Audio(o[c]._node)),delete o[c]._node,s._clearTimer(o[c]._id);var u=t._howls.indexOf(s);u>=0&&t._howls.splice(u,1);var d=!0;for(c=0;c<t._howls.length;c++)if(t._howls[c]._src===s._src||s._src.indexOf(t._howls[c]._src)>=0){d=!1;break}return n&&d&&delete n[s._src],t.noAudio=!1,s._state="unloaded",s._sounds=[],s=null,null},on:function(s,o,c,u){var d=this,w=d["_on"+s];return typeof o=="function"&&w.push(u?{id:c,fn:o,once:u}:{id:c,fn:o}),d},off:function(s,o,c){var u=this,d=u["_on"+s],w=0;if(typeof o=="number"&&(c=o,o=null),o||c)for(w=0;w<d.length;w++){var f=c===d[w].id;if(o===d[w].fn&&f||!o&&f){d.splice(w,1);break}}else if(s)u["_on"+s]=[];else{var v=Object.keys(u);for(w=0;w<v.length;w++)v[w].indexOf("_on")===0&&Array.isArray(u[v[w]])&&(u[v[w]]=[])}return u},once:function(s,o,c){var u=this;return u.on(s,o,c,1),u},_emit:function(s,o,c){for(var u=this,d=u["_on"+s],w=d.length-1;w>=0;w--)(!d[w].id||d[w].id===o||s==="load")&&(setTimeout((function(f){f.call(this,o,c)}).bind(u,d[w].fn),0),d[w].once&&u.off(s,d[w].fn,d[w].id));return u._loadQueue(s),u},_loadQueue:function(s){var o=this;if(o._queue.length>0){var c=o._queue[0];c.event===s&&(o._queue.shift(),o._loadQueue()),s||c.action()}return o},_ended:function(s){var o=this,c=s._sprite;if(!o._webAudio&&s._node&&!s._node.paused&&!s._node.ended&&s._node.currentTime<s._stop)return setTimeout(o._ended.bind(o,s),100),o;var u=!!(s._loop||o._sprite[c][2]);if(o._emit("end",s._id),!o._webAudio&&u&&o.stop(s._id,!0).play(s._id),o._webAudio&&u){o._emit("play",s._id),s._seek=s._start||0,s._rateSeek=0,s._playStart=t.ctx.currentTime;var d=(s._stop-s._start)*1e3/Math.abs(s._rate);o._endTimers[s._id]=setTimeout(o._ended.bind(o,s),d)}return o._webAudio&&!u&&(s._paused=!0,s._ended=!0,s._seek=s._start||0,s._rateSeek=0,o._clearTimer(s._id),o._cleanBuffer(s._node),t._autoSuspend()),!o._webAudio&&!u&&o.stop(s._id,!0),o},_clearTimer:function(s){var o=this;if(o._endTimers[s]){if(typeof o._endTimers[s]!="function")clearTimeout(o._endTimers[s]);else{var c=o._soundById(s);c&&c._node&&c._node.removeEventListener("ended",o._endTimers[s],!1)}delete o._endTimers[s]}return o},_soundById:function(s){for(var o=this,c=0;c<o._sounds.length;c++)if(s===o._sounds[c]._id)return o._sounds[c];return null},_inactiveSound:function(){var s=this;s._drain();for(var o=0;o<s._sounds.length;o++)if(s._sounds[o]._ended)return s._sounds[o].reset();return new r(s)},_drain:function(){var s=this,o=s._pool,c=0,u=0;if(!(s._sounds.length<o)){for(u=0;u<s._sounds.length;u++)s._sounds[u]._ended&&c++;for(u=s._sounds.length-1;u>=0;u--){if(c<=o)return;s._sounds[u]._ended&&(s._webAudio&&s._sounds[u]._node&&s._sounds[u]._node.disconnect(0),s._sounds.splice(u,1),c--)}}},_getSoundIds:function(s){var o=this;if(typeof s>"u"){for(var c=[],u=0;u<o._sounds.length;u++)c.push(o._sounds[u]._id);return c}else return[s]},_refreshBuffer:function(s){var o=this;return s._node.bufferSource=t.ctx.createBufferSource(),s._node.bufferSource.buffer=n[o._src],s._panner?s._node.bufferSource.connect(s._panner):s._node.bufferSource.connect(s._node),s._node.bufferSource.loop=s._loop,s._loop&&(s._node.bufferSource.loopStart=s._start||0,s._node.bufferSource.loopEnd=s._stop||0),s._node.bufferSource.playbackRate.setValueAtTime(s._rate,t.ctx.currentTime),o},_cleanBuffer:function(s){var o=this,c=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!s.bufferSource)return o;if(t._scratchBuffer&&s.bufferSource&&(s.bufferSource.onended=null,s.bufferSource.disconnect(0),c))try{s.bufferSource.buffer=t._scratchBuffer}catch{}return s.bufferSource=null,o},_clearSound:function(s){var o=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);o||(s.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var r=function(s){this._parent=s,this.init()};r.prototype={init:function(){var s=this,o=s._parent;return s._muted=o._muted,s._loop=o._loop,s._volume=o._volume,s._rate=o._rate,s._seek=0,s._paused=!0,s._ended=!0,s._sprite="__default",s._id=++t._counter,o._sounds.push(s),s.create(),s},create:function(){var s=this,o=s._parent,c=t._muted||s._muted||s._parent._muted?0:s._volume;return o._webAudio?(s._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),s._node.gain.setValueAtTime(c,t.ctx.currentTime),s._node.paused=!0,s._node.connect(t.masterGain)):t.noAudio||(s._node=t._obtainHtml5Audio(),s._errorFn=s._errorListener.bind(s),s._node.addEventListener("error",s._errorFn,!1),s._loadFn=s._loadListener.bind(s),s._node.addEventListener(t._canPlayEvent,s._loadFn,!1),s._endFn=s._endListener.bind(s),s._node.addEventListener("ended",s._endFn,!1),s._node.src=o._src,s._node.preload=o._preload===!0?"auto":o._preload,s._node.volume=c*t.volume(),s._node.load()),s},reset:function(){var s=this,o=s._parent;return s._muted=o._muted,s._loop=o._loop,s._volume=o._volume,s._rate=o._rate,s._seek=0,s._rateSeek=0,s._paused=!0,s._ended=!0,s._sprite="__default",s._id=++t._counter,s},_errorListener:function(){var s=this;s._parent._emit("loaderror",s._id,s._node.error?s._node.error.code:0),s._node.removeEventListener("error",s._errorFn,!1)},_loadListener:function(){var s=this,o=s._parent;o._duration=Math.ceil(s._node.duration*10)/10,Object.keys(o._sprite).length===0&&(o._sprite={__default:[0,o._duration*1e3]}),o._state!=="loaded"&&(o._state="loaded",o._emit("load"),o._loadQueue()),s._node.removeEventListener(t._canPlayEvent,s._loadFn,!1)},_endListener:function(){var s=this,o=s._parent;o._duration===1/0&&(o._duration=Math.ceil(s._node.duration*10)/10,o._sprite.__default[1]===1/0&&(o._sprite.__default[1]=o._duration*1e3),o._ended(s)),s._node.removeEventListener("ended",s._endFn,!1)}};var n={},a=function(s){var o=s._src;if(n[o]){s._duration=n[o].duration,g(s);return}if(/^data:[^;]+;base64,/.test(o)){for(var c=atob(o.split(",")[1]),u=new Uint8Array(c.length),d=0;d<c.length;++d)u[d]=c.charCodeAt(d);h(u.buffer,s)}else{var w=new XMLHttpRequest;w.open(s._xhr.method,o,!0),w.withCredentials=s._xhr.withCredentials,w.responseType="arraybuffer",s._xhr.headers&&Object.keys(s._xhr.headers).forEach(function(f){w.setRequestHeader(f,s._xhr.headers[f])}),w.onload=function(){var f=(w.status+"")[0];if(f!=="0"&&f!=="2"&&f!=="3"){s._emit("loaderror",null,"Failed loading audio file with status: "+w.status+".");return}h(w.response,s)},w.onerror=function(){s._webAudio&&(s._html5=!0,s._webAudio=!1,s._sounds=[],delete n[o],s.load())},l(w)}},l=function(s){try{s.send()}catch{s.onerror()}},h=function(s,o){var c=function(){o._emit("loaderror",null,"Decoding audio data failed.")},u=function(d){d&&o._sounds.length>0?(n[o._src]=d,g(o,d)):c()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(s).then(u).catch(c):t.ctx.decodeAudioData(s,u,c)},g=function(s,o){o&&!s._duration&&(s._duration=o.duration),Object.keys(s._sprite).length===0&&(s._sprite={__default:[0,s._duration*1e3]}),s._state!=="loaded"&&(s._state="loaded",s._emit("load"),s._loadQueue())},p=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var s=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),o=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),c=o?parseInt(o[1],10):null;if(s&&c&&c<9){var u=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!u&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};m.Howler=t,m.Howl=i,typeof H<"u"?(H.HowlerGlobal=e,H.Howler=t,H.Howl=i,H.Sound=r):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=i,window.Sound=r)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var r=i._howls.length-1;r>=0;r--)i._howls[r].stereo(t);return i},HowlerGlobal.prototype.pos=function(t,i,r){var n=this;if(!n.ctx||!n.ctx.listener)return n;if(i=typeof i!="number"?n._pos[1]:i,r=typeof r!="number"?n._pos[2]:r,typeof t=="number")n._pos=[t,i,r],typeof n.ctx.listener.positionX<"u"?(n.ctx.listener.positionX.setTargetAtTime(n._pos[0],Howler.ctx.currentTime,.1),n.ctx.listener.positionY.setTargetAtTime(n._pos[1],Howler.ctx.currentTime,.1),n.ctx.listener.positionZ.setTargetAtTime(n._pos[2],Howler.ctx.currentTime,.1)):n.ctx.listener.setPosition(n._pos[0],n._pos[1],n._pos[2]);else return n._pos;return n},HowlerGlobal.prototype.orientation=function(t,i,r,n,a,l){var h=this;if(!h.ctx||!h.ctx.listener)return h;var g=h._orientation;if(i=typeof i!="number"?g[1]:i,r=typeof r!="number"?g[2]:r,n=typeof n!="number"?g[3]:n,a=typeof a!="number"?g[4]:a,l=typeof l!="number"?g[5]:l,typeof t=="number")h._orientation=[t,i,r,n,a,l],typeof h.ctx.listener.forwardX<"u"?(h.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),h.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),h.ctx.listener.forwardZ.setTargetAtTime(r,Howler.ctx.currentTime,.1),h.ctx.listener.upX.setTargetAtTime(n,Howler.ctx.currentTime,.1),h.ctx.listener.upY.setTargetAtTime(a,Howler.ctx.currentTime,.1),h.ctx.listener.upZ.setTargetAtTime(l,Howler.ctx.currentTime,.1)):h.ctx.listener.setOrientation(t,i,r,n,a,l);else return g;return h},Howl.prototype.init=function(t){return function(i){var r=this;return r._orientation=i.orientation||[1,0,0],r._stereo=i.stereo||null,r._pos=i.pos||null,r._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},r._onstereo=i.onstereo?[{fn:i.onstereo}]:[],r._onpos=i.onpos?[{fn:i.onpos}]:[],r._onorientation=i.onorientation?[{fn:i.onorientation}]:[],t.call(this,i)}}(Howl.prototype.init),Howl.prototype.stereo=function(t,i){var r=this;if(!r._webAudio)return r;if(r._state!=="loaded")return r._queue.push({event:"stereo",action:function(){r.stereo(t,i)}}),r;var n=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof t=="number")r._stereo=t,r._pos=[t,0,0];else return r._stereo;for(var a=r._getSoundIds(i),l=0;l<a.length;l++){var h=r._soundById(a[l]);if(h)if(typeof t=="number")h._stereo=t,h._pos=[t,0,0],h._node&&(h._pannerAttr.panningModel="equalpower",(!h._panner||!h._panner.pan)&&e(h,n),n==="spatial"?typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):h._panner.setPosition(t,0,0):h._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),r._emit("stereo",h._id);else return h._stereo}return r},Howl.prototype.pos=function(t,i,r,n){var a=this;if(!a._webAudio)return a;if(a._state!=="loaded")return a._queue.push({event:"pos",action:function(){a.pos(t,i,r,n)}}),a;if(i=typeof i!="number"?0:i,r=typeof r!="number"?-.5:r,typeof n>"u")if(typeof t=="number")a._pos=[t,i,r];else return a._pos;for(var l=a._getSoundIds(n),h=0;h<l.length;h++){var g=a._soundById(l[h]);if(g)if(typeof t=="number")g._pos=[t,i,r],g._node&&((!g._panner||g._panner.pan)&&e(g,"spatial"),typeof g._panner.positionX<"u"?(g._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),g._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),g._panner.positionZ.setValueAtTime(r,Howler.ctx.currentTime)):g._panner.setPosition(t,i,r)),a._emit("pos",g._id);else return g._pos}return a},Howl.prototype.orientation=function(t,i,r,n){var a=this;if(!a._webAudio)return a;if(a._state!=="loaded")return a._queue.push({event:"orientation",action:function(){a.orientation(t,i,r,n)}}),a;if(i=typeof i!="number"?a._orientation[1]:i,r=typeof r!="number"?a._orientation[2]:r,typeof n>"u")if(typeof t=="number")a._orientation=[t,i,r];else return a._orientation;for(var l=a._getSoundIds(n),h=0;h<l.length;h++){var g=a._soundById(l[h]);if(g)if(typeof t=="number")g._orientation=[t,i,r],g._node&&(g._panner||(g._pos||(g._pos=a._pos||[0,0,-.5]),e(g,"spatial")),typeof g._panner.orientationX<"u"?(g._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),g._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),g._panner.orientationZ.setValueAtTime(r,Howler.ctx.currentTime)):g._panner.setOrientation(t,i,r)),a._emit("orientation",g._id);else return g._orientation}return a},Howl.prototype.pannerAttr=function(){var t=this,i=arguments,r,n,a;if(!t._webAudio)return t;if(i.length===0)return t._pannerAttr;if(i.length===1)if(typeof i[0]=="object")r=i[0],typeof n>"u"&&(r.pannerAttr||(r.pannerAttr={coneInnerAngle:r.coneInnerAngle,coneOuterAngle:r.coneOuterAngle,coneOuterGain:r.coneOuterGain,distanceModel:r.distanceModel,maxDistance:r.maxDistance,refDistance:r.refDistance,rolloffFactor:r.rolloffFactor,panningModel:r.panningModel}),t._pannerAttr={coneInnerAngle:typeof r.pannerAttr.coneInnerAngle<"u"?r.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof r.pannerAttr.coneOuterAngle<"u"?r.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof r.pannerAttr.coneOuterGain<"u"?r.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof r.pannerAttr.distanceModel<"u"?r.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof r.pannerAttr.maxDistance<"u"?r.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof r.pannerAttr.refDistance<"u"?r.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof r.pannerAttr.rolloffFactor<"u"?r.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof r.pannerAttr.panningModel<"u"?r.pannerAttr.panningModel:t._panningModel});else return a=t._soundById(parseInt(i[0],10)),a?a._pannerAttr:t._pannerAttr;else i.length===2&&(r=i[0],n=parseInt(i[1],10));for(var l=t._getSoundIds(n),h=0;h<l.length;h++)if(a=t._soundById(l[h]),a){var g=a._pannerAttr;g={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:g.coneInnerAngle,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:g.coneOuterAngle,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:g.coneOuterGain,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:g.distanceModel,maxDistance:typeof r.maxDistance<"u"?r.maxDistance:g.maxDistance,refDistance:typeof r.refDistance<"u"?r.refDistance:g.refDistance,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:g.rolloffFactor,panningModel:typeof r.panningModel<"u"?r.panningModel:g.panningModel};var p=a._panner;p||(a._pos||(a._pos=t._pos||[0,0,-.5]),e(a,"spatial"),p=a._panner),p.coneInnerAngle=g.coneInnerAngle,p.coneOuterAngle=g.coneOuterAngle,p.coneOuterGain=g.coneOuterGain,p.distanceModel=g.distanceModel,p.maxDistance=g.maxDistance,p.refDistance=g.refDistance,p.rolloffFactor=g.rolloffFactor,p.panningModel=g.panningModel}return t},Sound.prototype.init=function(t){return function(){var i=this,r=i._parent;i._orientation=r._orientation,i._stereo=r._stereo,i._pos=r._pos,i._pannerAttr=r._pannerAttr,t.call(this),i._stereo?r.stereo(i._stereo):i._pos&&r.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var i=this,r=i._parent;return i._orientation=r._orientation,i._stereo=r._stereo,i._pos=r._pos,i._pannerAttr=r._pannerAttr,i._stereo?r.stereo(i._stereo):i._pos?r.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,r._refreshBuffer(i)),t.call(this)}}(Sound.prototype.reset);var e=function(t,i){i=i||"spatial",i==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(F);class Se{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,F.Howler.autoUnlock=!0,F.Howler.html5PoolSize=10,F.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(F.Howler.ctx&&F.Howler.ctx.state==="suspended")try{await F.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(e){console.error("Failed to resume AudioContext:",e)}}async preloadHotspots(e){const t=e.filter(i=>i.audioUrl).map(i=>({id:i.id,url:i.audioUrl}));this.preloadQueue.push(...t),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:e,url:t}=this.preloadQueue.shift();this.sounds.has(e)||(await this.loadSound(e,t),this.preloadedCount++)}this.isPreloading=!1}async loadSound(e,t){return new Promise(i=>{const r=new Audio;r.addEventListener("error",()=>{t.includes("example.com")||console.log(`Audio not found for ${e}, using placeholder`),this.createSound(e,this.placeholderUrl,!0),i()}),r.addEventListener("canplaythrough",()=>{this.createSound(e,t,!1),i()}),r.src=t})}createSound(e,t,i=!1){const r=new F.Howl({src:[t],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${e} (placeholder: ${i})`)},onend:()=>this.handlePlaybackEnd(e),onloaderror:(n,a)=>{console.error(`Failed to load sound ${e}:`,a),this.onError&&this.onError(e,a)},onplayerror:(n,a)=>{console.error(`Failed to play sound ${e}:`,a),this.onError&&this.onError(e,a)}});this.sounds.set(e,{howl:r,isPlaceholder:i,duration:i?this.placeholderDuration:null})}async play(e){if(await this.resumeContext(),this.currentHotspotId===e&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(e)||(this.state="loading",await this.loadSound(e,`/audio/hotspot_${e}.mp3`));const t=this.sounds.get(e);if(!t){console.error(`No sound found for hotspot: ${e}`);return}const i=t.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,i,e):(this.currentSound&&this.currentSound.stop(),this.currentSound=i,this.currentHotspotId=e,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(e),this.startProgressTracking())}crossfade(e,t,i){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${i}`),this.isCrossfading=!0,this.state="crossfading";const r=this.crossfadeDuration,n=20,a=r/n;let l=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,i),t.volume(0),t.play();const h=setInterval(()=>{l++;const g=l/n;e.volume(this.masterVolume*(1-g)),t.volume(this.masterVolume*g),l>=n&&(clearInterval(h),e.stop(),e.volume(this.masterVolume),this.previousSound=e,this.currentSound=t,this.currentHotspotId=i,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(i),this.startProgressTracking())},a)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(e){if(this.currentSound&&this.currentSound.playing()){const t=this.currentSound.seek()||0,i=this.currentSound.duration(),r=Math.max(0,Math.min(i,t+e));this.currentSound.seek(r),console.log(`Skipped to ${r.toFixed(1)}s`)}}setVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),F.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,F.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const e=this.currentSound.seek()||0,t=this.sounds.get(this.currentHotspotId),i=t!=null&&t.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,r=i>0?e/i*100:0;return{current:e,duration:i,percent:r}}seekTo(e){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(e)}seekToPercent(e){if(this.currentSound){const t=this.currentSound.duration(),i=e/100*t;this.seekTo(i)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const e=this.getProgress();this.onProgress(e)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(e){console.log(`Playback ended for hotspot: ${e}`),e===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(e))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(e,t=500){this.crossfadeEnabled=e,this.crossfadeDuration=Math.max(100,Math.min(2e3,t)),console.log(`Crossfade ${e?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(e){const t=this.sounds.get(e);t&&(t.howl.unload(),this.sounds.delete(e),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(e=>{e.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}playTemporalSound(e,t,i=50){(!t||isNaN(t)||!isFinite(t))&&(console.warn(`Invalid frequency for temporal sound: ${t}`),t=1e3),(!i||isNaN(i)||i<=0)&&(i=50),this.resumeContext(),this.uiAudioContext||(this.uiAudioContext=new(window.AudioContext||window.webkitAudioContext));try{const r=this.uiAudioContext,n=r.createOscillator(),a=r.createGain(),l=r.createBiquadFilter();l.type="lowpass",l.frequency.value=Math.min(t*1.5,2e3),n.connect(l),l.connect(a),a.connect(r.destination),n.type="sine",n.frequency.value=t;const h=r.currentTime,g=.01,p=i/1e3,s=t>1500?.05:.08;a.gain.setValueAtTime(0,h),a.gain.linearRampToValueAtTime(s,h+g),a.gain.exponentialRampToValueAtTime(.001,h+p),n.start(h),n.stop(h+p),console.log(`Temporal sound played: ${e} at ${t}Hz for ${i}ms`)}catch(r){console.error("Error playing temporal sound:",r)}}playTemporalTick(e=.5){const i=1200+400*(!isNaN(e)&&isFinite(e)?Math.min(1,Math.max(0,e)):.5);this.playTemporalSound("explore",i,40)}playTemporalBoop(){this.playTemporalSound("preview",600,80)}playTemporalThunk(e=.5){const i=150+100*(1-(!isNaN(e)&&isFinite(e)?Math.min(1,Math.max(0,e)):.5));this.playTemporalSound("activate",i,120)}}class _e{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(e){e.forEach(t=>{t.image_url_1&&this.overlays.set(t.id,{hotspotId:t.id,imageUrls:[t.image_url_1],autoReveal:t.overlay_auto_reveal||!1,displayMode:t.overlay_display_mode||"modal",showButton:t.show_images_button!==!1,access:t.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(e){const t=[];e.forEach(i=>{const r=this.overlays.get(i);r&&!r.isLoaded&&r.imageUrls.forEach(n=>{this.preloadedImages.has(n)||t.push({url:n,hotspotId:i})})}),this.preloadQueue.push(...t),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:e,hotspotId:t}=this.preloadQueue.shift();try{await this.loadImage(e,t)}catch(i){console.error(`Failed to preload image: ${e}`,i)}}this.isPreloading=!1}loadImage(e,t){return new Promise((i,r)=>{const n=new Image;n.onload=()=>{this.preloadedImages.set(e,n);const a=this.overlays.get(t);a&&(a.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(e,t),console.log(`Image loaded: ${e}`),i(n)},n.onerror=a=>{this.onImageError&&this.onImageError(e,t,a),console.error(`Failed to load image: ${e}`),r(a)},n.crossOrigin="anonymous",n.src=e})}shouldAutoReveal(e){const t=this.overlays.get(e);return t?t.autoReveal:!1}shouldShowButton(e){const t=this.overlays.get(e);return t?t.showButton:!0}getOverlay(e){return this.overlays.get(e)}openOverlay(e){const t=this.overlays.get(e);if(!t)return console.warn(`No overlay found for hotspot: ${e}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=e,!t.isLoaded){const i=t.imageUrls[0];this.loadImage(i,e).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(e,t),t}closeOverlay(){if(this.activeOverlay){const e=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(e)}}getImage(e){return this.preloadedImages.get(e)}hasAccess(e,t="free"){const i=this.overlays.get(e);if(!i)return!1;const r={free:0,gated:1,supporter:2},n=r[i.access]||0;return(r[t]||0)>=n}unloadImages(e){e.forEach(t=>{const i=this.overlays.get(t);i&&(i.imageUrls.forEach(r=>{this.preloadedImages.delete(r)}),i.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class be{constructor(e,t=!1){this.viewer=e,this.isMobile=t,this.isActive=!0,this.isZooming=!1,this.lastZoomLevel=null,this.zoomStartTime=null,this.cinematicMode=!1,this.LOW_ZOOM_THRESHOLD=2,this.CRITICAL_ZOOM_THRESHOLD=1,this.originalSettings={},this.isOptimizing=!1,this.setupEventHandlers()}setupEventHandlers(){this.viewer&&(this.viewer.addHandler("zoom",e=>{this.isActive&&this.handleZoomChange(e)}),this.viewer.addHandler("pan",e=>{this.isActive&&this.handlePanAtLowZoom(e)}),this.viewer.addHandler("animation-start",()=>{this.isActive&&this.handleAnimationStart()}),this.viewer.addHandler("animation-finish",()=>{this.isActive&&this.handleAnimationFinish()}),this.viewer.drawer&&this.viewer.drawer.getType()!=="webgl"&&this.setupTileDrawingOptimization())}handleZoomChange(e){const t=e.zoom||this.viewer.viewport.getZoom();if(this.lastZoomLevel=t,this.cinematicMode){console.log("LowZoomOptimizer: Skipping zoom optimization - cinematic mode active");return}t<this.CRITICAL_ZOOM_THRESHOLD?this.applyCriticalZoomOptimization():t<this.LOW_ZOOM_THRESHOLD?this.applyLowZoomOptimization():this.restoreNormalOptimization()}handlePanAtLowZoom(e){if(this.viewer.viewport.getZoom()<this.LOW_ZOOM_THRESHOLD&&this.viewer.imageLoader){const i=this.viewer.imageLoader.jobLimit;this.viewer.imageLoader.jobLimit=this.isMobile?1:2,setTimeout(()=>{this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=i)},50)}}handleAnimationStart(){if(this.isZooming=!0,this.zoomStartTime=performance.now(),this.cinematicMode){console.log("LowZoomOptimizer: Skipping animation optimization - cinematic mode active");return}if(!this.isActive){console.log("LowZoomOptimizer: Skipping optimization - disabled");return}this.viewer.viewport.getZoom()<this.LOW_ZOOM_THRESHOLD&&(!this.isMobile&&this.viewer.imageLoader&&this.viewer.imageLoader.clear(),this.storeOriginalSpringSettings(),this.optimizeSpringSettings())}handleAnimationFinish(){if(this.isZooming=!1,this.zoomStartTime&&(performance.now()-this.zoomStartTime,this.zoomStartTime=null),this.cinematicMode){console.log("LowZoomOptimizer: Skipping spring restoration - cinematic mode active");return}if(!this.isActive){console.log("LowZoomOptimizer: Skipping spring restoration - disabled");return}this.restoreOriginalSpringSettings()}applyCriticalZoomOptimization(){this.isOptimizing||(this.isOptimizing=!0,Object.keys(this.originalSettings).length===0&&this.storeOriginalSettings(),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),this.viewer.imageSmoothingEnabled=!1,this.viewer.immediateRender=!0,this.isMobile&&(this.viewer.maxTilesPerFrame=1,this.viewer.blendTime=0,this.viewer.alwaysBlend=!1))}applyLowZoomOptimization(){this.isOptimizing||(this.isOptimizing=!0,Object.keys(this.originalSettings).length===0&&this.storeOriginalSettings(),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=this.isMobile?1:2),this.isMobile?(this.viewer.maxTilesPerFrame=1,this.viewer.blendTime=0):(this.viewer.maxTilesPerFrame=2,this.viewer.blendTime=0))}restoreNormalOptimization(){this.isOptimizing&&(this.restoreOriginalSettings(),this.isOptimizing=!1)}setupTileDrawingOptimization(){let e=0;this.viewer.addHandler("tile-drawing",t=>{if(!this.isActive)return;const i=this.viewer.viewport.getZoom();t.tile;const r=t.tile.level;if(i<this.LOW_ZOOM_THRESHOLD){e++;const n=i<this.CRITICAL_ZOOM_THRESHOLD?2:1;if(n>0&&e%(n+1)!==0){t.preventDefaultAction=!0;return}if(t.tile.size*i<(this.isMobile?32:24)){t.preventDefaultAction=!0;return}}if(this.isZooming){const n=Math.floor(Math.log2(i));if(Math.abs(r-n)>2){t.preventDefaultAction=!0;return}}})}storeOriginalSettings(){var e;this.originalSettings={imageLoaderLimit:(e=this.viewer.imageLoader)==null?void 0:e.jobLimit,maxTilesPerFrame:this.viewer.maxTilesPerFrame,blendTime:this.viewer.blendTime,alwaysBlend:this.viewer.alwaysBlend,imageSmoothingEnabled:this.viewer.imageSmoothingEnabled,immediateRender:this.viewer.immediateRender}}restoreOriginalSettings(){Object.keys(this.originalSettings).length!==0&&Object.keys(this.originalSettings).forEach(e=>{const t=this.originalSettings[e];t!==void 0&&(e==="imageLoaderLimit"&&this.viewer.imageLoader?this.viewer.imageLoader.jobLimit=t:this.viewer[e]!==void 0&&(this.viewer[e]=t))})}storeOriginalSpringSettings(){this.originalSpringSettings||(this.originalSpringSettings={animationTime:this.viewer.animationTime,springStiffness:this.viewer.springStiffness,centerXAnimationTime:this.viewer.viewport.centerSpringX.animationTime,centerYAnimationTime:this.viewer.viewport.centerSpringY.animationTime,zoomAnimationTime:this.viewer.viewport.zoomSpring.animationTime,centerXStiffness:this.viewer.viewport.centerSpringX.springStiffness,centerYStiffness:this.viewer.viewport.centerSpringY.springStiffness,zoomStiffness:this.viewer.viewport.zoomSpring.springStiffness})}optimizeSpringSettings(){if(this.cinematicMode){console.log("LowZoomOptimizer: Preserving springs - cinematic mode active");return}const e=this.isMobile?.25:.2,t=this.isMobile?15:18;this.viewer.animationTime=e,this.viewer.springStiffness=t,this.viewer.viewport.centerSpringX.animationTime=e,this.viewer.viewport.centerSpringY.animationTime=e,this.viewer.viewport.zoomSpring.animationTime=e,this.viewer.viewport.centerSpringX.springStiffness=t,this.viewer.viewport.centerSpringY.springStiffness=t,this.viewer.viewport.zoomSpring.springStiffness=t}restoreOriginalSpringSettings(){if(!this.originalSpringSettings)return;const e=this.originalSpringSettings;this.viewer.animationTime=e.animationTime,this.viewer.springStiffness=e.springStiffness,this.viewer.viewport.centerSpringX.animationTime=e.centerXAnimationTime,this.viewer.viewport.centerSpringY.animationTime=e.centerYAnimationTime,this.viewer.viewport.zoomSpring.animationTime=e.zoomAnimationTime,this.viewer.viewport.centerSpringX.springStiffness=e.centerXStiffness,this.viewer.viewport.centerSpringY.springStiffness=e.centerYStiffness,this.viewer.viewport.zoomSpring.springStiffness=e.zoomStiffness,this.originalSpringSettings=null}monitorPerformance(e){this._lastEmergencyTime||(this._lastEmergencyTime=0);const t=Date.now(),i=5e3,n=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&!/iPad|iPhone|iPod/.test(navigator.userAgent)?10:this.isMobile?15:25;e<n&&e>0&&t-this._lastEmergencyTime>i&&(console.warn(`LowZoomOptimizer: Low FPS detected (${e}), applying emergency optimization`),this._lastEmergencyTime=t,this.applyEmergencyOptimization())}applyEmergencyOptimization(){console.warn("LowZoomOptimizer: Applying EMERGENCY optimization");const e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=e&&!/iPad|iPhone|iPod/.test(navigator.userAgent);if(this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=t?2:1,e||this.viewer.imageLoader.clear()),this.viewer.maxTilesPerFrame=t?2:1,this.viewer.blendTime=e?.1:0,this.viewer.alwaysBlend=!1,this.viewer.immediateRender=!0,!e&&!this.isMobile&&this.viewer.world){const i=this.viewer.world.getItemCount();for(let r=0;r<i;r++){const n=this.viewer.world.getItemAt(r);n&&n._tileCache&&setTimeout(()=>{n._tileCache.clearTilesFor(n)},0)}}}enable(){this.isActive=!0}disable(){this.isActive=!1,this.restoreNormalOptimization()}destroy(){this.disable(),this.viewer&&(this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("pan"),this.viewer.removeAllHandlers("animation-start"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("tile-drawing")),console.log(" PERFORMANCE FIXED: LowZoomOptimizer destroyed")}setCinematicMode(e){this.cinematicMode=e,console.log(`LowZoomOptimizer: Cinematic mode ${e?"ENABLED":"DISABLED"}`),e&&this.restoreNormalOptimization()}getStatus(){return{isActive:this.isActive,isOptimizing:this.isOptimizing,currentZoom:this.lastZoomLevel,isMobile:this.isMobile,cinematicMode:this.cinematicMode,optimizationLevel:this.isOptimizing?this.lastZoomLevel<this.CRITICAL_ZOOM_THRESHOLD?"critical":"low":"normal",fixed:"PERFORMANCE_OPTIMIZED"}}}class xe{constructor(e){W(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});W(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=e,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const e=performance.memory.usedJSHeapSize/1048576,t=performance.memory.jsHeapSizeLimit/1048576,i=e/t*100;this.metrics.currentUsage=e,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,e);const r=this.state.memoryPressure;if(e>this.config.criticalThreshold||i>80?this.state.memoryPressure="critical":e>this.config.highThreshold||i>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==r)switch(console.log(`Memory pressure changed: ${r}  ${this.state.memoryPressure} (${e.toFixed(0)}MB, ${i.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const e=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==e.tiles&&(this.viewer.maxImageCacheCount=e.tiles,console.log(`Adjusted tile cache limit to ${e.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var t;console.warn("CRITICAL: Emergency memory cleanup");const e=(t=this.viewer.world)==null?void 0:t.getItemAt(0);e&&(e._tileCache&&e._tileCache.clearTilesFor(e),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(e=!1){var n,a;const t=(n=this.viewer.world)==null?void 0:n.getItemAt(0);if(!(t!=null&&t._tileCache))return;const i=t._tileCache,r=((a=i._tilesLoaded)==null?void 0:a.length)||i._imagesLoadedCount||0;if(e||r>this.config.cacheLimits[this.state.memoryPressure].tiles){const l=e?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,h=r-l;h>0&&(console.log(`Removing ${h} tiles from cache (current: ${r})`),i.clearTilesFor(t))}}clearUnusedImages(){const e=document.querySelectorAll("img");let t=0;e.forEach(i=>{!this.isElementVisible(i)&&i.src&&(i.removeAttribute("src"),t++)}),t>0&&console.log(`Cleared ${t} unused images`)}isElementVisible(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const e={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const t=performance.memory.jsHeapSizeLimit/1048576;e.usagePercentage=(this.metrics.currentUsage/t*100).toFixed(1)+"%",e.totalLimit=t.toFixed(0)+"MB"}return e}destroy(){this.stop(),this.viewer=null}}class Ae{constructor(e,t={}){this.viewer=e,this.config={throttleMs:t.throttleMs||16,zoomStep:t.zoomStep||.02,enabled:t.enabled!==!1,...t},this.lastEventTime=0,this.pendingZoom=0,this.throttleTimeout=null,this.isEnabled=this.config.enabled,this.init()}init(){!this.viewer||!this.isEnabled||(this.viewer.addHandler("canvas-scroll",this.handleScroll.bind(this)),console.log("Mouse wheel smoothing initialized:",{throttleMs:this.config.throttleMs,zoomStep:this.config.zoomStep}))}handleScroll(e){if(!this.isEnabled)return;e.preventDefault=!0;const t=performance.now(),i=this.normalizeWheelDelta(e.originalEvent),r=Math.sign(-i),n=this.config.zoomStep*Math.abs(r);this.pendingZoom+=n*r,t-this.lastEventTime>=this.config.throttleMs?(this.applyPendingZoom(),this.lastEventTime=t):(this.throttleTimeout&&clearTimeout(this.throttleTimeout),this.throttleTimeout=setTimeout(()=>{this.applyPendingZoom(),this.lastEventTime=performance.now()},this.config.throttleMs))}normalizeWheelDelta(e){let i=0;return"deltaY"in e?i=e.deltaY:"wheelDelta"in e&&(i=-e.wheelDelta/120*40),e.deltaMode===1&&(i*=40),i}applyPendingZoom(){if(Math.abs(this.pendingZoom)<.001){this.pendingZoom=0;return}const t=this.viewer.viewport.getZoom()*(1+this.pendingZoom),i=Math.max(this.viewer.viewport.getMinZoom(),Math.min(this.viewer.viewport.getMaxZoom(),t));this.viewer.viewport.zoomTo(i),this.viewer.viewport.applyConstraints(),this.pendingZoom=0}updateConfig(e){this.config={...this.config,...e},console.log("Mouse wheel smoothing config updated:",this.config)}enable(){this.isEnabled=!0,console.log("Mouse wheel smoothing enabled")}disable(){this.isEnabled=!1,this.throttleTimeout&&(clearTimeout(this.throttleTimeout),this.throttleTimeout=null),console.log("Mouse wheel smoothing disabled")}destroy(){this.disable()}}class Me{constructor(){this.variationCache=new Map,this.durationVariation=.1,this.easingVariation=.05,this.startPointVariation=.15,this.debugMode=!1,this.enableDebugMode=()=>{this.debugMode=!0,this.durationVariation=.5,this.easingVariation=.25,this.startPointVariation=.5,this.clearAllVariations(),console.log("[OrganicVariations]  EXTREME DEBUG MODE enabled - variations are now VERY obvious:"),console.log("  - Duration: 50% (1.1s to 3.3s instead of 2.2s)"),console.log("  - Easing: 25% control point variation"),console.log("  - Start Point: 0-50% of path length"),console.log("  - Hover over multiple hotspots to see the differences!")},this.disableDebugMode=()=>{this.debugMode=!1,this.durationVariation=.1,this.easingVariation=.05,this.startPointVariation=.15,this.clearAllVariations(),console.log("[OrganicVariations] Debug mode disabled - variations are back to subtle")}}getVariations(e){return this.variationCache.has(e)||this.variationCache.set(e,this.generateVariations()),this.variationCache.get(e)}generateVariations(){return{durationMultiplier:this.generateDurationMultiplier(),easingAdjustment:this.generateEasingAdjustment(),startPointOffset:this.generateStartPointOffset(),timestamp:Date.now()}}generateDurationMultiplier(){const e=1-this.durationVariation,t=1+this.durationVariation;return e+Math.random()*(t-e)}generateEasingAdjustment(){return{x1:(Math.random()-.5)*this.easingVariation*2,y1:(Math.random()-.5)*this.easingVariation*2,x2:(Math.random()-.5)*this.easingVariation*2,y2:(Math.random()-.5)*this.easingVariation*2}}generateStartPointOffset(){return Math.random()*this.startPointVariation}applyDurationVariation(e,t){const i=this.getVariations(t);return Date.now()-i.timestamp>3e4?(this.variationCache.delete(t),this.applyDurationVariation(e,t)):e*i.durationMultiplier}applyEasingVariation(e,t){const i=this.getVariations(t),r=e.match(/cubic-bezier\(([\d.]+),\s*([\d.]+),\s*([\d.]+),\s*([\d.]+)\)/);if(!r)return e;const n=parseFloat(r[1])+i.easingAdjustment.x1,a=parseFloat(r[2])+i.easingAdjustment.y1,l=parseFloat(r[3])+i.easingAdjustment.x2,h=parseFloat(r[4])+i.easingAdjustment.y2,g=p=>Math.max(0,Math.min(1,p));return`cubic-bezier(${g(n)}, ${g(a)}, ${g(l)}, ${g(h)})`}getVariedStrokeDashValues(e,t){const i=this.getVariations(t);return e*i.startPointOffset,{dashArray:e,dashOffset:e}}clearVariations(e){this.variationCache.delete(e)}clearAllVariations(){this.variationCache.clear()}}const Z=new Me;typeof window<"u"&&(window.organicVariations=Z,window.testVariations={enableDebugMode:()=>Z.enableDebugMode(),disableDebugMode:()=>Z.disableDebugMode(),showCache:()=>{const m=[];return Z.variationCache.forEach((e,t)=>{m.push({hotspotId:t,duration:`${e.durationMultiplier.toFixed(3)}`,startOffset:`${(e.startPointOffset*100).toFixed(1)}%`,age:`${((Date.now()-e.timestamp)/1e3).toFixed(1)}s`})}),console.table(m),`${m.length} variations cached`},clear:()=>(Z.clearAllVariations(),"All variations cleared")});const ue=typeof window<"u"&&(window.DEBUG||localStorage.getItem("debugLevel")==="1"||new URLSearchParams(window.location.search).has("debug")),q={DEBUG:0,INFO:1,WARN:2,ERROR:3};let Ce=q.WARN;class K{constructor(e=""){this.prefix=e}_shouldLog(e){return ue&&e>=Ce}_formatMessage(e,...t){return new Date().toISOString(),[`${this.prefix?`[${this.prefix}] `:""}${e}`,...t]}debug(e,...t){this._shouldLog(q.DEBUG)&&console.log(...this._formatMessage(e,...t))}info(e,...t){this._shouldLog(q.INFO)&&console.info(...this._formatMessage(e,...t))}warn(e,...t){this._shouldLog(q.WARN)&&console.warn(...this._formatMessage(e,...t))}error(e,...t){this._shouldLog(q.ERROR)&&console.error(...this._formatMessage(e,...t))}perf(e,...t){ue&&window.DEBUG_PERFORMANCE&&console.log(`[PERF] ${this.prefix?`[${this.prefix}] `:""}${e}`,...t)}child(e){const t=this.prefix?`${this.prefix}:${e}`:e;return new K(t)}}function ut(m){return new K(m)}class Pe{constructor(e){this.viewer=e,this.enabled=!1,this.currentQuality="high",this.networkType="4g",this.saveDataMode=!1,this.qualityLevels={"slow-2g":{imageLoaderLimit:1,maxImageCacheCount:15,maxTilesPerFrame:1,jpegQuality:30,preload:!1,animationTime:.5,springStiffness:8},"2g":{imageLoaderLimit:1,maxImageCacheCount:20,maxTilesPerFrame:1,jpegQuality:50,preload:!1,animationTime:.4,springStiffness:10},"3g":{imageLoaderLimit:1,maxImageCacheCount:50,maxTilesPerFrame:2,jpegQuality:70,preload:!0,animationTime:.3,springStiffness:12},"4g":{imageLoaderLimit:2,maxImageCacheCount:100,maxTilesPerFrame:2,jpegQuality:85,preload:!0,animationTime:.3,springStiffness:12},wifi:{imageLoaderLimit:3,maxImageCacheCount:150,maxTilesPerFrame:3,jpegQuality:90,preload:!0,animationTime:.3,springStiffness:12}},this.performanceMetrics={lastCheck:0,avgLoadTime:0,samples:[]},this.onNetworkChange=null}initialize(){this.enabled||(console.log("[NetworkAdaptive] Initializing network detection..."),"connection"in navigator?this.setupNetworkAPI():(console.log("[NetworkAdaptive] Network API not available, using Safari fallback"),this.setupSafariFallback()),this.checkDataSaver(),this.applyNetworkSettings(),this.enabled=!0)}setupNetworkAPI(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;e&&(this.networkType=e.effectiveType||"4g",this.saveDataMode=e.saveData||!1,console.log("[NetworkAdaptive] Network detected:",this.networkType,"Save data:",this.saveDataMode),e.addEventListener("change",()=>{const t=e.effectiveType||"4g",i=e.saveData||!1;(t!==this.networkType||i!==this.saveDataMode)&&(console.log("[NetworkAdaptive] Network changed from",this.networkType,"to",t),this.networkType=t,this.saveDataMode=i,this.applyNetworkSettings())}),e.downlink&&(console.log("[NetworkAdaptive] Downlink speed:",e.downlink,"Mbps"),e.downlink<.5?this.networkType="slow-2g":e.downlink<1?this.networkType="2g":e.downlink<5&&(this.networkType="3g")))}setupSafariFallback(){this.estimateNetworkSpeed(),setInterval(()=>{this.estimateNetworkSpeed()},3e4),this.viewer&&this.viewer.addHandler("tile-loaded",e=>{this.trackTileLoadTime(e)})}async estimateNetworkSpeed(){try{const e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",t=performance.now(),i=new Image;await new Promise((l,h)=>{i.onload=l,i.onerror=h,i.src=e});const r=performance.now()-t;this.performanceMetrics.samples.push(r),this.performanceMetrics.samples.length>10&&this.performanceMetrics.samples.shift();const n=this.performanceMetrics.samples.reduce((l,h)=>l+h,0)/this.performanceMetrics.samples.length;this.performanceMetrics.avgLoadTime=n;let a="4g";n>500?a="slow-2g":n>300?a="2g":n>150?a="3g":n>50?a="4g":a="wifi",a!==this.networkType&&(console.log("[NetworkAdaptive] Safari: Network estimated as",a,"(avg load time:",n.toFixed(2),"ms)"),this.networkType=a,this.applyNetworkSettings())}catch(e){console.warn("[NetworkAdaptive] Failed to estimate network speed:",e)}}trackTileLoadTime(e){if(!e.tiledImage||!e.tile)return;const t=e.tile.loadTime||0;if(t>0){this.performanceMetrics.samples.push(t),this.performanceMetrics.samples.length>20&&this.performanceMetrics.samples.shift();const i=this.performanceMetrics.samples.reduce((n,a)=>n+a,0)/this.performanceMetrics.samples.length;let r="wifi";i>2e3?r="slow-2g":i>1e3?r="2g":i>500?r="3g":i>200&&(r="4g"),r!==this.networkType&&(console.log("[NetworkAdaptive] Adjusting based on tile load times:",r,"(avg:",i.toFixed(2),"ms)"),this.networkType=r,this.applyNetworkSettings())}}checkDataSaver(){"connection"in navigator&&navigator.connection&&(this.saveDataMode=navigator.connection.saveData||!1),window.matchMedia&&window.matchMedia("(prefers-reduced-data: reduce)").matches&&(this.saveDataMode=!0),this.saveDataMode&&console.log("[NetworkAdaptive] Data saver mode detected")}applyNetworkSettings(){if(!this.viewer)return;const e=this.qualityLevels[this.networkType]||this.qualityLevels["4g"];this.saveDataMode&&(e.jpegQuality=Math.min(40,e.jpegQuality),e.preload=!1,e.maxImageCacheCount=Math.min(20,e.maxImageCacheCount),e.imageLoaderLimit=1,console.log("[NetworkAdaptive] Data saver mode active - reducing quality")),console.log("[NetworkAdaptive] Applying settings for",this.networkType,":",e),this.viewer.drawer&&(this.viewer.imageLoaderLimit=e.imageLoaderLimit,this.viewer.maxImageCacheCount=e.maxImageCacheCount,this.viewer.viewport&&(this.viewer.viewport.animationTime=e.animationTime,this.viewer.viewport.springStiffness=e.springStiffness));const t=this.currentQuality;this.networkType==="slow-2g"||this.networkType==="2g"?this.currentQuality="low":this.networkType==="3g"?this.currentQuality="medium":this.currentQuality="high",this.onNetworkChange&&t!==this.currentQuality&&this.onNetworkChange(this.networkType,this.currentQuality),this.showNetworkNotification()}showNetworkNotification(){let e=document.getElementById("network-notification");e||(e=document.createElement("div"),e.id="network-notification",e.style.cssText=`
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            `,document.body.appendChild(e));let t="",i="";switch(this.networkType){case"slow-2g":t="Very slow connection - Quality reduced",i="";break;case"2g":t="Slow connection - Quality reduced",i="";break;case"3g":t="Moderate connection - Balanced quality",i="";break;case"4g":t="Good connection",i="";break;case"wifi":t="Excellent connection",i="";break}this.saveDataMode&&(t+=" (Data saver on)",i=""),e.textContent=`${i} ${t}`,e.style.opacity="1",setTimeout(()=>{e.style.opacity="0"},3e3)}getStatus(){return{enabled:this.enabled,networkType:this.networkType,quality:this.currentQuality,saveDataMode:this.saveDataMode,settings:this.qualityLevels[this.networkType]}}setNetworkType(e){this.qualityLevels[e]&&(console.log("[NetworkAdaptive] Manually setting network type to:",e),this.networkType=e,this.applyNetworkSettings())}destroy(){this.enabled=!1;const e=document.getElementById("network-notification");e&&e.remove(),"connection"in navigator&&navigator.connection&&navigator.connection.removeEventListener("change",this.applyNetworkSettings)}}class Ie{constructor(e){this.viewer=e,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[];const t=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);this.thresholds={fps:{target:t?45:60,good:t?35:50,acceptable:t?25:35,poor:t?20:25,critical:15},frameTime:{target:t?22:16.67,warning:40},memory:{warning:t?200:300,critical:t?300:400}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const e={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(e).forEach(([t,i])=>this.viewer.addHandler(t,i.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(e=>this.viewer.removeAllHandlers(e))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const e=performance.now(),t=e-this.lastTime;this.updateFrameMetrics(t),this.lastTime=e,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(e){if(this.frameTimes.push(e),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),e>0){const t=1e3/e;this.fpsHistory.push(t),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=t,e>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const e=this.viewer.drawer.canvas;e&&(this.metrics.canvasSize=`${e.width}${e.height}`);const i=this.viewer.viewport.getBounds(),r=this.viewer.world.getHomeBounds(),n=i.width*i.height/(r.width*r.height);this.metrics.viewportCoverage=Math.min(100,n*100).toFixed(1)}updateTileMetrics(){var i,r;const e=this.viewer.world;if(e.getItemCount()===0)return;const t=e.getItemAt(0);if(t){if(this.metrics.visibleTiles=((i=t._tilesToDraw)==null?void 0:i.length)||0,t._tileCache){const n=t._tileCache;this.metrics.cachedTiles=((r=n._tilesLoaded)==null?void 0:r.length)||n._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:e,frameTime:t,memory:i}=this.thresholds,r={fps:Math.min(100,this.metrics.averageFPS/e.target*100)*.5,frameTime:Math.min(100,t.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(r).reduce((n,a)=>n+a,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const e=Date.now();if(e-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:t}=this.thresholds,i=this.metrics.averageFPS,r=this.metrics.performanceScore,n=this.getPerformanceTrend(),a=[{condition:i<t.critical||r<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:i<t.poor||r<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:i<t.good||r<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:i>t.target&&r>90&&(n==="improving"||n==="stable"),action:this.restoreQualitySettings,log:null}];for(const l of a)if(l.condition){l.log&&console[l.log==="CRITICAL"?"error":"warn"](`${l.log} performance: Score ${r}, FPS: ${i}`),l.action.call(this),this.lastOptimization=e;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const e=this.performanceHistory.slice(-10),t=this.performanceHistory.slice(-20,-10),i=this.average(e.map(a=>a.score)),r=this.average(t.map(a=>a.score)),n=i-r;return n>5?"improving":n<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var i;const e=(i=window.performanceConfig)==null?void 0:i.viewer;if(!e)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:r,delta:n,op:a})=>{const l=this.viewer[r],h=e[r];a==="increase"&&l<h?this.viewer[r]=Math.min(h,l+n):a==="decrease"&&l>h&&(this.viewer[r]=Math.max(h,l-n))})}onTileLoaded(e){var t;(t=e.tile)!=null&&t.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+e.tile.loadTime*.1)}onTileLoadFailed(e){console.warn("Tile load failed:",e.tile)}trackLoadTime(e){this.loadTimes.push(e),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const e=this.getPerformanceLevel();return{...this.metrics,instantFPS:this.metrics.currentFPS,performanceLevel:e,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:e,performanceScore:t}=this.metrics,{fps:i}=this.thresholds;return[{name:"excellent",condition:e>=i.target&&t>=90},{name:"good",condition:e>=i.good&&t>=80},{name:"acceptable",condition:e>=i.acceptable&&t>=60},{name:"poor",condition:e>=i.poor&&t>=40},{name:"critical",condition:!0}].find(n=>n.condition).name}getWarnings(){const e=this.metrics,t=this.thresholds;return[{condition:e.averageFPS<t.fps.poor,message:`Low FPS: ${e.averageFPS} (target: ${t.fps.target})`},{condition:e.droppedFrames>200,message:`Dropped frames: ${e.droppedFrames}`},{condition:parseFloat(e.frameTime)>t.frameTime.warning,message:`High frame time: ${e.frameTime}ms`},{condition:e.memoryUsage>t.memory.critical,message:`High memory: ${e.memoryUsage}MB`},{condition:e.cachedTiles>3e3,message:`Large cache: ${e.cachedTiles} tiles`},{condition:e.tileLoadTime>500,message:`Slow tile loading: ${Math.round(e.tileLoadTime)}ms`}].filter(r=>r.condition).map(r=>r.message)}getRecommendations(){const e=[],t=this.metrics,i=this.thresholds;return t.averageFPS<i.fps.acceptable&&(t.renderMode==="animating"&&e.push("Reduce animation time for smoother transitions"),t.cachedTiles>1e3&&e.push("Clear tile cache to free memory"),t.visibleTiles>50&&e.push("Zoom in to reduce visible tiles")),t.memoryUsage>i.memory.warning&&e.push("Consider reloading the page to clear memory"),t.tileLoadTime>200&&e.push("Check network connection or reduce concurrent tile loads"),e}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const e=this.getMetrics(),t={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},i=e.currentFPS<55?"#FF9800":"#4CAF50",r=e.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${t[e.performanceLevel]};">
                    ${e.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${i};">
                    ${e.currentFPS.toFixed(0)} (avg: ${e.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${e.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${r};">
                    ${e.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${t[e.performanceLevel]}; font-weight: 500;">
                    ${e.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(e){return e.reduce((t,i)=>t+i,0)/e.length}trimArray(e,t){for(;e.length>t;)e.shift()}}class Fe{constructor(e){this.viewer=e,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([t,i])=>this.viewer.addHandler(t,i))}applyInitialOptimizations(){const e=this.viewer.container;e&&Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const e=performance.now(),t=e-this.state.lastFrameTime;if(this.state.lastFrameTime=e,this.viewer.viewport.getZoom()<3&&t>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let e=null,t=!1;this.viewer.addHandler("zoom",()=>{if(!t){if(t=!0,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!1,i.globalAlpha=1}this.viewer.skipTileDrawing=!0}e&&clearTimeout(e),e=setTimeout(()=>{if(t=!1,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!0,i.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),e=null},150)})}handleViewportChange(){const e=this.viewer.viewport.getZoom(!0),t=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const i=Math.abs(e-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+i*.3,this.state.isZooming=i>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const i=Math.sqrt(Math.pow(t.x-this.lastCenter.x,2)+Math.pow(t.y-this.lastCenter.y,2));this.state.isPanning=i>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=e,this.lastCenter=t}applyZoomOptimizations(e){var i,r;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((r=(i=window.performanceConfig)==null?void 0:i.renderOptimization)!=null&&r.zoomOptimizations))){if(e&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const n=this.viewer.world.getItemAt(0);n&&(this.state.lastBlendTime=0,n.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!e&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const n=this.viewer.world.getItemAt(0);n&&(n.blendTime=0)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(e){var i;this.lastInteraction=Date.now();const t={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(i=t[e])==null||i.call(t)}setRenderMode(e){var i,r;if(this.state.renderMode===e)return;const t=this.state.renderMode;this.state.renderMode=e,e==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):e==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(r=(i=window.performanceConfig)==null?void 0:i.debug)!=null&&r.logPerformance&&console.log(`Render mode: ${t}  ${e}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var r,n;const e=Date.now();if(e-this.lastOptimizationTime<this.config.optimizationCooldown)return;const t=(r=this.viewer.drawer)==null?void 0:r.canvas,i=(n=this.viewer.drawer)==null?void 0:n.context;!t||!i||(Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(i,!0),i.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=e)}removeCanvasOptimizations(){var t;const e=(t=this.viewer.drawer)==null?void 0:t.context;e&&(this.setContextSmoothing(e,!0),e.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(e,t){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(r=>{r in e&&(e[r]=t)})}clearTimers(){Object.entries(this.timers).forEach(([e,t])=>{clearTimeout(t),delete this.timers[e]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(e){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(i=>Object.assign(i.style,e))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(e){Object.assign(this.config,e)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var e,t;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((t=(e=window.performanceConfig)==null?void 0:e.viewer)==null?void 0:t.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(e=>this.viewer.removeAllHandlers(e)),this.removeCanvasOptimizations(),this.viewer=null}}class Ee{constructor(e){this.viewer=e,this.isInteracting=!1,this.highQualityTimeout=null,this.basePixelRatio=window.devicePixelRatio||1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.lastInteractionStart=0,this.interactionCount=0,this.averageFPS=60,this.lastPosition=null,this.velocity=0,this.velocityBuffer=[],this.velocityCheckInterval=null,this.scalingFactor=this.isIOS?.5:.35,this.restoreDelay=(this.isIOS,300),console.log("SafariPerformanceOptimizer initialized:",{isSafari:this.isSafari,isIOS:this.isIOS,basePixelRatio:this.basePixelRatio,scalingFactor:this.scalingFactor}),this.isSafari&&(this.setupEventHandlers(),this.applyInitialOptimizations())}setupEventHandlers(){let e=null;const t=()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.startInteraction()},16)};this.viewer.addHandler("animation-start",t),this.viewer.addHandler("pan",t),this.viewer.addHandler("zoom",t),this.isIOS&&this.viewer.addHandler("canvas-pinch",t),this.viewer.addHandler("animation-finish",()=>this.endInteraction());const i=this.viewer.canvas;i&&(i.addEventListener("touchstart",t,{passive:!0}),i.addEventListener("mousedown",t,{passive:!0}))}applyInitialOptimizations(){if(this.viewer.drawer&&this.viewer.drawer.canvas){const e=this.viewer.drawer.canvas;if(this.isIOS){const t=this.viewer.viewport.getContainerSize(),i=this.viewer.drawer.pixelRatio||this.basePixelRatio;e.width=Math.floor(t.x*i),e.height=Math.floor(t.y*i),console.log("iOS Canvas Fix: Initial dimensions floored to prevent oversizing",{width:e.width,height:e.height,pixelRatio:i,originalWidth:t.x*i,originalHeight:t.y*i})}e.style.transform="translateZ(0)",e.style.willChange="transform",e.style.backfaceVisibility="hidden",e.style.webkitBackfaceVisibility="hidden",e.style.outline="none"}if(this.viewer.drawer&&this.viewer.drawer.context){const e=this.viewer.drawer.context;e.imageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1}}startInteraction(){var t;if(!this.isSafari||this.isInteracting)return;this.isInteracting=!0,this.lastInteractionStart=performance.now(),this.interactionCount++,this.velocityBuffer=[],this.lastPosition=null,this.velocityCheckInterval&&clearInterval(this.velocityCheckInterval),this.velocityCheckInterval=setInterval(()=>{this.updateVelocity()},16),clearTimeout(this.highQualityTimeout),!this.originalPixelRatio&&this.viewer.drawer&&(this.originalPixelRatio=this.viewer.drawer.pixelRatio||this.basePixelRatio);const e=this.originalPixelRatio*this.scalingFactor;if(console.log("Safari: Reducing render quality for interaction",{from:this.originalPixelRatio,to:e,scalingFactor:this.scalingFactor}),this.viewer.drawer&&(this.viewer.drawer.pixelRatio=e,this.viewer.drawer.canvas)){const i=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=Math.floor(i.x*e),this.viewer.drawer.canvas.height=Math.floor(i.y*e)}if(this.viewer.drawer&&(this.viewer.drawer.context&&(this.viewer.drawer.context.imageSmoothingEnabled=!1,this.viewer.drawer.context.webkitImageSmoothingEnabled=!1),this.viewer.immediateRender=!0,this.viewer.blendTime=0,this.viewer.alwaysBlend=!1,this.originalSettings={immediateRender:this.viewer.immediateRender,blendTime:this.viewer.blendTime,alwaysBlend:this.viewer.alwaysBlend,imageLoaderLimit:(t=this.viewer.imageLoader)==null?void 0:t.jobLimit}),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),this.viewer.world){const i=this.viewer.world.getItemAt(0);i&&(i.skipLevelIfLargerThan=.9)}if(this.averageFPS<15&&this.scalingFactor<=.2&&(console.log("Safari: ULTRA PERFORMANCE MODE activated"),this.viewer.minPixelRatio=2,this.viewer.maxTilesPerFrame=1,this.viewer.visibilityRatio=1,window.nativeHotspotRenderer&&(window.nativeHotspotRenderer.performanceMode=!0)),this.viewer.tileCache){const i=this.viewer.tileCache;this.originalCacheSize=i._maxImageCacheCount,i._maxImageCacheCount=Math.floor(this.originalCacheSize*.3)}this.viewer.forceRedraw()}endInteraction(){if(!this.isSafari||!this.isInteracting)return;this.isInteracting=!1,this.velocityCheckInterval&&(clearInterval(this.velocityCheckInterval),this.velocityCheckInterval=null);const e=performance.now()-this.lastInteractionStart;console.log(`Safari: Interaction ended (duration: ${e.toFixed(0)}ms)`),this.highQualityTimeout=setTimeout(()=>{const t=this.originalPixelRatio||this.basePixelRatio;if(console.log("Safari: Restoring full render quality",{to:t}),this.viewer.drawer&&(this.viewer.drawer.pixelRatio=t,this.viewer.drawer.canvas)){const i=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=Math.floor(i.x*t),this.viewer.drawer.canvas.height=Math.floor(i.y*t)}if(this.originalSettings&&(this.viewer.immediateRender=this.originalSettings.immediateRender!==void 0?this.originalSettings.immediateRender:!1,this.viewer.blendTime=this.originalSettings.blendTime!==void 0?this.originalSettings.blendTime:.5,this.viewer.alwaysBlend=this.originalSettings.alwaysBlend!==void 0?this.originalSettings.alwaysBlend:!1,this.viewer.imageLoader&&this.originalSettings.imageLoaderLimit&&(this.viewer.imageLoader.jobLimit=this.originalSettings.imageLoaderLimit)),this.viewer.drawer&&this.viewer.drawer.context&&(this.viewer.drawer.context.imageSmoothingEnabled=!0,this.viewer.drawer.context.webkitImageSmoothingEnabled=!0),this.viewer.world){const i=this.viewer.world.getItemAt(0);i&&(i.skipLevelIfLargerThan=1/0)}this.viewer.tileCache&&this.originalCacheSize&&(this.viewer.tileCache._maxImageCacheCount=this.originalCacheSize),this.viewer.forceRedraw()},this.restoreDelay)}updateVelocity(){if(!this.viewer.viewport)return;const e=this.viewer.viewport.getCenter();if(this.lastPosition){const t=e.x-this.lastPosition.x,i=e.y-this.lastPosition.y,r=Math.sqrt(t*t+i*i)*1e3;this.velocityBuffer.push(r),this.velocityBuffer.length>3&&this.velocityBuffer.shift(),this.velocity=this.velocityBuffer.reduce((a,l)=>a+l,0)/this.velocityBuffer.length;let n;if(this.velocity>10?n=.5:this.velocity>5?n=.65:this.velocity>2?n=.75:n=.85,this.scalingFactor=this.scalingFactor*.7+n*.3,this.isInteracting&&this.viewer.drawer){const a=(this.originalPixelRatio||this.basePixelRatio)*this.scalingFactor;if(Math.abs(this.viewer.drawer.pixelRatio-a)>.05&&(this.viewer.drawer.pixelRatio=a,this.viewer.drawer.canvas)){const l=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=Math.floor(l.x*a),this.viewer.drawer.canvas.height=Math.floor(l.y*a)}}}this.lastPosition=e}updatePerformanceMetrics(e,t=!1){this.averageFPS=this.averageFPS*.9+e*.1,this.averageFPS<20&&this.scalingFactor>.4?(this.scalingFactor=.4,t&&console.log(`Safari: EMERGENCY - Reduced scaling factor to ${this.scalingFactor} due to very low FPS`)):this.averageFPS<30&&this.scalingFactor>.4?(this.scalingFactor=Math.max(.4,this.scalingFactor-.1),t&&console.log(`Safari: Reduced scaling factor to ${this.scalingFactor} due to low FPS`)):this.averageFPS>50&&this.scalingFactor<.75&&(this.scalingFactor=Math.min(.75,this.scalingFactor+.05),t&&console.log(`Safari: Increased scaling factor to ${this.scalingFactor} due to good FPS`))}forceOptimization(e){e?(this.startInteraction(),clearTimeout(this.highQualityTimeout)):(this.isInteracting=!1,this.endInteraction())}getState(){const e=this.viewer.drawer?this.viewer.drawer.pixelRatio:this.basePixelRatio;return{isActive:this.isSafari,isInteracting:this.isInteracting,currentPixelRatio:e,basePixelRatio:this.basePixelRatio,scalingFactor:this.scalingFactor,averageFPS:this.averageFPS.toFixed(1),platform:this.isIOS?"iOS Safari":"Desktop Safari"}}destroy(){clearTimeout(this.highQualityTimeout),this.velocityCheckInterval&&clearInterval(this.velocityCheckInterval)}}class ze{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(e,t){let i=this.length++;for(;i>0;){const r=i-1>>1,n=this.values[r];if(t>=n)break;this.ids[i]=this.ids[r],this.values[i]=n,i=r}this.ids[i]=e,this.values[i]=t}pop(){if(this.length===0)return;const e=this.ids[0];if(this.length--,this.length>0){const t=this.ids[0]=this.ids[this.length],i=this.values[0]=this.values[this.length],r=this.length>>1;let n=0;for(;n<r;){let a=(n<<1)+1;const l=a+1;let h=this.ids[a],g=this.values[a];const p=this.values[l];if(l<this.length&&p<g&&(a=l,h=this.ids[l],g=p),g>=i)break;this.ids[n]=h,this.values[n]=g,n=a}this.ids[n]=t,this.values[n]=i}return e}peek(){if(this.length!==0)return this.ids[0]}peekValue(){if(this.length!==0)return this.values[0]}shrink(){this.ids.length=this.values.length=this.length}}const ge=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],G=3;class J{static from(e,t=0){if(t%8!==0)throw new Error("byteOffset must be 8-byte aligned.");if(!e||e.byteLength===void 0||e.buffer)throw new Error("Data must be an instance of ArrayBuffer or SharedArrayBuffer.");const[i,r]=new Uint8Array(e,t+0,2);if(i!==251)throw new Error("Data does not appear to be in a Flatbush format.");const n=r>>4;if(n!==G)throw new Error(`Got v${n} data when expected v${G}.`);const a=ge[r&15];if(!a)throw new Error("Unrecognized array type.");const[l]=new Uint16Array(e,t+2,1),[h]=new Uint32Array(e,t+4,1);return new J(h,l,a,void 0,e,t)}constructor(e,t=16,i=Float64Array,r=ArrayBuffer,n,a=0){if(e===void 0)throw new Error("Missing required argument: numItems.");if(isNaN(e)||e<=0)throw new Error(`Unexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.byteOffset=a;let l=e,h=l;this._levelBounds=[l*4];do l=Math.ceil(l/this.nodeSize),h+=l,this._levelBounds.push(h*4);while(l!==1);this.ArrayType=i,this.IndexArrayType=h<16384?Uint16Array:Uint32Array;const g=ge.indexOf(i),p=h*4*i.BYTES_PER_ELEMENT;if(g<0)throw new Error(`Unexpected typed array class: ${i}.`);if(n)this.data=n,this._boxes=new i(n,a+8,h*4),this._indices=new this.IndexArrayType(n,a+8+p,h),this._pos=h*4,this.minX=this._boxes[this._pos-4],this.minY=this._boxes[this._pos-3],this.maxX=this._boxes[this._pos-2],this.maxY=this._boxes[this._pos-1];else{const s=this.data=new r(8+p+h*this.IndexArrayType.BYTES_PER_ELEMENT);this._boxes=new i(s,8,h*4),this._indices=new this.IndexArrayType(s,8+p,h),this._pos=0,this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,new Uint8Array(s,0,2).set([251,(G<<4)+g]),new Uint16Array(s,2,1)[0]=t,new Uint32Array(s,4,1)[0]=e}this._queue=new ze}add(e,t,i=e,r=t){const n=this._pos>>2,a=this._boxes;return this._indices[n]=n,a[this._pos++]=e,a[this._pos++]=t,a[this._pos++]=i,a[this._pos++]=r,e<this.minX&&(this.minX=e),t<this.minY&&(this.minY=t),i>this.maxX&&(this.maxX=i),r>this.maxY&&(this.maxY=r),n}finish(){if(this._pos>>2!==this.numItems)throw new Error(`Added ${this._pos>>2} items when expected ${this.numItems}.`);const e=this._boxes;if(this.numItems<=this.nodeSize){e[this._pos++]=this.minX,e[this._pos++]=this.minY,e[this._pos++]=this.maxX,e[this._pos++]=this.maxY;return}const t=this.maxX-this.minX||1,i=this.maxY-this.minY||1,r=new Uint32Array(this.numItems),n=65535;for(let a=0,l=0;a<this.numItems;a++){const h=e[l++],g=e[l++],p=e[l++],s=e[l++],o=Math.floor(n*((h+p)/2-this.minX)/t),c=Math.floor(n*((g+s)/2-this.minY)/i);r[a]=Re(o,c)}j(r,e,this._indices,0,this.numItems-1,this.nodeSize);for(let a=0,l=0;a<this._levelBounds.length-1;a++){const h=this._levelBounds[a];for(;l<h;){const g=l;let p=e[l++],s=e[l++],o=e[l++],c=e[l++];for(let u=1;u<this.nodeSize&&l<h;u++)p=Math.min(p,e[l++]),s=Math.min(s,e[l++]),o=Math.max(o,e[l++]),c=Math.max(c,e[l++]);this._indices[this._pos>>2]=g,e[this._pos++]=p,e[this._pos++]=s,e[this._pos++]=o,e[this._pos++]=c}}}search(e,t,i,r,n){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let a=this._boxes.length-4;const l=[],h=[];for(;a!==void 0;){const g=Math.min(a+this.nodeSize*4,fe(a,this._levelBounds));for(let p=a;p<g;p+=4){if(i<this._boxes[p]||r<this._boxes[p+1]||e>this._boxes[p+2]||t>this._boxes[p+3])continue;const s=this._indices[p>>2]|0;a>=this.numItems*4?l.push(s):(n===void 0||n(s))&&h.push(s)}a=l.pop()}return h}neighbors(e,t,i=1/0,r=1/0,n){if(this._pos!==this._boxes.length)throw new Error("Data not yet indexed - call index.finish().");let a=this._boxes.length-4;const l=this._queue,h=[],g=r*r;e:for(;a!==void 0;){const p=Math.min(a+this.nodeSize*4,fe(a,this._levelBounds));for(let s=a;s<p;s+=4){const o=this._indices[s>>2]|0,c=this._boxes[s],u=this._boxes[s+1],d=this._boxes[s+2],w=this._boxes[s+3],f=e<c?c-e:e>d?e-d:0,v=t<u?u-t:t>w?t-w:0,T=f*f+v*v;T>g||(a>=this.numItems*4?l.push(o<<1,T):(n===void 0||n(o))&&l.push((o<<1)+1,T))}for(;l.length&&l.peek()&1;)if(l.peekValue()>g||(h.push(l.pop()>>1),h.length===i))break e;a=l.length?l.pop()>>1:void 0}return l.clear(),h}}function fe(m,e){let t=0,i=e.length-1;for(;t<i;){const r=t+i>>1;e[r]>m?i=r:t=r+1}return e[t]}function j(m,e,t,i,r,n){if(Math.floor(i/n)>=Math.floor(r/n))return;const a=m[i],l=m[i+r>>1],h=m[r];let g=h;const p=Math.max(a,l);h>p?g=p:p===a?g=Math.max(l,h):p===l&&(g=Math.max(a,h));let s=i-1,o=r+1;for(;;){do s++;while(m[s]<g);do o--;while(m[o]>g);if(s>=o)break;ke(m,e,t,s,o)}j(m,e,t,i,o,n),j(m,e,t,o+1,r,n)}function ke(m,e,t,i,r){const n=m[i];m[i]=m[r],m[r]=n;const a=4*i,l=4*r,h=e[a],g=e[a+1],p=e[a+2],s=e[a+3];e[a]=e[l],e[a+1]=e[l+1],e[a+2]=e[l+2],e[a+3]=e[l+3],e[l]=h,e[l+1]=g,e[l+2]=p,e[l+3]=s;const o=t[i];t[i]=t[r],t[r]=o}function Re(m,e){let t=m^e,i=65535^t,r=65535^(m|e),n=m&(e^65535),a=t|i>>1,l=t>>1^t,h=r>>1^i&n>>1^r,g=t&r>>1^n>>1^n;t=a,i=l,r=h,n=g,a=t&t>>2^i&i>>2,l=t&i>>2^i&(t^i)>>2,h^=t&r>>2^i&n>>2,g^=i&r>>2^(t^i)&n>>2,t=a,i=l,r=h,n=g,a=t&t>>4^i&i>>4,l=t&i>>4^i&(t^i)>>4,h^=t&r>>4^i&n>>4,g^=i&r>>4^(t^i)&n>>4,t=a,i=l,r=h,n=g,h^=t&r>>8^i&n>>8,g^=i&r>>8^(t^i)&n>>8,t=h^h>>1,i=g^g>>1;let p=m^e,s=i|65535^(p|t);return p=(p|p<<8)&16711935,p=(p|p<<4)&252645135,p=(p|p<<2)&858993459,p=(p|p<<1)&1431655765,s=(s|s<<8)&16711935,s=(s|s<<4)&252645135,s=(s|s<<2)&858993459,s=(s|s<<1)&1431655765,(s<<1|p)>>>0}class Le{constructor(){this.index=null,this.hotspots=[],this.hotspotsMap=new Map,this.centerPoints=[],this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(e){const t=performance.now();this.hotspots=[],this.hotspotsMap.clear(),this.centerPoints=[],this.queryCache.clear();const i=e.length;this.index=new J(i),e.forEach((n,a)=>{const l=this.calculateBoundingBox(n.coordinates),h=(l.minX+l.maxX)/2,g=(l.minY+l.maxY)/2,p={...n,bbox:l,center:{x:h,y:g},index:a};this.hotspots.push(p),this.hotspotsMap.set(n.id,p),this.centerPoints.push([h,g]),this.index.add(l.minX,l.minY,l.maxX,l.maxY)}),this.index.finish();const r=performance.now()-t;console.log(`[Flatbush] Spatial index built in ${r.toFixed(2)}ms for ${i} hotspots`)}queryViewport(e,t=1){const i=`${e.minX.toFixed(2)},${e.minY.toFixed(2)},${e.maxX.toFixed(2)},${e.maxY.toFixed(2)},${t.toFixed(2)}`;if(this.queryCache.has(i))return this.queryCache.get(i);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const n=this.index.search(e.minX,e.minY,e.maxX,e.maxY).map(a=>this.hotspots[a]);return this.queryCache.size<this.cacheSize&&this.queryCache.set(i,n),n}getHotspotAtPoint(e,t){const i=this.index.search(e,t,e,t);for(const r of i){const n=this.hotspots[r];if(this.isPointInHotspot(e,t,n))return n}return null}findNearbyHotspots(e,t,i=200,r=10){const n=performance.now(),a=this.index.search(e-i,t-i,e+i,t+i),l=[];for(const p of a){const s=this.hotspots[p],o=s.center.x-e,c=s.center.y-t,u=Math.sqrt(o*o+c*c);u<=i&&l.push({hotspot:s,distance:u})}l.sort((p,s)=>p.distance-s.distance);const h=l.slice(0,r).map(p=>p.hotspot),g=performance.now()-n;return g>5&&console.warn(`[Flatbush] Slow nearby search: ${g.toFixed(2)}ms for ${h.length} results`),h}findAdjacentHotspots(e,t,i=10,r=100){const n=performance.now(),a=500,l=this.index.search(e-a,t-a,e+a,t+a);let h=null,g=1/0;for(const u of l){const d=this.hotspots[u],w=d.center.x-e,f=d.center.y-t,v=Math.sqrt(w*w+f*f);v<g&&(g=v,h=d)}if(!h)return console.log("[SpatialIndex] No hotspot found near tap point"),[];const p=new Set([h.id]),s=[h],o=[h];for(;s.length>0&&o.length<i;){const u=s.shift(),d=this.findAdjacentNeighbors(u,r);for(const w of d)!p.has(w.id)&&o.length<i&&(p.add(w.id),o.push(w),s.push(w))}const c=performance.now()-n;return console.log(`[SpatialIndex] Found ${o.length} adjacent hotspots in ${c.toFixed(2)}ms`),o}findAdjacentNeighbors(e,t=100){const i=e.bbox,r=this.index.search(i.minX-t,i.minY-t,i.maxX+t,i.maxY+t),n=[];for(const a of r){const l=this.hotspots[a];l.id!==e.id&&this.areBoundingBoxesAdjacent(i,l.bbox,t)&&n.push(l)}return n.sort((a,l)=>{const h=Math.sqrt(Math.pow(a.center.x-e.center.x,2)+Math.pow(a.center.y-e.center.y,2)),g=Math.sqrt(Math.pow(l.center.x-e.center.x,2)+Math.pow(l.center.y-e.center.y,2));return h-g}),n}areBoundingBoxesAdjacent(e,t,i){const r=Math.max(0,Math.max(e.minX,t.minX)-Math.min(e.maxX,t.maxX)),n=Math.max(0,Math.max(e.minY,t.minY)-Math.min(e.maxY,t.maxY));return r<i&&n<i}calculateBoundingBox(e){let t=1/0,i=1/0,r=-1/0,n=-1/0;const a=l=>{for(const h of l)t=Math.min(t,h[0]),i=Math.min(i,h[1]),r=Math.max(r,h[0]),n=Math.max(n,h[1])};if(e.length>0&&typeof e[0][0]=="number")a(e);else for(const l of e)a(l);return{minX:t,minY:i,maxX:r,maxY:n}}isPointInHotspot(e,t,i){return i.shape==="polygon"?this.pointInPolygon(e,t,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(r=>this.pointInPolygon(e,t,r)):!1}pointInPolygon(e,t,i){let r=!1;const n=i.length;let a=i[0][0],l=i[0][1];for(let h=1;h<=n;h++){const g=i[h%n][0],p=i[h%n][1];if(t>Math.min(l,p)&&t<=Math.max(l,p)&&e<=Math.max(a,g)&&l!==p){const s=(t-l)*(g-a)/(p-l)+a;(a===g||e<=s)&&(r=!r)}a=g,l=p}return r}getAllHotspots(){return this.hotspots}getHotspotById(e){return this.hotspotsMap.get(e)}clear(){this.index=null,this.hotspots=[],this.hotspotsMap.clear(),this.centerPoints=[],this.queryCache.clear()}}class Oe{constructor(e){this.viewer=e,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:10}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(e){if(!e.tile)return;const t=this.getTileKey(e.tile);this.tileAccessTimes.set(t,Date.now())}handleViewportChange(){var i;const e=(i=this.viewer.world)==null?void 0:i.getItemAt(0);if(!e||!e._tilesToDraw)return;const t=Date.now();e._tilesToDraw.forEach(r=>{const n=this.getTileKey(r);this.tileAccessTimes.set(n,t)})}getTileKey(e){return`${e.level}_${e.x}_${e.y}`}monitorPerformance(){var r,n;const e=((n=(r=window.performanceMonitor)==null?void 0:r.getMetrics())==null?void 0:n.averageFPS)||60,t=this.state.currentPressure;/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?e<10?this.state.currentPressure="critical":e<15?this.state.currentPressure="high":e<25?this.state.currentPressure="elevated":this.state.currentPressure="normal":e<this.config.fpsThresholds.critical?this.state.currentPressure="critical":e<this.config.fpsThresholds.poor?this.state.currentPressure="high":e<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",t!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${t}  ${this.state.currentPressure} (FPS: ${e})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const t={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),t)}performCleanup(){var T;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const t=performance.now(),i=(T=this.viewer.world)==null?void 0:T.getItemAt(0);if(!i||!i._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const n=this.state.currentPressure,a=this.config.maxTileAge[n],l=this.config.cacheThresholds[n],h=this.config.keepDistance[n],g=Date.now(),s=this.viewer.viewport.getBounds(),o={x:s.x-s.width*(h-1)/2,y:s.y-s.height*(h-1)/2,width:s.width*h,height:s.height*h},u=i._tileCache._tilesLoaded||[],d=u.length;if(d===0)return;const w=new Set;i._tilesToDraw&&i._tilesToDraw.forEach(_=>{const x=this.getTileKey(_);w.add(x)});const f=[];if(u.forEach(_=>{const x=this.getTileKey(_);if(w.has(x))return;const A=this.tileAccessTimes.get(x)||0,M=g-A;let C=!1;if(M>a&&(C=!0),!C&&n!=="normal"){const b=_.bounds;b&&(!(b.x+b.width<o.x||b.x>o.x+o.width||b.y+b.height<o.y||b.y>o.y+o.height)||(C=!0))}C&&f.push(_)}),d>l){const _=d-l;if(_>f.length){const x=u.filter(M=>{const C=this.getTileKey(M);return!f.includes(M)&&!w.has(C)});x.sort((M,C)=>{const b=this.getTileKey(M),E=this.getTileKey(C),k=this.tileAccessTimes.get(b)||0,D=this.tileAccessTimes.get(E)||0;return k-D});const A=_-f.length;f.push(...x.slice(0,A))}}f.length>0&&(f.forEach(_=>{const x=this.getTileKey(_);this.tileAccessTimes.delete(x),_.unload&&_.unload()}),this.state.tilesRemoved+=f.length,this.metrics.totalCleaned+=f.length,console.log(`Cleaned ${f.length} tiles (pressure: ${n}, cache was: ${d}, kept ${w.size} visible)`));const v=performance.now()-t;this.metrics.lastCleanupDuration=v,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+v)/this.metrics.cleanupRuns,this.state.lastCleanup=g,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const t=performance.now(),i=Date.now(),r=3e5,n=[];this.tileAccessTimes.forEach((l,h)=>{i-l>r&&n.push(h)}),n.forEach(l=>this.tileAccessTimes.delete(l)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const a=performance.now()-t;this.state.lastDeepCleanup=i,console.log(`Deep cleanup completed in ${a.toFixed(2)}ms, cleared ${n.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var i,r,n;const e=(i=this.viewer.world)==null?void 0:i.getItemAt(0),t=((n=(r=e==null?void 0:e._tileCache)==null?void 0:r._tilesLoaded)==null?void 0:n.length)||0;return{...this.metrics,currentCacheSize:t,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(e){["normal","elevated","high","critical"].includes(e)&&(this.state.currentPressure=e,this.updateCleanupInterval())}pauseCleanup(e=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},e))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class De{constructor(e){this.viewer=e,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(e){throw console.error("Failed to initialize TileWorkerManager:",e),this.state.lastError=e,e}}async processTile(e,t=2){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((r,n)=>{const a=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,n(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(i,{resolve:r,reject:n,timeout:a,startTime:performance.now(),tile:e}),this.worker.postMessage({type:"process-tile",requestId:i,data:{tile:this.serializeTile(e),priority:t}}),this.metrics.requestsSent++})}async processBatch(e,t=[]){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((r,n)=>{const a=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,n(new Error("Batch processing timeout"))},this.config.requestTimeout*e.length);this.state.pendingRequests.set(i,{resolve:r,reject:n,timeout:a,startTime:performance.now(),tiles:e}),this.worker.postMessage({type:"batch-process",requestId:i,data:{tiles:e.map(l=>this.serializeTile(l)),priorities:t}}),this.metrics.requestsSent++})}async prioritizeTiles(e,t){if(this.isInitialized||await this.initialize(),e.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const r=e.map(n=>{const a=(n.bounds.minX+n.bounds.maxX)/2,l=(n.bounds.minY+n.bounds.maxY)/2,h=(t.bounds.minX+t.bounds.maxX)/2,g=(t.bounds.minY+t.bounds.maxY)/2,p=Math.sqrt(Math.pow(a-h,2)+Math.pow(l-g,2));return p<.5?0:p<1?1:2});return{tiles:e,priorities:r}}const i=this.generateRequestId();return new Promise((r,n)=>{const a=setTimeout(()=>{this.state.pendingRequests.delete(i),r({tiles:e,priorities:e.map(()=>1)})},50);this.state.pendingRequests.set(i,{resolve:r,reject:n,timeout:a}),this.worker.postMessage({type:"prioritize",requestId:i,data:{tiles:e.map(l=>this.serializeTile(l)),viewport:{bounds:t.bounds,zoom:t.zoom}}})})}clearCache(e=!1,t=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:e,maxAge:t}})}async getStats(){if(!this.isInitialized)return this.metrics;const e=this.generateRequestId();return new Promise(t=>{const i=setTimeout(()=>{this.state.pendingRequests.delete(e),t(this.metrics)},1e3);this.state.pendingRequests.set(e,{resolve:t,reject:()=>{},timeout:i}),this.worker.postMessage({type:"get-stats",requestId:e})})}handleWorkerMessage(e){const{type:t,requestId:i,data:r}=e.data;switch(t){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=r.capabilities,this.handleRequestComplete(i,r);break;case"tile-ready":this.handleTileReady(i,r);break;case"tile-error":this.handleTileError(i,r);break;case"batch-complete":this.handleRequestComplete(i,r);break;case"priorities-calculated":this.handleRequestComplete(i,r);break;case"stats":this.handleStatsReceived(i,r);break;case"cache-cleared":console.log("Worker cache cleared:",r);break;default:console.warn("Unknown worker message type:",t)}}handleWorkerError(e){console.error("Worker error:",e),this.state.lastError=e,this.state.pendingRequests.forEach((t,i)=>{clearTimeout(t.timeout),t.reject(e)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(e,t){const i=this.state.pendingRequests.get(e);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(e);const r=performance.now()-i.startTime;this.updateMetrics(r,t.cached),i.resolve({...t,processingTime:r})}handleTileError(e,t){const i=this.state.pendingRequests.get(e);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(e),this.metrics.requestsFailed++,i.reject(new Error(t.error)))}handleRequestComplete(e,t){const i=this.state.pendingRequests.get(e);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(e),i.resolve(t))}handleStatsReceived(e,t){const i=this.state.pendingRequests.get(e);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(e);const r={...this.metrics,worker:t};i.resolve(r)}updateMetrics(e,t){this.metrics.requestsCompleted++,t&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=e,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(e){return{level:e.level,x:e.x,y:e.y,bounds:e.bounds?{minX:e.bounds.x||e.bounds.minX,minY:e.bounds.y||e.bounds.minY,maxX:(e.bounds.x||e.bounds.minX)+(e.bounds.width||0),maxY:(e.bounds.y||e.bounds.minY)+(e.bounds.height||0)}:null,url:e.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(e=>{if(this.state.workerReady){e();return}const t=setInterval(()=>{this.state.workerReady&&(clearInterval(t),e())},100);setTimeout(()=>{clearInterval(t),e()},5e3)})}async sendToWorker(e,t){const i=this.generateRequestId();return new Promise((r,n)=>{const a=setTimeout(()=>{this.state.pendingRequests.delete(i),n(new Error(`Worker request timeout: ${e}`))},5e3);this.state.pendingRequests.set(i,{resolve:r,reject:n,timeout:a}),this.worker.postMessage({type:e,requestId:i,data:t})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(e=>{clearTimeout(e.timeout),e.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class He{constructor(e){this.viewer=e,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new De(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(e){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",e),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const e=this.viewer.viewport,t=e.getBounds(),i={bounds:{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height},zoom:e.getZoom()},r=this.state.tileQueue.slice(0,50),n=await this.workerManager.prioritizeTiles(r,i);n.tiles&&n.priorities&&(n.tiles.forEach((a,l)=>{const h=n.priorities[l],g=this.state.tileQueue.find(p=>p.level===a.level&&p.x===a.x&&p.y===a.y);g&&(g.priority=h)}),this.sortQueue())}catch(e){console.warn("Failed to update worker priorities:",e)}}calculateTilePriority(e,t,i){const r=this.viewer.viewport,n=r.getBounds(),a=r.getCenter(),l=r.getZoom();if(l<2&&this.viewer.source.getTileWidth(e)*l<32)return 999;const h=this.viewer.source.getTileWidth(e),g=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(e):h,p=(t+.5)*h/this.viewer.source.width,s=(i+.5)*g/this.viewer.source.height,o=Math.sqrt(Math.pow(p-a.x,2)+Math.pow(s-a.y,2)),c={left:t*h/this.viewer.source.width,top:i*g/this.viewer.source.height,right:(t+1)*h/this.viewer.source.width,bottom:(i+1)*g/this.viewer.source.height};return c.right<n.x||c.left>n.x+n.width||c.bottom<n.y||c.top>n.y+n.height?o<n.width*this.config.predictiveRadius?1:2:l<3?Math.abs(p-a.x)+Math.abs(s-a.y)<.2?0:1:0}enqueueTile(e,t,i,r){const n=`${e}_${t}_${i}`;if(this.state.loadingTiles.has(n))return;const a=this.state.tileQueue.findIndex(h=>h.key===n);if(a>=0){r<this.state.tileQueue[a].priority&&(this.state.tileQueue[a].priority=r,this.sortQueue());return}const l={level:e,x:t,y:i,key:n,priority:r,timestamp:Date.now(),bounds:this.calculateTileBounds(e,t,i)};this.state.tileQueue.push(l),this.sortQueue()}calculateTileBounds(e,t,i){const r=this.viewer.source.getTileWidth(e),n=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(e):r,a=this.viewer.source.width,l=this.viewer.source.height;return{minX:t*r/a,minY:i*n/l,maxX:(t+1)*r/a,maxY:(i+1)*n/l}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const e=this.state.tileQueue.filter(t=>t.priority<=1).slice(0,this.config.workerBatchSize);if(e.length!==0)try{const t=e.map(n=>n.priority),i=performance.now();await this.workerManager.processBatch(e,t);const r=performance.now()-i;this.workerMetrics.tilesProcessedByWorker+=e.length,this.workerMetrics.workerProcessingTime+=r,e.forEach(n=>{const a=this.state.tileQueue.findIndex(l=>l.key===n.key);a>=0&&this.state.tileQueue.splice(a,1)})}catch(t){console.error("Worker batch processing failed:",t),this.workerMetrics.workerErrors++}}processQueue(){var t;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((t=this.viewer.world)!=null&&t.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const i=this.state.tileQueue.shift();Date.now()-i.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(i.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((e,t)=>e.priority!==t.priority?e.priority-t.priority:e.timestamp-t.timestamp)}predictiveLoad(){var o;if(this.shouldSkipPredictiveLoad()||!((o=this.viewer.world)==null?void 0:o.getItemAt(0))||!this.viewer.source)return;const t=this.viewer.viewport,i=t.getBounds(),r={x:i.x-i.width*(this.config.predictiveRadius-1)/2,y:i.y-i.height*(this.config.predictiveRadius-1)/2,width:i.width*this.config.predictiveRadius,height:i.height*this.config.predictiveRadius},n=t.getZoom(),a=Math.max(0,Math.min(Math.floor(Math.log2(n)),this.viewer.source.maxLevel||14)),l=this.viewer.source.getTileWidth(a),h=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(a):l,g=this.viewer.source.width,p=this.viewer.source.height,s={startX:Math.max(0,Math.floor(r.x*g/l)),endX:Math.min(Math.ceil(g/l)-1,Math.ceil((r.x+r.width)*g/l)),startY:Math.max(0,Math.floor(r.y*p/h)),endY:Math.min(Math.ceil(p/h)-1,Math.ceil((r.y+r.height)*p/h))};for(let c=s.startX;c<=s.endX;c++)for(let u=s.startY;u<=s.endY;u++){const d=this.calculateTilePriority(a,c,u);this.enqueueTile(a,c,u,d)}}trackLoadTime(e){this.state.loadTimes.push(e),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((t,i)=>t+i,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(e){this.state.loadingTiles.delete(e)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const e=this.state.averageLoadTime,t=this.config.maxConcurrentLoads,r=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?4:8;e>500&&t>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${e.toFixed(0)}ms)`)):e<200&&t<r&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${e.toFixed(0)}ms)`))}performCleanup(){const e=Date.now();this.state.tileQueue=this.state.tileQueue.filter(t=>e-t.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=e,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const e=document.createElement("canvas");e.width=e.height=1;const t=e.getContext("2d");t.fillStyle="rgba(0,0,0,0)",t.fillRect(0,0,1,1);try{return e.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const e=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:e}}}class Ze{constructor(e=60){this.targetFPS=e,this.targetFrameTime=1e3/e,this.frameTimings=new Float32Array(120),this.frameIndex=0,this.frameCount=0,this.currentFPS=e,this.averageFPS=e,this.percentile95FPS=e,this.lastFrameStart=performance.now(),this.currentFrameStart=performance.now(),this.frameTimeUsed=0,this.budgetRemaining=this.targetFrameTime,this.emaAlpha=.1,this.emaFPS=e,this.degradeThreshold=.8,this.upgradeThreshold=.6,this.onQualityAdjust=null,this.performanceSamples=[],this.isStable=!1}startFrame(){this.lastFrameStart=this.currentFrameStart,this.currentFrameStart=performance.now();const e=this.currentFrameStart-this.lastFrameStart;return this.frameTimings[this.frameIndex]=e,this.frameIndex=(this.frameIndex+1)%this.frameTimings.length,this.frameCount=Math.min(this.frameCount+1,this.frameTimings.length),this.updateStatistics(),this.frameTimeUsed=0,this.budgetRemaining=this.targetFrameTime,{targetFrameTime:this.targetFrameTime,budgetRemaining:this.budgetRemaining,isOverBudget:!1,shouldDegrade:!1}}endFrame(){const e=performance.now();this.frameTimeUsed=e-this.currentFrameStart;const t=this.frameTimeUsed/this.targetFrameTime,i=t>1,r=t>this.degradeThreshold,n=t<this.upgradeThreshold&&this.isStable;return this.onQualityAdjust&&this.frameCount>30&&(r&&this.averageFPS<this.targetFPS*.9?this.onQualityAdjust("degrade",this.averageFPS):n&&this.averageFPS>this.targetFPS*.95&&this.onQualityAdjust("upgrade",this.averageFPS)),{frameTimeUsed:this.frameTimeUsed,budgetUsageRatio:t,isOverBudget:i,shouldDegrade:r,canUpgrade:n}}checkBudget(){const e=performance.now();return this.frameTimeUsed=e-this.currentFrameStart,this.budgetRemaining=Math.max(0,this.targetFrameTime-this.frameTimeUsed),{timeUsed:this.frameTimeUsed,budgetRemaining:this.budgetRemaining,isOverBudget:this.budgetRemaining<=0}}updateStatistics(){if(this.frameCount<2)return;const e=this.frameTimings[(this.frameIndex-1+this.frameTimings.length)%this.frameTimings.length];this.currentFPS=e>0?1e3/e:this.targetFPS,this.emaFPS=this.emaAlpha*this.currentFPS+(1-this.emaAlpha)*this.emaFPS;let t=0;const i=Math.min(this.frameCount,60);for(let r=0;r<i;r++){const n=(this.frameIndex-1-r+this.frameTimings.length)%this.frameTimings.length;t+=this.frameTimings[n]}if(this.averageFPS=i>0?i*1e3/t:this.targetFPS,this.frameCount>=30){const r=new Float32Array(i);for(let l=0;l<i;l++){const h=(this.frameIndex-1-l+this.frameTimings.length)%this.frameTimings.length;r[l]=this.frameTimings[h]}r.sort();const n=Math.floor(i*.95),a=r[n];this.percentile95FPS=a>0?1e3/a:this.targetFPS}this.checkStability()}checkStability(){if(this.frameCount<60){this.isStable=!1;return}const e=30;let t=0,i=0;for(let h=0;h<e;h++){const g=(this.frameIndex-1-h+this.frameTimings.length)%this.frameTimings.length,p=this.frameTimings[g];t+=p,i+=p*p}const r=t/e,n=i/e-r*r,l=Math.sqrt(n)/r;this.isStable=l<.15}getMetrics(){return{currentFPS:Math.round(this.currentFPS),averageFPS:Math.round(this.averageFPS),smoothFPS:Math.round(this.emaFPS),percentile95FPS:Math.round(this.percentile95FPS),targetFPS:this.targetFPS,isStable:this.isStable,frameCount:this.frameCount}}canPerformOperation(e){return this.checkBudget().budgetRemaining>=e}reset(){this.frameTimings.fill(this.targetFrameTime),this.frameIndex=0,this.frameCount=0,this.currentFPS=this.targetFPS,this.averageFPS=this.targetFPS,this.emaFPS=this.targetFPS,this.percentile95FPS=this.targetFPS,this.isStable=!1}setTargetFPS(e){this.targetFPS=e,this.targetFrameTime=1e3/e,this.reset()}}class Be{constructor(){this.platform=this.detectPlatform(),this.browser=this.detectBrowser(),this.deviceMemory=navigator.deviceMemory||null,this.hardwareConcurrency=navigator.hardwareConcurrency||4,this.pixelRatio=window.devicePixelRatio||1,this.screenWidth=window.screen.width*this.pixelRatio,this.screenHeight=window.screen.height*this.pixelRatio,this.gpuTier=null,this.gpuInfo=null,this.performanceTier=null,this.tierDetails=null,this.isOnBattery=!1,this.batteryLevel=1,this.initBatteryMonitoring()}detectPlatform(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"ios":/Android/i.test(e)?"android":/Windows/i.test(e)?"windows":/Mac/i.test(e)?"mac":/Linux/i.test(e)?"linux":"unknown"}detectBrowser(){const e=navigator.userAgent;return/Chrome/i.test(e)&&!/Edge/i.test(e)?"chrome":/Firefox/i.test(e)?"firefox":/^((?!chrome|android).)*safari/i.test(e)?"safari":/Edge/i.test(e)?"edge":"unknown"}async initBatteryMonitoring(){if("getBattery"in navigator)try{const e=await navigator.getBattery();this.isOnBattery=!e.charging,this.batteryLevel=e.level,e.addEventListener("chargingchange",()=>{this.isOnBattery=!e.charging}),e.addEventListener("levelchange",()=>{this.batteryLevel=e.level})}catch{console.log("Battery API not available")}}async detectGPU(){const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(t){const i=t.getExtension("WEBGL_debug_renderer_info");if(i){const r=t.getParameter(i.UNMASKED_VENDOR_WEBGL),n=t.getParameter(i.UNMASKED_RENDERER_WEBGL);this.gpuInfo={vendor:r,renderer:n},this.gpuTier=this.classifyGPU(r,n)}}return e.remove(),this.gpuTier}classifyGPU(e,t){const i=t.toLowerCase();return i.includes("nvidia")&&(i.includes("rtx")||i.includes("gtx 1080")||i.includes("gtx 1070"))||i.includes("apple")&&(i.includes("m1")||i.includes("m2")||i.includes("m3"))?"high":i.includes("mali-")||i.includes("adreno")||i.includes("powervr")?i.includes("adreno 6")||i.includes("mali-g7")?"medium":"low":i.includes("intel")?i.includes("iris")?"medium":"low":"medium"}async runBenchmark(){const e=document.createElement("canvas");e.width=512,e.height=512;const t=e.getContext("2d");if(!t)return 0;const i=1e3,r=performance.now();for(let l=0;l<i;l++)t.fillStyle=`rgba(${l%255}, ${l*2%255}, ${l*3%255}, 0.5)`,t.beginPath(),t.arc(Math.random()*e.width,Math.random()*e.height,Math.random()*20+5,0,Math.PI*2),t.fill();const a=performance.now()-r;return e.remove(),i/a*1e3}async determinePerformanceTier(){await this.detectGPU();const e=await this.runBenchmark();let t=0;return this.gpuTier==="high"?t+=30:this.gpuTier==="medium"?t+=20:t+=10,e>1e4?t+=30:e>5e3?t+=20:e>2e3?t+=10:t+=5,this.hardwareConcurrency>=8?t+=10:this.hardwareConcurrency>=4&&(t+=5),this.deviceMemory>=8?t+=10:this.deviceMemory>=4&&(t+=5),Y()&&(t-=20),this.browser==="safari"&&(t-=10),this.isOnBattery&&(t-=5),this.batteryLevel<.2&&(t-=10),this.pixelRatio>2&&(t-=5),t>=60?this.performanceTier="premium":t>=35?this.performanceTier="optimized":this.performanceTier="essential",this.tierDetails={score:t,benchmarkScore:e,factors:{gpuTier:this.gpuTier,platform:this.platform,browser:this.browser,isMobile:Y(),cores:this.hardwareConcurrency,memory:this.deviceMemory,pixelRatio:this.pixelRatio,isOnBattery:this.isOnBattery,batteryLevel:this.batteryLevel}},this.performanceTier}getTierSettings(){const e={premium:{targetFPS:60,flowFieldResolution:15,maxParticles:8e3,particleTrails:!0,splineQuality:"high",parallaxLayers:3,zoomDuration:{min:600,max:900},effects:["flowField","particles","lissajous","parallax"],debugPath:!1},optimized:{targetFPS:45,flowFieldResolution:25,maxParticles:2e3,particleTrails:!1,splineQuality:"medium",parallaxLayers:1,zoomDuration:{min:500,max:700},effects:["flowField","particles"]},essential:{targetFPS:30,flowFieldResolution:40,maxParticles:500,particleTrails:!1,splineQuality:"low",parallaxLayers:0,zoomDuration:{min:400,max:600},effects:["flowField","simpleCurves"]}};return e[this.performanceTier]||e.essential}shouldEnableFeature(e){return this.getTierSettings().effects.includes(e)}getCapabilities(){return{tier:this.performanceTier,tierDetails:this.tierDetails,platform:this.platform,browser:this.browser,gpu:{tier:this.gpuTier,info:this.gpuInfo},device:{cores:this.hardwareConcurrency,memory:this.deviceMemory,pixelRatio:this.pixelRatio,screenResolution:`${this.screenWidth}x${this.screenHeight}`},power:{isOnBattery:this.isOnBattery,batteryLevel:this.batteryLevel},settings:this.getTierSettings()}}}class Ve{constructor(e){this.viewer=e,this.canvas=null,this.ctx=null,this.isActive=!1,this.createOverlay()}createOverlay(){this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="10",this.canvas.style.opacity="0",this.canvas.style.transition="opacity 0.3s ease-out",this.viewer.element.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d",{alpha:!0,desynchronized:!0,willReadFrequently:!1}),this.updateSize(),this.viewer.addHandler("resize",()=>this.updateSize())}updateSize(){const e=this.viewer.element;this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight}show(){this.isActive=!0,this.canvas.style.opacity="1"}hide(){this.isActive=!1,this.canvas.style.opacity="0",setTimeout(()=>{this.isActive||this.clear()},300)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}getContext(){return this.ctx}viewportToCanvas(e){const t=new P.Point(e.x,e.y),i=this.viewer.viewport.viewportToViewerElementCoordinates(t);return{x:i.x,y:i.y}}destroy(){this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.ctx=null}}class qe{constructor(e){this.viewer=e,this.detector=new Be,this.frameBudget=null,this.effectsOverlay=new Ve(e),this.currentTier=null,this.currentSettings=null,this.isInitialized=!1,this.qualityController={degradeCount:0,upgradeCount:0,lastAdjustment:0,cooldownMs:2e3},this.flowField=null,this.particleSystem=null,this.splineRenderer=null,this.isAnimating=!1,this.currentAnimation=null,this.onTierChange=null}async initialize(){return console.log(" Initializing AdaptiveZoomRenderer..."),this.currentTier=await this.detector.determinePerformanceTier(),this.currentSettings=this.detector.getTierSettings(),console.log(` Performance tier detected: ${this.currentTier}`,this.detector.getCapabilities()),this.frameBudget=new Ze(this.currentSettings.targetFPS),this.frameBudget.onQualityAdjust=this.handleQualityAdjustment.bind(this),await this.initializeEffectSystems(),this.isInitialized=!0,this.onTierChange&&this.onTierChange(this.currentTier,this.currentSettings),this.currentTier}async initializeEffectSystems(){const e=this.currentSettings.effects;if(e.includes("flowField")){const{default:i}=await U(async()=>{const{default:r}=await import("./SimplexFlowField-BD36Xzhk.js");return{default:r}},[]);this.flowField=new i({resolution:this.currentSettings.flowFieldResolution,viewer:this.viewer})}if(e.includes("particles")){const{default:i}=await U(async()=>{const{default:r}=await import("./OptimizedParticleSystem-DeTUeoW7.js");return{default:r}},[]);this.particleSystem=new i({maxParticles:this.currentSettings.maxParticles,hasTrails:this.currentSettings.particleTrails})}const{default:t}=await U(async()=>{const{default:i}=await import("./SplineRenderer-SdRDfpaC.js");return{default:i}},[]);this.splineRenderer=new t({quality:this.currentSettings.splineQuality})}handleQualityAdjustment(e,t){const i=Date.now();i-this.qualityController.lastAdjustment<this.qualityController.cooldownMs||(e==="degrade"?(this.qualityController.degradeCount++,this.qualityController.upgradeCount=0,this.qualityController.degradeCount>=3?this.degradeTier():this.reduceEffects()):(this.qualityController.upgradeCount++,this.qualityController.degradeCount=0,this.qualityController.upgradeCount>=10&&this.upgradeTier()),this.qualityController.lastAdjustment=i)}async degradeTier(){const e=["premium","optimized","essential"],t=e.indexOf(this.currentTier);t<e.length-1&&(console.warn(` Degrading from ${this.currentTier} to ${e[t+1]} tier`),this.currentTier=e[t+1],this.currentSettings=this.detector.getTierSettings(),await this.initializeEffectSystems(),this.frameBudget.setTargetFPS(this.currentSettings.targetFPS),this.qualityController.degradeCount=0,this.onTierChange&&this.onTierChange(this.currentTier,this.currentSettings))}async upgradeTier(){const e=["premium","optimized","essential"],t=e.indexOf(this.currentTier);t>0&&this.detector.batteryLevel>.3&&(console.log(` Upgrading from ${this.currentTier} to ${e[t-1]} tier`),this.currentTier=e[t-1],this.currentSettings=this.detector.getTierSettings(),await this.initializeEffectSystems(),this.frameBudget.setTargetFPS(this.currentSettings.targetFPS),this.qualityController.upgradeCount=0,this.onTierChange&&this.onTierChange(this.currentTier,this.currentSettings))}reduceEffects(){if(this.particleSystem&&this.particleSystem.getActiveCount()>100){const e=Math.floor(this.particleSystem.maxParticles*.75);this.particleSystem.setMaxParticles(e),console.log(` Reduced particles to ${e}`)}this.flowField&&this.flowField.resolution<50&&(this.flowField.setResolution(this.flowField.resolution+5),console.log(` Reduced flow field resolution to ${this.flowField.resolution}`))}async performZoom(e,t,i={}){if(console.log(" AdaptiveZoomRenderer.performZoom called",{startBounds:e,targetBounds:t,options:i}),this.isInitialized||(console.log(" Initializing adaptive renderer..."),await this.initialize()),this.isAnimating){console.warn("Animation already in progress");return}this.isAnimating=!0,this.frameBudget&&(this.frameBudget.reset(),console.log(" Frame budget reset at animation start"));const r=this.frameBudget.getMetrics();if(console.log(` FPS Check: frameCount=${r.frameCount}, averageFPS=${r.averageFPS}, forceConsciousness=${i.forceConsciousness}`),!i.forceConsciousness&&r.frameCount>120&&r.averageFPS<25&&r.averageFPS>0)return console.warn(` Low FPS detected (${r.averageFPS}), using fallback zoom`),this.isAnimating=!1,"fallback";r.frameCount<=120?console.log(` Starting consciousness zoom (warming up, ${r.frameCount} frames so far)`):console.log(` Starting consciousness zoom (FPS check passed: ${r.averageFPS} FPS)`);const n=this.prepareAnimation(e,t,i);this.currentAnimation=n;const a=performance.now(),l=h=>{const g=this.frameBudget.startFrame(),p=h-a,s=Math.min(p/n.duration,1),o=n.easing(s),c=this.interpolatePosition(n.startPosition,n.targetPosition,o);g.budgetRemaining>5&&Math.floor(s*100)%5===0&&this.renderEffects(c,o,n),this.applyZoomToViewer(c);const u=this.frameBudget.endFrame();if(Math.random()<.005){const d=this.frameBudget.getMetrics();console.log(` Animation performance: ${d.averageFPS} FPS, frame ${d.frameCount}`)}s<1?!u.isOverBudget||u.budgetUsageRatio<1.5?requestAnimationFrame(l):setTimeout(()=>requestAnimationFrame(l),16):(console.log(" AdaptiveZoomRenderer animation complete, calling completeAnimation"),this.completeAnimation())};return requestAnimationFrame(l),new Promise(h=>{this.animationCompleteCallback=h})}prepareAnimation(e,t,i){var p;const r=this.currentSettings,n=this.calculateZoomDistance(e,t),a=this.mapDistanceToDuration(n,r.zoomDuration),l=i.duration||a,h=this.getEasingFunction(i.easing||"consciousness");let g=null;return this.flowField&&this.detector.shouldEnableFeature("flowField")?(console.log(" Creating flow field path for consciousness zoom"),g=this.flowField.calculatePath(e,t),console.log(" Flow path created:",g?"Success":"Failed")):console.log(" Flow field not available:",{hasFlowField:!!this.flowField,shouldEnable:this.detector.shouldEnableFeature("flowField"),effects:(p=this.currentSettings)==null?void 0:p.effects}),{startPosition:{center:e.getCenter(),zoom:this.viewer.viewport.getZoom()},targetPosition:{center:t.getCenter(),zoom:this.calculateTargetZoom(t)},duration:l,easing:h,flowPath:g,settings:r}}calculateTargetZoom(e){if(this.viewer.viewport.getZoomForBounds)return this.viewer.viewport.getZoomForBounds(e);{const t=this.viewer.viewport.getBounds(),i=this.viewer.viewport.getZoom(),r=t.width/e.width,n=t.height/e.height;return Math.min(r,n)*i}}calculateZoomDistance(e,t){const i=e.getCenter(),r=t.getCenter(),n=Math.sqrt(Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2)),a=this.viewer.viewport.getZoom(),l=this.calculateTargetZoom(t),h=Math.abs(Math.log(l/a));return n+h*.5}mapDistanceToDuration(e,t){const i=Math.min(e/5,1);return t.min+(t.max-t.min)*i}getEasingFunction(e){var i,r,n,a;const t={consciousness:l=>this.cubicBezier(.15,.4,.32,.88,l),standard:l=>this.cubicBezier(.4,0,.2,1,l),zoomIn:l=>this.cubicBezier(0,0,.2,1,l),zoomOut:l=>this.cubicBezier(.4,0,1,1,l),meditative:l=>this.cubicBezier(.18,.35,.35,.9,l),dynamic:l=>this.cubicBezier(.22,.25,.38,.85,l),linear:l=>l};return e==="auto"&&(e=(((r=(i=this.currentAnimation)==null?void 0:i.targetPosition)==null?void 0:r.zoom)>((a=(n=this.currentAnimation)==null?void 0:n.startPosition)==null?void 0:a.zoom)?"in":"out")==="in"?"zoomIn":"zoomOut"),t[e]||t.consciousness}cubicBezier(e,t,i,r,n){let l=n;for(let s=0;s<8;s++){const o=3*e,c=3*(i-e)-o,u=1-o-c,w=((u*l+c)*l+o)*l-n;if(Math.abs(w)<.001)break;const f=(3*u*l+2*c)*l+o;if(Math.abs(f)<.001)break;l-=w/f}const h=3*t,g=3*(r-t)-h;return(((1-h-g)*l+g)*l+h)*l}interpolatePosition(e,t,i){let r={x:e.center.x+(t.center.x-e.center.x)*i,y:e.center.y+(t.center.y-e.center.y)*i};if(this.currentAnimation.flowPath&&this.currentAnimation.flowPath.getInfluence){const g=Math.floor(i*200);if(!this.flowCache||this.flowCache.key!==g){const p=this.currentAnimation.flowPath.getInfluence(i),o=.3*Math.sin(i*Math.PI);this.flowCache={key:g,x:p.x*o,y:p.y*o}}r.x+=this.flowCache.x,r.y+=this.flowCache.y,i<.01&&console.log(" Flow field active with caching for consciousness zoom")}const n=Math.log(e.zoom),a=Math.log(t.zoom),l=n+(a-n)*i,h=Math.exp(l);return{center:r,zoom:h}}renderEffects(e,t,i){var a;if(this.detector.browser==="safari"&&this.frameBudget.getMetrics().averageFPS<45)return;const n=this.effectsOverlay.getContext();n&&(this.effectsOverlay.clear(),(a=this.currentSettings)!=null&&a.debugPath&&this.drawZoomPath(n,i,t),this.effectsOverlay.viewportToCanvas({x:e.center.x,y:e.center.y}))}applyZoomToViewer(e){this.viewer.viewport.silenceMultiUpdate=!0,this.viewer.viewport.panTo(e.center,!0),this.viewer.viewport.zoomTo(e.zoom,null,!0),this.viewer.viewport.silenceMultiUpdate=!1,this.viewer.viewport.applyConstraints()}drawZoomPath(e,t,i){e.save(),e.strokeStyle="rgba(255, 0, 255, 0.5)",e.lineWidth=2,e.beginPath();const r=50;for(let n=0;n<=r;n++){const a=n/r,l=this.interpolatePosition(t.startPosition,t.targetPosition,a),h=this.effectsOverlay.viewportToCanvas({x:l.center.x,y:l.center.y});n===0?e.moveTo(h.x,h.y):e.lineTo(h.x,h.y),Math.abs(a-i)<.02&&(e.fillStyle="rgba(255, 255, 0, 0.8)",e.fillRect(h.x-5,h.y-5,10,10))}e.stroke(),e.restore()}completeAnimation(){if(console.log(" AdaptiveZoomRenderer.completeAnimation called"),this.isAnimating=!1,this.currentAnimation=null,this.particleSystem&&this.particleSystem.clear(),this.qualityController.degradeCount=0,this.qualityController.upgradeCount=0,this.frameBudget&&(this.frameBudget.reset(),console.log(" Frame budget metrics reset for next animation")),this.detector.browser==="safari"){this.flowField&&this.flowField.fieldCache.clear();const e=this.viewer.drawer.canvas;if(e&&e.getContext){const t=e.getContext("2d");t&&t.clearRect(0,0,1,1)}}this.animationCompleteCallback?(console.log(" Calling animation complete callback"),this.animationCompleteCallback(),this.animationCompleteCallback=null):console.warn(" No animation complete callback found")}getMetrics(){return{tier:this.currentTier,settings:this.currentSettings,fps:this.frameBudget?this.frameBudget.getMetrics():null,capabilities:this.detector.getCapabilities()}}destroy(){this.flowField&&this.flowField.destroy(),this.particleSystem&&this.particleSystem.destroy(),this.splineRenderer&&this.splineRenderer.destroy(),this.effectsOverlay&&this.effectsOverlay.destroy()}}class $e{constructor(e,t){this.viewer=e,this.components=t,this.isAnimating=!1,this.animationEndHandlers=[],this.debugMode=!0,this.reducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.adaptiveRenderer=new qe(e),this.adaptiveRenderer.onTierChange=(i,r)=>{console.log(` Zoom renderer tier changed to: ${i}`,r)},console.log(" Auto-initializing adaptive renderer..."),this.adaptiveRenderer.initialize().then(i=>{console.log(` Adaptive renderer initialized with tier: ${i}`)}).catch(i=>{console.error(" Failed to auto-initialize adaptive renderer:",i)}),this.SPRING_PHYSICS={desktop:{tension:this.reducedMotion?100:50,friction:this.reducedMotion?20:14,mass:1.8,precision:.001},mobile:{tension:this.reducedMotion?120:60,friction:this.reducedMotion?25:16,mass:1.5,precision:.001}},this.CONTEMPLATIVE_SPRING={stiffness:4.4,damping:.75,mass:2},this.STABLE_SPRING_CONFIG={desktop:{animationTime:this.reducedMotion?.3:1,springStiffness:this.reducedMotion?12:6.5,damping:.85},mobile:{animationTime:this.reducedMotion?.2:.8,springStiffness:this.reducedMotion?15:8,damping:.9}},this.CONVERGENCE_THRESHOLD=.001,this.OSCILLATION_THRESHOLD=.01,this.setupDiagnostics(),this.setupAccessibility()}setupAccessibility(){window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{this.reducedMotion=e.matches,this.updateSpringConfig()}),this.createAriaAnnouncer()}updateSpringConfig(){const e=/Android|iPhone|iPad/i.test(navigator.userAgent),t=e?this.STABLE_SPRING_CONFIG.mobile:this.STABLE_SPRING_CONFIG.desktop;this.reducedMotion?(t.animationTime=e?.2:.3,t.springStiffness=e?15:12):(t.animationTime=e?.8:1,t.springStiffness=e?8:6.5)}createAriaAnnouncer(){const e=document.createElement("div");e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",e.style.cssText=`
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        `,document.body.appendChild(e),this.ariaAnnouncer=e}announceZoomChange(e){this.ariaAnnouncer&&(this.ariaAnnouncer.textContent=e,setTimeout(()=>{this.ariaAnnouncer.textContent=""},1e3))}setupDiagnostics(){if(!this.viewer)return;let e=0,t=[];this.viewer.addHandler("zoom",i=>{if(!this.isAnimating)return;const r=i.zoom;if(t.push(r),t.length>10&&t.shift(),t.length>=3){const[n,a,l]=t.slice(-3);(a>n&&l<a||a<n&&l>a)&&(e++,e>=2&&this.debugMode&&console.warn(" Oscillation detected!",{pattern:[n,a,l],count:e}))}})}async performCinematicZoom(e,t={}){if(this.isAnimating)if(console.log("Cinematic zoom already in progress"),this.animationStartTime&&Date.now()-this.animationStartTime>5e3)console.warn("Animation seems stuck, forcing reset"),this.isAnimating=!1;else return;if(t.type==="consciousness"||t.mode==="consciousness")return this.performConsciousnessZoom(e,t);const r=/Android|iPhone|iPad/i.test(navigator.userAgent)?this.STABLE_SPRING_CONFIG.mobile:this.STABLE_SPRING_CONFIG.desktop;if(t.stages&&!this.reducedMotion)return this.performMultiStageZoom(e,t.stages,r);const n={...r,...t,onComplete:t.onComplete||(()=>{})};this.isAnimating=!0,this.animationStartTime=Date.now(),this.disableInterferingComponents();const a=this.storeOriginalSettings();this.applyStableSpringConfig(n);const l=this.calculateZoomParameters(e);return this.debugMode&&console.log(" Starting stable cinematic zoom:",{currentZoom:this.viewer.viewport.getZoom(),targetZoom:l.zoom,config:n}),this.executeStableZoom(l,n,a),new Promise(h=>{this.animationEndHandlers.push(h)})}async performConsciousnessZoom(e,t={}){console.log(" Starting consciousness stream zoom"),this.isAnimating=!0,this.animationStartTime=Date.now();try{if(!this.adaptiveRenderer){console.error(" Adaptive renderer not created!"),this.isAnimating=!1;return}if(!this.adaptiveRenderer.isInitialized){console.log(" Initializing adaptive renderer...");const l=await this.adaptiveRenderer.initialize();console.log(` Adaptive renderer initialized with tier: ${l}`)}const i=this.viewer.viewport.getBounds(),r={...t,easing:t.easing||"consciousness",forceConsciousness:t.forceConsciousness||!1,onComplete:()=>{this.isAnimating=!1,t.onComplete&&t.onComplete()}};this.disableInterferingComponents();const n=this.storeOriginalSettings();if(console.log(" Calling adaptiveRenderer.performZoom with:",{currentBounds:i,targetBounds:e,zoomOptions:r}),await this.adaptiveRenderer.performZoom(i,e,r)==="fallback")return console.warn(" Falling back to spring physics zoom"),this.isAnimating=!1,this.performCinematicZoom(e,{...t,type:"spring"});console.log(" Consciousness zoom promise resolved, completing animation"),r.onComplete&&(console.log(" Calling onComplete callback from zoomOptions"),r.onComplete()),this.completeAnimation(n,r);return}catch(i){return console.error(" Consciousness zoom error:",i),this.isAnimating=!1,console.warn(" Falling back to spring physics zoom due to error"),this.performCinematicZoom(e,{...t,type:"spring"})}}async performAdaptiveZoom(e,t={}){const i=this.viewer.viewport.getBounds(),r=this.viewer.viewport.getZoom(),n=this.calculateTargetZoom(e),a=Math.sqrt(Math.pow(i.width,2)+Math.pow(i.height,2)),l=i.getCenter(),h=e.getCenter(),p=Math.sqrt(Math.pow(h.x-l.x,2)+Math.pow(h.y-l.y,2))/a;if(console.log(" Adaptive zoom analysis:",{normalizedDistance:p,threshold:3,currentZoom:r,targetZoom:n,strategy:p<3?"direct":"zoom-out-pan-zoom-in"}),p<3)return console.log(" Using direct zoom for short distance"),t.type==="consciousness"?this.performConsciousnessZoom(e,t):this.performCinematicZoom(e,t);console.log(" Using zoom-out-pan-zoom-in for long distance");const s=Math.min(r,n),o=this.viewer.viewport.getMaxZoom(),c=this.viewer.viewport.getMinZoom(),u=Math.min(.3+.4*p/10,.7);let d=s*u;d=Math.max(d,c*1.5),d=Math.min(d,o*.1),d=Math.min(d,s*.8),console.log(" Intermediate zoom calculation:",{minZoom:s,distanceFactor:u,intermediateZoom:d,minAllowed:this.viewer.viewport.getMinZoom()});const w=/Android|iPhone|iPad/i.test(navigator.userAgent),v=2500*Math.sqrt(p/3),x=Math.max(w?1500:2e3,Math.min(v,w?4e3:6e3));console.log(" Contemplative timing calculation:",{normalizedDistance:p,rawDuration:v,finalDuration:x+"ms"});const A=[{duration:x*.25,zoomFactor:d/r,centerProgress:0,easing:"contemplativeOut",delay:0,microPause:30},{duration:x*.5,progress:1,zoomFactor:1,useTargetCenter:!0,easing:"contemplativePan",delay:0,microPause:30},{duration:x*.25,progress:1,zoomFactor:n/d,useTargetCenter:!0,easing:"contemplativeIn",delay:300,microPause:0}];return A.onComplete=t.onComplete,console.log(" Starting adaptive multi-stage zoom:",{totalDuration:x+"ms",phases:A.map((M,C)=>`Phase ${C+1}: ${M.duration}ms`)}),this.performMultiStageZoom(e,A,{...t,type:"adaptive"})}calculateTargetZoom(e){const t=this.viewer.viewport;try{if(t.getZoomForBounds){const i=t.getZoomForBounds(e),r=t.getMinZoom(),n=t.getMaxZoom();return Math.max(r,Math.min(n,i))}else{const i=t.getBounds(),r=t.getZoom(),n=i.width/e.width,a=i.height/e.height,l=Math.min(n,a)*r,h=t.getMinZoom(),g=t.getMaxZoom();return Math.max(h,Math.min(g,l))}}catch(i){return console.error("Error calculating target zoom:",i),t.getZoom()}}async performMultiStageZoom(e,t,i){this.isAnimating=!0,this.animationStartTime=Date.now(),this.isMultiStage=!0,this.totalStages=t.length,this.currentStageIndex=0,this.disableInterferingComponents();const r=this.storeOriginalSettings(),n=this.calculateZoomParameters(e),a=this.viewer.viewport.getZoom(),l=this.viewer.viewport.getCenter();this.multiStageTimeout&&clearTimeout(this.multiStageTimeout);let h=0;const g=()=>{if(h>=t.length){this.isMultiStage&&(this.isMultiStage=!1,this.completeAnimation(r,{onComplete:t.onComplete}));return}const p=t[h],s=h===t.length-1;let o,c;const u=this.viewer.viewport.getZoom();if(p.zoomFactor)o=u*p.zoomFactor;else if(p.progress!==void 0)o=a+(n.zoom-a)*p.progress;else if(s)o=n.zoom;else{const T=(h+1)/t.length;o=a+(n.zoom-a)*T}const d=this.viewer.viewport.getMinZoom(),w=this.viewer.viewport.getMaxZoom();if(o=Math.max(d,Math.min(w,o)),p.centerProgress!==void 0){const T={x:n.center.x-l.x,y:n.center.y-l.y};c=new P.Point(l.x+T.x*p.centerProgress,l.y+T.y*p.centerProgress)}else s||p.useTargetCenter?c=n.center:c=null;const f={...i,animationTime:p.duration/1e3||i.animationTime,easing:p.easing||"easeInOutCubic",skipFinalComplete:h<t.length-1,onComplete:()=>{const T=p.microPause||0,_=p.delay||0,x=T+_;x>0&&h<t.length-1?this.multiStageTimeout=setTimeout(()=>{h++,this.currentStageIndex=h,g()},x):(h++,this.currentStageIndex=h,g())}};this.applyStableSpringConfig(f);const v={zoom:o,center:c,currentZoom:u};this.debugMode&&console.log(` Stage ${h+1}/${t.length}:`,{zoom:v.zoom,center:c?`(${c.x.toFixed(3)}, ${c.y.toFixed(3)})`:"none",duration:p.duration||"default",easing:p.easing||"default"}),Math.abs(o-u)<.001&&c?this.executePanOnly(c,f,r):this.executeStableZoom(v,f,r)};return g(),new Promise(p=>{this.animationEndHandlers.push(p)})}disableInterferingComponents(){this.components.lowZoomOptimizer&&this.components.lowZoomOptimizer.setCinematicMode(!0),this.viewer.imageLoader&&this.viewer.imageLoader.clear(),this.components.tileCleanupManager&&this.components.tileCleanupManager.pauseCleanup(3e3),this.components.renderOptimizer&&this.components.renderOptimizer.startCinematicZoom(),this.components.predictiveTileLoader&&this.viewer.raiseEvent("animation-start"),window.overlayManager&&window.overlayManager.disableAutoSwitch&&(console.log(" Disabling overlay auto-switch during cinematic zoom"),window.overlayManager.disableAutoSwitch=!0)}storeOriginalSettings(){return{animationTime:this.viewer.animationTime,springStiffness:this.viewer.springStiffness,centerXTime:this.viewer.viewport.centerSpringX.animationTime,centerYTime:this.viewer.viewport.centerSpringY.animationTime,zoomTime:this.viewer.viewport.zoomSpring.animationTime,centerXStiffness:this.viewer.viewport.centerSpringX.springStiffness,centerYStiffness:this.viewer.viewport.centerSpringY.springStiffness,zoomStiffness:this.viewer.viewport.zoomSpring.springStiffness}}applyStableSpringConfig(e){this.viewer.animationTime=e.animationTime,this.viewer.springStiffness=e.springStiffness,[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].forEach(i=>{i.animationTime=e.animationTime,i.springStiffness=e.springStiffness,i.resetTo(i.current.value)}),this.viewer.viewport.applyConstraints()}calculateZoomParameters(e){const t=this.viewer.viewport,i=t.getZoom();let r;if(t.getZoomForBounds)r=t.getZoomForBounds(e);else{const a=t.getBounds(),l=a.width/e.width,h=a.height/e.height;r=Math.min(l,h)*i}const n=e.getCenter();return{zoom:r,center:new P.Point(n.x,n.y),currentZoom:i,zoomRatio:r/i}}calculateLogInterpolation(e,t,i){const r=Math.log(e),n=Math.log(t),a=r+(n-r)*i;return Math.exp(a)}getEasingFunction(e){const t={linear:i=>i,easeInOutCubic:i=>i<.5?4*i*i*i:1-Math.pow(-2*i+2,3)/2,easeOutQuart:i=>1-Math.pow(1-i,4),easeOutBack:i=>1+2.70158*Math.pow(i-1,3)+1.70158*Math.pow(i-1,2),easeInOutQuad:i=>i<.5?2*i*i:1-Math.pow(-2*i+2,2)/2,consciousness:i=>i<.5?4*i*i*i:1-Math.pow(-2*i+2,3)/2,standard:i=>i<.5?2*i*i:1-Math.pow(-2*i+2,2)/2,zoomIn:i=>1-Math.pow(1-i,3),zoomOut:i=>i*i*i,contemplativeOut:i=>{const r=i;return r<.5?2.2*r*r:1-2.2*Math.pow(1-r,2)},contemplativePan:i=>1-Math.pow(1-i,2.5),contemplativeIn:i=>i<.5?2.7*i*i*i:1-2.7*Math.pow(1-i,3)};return t[e]||t.easeInOutCubic}calculateSpringProgress(e,t){const{tension:i,friction:r,mass:n}=t,a=Math.sqrt(i/n),l=r/(2*Math.sqrt(i*n));let h;if(l<1){const g=a*Math.sqrt(1-l*l);h=1-Math.exp(-l*a*e)*(Math.cos(g*e)+l*a/g*Math.sin(g*e))}else if(l===1)h=1-Math.exp(-a*e)*(1+a*e);else{const g=-a*(l-Math.sqrt(l*l-1)),p=-a*(l+Math.sqrt(l*l-1)),s=p/(p-g),o=-g/(p-g);h=1-(s*Math.exp(g*e)+o*Math.exp(p*e))}return Math.max(0,Math.min(1,h))}executePanOnly(e,t,i){const r=performance.now(),n=this.viewer.viewport.getCenter();let a=null;const l=this.getEasingFunction(t.easing||"easeInOutCubic"),h=t.animationTime*1e3;this.applyMotionBlur(!0);const g=p=>{const s=p-r,o=Math.min(s/h,1),c=l(o),u=new P.Point(n.x+(e.x-n.x)*c,n.y+(e.y-n.y)*c);this.viewer.viewport.panTo(u,!0),c>=1?(cancelAnimationFrame(a),this.viewer.viewport.panTo(e,!0),this.debugMode&&console.log(" Pan-only animation completed:",{duration:s,from:`(${n.x.toFixed(3)}, ${n.y.toFixed(3)})`,to:`(${e.x.toFixed(3)}, ${e.y.toFixed(3)})`}),setTimeout(()=>{this.applyMotionBlur(!1),this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null),t.skipFinalComplete?t.onComplete&&t.onComplete():this.completeAnimation(i,t)},50)):a=requestAnimationFrame(g)};a=requestAnimationFrame(g),this.animationTimeout=setTimeout(()=>{a&&(cancelAnimationFrame(a),(!this.isMultiStage||this.currentStageIndex===this.totalStages-1)&&console.warn("Pan animation timeout"),t.skipFinalComplete||this.completeAnimation(i,t))},h+1e3)}executeStableZoom(e,t,i){const{zoom:r,center:n,currentZoom:a}=e,h=/Android|iPhone|iPad/i.test(navigator.userAgent)?this.SPRING_PHYSICS.mobile:this.SPRING_PHYSICS.desktop,g=t.useSpringPhysics!==!1,p=performance.now(),s=this.viewer.viewport.getCenter();let o=null,c=0;const u=w=>{const f=(w-p)/1e3;let v;if(g)v=this.calculateSpringProgress(f,h);else{const x=t.animationTime*1e3,A=Math.min(f*1e3/x,1);v=this.getEasingFunction(t.easing||"easeInOutCubic")(A)}const T=this.calculateLogInterpolation(a,r,v);if(n){const x=new P.Point(s.x+(n.x-s.x)*v,s.y+(n.y-s.y)*v);this.viewer.viewport.panTo(x,!0),this.viewer.viewport.zoomTo(T,null,!0)}else this.viewer.viewport.zoomTo(T,null,!0);if(g?v>=.995&&Math.abs(v-c)<h.precision:v>=1){cancelAnimationFrame(o),this.viewer.viewport.zoomTo(r,null,!0),n&&this.viewer.viewport.panTo(n,!0),this.debugMode&&console.log(" Spring physics zoom completed:",{startZoom:a,endZoom:r,duration:f*1e3,springConfig:g?h:"easing"});const x=Math.round(r);this.announceZoomChange(`Zoom completed at ${x}x magnification`),setTimeout(()=>{this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null),t.skipFinalComplete?t.onComplete&&t.onComplete():this.completeAnimation(i,t)},100)}else c=v,o=requestAnimationFrame(u)};o=requestAnimationFrame(u);const d=5e3;this.animationTimeout=setTimeout(()=>{o&&(cancelAnimationFrame(o),(!this.isMultiStage||this.currentStageIndex===this.totalStages-1)&&console.warn("Animation timeout - forcing completion"),t.skipFinalComplete||this.completeAnimation(i,t))},d)}applyEmergencyDamping(){[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].forEach(t=>{t.springStiffness=Math.min(t.springStiffness*1.5,20),Math.abs(t.current.value-t.target.value)<this.OSCILLATION_THRESHOLD&&t.resetTo(t.target.value)}),this.debugMode&&console.log(" Emergency damping applied")}completeAnimation(e,t){var i,r,n,a;if(this.isAnimating=!1,this.animationStartTime=null,this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null),this.multiStageTimeout&&(clearTimeout(this.multiStageTimeout),this.multiStageTimeout=null),this.viewer.animationTime=e.animationTime,this.viewer.springStiffness=e.springStiffness,this.viewer.viewport.centerSpringX.animationTime=e.centerXTime,this.viewer.viewport.centerSpringY.animationTime=e.centerYTime,this.viewer.viewport.zoomSpring.animationTime=e.zoomTime,this.viewer.viewport.centerSpringX.springStiffness=e.centerXStiffness,this.viewer.viewport.centerSpringY.springStiffness=e.centerYStiffness,this.viewer.viewport.zoomSpring.springStiffness=e.zoomStiffness,this.components.lowZoomOptimizer&&this.components.lowZoomOptimizer.setCinematicMode(!1),this.components.renderOptimizer&&this.components.renderOptimizer.endCinematicZoom(),this.components.predictiveTileLoader&&this.viewer.raiseEvent("animation-finish"),window.overlayManager&&window.overlayManager.disableAutoSwitch&&(console.log(" Re-enabling overlay auto-switch after cinematic zoom"),window.overlayManager.disableAutoSwitch=!1),console.log(" Checking renderer for reset:",{hasRenderer:!!this.components.renderer,rendererType:(r=(i=this.components.renderer)==null?void 0:i.constructor)==null?void 0:r.name,hasResetMethod:typeof((n=this.components.renderer)==null?void 0:n.resetAnimationState)=="function",hasGetResetMethod:typeof((a=this.components.renderer)==null?void 0:a.getResetAnimationState)=="function"}),this.components.renderer)if(typeof this.components.renderer.resetAnimationState=="function")console.log(" Safari Fix: Resetting renderer animation state after cinematic zoom"),this.components.renderer.resetAnimationState();else if(typeof this.components.renderer.getResetAnimationState=="function"){console.log(" Safari Fix: Resetting renderer animation state via getResetAnimationState");const l=this.components.renderer.getResetAnimationState();l&&l()}else console.warn(" Cannot reset renderer animation state - method not available");if(this.components.overlayManager&&typeof this.components.overlayManager.resetAnimationState=="function"&&(console.log(" Safari Fix: Resetting overlay manager animation state"),this.components.overlayManager.resetAnimationState()),window.temporalEchoController&&(console.log(" Mobile Fix: Clearing temporal echo state after cinematic zoom"),window.temporalEchoController.clearActiveEchoes&&window.temporalEchoController.clearActiveEchoes(),window.temporalEchoController.cleanupTimeout&&(clearTimeout(window.temporalEchoController.cleanupTimeout),window.temporalEchoController.cleanupTimeout=null),window.temporalEchoController.revealCount!==void 0&&(console.log(` Resetting reveal counter from ${window.temporalEchoController.revealCount}`),window.temporalEchoController.revealCount=0)),window.nativeHotspotRenderer&&(console.log(" Resetting all hotspot visibility states after zoom"),document.querySelectorAll(".hotspot-visible, .hotspot-echo-active, .hotspot-tree-reveal").forEach(h=>{h.classList.remove("hotspot-echo-active","hotspot-tree-reveal","hotspot-echo-reveal"),h.style.visibility==="visible"&&(h.style.visibility=""),h.style.display==="block"&&(h.style.display="")})),this.animationEndHandlers.forEach(l=>l()),this.animationEndHandlers=[],this.viewer.forceRedraw(),this.viewer&&this.viewer.canvas&&(console.log(" Restoring focus to viewer canvas"),this.viewer.canvas.focus()),t.onComplete){const h=/Android|iPhone|iPad/i.test(navigator.userAgent)?400:800;setTimeout(()=>{t.onComplete()},h)}}applyMotionBlur(e){const t=this.viewer.canvas;if(!t)return;const i=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),r=/Android|iPhone|iPad/i.test(navigator.userAgent);i||r||(e?(t.style.filter="blur(1px)",t.style.transition="filter 200ms ease-in"):(t.style.filter="blur(0px)",t.style.transition="filter 300ms ease-out",setTimeout(()=>{t.style.filter="",t.style.transition=""},300)))}enableDebug(){this.debugMode=!0,console.log(" CinematicZoomManager debug mode enabled")}getDiagnostics(){const e=[{name:"centerX",spring:this.viewer.viewport.centerSpringX},{name:"centerY",spring:this.viewer.viewport.centerSpringY},{name:"zoom",spring:this.viewer.viewport.zoomSpring}];return{isAnimating:this.isAnimating,currentZoom:this.viewer.viewport.getZoom(),springs:e.map(({name:t,spring:i})=>({name:t,current:i.current.value,target:i.target.value,velocity:Math.abs(i.current.value-i.target.value),animationTime:i.animationTime,stiffness:i.springStiffness}))}}}class Qe{constructor(e){this.viewer=e,this.enabled=!1,this.prefetchRadius=2,this.velocityHistory=[],this.maxVelocityHistory=5,this.lastPosition=null,this.lastUpdateTime=0,this.stats={tilesPreloaded:0,hitRate:0,predictions:0,correctPredictions:0},this.updateInterval=100,this.viewer&&this.initialize()}initialize(){this.viewer.addHandler("viewport-change",e=>{if(!this.enabled)return;const t=performance.now();if(t-this.lastUpdateTime<this.updateInterval)return;const r=e.eventSource.viewport.getCenter(!0);this.updatePosition(r),this.lastUpdateTime=t}),console.log("[PredictiveTileLoader] Initialized with prefetch radius:",this.prefetchRadius)}updatePosition(e){if(this.lastPosition){const t={x:e.x-this.lastPosition.x,y:e.y-this.lastPosition.y,timestamp:performance.now()};this.velocityHistory.push(t),this.velocityHistory.length>this.maxVelocityHistory&&this.velocityHistory.shift();const i=this.getAverageVelocity();(Math.abs(i.x)>.001||Math.abs(i.y)>.001)&&this.prefetchTiles(e,i)}this.lastPosition=e}getAverageVelocity(){if(this.velocityHistory.length===0)return{x:0,y:0};const e=this.velocityHistory.reduce((t,i)=>({x:t.x+i.x,y:t.y+i.y}),{x:0,y:0});return{x:e.x/this.velocityHistory.length,y:e.y/this.velocityHistory.length}}prefetchTiles(e,t){const i={x:e.x+t.x*3,y:e.y+t.y*3},r=this.viewer.viewport.getZoom(),n=this.viewer.world.getItemAt(0);if(!n)return;const a=this.viewer.viewport.getBounds(),l={x:i.x-a.width/2,y:i.y-a.height/2,width:a.width,height:a.height};this.requestTilesInBounds(n,l,r),this.stats.predictions++}requestTilesInBounds(e,t,i){try{const r=this.viewer.viewport.getBounds(),n=this.viewer.viewport.getZoom(),a={x:t.x+t.width/2,y:t.y+t.height/2},l=this.viewer.viewport;requestAnimationFrame(()=>{l.panTo(a,!0),requestAnimationFrame(()=>{l.panTo(l.getCenter(r),!0)})}),this.stats.tilesPreloaded++}catch(r){console.debug("[PredictiveTileLoader] Prefetch error:",r)}}getStats(){return{...this.stats,hitRate:this.stats.predictions>0?(this.stats.correctPredictions/this.stats.predictions*100).toFixed(1)+"%":"N/A",velocityHistorySize:this.velocityHistory.length}}setEnabled(e){this.enabled=e,e||(this.velocityHistory=[],this.lastPosition=null),console.log(`[PredictiveTileLoader] ${e?"Enabled":"Disabled"}`)}reset(){this.velocityHistory=[],this.lastPosition=null,this.stats={tilesPreloaded:0,hitRate:0,predictions:0,correctPredictions:0}}destroy(){this.enabled=!1,this.reset()}}class Ne{constructor(e){this.viewer=e,this.vignetteElement=null,this.isEnabled=!0,this.currentOpacity=0,this.reducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches;const t=/Android|iPhone|iPad/i.test(navigator.userAgent);this.isEnabled=!t&&!this.reducedMotion,this.isEnabled&&(this.createVignetteElement(),this.setupEventHandlers())}createVignetteElement(){this.vignetteElement=document.createElement("div"),this.vignetteElement.className="vignette-overlay",this.vignetteElement.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 45%,
                rgba(0,0,0,0.05) 70%,
                rgba(0,0,0,0.15) 100%
            );
            opacity: 0;
            transition: opacity 0.5s ease-out;
            z-index: 10;
            will-change: opacity;
        `,this.viewer.element.appendChild(this.vignetteElement)}setupEventHandlers(){this.viewer.addHandler("zoom",e=>{this.updateVignette(e.zoom)}),this.viewer.addHandler("animation-start",()=>{this.vignetteElement&&(this.vignetteElement.style.transition="opacity 0.3s ease-out")}),this.viewer.addHandler("animation-finish",()=>{this.vignetteElement&&(this.vignetteElement.style.transition="opacity 0.5s ease-out")}),window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{e.matches?this.disable():/Android|iPhone|iPad/i.test(navigator.userAgent)||this.enable()})}updateVignette(e){if(!this.isEnabled||!this.vignetteElement)return;const t=this.viewer.viewport.getHomeZoom(),i=this.viewer.viewport.getMaxZoom(),r=(e-t)/(i-t);let n=0;r>.1&&(n=Math.pow(r-.1,1.5)*.6,n=Math.min(n,.4)),Math.abs(n-this.currentOpacity)>.01&&(this.currentOpacity=n,requestAnimationFrame(()=>{this.vignetteElement&&(this.vignetteElement.style.opacity=n)}))}enable(){this.isEnabled=!0,this.vignetteElement||(this.createVignetteElement(),this.setupEventHandlers());const e=this.viewer.viewport.getZoom();this.updateVignette(e)}disable(){this.isEnabled=!1,this.vignetteElement&&(this.vignetteElement.style.opacity=0)}toggle(){return this.isEnabled?this.disable():this.enable(),this.isEnabled}destroy(){this.vignetteElement&&this.vignetteElement.parentNode&&(this.vignetteElement.parentNode.removeChild(this.vignetteElement),this.vignetteElement=null)}getState(){return{enabled:this.isEnabled,opacity:this.currentOpacity,reducedMotion:this.reducedMotion}}}class Ue{constructor(e){this.viewer=e,this.config={sensitivity:{low:.02,medium:.015,high:.01},thresholds:{medium:5,high:20},discreteSteps:{zoomIn:1.12,zoomOut:.89}},this.setupWheelHandler()}normalizeWheelDelta(e){let t=e.deltaY;return e.deltaMode===1?t*=40:e.deltaMode===2&&(t*=800),t}detectInputDevice(e){return!Number.isInteger(e.deltaY)||e.deltaX!==0?"trackpad":Math.abs(e.deltaY)>=50?"mouse":"trackpad"}getAdaptiveSensitivity(e){const{sensitivity:t,thresholds:i}=this.config;return e<i.medium?t.low:e<i.high?t.medium:t.high}setupWheelHandler(){const e=this.viewer.canvas;this.viewer.removeAllHandlers("canvas-scroll"),e.addEventListener("wheel",t=>{t.preventDefault();const i=this.detectInputDevice(t),r=this.viewer.viewport.getZoom(),n=e.getBoundingClientRect(),a=this.viewer.viewport.pointFromPixel(new P.Point(t.clientX-n.left,t.clientY-n.top));let l;if(i==="mouse"){const{discreteSteps:h}=this.config;let g=1;r>20&&(g=.5),t.deltaY<0?l=Math.pow(h.zoomIn,g):l=Math.pow(h.zoomOut,g)}else{const h=this.normalizeWheelDelta(t),g=this.getAdaptiveSensitivity(r);l=Math.exp(-h*g),l=Math.max(.9,Math.min(1.1,l))}this.applyZoom(l,a)},{passive:!1})}applyZoom(e,t){const i=this.viewer.viewport.getZoom(),r=i*e,n=this.viewer.viewport.getMinZoom(),a=this.viewer.viewport.getMaxZoom(),l=Math.max(n,Math.min(a,r));Math.abs(l-i)>1e-4&&(this.viewer.viewport.zoomTo(l,t,!0),this.viewer.viewport.applyConstraints(!0),this.viewer.forceRedraw())}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}destroy(){this.viewer=null}}class We{constructor(e){this.viewer=e,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const e=performance.now();return this.cacheEnabled&&this.cachedViewport&&e-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const e=performance.now(),t=this.viewer.viewport,i=t.getBounds(),r=t.viewportToImageCoordinates(i.getTopLeft()),n=t.viewportToImageCoordinates(i.getBottomRight()),a=n.x-r.x,l=n.y-r.y,h=a*this.viewportPadding,g=l*this.viewportPadding,p=this.viewer.world.getItemAt(0),s=p?p.getContentSize():{x:1,y:1},c={bounds:{minX:Math.max(0,r.x-h),minY:Math.max(0,r.y-g),maxX:Math.min(s.x,n.x+h),maxY:Math.min(s.y,n.y+g)},zoom:t.getZoom(!0),center:t.getCenter(!0),rotation:t.getRotation(),containerSize:t.getContainerSize(),imageBounds:{minX:r.x,minY:r.y,maxX:n.x,maxY:n.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=c,this.lastUpdate=performance.now();const u=this.lastUpdate-e;return this.metrics.lastUpdateDuration=u,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+u)/this.metrics.totalUpdates,c}isPointInViewport(e,t,i=!1){const r=this.getCurrentViewport(),n=i?r.bounds:r.imageBounds;return e>=n.minX&&e<=n.maxX&&t>=n.minY&&t<=n.maxY}isBoxInViewport(e,t,i,r,n=!0){const a=this.getCurrentViewport(),l=n?a.bounds:a.imageBounds;return!(i<l.minX||e>l.maxX||r<l.minY||t>l.maxY)}imageToPixel(e,t){const i=this.viewer.viewport.imageToViewportCoordinates(new P.Point(e,t));return this.viewer.viewport.pixelFromPoint(i)}pixelToImage(e,t){const i=this.viewer.viewport.pointFromPixel(new P.Point(e,t));return this.viewer.viewport.viewportToImageCoordinates(i)}calculatePixelRatio(){const e=this.viewer.viewport,t=e.getContainerSize(),i=e.getBounds(),r=this.viewer.world.getItemAt(0);if(!r)return 1;const n=r.getContentSize(),a=i.width*n.x;return t.x/a}getLevelOfDetail(){const e=this.viewer.viewport.getZoom(!0),t=this.viewer.viewport.getMaxZoom(),i=e/t;return i<.1?0:i<.3?1:i<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const e=this.getCurrentViewport(),t=this.viewer.world.getItemAt(0);if(!t)return 1;const i=t.getContentSize(),r=(e.imageBounds.maxX-e.imageBounds.minX)*(e.imageBounds.maxY-e.imageBounds.minY),n=i.x*i.y;return r/n}getMetrics(){const e=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:e.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const e=this.getCurrentViewport();return{x:e.imageBounds.minX,y:e.imageBounds.minY,width:e.imageBounds.maxX-e.imageBounds.minX,height:e.imageBounds.maxY-e.imageBounds.minY}}setCacheEnabled(e){this.cacheEnabled=e,e||(this.cachedViewport=null)}setCacheTimeout(e){this.cacheTimeout=Math.max(0,e)}setViewportPadding(e){this.viewportPadding=Math.max(0,Math.min(1,e))}destroy(){this.viewer=null,this.cachedViewport=null}}class Ge{constructor(e,t=!1){this.viewer=e,this.isMobile=t,this.enabled=t,this.targetFPS=t?45:60,this.frameInterval=1e3/this.targetFPS,this.lastFrameTime=0,this.skipCount=0,this.maxSkipCount=2,this.frameTimes=[],this.maxFrameTimeSamples=10,this.isInteracting=!1,this.fastMotion=!1,this.enabled&&(this.setupInterceptor(),console.log("FrameSkipManager: Enabled for mobile performance"))}setupInterceptor(){if(!this.viewer)return;this.originalForceRedraw=this.viewer.forceRedraw.bind(this.viewer),this.viewer.forceRedraw=()=>{if(!this.enabled||this.isInteracting)return this.originalForceRedraw();const i=performance.now(),r=i-this.lastFrameTime;if(this.updateFrameStats(r),this.shouldSkipFrame(r)){this.skipCount++;return}return this.skipCount=0,this.lastFrameTime=i,this.originalForceRedraw()},this.viewer.addHandler("animation-start",()=>{this.isInteracting=!0,this.skipCount=0}),this.viewer.addHandler("animation-finish",()=>{this.isInteracting=!1,this.fastMotion=!1,this.skipCount=0,this.originalForceRedraw()});let e=null,t=null;this.viewer.addHandler("viewport-change",()=>{if(!this.isInteracting)return;const i=this.viewer.viewport.getCenter(),r=this.viewer.viewport.getZoom();if(e&&t){const n=Math.sqrt(Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2)),a=Math.abs(r-t);this.fastMotion=n>.05||a>.1}e=i,t=r})}shouldSkipFrame(e){return this.skipCount>=this.maxSkipCount?!1:!!(e<this.frameInterval*.8||this.fastMotion&&this.getAverageFrameTime()>this.frameInterval*1.2||this.getAverageFrameTime()>this.frameInterval*1.5)}updateFrameStats(e){this.frameTimes.push(e),this.frameTimes.length>this.maxFrameTimeSamples&&this.frameTimes.shift()}getAverageFrameTime(){return this.frameTimes.length===0?this.frameInterval:this.frameTimes.reduce((t,i)=>t+i,0)/this.frameTimes.length}setEnabled(e){this.enabled=e,e||(this.skipCount=0,this.isInteracting=!1,this.fastMotion=!1),console.log(`FrameSkipManager: ${e?"Enabled":"Disabled"}`)}getStats(){const e=this.getAverageFrameTime(),t=e>0?1e3/e:0;return{enabled:this.enabled,isInteracting:this.isInteracting,fastMotion:this.fastMotion,currentSkipCount:this.skipCount,averageFrameTime:e.toFixed(2),estimatedFPS:t.toFixed(1),targetFPS:this.targetFPS}}destroy(){this.viewer&&this.originalForceRedraw&&(this.viewer.forceRedraw=this.originalForceRedraw)}}const y={qualityPreservation:{minVisibleAreaDesktop:600,minVisibleAreaMobile:400,maxZoomForQuality:15,adaptivePaddingEnabled:!0},viewer:{imageLoaderLimit:1,maxImageCacheCount:100,minPixelRatio:1,minZoomImageRatio:.8,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:1,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:"transparent",subPixelRoundingEnabled:!1,animationTime:.3,springStiffness:12,blendTime:.3,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.1,zoomPerClick:1.5,minZoomLevel:.8,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:1.5,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:2,tileRetryMax:1,tileRetryDelay:50,minimumPixelsPerTile:24,artifactElimination:{enableTileCascadePrevention:!0,enableBlendingOptimization:!0,enableMouseWheelSmoothing:!0,enableProgressiveQuality:!0},compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},tiles:{tileSize:1024,overlap:2,jpegQuality:85,format:"jpeg",enableWebP:!1},hotspots:{batchSize:20,visibilityCheckInterval:150,renderDebounceTime:16,fadeInDuration:0,preloadPadding:.1,maxVisibleHotspots:20,minZoomForHotspots:4,animationBatchSize:10,animationFrameBudget:12,maxConcurrentAnimations:8},audio:{preloadCount:5,crossfadeDuration:150,bufferSize:5,html5PoolSize:5,autoUnlock:!0},viewport:{cacheEnabled:!0,cacheTimeout:8,updateDebounce:4,preloadPadding:.15},memory:{maxCachedImages:250,maxCachedAudio:8,gcInterval:2e4,lowMemoryThreshold:80,criticalMemoryThreshold:150},network:{maxConcurrentRequests:4,retryAttempts:1,retryDelay:50,timeout:45e3,useCDN:!0},mobile:{reduceQuality:!1,maxZoomLevel:20,touchSensitivity:1,doubleTapDelay:250,maxImageCacheCount:25,imageLoaderLimit:1,animationTime:.3,springStiffness:12,immediateRender:!0,blendTime:.3,maxTilesPerFrame:2,minPixelRatio:1,minZoomImageRatio:.8,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,debugMode:!1,preserveImageSizeOnResize:!0,maxZoomPixelRatio:1,constrainDuringPan:!0,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:150,flickMomentum:.05,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}},renderOptimization:{enableAdaptiveRendering:!0,animationEndDelay:25,pixelPerfectDelay:15,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:50,useWebGL:!1,forceIntegerPositions:!0,zoomOptimizations:{reduceBlendTime:!0,targetBlendTime:0,increaseStiffness:!0,targetStiffness:18,forceImmediateRender:!0,disableSmoothing:!0,reduceTilesPerFrame:!0,targetTilesPerFrame:2}},debug:{showFPS:!1,showMetrics:!0,logPerformance:!1,warnThreshold:{fps:45,renderTime:20,visibleHotspots:100}}},Ye=()=>{var t;const m=navigator.userAgent.toLowerCase(),e=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(m),isChrome:/chrome|crios/i.test(m)&&!/edge|edg/i.test(m),isFirefox:/firefox|fxios/i.test(m),isEdge:/edge|edg/i.test(m),isIOS:/ipad|iphone|ipod/.test(m)||e==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(m),isMac:/mac/.test(e),isWindows:/win/.test(e),isMobile:/android|iphone|ipad|ipod/i.test(m)||e==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(m)||e==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((t=navigator.connection)==null?void 0:t.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},Xe=()=>{const m=Ye();return(m.isSafari||m.isIOS)&&(y.viewer.drawer="canvas",m.isSafari&&!m.isIOS&&(y.viewer.imageLoaderLimit=m.isHighEndDevice?4:2,y.viewer.maxImageCacheCount=100,y.viewer.maxTilesPerFrame=3,y.viewer.animationTime=1,y.viewer.springStiffness=7,y.viewer.blendTime=0,y.viewer.minPixelRatio=.5,y.viewer.immediateRender=!0),m.isIOS&&(y.viewer.imageLoaderLimit=2,y.viewer.maxImageCacheCount=100,y.viewer.maxTilesPerFrame=2,y.viewer.animationTime=.8,y.viewer.springStiffness=8,y.viewer.blendTime=0,y.viewer.minPixelRatio=1,y.viewer.immediateRender=!0,y.viewer.alwaysBlend=!1,y.viewer.smoothTileEdgesMinZoom=1/0,y.viewer.gestureSettingsTouch={flickEnabled:!0,flickMinSpeed:120,flickMomentum:.35,pinchRotate:!1}),y.viewer.imageSmoothingEnabled=!1,y.viewer.smoothTileEdgesMinZoom=1/0,y.viewer.updatePixelDensityRatio=!1,y.viewer.placeholderFillStyle=null,y.viewer.opacity=1,y.viewer.preload=!1,y.viewer.compositeOperation=null,y.viewer.subPixelRoundingForTransparency="NEVER",console.log("Safari detected - applied research-based 50-60 FPS optimizations",{platform:m.isIOS?"iOS":"Desktop",imageLoaderLimit:y.viewer.imageLoaderLimit,blendTime:y.viewer.blendTime})),m.isAndroid&&(y.viewer.drawer="canvas",y.viewer.imageSmoothingEnabled=!1,console.log("Android detected - applying STEP 4 optimizations")),m.isMobile&&(Object.assign(y.viewer,{drawer:"canvas",imageLoaderLimit:1,maxImageCacheCount:100,animationTime:.3,springStiffness:12,immediateRender:!0,blendTime:.3,smoothImageZoom:!1,maxTilesPerFrame:2,visibilityRatio:1,minPixelRatio:1,minZoomImageRatio:.5,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,preserveImageSizeOnResize:!0,maxZoomPixelRatio:1,imageSmoothingEnabled:!1,updatePixelDensityRatio:!1,constrainDuringPan:!0,subPixelRendering:!1,minimumPixelsPerTile:40,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:150,flickMomentum:.05,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),y.hotspots.batchSize=15,y.hotspots.maxVisibleHotspots=15,y.hotspots.renderDebounceTime=8,y.memory.maxCachedImages=30,console.log("Mobile device detected - applied STEP 4 ultra-aggressive optimizations")),m.isLowEndDevice&&(y.viewer.animationTime=.15,y.viewer.springStiffness=18,y.viewer.maxImageCacheCount=Math.min(100,y.viewer.maxImageCacheCount),y.viewer.imageLoaderLimit=1,y.viewer.maxTilesPerFrame=1,y.memory.maxCachedImages=100,y.network.maxConcurrentRequests=2,y.hotspots.maxVisibleHotspots=30,y.viewer.minPixelRatio=.8,console.log("Low-end device detected - applied STEP 4 ultra-conservative settings")),m.isHighEndDevice&&!m.isMobile&&(y.viewer.maxImageCacheCount=600,y.viewer.imageLoaderLimit=6,y.viewer.maxTilesPerFrame=4,y.memory.maxCachedImages=400,y.network.maxConcurrentRequests=6,y.viewer.minPixelRatio=.4,y.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - applied STEP 4 balanced performance/quality")),m.isHighDPI&&!m.isMobile&&(y.viewer.minPixelRatio=Math.min(.5,y.viewer.minPixelRatio),y.viewer.maxZoomPixelRatio=Math.max(4,m.pixelRatio*2)),(m.connectionType==="slow-2g"||m.connectionType==="2g")&&(y.viewer.imageLoaderLimit=1,y.network.maxConcurrentRequests=1,y.viewer.timeout=9e4,console.log("Slow connection detected - applied STEP 4 minimal network usage")),m},B=Xe();function gt(m,e){const t=y,i=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent),r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=r&&!i;let a,l,h;if(n?(a=8,l=12,h=20):i?(a=15,l=20,h=30):(a=20,l=25,h=35),m<a&&m>0)return r?(t.viewer.imageLoaderLimit=1,t.viewer.maxTilesPerFrame=1,t.viewer.blendTime=0,t.viewer.maxImageCacheCount=25,t.viewer.minPixelRatio=1.2,t.viewer.immediateRender=!0,t.viewer.animationTime=.5,t.viewer.springStiffness=10):(t.viewer.imageLoaderLimit=1,t.viewer.maxTilesPerFrame=1,t.viewer.animationTime=.1,t.viewer.springStiffness=20,t.viewer.immediateRender=!0,t.viewer.blendTime=0,t.viewer.maxImageCacheCount=25,t.viewer.minPixelRatio=1),console.error("SAFARI FIX: Emergency performance mode activated"),"ultra-emergency";if(m<l&&m>0)return t.viewer.imageLoaderLimit=1,t.viewer.maxTilesPerFrame=1,t.viewer.animationTime=.4,t.viewer.springStiffness=12,t.viewer.immediateRender=!0,t.viewer.blendTime=.05,t.viewer.maxImageCacheCount=60,t.viewer.minPixelRatio=.8,console.warn("Critical performance mode activated"),"critical";if(m<h&&m>0)return t.viewer.imageLoaderLimit=Math.max(1,t.viewer.imageLoaderLimit-1),t.viewer.maxTilesPerFrame=Math.max(1,t.viewer.maxTilesPerFrame-1),t.viewer.animationTime=.25,t.viewer.springStiffness=12,"reduced";if(m>55){const g=B.isHighEndDevice?6:B.isMobile?1:4;return t.viewer.imageLoaderLimit<g&&(t.viewer.imageLoaderLimit=Math.min(g,t.viewer.imageLoaderLimit+1)),t.viewer.maxTilesPerFrame<3&&(t.viewer.maxTilesPerFrame=Math.min(3,t.viewer.maxTilesPerFrame+1)),t.viewer.animationTime=B.isMobile?.2:.3,t.viewer.springStiffness=B.isMobile?15:12,t.viewer.minPixelRatio=B.isMobile?.8:.5,"normal"}return e>t.memory.criticalMemoryThreshold?(t.viewer.maxImageCacheCount=Math.max(25,Math.floor(t.viewer.maxImageCacheCount*.4)),t.hotspots.maxVisibleHotspots=Math.max(10,Math.floor(t.hotspots.maxVisibleHotspots*.5)),console.warn(`STEP 4: High memory usage: ${e}MB - Applied aggressive reduction`),"memory-limited"):"normal"}const je=(m,e,t,i,r=null)=>{const n=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;if(n&&i&&(t="canvas",console.log("[CRITICAL] iOS detected: Forcing canvas drawer to prevent tile array corruption at indices 12/13")),i){const a=n&&window.screen.width>=1024,l=n&&!a&&window.screen.width>=820,h=n&&!a&&!l;m.animationTime=n?.2:.3,m.springStiffness=n?9:10,m.blendTime=n?.2:.3,m.immediateRender=!0,a?(m.imageLoaderLimit=4,m.maxImageCacheCount=100,console.log("[iPad Pro Detected] Using optimized settings: 4 concurrent loads, 100 tile cache")):l?(m.imageLoaderLimit=2,m.maxImageCacheCount=75,console.log("[iPad Air Detected] Using balanced settings: 2 concurrent loads, 75 tile cache")):h?(m.imageLoaderLimit=1,m.maxImageCacheCount=30,console.log("[Standard iPad Detected] Using conservative settings: 1 load, 30 tile cache")):(m.imageLoaderLimit=1,m.maxImageCacheCount=100),m.visibilityRatio=1,m.maxTilesPerFrame=2,m.alwaysBlend=!1,m.constrainDuringPan=!0,m.maxZoomPixelRatio=1.5,m.imageSmoothingEnabled=!1,m.updatePixelDensityRatio=!1,m.subPixelRendering=!1,m.minimumPixelsPerTile=32,console.log("Applied research-based mobile optimizations for zoom performance")}return{tileSources:r||e,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:t,imageSmoothingEnabled:m.imageSmoothingEnabled,smoothTileEdgesMinZoom:n?1/0:m.smoothTileEdgesMinZoom,alwaysBlend:m.alwaysBlend,placeholderFillStyle:m.placeholderFillStyle,opacity:1,preload:m.preload,compositeOperation:m.compositeOperation,...m.drawer==="webgl"?{webglOptions:m.webglOptions}:{},immediateRender:m.immediateRender,imageLoaderLimit:m.imageLoaderLimit,maxImageCacheCount:m.maxImageCacheCount,timeout:m.timeout,loadTilesWithAjax:m.loadTilesWithAjax,ajaxHeaders:m.ajaxHeaders,visibilityRatio:m.visibilityRatio,minPixelRatio:m.minPixelRatio,defaultZoomLevel:m.defaultZoomLevel,minZoomLevel:m.minZoomLevel,maxZoomPixelRatio:m.maxZoomPixelRatio,constrainDuringPan:m.constrainDuringPan,wrapHorizontal:m.wrapHorizontal,wrapVertical:m.wrapVertical,animationTime:m.animationTime,springStiffness:m.springStiffness,blendTime:m.blendTime,zoomPerScroll:i?1.2:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:n?!1:m.flickEnabled,flickMinSpeed:m.flickMinSpeed,flickMomentum:n?0:m.flickMomentum,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:m.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:m.preserveImageSizeOnResize,maxTilesPerFrame:m.maxTilesPerFrame,smoothImageZoom:m.smoothImageZoom,subPixelRendering:m.subPixelRendering!==void 0?m.subPixelRendering:!1,minimumPixelsPerTile:m.minimumPixelsPerTile||(i?32:24),updatePixelDensityRatio:m.updatePixelDensityRatio!==void 0?m.updatePixelDensityRatio:!1,smoothTileEdgesMinZoom:i?1/0:m.smoothTileEdgesMinZoom,imageSmoothingEnabled:m.imageSmoothingEnabled!==void 0?m.imageSmoothingEnabled:!i,useCanvas:n?!1:void 0}};let L=null;async function Ke(){if(L)return L;try{return L=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${L.length} hotspots`),L}catch(m){return console.error("Failed to load hotspots:",m),L=[],L}}function Je(m){if(m){if(console.log("Forcing viewer state reset to fix flickering..."),m.world){const e=m.world.getItemCount();for(let t=0;t<e;t++){const i=m.world.getItemAt(t);i&&i.reset()}}m.viewport.centerSpringX.resetTo(m.viewport.centerSpringX.target.value),m.viewport.centerSpringY.resetTo(m.viewport.centerSpringY.target.value),m.viewport.zoomSpring.resetTo(m.viewport.zoomSpring.target.value),m.viewport.applyConstraints(!0),m.forceRedraw(),setTimeout(()=>m.forceRedraw(),50),setTimeout(()=>m.forceRedraw(),100),console.log("Viewer state reset completed")}}class et{constructor(e={}){this.viewer=e.viewer,this.targetFPS=e.targetFPS||30,this.criticalFPS=e.criticalFPS||20,this.qualityLevels={HIGH:"high",MEDIUM:"medium",LOW:"low",ULTRA_LOW:"ultra-low"},this.currentQuality=this.qualityLevels.HIGH,this.qualityHistory=[],this.metrics={fps:[],frameTime:[],memoryUsage:[],cpuUsage:[],temperature:"normal"},this.qualityPresets={[this.qualityLevels.HIGH]:{maxHotspots:10,animationDuration:800,staggerDelay:12,shadowQuality:"high",rippleComplexity:"full",lodAggressiveness:1,useGPUEffects:!0,maxConcurrentAnimations:3},[this.qualityLevels.MEDIUM]:{maxHotspots:8,animationDuration:600,staggerDelay:8,shadowQuality:"medium",rippleComplexity:"simple",lodAggressiveness:1.2,useGPUEffects:!0,maxConcurrentAnimations:2},[this.qualityLevels.LOW]:{maxHotspots:6,animationDuration:400,staggerDelay:5,shadowQuality:"low",rippleComplexity:"minimal",lodAggressiveness:1.5,useGPUEffects:!1,maxConcurrentAnimations:1},[this.qualityLevels.ULTRA_LOW]:{maxHotspots:4,animationDuration:300,staggerDelay:0,shadowQuality:"none",rippleComplexity:"none",lodAggressiveness:2,useGPUEffects:!1,maxConcurrentAnimations:1}},this.deviceCapabilities=this.detectDeviceCapabilities(),this.frameCount=0,this.lastFrameTime=performance.now(),this.fpsUpdateInterval=1e3,this.lastFPSUpdate=performance.now(),this.adjustmentThresholds={upgradeThreshold:5e3,downgradeThreshold:2e3,criticalThreshold:500},this.isMonitoring=!1,this.rafId=null,this.onQualityChange=e.onQualityChange||(()=>{}),console.log("[AdaptiveQualityManager] Initialized with device capabilities:",this.deviceCapabilities)}detectDeviceCapabilities(){const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl"),i={cores:navigator.hardwareConcurrency||2,memory:navigator.deviceMemory||2,connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink}:null,gpu:t?{vendor:t.getParameter(t.VENDOR),renderer:t.getParameter(t.RENDERER)}:null,isMobile:/Android|iPhone|iPad|iPod/i.test(navigator.userAgent),isLowEnd:!1};(i.cores<=2||i.memory<=2)&&(i.isLowEnd=!0);const r=navigator.userAgent.toLowerCase(),n=["samsung galaxy a","samsung galaxy j","xiaomi redmi","oppo a","vivo y"];return i.isLowEnd=i.isLowEnd||n.some(a=>r.includes(a)),i}start(){this.isMonitoring||(this.isMonitoring=!0,this.deviceCapabilities.isLowEnd?this.setQuality(this.qualityLevels.LOW):this.deviceCapabilities.isMobile&&this.setQuality(this.qualityLevels.MEDIUM),this.monitor(),console.log("[AdaptiveQualityManager] Started monitoring"))}monitor(){if(!this.isMonitoring)return;const e=performance.now(),t=e-this.lastFrameTime;if(this.lastFrameTime=e,this.frameCount++,e-this.lastFPSUpdate>=this.fpsUpdateInterval){const i=this.frameCount*1e3/(e-this.lastFPSUpdate);this.updateMetrics(i,t),this.frameCount=0,this.lastFPSUpdate=e,this.evaluateQualityAdjustment()}this.rafId=requestAnimationFrame(()=>this.monitor())}updateMetrics(e,t){if(this.metrics.fps.push(e),this.metrics.fps.length>10&&this.metrics.fps.shift(),this.metrics.frameTime.push(t),this.metrics.frameTime.length>10&&this.metrics.frameTime.shift(),performance.memory){const i=performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit;this.metrics.memoryUsage.push(i),this.metrics.memoryUsage.length>10&&this.metrics.memoryUsage.shift()}}evaluateQualityAdjustment(){const e=this.getAverageFPS(),t=performance.now(),i={quality:this.currentQuality,fps:e,timestamp:t};if(this.qualityHistory.push(i),e<this.criticalFPS&&this.qualityHistory.filter(n=>t-n.timestamp<this.adjustmentThresholds.criticalThreshold).every(n=>n.fps<this.criticalFPS)){this.downgradeQuality("critical");return}if(e<this.targetFPS){const r=this.qualityHistory.filter(n=>t-n.timestamp<this.adjustmentThresholds.downgradeThreshold);if(r.length>5&&r.every(n=>n.fps<this.targetFPS)){this.downgradeQuality("poor");return}}if(e>this.targetFPS+10){const r=this.qualityHistory.filter(n=>t-n.timestamp<this.adjustmentThresholds.upgradeThreshold);r.length>10&&r.every(n=>n.fps>this.targetFPS+10)&&this.upgradeQuality()}this.qualityHistory=this.qualityHistory.filter(r=>t-r.timestamp<3e4)}getAverageFPS(){return this.metrics.fps.length===0?this.targetFPS:this.metrics.fps.reduce((e,t)=>e+t,0)/this.metrics.fps.length}downgradeQuality(e="performance"){const t=Object.values(this.qualityLevels),i=t.indexOf(this.currentQuality);if(i<t.length-1){const r=t[i+1];this.setQuality(r),console.warn(`[AdaptiveQualityManager] Downgrading quality to ${r} due to ${e} performance`)}}upgradeQuality(){const e=Object.values(this.qualityLevels),t=e.indexOf(this.currentQuality);if(t>0){const i=e[t-1];this.setQuality(i),console.log(`[AdaptiveQualityManager] Upgrading quality to ${i} due to good performance`)}}setQuality(e){if(!this.qualityPresets[e])return;this.currentQuality=e;const t=this.qualityPresets[e];this.applyQualitySettings(t),this.onQualityChange(e,t)}applyQualitySettings(e){var t,i;window.temporalEchoController&&(window.temporalEchoController.config.mobileMaxHotspots=e.maxHotspots,window.temporalEchoController.config.echoDuration=e.animationDuration,window.temporalEchoController.config.staggerDelay=e.staggerDelay),(t=window.temporalEchoController)!=null&&t.rippleRenderer&&(window.temporalEchoController.rippleRenderer.duration=e.animationDuration,window.temporalEchoController.rippleRenderer.maxRipples=e.maxConcurrentAnimations),(i=window.nativeHotspotRenderer)!=null&&i.lodSystem&&(window.nativeHotspotRenderer.lodSystem.aggressiveness=e.lodAggressiveness),this.updateShadowQuality(e.shadowQuality),console.log("[AdaptiveQualityManager] Applied quality settings:",e)}updateShadowQuality(e){}forceQuality(e){this.qualityPresets[e]&&(this.setQuality(e),console.log(`[AdaptiveQualityManager] Forced quality to ${e}`))}getMetrics(){return{currentQuality:this.currentQuality,averageFPS:this.getAverageFPS(),metrics:this.metrics,deviceCapabilities:this.deviceCapabilities}}stop(){this.isMonitoring=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),console.log("[AdaptiveQualityManager] Stopped monitoring")}destroy(){this.stop(),this.metrics={fps:[],frameTime:[],memoryUsage:[],cpuUsage:[]},this.qualityHistory=[]}}const tt=new et;class it{constructor(e={}){this.enabled=e.enabled!==!1,this.thermalStates={NORMAL:"normal",WARM:"warm",HOT:"hot",CRITICAL:"critical"},this.currentState=this.thermalStates.NORMAL,this.throttleProfiles={[this.thermalStates.NORMAL]:{cpuThrottle:1,animationScale:1,renderDelay:0,maxConcurrent:10},[this.thermalStates.WARM]:{cpuThrottle:.8,animationScale:.8,renderDelay:50,maxConcurrent:6},[this.thermalStates.HOT]:{cpuThrottle:.6,animationScale:.5,renderDelay:100,maxConcurrent:3},[this.thermalStates.CRITICAL]:{cpuThrottle:.3,animationScale:.3,renderDelay:200,maxConcurrent:1}},this.performanceHistory=[],this.lastPerformanceCheck=performance.now(),this.batteryLevel=1,this.isCharging=!0,this.batteryAPISupported="getBattery"in navigator,this.thermalEstimation={sustainedHighPerf:0,lastHighPerfStart:null,cooldownPeriod:0},this.onStateChange=e.onStateChange||(()=>{}),this.batteryAPISupported&&this.initBatteryMonitoring(),console.log("[ThermalManager] Initialized",{batteryAPISupported:this.batteryAPISupported})}async initBatteryMonitoring(){try{const e=await navigator.getBattery();this.batteryLevel=e.level,this.isCharging=e.charging,e.addEventListener("levelchange",()=>{this.batteryLevel=e.level,this.evaluateThermalState()}),e.addEventListener("chargingchange",()=>{this.isCharging=e.charging,this.evaluateThermalState()}),console.log("[ThermalManager] Battery monitoring initialized",{level:this.batteryLevel,charging:this.isCharging})}catch(e){console.warn("[ThermalManager] Battery API not available:",e),this.batteryAPISupported=!1}}updatePerformance(e){const t=performance.now();this.performanceHistory.push({timestamp:t,fps:e.fps,frameTime:e.frameTime,memoryUsage:e.memoryUsage}),this.performanceHistory=this.performanceHistory.filter(i=>t-i.timestamp<6e4),this.updateThermalEstimation(e),this.evaluateThermalState()}updateThermalEstimation(e){const t=performance.now();e.fps>50||e.frameTime<20?(this.thermalEstimation.lastHighPerfStart||(this.thermalEstimation.lastHighPerfStart=t),this.thermalEstimation.sustainedHighPerf=t-this.thermalEstimation.lastHighPerfStart,this.thermalEstimation.cooldownPeriod=0):(this.thermalEstimation.lastHighPerfStart&&(this.thermalEstimation.cooldownPeriod+=t-this.lastPerformanceCheck),this.thermalEstimation.cooldownPeriod>1e4&&(this.thermalEstimation.lastHighPerfStart=null,this.thermalEstimation.sustainedHighPerf=0)),this.lastPerformanceCheck=t}evaluateThermalState(){let e=this.thermalStates.NORMAL;const t=this.thermalEstimation.sustainedHighPerf;t>12e4?e=this.thermalStates.CRITICAL:t>6e4?e=this.thermalStates.HOT:t>3e4&&(e=this.thermalStates.WARM),this.batteryAPISupported&&(!this.isCharging&&this.batteryLevel<.2?e=this.increaseThrottleState(e):this.isCharging&&this.batteryLevel>.8&&(e=this.decreaseThrottleState(e)));const i=this.getRecentPerformance(5e3);i.avgFPS<20&&(e=this.increaseThrottleState(e)),i.avgMemoryUsage>.8&&(e=this.increaseThrottleState(e)),e!==this.currentState&&this.setState(e)}getRecentPerformance(e){const t=performance.now(),i=this.performanceHistory.filter(l=>t-l.timestamp<e);if(i.length===0)return{avgFPS:30,avgFrameTime:33,avgMemoryUsage:.5};const r=i.reduce((l,h)=>l+h.fps,0)/i.length,n=i.reduce((l,h)=>l+h.frameTime,0)/i.length,a=i.reduce((l,h)=>l+(h.memoryUsage||.5),0)/i.length;return{avgFPS:r,avgFrameTime:n,avgMemoryUsage:a}}increaseThrottleState(e){const t=Object.values(this.thermalStates),i=t.indexOf(e);return t[Math.min(i+1,t.length-1)]}decreaseThrottleState(e){const t=Object.values(this.thermalStates),i=t.indexOf(e);return t[Math.max(i-1,0)]}setState(e){const t=this.currentState;this.currentState=e;const i=this.throttleProfiles[e];console.log(`[ThermalManager] State changed: ${t} -> ${e}`,i),this.applyThrottling(i),this.onStateChange(e,i)}applyThrottling(e){window.temporalEchoController&&(window.temporalEchoController.config.echoDuration=800*e.animationScale),window.nativeHotspotRenderer&&(window.nativeHotspotRenderer.renderDelay=e.renderDelay),window.temporalEchoController&&(window.temporalEchoController.config.maxSimultaneous=Math.min(e.maxConcurrent,10))}forceCooldown(){console.log("[ThermalManager] Forcing cooldown period"),this.thermalEstimation={sustainedHighPerf:0,lastHighPerfStart:null,cooldownPeriod:0},this.setState(this.thermalStates.WARM),setTimeout(()=>{this.currentState===this.thermalStates.WARM&&this.evaluateThermalState()},1e4)}getCurrentProfile(){return this.throttleProfiles[this.currentState]}getStatus(){return{state:this.currentState,profile:this.getCurrentProfile(),battery:{level:this.batteryLevel,charging:this.isCharging},thermalEstimation:this.thermalEstimation,recentPerformance:this.getRecentPerformance(1e4)}}destroy(){this.performanceHistory=[],this.thermalEstimation={sustainedHighPerf:0,lastHighPerfStart:null,cooldownPeriod:0}}}const st=new it;class rt{constructor(e={}){this.viewer=e.viewer,this.enabled=e.enabled!==!1,this.config={sampleInterval:100,reportInterval:1e3,historySize:60,enableLogging:e.enableLogging||!1},this.metrics={fps:{current:0,average:0,min:60,max:0,samples:[]},frameTime:{current:0,average:0,max:0,samples:[]},memory:{used:0,total:0,percentage:0,samples:[]},interactions:{tapLatency:[],animationDroppedFrames:0,totalInteractions:0},rendering:{hotspotCount:0,visibleHotspots:0,activeAnimations:0,renderCalls:0}},this.performanceState={overall:"optimal",fps:"optimal",memory:"optimal",thermal:"normal",quality:"high"},this.isMonitoring=!1,this.frameCount=0,this.lastFrameTime=performance.now(),this.lastReportTime=performance.now(),this.rafId=null,this.performanceMarks=new Map,this.adaptiveQuality=tt,this.thermal=st,this.onPerformanceReport=e.onPerformanceReport||(()=>{}),this.onPerformanceWarning=e.onPerformanceWarning||(()=>{}),console.log("[PerformanceMonitoringSystem] Initialized")}start(){this.isMonitoring||(this.isMonitoring=!0,this.adaptiveQuality.start(),this.adaptiveQuality.onQualityChange=(e,t)=>{this.performanceState.quality=e,this.handleQualityChange(e,t)},this.thermal.onStateChange=(e,t)=>{this.performanceState.thermal=e,this.handleThermalChange(e,t)},this.monitor(),this.startReporting(),console.log("[PerformanceMonitoringSystem] Started monitoring"))}monitor(){if(!this.isMonitoring)return;const e=performance.now(),t=e-this.lastFrameTime;this.frameCount++,this.updateFrameMetrics(t),this.updateMemoryMetrics(),this.updateRenderingMetrics(),this.lastFrameTime=e,this.rafId=requestAnimationFrame(()=>this.monitor())}updateFrameMetrics(e){this.frameCount!==1&&(this.metrics.frameTime.current=e,this.metrics.frameTime.samples.push(e),this.metrics.frameTime.samples.length>this.config.historySize&&this.metrics.frameTime.samples.shift(),e>this.metrics.frameTime.max&&(this.metrics.frameTime.max=e),e>33&&this.metrics.interactions.animationDroppedFrames++)}updateMemoryMetrics(){if(!performance.memory)return;const e=performance.memory.usedJSHeapSize,t=performance.memory.jsHeapSizeLimit,i=e/t;this.metrics.memory.used=e,this.metrics.memory.total=t,this.metrics.memory.percentage=i,this.metrics.memory.samples.push(i),this.metrics.memory.samples.length>this.config.historySize&&this.metrics.memory.samples.shift(),i>.9?this.performanceState.memory="critical":i>.8?this.performanceState.memory="poor":i>.7?this.performanceState.memory="degraded":i>.5?this.performanceState.memory="good":this.performanceState.memory="optimal"}updateRenderingMetrics(){if(window.nativeHotspotRenderer){const e=window.nativeHotspotRenderer.activeHotspotManager;if(e){const t=e.getStats();this.metrics.rendering.hotspotCount=t.totalHotspots,this.metrics.rendering.visibleHotspots=t.activeHotspots}}window.temporalEchoController&&(this.metrics.rendering.activeAnimations=window.temporalEchoController.activeEchoes.size),this.metrics.rendering.renderCalls++}startReporting(){setInterval(()=>{if(!this.isMonitoring)return;const e=performance.now(),t=e-this.lastReportTime,i=this.frameCount*1e3/t;this.metrics.fps.current=i,this.metrics.fps.samples.push(i),this.metrics.fps.samples.length>this.config.historySize&&this.metrics.fps.samples.shift(),i<this.metrics.fps.min&&(this.metrics.fps.min=i),i>this.metrics.fps.max&&(this.metrics.fps.max=i),this.calculateAverages(),i<20?this.performanceState.fps="critical":i<25?this.performanceState.fps="poor":i<30?this.performanceState.fps="degraded":i<45?this.performanceState.fps="good":this.performanceState.fps="optimal",this.updateOverallState(),this.thermal.updatePerformance({fps:i,frameTime:this.metrics.frameTime.average,memoryUsage:this.metrics.memory.percentage});const r=this.generateReport();this.onPerformanceReport(r),this.checkPerformanceWarnings(r),this.frameCount=0,this.lastReportTime=e,this.metrics.rendering.renderCalls=0},this.config.reportInterval)}calculateAverages(){this.metrics.fps.samples.length>0&&(this.metrics.fps.average=this.metrics.fps.samples.reduce((e,t)=>e+t,0)/this.metrics.fps.samples.length),this.metrics.frameTime.samples.length>0&&(this.metrics.frameTime.average=this.metrics.frameTime.samples.reduce((e,t)=>e+t,0)/this.metrics.frameTime.samples.length)}updateOverallState(){const e=["critical","poor","degraded","good","optimal"],t={critical:0,poor:1,degraded:2,good:3,optimal:4},i=Math.min(t[this.performanceState.fps],t[this.performanceState.memory]);this.performanceState.overall=e[i]}generateReport(){return{timestamp:Date.now(),state:this.performanceState,metrics:{fps:{current:Math.round(this.metrics.fps.current),average:Math.round(this.metrics.fps.average),min:Math.round(this.metrics.fps.min),max:Math.round(this.metrics.fps.max)},frameTime:{current:Math.round(this.metrics.frameTime.current),average:Math.round(this.metrics.frameTime.average),max:Math.round(this.metrics.frameTime.max)},memory:{used:Math.round(this.metrics.memory.used/1048576),total:Math.round(this.metrics.memory.total/1048576),percentage:Math.round(this.metrics.memory.percentage*100)},rendering:{...this.metrics.rendering,droppedFrames:this.metrics.interactions.animationDroppedFrames}},quality:this.adaptiveQuality.getMetrics(),thermal:this.thermal.getStatus()}}checkPerformanceWarnings(e){const t=[];e.state.fps==="critical"&&t.push({type:"fps",severity:"critical",message:`FPS critically low: ${e.metrics.fps.current}`,suggestion:"Reducing quality settings"}),e.metrics.memory.percentage>85&&t.push({type:"memory",severity:"high",message:`Memory usage high: ${e.metrics.memory.percentage}%`,suggestion:"Consider reloading the page"}),(e.thermal.state==="hot"||e.thermal.state==="critical")&&t.push({type:"thermal",severity:"high",message:`Device overheating: ${e.thermal.state}`,suggestion:"Performance throttled to prevent damage"}),t.length>0&&this.onPerformanceWarning(t)}handleQualityChange(e,t){this.config.enableLogging&&console.log("[PerformanceMonitoringSystem] Quality changed:",e,t)}handleThermalChange(e,t){this.config.enableLogging&&console.log("[PerformanceMonitoringSystem] Thermal state changed:",e,t)}markStart(e){this.performanceMarks.set(e,performance.now())}markEnd(e){const t=this.performanceMarks.get(e);if(!t)return null;const i=performance.now()-t;return this.performanceMarks.delete(e),(e.includes("tap")||e.includes("interaction"))&&(this.metrics.interactions.tapLatency.push(i),this.metrics.interactions.tapLatency.length>20&&this.metrics.interactions.tapLatency.shift(),this.metrics.interactions.totalInteractions++),i}forceGC(){window.gc&&(console.log("[PerformanceMonitoringSystem] Forcing garbage collection"),window.gc())}getSummary(){return{fps:Math.round(this.metrics.fps.current),state:this.performanceState.overall,quality:this.performanceState.quality,thermal:this.performanceState.thermal}}stop(){this.isMonitoring=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.adaptiveQuality.stop(),console.log("[PerformanceMonitoringSystem] Stopped monitoring")}destroy(){this.stop(),this.adaptiveQuality.destroy(),this.thermal.destroy(),this.performanceMarks.clear()}}const V=new rt;async function ot(){const m="data:image/avif;base64,AAAAFGZ0eXBhdmlmAAAAAG1pZjEAAACgbWV0YQAAAAAAAAAOcGl0bQAAAAAAAQAAAB5pbG9jAAAAAEQAAAEAAQAAAAEAAAC8AAAAGwAAACNpaW5mAAAAAAABAAAAFWluZmUCAAAAAAEAAGF2MDEAAAAARWlwcnAAAAAoaXBjbwAAABRpc3BlAAAAAAAAAAQAAAAEAAAADGF2MUOBAAAAAAAAFWlwbWEAAAAAAAAAAQABAgECAAAAI21kYXRSAAoIP8R8hAQ0BUAyDWeeUy0JG+QAACANEkA=",e="data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoCAAEAAQAcJaQAA3AA/v3AgAA=",t=await new Promise(n=>{const a=new Image;a.onload=()=>n(!0),a.onerror=()=>n(!1),a.src=m}),i=await new Promise(n=>{const a=new Image;a.onload=()=>n(a.width===2&&a.height===1),a.onerror=()=>n(!1),a.src=e}),r={avif:t,webp:i};return console.log("[ImageFormatDetection] Browser support:",r),r}class nt{constructor(e,t){this.viewer=e,this.formats=t||{webp:!1,avif:!1},this.baseFormat="jpg",console.log("[AdaptiveFormatTileSource] Initialized with format support:",this.formats)}getTileUrl(e,t,i){const r=this.selectOptimalFormat(e);return`/images/tiles/${e}/${t}_${i}.${r}`}selectOptimalFormat(e){return e>=12&&this.formats.avif?"avif":e>=8&&this.formats.webp?"webp":this.baseFormat}updateFormatSupport(e){this.formats=e,console.log("[AdaptiveFormatTileSource] Updated format support:",this.formats)}}async function at(m){const e=await ot(),t=new nt(m,e);return window.adaptiveFormatSource=t,t}class lt{constructor(e=200){this.dbName="diary-tile-cache",this.version=1,this.maxSize=e*1024*1024,this.db=null,this.lruMap=new Map,this.currentSize=0,this.enabled=!0,this.stats={hits:0,misses:0,stores:0,evictions:0},this.initDB()}async initDB(){if(!("indexedDB"in window)){console.warn("[IndexedDBTileCache] IndexedDB not supported"),this.enabled=!1;return}try{const e=indexedDB.open(this.dbName,this.version);e.onupgradeneeded=t=>{const i=t.target.result;if(!i.objectStoreNames.contains("tiles")){const r=i.createObjectStore("tiles",{keyPath:"id"});r.createIndex("timestamp","timestamp"),r.createIndex("size","size"),console.log("[IndexedDBTileCache] Created tiles object store")}i.objectStoreNames.contains("metadata")||i.createObjectStore("metadata",{keyPath:"key"})},e.onsuccess=()=>{this.db=e.result,console.log("[IndexedDBTileCache] Database initialized"),this.loadMetadata(),this.checkStorageQuota()},e.onerror=t=>{console.error("[IndexedDBTileCache] Database error:",t.target.error),this.enabled=!1}}catch(e){console.error("[IndexedDBTileCache] Failed to initialize:",e),this.enabled=!1}}async storeTile(e,t){if(!(!this.enabled||!this.db))try{const i={id:e,blob:t,timestamp:Date.now(),size:t.size};this.currentSize+t.size>this.maxSize&&await this.evictOldest(t.size);const a=this.db.transaction(["tiles"],"readwrite").objectStore("tiles").put(i);a.onsuccess=()=>{this.lruMap.delete(e),this.lruMap.set(e,Date.now()),this.currentSize+=t.size,this.stats.stores++,this.saveMetadata()},a.onerror=l=>{console.error("[IndexedDBTileCache] Store error:",l.target.error)}}catch(i){console.error("[IndexedDBTileCache] Failed to store tile:",i)}}async getTile(e){return!this.enabled||!this.db?null:new Promise(t=>{try{const n=this.db.transaction(["tiles"],"readonly").objectStore("tiles").get(e);n.onsuccess=()=>{const a=n.result;a?(this.lruMap.delete(e),this.lruMap.set(e,Date.now()),this.stats.hits++,t(a.blob)):(this.stats.misses++,t(null))},n.onerror=()=>{this.stats.misses++,t(null)}}catch(i){console.error("[IndexedDBTileCache] Failed to get tile:",i),t(null)}})}async evictOldest(e){const i=this.db.transaction(["tiles"],"readwrite").objectStore("tiles"),r=i.index("timestamp");let n=0;const a=[],l=r.openCursor();l.onsuccess=h=>{const g=h.target.result;if(g&&n<e){const p=g.value;a.push(p.id),n+=p.size,g.continue()}else a.forEach(p=>{i.delete(p),this.lruMap.delete(p),this.stats.evictions++}),this.currentSize-=n,console.log(`[IndexedDBTileCache] Evicted ${a.length} tiles, freed ${(n/1024).toFixed(2)}KB`)}}async checkStorageQuota(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate(),t=e.usage/e.quota*100;t>80&&(console.warn(`[IndexedDBTileCache] Storage usage high: ${t.toFixed(2)}%`),await this.performCleanup()),console.log(`[IndexedDBTileCache] Storage: ${(e.usage/1024/1024).toFixed(2)}MB / ${(e.quota/1024/1024).toFixed(2)}MB (${t.toFixed(2)}%)`)}catch(e){console.warn("[IndexedDBTileCache] Could not estimate storage:",e)}}async performCleanup(){if(!this.db)return;const t=this.db.transaction(["tiles"],"readwrite").objectStore("tiles"),i=t.index("timestamp"),r=Date.now()-7*24*60*60*1e3,n=IDBKeyRange.upperBound(r),a=i.openCursor(n);let l=0;a.onsuccess=h=>{const g=h.target.result;g?(t.delete(g.primaryKey),this.lruMap.delete(g.primaryKey),l++,g.continue()):l>0&&console.log(`[IndexedDBTileCache] Cleaned up ${l} old tiles`)}}async saveMetadata(){if(!this.db)return;this.db.transaction(["metadata"],"readwrite").objectStore("metadata").put({key:"cacheStats",currentSize:this.currentSize,stats:this.stats,lastUpdated:Date.now()})}async loadMetadata(){if(!this.db)return;const i=this.db.transaction(["metadata"],"readonly").objectStore("metadata").get("cacheStats");i.onsuccess=()=>{const r=i.result;r&&(this.currentSize=r.currentSize||0,this.stats=r.stats||this.stats,console.log("[IndexedDBTileCache] Loaded metadata:",this.stats))}}getStats(){const e=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(2):0;return{...this.stats,hitRate:`${e}%`,sizeUsed:`${(this.currentSize/1024/1024).toFixed(2)}MB`,sizeLimit:`${(this.maxSize/1024/1024).toFixed(2)}MB`}}async clearCache(){if(!this.db)return;const i=this.db.transaction(["tiles"],"readwrite").objectStore("tiles").clear();i.onsuccess=()=>{this.lruMap.clear(),this.currentSize=0,this.stats={hits:0,misses:0,stores:0,evictions:0},this.saveMetadata(),console.log("[IndexedDBTileCache] Cache cleared")}}setEnabled(e){this.enabled=e,console.log(`[IndexedDBTileCache] Cache ${e?"enabled":"disabled"}`)}}const pe=new lt(200);window.tileCache=pe;async function ct(m,e,t,i){var $,ee,te,ie,se,re,oe,ne,ae,le,ce;console.log("initializeViewer called with:",{viewerRef:m,props:e,state:!!t,handleHotspotClick:!!i});const r={};let n=null;const a=y.viewer,l=Y(),h=l?"512":"1024",g=`/images/tiles/${e.artworkId}_${h}/${e.artworkId}.dzi`;console.log(`[Mobile Optimization] Using ${h}px tiles for ${l?"mobile":"desktop"} device`);const p={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${e.artworkId}_${h}/${e.artworkId}_files/`,Format:"jpg",Overlap:h==="512"?"1":"2",TileSize:h,Size:{Width:"11244",Height:"6543"}},minLevel:h==="512"?9:8,maxLevel:h==="512"?15:14},s=ye(),o=je(a,p,s,l,p);o.springStiffness=10,o.animationTime=.3,console.log("[viewerSetup] Creating viewer WITHOUT tileSources to ensure handlers attach first");const c=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),u=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;u&&console.log("[CRITICAL iOS CONFIG]",{drawer:o.drawer,smoothTileEdgesMinZoom:o.smoothTileEdgesMinZoom,maxImageCacheCount:o.maxImageCacheCount,flickEnabled:($=o.gestureSettingsTouch)==null?void 0:$.flickEnabled,flickMomentum:(ee=o.gestureSettingsTouch)==null?void 0:ee.flickMomentum,useCanvas:o.useCanvas,tileSize:h}),o.drawer="canvas",o.smoothTileEdgesMinZoom=1/0,o.immediateRender=!0,o.imageSmoothingEnabled=!0,o.updatePixelDensityRatio=!1,o.subPixelRendering=!1,o.blendTime=.5,o.alwaysBlend=!1,console.log("BALANCED: Canvas drawer with optimized smoothing management"),l&&(o.imageLoaderLimit=2,o.maxImageCacheCount=100,o.maxTilesPerFrame=2,o.prefetchTiles=!0,o.subPixelRoundingEnabled=!1,o.constrainDuringPan=!0,o.minPixelRatio=1,o.smoothTileEdgesMinZoom=1/0,console.log("MOBILE PERFORMANCE: Applied research-based optimizations (100 cache, 2 loaders, prefetch enabled)")),console.log("RESEARCH VERIFICATION: Creating viewer with settings:",{drawer:o.drawer,imageLoaderLimit:o.imageLoaderLimit,maxTilesPerFrame:o.maxTilesPerFrame,immediateRender:o.immediateRender,animationTime:o.animationTime,springStiffness:o.springStiffness,isMobile:l}),console.log("Creating OpenSeadragon viewer with config:",o);const d=P({element:m,...o,updatePixelDensityRatio:!1,drawer:l||c||u?"canvas":o.drawer,canvasOptions:{alpha:!1,desynchronized:!0,powerPreference:"low-power"}});console.log("Applying TileCascadeFix for stable tile rendering..."),X(P),await new Promise(S=>setTimeout(S,50));const w={setIsLoading:S=>{console.log(`[viewerSetup] Calling setIsLoading(${S})`),t.setIsLoading(S)},setViewerReady:S=>{console.log(`[viewerSetup] Calling setViewerReady(${S})`),t.setViewerReady(S)}};console.log("[viewerSetup] Current state before open handler:",{isLoading:t.isLoading(),viewerReady:t.viewerReady()}),d.addHandler("open",()=>{console.log("[viewerSetup] OpenSeadragon open event fired!"),console.log("[viewerSetup] Current loading state in handler:",t.isLoading());try{const S=d.world.getItemAt(0);if(S){const I=S.getBounds();if(n=d.viewport.getHomeBounds(),console.log("[viewerSetup] Home viewport stored:",n),console.log("[viewerSetup] About to set isLoading to false"),S.getFullyLoaded()?(console.log("[viewerSetup] Tiles fully loaded - hiding loading screen immediately"),w.setIsLoading(!1),w.setViewerReady(!0)):(console.log("[viewerSetup] Waiting for tiles to fully load..."),S.addOnceHandler("fully-loaded-change",()=>{console.log("[viewerSetup] Tiles now fully loaded - hiding loading screen"),w.setIsLoading(!1),w.setViewerReady(!0)}),setTimeout(()=>{t.isLoading()&&(console.warn("[viewerSetup] Forcing loading screen hide after 2s wait"),w.setIsLoading(!1),w.setViewerReady(!0))},2e3)),u){console.log("[iOS] Tile protection will be handled by global patch");const O=d.canvas;O&&(O.addEventListener("click",()=>{O.blur(),console.log("[iOS Performance] Canvas focus cleared to prevent performance degradation")}),O.addEventListener("touchstart",()=>{O.blur()}))}}else console.error("[viewerSetup] No tiled image found!"),w.setIsLoading(!1),w.setViewerReady(!0)}catch(S){console.error("[viewerSetup] Error in open handler:",S),w.setIsLoading(!1),w.setViewerReady(!0)}}),d.addHandler("open-failed",S=>{console.error("OpenSeadragon open-failed event:",S),t.setIsLoading(!1)}),d.addHandler("tile-load-failed",S=>{console.error("Tile load failed:",S.tile,S.message)}),d.drawer&&(d.drawer.imageSmoothingEnabled=!0,d.drawer.context&&(d.drawer.context.imageSmoothingEnabled=!0,d.drawer.context.webkitImageSmoothingEnabled=!0,d.drawer.context.mozImageSmoothingEnabled=!0,d.drawer.context.msImageSmoothingEnabled=!0)),d.canvas&&(d.canvas.style.imageRendering="pixelated",d.canvas.style.imageRendering="crisp-edges",d.canvas.style.imageRendering="-webkit-optimize-contrast",console.log("[Mobile Performance] Applied pixelated rendering for monochrome art"));const f=new Pe(d);f.initialize(),console.log("[Mobile Performance] NetworkAdaptiveManager initialized and enabled");const v={networkAdaptiveManager:f,spatialIndex:new Le,viewportManager:new We(d),audioEngine:new Se,performanceMonitor:new Ie(d),renderOptimizer:new Fe(d),tileOptimizer:new He(d),memoryManager:new xe(d),tileCleanupManager:new Oe(d),imageOverlayManager:new _e,overlayManager:me.createWithOverride(d),lowZoomOptimizer:new be(d,l),safariPerformanceOptimizer:new Ee(d),frameSkipManager:new Ge(d,l),mouseWheelSmoothing:new Ae(d,(te=N().enableMouseWheelSmoothing)!=null&&te.value?{throttleMs:((ie=N().wheelEventThrottleMs)==null?void 0:ie.value)||16,zoomStep:((se=N().wheelZoomStep)==null?void 0:se.value)||.02,enabled:((re=N().enableMouseWheelSmoothing)==null?void 0:re.value)!==!1}:{enabled:!1})};l&&(V.viewer=d,V.onPerformanceReport=S=>{t.setPerformanceStatus&&t.setPerformanceStatus({fps:S.metrics.fps.current,quality:S.quality.currentQuality,thermal:S.thermal.state})},V.onPerformanceWarning=S=>{console.warn("[Performance Warning]",S)},setTimeout(()=>{V.start(),console.log("[Mobile Performance] Unified monitoring system started")},2e3),v.unifiedPerformanceMonitor=V),v.tileOptimizer.state.isActive=!1,setTimeout(()=>{v.tileOptimizer.state.isActive=!0},1e3);const T=new $e(d,v);v.cinematicZoomManager=T;const _=new Qe(d);v.predictiveTileLoader=_;const x=new Ne(d);v.vignetteOverlay=x;const A=new Ue(d);if(v.immediateZoomHandler=A,at(d).then(S=>{v.adaptiveFormatSource=S,console.log("[Mobile Performance] Adaptive image formats initialized")}).catch(S=>{console.warn("[Mobile Performance] Failed to initialize adaptive formats:",S)}),v.tileCache=pe,console.log("[Mobile Performance] IndexedDB tile cache initialized (200MB limit)"),window.cinematicZoomManager=T,window.predictiveTileLoader=_,window.vignetteOverlay=x,window.immediateZoomHandler=A,t.debugLevel()>=1&&T.enableDebug(),t.setComponents(v),window.performanceMetrics=t.performanceMetrics,console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!v.overlayManager),console.log("Does it have initialize method?",typeof((oe=v.overlayManager)==null?void 0:oe.initialize)),v.overlayManager.initialize(),v.overlayManager.constructor.name==="Canvas2DOverlayManager"&&v.overlayManager.setAutoDeselectThreshold&&t.autoDeselectThreshold){const S=t.autoDeselectThreshold();v.overlayManager.setAutoDeselectThreshold(S),console.log("Set auto-deselect threshold on Canvas2D manager:",S)}console.log("Overlay manager initialized"),console.log("Is initialized flag:",(ne=v.overlayManager)==null?void 0:ne.isInitialized),console.log("Overlay element created?",!!((ae=v.overlayManager)!=null&&ae.overlayElement));const M=me.getCurrentType();M&&M!==t.currentOverlayType()&&(console.log("Updating overlay type signal to match actual:",M),t.setCurrentOverlayType(M)),window.overlayManager=v.overlayManager,console.log("Overlay manager set on window:",(le=window.overlayManager)==null?void 0:le.constructor.name),window.audioEngine=v.audioEngine,v.audioEngine.onPlaybackEnd=S=>{console.log(`Finished playing audio for hotspot ${S}`)};const C=await Ke();v.spatialIndex.loadHotspots(C),v.imageOverlayManager.loadHotspots(C),window.viewer=d,window.performanceMonitor=v.performanceMonitor,window.tileOptimizer=v.tileOptimizer,window.tileCleanupManager=v.tileCleanupManager,window.lowZoomOptimizer=v.lowZoomOptimizer,window.safariPerformanceOptimizer=v.safariPerformanceOptimizer,window.frameSkipManager=v.frameSkipManager,window.networkAdaptiveManager=v.networkAdaptiveManager,window.performanceConfig=y,window.iosMemoryManager=v.iosMemoryManager,ht(d),Te(d,y),setTimeout(()=>{var I;const S=(I=d.drawer)!=null&&I.getType?d.drawer.getType():"unknown";console.log("RESEARCH VERIFICATION: Actual drawer in use:",S),(l||c||u)&&S!=="canvas"?console.error("CRITICAL: Canvas drawer not applied! Performance will be poor."):(l||c||u)&&S==="canvas"&&console.log("SUCCESS: Canvas drawer confirmed for mobile/Safari - performance should be optimal")},100),v.performanceMonitor.start(),v.memoryManager.start(),v.tileOptimizer.start(),v.tileCleanupManager.start(),v.lowZoomOptimizer.enable(),u&&(console.log("===== iOS CRITICAL CONFIGURATION ====="),console.log("Drawer type:",(ce=d.drawer)!=null&&ce.getType?d.drawer.getType():"unknown"),console.log("Max image cache count:",d.maxImageCacheCount),console.log("Smooth tile edges min zoom:",d.smoothTileEdgesMinZoom),console.log("====================================="),window.addEventListener("tilecorruption:reload",S=>{console.error("Tile corruption reload requested",S.detail),window.confirm("The image viewer has encountered an error. Would you like to reload?")&&window.location.reload()}));let b=!1,E=0;const k=2e3;d.addHandler("animation",()=>{b=!0,E=Date.now()}),d.addHandler("animation-finish",()=>{setTimeout(()=>{Date.now()-E>=k&&(b=!1)},k)});const D=setInterval(()=>{var S;if(v.performanceMonitor&&v.performanceMonitor.isMonitoring){const I=v.performanceMonitor.getMetrics();t.setPerformanceMetrics(I);const he=d.viewport.getZoom()>=1.8;if(he&&!t.showExpandButton()?(t.setExpandButtonFading(!1),t.setShowExpandButton(!0)):!he&&t.showExpandButton()&&!t.expandButtonFading()&&(t.setExpandButtonFading(!0),setTimeout(()=>{t.setShowExpandButton(!1),t.setExpandButtonFading(!1)},300)),window.nativeHotspotRenderer&&typeof window.nativeHotspotRenderer.getPerformanceMetrics=="function")try{const Q=window.nativeHotspotRenderer.getPerformanceMetrics();Q&&window.nativeHotspotRenderer.constructor.name==="WebGLHotspotRenderer"&&t.setSafariHybridMetrics(Q)}catch(Q){console.error("Error getting WebGL metrics:",Q)}else((S=window.nativeHotspotRenderer)==null?void 0:S.constructor.name)!=="WebGLHotspotRenderer"&&t.setSafariHybridMetrics(null);v.lowZoomOptimizer&&I.averageFPS>0&&v.lowZoomOptimizer.monitorPerformance(I.averageFPS),v.safariPerformanceOptimizer&&I.averageFPS>0&&v.safariPerformanceOptimizer.updatePerformanceMetrics(I.averageFPS,b),b&&I.averageFPS<30}},500);r.performanceUpdate=D,v.performanceMonitor.disableDebugOverlay(),d.viewport.centerSpringX.animationTime=y.viewer.animationTime,d.viewport.centerSpringY.animationTime=y.viewer.animationTime,d.viewport.zoomSpring.animationTime=y.viewer.animationTime,d.viewport.centerSpringX.springStiffness=y.viewer.springStiffness,d.viewport.centerSpringY.springStiffness=y.viewer.springStiffness,d.viewport.zoomSpring.springStiffness=y.viewer.springStiffness;const R=await U(()=>import("./viewerEventHandlers-CnqD_1Bt.js"),__vite__mapDeps([0,1,2]));R.setupViewerEventHandlers(d,t,v,i,C),R.setupAdaptiveSprings(d,y);const z=R.setupKeyboardHandler(d,t,v);return r.handleKeyPress=z,R.setupResizeObserver(m,d,t),console.log("[viewerSetup] All handlers attached, now opening viewer with tileSources:",g),d.open(g),setTimeout(()=>{console.log("[viewerSetup] Forcing initial redraw to ensure clean state"),d.forceRedraw(),d.viewport.centerSpringX.resetTo(d.viewport.centerSpringX.target.value),d.viewport.centerSpringY.resetTo(d.viewport.centerSpringY.target.value),d.viewport.zoomSpring.resetTo(d.viewport.zoomSpring.target.value),d.forceRedraw()},500),console.log("Returning from initializeViewer:",{viewer:!!d,intervals:!!r,homeViewport:!!n}),{viewer:d,intervals:r,homeViewport:n}}function ht(m){window.forceSmoothingOn=function(){if(console.log(" FORCING SMOOTHING ON"),m&&m.drawer){if(m.drawer.imageSmoothingEnabled=!0,m.drawer.context){const e=m.drawer.context;e.imageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.msImageSmoothingEnabled=!0,console.log(" Canvas context smoothing enabled")}m.canvas&&(m.canvas.style.imageRendering="auto",console.log(" CSS rendering set to auto")),m.forceRedraw(),console.log(" Forced redraw with smoothing enabled"),m.drawer.context&&console.log("Current imageSmoothingEnabled:",m.drawer.context.imageSmoothingEnabled)}else console.error(" Viewer or drawer not available")},window.checkSmoothingState=function(){console.group(" SMOOTHING STATE DIAGNOSTIC"),m&&m.drawer?(console.log("Drawer type:",m.drawer.getType?m.drawer.getType():"unknown"),console.log("Drawer imageSmoothingEnabled:",m.drawer.imageSmoothingEnabled),m.drawer.context?(console.log("Context imageSmoothingEnabled:",m.drawer.context.imageSmoothingEnabled),console.log("Context webkitImageSmoothingEnabled:",m.drawer.context.webkitImageSmoothingEnabled),console.log("Context mozImageSmoothingEnabled:",m.drawer.context.mozImageSmoothingEnabled),console.log("Context msImageSmoothingEnabled:",m.drawer.context.msImageSmoothingEnabled)):console.warn("No context available"),m.canvas&&console.log("Canvas style.imageRendering:",m.canvas.style.imageRendering),console.log(`
Configuration:`),console.log("imageSmoothingEnabled config:",m.imageSmoothingEnabled),console.log("smoothTileEdgesMinZoom:",m.smoothTileEdgesMinZoom),console.log("blendTime:",m.blendTime),console.log("alwaysBlend:",m.alwaysBlend),console.log("immediateRender:",m.immediateRender)):console.error("Viewer or drawer not available"),console.groupEnd()},window.toggleTileCascadeFix=function(e){e?(console.log(" Enabling TileCascadeFix..."),X(P),console.log(" TileCascadeFix enabled - single tile level (may cause zoom artifacts)")):(console.log(" Disabling TileCascadeFix..."),de(P),console.log(" TileCascadeFix disabled - smooth blending enabled")),m.forceRedraw()},window.applyBalancedSmoothingConfig=function(){console.group(" APPLYING BALANCED SMOOTHING CONFIG"),console.log("1 Ensuring image smoothing is enabled..."),window.forceSmoothingOn(),console.log("2 Disabling TileCascadeFix for smooth zoom..."),window.toggleTileCascadeFix(!1),console.log("3 Checking blend time..."),m&&console.log("Current blendTime:",m.blendTime||.5),console.log("4 Verifying smoothing state..."),window.checkSmoothingState(),console.log(`
 BALANCED CONFIG APPLIED!`),console.log(" Smooth rendering with tile blending enabled"),console.log(" Test by zooming in/out"),console.log(" If artifacts persist, try toggleTileCascadeFix(true)"),console.groupEnd()},window.getCinematicZoomDiagnostics=function(){return window.cinematicZoomManager?window.cinematicZoomManager.getDiagnostics():(console.error("CinematicZoomManager not initialized"),null)},window.fixFlickering=function(){console.log("Applying manual flickering fix..."),Je(m),de(P),setTimeout(()=>{X(P),m.forceRedraw(),console.log("Flickering fix applied")},100)},window.testSafariOptimizer=function(){if(!window.safariPerformanceOptimizer){console.error("SafariPerformanceOptimizer not initialized");return}const e=window.safariPerformanceOptimizer;console.group(" SAFARI PERFORMANCE OPTIMIZER TEST");const t=e.getState();console.table(t),console.log(`
 Testing dynamic resolution scaling...`),console.log("1 Forcing optimization ON"),e.forceOptimization(!0),setTimeout(()=>{console.log("Current pixel ratio:",m.viewport.getPixelRatio()),console.log("Expected:",t.basePixelRatio*e.scalingFactor),console.log(`
2 Forcing optimization OFF`),e.forceOptimization(!1),setTimeout(()=>{console.log("Current pixel ratio:",m.viewport.getPixelRatio()),console.log("Expected:",t.basePixelRatio),console.log(`
 Test complete! Try zooming/panning to see dynamic scaling.`),console.groupEnd()},500)},100)},window.getSafariOptimizerState=function(){return window.safariPerformanceOptimizer?window.safariPerformanceOptimizer.getState():(console.error("SafariPerformanceOptimizer not initialized"),null)}}const ft=Object.freeze(Object.defineProperty({__proto__:null,initializeViewer:ct},Symbol.toStringTag,{value:"Module"}));export{gt as a,ut as c,Z as o,y as p,ft as v};
