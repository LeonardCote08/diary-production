const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/viewerEventHandlers-D91abJ9u.js","assets/main-B6HoTpYi.js","assets/main-Bg1TiEVQ.css"])))=>i.map(i=>d[i]);
var ae=Object.defineProperty;var le=(c,e,t)=>e in c?ae(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var j=(c,e,t)=>le(c,typeof e!="symbol"?e+"":e,t);import{c as B,O as P,i as ce,g as de,a as J,b as G,d as ne,e as he,_ as me,r as oe}from"./main-B6HoTpYi.js";var O={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(c){(function(){var e=function(){this.init()};e.prototype={init:function(){var i=this||t;return i._counter=1e3,i._html5AudioPool=[],i.html5PoolSize=10,i._codecs={},i._howls=[],i._muted=!1,i._volume=1,i._canPlayEvent="canplaythrough",i._navigator=typeof window<"u"&&window.navigator?window.navigator:null,i.masterGain=null,i.noAudio=!1,i.usingWebAudio=!0,i.autoSuspend=!0,i.ctx=null,i.autoUnlock=!0,i._setup(),i},volume:function(i){var r=this||t;if(i=parseFloat(i),r.ctx||v(),typeof i<"u"&&i>=0&&i<=1){if(r._volume=i,r._muted)return r;r.usingWebAudio&&r.masterGain.gain.setValueAtTime(i,t.ctx.currentTime);for(var a=0;a<r._howls.length;a++)if(!r._howls[a]._webAudio)for(var d=r._howls[a]._getSoundIds(),f=0;f<d.length;f++){var u=r._howls[a]._soundById(d[f]);u&&u._node&&(u._node.volume=u._volume*i)}return r}return r._volume},mute:function(i){var r=this||t;r.ctx||v(),r._muted=i,r.usingWebAudio&&r.masterGain.gain.setValueAtTime(i?0:r._volume,t.ctx.currentTime);for(var a=0;a<r._howls.length;a++)if(!r._howls[a]._webAudio)for(var d=r._howls[a]._getSoundIds(),f=0;f<d.length;f++){var u=r._howls[a]._soundById(d[f]);u&&u._node&&(u._node.muted=i?!0:u._muted)}return r},stop:function(){for(var i=this||t,r=0;r<i._howls.length;r++)i._howls[r].stop();return i},unload:function(){for(var i=this||t,r=i._howls.length-1;r>=0;r--)i._howls[r].unload();return i.usingWebAudio&&i.ctx&&typeof i.ctx.close<"u"&&(i.ctx.close(),i.ctx=null,v()),i},codecs:function(i){return(this||t)._codecs[i.replace(/^x-/,"")]},_setup:function(){var i=this||t;if(i.state=i.ctx&&i.ctx.state||"suspended",i._autoSuspend(),!i.usingWebAudio)if(typeof Audio<"u")try{var r=new Audio;typeof r.oncanplaythrough>"u"&&(i._canPlayEvent="canplay")}catch{i.noAudio=!0}else i.noAudio=!0;try{var r=new Audio;r.muted&&(i.noAudio=!0)}catch{}return i.noAudio||i._setupCodecs(),i},_setupCodecs:function(){var i=this||t,r=null;try{r=typeof Audio<"u"?new Audio:null}catch{return i}if(!r||typeof r.canPlayType!="function")return i;var a=r.canPlayType("audio/mpeg;").replace(/^no$/,""),d=i._navigator?i._navigator.userAgent:"",f=d.match(/OPR\/(\d+)/g),u=f&&parseInt(f[0].split("/")[1],10)<33,g=d.indexOf("Safari")!==-1&&d.indexOf("Chrome")===-1,w=d.match(/Version\/(.*?) /),y=g&&w&&parseInt(w[1],10)<15;return i._codecs={mp3:!!(!u&&(a||r.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!a,opus:!!r.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(r.canPlayType('audio/wav; codecs="1"')||r.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!r.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!r.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(r.canPlayType("audio/x-m4a;")||r.canPlayType("audio/m4a;")||r.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(r.canPlayType("audio/x-m4b;")||r.canPlayType("audio/m4b;")||r.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(r.canPlayType("audio/x-mp4;")||r.canPlayType("audio/mp4;")||r.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!y&&r.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!y&&r.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!r.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(r.canPlayType("audio/x-flac;")||r.canPlayType("audio/flac;")).replace(/^no$/,"")},i},_unlockAudio:function(){var i=this||t;if(!(i._audioUnlocked||!i.ctx)){i._audioUnlocked=!1,i.autoUnlock=!1,!i._mobileUnloaded&&i.ctx.sampleRate!==44100&&(i._mobileUnloaded=!0,i.unload()),i._scratchBuffer=i.ctx.createBuffer(1,1,22050);var r=function(a){for(;i._html5AudioPool.length<i.html5PoolSize;)try{var d=new Audio;d._unlocked=!0,i._releaseHtml5Audio(d)}catch{i.noAudio=!0;break}for(var f=0;f<i._howls.length;f++)if(!i._howls[f]._webAudio)for(var u=i._howls[f]._getSoundIds(),g=0;g<u.length;g++){var w=i._howls[f]._soundById(u[g]);w&&w._node&&!w._node._unlocked&&(w._node._unlocked=!0,w._node.load())}i._autoResume();var y=i.ctx.createBufferSource();y.buffer=i._scratchBuffer,y.connect(i.ctx.destination),typeof y.start>"u"?y.noteOn(0):y.start(0),typeof i.ctx.resume=="function"&&i.ctx.resume(),y.onended=function(){y.disconnect(0),i._audioUnlocked=!0,document.removeEventListener("touchstart",r,!0),document.removeEventListener("touchend",r,!0),document.removeEventListener("click",r,!0),document.removeEventListener("keydown",r,!0);for(var T=0;T<i._howls.length;T++)i._howls[T]._emit("unlock")}};return document.addEventListener("touchstart",r,!0),document.addEventListener("touchend",r,!0),document.addEventListener("click",r,!0),document.addEventListener("keydown",r,!0),i}},_obtainHtml5Audio:function(){var i=this||t;if(i._html5AudioPool.length)return i._html5AudioPool.pop();var r=new Audio().play();return r&&typeof Promise<"u"&&(r instanceof Promise||typeof r.then=="function")&&r.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(i){var r=this||t;return i._unlocked&&r._html5AudioPool.push(i),r},_autoSuspend:function(){var i=this;if(!(!i.autoSuspend||!i.ctx||typeof i.ctx.suspend>"u"||!t.usingWebAudio)){for(var r=0;r<i._howls.length;r++)if(i._howls[r]._webAudio){for(var a=0;a<i._howls[r]._sounds.length;a++)if(!i._howls[r]._sounds[a]._paused)return i}return i._suspendTimer&&clearTimeout(i._suspendTimer),i._suspendTimer=setTimeout(function(){if(i.autoSuspend){i._suspendTimer=null,i.state="suspending";var d=function(){i.state="suspended",i._resumeAfterSuspend&&(delete i._resumeAfterSuspend,i._autoResume())};i.ctx.suspend().then(d,d)}},3e4),i}},_autoResume:function(){var i=this;if(!(!i.ctx||typeof i.ctx.resume>"u"||!t.usingWebAudio))return i.state==="running"&&i.ctx.state!=="interrupted"&&i._suspendTimer?(clearTimeout(i._suspendTimer),i._suspendTimer=null):i.state==="suspended"||i.state==="running"&&i.ctx.state==="interrupted"?(i.ctx.resume().then(function(){i.state="running";for(var r=0;r<i._howls.length;r++)i._howls[r]._emit("resume")}),i._suspendTimer&&(clearTimeout(i._suspendTimer),i._suspendTimer=null)):i.state==="suspending"&&(i._resumeAfterSuspend=!0),i}};var t=new e,n=function(i){var r=this;if(!i.src||i.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}r.init(i)};n.prototype={init:function(i){var r=this;return t.ctx||v(),r._autoplay=i.autoplay||!1,r._format=typeof i.format!="string"?i.format:[i.format],r._html5=i.html5||!1,r._muted=i.mute||!1,r._loop=i.loop||!1,r._pool=i.pool||5,r._preload=typeof i.preload=="boolean"||i.preload==="metadata"?i.preload:!0,r._rate=i.rate||1,r._sprite=i.sprite||{},r._src=typeof i.src!="string"?i.src:[i.src],r._volume=i.volume!==void 0?i.volume:1,r._xhr={method:i.xhr&&i.xhr.method?i.xhr.method:"GET",headers:i.xhr&&i.xhr.headers?i.xhr.headers:null,withCredentials:i.xhr&&i.xhr.withCredentials?i.xhr.withCredentials:!1},r._duration=0,r._state="unloaded",r._sounds=[],r._endTimers={},r._queue=[],r._playLock=!1,r._onend=i.onend?[{fn:i.onend}]:[],r._onfade=i.onfade?[{fn:i.onfade}]:[],r._onload=i.onload?[{fn:i.onload}]:[],r._onloaderror=i.onloaderror?[{fn:i.onloaderror}]:[],r._onplayerror=i.onplayerror?[{fn:i.onplayerror}]:[],r._onpause=i.onpause?[{fn:i.onpause}]:[],r._onplay=i.onplay?[{fn:i.onplay}]:[],r._onstop=i.onstop?[{fn:i.onstop}]:[],r._onmute=i.onmute?[{fn:i.onmute}]:[],r._onvolume=i.onvolume?[{fn:i.onvolume}]:[],r._onrate=i.onrate?[{fn:i.onrate}]:[],r._onseek=i.onseek?[{fn:i.onseek}]:[],r._onunlock=i.onunlock?[{fn:i.onunlock}]:[],r._onresume=[],r._webAudio=t.usingWebAudio&&!r._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(r),r._autoplay&&r._queue.push({event:"play",action:function(){r.play()}}),r._preload&&r._preload!=="none"&&r.load(),r},load:function(){var i=this,r=null;if(t.noAudio){i._emit("loaderror",null,"No audio support.");return}typeof i._src=="string"&&(i._src=[i._src]);for(var a=0;a<i._src.length;a++){var d,f;if(i._format&&i._format[a])d=i._format[a];else{if(f=i._src[a],typeof f!="string"){i._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}d=/^data:audio\/([^;,]+);/i.exec(f),d||(d=/\.([^.]+)$/.exec(f.split("?",1)[0])),d&&(d=d[1].toLowerCase())}if(d||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),d&&t.codecs(d)){r=i._src[a];break}}if(!r){i._emit("loaderror",null,"No codec support for selected audio sources.");return}return i._src=r,i._state="loading",window.location.protocol==="https:"&&r.slice(0,5)==="http:"&&(i._html5=!0,i._webAudio=!1),new o(i),i._webAudio&&l(i),i},play:function(i,r){var a=this,d=null;if(typeof i=="number")d=i,i=null;else{if(typeof i=="string"&&a._state==="loaded"&&!a._sprite[i])return null;if(typeof i>"u"&&(i="__default",!a._playLock)){for(var f=0,u=0;u<a._sounds.length;u++)a._sounds[u]._paused&&!a._sounds[u]._ended&&(f++,d=a._sounds[u]._id);f===1?i=null:d=null}}var g=d?a._soundById(d):a._inactiveSound();if(!g)return null;if(d&&!i&&(i=g._sprite||"__default"),a._state!=="loaded"){g._sprite=i,g._ended=!1;var w=g._id;return a._queue.push({event:"play",action:function(){a.play(w)}}),w}if(d&&!g._paused)return r||a._loadQueue("play"),g._id;a._webAudio&&t._autoResume();var y=Math.max(0,g._seek>0?g._seek:a._sprite[i][0]/1e3),T=Math.max(0,(a._sprite[i][0]+a._sprite[i][1])/1e3-y),b=T*1e3/Math.abs(g._rate),A=a._sprite[i][0]/1e3,C=(a._sprite[i][0]+a._sprite[i][1])/1e3;g._sprite=i,g._ended=!1;var M=function(){g._paused=!1,g._seek=y,g._start=A,g._stop=C,g._loop=!!(g._loop||a._sprite[i][2])};if(y>=C){a._ended(g);return}var S=g._node;if(a._webAudio){var E=function(){a._playLock=!1,M(),a._refreshBuffer(g);var z=g._muted||a._muted?0:g._volume;S.gain.setValueAtTime(z,t.ctx.currentTime),g._playStart=t.ctx.currentTime,typeof S.bufferSource.start>"u"?g._loop?S.bufferSource.noteGrainOn(0,y,86400):S.bufferSource.noteGrainOn(0,y,T):g._loop?S.bufferSource.start(0,y,86400):S.bufferSource.start(0,y,T),b!==1/0&&(a._endTimers[g._id]=setTimeout(a._ended.bind(a,g),b)),r||setTimeout(function(){a._emit("play",g._id),a._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?E():(a._playLock=!0,a.once("resume",E),a._clearTimer(g._id))}else{var L=function(){S.currentTime=y,S.muted=g._muted||a._muted||t._muted||S.muted,S.volume=g._volume*t.volume(),S.playbackRate=g._rate;try{var z=S.play();if(z&&typeof Promise<"u"&&(z instanceof Promise||typeof z.then=="function")?(a._playLock=!0,M(),z.then(function(){a._playLock=!1,S._unlocked=!0,r?a._loadQueue():a._emit("play",g._id)}).catch(function(){a._playLock=!1,a._emit("playerror",g._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),g._ended=!0,g._paused=!0})):r||(a._playLock=!1,M(),a._emit("play",g._id)),S.playbackRate=g._rate,S.paused){a._emit("playerror",g._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}i!=="__default"||g._loop?a._endTimers[g._id]=setTimeout(a._ended.bind(a,g),b):(a._endTimers[g._id]=function(){a._ended(g),S.removeEventListener("ended",a._endTimers[g._id],!1)},S.addEventListener("ended",a._endTimers[g._id],!1))}catch(W){a._emit("playerror",g._id,W)}};S.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(S.src=a._src,S.load());var R=window&&window.ejecta||!S.readyState&&t._navigator.isCocoonJS;if(S.readyState>=3||R)L();else{a._playLock=!0,a._state="loading";var Z=function(){a._state="loaded",L(),S.removeEventListener(t._canPlayEvent,Z,!1)};S.addEventListener(t._canPlayEvent,Z,!1),a._clearTimer(g._id)}}return g._id},pause:function(i){var r=this;if(r._state!=="loaded"||r._playLock)return r._queue.push({event:"pause",action:function(){r.pause(i)}}),r;for(var a=r._getSoundIds(i),d=0;d<a.length;d++){r._clearTimer(a[d]);var f=r._soundById(a[d]);if(f&&!f._paused&&(f._seek=r.seek(a[d]),f._rateSeek=0,f._paused=!0,r._stopFade(a[d]),f._node))if(r._webAudio){if(!f._node.bufferSource)continue;typeof f._node.bufferSource.stop>"u"?f._node.bufferSource.noteOff(0):f._node.bufferSource.stop(0),r._cleanBuffer(f._node)}else(!isNaN(f._node.duration)||f._node.duration===1/0)&&f._node.pause();arguments[1]||r._emit("pause",f?f._id:null)}return r},stop:function(i,r){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"stop",action:function(){a.stop(i)}}),a;for(var d=a._getSoundIds(i),f=0;f<d.length;f++){a._clearTimer(d[f]);var u=a._soundById(d[f]);u&&(u._seek=u._start||0,u._rateSeek=0,u._paused=!0,u._ended=!0,a._stopFade(d[f]),u._node&&(a._webAudio?u._node.bufferSource&&(typeof u._node.bufferSource.stop>"u"?u._node.bufferSource.noteOff(0):u._node.bufferSource.stop(0),a._cleanBuffer(u._node)):(!isNaN(u._node.duration)||u._node.duration===1/0)&&(u._node.currentTime=u._start||0,u._node.pause(),u._node.duration===1/0&&a._clearSound(u._node))),r||a._emit("stop",u._id))}return a},mute:function(i,r){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"mute",action:function(){a.mute(i,r)}}),a;if(typeof r>"u")if(typeof i=="boolean")a._muted=i;else return a._muted;for(var d=a._getSoundIds(r),f=0;f<d.length;f++){var u=a._soundById(d[f]);u&&(u._muted=i,u._interval&&a._stopFade(u._id),a._webAudio&&u._node?u._node.gain.setValueAtTime(i?0:u._volume,t.ctx.currentTime):u._node&&(u._node.muted=t._muted?!0:i),a._emit("mute",u._id))}return a},volume:function(){var i=this,r=arguments,a,d;if(r.length===0)return i._volume;if(r.length===1||r.length===2&&typeof r[1]>"u"){var f=i._getSoundIds(),u=f.indexOf(r[0]);u>=0?d=parseInt(r[0],10):a=parseFloat(r[0])}else r.length>=2&&(a=parseFloat(r[0]),d=parseInt(r[1],10));var g;if(typeof a<"u"&&a>=0&&a<=1){if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"volume",action:function(){i.volume.apply(i,r)}}),i;typeof d>"u"&&(i._volume=a),d=i._getSoundIds(d);for(var w=0;w<d.length;w++)g=i._soundById(d[w]),g&&(g._volume=a,r[2]||i._stopFade(d[w]),i._webAudio&&g._node&&!g._muted?g._node.gain.setValueAtTime(a,t.ctx.currentTime):g._node&&!g._muted&&(g._node.volume=a*t.volume()),i._emit("volume",g._id))}else return g=d?i._soundById(d):i._sounds[0],g?g._volume:0;return i},fade:function(i,r,a,d){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"fade",action:function(){f.fade(i,r,a,d)}}),f;i=Math.min(Math.max(0,parseFloat(i)),1),r=Math.min(Math.max(0,parseFloat(r)),1),a=parseFloat(a),f.volume(i,d);for(var u=f._getSoundIds(d),g=0;g<u.length;g++){var w=f._soundById(u[g]);if(w){if(d||f._stopFade(u[g]),f._webAudio&&!w._muted){var y=t.ctx.currentTime,T=y+a/1e3;w._volume=i,w._node.gain.setValueAtTime(i,y),w._node.gain.linearRampToValueAtTime(r,T)}f._startFadeInterval(w,i,r,a,u[g],typeof d>"u")}}return f},_startFadeInterval:function(i,r,a,d,f,u){var g=this,w=r,y=a-r,T=Math.abs(y/.01),b=Math.max(4,T>0?d/T:d),A=Date.now();i._fadeTo=a,i._interval=setInterval(function(){var C=(Date.now()-A)/d;A=Date.now(),w+=y*C,w=Math.round(w*100)/100,y<0?w=Math.max(a,w):w=Math.min(a,w),g._webAudio?i._volume=w:g.volume(w,i._id,!0),u&&(g._volume=w),(a<r&&w<=a||a>r&&w>=a)&&(clearInterval(i._interval),i._interval=null,i._fadeTo=null,g.volume(a,i._id),g._emit("fade",i._id))},b)},_stopFade:function(i){var r=this,a=r._soundById(i);return a&&a._interval&&(r._webAudio&&a._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(a._interval),a._interval=null,r.volume(a._fadeTo,i),a._fadeTo=null,r._emit("fade",i)),r},loop:function(){var i=this,r=arguments,a,d,f;if(r.length===0)return i._loop;if(r.length===1)if(typeof r[0]=="boolean")a=r[0],i._loop=a;else return f=i._soundById(parseInt(r[0],10)),f?f._loop:!1;else r.length===2&&(a=r[0],d=parseInt(r[1],10));for(var u=i._getSoundIds(d),g=0;g<u.length;g++)f=i._soundById(u[g]),f&&(f._loop=a,i._webAudio&&f._node&&f._node.bufferSource&&(f._node.bufferSource.loop=a,a&&(f._node.bufferSource.loopStart=f._start||0,f._node.bufferSource.loopEnd=f._stop,i.playing(u[g])&&(i.pause(u[g],!0),i.play(u[g],!0)))));return i},rate:function(){var i=this,r=arguments,a,d;if(r.length===0)d=i._sounds[0]._id;else if(r.length===1){var f=i._getSoundIds(),u=f.indexOf(r[0]);u>=0?d=parseInt(r[0],10):a=parseFloat(r[0])}else r.length===2&&(a=parseFloat(r[0]),d=parseInt(r[1],10));var g;if(typeof a=="number"){if(i._state!=="loaded"||i._playLock)return i._queue.push({event:"rate",action:function(){i.rate.apply(i,r)}}),i;typeof d>"u"&&(i._rate=a),d=i._getSoundIds(d);for(var w=0;w<d.length;w++)if(g=i._soundById(d[w]),g){i.playing(d[w])&&(g._rateSeek=i.seek(d[w]),g._playStart=i._webAudio?t.ctx.currentTime:g._playStart),g._rate=a,i._webAudio&&g._node&&g._node.bufferSource?g._node.bufferSource.playbackRate.setValueAtTime(a,t.ctx.currentTime):g._node&&(g._node.playbackRate=a);var y=i.seek(d[w]),T=(i._sprite[g._sprite][0]+i._sprite[g._sprite][1])/1e3-y,b=T*1e3/Math.abs(g._rate);(i._endTimers[d[w]]||!g._paused)&&(i._clearTimer(d[w]),i._endTimers[d[w]]=setTimeout(i._ended.bind(i,g),b)),i._emit("rate",g._id)}}else return g=i._soundById(d),g?g._rate:i._rate;return i},seek:function(){var i=this,r=arguments,a,d;if(r.length===0)i._sounds.length&&(d=i._sounds[0]._id);else if(r.length===1){var f=i._getSoundIds(),u=f.indexOf(r[0]);u>=0?d=parseInt(r[0],10):i._sounds.length&&(d=i._sounds[0]._id,a=parseFloat(r[0]))}else r.length===2&&(a=parseFloat(r[0]),d=parseInt(r[1],10));if(typeof d>"u")return 0;if(typeof a=="number"&&(i._state!=="loaded"||i._playLock))return i._queue.push({event:"seek",action:function(){i.seek.apply(i,r)}}),i;var g=i._soundById(d);if(g)if(typeof a=="number"&&a>=0){var w=i.playing(d);w&&i.pause(d,!0),g._seek=a,g._ended=!1,i._clearTimer(d),!i._webAudio&&g._node&&!isNaN(g._node.duration)&&(g._node.currentTime=a);var y=function(){w&&i.play(d,!0),i._emit("seek",d)};if(w&&!i._webAudio){var T=function(){i._playLock?setTimeout(T,0):y()};setTimeout(T,0)}else y()}else if(i._webAudio){var b=i.playing(d)?t.ctx.currentTime-g._playStart:0,A=g._rateSeek?g._rateSeek-g._seek:0;return g._seek+(A+b*Math.abs(g._rate))}else return g._node.currentTime;return i},playing:function(i){var r=this;if(typeof i=="number"){var a=r._soundById(i);return a?!a._paused:!1}for(var d=0;d<r._sounds.length;d++)if(!r._sounds[d]._paused)return!0;return!1},duration:function(i){var r=this,a=r._duration,d=r._soundById(i);return d&&(a=r._sprite[d._sprite][1]/1e3),a},state:function(){return this._state},unload:function(){for(var i=this,r=i._sounds,a=0;a<r.length;a++)r[a]._paused||i.stop(r[a]._id),i._webAudio||(i._clearSound(r[a]._node),r[a]._node.removeEventListener("error",r[a]._errorFn,!1),r[a]._node.removeEventListener(t._canPlayEvent,r[a]._loadFn,!1),r[a]._node.removeEventListener("ended",r[a]._endFn,!1),t._releaseHtml5Audio(r[a]._node)),delete r[a]._node,i._clearTimer(r[a]._id);var d=t._howls.indexOf(i);d>=0&&t._howls.splice(d,1);var f=!0;for(a=0;a<t._howls.length;a++)if(t._howls[a]._src===i._src||i._src.indexOf(t._howls[a]._src)>=0){f=!1;break}return s&&f&&delete s[i._src],t.noAudio=!1,i._state="unloaded",i._sounds=[],i=null,null},on:function(i,r,a,d){var f=this,u=f["_on"+i];return typeof r=="function"&&u.push(d?{id:a,fn:r,once:d}:{id:a,fn:r}),f},off:function(i,r,a){var d=this,f=d["_on"+i],u=0;if(typeof r=="number"&&(a=r,r=null),r||a)for(u=0;u<f.length;u++){var g=a===f[u].id;if(r===f[u].fn&&g||!r&&g){f.splice(u,1);break}}else if(i)d["_on"+i]=[];else{var w=Object.keys(d);for(u=0;u<w.length;u++)w[u].indexOf("_on")===0&&Array.isArray(d[w[u]])&&(d[w[u]]=[])}return d},once:function(i,r,a){var d=this;return d.on(i,r,a,1),d},_emit:function(i,r,a){for(var d=this,f=d["_on"+i],u=f.length-1;u>=0;u--)(!f[u].id||f[u].id===r||i==="load")&&(setTimeout((function(g){g.call(this,r,a)}).bind(d,f[u].fn),0),f[u].once&&d.off(i,f[u].fn,f[u].id));return d._loadQueue(i),d},_loadQueue:function(i){var r=this;if(r._queue.length>0){var a=r._queue[0];a.event===i&&(r._queue.shift(),r._loadQueue()),i||a.action()}return r},_ended:function(i){var r=this,a=i._sprite;if(!r._webAudio&&i._node&&!i._node.paused&&!i._node.ended&&i._node.currentTime<i._stop)return setTimeout(r._ended.bind(r,i),100),r;var d=!!(i._loop||r._sprite[a][2]);if(r._emit("end",i._id),!r._webAudio&&d&&r.stop(i._id,!0).play(i._id),r._webAudio&&d){r._emit("play",i._id),i._seek=i._start||0,i._rateSeek=0,i._playStart=t.ctx.currentTime;var f=(i._stop-i._start)*1e3/Math.abs(i._rate);r._endTimers[i._id]=setTimeout(r._ended.bind(r,i),f)}return r._webAudio&&!d&&(i._paused=!0,i._ended=!0,i._seek=i._start||0,i._rateSeek=0,r._clearTimer(i._id),r._cleanBuffer(i._node),t._autoSuspend()),!r._webAudio&&!d&&r.stop(i._id,!0),r},_clearTimer:function(i){var r=this;if(r._endTimers[i]){if(typeof r._endTimers[i]!="function")clearTimeout(r._endTimers[i]);else{var a=r._soundById(i);a&&a._node&&a._node.removeEventListener("ended",r._endTimers[i],!1)}delete r._endTimers[i]}return r},_soundById:function(i){for(var r=this,a=0;a<r._sounds.length;a++)if(i===r._sounds[a]._id)return r._sounds[a];return null},_inactiveSound:function(){var i=this;i._drain();for(var r=0;r<i._sounds.length;r++)if(i._sounds[r]._ended)return i._sounds[r].reset();return new o(i)},_drain:function(){var i=this,r=i._pool,a=0,d=0;if(!(i._sounds.length<r)){for(d=0;d<i._sounds.length;d++)i._sounds[d]._ended&&a++;for(d=i._sounds.length-1;d>=0;d--){if(a<=r)return;i._sounds[d]._ended&&(i._webAudio&&i._sounds[d]._node&&i._sounds[d]._node.disconnect(0),i._sounds.splice(d,1),a--)}}},_getSoundIds:function(i){var r=this;if(typeof i>"u"){for(var a=[],d=0;d<r._sounds.length;d++)a.push(r._sounds[d]._id);return a}else return[i]},_refreshBuffer:function(i){var r=this;return i._node.bufferSource=t.ctx.createBufferSource(),i._node.bufferSource.buffer=s[r._src],i._panner?i._node.bufferSource.connect(i._panner):i._node.bufferSource.connect(i._node),i._node.bufferSource.loop=i._loop,i._loop&&(i._node.bufferSource.loopStart=i._start||0,i._node.bufferSource.loopEnd=i._stop||0),i._node.bufferSource.playbackRate.setValueAtTime(i._rate,t.ctx.currentTime),r},_cleanBuffer:function(i){var r=this,a=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!i.bufferSource)return r;if(t._scratchBuffer&&i.bufferSource&&(i.bufferSource.onended=null,i.bufferSource.disconnect(0),a))try{i.bufferSource.buffer=t._scratchBuffer}catch{}return i.bufferSource=null,r},_clearSound:function(i){var r=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);r||(i.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var o=function(i){this._parent=i,this.init()};o.prototype={init:function(){var i=this,r=i._parent;return i._muted=r._muted,i._loop=r._loop,i._volume=r._volume,i._rate=r._rate,i._seek=0,i._paused=!0,i._ended=!0,i._sprite="__default",i._id=++t._counter,r._sounds.push(i),i.create(),i},create:function(){var i=this,r=i._parent,a=t._muted||i._muted||i._parent._muted?0:i._volume;return r._webAudio?(i._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),i._node.gain.setValueAtTime(a,t.ctx.currentTime),i._node.paused=!0,i._node.connect(t.masterGain)):t.noAudio||(i._node=t._obtainHtml5Audio(),i._errorFn=i._errorListener.bind(i),i._node.addEventListener("error",i._errorFn,!1),i._loadFn=i._loadListener.bind(i),i._node.addEventListener(t._canPlayEvent,i._loadFn,!1),i._endFn=i._endListener.bind(i),i._node.addEventListener("ended",i._endFn,!1),i._node.src=r._src,i._node.preload=r._preload===!0?"auto":r._preload,i._node.volume=a*t.volume(),i._node.load()),i},reset:function(){var i=this,r=i._parent;return i._muted=r._muted,i._loop=r._loop,i._volume=r._volume,i._rate=r._rate,i._seek=0,i._rateSeek=0,i._paused=!0,i._ended=!0,i._sprite="__default",i._id=++t._counter,i},_errorListener:function(){var i=this;i._parent._emit("loaderror",i._id,i._node.error?i._node.error.code:0),i._node.removeEventListener("error",i._errorFn,!1)},_loadListener:function(){var i=this,r=i._parent;r._duration=Math.ceil(i._node.duration*10)/10,Object.keys(r._sprite).length===0&&(r._sprite={__default:[0,r._duration*1e3]}),r._state!=="loaded"&&(r._state="loaded",r._emit("load"),r._loadQueue()),i._node.removeEventListener(t._canPlayEvent,i._loadFn,!1)},_endListener:function(){var i=this,r=i._parent;r._duration===1/0&&(r._duration=Math.ceil(i._node.duration*10)/10,r._sprite.__default[1]===1/0&&(r._sprite.__default[1]=r._duration*1e3),r._ended(i)),i._node.removeEventListener("ended",i._endFn,!1)}};var s={},l=function(i){var r=i._src;if(s[r]){i._duration=s[r].duration,p(i);return}if(/^data:[^;]+;base64,/.test(r)){for(var a=atob(r.split(",")[1]),d=new Uint8Array(a.length),f=0;f<a.length;++f)d[f]=a.charCodeAt(f);m(d.buffer,i)}else{var u=new XMLHttpRequest;u.open(i._xhr.method,r,!0),u.withCredentials=i._xhr.withCredentials,u.responseType="arraybuffer",i._xhr.headers&&Object.keys(i._xhr.headers).forEach(function(g){u.setRequestHeader(g,i._xhr.headers[g])}),u.onload=function(){var g=(u.status+"")[0];if(g!=="0"&&g!=="2"&&g!=="3"){i._emit("loaderror",null,"Failed loading audio file with status: "+u.status+".");return}m(u.response,i)},u.onerror=function(){i._webAudio&&(i._html5=!0,i._webAudio=!1,i._sounds=[],delete s[r],i.load())},h(u)}},h=function(i){try{i.send()}catch{i.onerror()}},m=function(i,r){var a=function(){r._emit("loaderror",null,"Decoding audio data failed.")},d=function(f){f&&r._sounds.length>0?(s[r._src]=f,p(r,f)):a()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(i).then(d).catch(a):t.ctx.decodeAudioData(i,d,a)},p=function(i,r){r&&!i._duration&&(i._duration=r.duration),Object.keys(i._sprite).length===0&&(i._sprite={__default:[0,i._duration*1e3]}),i._state!=="loaded"&&(i._state="loaded",i._emit("load"),i._loadQueue())},v=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var i=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),r=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),a=r?parseInt(r[1],10):null;if(i&&a&&a<9){var d=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!d&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};c.Howler=t,c.Howl=n,typeof B<"u"?(B.HowlerGlobal=e,B.Howler=t,B.Howl=n,B.Sound=o):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=n,window.Sound=o)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var o=n._howls.length-1;o>=0;o--)n._howls[o].stereo(t);return n},HowlerGlobal.prototype.pos=function(t,n,o){var s=this;if(!s.ctx||!s.ctx.listener)return s;if(n=typeof n!="number"?s._pos[1]:n,o=typeof o!="number"?s._pos[2]:o,typeof t=="number")s._pos=[t,n,o],typeof s.ctx.listener.positionX<"u"?(s.ctx.listener.positionX.setTargetAtTime(s._pos[0],Howler.ctx.currentTime,.1),s.ctx.listener.positionY.setTargetAtTime(s._pos[1],Howler.ctx.currentTime,.1),s.ctx.listener.positionZ.setTargetAtTime(s._pos[2],Howler.ctx.currentTime,.1)):s.ctx.listener.setPosition(s._pos[0],s._pos[1],s._pos[2]);else return s._pos;return s},HowlerGlobal.prototype.orientation=function(t,n,o,s,l,h){var m=this;if(!m.ctx||!m.ctx.listener)return m;var p=m._orientation;if(n=typeof n!="number"?p[1]:n,o=typeof o!="number"?p[2]:o,s=typeof s!="number"?p[3]:s,l=typeof l!="number"?p[4]:l,h=typeof h!="number"?p[5]:h,typeof t=="number")m._orientation=[t,n,o,s,l,h],typeof m.ctx.listener.forwardX<"u"?(m.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),m.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),m.ctx.listener.forwardZ.setTargetAtTime(o,Howler.ctx.currentTime,.1),m.ctx.listener.upX.setTargetAtTime(s,Howler.ctx.currentTime,.1),m.ctx.listener.upY.setTargetAtTime(l,Howler.ctx.currentTime,.1),m.ctx.listener.upZ.setTargetAtTime(h,Howler.ctx.currentTime,.1)):m.ctx.listener.setOrientation(t,n,o,s,l,h);else return p;return m},Howl.prototype.init=function(t){return function(n){var o=this;return o._orientation=n.orientation||[1,0,0],o._stereo=n.stereo||null,o._pos=n.pos||null,o._pannerAttr={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:360,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:360,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:0,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:"inverse",maxDistance:typeof n.maxDistance<"u"?n.maxDistance:1e4,panningModel:typeof n.panningModel<"u"?n.panningModel:"HRTF",refDistance:typeof n.refDistance<"u"?n.refDistance:1,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:1},o._onstereo=n.onstereo?[{fn:n.onstereo}]:[],o._onpos=n.onpos?[{fn:n.onpos}]:[],o._onorientation=n.onorientation?[{fn:n.onorientation}]:[],t.call(this,n)}}(Howl.prototype.init),Howl.prototype.stereo=function(t,n){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"stereo",action:function(){o.stereo(t,n)}}),o;var s=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof n>"u")if(typeof t=="number")o._stereo=t,o._pos=[t,0,0];else return o._stereo;for(var l=o._getSoundIds(n),h=0;h<l.length;h++){var m=o._soundById(l[h]);if(m)if(typeof t=="number")m._stereo=t,m._pos=[t,0,0],m._node&&(m._pannerAttr.panningModel="equalpower",(!m._panner||!m._panner.pan)&&e(m,s),s==="spatial"?typeof m._panner.positionX<"u"?(m._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),m._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),m._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):m._panner.setPosition(t,0,0):m._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),o._emit("stereo",m._id);else return m._stereo}return o},Howl.prototype.pos=function(t,n,o,s){var l=this;if(!l._webAudio)return l;if(l._state!=="loaded")return l._queue.push({event:"pos",action:function(){l.pos(t,n,o,s)}}),l;if(n=typeof n!="number"?0:n,o=typeof o!="number"?-.5:o,typeof s>"u")if(typeof t=="number")l._pos=[t,n,o];else return l._pos;for(var h=l._getSoundIds(s),m=0;m<h.length;m++){var p=l._soundById(h[m]);if(p)if(typeof t=="number")p._pos=[t,n,o],p._node&&((!p._panner||p._panner.pan)&&e(p,"spatial"),typeof p._panner.positionX<"u"?(p._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),p._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),p._panner.positionZ.setValueAtTime(o,Howler.ctx.currentTime)):p._panner.setPosition(t,n,o)),l._emit("pos",p._id);else return p._pos}return l},Howl.prototype.orientation=function(t,n,o,s){var l=this;if(!l._webAudio)return l;if(l._state!=="loaded")return l._queue.push({event:"orientation",action:function(){l.orientation(t,n,o,s)}}),l;if(n=typeof n!="number"?l._orientation[1]:n,o=typeof o!="number"?l._orientation[2]:o,typeof s>"u")if(typeof t=="number")l._orientation=[t,n,o];else return l._orientation;for(var h=l._getSoundIds(s),m=0;m<h.length;m++){var p=l._soundById(h[m]);if(p)if(typeof t=="number")p._orientation=[t,n,o],p._node&&(p._panner||(p._pos||(p._pos=l._pos||[0,0,-.5]),e(p,"spatial")),typeof p._panner.orientationX<"u"?(p._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),p._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),p._panner.orientationZ.setValueAtTime(o,Howler.ctx.currentTime)):p._panner.setOrientation(t,n,o)),l._emit("orientation",p._id);else return p._orientation}return l},Howl.prototype.pannerAttr=function(){var t=this,n=arguments,o,s,l;if(!t._webAudio)return t;if(n.length===0)return t._pannerAttr;if(n.length===1)if(typeof n[0]=="object")o=n[0],typeof s>"u"&&(o.pannerAttr||(o.pannerAttr={coneInnerAngle:o.coneInnerAngle,coneOuterAngle:o.coneOuterAngle,coneOuterGain:o.coneOuterGain,distanceModel:o.distanceModel,maxDistance:o.maxDistance,refDistance:o.refDistance,rolloffFactor:o.rolloffFactor,panningModel:o.panningModel}),t._pannerAttr={coneInnerAngle:typeof o.pannerAttr.coneInnerAngle<"u"?o.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof o.pannerAttr.coneOuterAngle<"u"?o.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof o.pannerAttr.coneOuterGain<"u"?o.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof o.pannerAttr.distanceModel<"u"?o.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof o.pannerAttr.maxDistance<"u"?o.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof o.pannerAttr.refDistance<"u"?o.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof o.pannerAttr.rolloffFactor<"u"?o.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof o.pannerAttr.panningModel<"u"?o.pannerAttr.panningModel:t._panningModel});else return l=t._soundById(parseInt(n[0],10)),l?l._pannerAttr:t._pannerAttr;else n.length===2&&(o=n[0],s=parseInt(n[1],10));for(var h=t._getSoundIds(s),m=0;m<h.length;m++)if(l=t._soundById(h[m]),l){var p=l._pannerAttr;p={coneInnerAngle:typeof o.coneInnerAngle<"u"?o.coneInnerAngle:p.coneInnerAngle,coneOuterAngle:typeof o.coneOuterAngle<"u"?o.coneOuterAngle:p.coneOuterAngle,coneOuterGain:typeof o.coneOuterGain<"u"?o.coneOuterGain:p.coneOuterGain,distanceModel:typeof o.distanceModel<"u"?o.distanceModel:p.distanceModel,maxDistance:typeof o.maxDistance<"u"?o.maxDistance:p.maxDistance,refDistance:typeof o.refDistance<"u"?o.refDistance:p.refDistance,rolloffFactor:typeof o.rolloffFactor<"u"?o.rolloffFactor:p.rolloffFactor,panningModel:typeof o.panningModel<"u"?o.panningModel:p.panningModel};var v=l._panner;v||(l._pos||(l._pos=t._pos||[0,0,-.5]),e(l,"spatial"),v=l._panner),v.coneInnerAngle=p.coneInnerAngle,v.coneOuterAngle=p.coneOuterAngle,v.coneOuterGain=p.coneOuterGain,v.distanceModel=p.distanceModel,v.maxDistance=p.maxDistance,v.refDistance=p.refDistance,v.rolloffFactor=p.rolloffFactor,v.panningModel=p.panningModel}return t},Sound.prototype.init=function(t){return function(){var n=this,o=n._parent;n._orientation=o._orientation,n._stereo=o._stereo,n._pos=o._pos,n._pannerAttr=o._pannerAttr,t.call(this),n._stereo?o.stereo(n._stereo):n._pos&&o.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var n=this,o=n._parent;return n._orientation=o._orientation,n._stereo=o._stereo,n._pos=o._pos,n._pannerAttr=o._pannerAttr,n._stereo?o.stereo(n._stereo):n._pos?o.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,o._refreshBuffer(n)),t.call(this)}}(Sound.prototype.reset);var e=function(t,n){n=n||"spatial",n==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(O);class ue{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,O.Howler.autoUnlock=!0,O.Howler.html5PoolSize=10,O.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(O.Howler.ctx&&O.Howler.ctx.state==="suspended")try{await O.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(e){console.error("Failed to resume AudioContext:",e)}}async preloadHotspots(e){const t=e.filter(n=>n.audioUrl).map(n=>({id:n.id,url:n.audioUrl}));this.preloadQueue.push(...t),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:e,url:t}=this.preloadQueue.shift();this.sounds.has(e)||(await this.loadSound(e,t),this.preloadedCount++)}this.isPreloading=!1}async loadSound(e,t){return new Promise(n=>{const o=new Audio;o.addEventListener("error",()=>{console.log(`Audio not found for ${e}, using placeholder`),this.createSound(e,this.placeholderUrl,!0),n()}),o.addEventListener("canplaythrough",()=>{this.createSound(e,t,!1),n()}),o.src=t})}createSound(e,t,n=!1){const o=new O.Howl({src:[t],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${e} (placeholder: ${n})`)},onend:()=>this.handlePlaybackEnd(e),onloaderror:(s,l)=>{console.error(`Failed to load sound ${e}:`,l),this.onError&&this.onError(e,l)},onplayerror:(s,l)=>{console.error(`Failed to play sound ${e}:`,l),this.onError&&this.onError(e,l)}});this.sounds.set(e,{howl:o,isPlaceholder:n,duration:n?this.placeholderDuration:null})}async play(e){if(await this.resumeContext(),this.currentHotspotId===e&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(e)||(this.state="loading",await this.loadSound(e,`/audio/hotspot_${e}.mp3`));const t=this.sounds.get(e);if(!t){console.error(`No sound found for hotspot: ${e}`);return}const n=t.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,n,e):(this.currentSound&&this.currentSound.stop(),this.currentSound=n,this.currentHotspotId=e,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(e),this.startProgressTracking())}crossfade(e,t,n){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${n}`),this.isCrossfading=!0,this.state="crossfading";const o=this.crossfadeDuration,s=20,l=o/s;let h=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,n),t.volume(0),t.play();const m=setInterval(()=>{h++;const p=h/s;e.volume(this.masterVolume*(1-p)),t.volume(this.masterVolume*p),h>=s&&(clearInterval(m),e.stop(),e.volume(this.masterVolume),this.previousSound=e,this.currentSound=t,this.currentHotspotId=n,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(n),this.startProgressTracking())},l)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(e){if(this.currentSound&&this.currentSound.playing()){const t=this.currentSound.seek()||0,n=this.currentSound.duration(),o=Math.max(0,Math.min(n,t+e));this.currentSound.seek(o),console.log(`Skipped to ${o.toFixed(1)}s`)}}setVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),O.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,O.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const e=this.currentSound.seek()||0,t=this.sounds.get(this.currentHotspotId),n=t!=null&&t.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,o=n>0?e/n*100:0;return{current:e,duration:n,percent:o}}seekTo(e){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(e)}seekToPercent(e){if(this.currentSound){const t=this.currentSound.duration(),n=e/100*t;this.seekTo(n)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const e=this.getProgress();this.onProgress(e)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(e){console.log(`Playback ended for hotspot: ${e}`),e===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(e))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(e,t=500){this.crossfadeEnabled=e,this.crossfadeDuration=Math.max(100,Math.min(2e3,t)),console.log(`Crossfade ${e?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(e){const t=this.sounds.get(e);t&&(t.howl.unload(),this.sounds.delete(e),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(e=>{e.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}playTemporalSound(e,t,n=50){(!t||isNaN(t)||!isFinite(t))&&(console.warn(`Invalid frequency for temporal sound: ${t}`),t=1e3),(!n||isNaN(n)||n<=0)&&(n=50),this.resumeContext(),this.uiAudioContext||(this.uiAudioContext=new(window.AudioContext||window.webkitAudioContext));try{const o=this.uiAudioContext,s=o.createOscillator(),l=o.createGain(),h=o.createBiquadFilter();h.type="lowpass",h.frequency.value=Math.min(t*1.5,2e3),s.connect(h),h.connect(l),l.connect(o.destination),s.type="sine",s.frequency.value=t;const m=o.currentTime,p=.01,v=n/1e3,i=t>1500?.05:.08;l.gain.setValueAtTime(0,m),l.gain.linearRampToValueAtTime(i,m+p),l.gain.exponentialRampToValueAtTime(.001,m+v),s.start(m),s.stop(m+v),console.log(`Temporal sound played: ${e} at ${t}Hz for ${n}ms`)}catch(o){console.error("Error playing temporal sound:",o)}}playTemporalTick(e=.5){const n=1200+400*(!isNaN(e)&&isFinite(e)?Math.min(1,Math.max(0,e)):.5);this.playTemporalSound("explore",n,40)}playTemporalBoop(){this.playTemporalSound("preview",600,80)}playTemporalThunk(e=.5){const n=150+100*(1-(!isNaN(e)&&isFinite(e)?Math.min(1,Math.max(0,e)):.5));this.playTemporalSound("activate",n,120)}}class pe{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(e){e.forEach(t=>{t.image_url_1&&this.overlays.set(t.id,{hotspotId:t.id,imageUrls:[t.image_url_1],autoReveal:t.overlay_auto_reveal||!1,displayMode:t.overlay_display_mode||"modal",showButton:t.show_images_button!==!1,access:t.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(e){const t=[];e.forEach(n=>{const o=this.overlays.get(n);o&&!o.isLoaded&&o.imageUrls.forEach(s=>{this.preloadedImages.has(s)||t.push({url:s,hotspotId:n})})}),this.preloadQueue.push(...t),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:e,hotspotId:t}=this.preloadQueue.shift();try{await this.loadImage(e,t)}catch(n){console.error(`Failed to preload image: ${e}`,n)}}this.isPreloading=!1}loadImage(e,t){return new Promise((n,o)=>{const s=new Image;s.onload=()=>{this.preloadedImages.set(e,s);const l=this.overlays.get(t);l&&(l.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(e,t),console.log(`Image loaded: ${e}`),n(s)},s.onerror=l=>{this.onImageError&&this.onImageError(e,t,l),console.error(`Failed to load image: ${e}`),o(l)},s.crossOrigin="anonymous",s.src=e})}shouldAutoReveal(e){const t=this.overlays.get(e);return t?t.autoReveal:!1}shouldShowButton(e){const t=this.overlays.get(e);return t?t.showButton:!0}getOverlay(e){return this.overlays.get(e)}openOverlay(e){const t=this.overlays.get(e);if(!t)return console.warn(`No overlay found for hotspot: ${e}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=e,!t.isLoaded){const n=t.imageUrls[0];this.loadImage(n,e).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(e,t),t}closeOverlay(){if(this.activeOverlay){const e=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(e)}}getImage(e){return this.preloadedImages.get(e)}hasAccess(e,t="free"){const n=this.overlays.get(e);if(!n)return!1;const o={free:0,gated:1,supporter:2},s=o[n.access]||0;return(o[t]||0)>=s}unloadImages(e){e.forEach(t=>{const n=this.overlays.get(t);n&&(n.imageUrls.forEach(o=>{this.preloadedImages.delete(o)}),n.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class ge{constructor(e,t=!1){this.viewer=e,this.isMobile=t,this.isActive=!0,this.isZooming=!1,this.lastZoomLevel=null,this.zoomStartTime=null,this.cinematicMode=!1,this.LOW_ZOOM_THRESHOLD=2,this.CRITICAL_ZOOM_THRESHOLD=1,this.originalSettings={},this.isOptimizing=!1,console.log("ðŸš€ PERFORMANCE FIXED: Simplified LowZoomOptimizer initialized for",t?"mobile":"desktop"),this.setupEventHandlers()}setupEventHandlers(){this.viewer&&(this.viewer.addHandler("zoom",e=>{this.isActive&&this.handleZoomChange(e)}),this.viewer.addHandler("pan",e=>{this.isActive&&this.handlePanAtLowZoom(e)}),this.viewer.addHandler("animation-start",()=>{this.isActive&&this.handleAnimationStart()}),this.viewer.addHandler("animation-finish",()=>{this.isActive&&this.handleAnimationFinish()}),this.viewer.drawer&&this.viewer.drawer.getType()!=="webgl"&&this.setupTileDrawingOptimization())}handleZoomChange(e){const t=e.zoom||this.viewer.viewport.getZoom();if(this.lastZoomLevel=t,this.cinematicMode){console.log("LowZoomOptimizer: Skipping zoom optimization - cinematic mode active");return}t<this.CRITICAL_ZOOM_THRESHOLD?this.applyCriticalZoomOptimization():t<this.LOW_ZOOM_THRESHOLD?this.applyLowZoomOptimization():this.restoreNormalOptimization()}handlePanAtLowZoom(e){if(this.viewer.viewport.getZoom()<this.LOW_ZOOM_THRESHOLD&&this.viewer.imageLoader){const n=this.viewer.imageLoader.jobLimit;this.viewer.imageLoader.jobLimit=this.isMobile?1:2,setTimeout(()=>{this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=n)},50)}}handleAnimationStart(){if(this.isZooming=!0,this.zoomStartTime=performance.now(),this.cinematicMode){console.log("LowZoomOptimizer: Skipping animation optimization - cinematic mode active");return}if(!this.isActive){console.log("LowZoomOptimizer: Skipping optimization - disabled");return}this.viewer.viewport.getZoom()<this.LOW_ZOOM_THRESHOLD&&(this.viewer.imageLoader&&this.viewer.imageLoader.clear(),this.storeOriginalSpringSettings(),this.optimizeSpringSettings())}handleAnimationFinish(){if(this.isZooming=!1,this.zoomStartTime){const e=performance.now()-this.zoomStartTime;console.log(`ðŸš€ PERFORMANCE FIXED: Animation duration: ${e.toFixed(1)}ms`),this.zoomStartTime=null}if(this.cinematicMode){console.log("LowZoomOptimizer: Skipping spring restoration - cinematic mode active");return}if(!this.isActive){console.log("LowZoomOptimizer: Skipping spring restoration - disabled");return}this.restoreOriginalSpringSettings()}applyCriticalZoomOptimization(){this.isOptimizing||(this.isOptimizing=!0,console.log("LowZoomOptimizer: Applying CRITICAL zoom optimization"),Object.keys(this.originalSettings).length===0&&this.storeOriginalSettings(),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),this.viewer.imageSmoothingEnabled=!1,this.viewer.immediateRender=!0,this.isMobile&&(this.viewer.maxTilesPerFrame=1,this.viewer.blendTime=0,this.viewer.alwaysBlend=!1))}applyLowZoomOptimization(){this.isOptimizing||(this.isOptimizing=!0,console.log("LowZoomOptimizer: Applying LOW zoom optimization"),Object.keys(this.originalSettings).length===0&&this.storeOriginalSettings(),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=this.isMobile?1:2),this.isMobile?(this.viewer.maxTilesPerFrame=1,this.viewer.blendTime=0):(this.viewer.maxTilesPerFrame=2,this.viewer.blendTime=0))}restoreNormalOptimization(){this.isOptimizing&&(console.log("LowZoomOptimizer: Restoring normal optimization"),this.restoreOriginalSettings(),this.isOptimizing=!1)}setupTileDrawingOptimization(){let e=0;this.viewer.addHandler("tile-drawing",t=>{if(!this.isActive)return;const n=this.viewer.viewport.getZoom();t.tile;const o=t.tile.level;if(n<this.LOW_ZOOM_THRESHOLD){e++;const s=n<this.CRITICAL_ZOOM_THRESHOLD?2:1;if(s>0&&e%(s+1)!==0){t.preventDefaultAction=!0;return}if(t.tile.size*n<(this.isMobile?32:24)){t.preventDefaultAction=!0;return}}if(this.isZooming){const s=Math.floor(Math.log2(n));if(Math.abs(o-s)>2){t.preventDefaultAction=!0;return}}})}storeOriginalSettings(){var e;this.originalSettings={imageLoaderLimit:(e=this.viewer.imageLoader)==null?void 0:e.jobLimit,maxTilesPerFrame:this.viewer.maxTilesPerFrame,blendTime:this.viewer.blendTime,alwaysBlend:this.viewer.alwaysBlend,imageSmoothingEnabled:this.viewer.imageSmoothingEnabled,immediateRender:this.viewer.immediateRender}}restoreOriginalSettings(){Object.keys(this.originalSettings).length!==0&&Object.keys(this.originalSettings).forEach(e=>{const t=this.originalSettings[e];t!==void 0&&(e==="imageLoaderLimit"&&this.viewer.imageLoader?this.viewer.imageLoader.jobLimit=t:this.viewer[e]!==void 0&&(this.viewer[e]=t))})}storeOriginalSpringSettings(){this.originalSpringSettings||(this.originalSpringSettings={animationTime:this.viewer.animationTime,springStiffness:this.viewer.springStiffness,centerXAnimationTime:this.viewer.viewport.centerSpringX.animationTime,centerYAnimationTime:this.viewer.viewport.centerSpringY.animationTime,zoomAnimationTime:this.viewer.viewport.zoomSpring.animationTime,centerXStiffness:this.viewer.viewport.centerSpringX.springStiffness,centerYStiffness:this.viewer.viewport.centerSpringY.springStiffness,zoomStiffness:this.viewer.viewport.zoomSpring.springStiffness})}optimizeSpringSettings(){if(this.cinematicMode){console.log("LowZoomOptimizer: Preserving springs - cinematic mode active");return}const e=this.isMobile?.25:.2,t=this.isMobile?15:18;this.viewer.animationTime=e,this.viewer.springStiffness=t,this.viewer.viewport.centerSpringX.animationTime=e,this.viewer.viewport.centerSpringY.animationTime=e,this.viewer.viewport.zoomSpring.animationTime=e,this.viewer.viewport.centerSpringX.springStiffness=t,this.viewer.viewport.centerSpringY.springStiffness=t,this.viewer.viewport.zoomSpring.springStiffness=t,console.log(`ðŸš€ PERFORMANCE FIXED: Ultra-fast springs applied - ${e*1e3}ms`)}restoreOriginalSpringSettings(){if(!this.originalSpringSettings)return;const e=this.originalSpringSettings;this.viewer.animationTime=e.animationTime,this.viewer.springStiffness=e.springStiffness,this.viewer.viewport.centerSpringX.animationTime=e.centerXAnimationTime,this.viewer.viewport.centerSpringY.animationTime=e.centerYAnimationTime,this.viewer.viewport.zoomSpring.animationTime=e.zoomAnimationTime,this.viewer.viewport.centerSpringX.springStiffness=e.centerXStiffness,this.viewer.viewport.centerSpringY.springStiffness=e.centerYStiffness,this.viewer.viewport.zoomSpring.springStiffness=e.zoomStiffness,this.originalSpringSettings=null}monitorPerformance(e){this._lastEmergencyTime||(this._lastEmergencyTime=0);const t=Date.now(),n=5e3,s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&!/iPad|iPhone|iPod/.test(navigator.userAgent)?10:this.isMobile?20:25;e<s&&e>0&&t-this._lastEmergencyTime>n&&(console.warn(`LowZoomOptimizer: Low FPS detected (${e}), applying emergency optimization`),this._lastEmergencyTime=t,this.applyEmergencyOptimization())}applyEmergencyOptimization(){console.warn("LowZoomOptimizer: Applying EMERGENCY optimization");const e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=e&&!/iPad|iPhone|iPod/.test(navigator.userAgent);if(this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=t?2:1,e||this.viewer.imageLoader.clear()),this.viewer.maxTilesPerFrame=t?2:1,this.viewer.blendTime=e?.1:0,this.viewer.alwaysBlend=!1,this.viewer.immediateRender=!0,!e&&this.viewer.world){const n=this.viewer.world.getItemCount();for(let o=0;o<n;o++){const s=this.viewer.world.getItemAt(o);s&&s._tileCache&&setTimeout(()=>{s._tileCache.clearTilesFor(s)},0)}}}enable(){this.isActive=!0,console.log("LowZoomOptimizer: Enabled")}disable(){this.isActive=!1,this.restoreNormalOptimization(),console.log("LowZoomOptimizer: Disabled")}destroy(){this.disable(),this.viewer&&(this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("pan"),this.viewer.removeAllHandlers("animation-start"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("tile-drawing")),console.log("ðŸš€ PERFORMANCE FIXED: LowZoomOptimizer destroyed")}setCinematicMode(e){this.cinematicMode=e,console.log(`LowZoomOptimizer: Cinematic mode ${e?"ENABLED":"DISABLED"}`),e&&this.restoreNormalOptimization()}getStatus(){return{isActive:this.isActive,isOptimizing:this.isOptimizing,currentZoom:this.lastZoomLevel,isMobile:this.isMobile,cinematicMode:this.cinematicMode,optimizationLevel:this.isOptimizing?this.lastZoomLevel<this.CRITICAL_ZOOM_THRESHOLD?"critical":"low":"normal",fixed:"PERFORMANCE_OPTIMIZED"}}}class fe{constructor(e){j(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});j(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=e,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const e=performance.memory.usedJSHeapSize/1048576,t=performance.memory.jsHeapSizeLimit/1048576,n=e/t*100;this.metrics.currentUsage=e,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,e);const o=this.state.memoryPressure;if(e>this.config.criticalThreshold||n>80?this.state.memoryPressure="critical":e>this.config.highThreshold||n>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==o)switch(console.log(`Memory pressure changed: ${o} â†’ ${this.state.memoryPressure} (${e.toFixed(0)}MB, ${n.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const e=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==e.tiles&&(this.viewer.maxImageCacheCount=e.tiles,console.log(`Adjusted tile cache limit to ${e.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var t;console.warn("CRITICAL: Emergency memory cleanup");const e=(t=this.viewer.world)==null?void 0:t.getItemAt(0);e&&(e._tileCache&&e._tileCache.clearTilesFor(e),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(e=!1){var s,l;const t=(s=this.viewer.world)==null?void 0:s.getItemAt(0);if(!(t!=null&&t._tileCache))return;const n=t._tileCache,o=((l=n._tilesLoaded)==null?void 0:l.length)||n._imagesLoadedCount||0;if(e||o>this.config.cacheLimits[this.state.memoryPressure].tiles){const h=e?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,m=o-h;m>0&&(console.log(`Removing ${m} tiles from cache (current: ${o})`),n.clearTilesFor(t))}}clearUnusedImages(){const e=document.querySelectorAll("img");let t=0;e.forEach(n=>{!this.isElementVisible(n)&&n.src&&(n.removeAttribute("src"),t++)}),t>0&&console.log(`Cleared ${t} unused images`)}isElementVisible(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const e={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const t=performance.memory.jsHeapSizeLimit/1048576;e.usagePercentage=(this.metrics.currentUsage/t*100).toFixed(1)+"%",e.totalLimit=t.toFixed(0)+"MB"}return e}destroy(){this.stop(),this.viewer=null}}class ve{constructor(e,t={}){this.viewer=e,this.config={throttleMs:t.throttleMs||16,zoomStep:t.zoomStep||.02,enabled:t.enabled!==!1,...t},this.lastEventTime=0,this.pendingZoom=0,this.throttleTimeout=null,this.isEnabled=this.config.enabled,this.init()}init(){!this.viewer||!this.isEnabled||(this.viewer.addHandler("canvas-scroll",this.handleScroll.bind(this)),console.log("Mouse wheel smoothing initialized:",{throttleMs:this.config.throttleMs,zoomStep:this.config.zoomStep}))}handleScroll(e){if(!this.isEnabled)return;e.preventDefault=!0;const t=performance.now(),n=this.normalizeWheelDelta(e.originalEvent),o=Math.sign(-n),s=this.config.zoomStep*Math.abs(o);this.pendingZoom+=s*o,t-this.lastEventTime>=this.config.throttleMs?(this.applyPendingZoom(),this.lastEventTime=t):(this.throttleTimeout&&clearTimeout(this.throttleTimeout),this.throttleTimeout=setTimeout(()=>{this.applyPendingZoom(),this.lastEventTime=performance.now()},this.config.throttleMs))}normalizeWheelDelta(e){let n=0;return"deltaY"in e?n=e.deltaY:"wheelDelta"in e&&(n=-e.wheelDelta/120*40),e.deltaMode===1&&(n*=40),n}applyPendingZoom(){if(Math.abs(this.pendingZoom)<.001){this.pendingZoom=0;return}const t=this.viewer.viewport.getZoom()*(1+this.pendingZoom),n=Math.max(this.viewer.viewport.getMinZoom(),Math.min(this.viewer.viewport.getMaxZoom(),t));this.viewer.viewport.zoomTo(n),this.viewer.viewport.applyConstraints(),this.pendingZoom=0}updateConfig(e){this.config={...this.config,...e},console.log("Mouse wheel smoothing config updated:",this.config)}enable(){this.isEnabled=!0,console.log("Mouse wheel smoothing enabled")}disable(){this.isEnabled=!1,this.throttleTimeout&&(clearTimeout(this.throttleTimeout),this.throttleTimeout=null),console.log("Mouse wheel smoothing disabled")}destroy(){this.disable()}}class we{constructor(){this.variationCache=new Map,this.durationVariation=.1,this.easingVariation=.05,this.startPointVariation=.15,this.debugMode=!1,this.enableDebugMode=()=>{this.debugMode=!0,this.durationVariation=.5,this.easingVariation=.25,this.startPointVariation=.5,this.clearAllVariations(),console.log("[OrganicVariations] ðŸ”¥ EXTREME DEBUG MODE enabled - variations are now VERY obvious:"),console.log("  - Duration: Â±50% (1.1s to 3.3s instead of 2.2s)"),console.log("  - Easing: Â±25% control point variation"),console.log("  - Start Point: 0-50% of path length"),console.log("  - Hover over multiple hotspots to see the differences!")},this.disableDebugMode=()=>{this.debugMode=!1,this.durationVariation=.1,this.easingVariation=.05,this.startPointVariation=.15,this.clearAllVariations(),console.log("[OrganicVariations] Debug mode disabled - variations are back to subtle")}}getVariations(e){return this.variationCache.has(e)||this.variationCache.set(e,this.generateVariations()),this.variationCache.get(e)}generateVariations(){return{durationMultiplier:this.generateDurationMultiplier(),easingAdjustment:this.generateEasingAdjustment(),startPointOffset:this.generateStartPointOffset(),timestamp:Date.now()}}generateDurationMultiplier(){const e=1-this.durationVariation,t=1+this.durationVariation;return e+Math.random()*(t-e)}generateEasingAdjustment(){return{x1:(Math.random()-.5)*this.easingVariation*2,y1:(Math.random()-.5)*this.easingVariation*2,x2:(Math.random()-.5)*this.easingVariation*2,y2:(Math.random()-.5)*this.easingVariation*2}}generateStartPointOffset(){return Math.random()*this.startPointVariation}applyDurationVariation(e,t){const n=this.getVariations(t);return Date.now()-n.timestamp>3e4?(this.variationCache.delete(t),this.applyDurationVariation(e,t)):e*n.durationMultiplier}applyEasingVariation(e,t){const n=this.getVariations(t),o=e.match(/cubic-bezier\(([\d.]+),\s*([\d.]+),\s*([\d.]+),\s*([\d.]+)\)/);if(!o)return e;const s=parseFloat(o[1])+n.easingAdjustment.x1,l=parseFloat(o[2])+n.easingAdjustment.y1,h=parseFloat(o[3])+n.easingAdjustment.x2,m=parseFloat(o[4])+n.easingAdjustment.y2,p=v=>Math.max(0,Math.min(1,v));return`cubic-bezier(${p(s)}, ${p(l)}, ${p(h)}, ${p(m)})`}getVariedStrokeDashValues(e,t){const n=this.getVariations(t);return e*n.startPointOffset,{dashArray:e,dashOffset:e}}clearVariations(e){this.variationCache.delete(e)}clearAllVariations(){this.variationCache.clear()}}const V=new we;typeof window<"u"&&(window.organicVariations=V,window.testVariations={enableDebugMode:()=>V.enableDebugMode(),disableDebugMode:()=>V.disableDebugMode(),showCache:()=>{const c=[];return V.variationCache.forEach((e,t)=>{c.push({hotspotId:t,duration:`Ã—${e.durationMultiplier.toFixed(3)}`,startOffset:`${(e.startPointOffset*100).toFixed(1)}%`,age:`${((Date.now()-e.timestamp)/1e3).toFixed(1)}s`})}),console.table(c),`${c.length} variations cached`},clear:()=>(V.clearAllVariations(),"All variations cleared")},console.log("[OrganicVariations] Loaded! Use these commands in console:"),console.log("- testVariations.enableDebugMode() : Make variations more obvious (Â±30%)"),console.log("- testVariations.disableDebugMode() : Return to subtle variations (Â±10%)"),console.log("- testVariations.showCache() : See all cached variations"),console.log("- testVariations.clear() : Clear all variations"));class _e{constructor(e){this.viewer=e,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[],this.thresholds={fps:{target:60,good:50,acceptable:35,poor:25,critical:15},frameTime:{target:16.67,warning:33},memory:{warning:300,critical:400}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const e={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(e).forEach(([t,n])=>this.viewer.addHandler(t,n.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(e=>this.viewer.removeAllHandlers(e))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const e=performance.now(),t=e-this.lastTime;this.updateFrameMetrics(t),this.lastTime=e,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(e){if(this.frameTimes.push(e),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),e>0){const t=1e3/e;this.fpsHistory.push(t),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=t,e>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const e=this.viewer.drawer.canvas;e&&(this.metrics.canvasSize=`${e.width}Ã—${e.height}`);const n=this.viewer.viewport.getBounds(),o=this.viewer.world.getHomeBounds(),s=n.width*n.height/(o.width*o.height);this.metrics.viewportCoverage=Math.min(100,s*100).toFixed(1)}updateTileMetrics(){var n,o;const e=this.viewer.world;if(e.getItemCount()===0)return;const t=e.getItemAt(0);if(t){if(this.metrics.visibleTiles=((n=t._tilesToDraw)==null?void 0:n.length)||0,t._tileCache){const s=t._tileCache;this.metrics.cachedTiles=((o=s._tilesLoaded)==null?void 0:o.length)||s._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:e,frameTime:t,memory:n}=this.thresholds,o={fps:Math.min(100,this.metrics.averageFPS/e.target*100)*.5,frameTime:Math.min(100,t.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(o).reduce((s,l)=>s+l,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const e=Date.now();if(e-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:t}=this.thresholds,n=this.metrics.averageFPS,o=this.metrics.performanceScore,s=this.getPerformanceTrend(),l=[{condition:n<t.critical||o<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:n<t.poor||o<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:n<t.good||o<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:n>t.target&&o>90&&(s==="improving"||s==="stable"),action:this.restoreQualitySettings,log:null}];for(const h of l)if(h.condition){h.log&&console[h.log==="CRITICAL"?"error":"warn"](`${h.log} performance: Score ${o}, FPS: ${n}`),h.action.call(this),this.lastOptimization=e;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const e=this.performanceHistory.slice(-10),t=this.performanceHistory.slice(-20,-10),n=this.average(e.map(l=>l.score)),o=this.average(t.map(l=>l.score)),s=n-o;return s>5?"improving":s<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var n;const e=(n=window.performanceConfig)==null?void 0:n.viewer;if(!e)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:o,delta:s,op:l})=>{const h=this.viewer[o],m=e[o];l==="increase"&&h<m?this.viewer[o]=Math.min(m,h+s):l==="decrease"&&h>m&&(this.viewer[o]=Math.max(m,h-s))})}onTileLoaded(e){var t;(t=e.tile)!=null&&t.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+e.tile.loadTime*.1)}onTileLoadFailed(e){console.warn("Tile load failed:",e.tile)}trackLoadTime(e){this.loadTimes.push(e),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const e=this.getPerformanceLevel();return{...this.metrics,instantFPS:this.metrics.currentFPS,performanceLevel:e,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:e,performanceScore:t}=this.metrics,{fps:n}=this.thresholds;return[{name:"excellent",condition:e>=n.target&&t>=90},{name:"good",condition:e>=n.good&&t>=80},{name:"acceptable",condition:e>=n.acceptable&&t>=60},{name:"poor",condition:e>=n.poor&&t>=40},{name:"critical",condition:!0}].find(s=>s.condition).name}getWarnings(){const e=this.metrics,t=this.thresholds;return[{condition:e.averageFPS<t.fps.poor,message:`Low FPS: ${e.averageFPS} (target: ${t.fps.target})`},{condition:e.droppedFrames>200,message:`Dropped frames: ${e.droppedFrames}`},{condition:parseFloat(e.frameTime)>t.frameTime.warning,message:`High frame time: ${e.frameTime}ms`},{condition:e.memoryUsage>t.memory.critical,message:`High memory: ${e.memoryUsage}MB`},{condition:e.cachedTiles>3e3,message:`Large cache: ${e.cachedTiles} tiles`},{condition:e.tileLoadTime>500,message:`Slow tile loading: ${Math.round(e.tileLoadTime)}ms`}].filter(o=>o.condition).map(o=>o.message)}getRecommendations(){const e=[],t=this.metrics,n=this.thresholds;return t.averageFPS<n.fps.acceptable&&(t.renderMode==="animating"&&e.push("Reduce animation time for smoother transitions"),t.cachedTiles>1e3&&e.push("Clear tile cache to free memory"),t.visibleTiles>50&&e.push("Zoom in to reduce visible tiles")),t.memoryUsage>n.memory.warning&&e.push("Consider reloading the page to clear memory"),t.tileLoadTime>200&&e.push("Check network connection or reduce concurrent tile loads"),e}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const e=this.getMetrics(),t={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},n=e.currentFPS<55?"#FF9800":"#4CAF50",o=e.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${t[e.performanceLevel]};">
                    ${e.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${n};">
                    ${e.currentFPS.toFixed(0)} (avg: ${e.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${e.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${o};">
                    ${e.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${t[e.performanceLevel]}; font-weight: 500;">
                    ${e.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(e){return e.reduce((t,n)=>t+n,0)/e.length}trimArray(e,t){for(;e.length>t;)e.shift()}}class ye{constructor(e){this.viewer=e,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([t,n])=>this.viewer.addHandler(t,n))}applyInitialOptimizations(){const e=this.viewer.container;e&&Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const e=performance.now(),t=e-this.state.lastFrameTime;if(this.state.lastFrameTime=e,this.viewer.viewport.getZoom()<3&&t>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let e=null,t=!1;this.viewer.addHandler("zoom",()=>{if(!t){if(t=!0,this.viewer.drawer&&this.viewer.drawer.context){const n=this.viewer.drawer.context;n.imageSmoothingEnabled=!1,n.globalAlpha=1}this.viewer.skipTileDrawing=!0}e&&clearTimeout(e),e=setTimeout(()=>{if(t=!1,this.viewer.drawer&&this.viewer.drawer.context){const n=this.viewer.drawer.context;n.imageSmoothingEnabled=!0,n.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),e=null},150)})}handleViewportChange(){const e=this.viewer.viewport.getZoom(!0),t=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const n=Math.abs(e-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+n*.3,this.state.isZooming=n>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const n=Math.sqrt(Math.pow(t.x-this.lastCenter.x,2)+Math.pow(t.y-this.lastCenter.y,2));this.state.isPanning=n>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=e,this.lastCenter=t}applyZoomOptimizations(e){var n,o;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((o=(n=window.performanceConfig)==null?void 0:n.renderOptimization)!=null&&o.zoomOptimizations))){if(e&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const s=this.viewer.world.getItemAt(0);s&&(this.state.lastBlendTime=0,s.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!e&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const s=this.viewer.world.getItemAt(0);s&&(s.blendTime=0)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(e){var n;this.lastInteraction=Date.now();const t={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(n=t[e])==null||n.call(t)}setRenderMode(e){var n,o;if(this.state.renderMode===e)return;const t=this.state.renderMode;this.state.renderMode=e,e==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):e==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(o=(n=window.performanceConfig)==null?void 0:n.debug)!=null&&o.logPerformance&&console.log(`Render mode: ${t} â†’ ${e}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var o,s;const e=Date.now();if(e-this.lastOptimizationTime<this.config.optimizationCooldown)return;const t=(o=this.viewer.drawer)==null?void 0:o.canvas,n=(s=this.viewer.drawer)==null?void 0:s.context;!t||!n||(Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(n,!0),n.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=e)}removeCanvasOptimizations(){var t;const e=(t=this.viewer.drawer)==null?void 0:t.context;e&&(this.setContextSmoothing(e,!0),e.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(e,t){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(o=>{o in e&&(e[o]=t)})}clearTimers(){Object.entries(this.timers).forEach(([e,t])=>{clearTimeout(t),delete this.timers[e]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(e){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(n=>Object.assign(n.style,e))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(e){Object.assign(this.config,e)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var e,t;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((t=(e=window.performanceConfig)==null?void 0:e.viewer)==null?void 0:t.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(e=>this.viewer.removeAllHandlers(e)),this.removeCanvasOptimizations(),this.viewer=null}}class Te{constructor(e){this.viewer=e,this.isInteracting=!1,this.highQualityTimeout=null,this.basePixelRatio=window.devicePixelRatio||1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.lastInteractionStart=0,this.interactionCount=0,this.averageFPS=60,this.scalingFactor=.2,this.restoreDelay=800,console.log("SafariPerformanceOptimizer initialized:",{isSafari:this.isSafari,isIOS:this.isIOS,basePixelRatio:this.basePixelRatio,scalingFactor:this.scalingFactor}),this.isSafari&&(this.setupEventHandlers(),this.applyInitialOptimizations())}setupEventHandlers(){let e=null;const t=()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.startInteraction()},16)};this.viewer.addHandler("animation-start",t),this.viewer.addHandler("pan",t),this.viewer.addHandler("zoom",t),this.isIOS&&this.viewer.addHandler("canvas-pinch",t),this.viewer.addHandler("animation-finish",()=>this.endInteraction());const n=this.viewer.canvas;n&&(n.addEventListener("touchstart",t,{passive:!0}),n.addEventListener("mousedown",t,{passive:!0}))}applyInitialOptimizations(){if(this.viewer.drawer&&this.viewer.drawer.canvas){const e=this.viewer.drawer.canvas;e.style.transform="translateZ(0)",e.style.willChange="transform",e.style.backfaceVisibility="hidden",e.style.webkitBackfaceVisibility="hidden",e.style.outline="none"}if(this.viewer.drawer&&this.viewer.drawer.context){const e=this.viewer.drawer.context;e.imageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1}}startInteraction(){var t;if(!this.isSafari||this.isInteracting)return;this.isInteracting=!0,this.lastInteractionStart=performance.now(),this.interactionCount++,clearTimeout(this.highQualityTimeout),!this.originalPixelRatio&&this.viewer.drawer&&(this.originalPixelRatio=this.viewer.drawer.pixelRatio||this.basePixelRatio);const e=this.originalPixelRatio*this.scalingFactor;if(console.log("Safari: Reducing render quality for interaction",{from:this.originalPixelRatio,to:e,scalingFactor:this.scalingFactor}),this.viewer.drawer&&(this.viewer.drawer.pixelRatio=e,this.viewer.drawer.canvas)){const n=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=n.x*e,this.viewer.drawer.canvas.height=n.y*e}if(this.viewer.drawer&&(this.viewer.drawer.context&&(this.viewer.drawer.context.imageSmoothingEnabled=!1,this.viewer.drawer.context.webkitImageSmoothingEnabled=!1),this.viewer.immediateRender=!0,this.viewer.blendTime=0,this.viewer.alwaysBlend=!1,this.originalSettings={immediateRender:this.viewer.immediateRender,blendTime:this.viewer.blendTime,alwaysBlend:this.viewer.alwaysBlend,imageLoaderLimit:(t=this.viewer.imageLoader)==null?void 0:t.jobLimit}),this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),this.viewer.world){const n=this.viewer.world.getItemAt(0);n&&(n.skipLevelIfLargerThan=.9)}if(this.averageFPS<15&&this.scalingFactor<=.2&&(console.log("Safari: ULTRA PERFORMANCE MODE activated"),this.viewer.minPixelRatio=2,this.viewer.maxTilesPerFrame=1,this.viewer.visibilityRatio=1,window.nativeHotspotRenderer&&(window.nativeHotspotRenderer.performanceMode=!0)),this.viewer.tileCache){const n=this.viewer.tileCache;this.originalCacheSize=n._maxImageCacheCount,n._maxImageCacheCount=Math.floor(this.originalCacheSize*.3)}this.viewer.forceRedraw()}endInteraction(){if(!this.isSafari||!this.isInteracting)return;this.isInteracting=!1;const e=performance.now()-this.lastInteractionStart;console.log(`Safari: Interaction ended (duration: ${e.toFixed(0)}ms)`),this.highQualityTimeout=setTimeout(()=>{const t=this.originalPixelRatio||this.basePixelRatio;if(console.log("Safari: Restoring full render quality",{to:t}),this.viewer.drawer&&(this.viewer.drawer.pixelRatio=t,this.viewer.drawer.canvas)){const n=this.viewer.viewport.getContainerSize();this.viewer.drawer.canvas.width=n.x*t,this.viewer.drawer.canvas.height=n.y*t}if(this.originalSettings&&(this.viewer.immediateRender=this.originalSettings.immediateRender!==void 0?this.originalSettings.immediateRender:!1,this.viewer.blendTime=this.originalSettings.blendTime!==void 0?this.originalSettings.blendTime:.5,this.viewer.alwaysBlend=this.originalSettings.alwaysBlend!==void 0?this.originalSettings.alwaysBlend:!1,this.viewer.imageLoader&&this.originalSettings.imageLoaderLimit&&(this.viewer.imageLoader.jobLimit=this.originalSettings.imageLoaderLimit)),this.viewer.drawer&&this.viewer.drawer.context&&(this.viewer.drawer.context.imageSmoothingEnabled=!0,this.viewer.drawer.context.webkitImageSmoothingEnabled=!0),this.viewer.world){const n=this.viewer.world.getItemAt(0);n&&(n.skipLevelIfLargerThan=1/0)}this.viewer.tileCache&&this.originalCacheSize&&(this.viewer.tileCache._maxImageCacheCount=this.originalCacheSize),this.viewer.forceRedraw()},this.restoreDelay)}updatePerformanceMetrics(e){this.averageFPS=this.averageFPS*.9+e*.1,this.averageFPS<20&&this.scalingFactor>.15?(this.scalingFactor=.15,console.log(`Safari: EMERGENCY - Reduced scaling factor to ${this.scalingFactor} due to very low FPS`)):this.averageFPS<30&&this.scalingFactor>.25?(this.scalingFactor=Math.max(.25,this.scalingFactor-.1),console.log(`Safari: Reduced scaling factor to ${this.scalingFactor} due to low FPS`)):this.averageFPS>50&&this.scalingFactor<.5&&(this.scalingFactor=Math.min(.5,this.scalingFactor+.05),console.log(`Safari: Increased scaling factor to ${this.scalingFactor} due to good FPS`))}forceOptimization(e){e?(this.startInteraction(),clearTimeout(this.highQualityTimeout)):(this.isInteracting=!1,this.endInteraction())}getState(){const e=this.viewer.drawer?this.viewer.drawer.pixelRatio:this.basePixelRatio;return{isActive:this.isSafari,isInteracting:this.isInteracting,currentPixelRatio:e,basePixelRatio:this.basePixelRatio,scalingFactor:this.scalingFactor,averageFPS:this.averageFPS.toFixed(1),platform:this.isIOS?"iOS Safari":"Desktop Safari"}}destroy(){clearTimeout(this.highQualityTimeout)}}function se(c,e,t=0,n=c.length-1,o=Se){for(;n>t;){if(n-t>600){const m=n-t+1,p=e-t+1,v=Math.log(m),i=.5*Math.exp(2*v/3),r=.5*Math.sqrt(v*i*(m-i)/m)*(p-m/2<0?-1:1),a=Math.max(t,Math.floor(e-p*i/m+r)),d=Math.min(n,Math.floor(e+(m-p)*i/m+r));se(c,e,a,d,o)}const s=c[e];let l=t,h=n;for(Y(c,t,e),o(c[n],s)>0&&Y(c,t,n);l<h;){for(Y(c,l,h),l++,h--;o(c[l],s)<0;)l++;for(;o(c[h],s)>0;)h--}o(c[t],s)===0?Y(c,t,h):(h++,Y(c,h,n)),h<=e&&(t=h+1),e<=h&&(n=h-1)}}function Y(c,e,t){const n=c[e];c[e]=c[t],c[t]=n}function Se(c,e){return c<e?-1:c>e?1:0}class be{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!Q(e,t))return n;const o=this.toBBox,s=[];for(;t;){for(let l=0;l<t.children.length;l++){const h=t.children[l],m=t.leaf?o(h):h;Q(e,m)&&(t.leaf?n.push(h):K(e,m)?this._all(h,n):s.push(h))}t=s.pop()}return n}collides(e){let t=this.data;if(!Q(e,t))return!1;const n=[];for(;t;){for(let o=0;o<t.children.length;o++){const s=t.children[o],l=t.leaf?this.toBBox(s):s;if(Q(e,l)){if(t.leaf||K(e,l))return!0;n.push(s)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=H([]),this}remove(e,t){if(!e)return this;let n=this.data;const o=this.toBBox(e),s=[],l=[];let h,m,p;for(;n||s.length;){if(n||(n=s.pop(),m=s[s.length-1],h=l.pop(),p=!0),n.leaf){const v=xe(e,n.children,t);if(v!==-1)return n.children.splice(v,1),s.push(n),this._condense(s),this}!p&&!n.leaf&&K(n,o)?(s.push(n),l.push(h),h=0,m=n,n=n.children[0]):m?(h++,n=m.children[h],p=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,o){const s=n-t+1;let l=this._maxEntries,h;if(s<=l)return h=H(e.slice(t,n+1)),F(h,this.toBBox),h;o||(o=Math.ceil(Math.log(s)/Math.log(l)),l=Math.ceil(s/Math.pow(l,o-1))),h=H([]),h.leaf=!1,h.height=o;const m=Math.ceil(s/l),p=m*Math.ceil(Math.sqrt(l));re(e,t,n,p,this.compareMinX);for(let v=t;v<=n;v+=p){const i=Math.min(v+p-1,n);re(e,v,i,m,this.compareMinY);for(let r=v;r<=i;r+=m){const a=Math.min(r+m-1,i);h.children.push(this._build(e,r,a,o-1))}}return F(h,this.toBBox),h}_chooseSubtree(e,t,n,o){for(;o.push(t),!(t.leaf||o.length-1===n);){let s=1/0,l=1/0,h;for(let m=0;m<t.children.length;m++){const p=t.children[m],v=U(p),i=Ce(e,p)-v;i<l?(l=i,s=v<s?v:s,h=p):i===l&&v<s&&(s=v,h=p)}t=h||t.children[0]}return t}_insert(e,t,n){const o=n?e:this.toBBox(e),s=[],l=this._chooseSubtree(o,this.data,t,s);for(l.children.push(e),q(l,o);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(o,s,t)}_split(e,t){const n=e[t],o=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,o);const l=this._chooseSplitIndex(n,s,o),h=H(n.children.splice(l,n.children.length-l));h.height=n.height,h.leaf=n.leaf,F(n,this.toBBox),F(h,this.toBBox),t?e[t-1].children.push(h):this._splitRoot(n,h)}_splitRoot(e,t){this.data=H([e,t]),this.data.height=e.height+1,this.data.leaf=!1,F(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let o,s=1/0,l=1/0;for(let h=t;h<=n-t;h++){const m=$(e,0,h,this.toBBox),p=$(e,h,n,this.toBBox),v=Pe(m,p),i=U(m)+U(p);v<s?(s=v,o=h,l=i<l?i:l):v===s&&i<l&&(l=i,o=h)}return o||n-t}_chooseSplitAxis(e,t,n){const o=e.leaf?this.compareMinX:Me,s=e.leaf?this.compareMinY:Ae,l=this._allDistMargin(e,t,n,o),h=this._allDistMargin(e,t,n,s);l<h&&e.children.sort(o)}_allDistMargin(e,t,n,o){e.children.sort(o);const s=this.toBBox,l=$(e,0,t,s),h=$(e,n-t,n,s);let m=N(l)+N(h);for(let p=t;p<n-t;p++){const v=e.children[p];q(l,e.leaf?s(v):v),m+=N(l)}for(let p=n-t-1;p>=t;p--){const v=e.children[p];q(h,e.leaf?s(v):v),m+=N(h)}return m}_adjustParentBBoxes(e,t,n){for(let o=n;o>=0;o--)q(t[o],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():F(e[t],this.toBBox)}}function xe(c,e,t){if(!t)return e.indexOf(c);for(let n=0;n<e.length;n++)if(t(c,e[n]))return n;return-1}function F(c,e){$(c,0,c.children.length,e,c)}function $(c,e,t,n,o){o||(o=H(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(let s=e;s<t;s++){const l=c.children[s];q(o,c.leaf?n(l):l)}return o}function q(c,e){return c.minX=Math.min(c.minX,e.minX),c.minY=Math.min(c.minY,e.minY),c.maxX=Math.max(c.maxX,e.maxX),c.maxY=Math.max(c.maxY,e.maxY),c}function Me(c,e){return c.minX-e.minX}function Ae(c,e){return c.minY-e.minY}function U(c){return(c.maxX-c.minX)*(c.maxY-c.minY)}function N(c){return c.maxX-c.minX+(c.maxY-c.minY)}function Ce(c,e){return(Math.max(e.maxX,c.maxX)-Math.min(e.minX,c.minX))*(Math.max(e.maxY,c.maxY)-Math.min(e.minY,c.minY))}function Pe(c,e){const t=Math.max(c.minX,e.minX),n=Math.max(c.minY,e.minY),o=Math.min(c.maxX,e.maxX),s=Math.min(c.maxY,e.maxY);return Math.max(0,o-t)*Math.max(0,s-n)}function K(c,e){return c.minX<=e.minX&&c.minY<=e.minY&&e.maxX<=c.maxX&&e.maxY<=c.maxY}function Q(c,e){return e.minX<=c.maxX&&e.minY<=c.maxY&&e.maxX>=c.minX&&e.maxY>=c.minY}function H(c){return{children:c,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function re(c,e,t,n,o){const s=[e,t];for(;s.length;){if(t=s.pop(),e=s.pop(),t-e<=n)continue;const l=e+Math.ceil((t-e)/n/2)*n;se(c,l,e,t,o),s.push(e,l,l,t)}}class Ie{constructor(){this.tree=new be(9),this.hotspots=new Map,this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(e){const t=performance.now();this.tree.clear(),this.hotspots.clear(),this.queryCache.clear();const n=[];e.forEach(s=>{const l=this.calculateBoundingBox(s.coordinates);this.hotspots.set(s.id,{...s,bbox:l}),n.push({minX:l.minX,minY:l.minY,maxX:l.maxX,maxY:l.maxY,id:s.id})}),this.tree.load(n);const o=performance.now()-t;console.log(`Spatial index built in ${o.toFixed(2)}ms for ${n.length} hotspots`)}queryViewport(e,t=1){const n=`${e.minX.toFixed(2)},${e.minY.toFixed(2)},${e.maxX.toFixed(2)},${e.maxY.toFixed(2)},${t.toFixed(2)}`;if(this.queryCache.has(n))return this.queryCache.get(n);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const s=this.tree.search({minX:e.minX,minY:e.minY,maxX:e.maxX,maxY:e.maxY}).map(l=>this.hotspots.get(l.id));return this.queryCache.size<this.cacheSize&&this.queryCache.set(n,s),s}getHotspotAtPoint(e,t){const n=this.tree.search({minX:e,minY:t,maxX:e,maxY:t});for(const o of n){const s=this.hotspots.get(o.id);if(this.isPointInHotspot(e,t,s))return s}return null}calculateBoundingBox(e){let t=1/0,n=1/0,o=-1/0,s=-1/0;const l=h=>{for(const m of h)t=Math.min(t,m[0]),n=Math.min(n,m[1]),o=Math.max(o,m[0]),s=Math.max(s,m[1])};if(e.length>0&&typeof e[0][0]=="number")l(e);else for(const h of e)l(h);return{minX:t,minY:n,maxX:o,maxY:s}}isPointInHotspot(e,t,n){return n.shape==="polygon"?this.pointInPolygon(e,t,n.coordinates):n.shape==="multipolygon"?n.coordinates.some(o=>this.pointInPolygon(e,t,o)):!1}pointInPolygon(e,t,n){let o=!1;const s=n.length;let l=n[0][0],h=n[0][1];for(let m=1;m<=s;m++){const p=n[m%s][0],v=n[m%s][1];if(t>Math.min(h,v)&&t<=Math.max(h,v)&&e<=Math.max(l,p)&&h!==v){const i=(t-h)*(p-l)/(v-h)+l;(l===p||e<=i)&&(o=!o)}l=p,h=v}return o}getAllHotspots(){return Array.from(this.hotspots.values())}clear(){this.tree.clear(),this.hotspots.clear(),this.queryCache.clear()}}class Oe{constructor(e){this.viewer=e,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:10}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(e){if(!e.tile)return;const t=this.getTileKey(e.tile);this.tileAccessTimes.set(t,Date.now())}handleViewportChange(){var n;const e=(n=this.viewer.world)==null?void 0:n.getItemAt(0);if(!e||!e._tilesToDraw)return;const t=Date.now();e._tilesToDraw.forEach(o=>{const s=this.getTileKey(o);this.tileAccessTimes.set(s,t)})}getTileKey(e){return`${e.level}_${e.x}_${e.y}`}monitorPerformance(){var o,s;const e=((s=(o=window.performanceMonitor)==null?void 0:o.getMetrics())==null?void 0:s.averageFPS)||60,t=this.state.currentPressure;/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?e<10?this.state.currentPressure="critical":e<15?this.state.currentPressure="high":e<25?this.state.currentPressure="elevated":this.state.currentPressure="normal":e<this.config.fpsThresholds.critical?this.state.currentPressure="critical":e<this.config.fpsThresholds.poor?this.state.currentPressure="high":e<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",t!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${t} â†’ ${this.state.currentPressure} (FPS: ${e})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const t={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),t)}performCleanup(){var y;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const t=performance.now(),n=(y=this.viewer.world)==null?void 0:y.getItemAt(0);if(!n||!n._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const s=this.state.currentPressure,l=this.config.maxTileAge[s],h=this.config.cacheThresholds[s],m=this.config.keepDistance[s],p=Date.now(),i=this.viewer.viewport.getBounds(),r={x:i.x-i.width*(m-1)/2,y:i.y-i.height*(m-1)/2,width:i.width*m,height:i.height*m},d=n._tileCache._tilesLoaded||[],f=d.length;if(f===0)return;const u=new Set;n._tilesToDraw&&n._tilesToDraw.forEach(T=>{const b=this.getTileKey(T);u.add(b)});const g=[];if(d.forEach(T=>{const b=this.getTileKey(T);if(u.has(b))return;const A=this.tileAccessTimes.get(b)||0,C=p-A;let M=!1;if(C>l&&(M=!0),!M&&s!=="normal"){const S=T.bounds;S&&(!(S.x+S.width<r.x||S.x>r.x+r.width||S.y+S.height<r.y||S.y>r.y+r.height)||(M=!0))}M&&g.push(T)}),f>h){const T=f-h;if(T>g.length){const b=d.filter(C=>{const M=this.getTileKey(C);return!g.includes(C)&&!u.has(M)});b.sort((C,M)=>{const S=this.getTileKey(C),E=this.getTileKey(M),L=this.tileAccessTimes.get(S)||0,R=this.tileAccessTimes.get(E)||0;return L-R});const A=T-g.length;g.push(...b.slice(0,A))}}g.length>0&&(g.forEach(T=>{const b=this.getTileKey(T);this.tileAccessTimes.delete(b),T.unload&&T.unload()}),this.state.tilesRemoved+=g.length,this.metrics.totalCleaned+=g.length,console.log(`Cleaned ${g.length} tiles (pressure: ${s}, cache was: ${f}, kept ${u.size} visible)`));const w=performance.now()-t;this.metrics.lastCleanupDuration=w,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+w)/this.metrics.cleanupRuns,this.state.lastCleanup=p,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const t=performance.now(),n=Date.now(),o=3e5,s=[];this.tileAccessTimes.forEach((h,m)=>{n-h>o&&s.push(m)}),s.forEach(h=>this.tileAccessTimes.delete(h)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const l=performance.now()-t;this.state.lastDeepCleanup=n,console.log(`Deep cleanup completed in ${l.toFixed(2)}ms, cleared ${s.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var n,o,s;const e=(n=this.viewer.world)==null?void 0:n.getItemAt(0),t=((s=(o=e==null?void 0:e._tileCache)==null?void 0:o._tilesLoaded)==null?void 0:s.length)||0;return{...this.metrics,currentCacheSize:t,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(e){["normal","elevated","high","critical"].includes(e)&&(this.state.currentPressure=e,this.updateCleanupInterval())}pauseCleanup(e=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},e))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class ze{constructor(e){this.viewer=e,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(e){throw console.error("Failed to initialize TileWorkerManager:",e),this.state.lastError=e,e}}async processTile(e,t=2){this.isInitialized||await this.initialize();const n=this.generateRequestId();return new Promise((o,s)=>{const l=setTimeout(()=>{this.state.pendingRequests.delete(n),this.metrics.requestsFailed++,s(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(n,{resolve:o,reject:s,timeout:l,startTime:performance.now(),tile:e}),this.worker.postMessage({type:"process-tile",requestId:n,data:{tile:this.serializeTile(e),priority:t}}),this.metrics.requestsSent++})}async processBatch(e,t=[]){this.isInitialized||await this.initialize();const n=this.generateRequestId();return new Promise((o,s)=>{const l=setTimeout(()=>{this.state.pendingRequests.delete(n),this.metrics.requestsFailed++,s(new Error("Batch processing timeout"))},this.config.requestTimeout*e.length);this.state.pendingRequests.set(n,{resolve:o,reject:s,timeout:l,startTime:performance.now(),tiles:e}),this.worker.postMessage({type:"batch-process",requestId:n,data:{tiles:e.map(h=>this.serializeTile(h)),priorities:t}}),this.metrics.requestsSent++})}async prioritizeTiles(e,t){if(this.isInitialized||await this.initialize(),e.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const o=e.map(s=>{const l=(s.bounds.minX+s.bounds.maxX)/2,h=(s.bounds.minY+s.bounds.maxY)/2,m=(t.bounds.minX+t.bounds.maxX)/2,p=(t.bounds.minY+t.bounds.maxY)/2,v=Math.sqrt(Math.pow(l-m,2)+Math.pow(h-p,2));return v<.5?0:v<1?1:2});return{tiles:e,priorities:o}}const n=this.generateRequestId();return new Promise((o,s)=>{const l=setTimeout(()=>{this.state.pendingRequests.delete(n),o({tiles:e,priorities:e.map(()=>1)})},50);this.state.pendingRequests.set(n,{resolve:o,reject:s,timeout:l}),this.worker.postMessage({type:"prioritize",requestId:n,data:{tiles:e.map(h=>this.serializeTile(h)),viewport:{bounds:t.bounds,zoom:t.zoom}}})})}clearCache(e=!1,t=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:e,maxAge:t}})}async getStats(){if(!this.isInitialized)return this.metrics;const e=this.generateRequestId();return new Promise(t=>{const n=setTimeout(()=>{this.state.pendingRequests.delete(e),t(this.metrics)},1e3);this.state.pendingRequests.set(e,{resolve:t,reject:()=>{},timeout:n}),this.worker.postMessage({type:"get-stats",requestId:e})})}handleWorkerMessage(e){const{type:t,requestId:n,data:o}=e.data;switch(t){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=o.capabilities,this.handleRequestComplete(n,o);break;case"tile-ready":this.handleTileReady(n,o);break;case"tile-error":this.handleTileError(n,o);break;case"batch-complete":this.handleRequestComplete(n,o);break;case"priorities-calculated":this.handleRequestComplete(n,o);break;case"stats":this.handleStatsReceived(n,o);break;case"cache-cleared":console.log("Worker cache cleared:",o);break;default:console.warn("Unknown worker message type:",t)}}handleWorkerError(e){console.error("Worker error:",e),this.state.lastError=e,this.state.pendingRequests.forEach((t,n)=>{clearTimeout(t.timeout),t.reject(e)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(e,t){const n=this.state.pendingRequests.get(e);if(!n)return;clearTimeout(n.timeout),this.state.pendingRequests.delete(e);const o=performance.now()-n.startTime;this.updateMetrics(o,t.cached),n.resolve({...t,processingTime:o})}handleTileError(e,t){const n=this.state.pendingRequests.get(e);n&&(clearTimeout(n.timeout),this.state.pendingRequests.delete(e),this.metrics.requestsFailed++,n.reject(new Error(t.error)))}handleRequestComplete(e,t){const n=this.state.pendingRequests.get(e);n&&(clearTimeout(n.timeout),this.state.pendingRequests.delete(e),n.resolve(t))}handleStatsReceived(e,t){const n=this.state.pendingRequests.get(e);if(!n)return;clearTimeout(n.timeout),this.state.pendingRequests.delete(e);const o={...this.metrics,worker:t};n.resolve(o)}updateMetrics(e,t){this.metrics.requestsCompleted++,t&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=e,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(e){return{level:e.level,x:e.x,y:e.y,bounds:e.bounds?{minX:e.bounds.x||e.bounds.minX,minY:e.bounds.y||e.bounds.minY,maxX:(e.bounds.x||e.bounds.minX)+(e.bounds.width||0),maxY:(e.bounds.y||e.bounds.minY)+(e.bounds.height||0)}:null,url:e.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(e=>{if(this.state.workerReady){e();return}const t=setInterval(()=>{this.state.workerReady&&(clearInterval(t),e())},100);setTimeout(()=>{clearInterval(t),e()},5e3)})}async sendToWorker(e,t){const n=this.generateRequestId();return new Promise((o,s)=>{const l=setTimeout(()=>{this.state.pendingRequests.delete(n),s(new Error(`Worker request timeout: ${e}`))},5e3);this.state.pendingRequests.set(n,{resolve:o,reject:s,timeout:l}),this.worker.postMessage({type:e,requestId:n,data:t})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(e=>{clearTimeout(e.timeout),e.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class Ee{constructor(e){this.viewer=e,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new ze(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(e){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",e),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(e=>clearInterval(e)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const e=this.viewer.viewport,t=e.getBounds(),n={bounds:{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height},zoom:e.getZoom()},o=this.state.tileQueue.slice(0,50),s=await this.workerManager.prioritizeTiles(o,n);s.tiles&&s.priorities&&(s.tiles.forEach((l,h)=>{const m=s.priorities[h],p=this.state.tileQueue.find(v=>v.level===l.level&&v.x===l.x&&v.y===l.y);p&&(p.priority=m)}),this.sortQueue())}catch(e){console.warn("Failed to update worker priorities:",e)}}calculateTilePriority(e,t,n){const o=this.viewer.viewport,s=o.getBounds(),l=o.getCenter(),h=o.getZoom();if(h<2&&this.viewer.source.getTileWidth(e)*h<32)return 999;const m=this.viewer.source.getTileWidth(e),p=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(e):m,v=(t+.5)*m/this.viewer.source.width,i=(n+.5)*p/this.viewer.source.height,r=Math.sqrt(Math.pow(v-l.x,2)+Math.pow(i-l.y,2)),a={left:t*m/this.viewer.source.width,top:n*p/this.viewer.source.height,right:(t+1)*m/this.viewer.source.width,bottom:(n+1)*p/this.viewer.source.height};return a.right<s.x||a.left>s.x+s.width||a.bottom<s.y||a.top>s.y+s.height?r<s.width*this.config.predictiveRadius?1:2:h<3?Math.abs(v-l.x)+Math.abs(i-l.y)<.2?0:1:0}enqueueTile(e,t,n,o){const s=`${e}_${t}_${n}`;if(this.state.loadingTiles.has(s))return;const l=this.state.tileQueue.findIndex(m=>m.key===s);if(l>=0){o<this.state.tileQueue[l].priority&&(this.state.tileQueue[l].priority=o,this.sortQueue());return}const h={level:e,x:t,y:n,key:s,priority:o,timestamp:Date.now(),bounds:this.calculateTileBounds(e,t,n)};this.state.tileQueue.push(h),this.sortQueue()}calculateTileBounds(e,t,n){const o=this.viewer.source.getTileWidth(e),s=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(e):o,l=this.viewer.source.width,h=this.viewer.source.height;return{minX:t*o/l,minY:n*s/h,maxX:(t+1)*o/l,maxY:(n+1)*s/h}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const e=this.state.tileQueue.filter(t=>t.priority<=1).slice(0,this.config.workerBatchSize);if(e.length!==0)try{const t=e.map(s=>s.priority),n=performance.now();await this.workerManager.processBatch(e,t);const o=performance.now()-n;this.workerMetrics.tilesProcessedByWorker+=e.length,this.workerMetrics.workerProcessingTime+=o,e.forEach(s=>{const l=this.state.tileQueue.findIndex(h=>h.key===s.key);l>=0&&this.state.tileQueue.splice(l,1)})}catch(t){console.error("Worker batch processing failed:",t),this.workerMetrics.workerErrors++}}processQueue(){var t;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((t=this.viewer.world)!=null&&t.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const n=this.state.tileQueue.shift();Date.now()-n.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(n.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((e,t)=>e.priority!==t.priority?e.priority-t.priority:e.timestamp-t.timestamp)}predictiveLoad(){var r;if(this.shouldSkipPredictiveLoad()||!((r=this.viewer.world)==null?void 0:r.getItemAt(0))||!this.viewer.source)return;const t=this.viewer.viewport,n=t.getBounds(),o={x:n.x-n.width*(this.config.predictiveRadius-1)/2,y:n.y-n.height*(this.config.predictiveRadius-1)/2,width:n.width*this.config.predictiveRadius,height:n.height*this.config.predictiveRadius},s=t.getZoom(),l=Math.max(0,Math.min(Math.floor(Math.log2(s)),this.viewer.source.maxLevel||14)),h=this.viewer.source.getTileWidth(l),m=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(l):h,p=this.viewer.source.width,v=this.viewer.source.height,i={startX:Math.max(0,Math.floor(o.x*p/h)),endX:Math.min(Math.ceil(p/h)-1,Math.ceil((o.x+o.width)*p/h)),startY:Math.max(0,Math.floor(o.y*v/m)),endY:Math.min(Math.ceil(v/m)-1,Math.ceil((o.y+o.height)*v/m))};for(let a=i.startX;a<=i.endX;a++)for(let d=i.startY;d<=i.endY;d++){const f=this.calculateTilePriority(l,a,d);this.enqueueTile(l,a,d,f)}}trackLoadTime(e){this.state.loadTimes.push(e),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((t,n)=>t+n,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(e){this.state.loadingTiles.delete(e)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const e=this.state.averageLoadTime,t=this.config.maxConcurrentLoads;e>500&&t>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${e.toFixed(0)}ms)`)):e<200&&t<8&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${e.toFixed(0)}ms)`))}performCleanup(){const e=Date.now();this.state.tileQueue=this.state.tileQueue.filter(t=>e-t.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=e,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const e=document.createElement("canvas");e.width=e.height=1;const t=e.getContext("2d");t.fillStyle="rgba(0,0,0,0)",t.fillRect(0,0,1,1);try{return e.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const e=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:e}}}class Le{constructor(e,t){this.viewer=e,this.components=t,this.isAnimating=!1,this.animationEndHandlers=[],this.debugMode=!1,this.reducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.SPRING_PHYSICS={desktop:{tension:this.reducedMotion?250:170,friction:this.reducedMotion?40:26,mass:1,precision:.001},mobile:{tension:this.reducedMotion?300:200,friction:this.reducedMotion?45:30,mass:1,precision:.001}},this.STABLE_SPRING_CONFIG={desktop:{animationTime:this.reducedMotion?.3:1,springStiffness:this.reducedMotion?12:6.5,damping:.85},mobile:{animationTime:this.reducedMotion?.2:.8,springStiffness:this.reducedMotion?15:8,damping:.9}},this.CONVERGENCE_THRESHOLD=.001,this.OSCILLATION_THRESHOLD=.01,this.setupDiagnostics(),this.setupAccessibility()}setupAccessibility(){window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{this.reducedMotion=e.matches,this.updateSpringConfig()}),this.createAriaAnnouncer()}updateSpringConfig(){const e=/Android|iPhone|iPad/i.test(navigator.userAgent),t=e?this.STABLE_SPRING_CONFIG.mobile:this.STABLE_SPRING_CONFIG.desktop;this.reducedMotion?(t.animationTime=e?.2:.3,t.springStiffness=e?15:12):(t.animationTime=e?.8:1,t.springStiffness=e?8:6.5)}createAriaAnnouncer(){const e=document.createElement("div");e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",e.style.cssText=`
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        `,document.body.appendChild(e),this.ariaAnnouncer=e}announceZoomChange(e){this.ariaAnnouncer&&(this.ariaAnnouncer.textContent=e,setTimeout(()=>{this.ariaAnnouncer.textContent=""},1e3))}setupDiagnostics(){if(!this.viewer)return;let e=0,t=[];this.viewer.addHandler("zoom",n=>{if(!this.isAnimating)return;const o=n.zoom;if(t.push(o),t.length>10&&t.shift(),t.length>=3){const[s,l,h]=t.slice(-3);(l>s&&h<l||l<s&&h>l)&&(e++,e>=2&&this.debugMode&&console.warn("ðŸ”´ Oscillation detected!",{pattern:[s,l,h],count:e}))}})}async performCinematicZoom(e,t={}){if(this.isAnimating){console.log("Cinematic zoom already in progress");return}const o=/Android|iPhone|iPad/i.test(navigator.userAgent)?this.STABLE_SPRING_CONFIG.mobile:this.STABLE_SPRING_CONFIG.desktop;if(t.stages&&!this.reducedMotion)return this.performMultiStageZoom(e,t.stages,o);const s={...o,...t,onComplete:t.onComplete||(()=>{})};this.isAnimating=!0,this.disableInterferingComponents();const l=this.storeOriginalSettings();this.applyStableSpringConfig(s);const h=this.calculateZoomParameters(e);return this.debugMode&&console.log("ðŸŽ¯ Starting stable cinematic zoom:",{currentZoom:this.viewer.viewport.getZoom(),targetZoom:h.zoom,config:s}),this.executeStableZoom(h,s,l),new Promise(m=>{this.animationEndHandlers.push(m)})}async performMultiStageZoom(e,t,n){this.isAnimating=!0,this.disableInterferingComponents();const o=this.storeOriginalSettings(),s=this.calculateZoomParameters(e),l=this.viewer.viewport.getZoom(),h=this.viewer.viewport.getCenter();let m=0;const p=()=>{if(m>=t.length){this.completeAnimation(o,{onComplete:t.onComplete});return}const v=t[m],i=m===t.length-1;let r,a;if(v.zoomFactor)r=l*v.zoomFactor;else if(v.progress!==void 0)r=l+(s.zoom-l)*v.progress;else if(i)r=s.zoom;else{const u=(m+1)/t.length;r=l+(s.zoom-l)*u}if(v.centerProgress!==void 0){const u={x:s.center.x-h.x,y:s.center.y-h.y};a=new P.Point(h.x+u.x*v.centerProgress,h.y+u.y*v.centerProgress)}else i||v.useTargetCenter?a=s.center:a=null;const d={...n,animationTime:v.duration/1e3||n.animationTime,easing:v.easing||"easeInOutCubic",onComplete:()=>{v.delay&&m<t.length-1?setTimeout(()=>{m++,p()},v.delay):(m++,p())}};this.applyStableSpringConfig(d);const f={zoom:r,center:a,currentZoom:this.viewer.viewport.getZoom()};this.debugMode&&console.log(`ðŸŽ¬ Stage ${m+1}/${t.length}:`,{zoom:f.zoom,center:a?`(${a.x.toFixed(3)}, ${a.y.toFixed(3)})`:"none",duration:v.duration||"default",easing:v.easing||"default"}),this.executeStableZoom(f,d,o)};return p(),new Promise(v=>{this.animationEndHandlers.push(v)})}disableInterferingComponents(){this.components.lowZoomOptimizer&&this.components.lowZoomOptimizer.setCinematicMode(!0),this.viewer.imageLoader&&this.viewer.imageLoader.clear(),this.components.tileCleanupManager&&this.components.tileCleanupManager.pauseCleanup(3e3),this.components.renderOptimizer&&this.components.renderOptimizer.startCinematicZoom(),this.components.predictiveTileLoader&&this.viewer.raiseEvent("animation-start")}storeOriginalSettings(){return{animationTime:this.viewer.animationTime,springStiffness:this.viewer.springStiffness,centerXTime:this.viewer.viewport.centerSpringX.animationTime,centerYTime:this.viewer.viewport.centerSpringY.animationTime,zoomTime:this.viewer.viewport.zoomSpring.animationTime,centerXStiffness:this.viewer.viewport.centerSpringX.springStiffness,centerYStiffness:this.viewer.viewport.centerSpringY.springStiffness,zoomStiffness:this.viewer.viewport.zoomSpring.springStiffness}}applyStableSpringConfig(e){this.viewer.animationTime=e.animationTime,this.viewer.springStiffness=e.springStiffness,[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].forEach(n=>{n.animationTime=e.animationTime,n.springStiffness=e.springStiffness,n.resetTo(n.current.value)}),this.viewer.viewport.applyConstraints()}calculateZoomParameters(e){const t=this.viewer.viewport,n=t.getZoom();let o;if(t.getZoomForBounds)o=t.getZoomForBounds(e);else{const l=t.getBounds(),h=l.width/e.width,m=l.height/e.height;o=Math.min(h,m)*n}const s=e.getCenter();return{zoom:o,center:new P.Point(s.x,s.y),currentZoom:n,zoomRatio:o/n}}calculateLogInterpolation(e,t,n){const o=Math.log(e),s=Math.log(t),l=o+(s-o)*n;return Math.exp(l)}getEasingFunction(e){const t={linear:n=>n,easeInOutCubic:n=>n<.5?4*n*n*n:1-Math.pow(-2*n+2,3)/2,easeOutQuart:n=>1-Math.pow(1-n,4),easeOutBack:n=>1+2.70158*Math.pow(n-1,3)+1.70158*Math.pow(n-1,2),easeInOutQuad:n=>n<.5?2*n*n:1-Math.pow(-2*n+2,2)/2};return t[e]||t.easeInOutCubic}calculateSpringProgress(e,t){const{tension:n,friction:o,mass:s}=t,l=Math.sqrt(n/s),h=o/(2*Math.sqrt(n*s));let m;if(h<1){const p=l*Math.sqrt(1-h*h);m=1-Math.exp(-h*l*e)*(Math.cos(p*e)+h*l/p*Math.sin(p*e))}else if(h===1)m=1-Math.exp(-l*e)*(1+l*e);else{const p=-l*(h-Math.sqrt(h*h-1)),v=-l*(h+Math.sqrt(h*h-1)),i=v/(v-p),r=-p/(v-p);m=1-(i*Math.exp(p*e)+r*Math.exp(v*e))}return Math.max(0,Math.min(1,m))}executeStableZoom(e,t,n){const{zoom:o,center:s,currentZoom:l}=e,m=/Android|iPhone|iPad/i.test(navigator.userAgent)?this.SPRING_PHYSICS.mobile:this.SPRING_PHYSICS.desktop,p=t.useSpringPhysics!==!1,v=performance.now(),i=this.viewer.viewport.getCenter();let r=null,a=0;const d=u=>{const g=(u-v)/1e3;let w;if(p)w=this.calculateSpringProgress(g,m);else{const b=t.animationTime*1e3,A=Math.min(g*1e3/b,1);w=this.getEasingFunction(t.easing||"easeInOutCubic")(A)}const y=this.calculateLogInterpolation(l,o,w);if(s){const b=new P.Point(i.x+(s.x-i.x)*w,i.y+(s.y-i.y)*w);this.viewer.viewport.panTo(b,!0),this.viewer.viewport.zoomTo(y,null,!0)}else this.viewer.viewport.zoomTo(y,null,!0);if(p?w>=.995&&Math.abs(w-a)<m.precision:w>=1){cancelAnimationFrame(r),this.viewer.viewport.zoomTo(o,null,!0),s&&this.viewer.viewport.panTo(s,!0),this.debugMode&&console.log("âœ… Spring physics zoom completed:",{startZoom:l,endZoom:o,duration:g*1e3,springConfig:p?m:"easing"});const b=Math.round(o);this.announceZoomChange(`Zoom completed at ${b}x magnification`),setTimeout(()=>{this.completeAnimation(n,t)},100)}else a=w,r=requestAnimationFrame(d)};r=requestAnimationFrame(d),setTimeout(()=>{r&&(cancelAnimationFrame(r),console.warn("Animation timeout - forcing completion"),this.completeAnimation(n,t))},5e3)}applyEmergencyDamping(){[this.viewer.viewport.centerSpringX,this.viewer.viewport.centerSpringY,this.viewer.viewport.zoomSpring].forEach(t=>{t.springStiffness=Math.min(t.springStiffness*1.5,20),Math.abs(t.current.value-t.target.value)<this.OSCILLATION_THRESHOLD&&t.resetTo(t.target.value)}),this.debugMode&&console.log("ðŸŸ¡ Emergency damping applied")}completeAnimation(e,t){var n,o,s;this.isAnimating=!1,this.viewer.animationTime=e.animationTime,this.viewer.springStiffness=e.springStiffness,this.viewer.viewport.centerSpringX.animationTime=e.centerXTime,this.viewer.viewport.centerSpringY.animationTime=e.centerYTime,this.viewer.viewport.zoomSpring.animationTime=e.zoomTime,this.viewer.viewport.centerSpringX.springStiffness=e.centerXStiffness,this.viewer.viewport.centerSpringY.springStiffness=e.centerYStiffness,this.viewer.viewport.zoomSpring.springStiffness=e.zoomStiffness,this.components.lowZoomOptimizer&&this.components.lowZoomOptimizer.setCinematicMode(!1),this.components.renderOptimizer&&this.components.renderOptimizer.endCinematicZoom(),this.components.predictiveTileLoader&&this.viewer.raiseEvent("animation-finish"),console.log("ðŸ” Checking renderer for reset:",{hasRenderer:!!this.components.renderer,rendererType:(o=(n=this.components.renderer)==null?void 0:n.constructor)==null?void 0:o.name,hasResetMethod:typeof((s=this.components.renderer)==null?void 0:s.resetAnimationState)=="function"}),this.components.renderer&&typeof this.components.renderer.resetAnimationState=="function"?(console.log("ðŸŽ¯ Safari Fix: Resetting renderer animation state after cinematic zoom"),this.components.renderer.resetAnimationState()):console.warn("âš ï¸ Cannot reset renderer animation state - method not available"),this.components.overlayManager&&typeof this.components.overlayManager.resetAnimationState=="function"&&(console.log("ðŸŽ¯ Safari Fix: Resetting overlay manager animation state"),this.components.overlayManager.resetAnimationState()),this.animationEndHandlers.forEach(l=>l()),this.animationEndHandlers=[],this.viewer.forceRedraw(),t.onComplete&&t.onComplete()}enableDebug(){this.debugMode=!0,console.log("ðŸ” CinematicZoomManager debug mode enabled")}getDiagnostics(){const e=[{name:"centerX",spring:this.viewer.viewport.centerSpringX},{name:"centerY",spring:this.viewer.viewport.centerSpringY},{name:"zoom",spring:this.viewer.viewport.zoomSpring}];return{isAnimating:this.isAnimating,currentZoom:this.viewer.viewport.getZoom(),springs:e.map(({name:t,spring:n})=>({name:t,current:n.current.value,target:n.target.value,velocity:Math.abs(n.current.value-n.target.value),animationTime:n.animationTime,stiffness:n.springStiffness}))}}}class ke{constructor(e){this.viewer=e,this.tileCache=new Map,this.loadQueue=[],this.isAnimating=!1,this.activeLoads=new Set,this.maxConcurrent=6,this.setupEventHandlers(),this.setupTileFadeIn()}setupEventHandlers(){this.viewer.addHandler("animation-start",()=>{this.isAnimating=!0,this.startPredictiveLoading()}),this.viewer.addHandler("animation-finish",()=>{this.isAnimating=!1,this.clearQueue()}),this.viewer.addHandler("zoom",e=>{this.isAnimating&&this.updatePredictions(e.zoom)})}startPredictiveLoading(){const e=this.viewer.viewport,t=e.getZoom(),n=e.getBounds();this.loadQueue=[],this.predictTilesForZoomRange(t,n),this.processQueue()}predictTilesForZoomRange(e,t){const n=this.viewer.source,o=[];for(let s=0;s<3;s++){const l=e*Math.pow(1.5,s+1),h=n.getClosestLevel(l);h>=0&&h<n.numberOfLevels&&o.push({level:h,zoom:l})}o.forEach(({level:s})=>{this.queueTilesForLevel(s,t)})}queueTilesForLevel(e,t){const n=this.viewer.source;if(!this.viewer.world.getItemAt(0))return;const s=1,l=n.getTileAtPoint(e,t.getTopLeft()),h=n.getTileAtPoint(e,t.getBottomRight()),m=(l.x+h.x)/2,p=(l.y+h.y)/2;for(let v=Math.max(0,l.x-s);v<=Math.min(n.getNumTiles(e).x-1,h.x+s);v++)for(let i=Math.max(0,l.y-s);i<=Math.min(n.getNumTiles(e).y-1,h.y+s);i++){const r=`${e}-${v}-${i}`;if(!this.tileCache.has(r)&&!this.isQueued(r)){const a=this.calculatePriority(v,i,m,p);this.loadQueue.push({level:e,x:v,y:i,key:r,priority:a})}}this.loadQueue.sort((v,i)=>i.priority-v.priority)}isQueued(e){return this.loadQueue.some(t=>t.key===e)}calculatePriority(e,t,n,o){return 100-Math.sqrt(Math.pow(e-n,2)+Math.pow(t-o,2))}async processQueue(){for(;this.loadQueue.length>0&&this.activeLoads.size<this.maxConcurrent;){const e=this.loadQueue.shift();if(!this.tileCache.has(e.key)){const t=this.loadTile(e);this.activeLoads.add(t),t.then(()=>{this.activeLoads.delete(t),this.isAnimating&&this.loadQueue.length>0&&this.processQueue()}).catch(n=>{console.warn(`Failed to preload tile ${e.key}:`,n),this.activeLoads.delete(t)})}}}setupTileFadeIn(){const e=P.Tile.prototype.draw;P.Tile.prototype.draw=function(t,n,o,s){if(!this.loaded)return;const l=Date.now(),h=200;this._loadedTime||(this._loadedTime=l);const m=l-this._loadedTime,p=Math.min(m/h,1);if(p<1){const v=t.globalAlpha;t.globalAlpha=v*p,e.call(this,t,n,o,s),t.globalAlpha=v,this.viewer&&this.viewer.world&&(this.viewer.world.needsDraw=!0)}else e.call(this,t,n,o,s)}}async loadTile(e){const n=this.viewer.source.getTileUrl(e.level,e.x,e.y);return new Promise((o,s)=>{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>{this.tileCache.set(e.key,l);const h=this.viewer.world.getItemAt(0);if(h&&h._tileCache){const m={image:l,loaded:!0,loading:!1};h._tileCache[e.key]=m}o(l)},l.onerror=()=>{s(new Error(`Failed to load tile: ${n}`))},l.src=n})}updatePredictions(e){if(this.lastPredictedZoom&&Math.abs(e-this.lastPredictedZoom)<.1)return;this.lastPredictedZoom=e;const t=this.viewer.viewport.getBounds();this.predictTilesForZoomRange(e,t),this.activeLoads.size<this.maxConcurrent&&this.processQueue()}clearQueue(){this.loadQueue=[]}clearCache(){this.tileCache.clear()}getCacheStats(){return{cacheSize:this.tileCache.size,queueLength:this.loadQueue.length,activeLoads:this.activeLoads.size,isAnimating:this.isAnimating}}}class Re{constructor(e){this.viewer=e,this.vignetteElement=null,this.isEnabled=!0,this.currentOpacity=0,this.reducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches;const t=/Android|iPhone|iPad/i.test(navigator.userAgent);this.isEnabled=!t&&!this.reducedMotion,this.isEnabled&&(this.createVignetteElement(),this.setupEventHandlers())}createVignetteElement(){this.vignetteElement=document.createElement("div"),this.vignetteElement.className="vignette-overlay",this.vignetteElement.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 45%,
                rgba(0,0,0,0.05) 70%,
                rgba(0,0,0,0.15) 100%
            );
            opacity: 0;
            transition: opacity 0.5s ease-out;
            z-index: 10;
            will-change: opacity;
        `,this.viewer.element.appendChild(this.vignetteElement)}setupEventHandlers(){this.viewer.addHandler("zoom",e=>{this.updateVignette(e.zoom)}),this.viewer.addHandler("animation-start",()=>{this.vignetteElement&&(this.vignetteElement.style.transition="opacity 0.3s ease-out")}),this.viewer.addHandler("animation-finish",()=>{this.vignetteElement&&(this.vignetteElement.style.transition="opacity 0.5s ease-out")}),window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{e.matches?this.disable():/Android|iPhone|iPad/i.test(navigator.userAgent)||this.enable()})}updateVignette(e){if(!this.isEnabled||!this.vignetteElement)return;const t=this.viewer.viewport.getHomeZoom(),n=this.viewer.viewport.getMaxZoom(),o=(e-t)/(n-t);let s=0;o>.1&&(s=Math.pow(o-.1,1.5)*.6,s=Math.min(s,.4)),Math.abs(s-this.currentOpacity)>.01&&(this.currentOpacity=s,requestAnimationFrame(()=>{this.vignetteElement&&(this.vignetteElement.style.opacity=s)}))}enable(){this.isEnabled=!0,this.vignetteElement||(this.createVignetteElement(),this.setupEventHandlers());const e=this.viewer.viewport.getZoom();this.updateVignette(e)}disable(){this.isEnabled=!1,this.vignetteElement&&(this.vignetteElement.style.opacity=0)}toggle(){return this.isEnabled?this.disable():this.enable(),this.isEnabled}destroy(){this.vignetteElement&&this.vignetteElement.parentNode&&(this.vignetteElement.parentNode.removeChild(this.vignetteElement),this.vignetteElement=null)}getState(){return{enabled:this.isEnabled,opacity:this.currentOpacity,reducedMotion:this.reducedMotion}}}class Fe{constructor(e){this.viewer=e,this.config={sensitivity:{low:.02,medium:.015,high:.01},thresholds:{medium:5,high:20},discreteSteps:{zoomIn:1.12,zoomOut:.89}},this.setupWheelHandler()}normalizeWheelDelta(e){let t=e.deltaY;return e.deltaMode===1?t*=40:e.deltaMode===2&&(t*=800),t}detectInputDevice(e){return!Number.isInteger(e.deltaY)||e.deltaX!==0?"trackpad":Math.abs(e.deltaY)>=50?"mouse":"trackpad"}getAdaptiveSensitivity(e){const{sensitivity:t,thresholds:n}=this.config;return e<n.medium?t.low:e<n.high?t.medium:t.high}setupWheelHandler(){const e=this.viewer.canvas;this.viewer.removeAllHandlers("canvas-scroll"),e.addEventListener("wheel",t=>{t.preventDefault();const n=this.detectInputDevice(t),o=this.viewer.viewport.getZoom(),s=e.getBoundingClientRect(),l=this.viewer.viewport.pointFromPixel(new P.Point(t.clientX-s.left,t.clientY-s.top));let h;if(n==="mouse"){const{discreteSteps:m}=this.config;let p=1;o>20&&(p=.5),t.deltaY<0?h=Math.pow(m.zoomIn,p):h=Math.pow(m.zoomOut,p)}else{const m=this.normalizeWheelDelta(t),p=this.getAdaptiveSensitivity(o);h=Math.exp(-m*p),h=Math.max(.9,Math.min(1.1,h))}this.applyZoom(h,l)},{passive:!1})}applyZoom(e,t){const n=this.viewer.viewport.getZoom(),o=n*e,s=this.viewer.viewport.getMinZoom(),l=this.viewer.viewport.getMaxZoom(),h=Math.max(s,Math.min(l,o));Math.abs(h-n)>1e-4&&(this.viewer.viewport.zoomTo(h,t,!0),this.viewer.viewport.applyConstraints(!0),this.viewer.forceRedraw())}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}destroy(){this.viewer=null}}class He{constructor(e){this.viewer=e,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const e=performance.now();return this.cacheEnabled&&this.cachedViewport&&e-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const e=performance.now(),t=this.viewer.viewport,n=t.getBounds(),o=t.viewportToImageCoordinates(n.getTopLeft()),s=t.viewportToImageCoordinates(n.getBottomRight()),l=s.x-o.x,h=s.y-o.y,m=l*this.viewportPadding,p=h*this.viewportPadding,v=this.viewer.world.getItemAt(0),i=v?v.getContentSize():{x:1,y:1},a={bounds:{minX:Math.max(0,o.x-m),minY:Math.max(0,o.y-p),maxX:Math.min(i.x,s.x+m),maxY:Math.min(i.y,s.y+p)},zoom:t.getZoom(!0),center:t.getCenter(!0),rotation:t.getRotation(),containerSize:t.getContainerSize(),imageBounds:{minX:o.x,minY:o.y,maxX:s.x,maxY:s.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=a,this.lastUpdate=performance.now();const d=this.lastUpdate-e;return this.metrics.lastUpdateDuration=d,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+d)/this.metrics.totalUpdates,a}isPointInViewport(e,t,n=!1){const o=this.getCurrentViewport(),s=n?o.bounds:o.imageBounds;return e>=s.minX&&e<=s.maxX&&t>=s.minY&&t<=s.maxY}isBoxInViewport(e,t,n,o,s=!0){const l=this.getCurrentViewport(),h=s?l.bounds:l.imageBounds;return!(n<h.minX||e>h.maxX||o<h.minY||t>h.maxY)}imageToPixel(e,t){const n=this.viewer.viewport.imageToViewportCoordinates(new P.Point(e,t));return this.viewer.viewport.pixelFromPoint(n)}pixelToImage(e,t){const n=this.viewer.viewport.pointFromPixel(new P.Point(e,t));return this.viewer.viewport.viewportToImageCoordinates(n)}calculatePixelRatio(){const e=this.viewer.viewport,t=e.getContainerSize(),n=e.getBounds(),o=this.viewer.world.getItemAt(0);if(!o)return 1;const s=o.getContentSize(),l=n.width*s.x;return t.x/l}getLevelOfDetail(){const e=this.viewer.viewport.getZoom(!0),t=this.viewer.viewport.getMaxZoom(),n=e/t;return n<.1?0:n<.3?1:n<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const e=this.getCurrentViewport(),t=this.viewer.world.getItemAt(0);if(!t)return 1;const n=t.getContentSize(),o=(e.imageBounds.maxX-e.imageBounds.minX)*(e.imageBounds.maxY-e.imageBounds.minY),s=n.x*n.y;return o/s}getMetrics(){const e=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:e.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const e=this.getCurrentViewport();return{x:e.imageBounds.minX,y:e.imageBounds.minY,width:e.imageBounds.maxX-e.imageBounds.minX,height:e.imageBounds.maxY-e.imageBounds.minY}}setCacheEnabled(e){this.cacheEnabled=e,e||(this.cachedViewport=null)}setCacheTimeout(e){this.cacheTimeout=Math.max(0,e)}setViewportPadding(e){this.viewportPadding=Math.max(0,Math.min(1,e))}destroy(){this.viewer=null,this.cachedViewport=null}}const _={qualityPreservation:{minVisibleAreaDesktop:600,minVisibleAreaMobile:400,maxZoomForQuality:15,adaptivePaddingEnabled:!0},viewer:{imageLoaderLimit:2,maxImageCacheCount:100,minPixelRatio:.8,minZoomImageRatio:.8,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:.8,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:null,animationTime:.2,springStiffness:8,blendTime:.5,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.1,zoomPerClick:1.5,minZoomLevel:.8,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:1.5,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:2,tileRetryMax:1,tileRetryDelay:50,minimumPixelsPerTile:24,artifactElimination:{enableTileCascadePrevention:!0,enableBlendingOptimization:!0,enableMouseWheelSmoothing:!0,enableProgressiveQuality:!0},compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},tiles:{tileSize:1024,overlap:2,jpegQuality:85,format:"jpeg",enableWebP:!1},hotspots:{batchSize:20,visibilityCheckInterval:150,renderDebounceTime:16,fadeInDuration:0,preloadPadding:.1,maxVisibleHotspots:20,minZoomForHotspots:4,animationBatchSize:10,animationFrameBudget:12,maxConcurrentAnimations:8},audio:{preloadCount:5,crossfadeDuration:150,bufferSize:5,html5PoolSize:5,autoUnlock:!0},viewport:{cacheEnabled:!0,cacheTimeout:8,updateDebounce:4,preloadPadding:.15},memory:{maxCachedImages:250,maxCachedAudio:8,gcInterval:2e4,lowMemoryThreshold:80,criticalMemoryThreshold:150},network:{maxConcurrentRequests:4,retryAttempts:1,retryDelay:50,timeout:45e3,useCDN:!0},mobile:{reduceQuality:!1,maxZoomLevel:20,touchSensitivity:1,doubleTapDelay:250,maxImageCacheCount:20,imageLoaderLimit:2,animationTime:.8,springStiffness:10,immediateRender:!0,blendTime:.1,maxTilesPerFrame:2,minPixelRatio:1,minZoomImageRatio:.9,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,debugMode:!1,preserveImageSizeOnResize:!0,maxZoomPixelRatio:1,constrainDuringPan:!0,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:150,flickMomentum:.05,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}},renderOptimization:{enableAdaptiveRendering:!0,animationEndDelay:25,pixelPerfectDelay:15,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:50,useWebGL:!1,forceIntegerPositions:!0,zoomOptimizations:{reduceBlendTime:!0,targetBlendTime:0,increaseStiffness:!0,targetStiffness:18,forceImmediateRender:!0,disableSmoothing:!0,reduceTilesPerFrame:!0,targetTilesPerFrame:2}},debug:{showFPS:!1,showMetrics:!0,logPerformance:!1,warnThreshold:{fps:45,renderTime:20,visibleHotspots:100}}},Ze=()=>{var t;const c=navigator.userAgent.toLowerCase(),e=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(c),isChrome:/chrome|crios/i.test(c)&&!/edge|edg/i.test(c),isFirefox:/firefox|fxios/i.test(c),isEdge:/edge|edg/i.test(c),isIOS:/ipad|iphone|ipod/.test(c)||e==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(c),isMac:/mac/.test(e),isWindows:/win/.test(e),isMobile:/android|iphone|ipad|ipod/i.test(c)||e==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(c)||e==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((t=navigator.connection)==null?void 0:t.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},De=()=>{const c=Ze();return(c.isSafari||c.isIOS)&&(_.viewer.drawer="canvas",c.isSafari&&!c.isIOS&&(_.viewer.imageLoaderLimit=c.isHighEndDevice?4:2,_.viewer.maxImageCacheCount=100,_.viewer.maxTilesPerFrame=3,_.viewer.animationTime=1,_.viewer.springStiffness=7,_.viewer.blendTime=0,_.viewer.minPixelRatio=.5,_.viewer.immediateRender=!0),c.isIOS&&(_.viewer.imageLoaderLimit=1,_.viewer.maxImageCacheCount=50,_.viewer.maxTilesPerFrame=1,_.viewer.animationTime=.8,_.viewer.springStiffness=8,_.viewer.blendTime=0,_.viewer.minPixelRatio=.8,_.viewer.immediateRender=!0,_.viewer.alwaysBlend=!1,_.viewer.gestureSettingsTouch={flickEnabled:!0,flickMinSpeed:120,flickMomentum:.35,pinchRotate:!1}),_.viewer.imageSmoothingEnabled=!1,_.viewer.smoothTileEdgesMinZoom=1/0,_.viewer.updatePixelDensityRatio=!1,_.viewer.placeholderFillStyle=null,_.viewer.opacity=1,_.viewer.preload=!1,_.viewer.compositeOperation=null,_.viewer.subPixelRoundingForTransparency="NEVER",console.log("Safari detected - applied research-based 50-60 FPS optimizations",{platform:c.isIOS?"iOS":"Desktop",imageLoaderLimit:_.viewer.imageLoaderLimit,blendTime:_.viewer.blendTime})),c.isAndroid&&(_.viewer.drawer="canvas",_.viewer.imageSmoothingEnabled=!1,console.log("Android detected - applying STEP 4 optimizations")),c.isMobile&&(Object.assign(_.viewer,{drawer:"canvas",imageLoaderLimit:1,maxImageCacheCount:_.mobile.maxImageCacheCount,animationTime:.2,springStiffness:10,immediateRender:!0,blendTime:0,smoothImageZoom:!1,maxTilesPerFrame:1,visibilityRatio:1,minPixelRatio:1,minZoomImageRatio:.9,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,preserveImageSizeOnResize:!0,maxZoomPixelRatio:1,imageSmoothingEnabled:!1,updatePixelDensityRatio:!1,constrainDuringPan:!0,subPixelRendering:!1,minimumPixelsPerTile:40,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:150,flickMomentum:.05,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),_.hotspots.batchSize=15,_.hotspots.maxVisibleHotspots=15,_.hotspots.renderDebounceTime=8,_.memory.maxCachedImages=30,console.log("Mobile device detected - applied STEP 4 ultra-aggressive optimizations")),c.isLowEndDevice&&(_.viewer.animationTime=.15,_.viewer.springStiffness=18,_.viewer.maxImageCacheCount=Math.min(100,_.viewer.maxImageCacheCount),_.viewer.imageLoaderLimit=1,_.viewer.maxTilesPerFrame=1,_.memory.maxCachedImages=100,_.network.maxConcurrentRequests=2,_.hotspots.maxVisibleHotspots=30,_.viewer.minPixelRatio=.8,console.log("Low-end device detected - applied STEP 4 ultra-conservative settings")),c.isHighEndDevice&&!c.isMobile&&(_.viewer.maxImageCacheCount=600,_.viewer.imageLoaderLimit=6,_.viewer.maxTilesPerFrame=4,_.memory.maxCachedImages=400,_.network.maxConcurrentRequests=6,_.viewer.minPixelRatio=.4,_.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - applied STEP 4 balanced performance/quality")),c.isHighDPI&&!c.isMobile&&(_.viewer.minPixelRatio=Math.min(.5,_.viewer.minPixelRatio),_.viewer.maxZoomPixelRatio=Math.max(4,c.pixelRatio*2)),(c.connectionType==="slow-2g"||c.connectionType==="2g")&&(_.viewer.imageLoaderLimit=1,_.network.maxConcurrentRequests=1,_.viewer.timeout=9e4,console.log("Slow connection detected - applied STEP 4 minimal network usage")),c},X=De();function Ne(c,e){const t=_,n=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent),o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),s=o&&!n;let l,h,m;if(s?(l=8,h=12,m=20):n?(l=10,h=15,m=25):(l=20,h=25,m=35),c<l&&c>0)return o?(t.viewer.imageLoaderLimit=1,t.viewer.maxTilesPerFrame=1,t.viewer.blendTime=0,t.viewer.maxImageCacheCount=25,t.viewer.minPixelRatio=1.2,t.viewer.immediateRender=!0,t.viewer.animationTime=.5,t.viewer.springStiffness=10):(t.viewer.imageLoaderLimit=1,t.viewer.maxTilesPerFrame=1,t.viewer.animationTime=.1,t.viewer.springStiffness=20,t.viewer.immediateRender=!0,t.viewer.blendTime=0,t.viewer.maxImageCacheCount=25,t.viewer.minPixelRatio=1),console.error("SAFARI FIX: Emergency performance mode activated"),"ultra-emergency";if(c<h&&c>0)return t.viewer.imageLoaderLimit=1,t.viewer.maxTilesPerFrame=1,t.viewer.animationTime=.4,t.viewer.springStiffness=12,t.viewer.immediateRender=!0,t.viewer.blendTime=.05,t.viewer.maxImageCacheCount=60,t.viewer.minPixelRatio=.8,console.warn("Critical performance mode activated"),"critical";if(c<m&&c>0)return t.viewer.imageLoaderLimit=Math.max(1,t.viewer.imageLoaderLimit-1),t.viewer.maxTilesPerFrame=Math.max(1,t.viewer.maxTilesPerFrame-1),t.viewer.animationTime=.25,t.viewer.springStiffness=12,"reduced";if(c>55){const p=X.isHighEndDevice?6:X.isMobile?1:4;return t.viewer.imageLoaderLimit<p&&(t.viewer.imageLoaderLimit=Math.min(p,t.viewer.imageLoaderLimit+1)),t.viewer.maxTilesPerFrame<3&&(t.viewer.maxTilesPerFrame=Math.min(3,t.viewer.maxTilesPerFrame+1)),t.viewer.animationTime=X.isMobile?.2:.3,t.viewer.springStiffness=X.isMobile?15:12,t.viewer.minPixelRatio=X.isMobile?.8:.5,"normal"}return e>t.memory.criticalMemoryThreshold?(t.viewer.maxImageCacheCount=Math.max(25,Math.floor(t.viewer.maxImageCacheCount*.4)),t.hotspots.maxVisibleHotspots=Math.max(10,Math.floor(t.hotspots.maxVisibleHotspots*.5)),console.warn(`STEP 4: High memory usage: ${e}MB - Applied aggressive reduction`),"memory-limited"):"normal"}const Be=(c,e,t,n,o=null)=>(n&&(c.animationTime=.2,c.springStiffness=8,c.blendTime=0,c.immediateRender=!0,c.imageLoaderLimit=2,c.maxImageCacheCount=50,c.visibilityRatio=.8,c.maxTilesPerFrame=2,c.alwaysBlend=!1,c.constrainDuringPan=!0,c.maxZoomPixelRatio=1.5,c.imageSmoothingEnabled=!1,c.updatePixelDensityRatio=!1,c.subPixelRendering=!1,c.minimumPixelsPerTile=32,console.log("Applied research-based mobile optimizations for zoom performance")),{tileSources:o||e,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:t,imageSmoothingEnabled:c.imageSmoothingEnabled,smoothTileEdgesMinZoom:c.smoothTileEdgesMinZoom,alwaysBlend:c.alwaysBlend,placeholderFillStyle:c.placeholderFillStyle,opacity:1,preload:c.preload,compositeOperation:c.compositeOperation,...c.drawer==="webgl"?{webglOptions:c.webglOptions}:{},immediateRender:c.immediateRender,imageLoaderLimit:c.imageLoaderLimit,maxImageCacheCount:c.maxImageCacheCount,timeout:c.timeout,loadTilesWithAjax:c.loadTilesWithAjax,ajaxHeaders:c.ajaxHeaders,visibilityRatio:c.visibilityRatio,minPixelRatio:c.minPixelRatio,defaultZoomLevel:c.defaultZoomLevel,minZoomLevel:c.minZoomLevel,maxZoomPixelRatio:c.maxZoomPixelRatio,constrainDuringPan:c.constrainDuringPan,wrapHorizontal:c.wrapHorizontal,wrapVertical:c.wrapVertical,animationTime:.2,springStiffness:20,blendTime:.1,zoomPerScroll:n?1.2:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:c.flickEnabled,flickMinSpeed:c.flickMinSpeed,flickMomentum:c.flickMomentum,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:c.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:c.preserveImageSizeOnResize,maxTilesPerFrame:c.maxTilesPerFrame,smoothImageZoom:c.smoothImageZoom,subPixelRendering:c.subPixelRendering!==void 0?c.subPixelRendering:!1,minimumPixelsPerTile:c.minimumPixelsPerTile||(n?32:24),updatePixelDensityRatio:c.updatePixelDensityRatio!==void 0?c.updatePixelDensityRatio:!1,smoothTileEdgesMinZoom:n?1/0:c.smoothTileEdgesMinZoom,imageSmoothingEnabled:c.imageSmoothingEnabled!==void 0?c.imageSmoothingEnabled:!n});let k=null;async function Ve(){if(k)return k;try{return k=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${k.length} hotspots`),k}catch(c){return console.error("Failed to load hotspots:",c),k=[],k}}function Ye(c){if(c){if(console.log("Forcing viewer state reset to fix flickering..."),c.world){const e=c.world.getItemCount();for(let t=0;t<e;t++){const n=c.world.getItemAt(t);n&&n.reset()}}c.viewport.centerSpringX.resetTo(c.viewport.centerSpringX.target.value),c.viewport.centerSpringY.resetTo(c.viewport.centerSpringY.target.value),c.viewport.zoomSpring.resetTo(c.viewport.zoomSpring.target.value),c.viewport.applyConstraints(!0),c.forceRedraw(),setTimeout(()=>c.forceRedraw(),50),setTimeout(()=>c.forceRedraw(),100),console.log("Viewer state reset completed")}}async function Xe(c,e,t,n){var E,L,R,Z,z,W,ee,te;console.log("initializeViewer called with:",{viewerRef:c,props:e,state:!!t,handleHotspotClick:!!n});const o={};let s=null;const l=_.viewer,h=`/images/tiles/${e.artworkId}_1024/${e.artworkId}.dzi`,m={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${e.artworkId}_1024/${e.artworkId}_files/`,Format:"jpg",Overlap:"2",TileSize:"1024",Size:{Width:"11244",Height:"6543"}},minLevel:8,maxLevel:14},p=ce(),v=de(),i=Be(l,m,v,p,m);console.log("[viewerSetup] Creating viewer WITHOUT tileSources to ensure handlers attach first");const r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),a=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;i.drawer="canvas",i.smoothTileEdgesMinZoom=1/0,i.immediateRender=!0,i.imageSmoothingEnabled=!0,i.updatePixelDensityRatio=!1,i.subPixelRendering=!1,i.blendTime=.5,i.alwaysBlend=!1,console.log("BALANCED: Canvas drawer with optimized smoothing management"),console.log("RESEARCH VERIFICATION: Creating viewer with settings:",{drawer:i.drawer,imageLoaderLimit:i.imageLoaderLimit,maxTilesPerFrame:i.maxTilesPerFrame,immediateRender:i.immediateRender,animationTime:i.animationTime,springStiffness:i.springStiffness,isMobile:p}),console.log("Creating OpenSeadragon viewer with config:",i);const d=P({element:c,...i,updatePixelDensityRatio:!1,drawer:p||r||a?"canvas":i.drawer});console.log("Applying TileCascadeFix for stable tile rendering..."),J(P),await new Promise(x=>setTimeout(x,50));const f={setIsLoading:x=>{console.log(`[viewerSetup] Calling setIsLoading(${x})`),t.setIsLoading(x)},setViewerReady:x=>{console.log(`[viewerSetup] Calling setViewerReady(${x})`),t.setViewerReady(x)}};console.log("[viewerSetup] Current state before open handler:",{isLoading:t.isLoading(),viewerReady:t.viewerReady()}),d.addHandler("open",()=>{console.log("[viewerSetup] OpenSeadragon open event fired!"),console.log("[viewerSetup] Current loading state in handler:",t.isLoading());try{const x=d.world.getItemAt(0);if(x){const I=x.getBounds();s=d.viewport.getHomeBounds(),console.log("[viewerSetup] Home viewport stored:",s),console.log("[viewerSetup] About to set isLoading to false"),x.getFullyLoaded()?(console.log("[viewerSetup] Tiles fully loaded - hiding loading screen immediately"),f.setIsLoading(!1),f.setViewerReady(!0)):(console.log("[viewerSetup] Waiting for tiles to fully load..."),x.addOnceHandler("fully-loaded-change",()=>{console.log("[viewerSetup] Tiles now fully loaded - hiding loading screen"),f.setIsLoading(!1),f.setViewerReady(!0)}),setTimeout(()=>{t.isLoading()&&(console.warn("[viewerSetup] Forcing loading screen hide after 2s wait"),f.setIsLoading(!1),f.setViewerReady(!0))},2e3))}else console.error("[viewerSetup] No tiled image found!"),f.setIsLoading(!1),f.setViewerReady(!0)}catch(x){console.error("[viewerSetup] Error in open handler:",x),f.setIsLoading(!1),f.setViewerReady(!0)}}),d.addHandler("open-failed",x=>{console.error("OpenSeadragon open-failed event:",x),t.setIsLoading(!1)}),d.addHandler("tile-load-failed",x=>{console.error("Tile load failed:",x.tile,x.message)}),d.drawer&&(d.drawer.imageSmoothingEnabled=!0,d.drawer.context&&(d.drawer.context.imageSmoothingEnabled=!0,d.drawer.context.webkitImageSmoothingEnabled=!0,d.drawer.context.mozImageSmoothingEnabled=!0,d.drawer.context.msImageSmoothingEnabled=!0));const u={spatialIndex:new Ie,viewportManager:new He(d),audioEngine:new ue,performanceMonitor:new _e(d),renderOptimizer:new ye(d),tileOptimizer:new Ee(d),memoryManager:new fe(d),tileCleanupManager:new Oe(d),imageOverlayManager:new pe,overlayManager:ne.createWithOverride(d),lowZoomOptimizer:new ge(d,p),safariPerformanceOptimizer:new Te(d),mouseWheelSmoothing:new ve(d,(E=G().enableMouseWheelSmoothing)!=null&&E.value?{throttleMs:((L=G().wheelEventThrottleMs)==null?void 0:L.value)||16,zoomStep:((R=G().wheelZoomStep)==null?void 0:R.value)||.02,enabled:((Z=G().enableMouseWheelSmoothing)==null?void 0:Z.value)!==!1}:{enabled:!1})};u.tileOptimizer.state.isActive=!1,setTimeout(()=>{u.tileOptimizer.state.isActive=!0},1e3);const g=new Le(d,u);u.cinematicZoomManager=g;const w=new ke(d);u.predictiveTileLoader=w;const y=new Re(d);u.vignetteOverlay=y;const T=new Fe(d);u.immediateZoomHandler=T,window.cinematicZoomManager=g,window.predictiveTileLoader=w,window.vignetteOverlay=y,window.immediateZoomHandler=T,t.debugLevel()>=1&&g.enableDebug(),t.setComponents(u),window.performanceMetrics=t.performanceMetrics,console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!u.overlayManager),console.log("Does it have initialize method?",typeof((z=u.overlayManager)==null?void 0:z.initialize)),u.overlayManager.initialize(),console.log("Overlay manager initialized"),console.log("Is initialized flag:",(W=u.overlayManager)==null?void 0:W.isInitialized),console.log("Overlay element created?",!!((ee=u.overlayManager)!=null&&ee.overlayElement));const b=ne.getCurrentType();b&&b!==t.currentOverlayType()&&(console.log("Updating overlay type signal to match actual:",b),t.setCurrentOverlayType(b)),window.overlayManager=u.overlayManager,console.log("Overlay manager set on window:",(te=window.overlayManager)==null?void 0:te.constructor.name),window.audioEngine=u.audioEngine,u.audioEngine.onPlaybackEnd=x=>{console.log(`Finished playing audio for hotspot ${x}`)};const A=await Ve();u.spatialIndex.loadHotspots(A),u.imageOverlayManager.loadHotspots(A),window.viewer=d,window.performanceMonitor=u.performanceMonitor,window.tileOptimizer=u.tileOptimizer,window.tileCleanupManager=u.tileCleanupManager,window.lowZoomOptimizer=u.lowZoomOptimizer,window.safariPerformanceOptimizer=u.safariPerformanceOptimizer,window.performanceConfig=_,$e(d),he(d,_),setTimeout(()=>{var I;const x=(I=d.drawer)!=null&&I.getType?d.drawer.getType():"unknown";console.log("RESEARCH VERIFICATION: Actual drawer in use:",x),(p||r||a)&&x!=="canvas"?console.error("CRITICAL: Canvas drawer not applied! Performance will be poor."):(p||r||a)&&x==="canvas"&&console.log("SUCCESS: Canvas drawer confirmed for mobile/Safari - performance should be optimal")},100),u.performanceMonitor.start(),u.memoryManager.start(),u.tileOptimizer.start(),u.tileCleanupManager.start(),u.lowZoomOptimizer.enable();const C=setInterval(()=>{var x;if(u.performanceMonitor&&u.performanceMonitor.isMonitoring){const I=u.performanceMonitor.getMetrics();t.setPerformanceMetrics(I);const ie=d.viewport.getZoom()>=1.8;if(ie&&!t.showExpandButton()?(t.setExpandButtonFading(!1),t.setShowExpandButton(!0)):!ie&&t.showExpandButton()&&!t.expandButtonFading()&&(t.setExpandButtonFading(!0),setTimeout(()=>{t.setShowExpandButton(!1),t.setExpandButtonFading(!1)},300)),window.nativeHotspotRenderer&&typeof window.nativeHotspotRenderer.getPerformanceMetrics=="function")try{const D=window.nativeHotspotRenderer.getPerformanceMetrics();D&&window.nativeHotspotRenderer.constructor.name==="WebGLHotspotRenderer"&&(console.log("WebGL metrics update:",D),t.setSafariHybridMetrics(D))}catch(D){console.error("Error getting WebGL metrics:",D)}else((x=window.nativeHotspotRenderer)==null?void 0:x.constructor.name)!=="WebGLHotspotRenderer"&&t.setSafariHybridMetrics(null);u.lowZoomOptimizer&&I.averageFPS>0&&u.lowZoomOptimizer.monitorPerformance(I.averageFPS),u.safariPerformanceOptimizer&&I.averageFPS>0&&u.safariPerformanceOptimizer.updatePerformanceMetrics(I.averageFPS),I.averageFPS<30&&p?console.warn(`RESEARCH: Low mobile FPS detected (${I.averageFPS}). Verify canvas drawer is active.`):I.averageFPS>=50&&console.log(`RESEARCH: Good performance achieved (${I.averageFPS} FPS)`)}},500);o.performanceUpdate=C,u.performanceMonitor.disableDebugOverlay(),d.viewport.centerSpringX.animationTime=_.viewer.animationTime,d.viewport.centerSpringY.animationTime=_.viewer.animationTime,d.viewport.zoomSpring.animationTime=_.viewer.animationTime,d.viewport.centerSpringX.springStiffness=_.viewer.springStiffness,d.viewport.centerSpringY.springStiffness=_.viewer.springStiffness,d.viewport.zoomSpring.springStiffness=_.viewer.springStiffness;const M=await me(()=>import("./viewerEventHandlers-D91abJ9u.js"),__vite__mapDeps([0,1,2]));M.setupViewerEventHandlers(d,t,u,n,A),M.setupAdaptiveSprings(d,_);const S=M.setupKeyboardHandler(d,t,u);return o.handleKeyPress=S,M.setupResizeObserver(c,d,t),console.log("[viewerSetup] All handlers attached, now opening viewer with tileSources:",h),d.open(h),setTimeout(()=>{console.log("[viewerSetup] Forcing initial redraw to ensure clean state"),d.forceRedraw(),d.viewport.centerSpringX.resetTo(d.viewport.centerSpringX.target.value),d.viewport.centerSpringY.resetTo(d.viewport.centerSpringY.target.value),d.viewport.zoomSpring.resetTo(d.viewport.zoomSpring.target.value),d.forceRedraw()},500),console.log("Returning from initializeViewer:",{viewer:!!d,intervals:!!o,homeViewport:!!s}),{viewer:d,intervals:o,homeViewport:s}}function $e(c){window.forceSmoothingOn=function(){if(console.log("âœ… FORCING SMOOTHING ON"),c&&c.drawer){if(c.drawer.imageSmoothingEnabled=!0,c.drawer.context){const e=c.drawer.context;e.imageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.msImageSmoothingEnabled=!0,console.log("âœ… Canvas context smoothing enabled")}c.canvas&&(c.canvas.style.imageRendering="auto",console.log("âœ… CSS rendering set to auto")),c.forceRedraw(),console.log("âœ… Forced redraw with smoothing enabled"),c.drawer.context&&console.log("Current imageSmoothingEnabled:",c.drawer.context.imageSmoothingEnabled)}else console.error("âŒ Viewer or drawer not available")},window.checkSmoothingState=function(){console.group("ðŸ§ª SMOOTHING STATE DIAGNOSTIC"),c&&c.drawer?(console.log("Drawer type:",c.drawer.getType?c.drawer.getType():"unknown"),console.log("Drawer imageSmoothingEnabled:",c.drawer.imageSmoothingEnabled),c.drawer.context?(console.log("Context imageSmoothingEnabled:",c.drawer.context.imageSmoothingEnabled),console.log("Context webkitImageSmoothingEnabled:",c.drawer.context.webkitImageSmoothingEnabled),console.log("Context mozImageSmoothingEnabled:",c.drawer.context.mozImageSmoothingEnabled),console.log("Context msImageSmoothingEnabled:",c.drawer.context.msImageSmoothingEnabled)):console.warn("No context available"),c.canvas&&console.log("Canvas style.imageRendering:",c.canvas.style.imageRendering),console.log(`
Configuration:`),console.log("imageSmoothingEnabled config:",c.imageSmoothingEnabled),console.log("smoothTileEdgesMinZoom:",c.smoothTileEdgesMinZoom),console.log("blendTime:",c.blendTime),console.log("alwaysBlend:",c.alwaysBlend),console.log("immediateRender:",c.immediateRender)):console.error("Viewer or drawer not available"),console.groupEnd()},window.toggleTileCascadeFix=function(e){e?(console.log("ðŸ” Enabling TileCascadeFix..."),J(P),console.log("âœ… TileCascadeFix enabled - single tile level (may cause zoom artifacts)")):(console.log("ðŸ”“ Disabling TileCascadeFix..."),oe(P),console.log("âœ… TileCascadeFix disabled - smooth blending enabled")),c.forceRedraw()},window.applyBalancedSmoothingConfig=function(){console.group("ðŸŽ¯ APPLYING BALANCED SMOOTHING CONFIG"),console.log("1ï¸âƒ£ Ensuring image smoothing is enabled..."),window.forceSmoothingOn(),console.log("2ï¸âƒ£ Disabling TileCascadeFix for smooth zoom..."),window.toggleTileCascadeFix(!1),console.log("3ï¸âƒ£ Checking blend time..."),c&&console.log("Current blendTime:",c.blendTime||.5),console.log("4ï¸âƒ£ Verifying smoothing state..."),window.checkSmoothingState(),console.log(`
âœ… BALANCED CONFIG APPLIED!`),console.log("ðŸ–¼ï¸ Smooth rendering with tile blending enabled"),console.log("ðŸ” Test by zooming in/out"),console.log("ðŸ“Š If artifacts persist, try toggleTileCascadeFix(true)"),console.groupEnd()},window.getCinematicZoomDiagnostics=function(){return window.cinematicZoomManager?window.cinematicZoomManager.getDiagnostics():(console.error("CinematicZoomManager not initialized"),null)},window.fixFlickering=function(){console.log("Applying manual flickering fix..."),Ye(c),oe(P),setTimeout(()=>{J(P),c.forceRedraw(),console.log("Flickering fix applied")},100)},window.testSafariOptimizer=function(){if(!window.safariPerformanceOptimizer){console.error("SafariPerformanceOptimizer not initialized");return}const e=window.safariPerformanceOptimizer;console.group("ðŸŽ¯ SAFARI PERFORMANCE OPTIMIZER TEST");const t=e.getState();console.table(t),console.log(`
ðŸ“Š Testing dynamic resolution scaling...`),console.log("1ï¸âƒ£ Forcing optimization ON"),e.forceOptimization(!0),setTimeout(()=>{console.log("Current pixel ratio:",c.viewport.getPixelRatio()),console.log("Expected:",t.basePixelRatio*e.scalingFactor),console.log(`
2ï¸âƒ£ Forcing optimization OFF`),e.forceOptimization(!1),setTimeout(()=>{console.log("Current pixel ratio:",c.viewport.getPixelRatio()),console.log("Expected:",t.basePixelRatio),console.log(`
âœ… Test complete! Try zooming/panning to see dynamic scaling.`),console.groupEnd()},500)},100)},window.getSafariOptimizerState=function(){return window.safariPerformanceOptimizer?window.safariPerformanceOptimizer.getState():(console.error("SafariPerformanceOptimizer not initialized"),null)}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,initializeViewer:Xe},Symbol.toStringTag,{value:"Module"}));export{Ne as a,V as o,_ as p,Qe as v};
