var ku=Object.defineProperty;var Ou=(s,t,e)=>t in s?ku(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var An=(s,t,e)=>Ou(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const Fu=!1,Lu=(s,t)=>s===t,Vu=Symbol("solid-track"),fs={equals:Lu};let Ec=Ac;const tn=1,ms=2,Sc={owned:null,cleanups:null,context:null,owner:null};var Tt=null;let no=null,Bu=null,mt=null,Ut=null,Di=null,Os=0;function os(s,t){const e=mt,i=Tt,n=s.length===0,r=t===void 0?i:t,o=n?Sc:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>Mi(()=>xr(o)));Tt=o,mt=null;try{return Or(a,!0)}finally{mt=e,Tt=i}}function pe(s,t){t=t?Object.assign({},fs,t):fs;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),Cc(e,n));return[Pc.bind(e),i]}function $e(s,t,e){const i=qo(s,t,!1,tn);kr(i)}function dn(s,t,e){Ec=zu;const i=qo(s,t,!1,tn);i.user=!0,Di?Di.push(i):kr(i)}function vr(s,t,e){e=e?Object.assign({},fs,e):fs;const i=qo(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,kr(i),Pc.bind(i)}function Mi(s){if(mt===null)return s();const t=mt;mt=null;try{return s()}finally{mt=t}}function jo(s){dn(()=>Mi(s))}function Un(s){return Tt===null||(Tt.cleanups===null?Tt.cleanups=[s]:Tt.cleanups.push(s)),s}function Pc(){if(this.sources&&this.state)if(this.state===tn)kr(this);else{const s=Ut;Ut=null,Or(()=>vs(this),!1),Ut=s}if(mt){const s=this.observers?this.observers.length:0;mt.sources?(mt.sources.push(this),mt.sourceSlots.push(s)):(mt.sources=[this],mt.sourceSlots=[s]),this.observers?(this.observers.push(mt),this.observerSlots.push(mt.sources.length-1)):(this.observers=[mt],this.observerSlots=[mt.sources.length-1])}return this.value}function Cc(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&Or(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=no&&no.running;o&&no.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?Ut.push(r):Di.push(r),r.observers&&Rc(r)),o||(r.state=tn)}if(Ut.length>1e6)throw Ut=[],new Error},!1)),t}function kr(s){if(!s.fn)return;xr(s);const t=Os;Nu(s,s.value,t)}function Nu(s,t,e){let i;const n=Tt,r=mt;mt=Tt=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=tn,s.owned&&s.owned.forEach(xr),s.owned=null),s.updatedAt=e+1,Ic(o)}finally{mt=r,Tt=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?Cc(s,i):s.value=i,s.updatedAt=e)}function qo(s,t,e,i=tn,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:Tt,context:Tt?Tt.context:null,pure:e};return Tt===null||Tt!==Sc&&(Tt.owned?Tt.owned.push(r):Tt.owned=[r]),r}function gs(s){if(s.state===0)return;if(s.state===ms)return vs(s);if(s.suspense&&Mi(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<Os);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===tn)kr(s);else if(s.state===ms){const i=Ut;Ut=null,Or(()=>vs(s,t[0]),!1),Ut=i}}function Or(s,t){if(Ut)return s();let e=!1;t||(Ut=[]),Di?e=!0:Di=[],Os++;try{const i=s();return Hu(e),i}catch(i){e||(Di=null),Ut=null,Ic(i)}}function Hu(s){if(Ut&&(Ac(Ut),Ut=null),s)return;const t=Di;Di=null,t.length&&Or(()=>Ec(t),!1)}function Ac(s){for(let t=0;t<s.length;t++)gs(s[t])}function zu(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:gs(i)}for(t=0;t<e;t++)gs(s[t])}function vs(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===tn?i!==t&&(!i.updatedAt||i.updatedAt<Os)&&gs(i):n===ms&&vs(i,t)}}}function Rc(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=ms,e.pure?Ut.push(e):Di.push(e),e.observers&&Rc(e))}}function xr(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)xr(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)xr(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function Uu(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function Ic(s,t=Tt){throw Uu(s)}const ju=Symbol("fallback");function el(s){for(let t=0;t<s.length;t++)s[t]()}function qu(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return Un(()=>el(r)),()=>{let c=s()||[],h=c.length,d,l;return c[Vu],Mi(()=>{let f,m,v,w,T,A,F,H,q;if(h===0)o!==0&&(el(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[ju],n[0]=os(J=>(r[0]=J,e.fallback())),o=1);else if(o===0){for(n=new Array(h),l=0;l<h;l++)i[l]=c[l],n[l]=os(p);o=h}else{for(v=new Array(h),w=new Array(h),a&&(T=new Array(h)),A=0,F=Math.min(o,h);A<F&&i[A]===c[A];A++);for(F=o-1,H=h-1;F>=A&&H>=A&&i[F]===c[H];F--,H--)v[H]=n[F],w[H]=r[F],a&&(T[H]=a[F]);for(f=new Map,m=new Array(H+1),l=H;l>=A;l--)q=c[l],d=f.get(q),m[l]=d===void 0?-1:d,f.set(q,l);for(d=A;d<=F;d++)q=i[d],l=f.get(q),l!==void 0&&l!==-1?(v[l]=n[d],w[l]=r[d],a&&(T[l]=a[d]),l=m[l],f.set(q,l)):r[d]();for(l=A;l<h;l++)l in v?(n[l]=v[l],r[l]=w[l],a&&(a[l]=T[l],a[l](l))):n[l]=os(p);n=n.slice(0,o=h),i=c.slice(0)}return n});function p(f){if(r[l]=f,a){const[m,v]=pe(l);return a[l]=v,t(c[l],m)}return t(c[l])}}}function be(s,t){return Mi(()=>s(t||{}))}const Wu=s=>`Stale read from <${s}>.`;function Gu(s){const t="fallback"in s&&{fallback:()=>s.fallback};return vr(qu(()=>s.each,s.children,t||void 0))}function qe(s){const t=s.keyed,e=vr(()=>s.when,void 0,void 0),i=t?e:vr(e,void 0,{equals:(n,r)=>!n==!r});return vr(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?Mi(()=>r(t?n:()=>{if(!Mi(i))throw Wu("Show");return e()})):r}return s.fallback},void 0,void 0)}const Rt=s=>vr(()=>s());function Zu(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,c=t[n-1].nextSibling,h=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const d=r<i?a?e[a-1].nextSibling:e[r-a]:c;for(;a<r;)s.insertBefore(e[a++],d)}else if(r===a)for(;o<n;)(!h||!h.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const d=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],d),t[n]=e[r]}else{if(!h){h=new Map;let l=a;for(;l<r;)h.set(e[l],l++)}const d=h.get(t[o]);if(d!=null)if(a<d&&d<r){let l=o,p=1,f;for(;++l<n&&l<r&&!((f=h.get(t[l]))==null||f!==d+p);)p++;if(p>d-a){const m=t[o];for(;a<d;)s.insertBefore(e[a++],m)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const tl="_$DX_DELEGATE";function Xu(s,t,e,i={}){let n;return os(r=>{n=r,t===document?s():ie(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function Y(s,t,e,i){let n;const r=()=>{const a=i?document.createElementNS("http://www.w3.org/1998/Math/MathML","template"):document.createElement("template");return a.innerHTML=s,e?a.content.firstChild.firstChild:i?a.firstChild:a.content.firstChild},o=t?()=>Mi(()=>document.importNode(n||(n=r()),!0)):()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function Yn(s,t=window.document){const e=t[tl]||(t[tl]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,Qu))}}function Yt(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function Bn(s,t){t==null?s.removeAttribute("class"):s.className=t}function Dc(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function as(s,t,e){if(!t)return e?Yt(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function Yu(s,t,e){return Mi(()=>s(t,e))}function ie(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return ys(s,t,i,e);$e(n=>ys(s,t(),n,e),i)}function Qu(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=c=>Object.defineProperty(s,"target",{configurable:!0,value:c}),o=()=>{const c=t[e];if(c&&!t.disabled){const h=t[`${e}Data`];if(h!==void 0?c.call(t,h,s):c.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const c=s.composedPath();r(c[0]);for(let h=0;h<c.length-2&&(t=c[h],!!o());h++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function ys(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=Rn(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=Rn(s,e,i);else{if(r==="function")return $e(()=>{let a=t();for(;typeof a=="function";)a=a();e=ys(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],c=e&&Array.isArray(e);if(vo(a,t,e,n))return $e(()=>e=ys(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=Rn(s,e,i),o)return e}else c?e.length===0?il(s,a,i):Zu(s,e,a):(e&&Rn(s),il(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=Rn(s,e,i,t);Rn(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function vo(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],c=e&&e[s.length],h;if(!(a==null||a===!0||a===!1))if((h=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=vo(s,a,c)||n;else if(h==="function")if(i){for(;typeof a=="function";)a=a();n=vo(s,Array.isArray(a)?a:[a],Array.isArray(c)?c:[c])||n}else s.push(a),n=!0;else{const d=String(a);c&&c.nodeType===3&&c.data===d?s.push(c):s.push(document.createTextNode(d))}}return n}function il(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function Rn(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const c=a.parentNode===s;!r&&!o?c?s.replaceChild(n,a):s.insertBefore(n,e):c&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}var Mn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ku(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Mc={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var c in o)a=c;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,c=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/c}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var c,h,d,l,p,f,m=arguments[0]||{},v=arguments.length,w=!1,T=1;for(typeof m=="boolean"&&(w=m,m=arguments[1]||{},T=2),typeof m!="object"&&!t.isFunction(m)&&(m={}),v===T&&(m=this,--T);T<v;T++)if(c=arguments[T],c!==null||c!==void 0)for(h in c){var A=Object.getOwnPropertyDescriptor(c,h);if(A!==void 0){if(A.get||A.set){Object.defineProperty(m,h,A);continue}l=A.value}else{e.console.warn('Could not copy inherited property "'+h+'".');continue}m!==l&&(w&&l&&(t.isPlainObject(l)||(p=t.isArray(l)))?(d=m[h],p?(p=!1,f=d&&t.isArray(d)?d:[]):f=d&&t.isPlainObject(d)?d:{},m[h]=t.extend(w,f,l)):l!==void 0&&(m[h]=l))}return m};var i=function(){if(typeof navigator!="object")return!1;var c=navigator.userAgent;return typeof c!="string"?!1:c.indexOf("iPhone")!==-1||c.indexOf("iPad")!==-1||c.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(c,h){return function(){var d=arguments;return d===void 0&&(d=[]),h.apply(c,d)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(c){return e._viewers.get(this.getElement(c))},getElement:function(c){return typeof c=="string"&&(c=document.getElementById(c)),c},getElementPosition:function(c){var h=new e.Point,d,l;for(c=e.getElement(c),d=e.getElementStyle(c).position==="fixed",l=a(c,d);l;)h.x+=c.offsetLeft,h.y+=c.offsetTop,d&&(h=h.plus(e.getPageScroll())),c=l,d=e.getElementStyle(c).position==="fixed",l=a(c,d);return h},getElementOffset:function(c){c=e.getElement(c);var h=c&&c.ownerDocument,d,l,p={top:0,left:0};return h?(d=h.documentElement,typeof c.getBoundingClientRect<"u"&&(p=c.getBoundingClientRect()),l=h===h.window?h:h.nodeType===9?h.defaultView||h.parentWindow:!1,new e.Point(p.left+(l.pageXOffset||d.scrollLeft)-(d.clientLeft||0),p.top+(l.pageYOffset||d.scrollTop)-(d.clientTop||0))):new e.Point},getElementSize:function(c){return c=e.getElement(c),new e.Point(c.clientWidth,c.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(c){return c=e.getElement(c),c.currentStyle}:function(c){return c=e.getElement(c),window.getComputedStyle(c,"")},getCssPropertyWithVendorPrefix:function(c){var h={};return e.getCssPropertyWithVendorPrefix=function(d){if(h[d]!==void 0)return h[d];var l=document.createElement("div").style,p=null;if(l[d]!==void 0)p=d;else for(var f=["Webkit","Moz","MS","O","webkit","moz","ms","o"],m=e.capitalizeFirstLetter(d),v=0;v<f.length;v++){var w=f[v]+m;if(l[w]!==void 0){p=w;break}}return h[d]=p,p},e.getCssPropertyWithVendorPrefix(c)},capitalizeFirstLetter:function(c){return c.charAt(0).toUpperCase()+c.slice(1)},positiveModulo:function(c,h){var d=c%h;return d<0&&(d+=h),d},pointInElement:function(c,h){c=e.getElement(c);var d=e.getElementOffset(c),l=e.getElementSize(c);return h.x>=d.x&&h.x<d.x+l.x&&h.y<d.y+l.y&&h.y>=d.y},getMousePosition:function(c){if(typeof c.pageX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.pageX,d.y=h.pageY,d};else if(typeof c.clientX=="number")e.getMousePosition=function(h){var d=new e.Point;return d.x=h.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d.y=h.clientY+document.body.scrollTop+document.documentElement.scrollTop,d};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(c)},getPageScroll:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(h.scrollLeft||h.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(c.scrollLeft||c.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(c){if(typeof window.scrollTo<"u")e.setPageScroll=function(l){window.scrollTo(l.x,l.y)};else{var h=e.getPageScroll();if(h.x===c.x&&h.y===c.y)return;document.body.scrollLeft=c.x,document.body.scrollTop=c.y;var d=e.getPageScroll();if(d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.body.scrollLeft=l.x,document.body.scrollTop=l.y};return}if(document.documentElement.scrollLeft=c.x,document.documentElement.scrollTop=c.y,d=e.getPageScroll(),d.x!==h.x&&d.y!==h.y){e.setPageScroll=function(l){document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y};return}e.setPageScroll=function(l){}}e.setPageScroll(c)},getWindowSize:function(){var c=document.documentElement||{},h=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(c.clientWidth||c.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(h.clientWidth||h.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(c){c=e.getElement(c);var h=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(h[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(h[1].style,{display:"table-row"}),e.extend(h[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),h[0].appendChild(h[1]),h[1].appendChild(h[2]),h[2].appendChild(c),h[0]},makeNeutralElement:function(c){var h=document.createElement(c),d=h.style;return d.background="transparent none",d.border="none",d.margin="0px",d.padding="0px",d.position="static",h},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(c){var h=e.makeNeutralElement("img");return h.src=c,h},setElementOpacity:function(c,h,d){var l,p;c=e.getElement(c),d&&!e.Browser.alpha&&(h=Math.round(h)),e.Browser.opacity?c.style.opacity=h<1?h:"":h<1?(l=Math.round(100*h),p="alpha(opacity="+l+")",c.style.filter=p):c.style.filter=""},setElementTouchActionNone:function(c){c=e.getElement(c),typeof c.style.touchAction<"u"?c.style.touchAction="none":typeof c.style.msTouchAction<"u"&&(c.style.msTouchAction="none")},setElementPointerEvents:function(c,h){c=e.getElement(c),typeof c.style<"u"&&typeof c.style.pointerEvents<"u"&&(c.style.pointerEvents=h)},setElementPointerEventsNone:function(c){e.setElementPointerEvents(c,"none")},addClass:function(c,h){c=e.getElement(c),c.className?(" "+c.className+" ").indexOf(" "+h+" ")===-1&&(c.className+=" "+h):c.className=h},indexOf:function(c,h,d){return Array.prototype.indexOf?this.indexOf=function(l,p,f){return l.indexOf(p,f)}:this.indexOf=function(l,p,f){var m,v=f||0,w;if(!l)throw new TypeError;if(w=l.length,w===0||v>=w)return-1;for(v<0&&(v=w-Math.abs(v)),m=v;m<w;m++)if(l[m]===p)return m;return-1},this.indexOf(c,h,d)},removeClass:function(c,h){var d,l=[],p;for(c=e.getElement(c),d=c.className.split(/\s+/),p=0;p<d.length;p++)d[p]&&d[p]!==h&&l.push(d[p]);c.className=l.join(" ")},normalizeEventListenerOptions:function(c){var h;return typeof c<"u"?typeof c=="boolean"?h=e.supportsEventListenerOptions?{capture:c}:c:h=e.supportsEventListenerOptions?c:typeof c.capture<"u"?c.capture:!1:h=e.supportsEventListenerOptions?{capture:!1}:!1,h},addEvent:function(){if(e.supportsAddEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.addEventListener(h,d,l)};if(document.documentElement.attachEvent&&document.attachEvent)return function(c,h,d){c=e.getElement(c),c.attachEvent("on"+h,d)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(c,h,d,l){l=e.normalizeEventListenerOptions(l),c=e.getElement(c),c.removeEventListener(h,d,l)};if(document.documentElement.detachEvent&&document.detachEvent)return function(c,h,d){c=e.getElement(c),c.detachEvent("on"+h,d)};throw new Error("No known event model.")}(),cancelEvent:function(c){c.preventDefault()},eventIsCanceled:function(c){return c.defaultPrevented},stopEvent:function(c){c.stopPropagation()},createCallback:function(c,h){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var d=[],l;for(l=2;l<arguments.length;l++)d.push(arguments[l]);return function(){var p=d.concat([]),f;for(f=0;f<arguments.length;f++)p.push(arguments[f]);return h.apply(c,p)}},getUrlParameter:function(c){var h=o[c];return h||null},getUrlProtocol:function(c){var h=c.match(/^([a-z]+:)\/\//i);return h===null?window.location.protocol:h[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(c,h,d){var l,p,f,m;e.isPlainObject(c)&&(h=c.success,d=c.error,l=c.withCredentials,p=c.headers,f=c.responseType||null,m=c.postData||null,c=c.url);var v=e.getUrlProtocol(c),w=e.createAjaxRequest();if(!e.isFunction(h))throw new Error("makeAjaxRequest requires a success callback");w.onreadystatechange=function(){w.readyState===4&&(w.onreadystatechange=function(){},w.status>=200&&w.status<300||w.status===0&&v!=="http:"&&v!=="https:"?h(w):e.isFunction(d)?d(w):e.console.error("AJAX request returned %d: %s",w.status,c))};var T=m?"POST":"GET";try{if(w.open(T,c,!0),f&&(w.responseType=f),p)for(var A in p)Object.prototype.hasOwnProperty.call(p,A)&&p[A]&&w.setRequestHeader(A,p[A]);l&&(w.withCredentials=!0),w.send(m)}catch(F){e.console.error("%s while making AJAX request: %s",F.name,F.message),w.onreadystatechange=function(){},e.isFunction(d)&&d(w,F)}return w},jsonp:function(c){var h,d=c.url,l=document.head||document.getElementsByTagName("head")[0]||document.documentElement,p=c.callbackName||"openseadragon"+e.now(),f=window[p],m="$1"+p+"$2",v=c.param||"callback",w=c.callback;d=d.replace(/(=)\?(&|$)|\?\?/i,m),d+=(/\?/.test(d)?"&":"?")+v+"="+p,window[p]=function(T){if(f)window[p]=f;else try{delete window[p]}catch{}w&&e.isFunction(w)&&w(T)},h=document.createElement("script"),(c.async!==void 0||c.async!==!1)&&(h.async="async"),c.scriptCharset&&(h.charset=c.scriptCharset),h.src=d,h.onload=h.onreadystatechange=function(T,A){(A||!h.readyState||/loaded|complete/.test(h.readyState))&&(h.onload=h.onreadystatechange=null,l&&h.parentNode&&l.removeChild(h),h=void 0)},l.insertBefore(h,l.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(c){if(window.DOMParser)e.parseXml=function(h){var d=null,l;return l=new DOMParser,d=l.parseFromString(h,"text/xml"),d};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(c)},parseJSON:function(c){return e.parseJSON=window.JSON.parse,e.parseJSON(c)},imageFormatSupported:function(c){return c=c||"",!!r[c.toLowerCase()]},setImageFormatsSupported:function(c){e.extend(r,c)}});var n=function(c){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var c=navigator.appVersion,h=navigator.userAgent,d;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(h.substring(h.indexOf("MSIE")+5,h.indexOf(";",h.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(h.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edge")+5))):h.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(h.substring(h.indexOf("Edg")+4))):h.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(h.substring(h.indexOf("Firefox")+8))):h.indexOf("Safari")>=0?(e.Browser.vendor=h.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(h.substring(h.substring(0,h.indexOf("Safari")).lastIndexOf("/")+1,h.indexOf("Safari")))):(d=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),d.exec(h)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(c);break}var l=window.location.search.substring(1),p=l.split("&"),f,m,v;for(v=0;v<p.length;v++)if(f=p[v],m=f.indexOf("="),m>0){var w=f.substring(0,m),T=f.substring(m+1);try{o[w]=decodeURIComponent(T)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",w,T)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(c){var h=c.requestAnimationFrame||c.mozRequestAnimationFrame||c.webkitRequestAnimationFrame||c.msRequestAnimationFrame,d=c.cancelAnimationFrame||c.mozCancelAnimationFrame||c.webkitCancelAnimationFrame||c.msCancelAnimationFrame;if(h&&d)e.requestAnimationFrame=function(){return h.apply(c,arguments)},e.cancelAnimationFrame=function(){return d.apply(c,arguments)};else{var l=[],p=[],f=0,m;e.requestAnimationFrame=function(v){return l.push([++f,v]),m||(m=setInterval(function(){if(l.length){var w=e.now(),T=p;for(p=l,l=T;p.length;)p.shift()[1](w)}else clearInterval(m),m=void 0},1e3/50)),f},e.cancelAnimationFrame=function(v){var w,T;for(w=0,T=l.length;w<T;w+=1)if(l[w][0]===v){l.splice(w,1);return}for(w=0,T=p.length;w<T;w+=1)if(p[w][0]===v){p.splice(w,1);return}}}}(window);function a(c,h){return h&&c!==document.body?document.body:c.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(Mn,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var c=o[0*3+0],h=o[0*3+1],d=o[0*3+2],l=o[1*3+0],p=o[1*3+1],f=o[1*3+2],m=o[2*3+0],v=o[2*3+1],w=o[2*3+2],T=a[0*3+0],A=a[0*3+1],F=a[0*3+2],H=a[1*3+0],q=a[1*3+1],J=a[1*3+2],D=a[2*3+0],E=a[2*3+1],S=a[2*3+2];return new i([T*c+A*l+F*m,T*h+A*p+F*v,T*d+A*f+F*w,H*c+q*l+J*m,H*h+q*p+J*v,H*d+q*f+J*w,D*c+E*l+S*m,D*h+E*p+S*v,D*d+E*f+S*w])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var c=this;o=o||1;var h=0,d=function(l){return h++,h===o&&c.removeHandler(i,d),n(l)};return this.addHandler(i,d,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var c=a.length,h={handler:n,userData:r||null,priority:o||0};for(a[c]=h;c>0&&a[c-1].priority<a[c].priority;)a[c]=a[c-1],a[c-1]=h,c--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,c=n.length;for(a=0;a<c;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(x){var b=arguments;e.isPlainObject(x)||(x={element:b[0],clickTimeThreshold:b[1],clickDistThreshold:b[2]}),this.hash=Math.random(),this.element=e.getElement(x.element),this.clickTimeThreshold=x.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=x.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=x.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=x.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=x.userData||null,this.stopDelay=x.stopDelay||50,this.preProcessEventHandler=x.preProcessEventHandler||null,this.contextMenuHandler=x.contextMenuHandler||null,this.enterHandler=x.enterHandler||null,this.leaveHandler=x.leaveHandler||null,this.exitHandler=x.exitHandler||null,this.overHandler=x.overHandler||null,this.outHandler=x.outHandler||null,this.pressHandler=x.pressHandler||null,this.nonPrimaryPressHandler=x.nonPrimaryPressHandler||null,this.releaseHandler=x.releaseHandler||null,this.nonPrimaryReleaseHandler=x.nonPrimaryReleaseHandler||null,this.moveHandler=x.moveHandler||null,this.scrollHandler=x.scrollHandler||null,this.clickHandler=x.clickHandler||null,this.dblClickHandler=x.dblClickHandler||null,this.dragHandler=x.dragHandler||null,this.dragEndHandler=x.dragEndHandler||null,this.pinchHandler=x.pinchHandler||null,this.stopHandler=x.stopHandler||null,this.keyDownHandler=x.keyDownHandler||null,this.keyUpHandler=x.keyUpHandler||null,this.keyHandler=x.keyHandler||null,this.focusHandler=x.focusHandler||null,this.blurHandler=x.blurHandler||null;var C=this;i[this.hash]={click:function(I){F(C,I)},dblclick:function(I){H(C,I)},keydown:function(I){q(C,I)},keyup:function(I){J(C,I)},keypress:function(I){D(C,I)},focus:function(I){E(C,I)},blur:function(I){S(C,I)},contextmenu:function(I){k(C,I)},wheel:function(I){L(C,I)},mousewheel:function(I){O(C,I)},DOMMouseScroll:function(I){O(C,I)},MozMousePixelScroll:function(I){O(C,I)},losecapture:function(I){V(C,I)},mouseenter:function(I){te(C,I)},mouseleave:function(I){ct(C,I)},mouseover:function(I){rt(C,I)},mouseout:function(I){Kt(C,I)},mousedown:function(I){St(C,I)},mouseup:function(I){ei(C,I)},mousemove:function(I){kt(C,I)},touchstart:function(I){Ce(C,I)},touchend:function(I){Ie(C,I)},touchmove:function(I){Oe(C,I)},touchcancel:function(I){ne(C,I)},gesturestart:function(I){Te(C,I)},gesturechange:function(I){Se(C,I)},gotpointercapture:function(I){dt(C,I)},lostpointercapture:function(I){We(C,I)},pointerenter:function(I){te(C,I)},pointerleave:function(I){ct(C,I)},pointerover:function(I){rt(C,I)},pointerout:function(I){Kt(C,I)},pointerdown:function(I){St(C,I)},pointerup:function(I){ei(C,I)},pointermove:function(I){kt(C,I)},pointercancel:function(I){wt(C,I)},pointerupcaptured:function(I){xi(C,I)},pointermovecaptured:function(I){Ot(C,I)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),x.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){c(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(x){return x?a(this):c(this),this},getActivePointersListByType:function(x){var b=i[this.hash],C,I=b?b.activePointersLists.length:0,U;for(C=0;C<I;C++)if(b.activePointersLists[C].type===x)return b.activePointersLists[C];return U=new e.MouseTracker.GesturePointList(x),b&&b.activePointersLists.push(U),U},getActivePointerCount:function(){var x=i[this.hash],b,C=x.activePointersLists.length,I=0;for(b=0;b<C;b++)I+=x.activePointersLists[b].getLength();return I},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(x){try{return x.addEventListener&&x.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var x=[],b=0,C=0,I=function(Ne,ve){return Ne.hash.toString()+ve.type+ve.id.toString()},U=function(){var Ne,ve=x.length,pt,it,si=e.now(),oi,Ei,Si;for(oi=si-C,C=si,Ne=0;Ne<ve;Ne++)pt=x[Ne],it=pt.gPoint,it.direction=Math.atan2(it.currentPos.y-pt.lastPos.y,it.currentPos.x-pt.lastPos.x),Ei=pt.lastPos.distanceTo(it.currentPos),pt.lastPos=it.currentPos,Si=1e3*Ei/(oi+1),it.speed=.75*Si+.25*it.speed},Q=function(Ne,ve){var pt=I(Ne,ve);x.push({guid:pt,gPoint:ve,lastPos:ve.currentPos}),x.length===1&&(C=e.now(),b=window.setInterval(U,50))},me=function(Ne,ve){var pt=I(Ne,ve),it,si=x.length;for(it=0;it<si;it++)if(x[it].guid===pt){x.splice(it,1),si--,si===0&&window.clearInterval(b);break}};return{addPoint:Q,removePoint:me}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var x=document.createElement("div");return e.isFunction(x.setPointerCapture)&&e.isFunction(x.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var x=document.createElement("div");return e.isFunction(x.setCapture)&&e.isFunction(x.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(x){this._gPoints=[],this.type=x,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(x){return this._gPoints.push(x)},removeById:function(x){var b,C=this._gPoints.length;for(b=0;b<C;b++)if(this._gPoints[b].id===x){this._gPoints.splice(b,1);break}return this._gPoints.length},getByIndex:function(x){return x<this._gPoints.length?this._gPoints[x]:null},getById:function(x){var b,C=this._gPoints.length;for(b=0;b<C;b++)if(this._gPoints[b].id===x)return this._gPoints[b];return null},getPrimary:function(x){var b,C=this._gPoints.length;for(b=0;b<C;b++)if(this._gPoints[b].isPrimary)return this._gPoints[b];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(x){var b=i[x.hash],C,I,U,Q,me,Ne=b.activePointersLists.length;for(C=0;C<Ne;C++)if(U=b.activePointersLists[C],U.getLength()>0){for(me=[],Q=U.asArray(),I=0;I<Q.length;I++)me.push(Q[I]);for(I=0;I<me.length;I++)Pt(x,U,me[I])}for(C=0;C<Ne;C++)b.activePointersLists.pop();b.sentDragEvent=!1}function a(x){var b=i[x.hash],C,I;if(!b.tracking){for(I=0;I<e.MouseTracker.subscribeEvents.length;I++)C=e.MouseTracker.subscribeEvents[I],e.addEvent(x.element,C,b[C],C===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(x),b.tracking=!0}}function c(x){var b=i[x.hash],C,I;if(b.tracking){for(I=0;I<e.MouseTracker.subscribeEvents.length;I++)C=e.MouseTracker.subscribeEvents[I],e.removeEvent(x.element,C,b[C],!1);o(x),b.tracking=!1}}function h(x,b){var C=i[x.hash];if(b==="pointerevent")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(b==="mouse")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(b==="touch")return{upName:"touchend",upHandler:C.touchendcaptured,moveName:"touchmove",moveHandler:C.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function d(x,b){var C;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{x.element.setPointerCapture(b.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else x.element.setCapture(!0);else C=h(x,e.MouseTracker.havePointerEvents?"pointerevent":b.type),n&&r(window.top)&&e.addEvent(window.top,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0);B(x,b,!0)}function l(x,b){var C,I,U;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(I=x.getActivePointersListByType(b.type),U=I.getById(b.id),!U||!U.captured)return;try{x.element.releasePointerCapture(b.id)}catch{}}else x.element.releaseCapture();else C=h(x,e.MouseTracker.havePointerEvents?"pointerevent":b.type),n&&r(window.top)&&e.removeEvent(window.top,C.upName,C.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0);B(x,b,!1)}function p(x){return e.MouseTracker.havePointerEvents?x.pointerId:e.MouseTracker.mousePointerId}function f(x){return e.MouseTracker.havePointerEvents&&x.pointerType?x.pointerType:"mouse"}function m(x){return e.MouseTracker.havePointerEvents?x.isPrimary:!0}function v(x){return e.getMousePosition(x)}function w(x,b){return T(v(x),b)}function T(x,b){var C=e.getElementOffset(b);return x.minus(C)}function A(x,b){return new e.Point((x.x+b.x)/2,(x.y+b.y)/2)}function F(x,b){var C={originalEvent:b,eventType:"click",pointerType:"mouse",isEmulated:!1};R(x,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(b),C.stopPropagation&&e.stopEvent(b)}function H(x,b){var C={originalEvent:b,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};R(x,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(b),C.stopPropagation&&e.stopEvent(b)}function q(x,b){var C=null,I={originalEvent:b,eventType:"keydown",pointerType:"",isEmulated:!1};R(x,I),x.keyDownHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:x,keyCode:b.keyCode?b.keyCode:b.charCode,ctrl:b.ctrlKey,shift:b.shiftKey,alt:b.altKey,meta:b.metaKey,originalEvent:b,preventDefault:I.preventDefault||I.defaultPrevented,userData:x.userData},x.keyDownHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function J(x,b){var C=null,I={originalEvent:b,eventType:"keyup",pointerType:"",isEmulated:!1};R(x,I),x.keyUpHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:x,keyCode:b.keyCode?b.keyCode:b.charCode,ctrl:b.ctrlKey,shift:b.shiftKey,alt:b.altKey,meta:b.metaKey,originalEvent:b,preventDefault:I.preventDefault||I.defaultPrevented,userData:x.userData},x.keyUpHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function D(x,b){var C=null,I={originalEvent:b,eventType:"keypress",pointerType:"",isEmulated:!1};R(x,I),x.keyHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:x,keyCode:b.keyCode?b.keyCode:b.charCode,ctrl:b.ctrlKey,shift:b.shiftKey,alt:b.altKey,meta:b.metaKey,originalEvent:b,preventDefault:I.preventDefault||I.defaultPrevented,userData:x.userData},x.keyHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function E(x,b){var C={originalEvent:b,eventType:"focus",pointerType:"",isEmulated:!1};R(x,C),x.focusHandler&&!C.preventGesture&&x.focusHandler({eventSource:x,originalEvent:b,userData:x.userData})}function S(x,b){var C={originalEvent:b,eventType:"blur",pointerType:"",isEmulated:!1};R(x,C),x.blurHandler&&!C.preventGesture&&x.blurHandler({eventSource:x,originalEvent:b,userData:x.userData})}function k(x,b){var C=null,I={originalEvent:b,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};R(x,I),x.contextMenuHandler&&!I.preventGesture&&!I.defaultPrevented&&(C={eventSource:x,position:T(v(b),x.element),originalEvent:I.originalEvent,preventDefault:I.preventDefault||I.defaultPrevented,userData:x.userData},x.contextMenuHandler(C)),(C&&C.preventDefault||I.preventDefault&&!I.defaultPrevented)&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function L(x,b){M(x,b,b)}function O(x,b){var C={target:b.target||b.srcElement,type:"wheel",shiftKey:b.shiftKey||!1,clientX:b.clientX,clientY:b.clientY,pageX:b.pageX?b.pageX:b.clientX,pageY:b.pageY?b.pageY:b.clientY,deltaMode:b.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?C.deltaY=-b.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:C.deltaY=b.detail,M(x,C,b)}function M(x,b,C){var I=0,U,Q=null;I=b.deltaY?b.deltaY<0?1:-1:0,U={originalEvent:b,eventType:"wheel",pointerType:"mouse",isEmulated:b!==C},R(x,U),x.scrollHandler&&!U.preventGesture&&!U.defaultPrevented&&(Q={eventSource:x,pointerType:"mouse",position:w(b,x.element),scroll:I,shift:b.shiftKey,isTouchEvent:!1,originalEvent:C,preventDefault:U.preventDefault||U.defaultPrevented,userData:x.userData},x.scrollHandler(Q)),U.stopPropagation&&e.stopEvent(C),(Q&&Q.preventDefault||U.preventDefault&&!U.defaultPrevented)&&e.cancelEvent(C)}function V(x,b){var C={id:e.MouseTracker.mousePointerId,type:"mouse"},I={originalEvent:b,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};R(x,I),b.target===x.element&&B(x,C,!1),I.stopPropagation&&e.stopEvent(b)}function Ce(x,b){var C,I,U=b.changedTouches.length,Q,me=x.getActivePointersListByType("touch");C=e.now(),me.getLength()>b.touches.length-U&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var Ne={originalEvent:b,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(R(x,Ne),I=0;I<U;I++)Q={id:b.changedTouches[I].identifier,type:"touch",isPrimary:me.getLength()===0,currentPos:v(b.changedTouches[I]),currentTime:C},X(x,Ne,Q),we(x,Ne,Q,0),B(x,Q,!0);Ne.preventDefault&&!Ne.defaultPrevented&&e.cancelEvent(b),Ne.stopPropagation&&e.stopEvent(b)}function Ie(x,b){var C,I,U=b.changedTouches.length,Q;C=e.now();var me={originalEvent:b,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(R(x,me),I=0;I<U;I++)Q={id:b.changedTouches[I].identifier,type:"touch",currentPos:v(b.changedTouches[I]),currentTime:C},Le(x,me,Q,0),B(x,Q,!1),$(x,me,Q);me.preventDefault&&!me.defaultPrevented&&e.cancelEvent(b),me.stopPropagation&&e.stopEvent(b)}function Oe(x,b){var C,I,U=b.changedTouches.length,Q;C=e.now();var me={originalEvent:b,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(R(x,me),I=0;I<U;I++)Q={id:b.changedTouches[I].identifier,type:"touch",currentPos:v(b.changedTouches[I]),currentTime:C},Ae(x,me,Q);me.preventDefault&&!me.defaultPrevented&&e.cancelEvent(b),me.stopPropagation&&e.stopEvent(b)}function ne(x,b){var C=b.changedTouches.length,I,U,Q={originalEvent:b,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(R(x,Q),I=0;I<C;I++)U={id:b.changedTouches[I].identifier,type:"touch"},he(x,Q,U);Q.stopPropagation&&e.stopEvent(b)}function Te(x,b){return e.eventIsCanceled(b)||b.preventDefault(),!1}function Se(x,b){return e.eventIsCanceled(b)||b.preventDefault(),!1}function dt(x,b){var C={originalEvent:b,eventType:"gotpointercapture",pointerType:f(b),isEmulated:!1};R(x,C),b.target===x.element&&B(x,{id:b.pointerId,type:f(b)},!0),C.stopPropagation&&e.stopEvent(b)}function We(x,b){var C={originalEvent:b,eventType:"lostpointercapture",pointerType:f(b),isEmulated:!1};R(x,C),b.target===x.element&&B(x,{id:b.pointerId,type:f(b)},!1),C.stopPropagation&&e.stopEvent(b)}function te(x,b){var C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()},I={originalEvent:b,eventType:"pointerenter",pointerType:C.type,isEmulated:!1};R(x,I),X(x,I,C)}function ct(x,b){var C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()},I={originalEvent:b,eventType:"pointerleave",pointerType:C.type,isEmulated:!1};R(x,I),$(x,I,C)}function rt(x,b){var C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()},I={originalEvent:b,eventType:"pointerover",pointerType:C.type,isEmulated:!1};R(x,I),ce(x,I,C),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function Kt(x,b){var C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()},I={originalEvent:b,eventType:"pointerout",pointerType:C.type,isEmulated:!1};R(x,I),Z(x,I,C),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function St(x,b){var C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()},I=e.MouseTracker.havePointerEvents&&C.type==="touch",U={originalEvent:b,eventType:"pointerdown",pointerType:C.type,isEmulated:!1};R(x,U),we(x,U,C,b.button),U.preventDefault&&!U.defaultPrevented&&e.cancelEvent(b),U.stopPropagation&&e.stopEvent(b),U.shouldCapture&&(I?B(x,C,!0):d(x,C))}function ei(x,b){qt(x,b)}function xi(x,b){var C=x.getActivePointersListByType(f(b));C.getById(b.pointerId)&&qt(x,b),e.stopEvent(b)}function qt(x,b){var C;C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()};var I={originalEvent:b,eventType:"pointerup",pointerType:C.type,isEmulated:!1};R(x,I),Le(x,I,C,b.button),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b),I.shouldReleaseCapture&&(b.target===x.element?l(x,C):B(x,C,!1))}function kt(x,b){Wt(x,b)}function Ot(x,b){var C=x.getActivePointersListByType(f(b));C.getById(b.pointerId)&&Wt(x,b),e.stopEvent(b)}function Wt(x,b){var C={id:p(b),type:f(b),isPrimary:m(b),currentPos:v(b),currentTime:e.now()},I={originalEvent:b,eventType:"pointermove",pointerType:C.type,isEmulated:!1};R(x,I),Ae(x,I,C),I.preventDefault&&!I.defaultPrevented&&e.cancelEvent(b),I.stopPropagation&&e.stopEvent(b)}function wt(x,b){var C={id:b.pointerId,type:f(b)},I={originalEvent:b,eventType:"pointercancel",pointerType:C.type,isEmulated:!1};R(x,I),he(x,I,C),I.stopPropagation&&e.stopEvent(b)}function ke(x,b){return b.speed=0,b.direction=0,b.contactPos=b.currentPos,b.contactTime=b.currentTime,b.lastPos=b.currentPos,b.lastTime=b.currentTime,x.add(b)}function Pt(x,b,C){var I,U=b.getById(C.id);return U?(U.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),l(x,U)),b.removeContact(),I=b.removeById(C.id)):I=b.getLength(),I}function y(x,b){switch(b.eventType){case"pointermove":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!1,b.preventGesture=!x.hasGestureHandlers,b.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!1,b.preventGesture=!1,b.stopPropagation=!1;break;case"pointerdown":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!1,b.preventGesture=!x.hasGestureHandlers,b.stopPropagation=!1;break;case"pointerup":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!1,b.preventGesture=!x.hasGestureHandlers,b.stopPropagation=!1;break;case"wheel":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!1,b.preventGesture=!x.hasScrollHandler,b.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":b.isStoppable=!0,b.isCancelable=!1,b.preventDefault=!1,b.preventGesture=!1,b.stopPropagation=!1;break;case"click":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!!x.clickHandler,b.preventGesture=!1,b.stopPropagation=!1;break;case"dblclick":b.isStoppable=!0,b.isCancelable=!0,b.preventDefault=!!x.dblClickHandler,b.preventGesture=!1,b.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:b.isStoppable=!1,b.isCancelable=!1,b.preventDefault=!1,b.preventGesture=!1,b.stopPropagation=!1;break}}function R(x,b){b.eventSource=x,b.eventPhase=b.originalEvent&&typeof b.originalEvent.eventPhase<"u"?b.originalEvent.eventPhase:0,b.defaultPrevented=e.eventIsCanceled(b.originalEvent),b.shouldCapture=!1,b.shouldReleaseCapture=!1,b.userData=x.userData,y(x,b),x.preProcessEventHandler&&x.preProcessEventHandler(b)}function B(x,b,C){var I=x.getActivePointersListByType(b.type),U=I.getById(b.id);U?C&&!U.captured?(U.captured=!0,I.captureCount++):!C&&U.captured&&(U.captured=!1,I.captureCount--,I.captureCount<0&&(I.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function X(x,b,C){var I=x.getActivePointersListByType(C.type),U;U=I.getById(C.id),U?(U.insideElement=!0,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime,C=U):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,ke(I,C)),x.enterHandler&&x.enterHandler({eventSource:x,pointerType:C.type,position:T(C.currentPos,x.element),buttons:I.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData})}function $(x,b,C){var I=x.getActivePointersListByType(C.type),U,Q;U=I.getById(C.id),U?(U.captured?(U.insideElement=!1,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime):Pt(x,I,U),C=U):(C.captured=!1,C.insideElementPressed=!1),(x.leaveHandler||x.exitHandler)&&(Q={eventSource:x,pointerType:C.type,position:C.currentPos&&T(C.currentPos,x.element),buttons:I.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData},x.leaveHandler&&x.leaveHandler(Q),x.exitHandler&&x.exitHandler(Q))}function ce(x,b,C){var I,U;I=x.getActivePointersListByType(C.type),U=I.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),x.overHandler&&x.overHandler({eventSource:x,pointerType:C.type,position:T(C.currentPos,x.element),buttons:I.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData})}function Z(x,b,C){var I,U;I=x.getActivePointersListByType(C.type),U=I.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),x.outHandler&&x.outHandler({eventSource:x,pointerType:C.type,position:C.currentPos&&T(C.currentPos,x.element),buttons:I.buttons,pointers:x.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:I.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData})}function we(x,b,C,I){var U=i[x.hash],Q=x.getActivePointersListByType(C.type),me;if(typeof b.originalEvent.buttons<"u"?Q.buttons=b.originalEvent.buttons:I===0?Q.buttons|=1:I===1?Q.buttons|=4:I===2?Q.buttons|=2:I===3?Q.buttons|=8:I===4?Q.buttons|=16:I===5&&(Q.buttons|=32),I!==0){b.shouldCapture=!1,b.shouldReleaseCapture=!1,x.nonPrimaryPressHandler&&!b.preventGesture&&!b.defaultPrevented&&(b.preventDefault=!0,x.nonPrimaryPressHandler({eventSource:x,pointerType:C.type,position:T(C.currentPos,x.element),button:I,buttons:Q.buttons,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData}));return}me=Q.getById(C.id),me?(me.insideElementPressed=!0,me.insideElement=!0,me.originalTarget=b.originalEvent.target,me.contactPos=C.currentPos,me.contactTime=C.currentTime,me.lastPos=me.currentPos,me.lastTime=me.currentTime,me.currentPos=C.currentPos,me.currentTime=C.currentTime,C=me):(C.captured=!1,C.insideElementPressed=!0,C.insideElement=!0,C.originalTarget=b.originalEvent.target,ke(Q,C)),Q.addContact(),!b.preventGesture&&!b.defaultPrevented?(b.shouldCapture=!0,b.shouldReleaseCapture=!1,b.preventDefault=!0,(x.dragHandler||x.dragEndHandler||x.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(x,C),Q.contacts===1?x.pressHandler&&!b.preventGesture&&x.pressHandler({eventSource:x,pointerType:C.type,position:T(C.contactPos,x.element),buttons:Q.buttons,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData}):Q.contacts===2&&x.pinchHandler&&C.type==="touch"&&(U.pinchGPoints=Q.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=A(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(b.shouldCapture=!1,b.shouldReleaseCapture=!1)}function Le(x,b,C,I){var U=i[x.hash],Q=x.getActivePointersListByType(C.type),me,Ne,ve,pt=!1,it;if(typeof b.originalEvent.buttons<"u"?Q.buttons=b.originalEvent.buttons:I===0?Q.buttons^=-2:I===1?Q.buttons^=-5:I===2?Q.buttons^=-3:I===3?Q.buttons^=-9:I===4?Q.buttons^=-17:I===5&&(Q.buttons^=-33),b.shouldCapture=!1,I!==0){b.shouldReleaseCapture=!1,x.nonPrimaryReleaseHandler&&!b.preventGesture&&!b.defaultPrevented&&(b.preventDefault=!0,x.nonPrimaryReleaseHandler({eventSource:x,pointerType:C.type,position:T(C.currentPos,x.element),button:I,buttons:Q.buttons,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData}));return}ve=Q.getById(C.id),ve?(Q.removeContact(),ve.captured&&(pt=!0),ve.lastPos=ve.currentPos,ve.lastTime=ve.currentTime,ve.currentPos=C.currentPos,ve.currentTime=C.currentTime,ve.insideElement||Pt(x,Q,ve),me=ve.currentPos,Ne=ve.currentTime):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,ke(Q,C),ve=C),!b.preventGesture&&!b.defaultPrevented&&(pt?(b.shouldReleaseCapture=!0,b.preventDefault=!0,(x.dragHandler||x.dragEndHandler||x.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(x,ve),Q.contacts===0?(x.releaseHandler&&me&&x.releaseHandler({eventSource:x,pointerType:ve.type,position:T(me,x.element),buttons:Q.buttons,insideElementPressed:ve.insideElementPressed,insideElementReleased:ve.insideElement,isTouchEvent:ve.type==="touch",originalEvent:b.originalEvent,userData:x.userData}),x.dragEndHandler&&U.sentDragEvent&&x.dragEndHandler({eventSource:x,pointerType:ve.type,position:T(ve.currentPos,x.element),speed:ve.speed,direction:ve.direction,shift:b.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:b.originalEvent,userData:x.userData}),U.sentDragEvent=!1,(x.clickHandler||x.dblClickHandler)&&ve.insideElement&&(it=Ne-ve.contactTime<=x.clickTimeThreshold&&ve.contactPos.distanceTo(me)<=x.clickDistThreshold,x.clickHandler&&x.clickHandler({eventSource:x,pointerType:ve.type,position:T(ve.currentPos,x.element),quick:it,shift:b.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:b.originalEvent,originalTarget:ve.originalTarget,userData:x.userData}),x.dblClickHandler&&it&&(Q.clicks++,Q.clicks===1?(U.lastClickPos=me,U.dblClickTimeOut=setTimeout(function(){Q.clicks=0},x.dblClickTimeThreshold)):Q.clicks===2&&(clearTimeout(U.dblClickTimeOut),Q.clicks=0,U.lastClickPos.distanceTo(me)<=x.dblClickDistThreshold&&x.dblClickHandler({eventSource:x,pointerType:ve.type,position:T(ve.currentPos,x.element),shift:b.originalEvent.shiftKey,isTouchEvent:ve.type==="touch",originalEvent:b.originalEvent,userData:x.userData}),U.lastClickPos=null)))):Q.contacts===2&&x.pinchHandler&&ve.type==="touch"&&(U.pinchGPoints=Q.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=A(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(b.shouldReleaseCapture=!1,x.releaseHandler&&me&&(x.releaseHandler({eventSource:x,pointerType:ve.type,position:T(me,x.element),buttons:Q.buttons,insideElementPressed:ve.insideElementPressed,insideElementReleased:ve.insideElement,isTouchEvent:ve.type==="touch",originalEvent:b.originalEvent,userData:x.userData}),b.preventDefault=!0)))}function Ae(x,b,C){var I=i[x.hash],U=x.getActivePointersListByType(C.type),Q,me,Ne;if(typeof b.originalEvent.buttons<"u"&&(U.buttons=b.originalEvent.buttons),Q=U.getById(C.id),Q)Q.lastPos=Q.currentPos,Q.lastTime=Q.currentTime,Q.currentPos=C.currentPos,Q.currentTime=C.currentTime;else return;b.shouldCapture=!1,b.shouldReleaseCapture=!1,x.stopHandler&&C.type==="mouse"&&(clearTimeout(x.stopTimeOut),x.stopTimeOut=setTimeout(function(){Xe(x,b.originalEvent,C.type)},x.stopDelay)),U.contacts===0?x.moveHandler&&x.moveHandler({eventSource:x,pointerType:C.type,position:T(C.currentPos,x.element),buttons:U.buttons,isTouchEvent:C.type==="touch",originalEvent:b.originalEvent,userData:x.userData}):U.contacts===1?(x.moveHandler&&(Q=U.asArray()[0],x.moveHandler({eventSource:x,pointerType:Q.type,position:T(Q.currentPos,x.element),buttons:U.buttons,isTouchEvent:Q.type==="touch",originalEvent:b.originalEvent,userData:x.userData})),x.dragHandler&&!b.preventGesture&&!b.defaultPrevented&&(Q=U.asArray()[0],Ne=Q.currentPos.minus(Q.lastPos),x.dragHandler({eventSource:x,pointerType:Q.type,position:T(Q.currentPos,x.element),buttons:U.buttons,delta:Ne,speed:Q.speed,direction:Q.direction,shift:b.originalEvent.shiftKey,isTouchEvent:Q.type==="touch",originalEvent:b.originalEvent,userData:x.userData}),b.preventDefault=!0,I.sentDragEvent=!0)):U.contacts===2&&(x.moveHandler&&(me=U.asArray(),x.moveHandler({eventSource:x,pointerType:me[0].type,position:T(A(me[0].currentPos,me[1].currentPos),x.element),buttons:U.buttons,isTouchEvent:me[0].type==="touch",originalEvent:b.originalEvent,userData:x.userData})),x.pinchHandler&&C.type==="touch"&&!b.preventGesture&&!b.defaultPrevented&&(Ne=I.pinchGPoints[0].currentPos.distanceTo(I.pinchGPoints[1].currentPos),Ne!==I.currentPinchDist&&(I.lastPinchDist=I.currentPinchDist,I.currentPinchDist=Ne,I.lastPinchCenter=I.currentPinchCenter,I.currentPinchCenter=A(I.pinchGPoints[0].currentPos,I.pinchGPoints[1].currentPos),x.pinchHandler({eventSource:x,pointerType:"touch",gesturePoints:I.pinchGPoints,lastCenter:T(I.lastPinchCenter,x.element),center:T(I.currentPinchCenter,x.element),lastDistance:I.lastPinchDist,distance:I.currentPinchDist,shift:b.originalEvent.shiftKey,originalEvent:b.originalEvent,userData:x.userData}),b.preventDefault=!0)))}function he(x,b,C){var I=x.getActivePointersListByType(C.type),U;U=I.getById(C.id),U&&Pt(x,I,U)}function Xe(x,b,C){x.stopHandler&&x.stopHandler({eventSource:x,pointerType:C,position:w(b,x.element),buttons:x.getActivePointersListByType(C).buttons,isTouchEvent:C==="touch",originalEvent:b,userData:x.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(y){var R=arguments,B=this,X;e.isPlainObject(y)||(y={id:R[0],xmlPath:R.length>1?R[1]:void 0,prefixUrl:R.length>2?R[2]:void 0,controls:R.length>3?R[3]:void 0,overlays:R.length>4?R[4]:void 0}),y.config&&(e.extend(!0,y,y.config),delete y.config);let $=["useCanvas"];if(y.drawerOptions=Object.assign({},$.reduce((Z,we)=>(Z[we]=y[we],delete y[we],Z),{}),y.drawerOptions),e.extend(!0,this,{id:y.id,hash:y.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,y),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(Z){var we=e.getString("Errors.OpenFailed",Z.eventSource,Z.message);B._showMessage(we)}),e.ControlDock.call(this,y),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(Z){Z.width="100%",Z.height="100%",Z.overflow="hidden",Z.position="absolute",Z.top="0px",Z.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),y.tabIndex!==""&&(this.canvas.tabIndex=y.tabIndex===void 0?0:y.tabIndex),this.container.className="openseadragon-container",function(Z){Z.width="100%",Z.height="100%",Z.position="relative",Z.overflow="hidden",Z.left="0px",Z.top="0px",Z.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,w),keyDownHandler:e.delegate(this,T),keyHandler:e.delegate(this,A),clickHandler:e.delegate(this,F),dblClickHandler:e.delegate(this,H),dragHandler:e.delegate(this,q),dragEndHandler:e.delegate(this,J),enterHandler:e.delegate(this,D),leaveHandler:e.delegate(this,E),pressHandler:e.delegate(this,S),releaseHandler:e.delegate(this,k),nonPrimaryPressHandler:e.delegate(this,L),nonPrimaryReleaseHandler:e.delegate(this,O),scrollHandler:e.delegate(this,Ie),pinchHandler:e.delegate(this,M),focusHandler:e.delegate(this,V),blurHandler:e.delegate(this,Ce)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,Oe),leaveHandler:e.delegate(this,ne)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[B.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(Z){B.source=B.world.getItemAt(0).source,i[B.hash].forceRedraw=!0,B._updateRequestId||(B._updateRequestId=h(B,Te))}),this.world.addHandler("remove-item",function(Z){B.world.getItemCount()?B.source=B.world.getItemAt(0).source:B.source=null,i[B.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(Z){B.viewport&&B.viewport._setContentBounds(B.world.getHomeBounds(),B.world.getContentFactor())}),this.world.addHandler("item-index-change",function(Z){B.source=B.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:y.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let ce=Array.isArray(this.drawer)?this.drawer:[this.drawer];ce.length===0&&(ce=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const Z of ce)if(this.requestDrawer(Z,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(X=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(X,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(X=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(X,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),X=0;X<this.customControls.length;X++)this.addControl(this.customControls[X].id,{anchor:this.customControls[X].anchor});e.requestAnimationFrame(function(){l(B)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(y){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(y)},openTileSource:function(y){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(y)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(y,R){var B=this;if(this.close(),!y)return this;if(this.sequenceMode&&e.isArray(y))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof R<"u"&&!isNaN(R)&&(this.initialPage=R),this.tileSources=y,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(y)||(y=[y]),!y.length)return this;this._opening=!0;for(var X=y.length,$=0,ce=0,Z,we=function(){if($+ce===X)if($){(B._firstOpen||!B.preserveViewport)&&(B.viewport.goHome(!0),B.viewport.update()),B._firstOpen=!1;var he=y[0];if(he.tileSource&&(he=he.tileSource),B.overlays&&!B.preserveOverlays)for(var Xe=0;Xe<B.overlays.length;Xe++)B.currentOverlays[Xe]=a(B,B.overlays[Xe]);B._drawOverlays(),B._opening=!1,B.raiseEvent("open",{source:he})}else B._opening=!1,B.raiseEvent("open-failed",Z)},Le=function(he){(!e.isPlainObject(he)||!he.tileSource)&&(he={tileSource:he}),he.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete he.index),he.collectionImmediately===void 0&&(he.collectionImmediately=!0);var Xe=he.success;he.success=function(b){if($++,he.tileSource.overlays)for(var C=0;C<he.tileSource.overlays.length;C++)B.addOverlay(he.tileSource.overlays[C]);Xe&&Xe(b),we()};var x=he.error;he.error=function(b){ce++,Z||(Z=b),x&&x(b),we()},B.addTiledImage(he)},Ae=0;Ae<y.length;Ae++)Le(y[Ae]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(y,R){const B={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};R=e.extend(!0,B,R);const X=R.mainDrawer,$=R.redrawImmediately,ce=R.drawerOptions,Z=this.drawer;let we=null;if(y&&y.prototype instanceof e.DrawerBase?(we=y,y="custom"):typeof y=="string"&&(we=e.determineDrawer(y)),we||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),we&&we.isSupported()){Z&&X&&Z.destroy();const Le=new we({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:ce||this.drawerOptions[y]});return X&&(this.drawer=Le,$&&this.forceRedraw()),Le}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(y){return this.innerTracker.setTracking(y),this.outerTracker.setTracking(y),this.raiseEvent("mouse-enabled",{enabled:y}),this},areControlsEnabled:function(){var y=this.controls.length,R;for(R=0;R<this.controls.length;R++)y=y&&this.controls[R].isVisible();return y},setControlsEnabled:function(y){return y?f(this):l(this),this.raiseEvent("controls-enabled",{enabled:y}),this},setDebugMode:function(y){for(var R=0;R<this.world.getItemCount();R++)this.world.getItemAt(R).debugMode=y;this.debugMode=y,this.forceRedraw()},setAjaxHeaders:function(y,R){if(y===null&&(y={}),!e.isPlainObject(y)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(R===void 0&&(R=!0),this.ajaxHeaders=y,R){for(var B=0;B<this.world.getItemCount();B++)this.world.getItemAt(B)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var X in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[X].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(y){this.buttonGroup.addButton(y)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(y){var R=document.body,B=R.style,X=document.documentElement.style,$=this,ce,Z;if(y===this.isFullPage())return this;var we={fullPage:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",we),we.preventDefaultAction)return this;if(y&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=B.margin,this.docMargin=X.margin,B.margin="0",X.margin="0",this.bodyPadding=B.padding,this.docPadding=X.padding,B.padding="0",X.padding="0",this.bodyWidth=B.width,this.docWidth=X.width,B.width="100%",X.width="100%",this.bodyHeight=B.height,this.docHeight=X.height,B.height="100%",X.height="100%",this.bodyDisplay=B.display,B.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,ce=R.childNodes.length,Z=0;Z<ce;Z++)this.previousBody.push(R.childNodes[0]),R.removeChild(R.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,R.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),R.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,Oe)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,B.margin=this.bodyMargin,X.margin=this.docMargin,B.padding=this.bodyPadding,X.padding=this.docPadding,B.width=this.bodyWidth,X.width=this.docWidth,B.height=this.bodyHeight,X.height=this.docHeight,B.display=this.bodyDisplay,R.removeChild(this.element),ce=this.previousBody.length,Z=0;Z<ce;Z++)R.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(R.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var Le=0,Ae=function(){e.setPageScroll($.pageScroll);var he=e.getPageScroll();Le++,Le<10&&(he.x!==$.pageScroll.x||he.y!==$.pageScroll.y)&&e.requestAnimationFrame(Ae)};e.requestAnimationFrame(Ae),i[this.hash].fullPage=!1,e.delegate(this,ne)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:y}),this},setFullScreen:function(y){var R=this;if(!e.supportsFullScreen)return this.setFullPage(y);if(e.isFullScreen()===y)return this;var B={fullScreen:y,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",B),B.preventDefaultAction)return this;if(y){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var X=function(){var $=e.isFullScreen();$||(e.removeEvent(document,e.fullScreenEventName,X),e.removeEvent(document,e.fullScreenErrorEventName,X),R.setFullPage(!1),R.isFullPage()&&(R.element.style.width=R.fullPageStyleWidth,R.element.style.height=R.fullPageStyleHeight)),R.navigator&&R.viewport&&setTimeout(function(){R.navigator.update(R.viewport)}),R.raiseEvent("full-screen",{fullScreen:$})};e.addEvent(document,e.fullScreenEventName,X),e.addEvent(document,e.fullScreenErrorEventName,X),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(y){return this.container.style.visibility=y?"":"hidden",this.raiseEvent("visible",{visible:y}),this},addTiledImage:function(y){e.console.assert(y,"[Viewer.addTiledImage] options is required"),e.console.assert(y.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!y.replace||y.index>-1&&y.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var R=this;y.replace&&(y.replaceItem=R.world.getItemAt(y.index)),this._hideMessage(),y.placeholderFillStyle===void 0&&(y.placeholderFillStyle=this.placeholderFillStyle),y.opacity===void 0&&(y.opacity=this.opacity),y.preload===void 0&&(y.preload=this.preload),y.compositeOperation===void 0&&(y.compositeOperation=this.compositeOperation),y.crossOriginPolicy===void 0&&(y.crossOriginPolicy=y.tileSource.crossOriginPolicy!==void 0?y.tileSource.crossOriginPolicy:this.crossOriginPolicy),y.ajaxWithCredentials===void 0&&(y.ajaxWithCredentials=this.ajaxWithCredentials),y.loadTilesWithAjax===void 0&&(y.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(y.ajaxHeaders)||(y.ajaxHeaders={});var B={options:y};function X(Z){for(var we=0;we<R._loadQueue.length;we++)if(R._loadQueue[we]===B){R._loadQueue.splice(we,1);break}R._loadQueue.length===0&&$(B),R.raiseEvent("add-item-failed",Z),y.error&&y.error(Z)}function $(Z){R.collectionMode&&(R.world.arrange({immediately:Z.options.collectionImmediately,rows:R.collectionRows,columns:R.collectionColumns,layout:R.collectionLayout,tileSize:R.collectionTileSize,tileMargin:R.collectionTileMargin}),R.world.setAutoRefigureSizes(!0))}if(e.isArray(y.tileSource)){setTimeout(function(){X({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:y.tileSource,options:y})});return}this._loadQueue.push(B);function ce(){for(var Z,we,Le;R._loadQueue.length&&(Z=R._loadQueue[0],!!Z.tileSource);){if(R._loadQueue.splice(0,1),Z.options.replace){var Ae=R.world.getIndexOfItem(Z.options.replaceItem);Ae!==-1&&(Z.options.index=Ae),R.world.removeItem(Z.options.replaceItem)}we=new e.TiledImage({viewer:R,source:Z.tileSource,viewport:R.viewport,drawer:R.drawer,tileCache:R.tileCache,imageLoader:R.imageLoader,x:Z.options.x,y:Z.options.y,width:Z.options.width,height:Z.options.height,fitBounds:Z.options.fitBounds,fitBoundsPlacement:Z.options.fitBoundsPlacement,clip:Z.options.clip,placeholderFillStyle:Z.options.placeholderFillStyle,opacity:Z.options.opacity,preload:Z.options.preload,degrees:Z.options.degrees,flipped:Z.options.flipped,compositeOperation:Z.options.compositeOperation,springStiffness:R.springStiffness,animationTime:R.animationTime,minZoomImageRatio:R.minZoomImageRatio,wrapHorizontal:R.wrapHorizontal,wrapVertical:R.wrapVertical,maxTilesPerFrame:R.maxTilesPerFrame,immediateRender:R.immediateRender,blendTime:R.blendTime,alwaysBlend:R.alwaysBlend,minPixelRatio:R.minPixelRatio,smoothTileEdgesMinZoom:R.smoothTileEdgesMinZoom,iOSDevice:R.iOSDevice,crossOriginPolicy:Z.options.crossOriginPolicy,ajaxWithCredentials:Z.options.ajaxWithCredentials,loadTilesWithAjax:Z.options.loadTilesWithAjax,ajaxHeaders:Z.options.ajaxHeaders,debugMode:R.debugMode,subPixelRoundingForTransparency:R.subPixelRoundingForTransparency}),R.collectionMode&&R.world.setAutoRefigureSizes(!1),R.navigator&&(Le=e.extend({},Z.options,{replace:!1,originalTiledImage:we,tileSource:Z.tileSource}),R.navigator.addTiledImage(Le)),R.world.addItem(we,{index:Z.options.index}),R._loadQueue.length===0&&$(Z),R.world.getItemCount()===1&&!R.preserveViewport&&R.viewport.goHome(!0),Z.options.success&&Z.options.success({item:we})}}o(this,y.tileSource,y,function(Z){B.tileSource=Z,ce()},function(Z){Z.options=y,X(Z),ce()})},addSimpleImage:function(y){e.console.assert(y,"[Viewer.addSimpleImage] options is required"),e.console.assert(y.url,"[Viewer.addSimpleImage] options.url is required");var R=e.extend({},y,{tileSource:{type:"image",url:y.url}});delete R.url,this.addTiledImage(R)},addLayer:function(y){var R=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var B=e.extend({},y,{success:function(X){R.raiseEvent("add-layer",{options:y,drawer:X.item})},error:function(X){R.raiseEvent("add-layer-failed",X)}});return this.addTiledImage(B),this},getLayerAtLevel:function(y){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(y)},getLevelOfLayer:function(y){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(y)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(y,R){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(y,R)},removeLayer:function(y){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(y)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var y=e.delegate(this,m),R=e.delegate(this,v),B=e.delegate(this,this.goToNextPage),X=e.delegate(this,this.goToPreviousPage),$=this.navImages,ce=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(ce=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:te(this.prefixUrl,$.previous.REST),srcGroup:te(this.prefixUrl,$.previous.GROUP),srcHover:te(this.prefixUrl,$.previous.HOVER),srcDown:te(this.prefixUrl,$.previous.DOWN),onRelease:X,onFocus:y,onBlur:R}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:te(this.prefixUrl,$.next.REST),srcGroup:te(this.prefixUrl,$.next.GROUP),srcHover:te(this.prefixUrl,$.next.HOVER),srcDown:te(this.prefixUrl,$.next.DOWN),onRelease:B,onFocus:y,onBlur:R}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),ce&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var y=e.delegate(this,ct),R=e.delegate(this,Kt),B=e.delegate(this,xi),X=e.delegate(this,rt),$=e.delegate(this,qt),ce=e.delegate(this,Ot),Z=e.delegate(this,Wt),we=e.delegate(this,wt),Le=e.delegate(this,ke),Ae=e.delegate(this,Pt),he=e.delegate(this,m),Xe=e.delegate(this,v),x=this.navImages,b=[],C=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(C=!1),this.showZoomControl&&(b.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:te(this.prefixUrl,x.zoomIn.REST),srcGroup:te(this.prefixUrl,x.zoomIn.GROUP),srcHover:te(this.prefixUrl,x.zoomIn.HOVER),srcDown:te(this.prefixUrl,x.zoomIn.DOWN),onPress:y,onRelease:R,onClick:B,onEnter:y,onExit:R,onFocus:he,onBlur:Xe})),b.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:te(this.prefixUrl,x.zoomOut.REST),srcGroup:te(this.prefixUrl,x.zoomOut.GROUP),srcHover:te(this.prefixUrl,x.zoomOut.HOVER),srcDown:te(this.prefixUrl,x.zoomOut.DOWN),onPress:X,onRelease:R,onClick:$,onEnter:X,onExit:R,onFocus:he,onBlur:Xe}))),this.showHomeControl&&b.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:te(this.prefixUrl,x.home.REST),srcGroup:te(this.prefixUrl,x.home.GROUP),srcHover:te(this.prefixUrl,x.home.HOVER),srcDown:te(this.prefixUrl,x.home.DOWN),onRelease:ce,onFocus:he,onBlur:Xe})),this.showFullPageControl&&b.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:te(this.prefixUrl,x.fullpage.REST),srcGroup:te(this.prefixUrl,x.fullpage.GROUP),srcHover:te(this.prefixUrl,x.fullpage.HOVER),srcDown:te(this.prefixUrl,x.fullpage.DOWN),onRelease:Z,onFocus:he,onBlur:Xe})),this.showRotationControl&&(b.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:te(this.prefixUrl,x.rotateleft.REST),srcGroup:te(this.prefixUrl,x.rotateleft.GROUP),srcHover:te(this.prefixUrl,x.rotateleft.HOVER),srcDown:te(this.prefixUrl,x.rotateleft.DOWN),onRelease:we,onFocus:he,onBlur:Xe})),b.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:te(this.prefixUrl,x.rotateright.REST),srcGroup:te(this.prefixUrl,x.rotateright.GROUP),srcHover:te(this.prefixUrl,x.rotateright.HOVER),srcDown:te(this.prefixUrl,x.rotateright.DOWN),onRelease:Le,onFocus:he,onBlur:Xe}))),this.showFlipControl&&b.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:te(this.prefixUrl,x.flip.REST),srcGroup:te(this.prefixUrl,x.flip.GROUP),srcHover:te(this.prefixUrl,x.flip.HOVER),srcDown:te(this.prefixUrl,x.flip.DOWN),onRelease:Ae,onFocus:he,onBlur:Xe})),C?(this.buttonGroup=new e.ButtonGroup({buttons:b,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,kt)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=b),this},currentPage:function(){return this._sequenceIndex},goToPage:function(y){return this.tileSources&&y>=0&&y<this.tileSources.length&&(this._sequenceIndex=y,this._updateSequenceButtons(y),this.open(this.tileSources[y]),this.referenceStrip&&this.referenceStrip.setFocus(y),this.raiseEvent("page",{page:y})),this},addOverlay:function(y,R,B,X){var $;if(e.isPlainObject(y)?$=y:$={element:y,location:R,placement:B,onDraw:X},y=e.getElement($.element),c(this.currentOverlays,y)>=0)return this;var ce=a(this,$);return this.currentOverlays.push(ce),ce.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:y,location:$.location,placement:$.placement}),this},updateOverlay:function(y,R,B){var X;return y=e.getElement(y),X=c(this.currentOverlays,y),X>=0&&(this.currentOverlays[X].update(R,B),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:y,location:R,placement:B})),this},removeOverlay:function(y){var R;return y=e.getElement(y),R=c(this.currentOverlays,y),R>=0&&(this.currentOverlays[R].destroy(),this.currentOverlays.splice(R,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:y})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(y){var R;return y=e.getElement(y),R=c(this.currentOverlays,y),R>=0?this.currentOverlays[R]:null},_updateSequenceButtons:function(y){this.nextButton&&(!this.tileSources||this.tileSources.length-1===y?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(y>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(y){this._hideMessage();var R=e.makeNeutralElement("div");R.appendChild(document.createTextNode(y)),this.messageDiv=e.makeCenteredNode(R),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var y=this.messageDiv;y&&(y.parentNode.removeChild(y),delete this.messageDiv)},gestureSettingsByDeviceType:function(y){switch(y){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var y,R=this.currentOverlays.length;for(y=0;y<R;y++)this.currentOverlays[y].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var y=e.pixelDensityRatio,R=e.getCurrentPixelDensityRatio();y!==R&&(e.pixelDensityRatio=R,this.forceResize())},goToPreviousPage:function(){var y=this._sequenceIndex-1;this.navPrevNextWrap&&y<0&&(y+=this.tileSources.length),this.goToPage(y)},goToNextPage:function(){var y=this._sequenceIndex+1;this.navPrevNextWrap&&y>=this.tileSources.length&&(y=0),this.goToPage(y)},isAnimating:function(){return i[this.hash].animating}});function r(y){return y=e.getElement(y),new e.Point(y.clientWidth===0?1:y.clientWidth,y.clientHeight===0?1:y.clientHeight)}function o(y,R,B,X,$){var ce=y;if(e.type(R)==="string"){if(R.match(/^\s*<.*>\s*$/))R=e.parseXml(R);else if(R.match(/^\s*[{[].*[}\]]\s*$/))try{var Z=e.parseJSON(R);R=Z}catch{}}function we(Le,Ae){Le.ready?X(Le):(Le.addHandler("ready",function(){X(Le)}),Le.addHandler("open-failed",function(he){$({message:he.message,source:Ae})}))}setTimeout(function(){if(e.type(R)==="string")R=new e.TileSource({url:R,crossOriginPolicy:B.crossOriginPolicy!==void 0?B.crossOriginPolicy:y.crossOriginPolicy,ajaxWithCredentials:y.ajaxWithCredentials,ajaxHeaders:B.ajaxHeaders?B.ajaxHeaders:y.ajaxHeaders,splitHashDataForPost:y.splitHashDataForPost,success:function(Xe){X(Xe.tileSource)}}),R.addHandler("open-failed",function(Xe){$(Xe)});else if(e.isPlainObject(R)||R.nodeType)if(R.crossOriginPolicy===void 0&&(B.crossOriginPolicy!==void 0||y.crossOriginPolicy!==void 0)&&(R.crossOriginPolicy=B.crossOriginPolicy!==void 0?B.crossOriginPolicy:y.crossOriginPolicy),R.ajaxWithCredentials===void 0&&(R.ajaxWithCredentials=y.ajaxWithCredentials),e.isFunction(R.getTileUrl)){var Le=new e.TileSource(R);Le.getTileUrl=R.getTileUrl,X(Le)}else{var Ae=e.TileSource.determineType(ce,R);if(!Ae){$({message:"Unable to load TileSource",source:R});return}var he=Ae.prototype.configure.apply(ce,[R]);we(new Ae(he),R)}else we(R,R)})}function a(y,R){if(R instanceof e.Overlay)return R;var B=null;if(R.element)B=e.getElement(R.element);else{var X=R.id?R.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);B=e.getElement(R.id),B||(B=document.createElement("a"),B.href="#/overlay/"+X),B.id=X,e.addClass(B,R.className?R.className:"openseadragon-overlay")}var $=R.location,ce=R.width,Z=R.height;if(!$){var we=R.x,Le=R.y;if(R.px!==void 0){var Ae=y.viewport.imageToViewportRectangle(new e.Rect(R.px,R.py,ce||0,Z||0));we=Ae.x,Le=Ae.y,ce=ce!==void 0?Ae.width:void 0,Z=Z!==void 0?Ae.height:void 0}$=new e.Point(we,Le)}var he=R.placement;return he&&e.type(he)==="string"&&(he=e.Placement[R.placement.toUpperCase()]),new e.Overlay({element:B,location:$,placement:he,onDraw:R.onDraw,checkResize:R.checkResize,width:ce,height:Z,rotationMode:R.rotationMode})}function c(y,R){var B;for(B=y.length-1;B>=0;B--)if(y[B].element===R)return B;return-1}function h(y,R){return e.requestAnimationFrame(function(){R(y)})}function d(y){e.requestAnimationFrame(function(){p(y)})}function l(y){y.autoHideControls&&(y.controlsShouldFade=!0,y.controlsFadeBeginTime=e.now()+y.controlsFadeDelay,window.setTimeout(function(){d(y)},y.controlsFadeDelay))}function p(y){var R,B,X,$;if(y.controlsShouldFade){for(R=e.now(),B=R-y.controlsFadeBeginTime,X=1-B/y.controlsFadeLength,X=Math.min(1,X),X=Math.max(0,X),$=y.controls.length-1;$>=0;$--)y.controls[$].autoFade&&y.controls[$].setOpacity(X);X>0&&d(y)}}function f(y){var R;for(y.controlsShouldFade=!1,R=y.controls.length-1;R>=0;R--)y.controls[R].setOpacity(1)}function m(){f(this)}function v(){l(this)}function w(y){var R={tracker:y.eventSource,position:y.position,originalEvent:y.originalEvent,preventDefault:y.preventDefault};this.raiseEvent("canvas-contextmenu",R),y.preventDefault=R.preventDefault}function T(y){var R={originalEvent:y.originalEvent,preventDefaultAction:!1,preventVerticalPan:y.preventVerticalPan||!this.panVertical,preventHorizontalPan:y.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",R),!R.preventDefaultAction&&!y.ctrl&&!y.alt&&!y.meta)switch(y.keyCode){case 38:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 40:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 37:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 39:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 87:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 83:R.preventVerticalPan||(y.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 65:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 68:R.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),y.preventDefault=!0;break;case 82:y.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),y.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),y.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:y.preventDefault=!1;break}else y.preventDefault=!1}function A(y){var R={originalEvent:y.originalEvent};this.raiseEvent("canvas-key-press",R)}function F(y){var R,B=document.activeElement===this.canvas;B||this.canvas.focus(),this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x);var X={tracker:y.eventSource,position:y.position,quick:y.quick,shift:y.shift,originalEvent:y.originalEvent,originalTarget:y.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",X),!X.preventDefaultAction&&this.viewport&&y.quick&&(R=this.gestureSettingsByDeviceType(y.pointerType),R.clickToZoom===!0&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,R.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()),R.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function H(y){var R,B={tracker:y.eventSource,position:y.position,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",B),!B.preventDefaultAction&&this.viewport&&(R=this.gestureSettingsByDeviceType(y.pointerType),R.dblClickToZoom&&(this.viewport.zoomBy(y.shift?1/this.zoomPerClick:this.zoomPerClick,R.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints()))}function q(y){var R,B={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,delta:y.delta,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",B),R=this.gestureSettingsByDeviceType(y.pointerType),!B.preventDefaultAction&&this.viewport){if(R.dblClickDragToZoom&&i[this.hash].draggingToZoom){var X=Math.pow(this.zoomPerDblClickDrag,y.delta.y/50);this.viewport.zoomBy(X)}else if(R.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(y.delta.x=0),this.panVertical||(y.delta.y=0),this.viewport.flipped&&(y.delta.x=-y.delta.x),this.constrainDuringPan){var $=this.viewport.deltaPointsFromPixels(y.delta.negate());this.viewport.centerSpringX.target.value+=$.x,this.viewport.centerSpringY.target.value+=$.y;var ce=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=$.x,this.viewport.centerSpringY.target.value-=$.y,ce.xConstrained&&(y.delta.x=0),ce.yConstrained&&(y.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(y.delta.negate()),R.flickEnabled&&!this.constrainDuringPan)}}}function J(y){var R,B={tracker:y.eventSource,pointerType:y.pointerType,position:y.position,speed:y.speed,direction:y.direction,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",B),R=this.gestureSettingsByDeviceType(y.pointerType),!B.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&R.dragToPan&&R.flickEnabled&&y.speed>=R.flickMinSpeed){var X=0;this.panHorizontal&&(X=R.flickMomentum*y.speed*Math.cos(y.direction));var $=0;this.panVertical&&($=R.flickMomentum*y.speed*Math.sin(y.direction));var ce=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),Z=this.viewport.pointFromPixel(new e.Point(ce.x-X,ce.y-$));this.viewport.panTo(Z,!1)}this.viewport.applyConstraints()}R.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function D(y){this.raiseEvent("canvas-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function E(y){this.raiseEvent("canvas-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function S(y){var R;if(this.raiseEvent("canvas-press",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent}),R=this.gestureSettingsByDeviceType(y.pointerType),R.dblClickDragToZoom){var B=i[this.hash].lastClickTime,X=e.now();if(B===null)return;X-B<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function k(y){this.raiseEvent("canvas-release",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,insideElementPressed:y.insideElementPressed,insideElementReleased:y.insideElementReleased,originalEvent:y.originalEvent})}function L(y){this.raiseEvent("canvas-nonprimary-press",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function O(y){this.raiseEvent("canvas-nonprimary-release",{tracker:y.eventSource,position:y.position,pointerType:y.pointerType,button:y.button,buttons:y.buttons,originalEvent:y.originalEvent})}function M(y){var R,B,X,$,ce={tracker:y.eventSource,pointerType:y.pointerType,gesturePoints:y.gesturePoints,lastCenter:y.lastCenter,center:y.center,lastDistance:y.lastDistance,distance:y.distance,shift:y.shift,originalEvent:y.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",ce),this.viewport&&(R=this.gestureSettingsByDeviceType(y.pointerType),R.pinchToZoom&&(!ce.preventDefaultPanAction||!ce.preventDefaultZoomAction)&&(B=this.viewport.pointFromPixel(y.center,!0),R.zoomToRefPoint&&!ce.preventDefaultPanAction&&(X=this.viewport.pointFromPixel(y.lastCenter,!0),$=X.minus(B),this.panHorizontal||($.x=0),this.panVertical||($.y=0),this.viewport.panBy($,!0)),ce.preventDefaultZoomAction||this.viewport.zoomBy(y.distance/y.lastDistance,B,!0),this.viewport.applyConstraints()),R.pinchRotate&&!ce.preventDefaultRotateAction)){var Z=Math.atan2(y.gesturePoints[0].currentPos.y-y.gesturePoints[1].currentPos.y,y.gesturePoints[0].currentPos.x-y.gesturePoints[1].currentPos.x),we=Math.atan2(y.gesturePoints[0].lastPos.y-y.gesturePoints[1].lastPos.y,y.gesturePoints[0].lastPos.x-y.gesturePoints[1].lastPos.x);B=this.viewport.pointFromPixel(y.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(Z-we)*(180/Math.PI),B,!0)}}function V(y){this.raiseEvent("canvas-focus",{tracker:y.eventSource,originalEvent:y.originalEvent})}function Ce(y){this.raiseEvent("canvas-blur",{tracker:y.eventSource,originalEvent:y.originalEvent})}function Ie(y){var R,B,X,$,ce;$=e.now(),ce=$-this._lastScrollTime,ce>this.minScrollDeltaTime?(this._lastScrollTime=$,R={tracker:y.eventSource,position:y.position,scroll:y.scroll,shift:y.shift,originalEvent:y.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",R),!R.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(y.position.x=this.viewport.getContainerSize().x-y.position.x),B=this.gestureSettingsByDeviceType(y.pointerType),B.scrollToZoom&&(X=Math.pow(this.zoomPerScroll,y.scroll),this.viewport.zoomBy(X,B.zoomToRefPoint?this.viewport.pointFromPixel(y.position,!0):null),this.viewport.applyConstraints())),y.preventDefault=R.preventDefault):y.preventDefault=!0}function Oe(y){i[this.hash].mouseInside=!0,f(this),this.raiseEvent("container-enter",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function ne(y){y.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||l(this)),this.raiseEvent("container-exit",{tracker:y.eventSource,pointerType:y.pointerType,position:y.position,buttons:y.buttons,pointers:y.pointers,insideElementPressed:y.insideElementPressed,buttonDownAny:y.buttonDownAny,originalEvent:y.originalEvent})}function Te(y){dt(y),y.isOpen()?y._updateRequestId=h(y,Te):y._updateRequestId=!1}function Se(y,R){var B=y.viewport,X=B.getZoom(),$=B.getCenter();B.resize(R,y.preserveImageSizeOnResize),B.panTo($,!0);var ce;if(y.preserveImageSizeOnResize)ce=i[y.hash].prevContainerSize.x/R.x;else{var Z=new e.Point(0,0),we=new e.Point(i[y.hash].prevContainerSize.x,i[y.hash].prevContainerSize.y).distanceTo(Z),Le=new e.Point(R.x,R.y).distanceTo(Z);ce=Le/we*i[y.hash].prevContainerSize.x/R.x}B.zoomTo(X*ce,null,!0),i[y.hash].prevContainerSize=R,i[y.hash].forceRedraw=!0,i[y.hash].needsResize=!1,i[y.hash].forceResize=!1}function dt(y){if(!(y._opening||!i[y.hash])){if(y.autoResize||i[y.hash].forceResize){var R;if(y._autoResizePolling){R=r(y.container);var B=i[y.hash].prevContainerSize;R.equals(B)||(i[y.hash].needsResize=!0)}i[y.hash].needsResize&&Se(y,R||r(y.container))}var X=y.viewport.update(),$=y.world.update(X)||X;X&&y.raiseEvent("viewport-change"),y.referenceStrip&&($=y.referenceStrip.update(y.viewport)||$);var ce=i[y.hash].animating;!ce&&$&&(y.raiseEvent("animation-start"),f(y));var Z=ce&&!$;Z&&(i[y.hash].animating=!1),($||Z||i[y.hash].forceRedraw||y.world.needsDraw())&&(We(y),y._drawOverlays(),y.navigator&&y.navigator.update(y.viewport),i[y.hash].forceRedraw=!1,$&&y.raiseEvent("animation")),Z&&(y.raiseEvent("animation-finish"),i[y.hash].mouseInside||l(y)),i[y.hash].animating=$}}function We(y){y.imageLoader.clear(),y.world.draw(),y.raiseEvent("update-viewport",{})}function te(y,R){return y?y+R:R}function ct(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,St(this)}function rt(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,St(this)}function Kt(){i[this.hash].zooming=!1}function St(y){e.requestAnimationFrame(e.delegate(y,ei))}function ei(){var y,R,B;i[this.hash].zooming&&this.viewport&&(y=e.now(),R=y-i[this.hash].lastZoomTime,B=Math.pow(i[this.hash].zoomFactor,R/1e3),this.viewport.zoomBy(B),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=y,St(this))}function xi(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function qt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function kt(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function Ot(){this.viewport&&this.viewport.goHome()}function Wt(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function wt(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y+=this.rotationIncrement:y-=this.rotationIncrement,this.viewport.setRotation(y)}}function ke(){if(this.viewport){var y=this.viewport.getRotation();this.viewport.flipped?y-=this.rotationIncrement:y+=this.rotationIncrement,this.viewport.setRotation(y)}}function Pt(){this.viewport.toggleFlip()}e.determineDrawer=function(y){for(let R in t){const B=t[R],X=B.prototype;if(X&&X instanceof t.DrawerBase&&e.isFunction(X.getType)&&X.getType.call(B)===y)return B}return null}}(t),function(e){e.Navigator=function(h){var d=h.viewer,l=this,p,f;h.element||h.id?(h.element?(h.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),h.element.id?h.id=h.element.id:h.id="navigator-"+e.now(),this.element=h.element):this.element=document.getElementById(h.id),h.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(h.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),h.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:h.autoFade},h.position&&(h.position==="BOTTOM_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:h.position==="BOTTOM_LEFT"?h.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:h.position==="TOP_RIGHT"?h.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:h.position==="TOP_LEFT"?h.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:h.position==="ABSOLUTE"&&(h.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,h.controlOptions.top=h.top,h.controlOptions.left=h.left,h.controlOptions.height=h.height,h.controlOptions.width=h.width))),this.element.id=h.id,this.element.className+=" navigator",h=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},h,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:h.animationTime,autoResize:!1,minZoomImageRatio:1,background:h.background,opacity:h.opacity,borderColor:h.borderColor,displayRegionColor:h.displayRegionColor}),h.minPixelRatio=this.minPixelRatio=d.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),h.controlOptions.anchor!==e.ControlAnchor.NONE&&function(w,T){w.margin="0px",w.border=T+"px solid "+h.borderColor,w.padding="0px",w.background=h.background,w.opacity=h.opacity,w.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(w,T){w.position="relative",w.top="0px",w.left="0px",w.fontSize="0px",w.overflow="hidden",w.border=T+"px solid "+h.displayRegionColor,w.margin="0px",w.padding="0px",w.background="transparent",w.float="left",w.cssFloat="left",w.zIndex=999999999,w.cursor="default",w.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),d.addControl(this.element,h.controlOptions),this._resizeWithViewer=h.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&h.controlOptions.anchor!==e.ControlAnchor.NONE,h.width&&h.height?(this.setWidth(h.width),this.setHeight(h.height)):this._resizeWithViewer&&(p=e.getElementSize(d.element),this.element.style.height=Math.round(p.y*h.sizeRatio)+"px",this.element.style.width=Math.round(p.x*h.sizeRatio)+"px",this.oldViewerSize=p,f=e.getElementSize(this.element),this.elementArea=f.x*f.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[h]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function m(w,T){a(l.displayRegionContainer,w),a(l.displayRegion,-w),l.viewport.setRotation(w,T)}if(h.navigatorRotate){var v=h.viewer.viewport?h.viewer.viewport.getRotation():h.viewer.degrees||0;m(v,!0),h.viewer.addHandler("rotate",function(w){m(w.degrees,w.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(w){w.eventType==="wheel"&&(w.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){l.viewport&&l.viewport.goHome(!0)}),d.world.addHandler("item-index-change",function(w){window.setTimeout(function(){var T=l.world.getItemAt(w.previousIndex);l.world.setItemIndex(T,w.newIndex)},1)}),d.world.addHandler("remove-item",function(w){var T=w.item,A=l._getMatchingItem(T);A&&l.world.removeItem(A)}),this.update(d.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var h=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);h.equals(this.oldContainerSize)||(this.viewport.resize(h,!0),this.viewport.goHome(!0),this.oldContainerSize=h,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(h){this.width=h,this.element.style.width=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(h){this.height=h,this.element.style.height=typeof h=="number"?h+"px":h,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(h){return this.viewport.setFlip(h),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(h){c(this.canvas,h),c(this.element,h)},update:function(h){var d,l,p,f,m,v;if(h||(h=this.viewer.viewport),d=e.getElementSize(this.viewer.element),this._resizeWithViewer&&d.x&&d.y&&!d.equals(this.oldViewerSize)&&(this.oldViewerSize=d,this.maintainSizeRatio||!this.elementArea?(l=d.x*this.sizeRatio,p=d.y*this.sizeRatio):(l=Math.sqrt(this.elementArea*(d.x/d.y)),p=this.elementArea/l),this.element.style.width=Math.round(l)+"px",this.element.style.height=Math.round(p)+"px",this.elementArea||(this.elementArea=l*p),this.updateSize()),h&&this.viewport){if(f=h.getBoundsNoRotate(!0),m=this.viewport.pixelFromPointNoRotate(f.getTopLeft(),!1),v=this.viewport.pixelFromPointNoRotate(f.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var w=h.getRotation(!0);a(this.displayRegion,-w)}var T=this.displayRegion.style;T.display=this.world.getItemCount()?"block":"none",T.top=m.y.toFixed(2)+"px",T.left=m.x.toFixed(2)+"px";var A=v.x-m.x,F=v.y-m.y;T.width=Math.round(Math.max(A,0))+"px",T.height=Math.round(Math.max(F,0))+"px"}},addTiledImage:function(h){var d=this,l=h.originalTiledImage;delete h.original;var p=e.extend({},h,{success:function(f){var m=f.item;m._originalForNavigator=l,d._matchBounds(m,l,!0),d._matchOpacity(m,l),d._matchCompositeOperation(m,l);function v(){d._matchBounds(m,l)}function w(){d._matchOpacity(m,l)}function T(){d._matchCompositeOperation(m,l)}l.addHandler("bounds-change",v),l.addHandler("clip-change",v),l.addHandler("opacity-change",w),l.addHandler("composite-operation-change",T)}});return e.Viewer.prototype.addTiledImage.apply(this,[p])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(h){for(var d=this.world.getItemCount(),l,p=0;p<d;p++)if(l=this.world.getItemAt(p),l._originalForNavigator===h)return l;return null},_matchBounds:function(h,d,l){var p=d.getBoundsNoRotate();h.setPosition(p.getTopLeft(),l),h.setWidth(p.width,l),h.setRotation(d.getRotation(),l),h.setClip(d.getClip()),h.setFlip(d.getFlip())},_matchOpacity:function(h,d){h.setOpacity(d.opacity)},_matchCompositeOperation:function(h,d){h.setCompositeOperation(d.compositeOperation)}});function i(h){var d={tracker:h.eventSource,position:h.position,quick:h.quick,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",d),!d.preventDefaultAction&&h.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(h.position.x=this.viewport.getContainerSize().x-h.position.x);var l=this.viewport.pointFromPixel(h.position);this.panVertical?this.panHorizontal||(l.x=this.viewer.viewport.getCenter(!0).x):l.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(l),this.viewer.viewport.applyConstraints()}}function n(h){var d={tracker:h.eventSource,position:h.position,delta:h.delta,speed:h.speed,direction:h.direction,shift:h.shift,originalEvent:h.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",d),!d.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(h.delta.x=0),this.panVertical||(h.delta.y=0),this.viewer.viewport.flipped&&(h.delta.x=-h.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(h.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(h){h.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(h){var d={tracker:h.eventSource,position:h.position,scroll:h.scroll,shift:h.shift,originalEvent:h.originalEvent,preventDefault:h.preventDefault};this.viewer.raiseEvent("navigator-scroll",d),h.preventDefault=d.preventDefault}function a(h,d){c(h,"rotate("+d+"deg)")}function c(h,d){h.style.webkitTransform=d,h.style.mozTransform=d,h.style.msTransform=d,h.style.oTransform=d,h.style.transform=d}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,c=i,h;for(h=0;h<r.length-1;h++)c=c[r[h]]||{};return o=c[r[h]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(d){var l=parseInt(d.match(/\d+/),10)+1;return l<a.length?a[l]:""})},setString:function(n,r){var o=n.split("."),a=i,c;for(c=0;c<o.length-1;c++)a[o[c]]||(a[o[c]]={}),a=a[o[c]];a[o[c]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var c=i*Math.PI/180;r=Math.cos(c),o=Math.sin(c)}var h=r*(this.x-n.x)-o*(this.y-n.y)+n.x,d=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(h,d)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,c,h){var d=this,l=arguments,p,f;if(e.isPlainObject(n)?p=n:p={width:l[0],height:l[1],tileSize:l[2],tileOverlap:l[3],minLevel:l[4],maxLevel:l[5]},e.EventSource.call(this),e.extend(!0,this,p),!this.success){for(f=0;f<arguments.length;f++)if(e.isFunction(arguments[f])){this.success=arguments[f];break}}this.success&&this.addHandler("ready",function(m){d.success(m)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=p.width&&p.height?p.width/p.height:1,this.dimensions=new e.Point(p.width,p.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=p.tileOverlap?p.tileOverlap:0,this.minLevel=p.minLevel?p.minLevel:0,this.maxLevel=p.maxLevel!==void 0&&p.maxLevel!==null?p.maxLevel:p.width&&p.height?Math.ceil(Math.log(Math.max(p.width,p.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),c=r.x*a,h=r.y*a,d=Math.floor(c/this.getTileWidth(n)),l=Math.floor(h/this.getTileHeight(n));r.x>=1&&(d=this.getNumTiles(n).x-1);var p=1e-15;return r.y>=1/this.aspectRatio-p&&(l=this.getNumTiles(n).y-1),new e.Point(d,l)},getTileBounds:function(n,r,o,a){var c=this.dimensions.times(this.getLevelScale(n)),h=this.getTileWidth(n),d=this.getTileHeight(n),l=r===0?0:h*r-this.tileOverlap,p=o===0?0:d*o-this.tileOverlap,f=h+(r===0?1:2)*this.tileOverlap,m=d+(o===0?1:2)*this.tileOverlap,v=1/c.x;return f=Math.min(f,c.x-l),m=Math.min(m,c.y-p),a?new e.Rect(0,0,f,m):new e.Rect(l*v,p*v,f*v,m*v)},getImageInfo:function(n){var r=this,o,a,c,h,d,l,p;n&&(d=n.split("/"),l=d[d.length-1],p=l.lastIndexOf("."),p>-1&&(d[d.length-1]=l.slice(0,p)));var f=null;if(this.splitHashDataForPost){var m=n.indexOf("#");m!==-1&&(f=n.substring(m+1),n=n.substr(0,m))}a=function(v){typeof v=="string"&&(v=e.parseXml(v));var w=e.TileSource.determineType(r,v,n);if(!w){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}h=w.prototype.configure.apply(r,[v,n,f]),h.ajaxWithCredentials===void 0&&(h.ajaxWithCredentials=r.ajaxWithCredentials),c=new w(h),r.ready=!0,r.raiseEvent("ready",{tileSource:c})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:f,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(v){var w=i(v);a(w)},error:function(v,w){var T;try{T="HTTP "+v.status+" attempting to load TileSource: "+n}catch{var A;typeof w>"u"||!w.toString?A="Unknown error":A=w.toString(),T=A+" attempting to load TileSource: "+n}e.console.error(T),r.raiseEvent("open-failed",{message:T,source:n,postData:f})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,c,h){function d(l){return c?l+"+"+JSON.stringify(c):l}return d(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(c){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(c?null:o,r.request,c)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(c){var h;try{h=new window.Blob([c.response])}catch(p){var d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(p.name==="TypeError"&&d){var l=new d;l.append(c.response),h=l.getBlob()}}h.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(h)},error:function(c){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,c;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{c=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{c=n.responseText}else if(r.match(/\s*[{[].*/))try{c=e.parseJSON(r)}catch{c=r}else c=r;return c}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,c,h,d,l,p,f){var m,v,w,T;if(e.isPlainObject(r)?T=r:T={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=T.tilesUrl,this.fileFormat=T.fileFormat,this.displayRects=T.displayRects,this.displayRects)for(m=this.displayRects.length-1;m>=0;m--)for(v=this.displayRects[m],w=v.minLevel;w<=v.maxLevel;w++)this._levelRects[w]||(this._levelRects[w]=[]),this._levelRects[w].push(v);e.TileSource.apply(this,[T])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var c;return e.isPlainObject(r)?c=n(this,r):c=i(this,r),o&&!c.tilesUrl&&(c.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?c.queryParams=o.match(/\?.*/):c.queryParams=""),c},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var c=this._levelRects[r],h,d,l,p,f,m,v;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!c||!c.length)return!0;for(v=c.length-1;v>=0;v--)if(h=c[v],!(r<h.minLevel||r>h.maxLevel)&&(d=this.getLevelScale(r),l=h.x*d,p=h.y*d,f=l+h.width*d,m=p+h.height*d,l=Math.floor(l/this._tileWidth),p=Math.floor(p/this._tileWidth),f=Math.ceil(f/this._tileWidth),m=Math.ceil(m/this._tileWidth),l<=o&&o<f&&p<=a&&a<m))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,c=a.localName||a.tagName,h=o.documentElement.namespaceURI,d=null,l=[],p,f,m,v,w;if(c==="Image")try{if(v=a.getElementsByTagName("Size")[0],v===void 0&&(v=a.getElementsByTagNameNS(h,"Size")[0]),d={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(v.getAttribute("Height"),10),Width:parseInt(v.getAttribute("Width"),10)}}},!e.imageFormatSupported(d.Image.Format))throw new Error(e.getString("Errors.ImageFormat",d.Image.Format.toUpperCase()));for(p=a.getElementsByTagName("DisplayRect"),p===void 0&&(p=a.getElementsByTagNameNS(h,"DisplayRect")[0]),w=0;w<p.length;w++)f=p[w],m=f.getElementsByTagName("Rect")[0],m===void 0&&(m=f.getElementsByTagNameNS(h,"Rect")[0]),l.push({Rect:{X:parseInt(m.getAttribute("X"),10),Y:parseInt(m.getAttribute("Y"),10),Width:parseInt(m.getAttribute("Width"),10),Height:parseInt(m.getAttribute("Height"),10),MinLevel:parseInt(f.getAttribute("MinLevel"),10),MaxLevel:parseInt(f.getAttribute("MaxLevel"),10)}});return l.length&&(d.Image.DisplayRect=l),n(r,d)}catch(F){throw F instanceof Error?F:new Error(e.getString("Errors.Dzi"))}else{if(c==="Collection")throw new Error(e.getString("Errors.Dzc"));if(c==="Error"){var T=a.getElementsByTagName("Message")[0],A=T.firstChild.nodeValue;throw new Error(A)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,c=a.Url,h=a.Format,d=a.Size,l=a.DisplayRect||[],p=parseInt(d.Width,10),f=parseInt(d.Height,10),m=parseInt(a.TileSize,10),v=parseInt(a.Overlap,10),w=[],T,A;for(A=0;A<l.length;A++)T=l[A].Rect,w.push(new e.DisplayRect(parseInt(T.X,10),parseInt(T.Y,10),parseInt(T.Width,10),parseInt(T.Height,10),parseInt(T.MinLevel,10),parseInt(T.MaxLevel,10)));return e.extend(!0,{width:p,height:f,tileSize:m,tileOverlap:v,minLevel:null,maxLevel:null,tilesUrl:c,fileFormat:h,displayRects:w},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var c=0;c<this.tiles.length;c++)for(var h=0;h<this.tiles[c].scaleFactors.length;h++){var d=this.tiles[c].scaleFactors[h];this.scale_factors.push(d),a.tileSizePerScaleFactor[d]={width:this.tiles[c].width,height:this.tiles[c].height||this.tiles[c].width}}}else if(i(a)){for(var l=Math.min(this.height,this.width),p=[256,512,1024],f=[],m=0;m<p.length;m++)p[m]<=l&&f.push(p[m]);f.length>0?a.tileSize=Math.max.apply(null,f):a.tileSize=l}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var v=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(v)*Math.LOG2E)}if(this.sizes){var w=this.sizes.length;(w===a.maxLevel||w===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((T,A)=>T.width-A.width),w===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,c){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,c,h){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=c.replace("/info.json",""),a.version=1;else{var l=a["@context"];if(Array.isArray(l)){for(var p=0;p<l.length;p++)if(typeof l[p]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(l[p])||l[p]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){l=l[p];break}}switch(l){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var f=0;f<a.preferredFormats.length;f++)if(t.imageFormatSupported(a.preferredFormats[f])){a.tileFormat=a.preferredFormats[f];break}}return a}else{var d=r(a);return d["@context"]="http://iiif.io/api/image/1.0/context.json",d["@id"]=c.replace("/info.xml",""),d.version=1,d}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var c=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[c]?this.tileSizePerScaleFactor[c].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var c=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(c=this.levels[a].width/this.levels[this.maxLevel].width),c}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var c=this.getLevelScale(a);return c?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var h=this.levelSizes[a],d=Math.ceil(h.width/this.getTileWidth(a)),l=Math.ceil(h.height/this.getTileHeight(a));return new e.Point(d,l)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,c){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var h=c.x>=0&&c.x<=1&&c.y>=0&&c.y<=1/this.aspectRatio;e.console.assert(h,"[TileSource.getTileAtPoint] must be called with a valid point.");var d=this.levelSizes[a].width,l=c.x*d,p=c.y*d,f=Math.floor(l/this.getTileWidth(a)),m=Math.floor(p/this.getTileHeight(a));c.x>=1&&(f=this.getNumTiles(a).x-1);var v=1e-15;return c.y>=1/this.aspectRatio-v&&(m=this.getNumTiles(a).y-1),new e.Point(f,m)}return e.TileSource.prototype.getTileAtPoint.call(this,a,c)},getTileUrl:function(a,c,h){if(this.emulateLegacyImagePyramid){var d=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(d=this.levels[a].url),d}var l="0",p=Math.pow(.5,this.maxLevel-a),f,m,v,w,T,A,F,H,q,J,D,E,S,k,L,O;return this.levelSizes?(f=this.levelSizes[a].width,m=this.levelSizes[a].height):(f=Math.ceil(this.width*p),m=Math.ceil(this.height*p)),v=this.getTileWidth(a),w=this.getTileHeight(a),T=Math.round(v/p),A=Math.round(w/p),this.version===1?L="native."+this.tileFormat:L="default."+this.tileFormat,f<v&&m<w?(this.version===2&&f===this.width?E="full":this.version===3&&f===this.width&&m===this.height?E="max":this.version===3?E=f+","+m:E=f+",",F="full"):(H=c*T,q=h*A,J=Math.min(T,this.width-H),D=Math.min(A,this.height-q),c===0&&h===0&&J===this.width&&D===this.height?F="full":F=[H,q,J,D].join(","),S=Math.min(v,f-c*v),k=Math.min(w,m-h*w),this.version===2&&S===this.width?E="full":this.version===3&&S===this.width&&k===this.height?E="max":this.version===3?E=S+","+k:E=S+","),O=[this._id,F,E,l,L].join("/"),O},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var c=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],h=Array.isArray(a.profile)?a.profile[0]:a.profile,d=c.indexOf(h)!==-1,l=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(l=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(l=a.extraFeatures.indexOf("sizeByWh")!==-1),!d||l}function n(a){for(var c=[],h=0;h<a.sizes.length;h++)c.push({url:a._id+"/full/"+a.sizes[h].width+","+(a.version===3?a.sizes[h].height:"")+"/0/default."+a.tileFormat,width:a.sizes[h].width,height:a.sizes[h].height});return c.sort(function(d,l){return d.width-l.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null;if(h==="info")try{return d={},o(c,d),d}catch(l){throw l instanceof Error?l:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,c,h){var d,l;if(a.nodeType===3&&h)l=a.nodeValue.trim(),l.match(/^\d*$/)&&(l=Number(l)),c[h]?(e.isArray(c[h])||(c[h]=[c[h]]),c[h].push(l)):c[h]=l;else if(a.nodeType===1)for(d=0;d<a.childNodes.length;d++)o(a.childNodes[d],c,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!c.width||!c.height)&&(c.width=65572864,c.height=65572864),c.tileSize||(c.tileSize=256,c.tileOverlap=0),c.tilesUrl||(c.tilesUrl="http://tile.openstreetmap.org/"),c.minLevel=8,e.TileSource.apply(this,[c])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var c;e.isPlainObject(i)?c=i:c={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var h=Math.ceil(c.width/256)*256,d=Math.ceil(c.height/256)*256,l;h>d?l=h/256:l=d/256,c.maxLevel=Math.ceil(Math.log(l)/Math.log(2))-1,c.tileSize=256,c.width=h,c.height=d,e.TileSource.apply(this,[c])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},c=0;c<i;c++)a=this.gridSize[c],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,c,h;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(c=a.levels[a.levels.length-1].width,h=a.levels[a.levels.length-1].height):(c=0,h=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:c,height:h,tileSize:Math.max(h,c),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,c){var h;return e.isPlainObject(o)?h=r(this,o):h=n(this,o),h},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,c){var h=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(h=this.levels[o].url),h}});function i(o){var a=[],c,h;for(h=0;h<o.length;h++)c=o[h],c.height&&c.width&&c.url?a.push({url:c.url,width:Number(c.width),height:Number(c.height)}):e.console.error("Unsupported image format: %s",c.url?c.url:"<no URL>");return a.sort(function(d,l){return d.height-l.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var c=a.documentElement,h=c.tagName,d=null,l=[],p,f;if(h==="image")try{for(d={type:c.getAttribute("type"),levels:[]},l=c.getElementsByTagName("level"),f=0;f<l.length;f++)p=l[f],d.levels.push({url:p.getAttribute("url"),width:parseInt(p.getAttribute("width"),10),height:parseInt(p.getAttribute("height"),10)});return r(o,d)}catch(m){throw m instanceof Error?m:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(h==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(h==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+h)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var c=document.createElement("canvas"),h=c.getContext("2d");c.width=n,c.height=r,h.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:h,width:n,height:r}),o=c,a=h}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(h){var d=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},h),this.element=h.element||e.makeNeutralElement("div"),h.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(l){l.insideElementPressed?(a(d,e.ButtonState.DOWN),d.raiseEvent("enter",{originalEvent:l.originalEvent})):l.buttonDownAny||a(d,e.ButtonState.HOVER)},focusHandler:function(l){d.tracker.enterHandler(l),d.raiseEvent("focus",{originalEvent:l.originalEvent})},leaveHandler:function(l){c(d,e.ButtonState.GROUP),l.insideElementPressed&&d.raiseEvent("exit",{originalEvent:l.originalEvent})},blurHandler:function(l){d.tracker.leaveHandler(l),d.raiseEvent("blur",{originalEvent:l.originalEvent})},pressHandler:function(l){a(d,e.ButtonState.DOWN),d.raiseEvent("press",{originalEvent:l.originalEvent})},releaseHandler:function(l){l.insideElementPressed&&l.insideElementReleased?(c(d,e.ButtonState.HOVER),d.raiseEvent("release",{originalEvent:l.originalEvent})):l.insideElementPressed?c(d,e.ButtonState.GROUP):a(d,e.ButtonState.HOVER)},clickHandler:function(l){l.quick&&d.raiseEvent("click",{originalEvent:l.originalEvent})},keyHandler:function(l){l.keyCode===13?(d.raiseEvent("click",{originalEvent:l.originalEvent}),d.raiseEvent("release",{originalEvent:l.originalEvent}),l.preventDefault=!0):l.preventDefault=!1}}),c(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){c(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(h){e.requestAnimationFrame(function(){n(h)})}function n(h){var d,l,p;h.shouldFade&&(d=e.now(),l=d-h.fadeBeginTime,p=1-l/h.fadeLength,p=Math.min(1,p),p=Math.max(0,p),h.imgGroup&&e.setElementOpacity(h.imgGroup,p,!0),p>0&&i(h))}function r(h){h.shouldFade=!0,h.fadeBeginTime=e.now()+h.fadeDelay,window.setTimeout(function(){i(h)},h.fadeDelay)}function o(h){h.shouldFade=!1,h.imgGroup&&e.setElementOpacity(h.imgGroup,1,!0)}function a(h,d){h.element.disabled||(d>=e.ButtonState.GROUP&&h.currentState===e.ButtonState.REST&&(o(h),h.currentState=e.ButtonState.GROUP),d>=e.ButtonState.HOVER&&h.currentState===e.ButtonState.GROUP&&(h.imgHover&&(h.imgHover.style.visibility=""),h.currentState=e.ButtonState.HOVER),d>=e.ButtonState.DOWN&&h.currentState===e.ButtonState.HOVER&&(h.imgDown&&(h.imgDown.style.visibility=""),h.currentState=e.ButtonState.DOWN))}function c(h,d){h.element.disabled||(d<=e.ButtonState.HOVER&&h.currentState===e.ButtonState.DOWN&&(h.imgDown&&(h.imgDown.style.visibility="hidden"),h.currentState=e.ButtonState.HOVER),d<=e.ButtonState.GROUP&&h.currentState===e.ButtonState.HOVER&&(h.imgHover&&(h.imgHover.style.visibility="hidden"),h.currentState=e.ButtonState.GROUP),d<=e.ButtonState.REST&&h.currentState===e.ButtonState.GROUP&&(r(h),h.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var c;for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupEnter()},leaveHandler:function(a){var c;if(!a.insideElementPressed)for(c=0;c<r.buttons.length;c++)r.buttons[c].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var c,h;this.degrees>=270?(c=this.getTopRight(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=270):this.degrees>=180?(c=this.getBottomRight(),this.x=c.x,this.y=c.y,this.degrees-=180):this.degrees>=90&&(c=this.getBottomLeft(),this.x=c.x,this.y=c.y,h=this.height,this.height=this.width,this.width=h,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),c=n.minus(i),h=Math.atan(c.y/c.x);return c.x<0?h+=Math.PI:c.y<0&&(h+=2*Math.PI),new e.Rect(i.x,i.y,o,a,h/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),c=Math.max(n.x+n.width,r.x+r.width),h=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,c-o,h-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var c=this.getBottomLeft();i.containsPoint(c,n)&&r.push(c);var h=this.getBottomRight();i.containsPoint(h,n)&&r.push(h);var d=i.getTopLeft();this.containsPoint(d,n)&&r.push(d);var l=i.getTopRight();this.containsPoint(l,n)&&r.push(l);var p=i.getBottomLeft();this.containsPoint(p,n)&&r.push(p);var f=i.getBottomRight();this.containsPoint(f,n)&&r.push(f);for(var m=this._getSegments(),v=i._getSegments(),w=0;w<m.length;w++)for(var T=m[w],A=0;A<v.length;A++){var F=v[A],H=q(T[0],T[1],F[0],F[1]);H&&r.push(H)}function q(O,M,V,Ce){var Ie=M.minus(O),Oe=Ce.minus(V),ne=-Oe.x*Ie.y+Ie.x*Oe.y;if(ne===0)return null;var Te=(Ie.x*(O.y-V.y)-Ie.y*(O.x-V.x))/ne,Se=(Oe.x*(O.y-V.y)-Oe.y*(O.x-V.x))/ne;return-n<=Te&&Te<=1-n&&-n<=Se&&Se<=1-n?new e.Point(O.x+Se*Ie.x,O.y+Se*Ie.y):null}if(r.length===0)return null;for(var J=r[0].x,D=r[0].x,E=r[0].y,S=r[0].y,k=1;k<r.length;k++){var L=r[k];L.x<J&&(J=L.x),L.x>D&&(D=L.x),L.y<E&&(E=L.y),L.y>S&&(S=L.y)}return new e.Rect(J,E,D-J,S-E)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(h){var d=1e-15;return Math.abs(h)<d?0:h});var c=Math.atan(a.y/a.x);return a.x<0?c+=Math.PI:a.y<0&&(c+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,c/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),c=Math.max(i.x,n.x,r.x,o.x),h=Math.min(i.y,n.y,r.y,o.y),d=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,h,c-a,d-h)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),c=o.minus(r),h=a.minus(r);return(i.x-r.x)*c.x+(i.y-r.y)*c.y>=-n&&(i.x-o.x)*c.x+(i.y-o.y)*c.y<=n&&(i.x-r.x)*h.x+(i.y-r.y)*h.y>=-n&&(i.x-a.x)*h.x+(i.y-a.y)*h.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(p){var f=this,m=p.viewer,v=e.getElementSize(m.element),w,T,A;for(p.id||(p.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=p.id,this.element.className="referencestrip"),p=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},p,{element:this.element}),e.extend(this,p),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,T=this.element.style,T.marginTop="0px",T.marginRight="0px",T.marginBottom="0px",T.marginLeft="0px",T.left="0px",T.bottom="0px",T.border="0px",T.background="#000",T.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=m,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,c),leaveHandler:e.delegate(this,h),keyDownHandler:e.delegate(this,d),keyHandler:e.delegate(this,l),preProcessEventHandler:function(F){F.eventType==="wheel"&&(F.preventDefault=!0)}}),p.width&&p.height?(this.element.style.width=p.width+"px",this.element.style.height=p.height+"px",m.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):p.scroll==="horizontal"?(this.element.style.width=v.x*p.sizeRatio*m.tileSources.length+12*m.tileSources.length+"px",this.element.style.height=v.y*p.sizeRatio+"px",m.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=v.y*p.sizeRatio*m.tileSources.length+12*m.tileSources.length+"px",this.element.style.width=v.x*p.sizeRatio+"px",m.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=v.x*this.sizeRatio+8,this.panelHeight=v.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},A=0;A<m.tileSources.length;A++)w=e.makeNeutralElement("div"),w.id=this.element.id+"-"+A,w.style.width=f.panelWidth+"px",w.style.height=f.panelHeight+"px",w.style.display="inline",w.style.float="left",w.style.cssFloat="left",w.style.padding="2px",e.setElementTouchActionNone(w),e.setElementPointerEventsNone(w),this.element.appendChild(w),w.activePanel=!1,this.panels.push(w);a(this,this.scroll==="vertical"?v.y:v.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(p){var f=this.element.querySelector("#"+this.element.id+"-"+p),m=e.getElementSize(this.viewer.canvas),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),T=-Number(this.element.style.marginLeft.replace("px","")),A=-Number(this.element.style.marginTop.replace("px","")),F;this.currentSelected!==f&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=f,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(F=Number(p)*(this.panelWidth+3),F>T+m.x-this.panelWidth?(F=Math.min(F,v-m.x),this.element.style.marginLeft=-F+"px",a(this,m.x,-F)):F<T&&(F=Math.max(0,F-m.x/2),this.element.style.marginLeft=-F+"px",a(this,m.x,-F))):(F=Number(p)*(this.panelHeight+3),F>A+m.y-this.panelHeight?(F=Math.min(F,w-m.y),this.element.style.marginTop=-F+"px",a(this,m.y,-F)):F<A&&(F=Math.max(0,F-m.y/2),this.element.style.marginTop=-F+"px",a(this,m.y,-F))),this.currentPage=p,c.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var p in this.miniViewers)this.miniViewers[p].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(p){if(p.quick){var f;this.scroll==="horizontal"?f=Math.floor(p.position.x/(this.panelWidth+4)):f=Math.floor(p.position.y/this.panelHeight),this.viewer.goToPage(f)}this.element.focus()}function r(p){if(this.dragging=!0,this.element){var f=Number(this.element.style.marginLeft.replace("px","")),m=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),T=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-p.delta.x>0?f>-(v-T.x)&&(this.element.style.marginLeft=f+p.delta.x*2+"px",a(this,T.x,f+p.delta.x*2)):-p.delta.x<0&&f<0&&(this.element.style.marginLeft=f+p.delta.x*2+"px",a(this,T.x,f+p.delta.x*2)):-p.delta.y>0?m>-(w-T.y)&&(this.element.style.marginTop=m+p.delta.y*2+"px",a(this,T.y,m+p.delta.y*2)):-p.delta.y<0&&m<0&&(this.element.style.marginTop=m+p.delta.y*2+"px",a(this,T.y,m+p.delta.y*2))}}function o(p){if(this.element){var f=Number(this.element.style.marginLeft.replace("px","")),m=Number(this.element.style.marginTop.replace("px","")),v=Number(this.element.style.width.replace("px","")),w=Number(this.element.style.height.replace("px","")),T=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?p.scroll>0?f>-(v-T.x)&&(this.element.style.marginLeft=f-p.scroll*60+"px",a(this,T.x,f-p.scroll*60)):p.scroll<0&&f<0&&(this.element.style.marginLeft=f-p.scroll*60+"px",a(this,T.x,f-p.scroll*60)):p.scroll<0?m>T.y-w&&(this.element.style.marginTop=m+p.scroll*60+"px",a(this,T.y,m+p.scroll*60)):p.scroll>0&&m<0&&(this.element.style.marginTop=m+p.scroll*60+"px",a(this,T.y,m+p.scroll*60)),p.preventDefault=!0}}function a(p,f,m){var v,w,T,A,F,H;for(p.scroll==="horizontal"?v=p.panelWidth:v=p.panelHeight,w=Math.ceil(f/v)+5,T=Math.ceil((Math.abs(m)+f)/v)+1,w=T-w,w=w<0?0:w,F=w;F<T&&F<p.panels.length;F++)if(H=p.panels[F],!H.activePanel){var q,J=p.viewer.tileSources[F];J.referenceStripThumbnailUrl?q={type:"image",url:J.referenceStripThumbnailUrl}:q=J,A=new e.Viewer({id:H.id,tileSources:[q],element:H,navigatorSizeRatio:p.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:p.viewer.loadTilesWithAjax,ajaxHeaders:p.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(A.canvas),e.setElementPointerEventsNone(A.container),A.innerTracker.setTracking(!1),A.outerTracker.setTracking(!1),p.miniViewers[H.id]=A,H.activePanel=!0}}function c(p){var f=p.eventSource.element;this.scroll==="horizontal"?f.style.marginBottom="0px":f.style.marginLeft="0px"}function h(p){var f=p.eventSource.element;this.scroll==="horizontal"?f.style.marginBottom="-"+e.getElementSize(f).y/2+"px":f.style.marginLeft="-"+e.getElementSize(f).x/2+"px"}function d(p){if(!p.ctrl&&!p.alt&&!p.meta)switch(p.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;default:p.preventDefault=!1;break}else p.preventDefault=!1}function l(p){if(!p.ctrl&&!p.alt&&!p.meta)switch(p.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),p.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),p.preventDefault=!0;break;default:p.preventDefault=!1;break}else p.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,c){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=c},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(d){i(o,d,n.callback)},c={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},h=new e.ImageJob(c);!this.jobLimit||this.jobsInProgress<this.jobLimit?(h.start(),this.jobsInProgress++):this.jobQueue.push(h)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,c,h,d,l,p,f,m){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=p,this.exists=a,this._url=c,this.postData=f,this.context2D=h,this.loadWithAjax=d,this.ajaxHeaders=l,m===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),m=e.TileSource.prototype.getTileHashKey(i,n,r,c,l,f)),this.cacheKey=m,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(c){return c%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,c=this.size=o.size,h="";n.overlayPreserveContentDirection&&(h=n.flipped?" scaleX(-1)":" scaleX(1)");var d=n.flipped?-o.rotate:o.rotate,l=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,c,this.element);else{var p=this.style,f=this.element.style;f.display="block",p.left=a.x+"px",p.top=a.y+"px",this.width!==null&&(f.width=c.x+"px"),this.height!==null&&(f.height=c.y+"px");var m=e.getCssPropertyWithVendorPrefix("transformOrigin"),v=e.getCssPropertyWithVendorPrefix("transform");m&&v&&(d&&!n.flipped?(f[v]="",p[m]=this._getTransformOrigin(),p[v]="rotate("+d+"deg)"):!d&&n.flipped?(f[v]=h,p[m]=this._getTransformOrigin(),p[v]=l):d&&n.flipped?(f[v]=h,p[m]=this._getTransformOrigin(),p[v]="rotate("+d+"deg)"+l):(f[v]="",p[m]="",p[v]="")),p.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),c=this._getBoundingBox(a,i.getRotation(!0));n=c.getTopLeft(),r=c.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(c){c.opacity!==0&&a._drawTiles(c)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(d=>d.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var c=a.length-1;c>=0;c--){var h=a[c];this._drawTile(h),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:h})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var c=o.getImage();if(!c)return;o.element=e.makeNeutralElement("div"),o.imgElement=c.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(d){super(d),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let d=e.makeNeutralElement("canvas"),l=this._calculateCanvasSize();return d.width=l.x,d.height=l.y,d}draw(d){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const l of d)l.opacity!==0&&this._drawTiles(l)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(d){return!0}setImageSmoothingEnabled(d){this._imageSmoothingEnabled=!!d,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(d){var l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.strokeStyle=this.debugGridColor[0],l.fillStyle=this.debugGridColor[0],l.strokeRect(d.x*e.pixelDensityRatio,d.y*e.pixelDensityRatio,d.width*e.pixelDensityRatio,d.height*e.pixelDensityRatio),l.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(d,l,p,f){this.viewer.raiseEvent("tile-drawing",{tiledImage:d,context:l,tile:p,rendered:f})}_prepareNewFrame(){var d=this._calculateCanvasSize();if((this.canvas.width!==d.x||this.canvas.height!==d.y)&&(this.canvas.width=d.x,this.canvas.height=d.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var l=this._calculateSketchCanvasSize();this.sketchCanvas.width=l.x,this.sketchCanvas.height=l.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(d,l){var p=this._getContext(d);if(l)p.clearRect(l.x,l.y,l.width,l.height);else{var f=p.canvas;p.clearRect(0,0,f.width,f.height)}}_drawTiles(d){var l=d.getTilesToDraw().map(O=>O.tile);if(!(d.opacity===0||l.length===0&&!d.placeholderFillStyle)){var p=l[0],f;p&&(f=d.opacity<1||d.compositeOperation&&d.compositeOperation!=="source-over"||!d._isBottomItem()&&d.source.hasTransparency(p.context2D,p.getUrl(),p.ajaxHeaders,p.postData));var m,v,w=this.viewport.getZoom(!0),T=d.viewportToImageZoom(w);l.length>1&&T>d.smoothTileEdgesMinZoom&&!d.iOSDevice&&d.getRotation(!0)%360===0&&(f=!0,m=p.getScaleForEdgeSmoothing(),v=p.getTranslationForEdgeSmoothing(m,this._getCanvasSize(!1),this._getCanvasSize(!0)));var A;f&&(m||(A=this.viewport.viewportToViewerElementRectangle(d.getClippedBounds(!0)).getIntegerBoundingBox(),A=A.times(e.pixelDensityRatio)),this._clear(!0,A)),m||this._setRotations(d,f);var F=!1;if(d._clip){this._saveContext(f);var H=d.imageToViewportRectangle(d._clip,!0);H=H.rotate(-d.getRotation(!0),d._getRotationPoint(!0));var q=this.viewportToDrawerRectangle(H);m&&(q=q.times(m)),v&&(q=q.translate(v)),this._setClip(q,f),F=!0}if(d._croppingPolygons){var J=this;F||this._saveContext(f);try{var D=d._croppingPolygons.map(function(O){return O.map(function(M){var V=d.imageToViewportCoordinates(M.x,M.y,!0).rotate(-d.getRotation(!0),d._getRotationPoint(!0)),Ce=J.viewportCoordToDrawerCoord(V);return m&&(Ce=Ce.times(m)),v&&(Ce=Ce.plus(v)),Ce})});this._clipWithPolygons(D,f)}catch(O){e.console.error(O)}F=!0}if(d._hasOpaqueTile=!1,d.placeholderFillStyle&&d._hasOpaqueTile===!1){let O=this.viewportToDrawerRectangle(d.getBoundsNoRotate(!0));m&&(O=O.times(m)),v&&(O=O.translate(v));let M=null;typeof d.placeholderFillStyle=="function"?M=d.placeholderFillStyle(d,this.context):M=d.placeholderFillStyle,this._drawRectangle(O,M,f)}var E=c(d.subPixelRoundingForTransparency),S=!1;if(E===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)S=!0;else if(E===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var k=this.viewer&&this.viewer.isAnimating();S=!k}for(var L=0;L<l.length;L++)p=l[L],this._drawTile(p,d,f,m,v,S,d.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:d,tile:p});F&&this._restoreContext(f),m||(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(f),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(f)),f&&(m&&this._setRotations(d),this.blendSketch({opacity:d.opacity,scale:m,translate:v,compositeOperation:d.compositeOperation,bounds:A}),m&&(d.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(d,l),this._raiseTiledImageDrawnEvent(d,l)}}_drawDebugInfo(d,l){if(d.debugMode)for(var p=l.length-1;p>=0;p--){var f=l[p];try{this._drawDebugInfoOnTile(f,l.length,p,d)}catch(m){e.console.error(m)}}}_clipWithPolygons(d,l){var p=this._getContext(l);p.beginPath();for(const f of d)for(const[m,v]of f.entries())p[m===0?"moveTo":"lineTo"](v.x,v.y);p.clip()}_drawTile(d,l,p,f,m,v,w){e.console.assert(d,"[Drawer._drawTile] tile is required"),e.console.assert(l,"[Drawer._drawTile] drawingHandler is required");var T=this._getContext(p);f=f||1,this._drawTileToCanvas(d,T,l,f,m,v,w)}_drawTileToCanvas(d,l,p,f,m,v,w){var T=d.position.times(e.pixelDensityRatio),A=d.size.times(e.pixelDensityRatio),F;if(!d.context2D&&!d.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",d.toString());return}if(F=d.getCanvasContext(),!d.loaded||!F){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",d.toString());return}l.save(),typeof f=="number"&&f!==1&&(T=T.times(f),A=A.times(f)),m instanceof e.Point&&(T=T.plus(m)),l.globalAlpha===1&&d.hasTransparency&&(v&&(T.x=Math.round(T.x),T.y=Math.round(T.y),A.x=Math.round(A.x),A.y=Math.round(A.y)),l.clearRect(T.x,T.y,A.x,A.y)),this._raiseTileDrawingEvent(p,l,d,F);var H,q;d.sourceBounds?(H=Math.min(d.sourceBounds.width,F.canvas.width),q=Math.min(d.sourceBounds.height,F.canvas.height)):(H=F.canvas.width,q=F.canvas.height),l.translate(T.x+A.x/2,0),d.flipped&&l.scale(-1,1),l.drawImage(F.canvas,0,0,H,q,-A.x/2,T.y,A.x,A.y),l.restore()}_getContext(d){var l=this.context;if(d){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var p=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=p.x,this.sketchCanvas.height=p.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var f=this;this.viewer.addHandler("rotate",function m(){if(f.viewport.getRotation()!==0){f.viewer.removeHandler("rotate",m);var v=f._calculateSketchCanvasSize();f.sketchCanvas.width=v.x,f.sketchCanvas.height=v.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}l=this.sketchContext}return l}_saveContext(d){this._getContext(d).save()}_restoreContext(d){this._getContext(d).restore()}_setClip(d,l){var p=this._getContext(l);p.beginPath(),p.rect(d.x,d.y,d.width,d.height),p.clip()}_drawRectangle(d,l,p){var f=this._getContext(p);f.save(),f.fillStyle=l,f.fillRect(d.x,d.y,d.width,d.height),f.restore()}blendSketch(d,l,p,f){var m=d;e.isPlainObject(m)||(m={opacity:d,scale:l,translate:p,compositeOperation:f}),d=m.opacity,f=m.compositeOperation;var v=m.bounds;if(this.context.save(),this.context.globalAlpha=d,f&&(this.context.globalCompositeOperation=f),v)v.x<0&&(v.width+=v.x,v.x=0),v.x+v.width>this.canvas.width&&(v.width=this.canvas.width-v.x),v.y<0&&(v.height+=v.y,v.y=0),v.y+v.height>this.canvas.height&&(v.height=this.canvas.height-v.y),this.context.drawImage(this.sketchCanvas,v.x,v.y,v.width,v.height,v.x,v.y,v.width,v.height);else{l=m.scale||1,p=m.translate;var w=p instanceof e.Point?p:new e.Point(0,0),T=0,A=0;if(p){var F=this.sketchCanvas.width-this.canvas.width,H=this.sketchCanvas.height-this.canvas.height;T=Math.round(F/2),A=Math.round(H/2)}this.context.drawImage(this.sketchCanvas,w.x-T*l,w.y-A*l,(this.canvas.width+2*T)*l,(this.canvas.height+2*A)*l,-T,-A,this.canvas.width+2*T,this.canvas.height+2*A)}this.context.restore()}_drawDebugInfoOnTile(d,l,p,f){var m=this.viewer.world.getIndexOfItem(f)%this.debugGridColor.length,v=this.context;v.save(),v.lineWidth=2*e.pixelDensityRatio,v.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",v.strokeStyle=this.debugGridColor[m],v.fillStyle=this.debugGridColor[m],this._setRotations(f),this._viewportFlipped&&this._flip({point:d.position.plus(d.size.divide(2))}),v.strokeRect(d.position.x*e.pixelDensityRatio,d.position.y*e.pixelDensityRatio,d.size.x*e.pixelDensityRatio,d.size.y*e.pixelDensityRatio);var w=(d.position.x+d.size.x/2)*e.pixelDensityRatio,T=(d.position.y+d.size.y/2)*e.pixelDensityRatio;v.translate(w,T);const A=this.viewport.getRotation(!0);v.rotate(Math.PI/180*-A),v.translate(-w,-T),d.x===0&&d.y===0&&(v.fillText("Zoom: "+this.viewport.getZoom(),d.position.x*e.pixelDensityRatio,(d.position.y-30)*e.pixelDensityRatio),v.fillText("Pan: "+this.viewport.getBounds().toString(),d.position.x*e.pixelDensityRatio,(d.position.y-20)*e.pixelDensityRatio)),v.fillText("Level: "+d.level,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+20)*e.pixelDensityRatio),v.fillText("Column: "+d.x,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+30)*e.pixelDensityRatio),v.fillText("Row: "+d.y,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+40)*e.pixelDensityRatio),v.fillText("Order: "+p+" of "+l,(d.position.x+10)*e.pixelDensityRatio,(d.position.y+50)*e.pixelDensityRatio),v.fillText("Size: "+d.size.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+60)*e.pixelDensityRatio),v.fillText("Position: "+d.position.toString(),(d.position.x+10)*e.pixelDensityRatio,(d.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),f.getRotation(!0)%360!==0&&this._restoreRotationChanges(),v.restore()}_updateImageSmoothingEnabled(d){d.msImageSmoothingEnabled=this._imageSmoothingEnabled,d.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(d){var l=this._getContext(d).canvas;return new e.Point(l.width,l.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(d,l=!1){var p=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:l,saveContext:p}),p=!1),d.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:d.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(d._getRotationPoint(!0),!0),useSketch:l,saveContext:p})}_offsetForRotation(d){var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),p=this._getContext(d.useSketch);p.save(),p.translate(l.x,l.y),p.rotate(Math.PI/180*d.degrees),p.translate(-l.x,-l.y)}_flip(d){d=d||{};var l=d.point?d.point.times(e.pixelDensityRatio):this._getCanvasCenter(),p=this._getContext(d.useSketch);p.translate(l.x,0),p.scale(-1,1),p.translate(-l.x,0)}_restoreRotationChanges(d){var l=this._getContext(d);l.restore()}_calculateCanvasSize(){var d=e.pixelDensityRatio,l=this.viewport.getContainerSize();return{x:Math.round(l.x*d),y:Math.round(l.y*d)}}_calculateSketchCanvasSize(){var d=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return d;var l=Math.ceil(Math.sqrt(d.x*d.x+d.y*d.y));return{x:l,y:l}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(h){return h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&h!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(h){return o(h)?r:h}function c(h){if(typeof h=="number")return a(h);if(!h||!e.Browser)return r;var d=h[e.Browser.vendor];return o(d)&&(d=h["*"]),a(d)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let c=0;c<o;++c)r.activeTexture(r.TEXTURE0+c),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let c={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},h=this.viewport.flipped?-1:1,d=e.Mat3.makeTranslation(-c.center.x,-c.center.y),l=e.Mat3.makeScaling(2/c.bounds.width*h,-2/c.bounds.height),p=e.Mat3.makeRotation(-c.rotation),f=l.multiply(p).multiply(d);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let m=!1;r.forEach((v,w)=>{if(v.isTainted()){m&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),m=!1);const T=this._getBackupCanvasDrawer();T.draw([v]),this._outputContext.drawImage(T.canvas,0,0)}else{let T=v.getTilesToDraw();if(v.placeholderFillStyle&&v._hasOpaqueTile===!1&&this._drawPlaceholder(v),T.length===0||v.getOpacity()===0)return;let A=T[0],F=v.compositeOperation||this.viewer.compositeOperation||v._clip||v._croppingPolygons||v.debugMode,H=F||v.opacity<1||A.hasTransparency;F&&(m&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),H?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let q=f,J=v.getRotation(!0);if(J%360!==0){let O=e.Mat3.makeRotation(-J*Math.PI/180),M=v.getBoundsNoRotate(!0).getCenter(),V=e.Mat3.makeTranslation(M.x,M.y),Ce=e.Mat3.makeTranslation(-M.x,-M.y),Ie=V.multiply(O).multiply(Ce);q=f.multiply(Ie)}let D=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(D<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${D}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let E=new Float32Array(D*12),S=new Array(D),k=new Array(D),L=new Array(D);for(let O=0;O<T.length;O++){let M=T[O].tile,V=O%D,Ce=V+1,Ie=M.getCanvasContext(),Oe=Ie?this._TextureMap.get(Ie.canvas):null;if(Oe||(this._tileReadyHandler({tile:M,tiledImage:v}),Oe=Ie?this._TextureMap.get(Ie.canvas):null),Oe&&this._getTileData(M,v,Oe,q,V,E,S,k,L),Ce===D||O===T.length-1){for(let ne=0;ne<=Ce;ne++)o.activeTexture(o.TEXTURE0+ne),o.bindTexture(o.TEXTURE_2D,S[ne]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,E,o.DYNAMIC_DRAW),k.forEach((ne,Te)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[Te],!1,ne)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(L)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*Ce)}}H&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,v.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),m=!0,F&&(this._applyContext2dPipeline(v,T,w),m=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),w===0&&this._raiseTiledImageDrawnEvent(v,T.map(O=>O.tile))}}),m&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const c=this.viewer.viewport.getFlip();c&&this._flip(),this._drawDebugInfo(o,r,c),c&&this._flip()}}_getTileData(r,o,a,c,h,d,l,p,f){let m=a.texture,v=a.position;d.set(v,h*12);let w=this._calculateOverlapFraction(r,o),T=r.positionedBounds.width*w.x,A=r.positionedBounds.height*w.y,F=r.positionedBounds.x+(r.x===0?0:T),H=r.positionedBounds.y+(r.y===0?0:A),q=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:T),J=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:A),D=q-F,E=J-H,S=new e.Mat3([D,0,0,0,E,0,F,H,1]);if(r.flipped){let L=e.Mat3.makeTranslation(.5,0),O=e.Mat3.makeTranslation(-.5,0),M=L.multiply(e.Mat3.makeScaling(-1,1)).multiply(O);S=S.multiply(M)}let k=c.multiply(S);f[h]=r.opacity,l[h]=m,p[h]=k.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(m=>`uniform mat3 u_matrix_${m};`).join(`
`),a=()=>[...Array(r).keys()].map(m=>`${m>0?"else ":""}if(int(a_index) == ${m}) { transform_matrix = u_matrix_${m}; }`).join(`
`);const c=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,h=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let d=this._gl,l=this.constructor.initShaderProgram(d,c,h);d.useProgram(l),this._firstPass={shaderProgram:l,aOutputPosition:d.getAttribLocation(l,"a_output_position"),aTexturePosition:d.getAttribLocation(l,"a_texture_position"),aIndex:d.getAttribLocation(l,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(m=>d.getUniformLocation(l,`u_matrix_${m}`)),uImages:d.getUniformLocation(l,"u_images"),uOpacities:d.getUniformLocation(l,"u_opacities"),bufferOutputPosition:d.createBuffer(),bufferTexturePosition:d.createBuffer(),bufferIndex:d.createBuffer()},d.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let p=new Float32Array(r*12);for(let m=0;m<r;++m)p.set(Float32Array.from(this._unitQuad),m*12);d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),d.bufferData(d.ARRAY_BUFFER,p,d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aOutputPosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),d.enableVertexAttribArray(this._firstPass.aTexturePosition),d.bindBuffer(d.ARRAY_BUFFER,this._firstPass.bufferIndex);let f=[...Array(this._glNumTextures).keys()].map(m=>Array(6).fill(m)).flat();d.bufferData(d.ARRAY_BUFFER,new Float32Array(f),d.STATIC_DRAW),d.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,c=this.constructor.initShaderProgram(a,r,o);a.useProgram(c),this._secondPass={shaderProgram:c,aOutputPosition:a.getAttribLocation(c,"a_output_position"),aTexturePosition:a.getAttribLocation(c,"a_texture_position"),uMatrix:a.getUniformLocation(c,"u_matrix"),uImage:a.getUniformLocation(c,"u_image"),uOpacityMultiplier:a.getUniformLocation(c,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let h=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,h.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,c){return new Float32Array([r,c,o,c,r,a,r,a,o,c,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let c=o.getCanvasContext(),h=c&&c.canvas;if(!h||e.isCanvasTainted(h)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(h)){let l=this._gl,p=l.createTexture(),f,m=a.source.tileOverlap,v,w;if(o.sourceBounds?(v=Math.min(o.sourceBounds.width,h.width)/h.width,w=Math.min(o.sourceBounds.height,h.height)/h.height):(v=1,w=1),m>0){let A=this._calculateOverlapFraction(o,a),F=(o.x===0?0:A.x)*v,H=(o.y===0?0:A.y)*w,q=(o.isRightMost?1:1-A.x)*v,J=(o.isBottomMost?1:1-A.y)*w;f=this._makeQuadVertexBuffer(F,q,H,J)}else v===1&&w===1?f=this._unitQuad:f=this._makeQuadVertexBuffer(0,v,0,w);let T={texture:p,position:f};this._TextureMap.set(h,T),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,p),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,this._textureFilter()),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(c)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,c=r.sourceBounds.width,h=r.sourceBounds.height,d=(r.x===0?0:a)+(r.isRightMost?0:a),l=(r.y===0?0:a)+(r.isBottomMost?0:a),p=a/(c+d),f=a/(h+l);return{x:p,y:f}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(c){e.console.error("Error uploading image data to WebGL",c)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)});this._clippingContext.beginPath(),a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(c=>{let h=r.imageToViewportCoordinates(c.x,c.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(h)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((c,h)=>{this._clippingContext[h===0?"moveTo":"lineTo"](c.x,c.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var c=r.length-1;c>=0;c--){var h=r[c].tile;try{this._drawDebugInfoOnTile(h,r.length,c,o,a)}catch(d){e.console.error(d)}}}_drawDebugInfoOnTile(r,o,a,c,h){var d=this.viewer.world.getIndexOfItem(c)%this.debugGridColor.length,l=this.context;l.save(),l.lineWidth=2*e.pixelDensityRatio,l.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",l.strokeStyle=this.debugGridColor[d],l.fillStyle=this.debugGridColor[d],this._setRotations(c),h&&this._flip({point:r.position.plus(r.size.divide(2))}),l.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var p=(r.position.x+r.size.x/2)*e.pixelDensityRatio,f=(r.position.y+r.size.y/2)*e.pixelDensityRatio;l.translate(p,f);const m=this.viewport.getRotation(!0);l.rotate(Math.PI/180*-m),l.translate(-p,-f),r.x===0&&r.y===0&&(l.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),l.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),l.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),l.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),l.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),l.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),l.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),l.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),c.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),c=this._outputContext;let h;typeof r.placeholderFillStyle=="function"?h=r.placeholderFillStyle(r,c):h=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),c.fillStyle=h,c.translate(a.x,a.y),c.rotate(Math.PI/180*o.degrees),c.translate(-a.x,-a.y),c.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function c(p,f,m){const v=p.createShader(f);return p.shaderSource(v,m),p.compileShader(v),p.getShaderParameter(v,p.COMPILE_STATUS)?v:(e.console.error(`An error occurred compiling the shaders: ${p.getShaderInfoLog(v)}`),p.deleteShader(v),null)}const h=c(r,r.VERTEX_SHADER,o),d=c(r,r.FRAGMENT_SHADER,a),l=r.createProgram();return r.attachShader(l,h),r.attachShader(l,d),r.linkProgram(l),r.getProgramParameter(l,r.LINK_STATUS)?l:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(l)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,c,h,d,l,p,f;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),c=1/a,h=c/this.getAspectRatio(),d=new e.Rect(n.x-c/2,n.y-h/2,c,h),l=this._pixelFromPoint(this.zoomPoint,d),p=l.minus(o).rotate(-this.getRotation(!0)),f=p.divide(this._containerInnerSize.x*a),r.plus(f)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var c=n.x+n.width,h=r.x+r.width,d,l,p;n.width>r.width?d=this.visibilityRatio*r.width:d=this.visibilityRatio*n.width,l=r.x-c+d,p=h-n.x-d,d>r.width?(n.x+=(l+p)/2,o=!0):p<0?(n.x+=p,o=!0):l>0&&(n.x+=l,o=!0)}if(!this.wrapVertical){var f=n.y+n.height,m=r.y+r.height,v,w,T;n.height>r.height?v=this.visibilityRatio*r.height:v=this.visibilityRatio*n.height,w=r.y-f+v,T=m-n.y-v,v>r.height?(n.y+=(w+T)/2,a=!0):T<0?(n.y+=T,a=!0):w>0&&(n.y+=w,a=!0)}var A=o||a,F=A?this.viewerElementToViewportRectangle(n):i.clone();return F.xConstrained=o,F.yConstrained=a,F.constraintApplied=A,F},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),c=i.getCenter(),h=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();h.getAspectRatio()>=a?h.height=h.width/a:h.width=h.height*a,h.x=c.x-h.width/2,h.y=c.y-h.height/2;var d=1/h.width;if(r)return this.panTo(c,!0),this.zoomTo(d,null,!0),o&&this.applyConstraints(!0),this;var l=this.getCenter(!0),p=this.getZoom(!0);this.panTo(l,!0),this.zoomTo(p,null,!0);var f=this.getBounds(),m=this.getZoom();if(m===0||Math.abs(d/m-1)<1e-8)return this.zoomTo(d,null,!0),this.panTo(c,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(c,!1),d=this._applyZoomConstraints(d),this.zoomTo(d,null,!1);var v=this.getConstrainedBounds();this.panTo(l,!0),this.zoomTo(p,null,!0),this.fitBounds(v)}else{var w=h.rotate(-this.getRotation()),T=w.getTopLeft().times(d).minus(f.getTopLeft().times(m)).divide(d-m);this.zoomTo(d,T,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),c=e.positiveModulo(i,360),h=c-a;h>180?c-=360:h<-180&&(c+=360);var d=a-c;this.degreesSpring.resetTo(i+d),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var c=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),c},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.imageToViewportRectangle(i,n,r,o,!0)}}var d=this.imageToViewportCoordinates(a.x,a.y),l=this._imageToViewportDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var c=this.viewer.world.getItemCount();if(c>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(c===1){var h=this.viewer.world.getItemAt(0);return h.viewportToImageRectangle(i,n,r,o,!0)}}var d=this.viewportToImageCoordinates(a.x,a.y),l=this._viewportToImageDelta(a.width,a.height);return new e.Rect(d.x,d.y,l.x,l.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=a/o*c;return i*h},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,c=this._contentBoundsNoRotate.width,h=o/a/c;return i*h},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var c=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var h=i.degrees||0;delete i.degrees;var d=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:h,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,c,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(d,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),c=n||r||o||a||this._needsUpdate;if(c||i||!this._fullyLoaded){let h=this._updateLevelsForViewport();this._setFullyLoaded(h)}return this._needsUpdate=!1,c?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,c=(o.y+r%o.y)%o.y,h=this.source.getTileBounds(i,a,c);return this.getFlip()&&(h.x=Math.max(0,1-h.x-h.width)),h.x+=(n-a)/o.x,h.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-c)/o.y),h},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var c=i;c instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.imageToViewportCoordinates(c.getTopLeft(),a),d=this._imageToViewportDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var c=i;i instanceof e.Rect?a=n:c=new e.Rect(i,n,r,o);var h=this.viewportToImageCoordinates(c.getTopLeft(),a),d=this._viewportToImageDelta(c.width,c.height,a);return new e.Rect(h.x,h.y,d.x,d.y,c.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,c=0,h=0,d=1,l=1;if(this._clip&&(a=this._clip.getAspectRatio(),d=this._clip.width/this.source.dimensions.x,l=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(c=this._clip.x/this._clip.height*i.height,h=this._clip.y/this._clip.height*i.height):(c=this._clip.x/this._clip.width*i.width,h=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var p=i.height/l,f=0;o.isHorizontallyCentered?f=(i.width-i.height*a)/2:o.isRight&&(f=i.width-i.height*a),this.setPosition(new e.Point(i.x-c+f,i.y-h),r),this.setHeight(p,r)}else{var m=i.width/d,v=0;o.isVerticallyCentered?v=(i.height-i.width/a)/2:o.isBottom&&(v=i.height-i.width/a),this.setPosition(new e.Point(i.x-c,i.y-h+v),r),this.setWidth(m,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var c in this.tilesMatrix){n=this.source.getNumTiles(c);for(var h in this.tilesMatrix[c]){r=(n.x+h%n.x)%n.x;for(var d in this.tilesMatrix[c][h])if(o=(n.y+d%n.y)%n.y,a=this.tilesMatrix[c][h][d],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var l=this.source.getTileAjaxHeaders(c,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,l)}else a.ajaxHeaders=null}}for(var p=0;p<this._imageLoader.jobQueue.length;p++){var f=this._imageLoader.jobQueue[p];f.loadWithAjax=f.tile.loadWithAjax,f.ajaxHeaders=f.tile.loadWithAjax?f.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),c=e.now();if(this._lastDrawn.forEach(q=>{q.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var h=new Array(r-n+1);for(let q=0,J=r;J>=n;J--,q++)h[q]=J;for(let q=r+1;q<=this.source.maxLevel;q++){var d=this.tilesMatrix[q]&&this.tilesMatrix[q][0]&&this.tilesMatrix[q][0][0];if(d&&d.isBottomMost&&d.isRightMost&&d.loaded){h.push(q);break}}let l=!1;for(let q=0;q<h.length;q++){let J=h[q];var p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!0).x*this._scaleSpring.current.value;if(q===h.length-1||p>=this.minPixelRatio)l=!0;else if(!l)continue;var f=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(J),!1).x*this._scaleSpring.current.value,m=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,v=this.immediateRender?1:m,w=Math.min(1,(p-.5)/.5),T=v/Math.abs(v-f),A=this._updateLevel(J,w,T,a,c,o);o=A.bestTiles;var F=A.updatedTiles.filter(D=>D.loaded),H=function(D,E,S){return function(k){return{tile:k,level:D,levelOpacity:E,currentTime:S}}}(J,w,c);if(this._tilesToDraw[J]=F.map(H),this._providesCoverage(this.coverage,J))break}return o&&o.length>0?(o.forEach(function(q){q&&!q.context2D&&this._loadTile(q,c)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function c(d){let l=d.tile;if(l&&l.loaded){let p=r._blendTile(l,l.x,l.y,d.level,d.levelOpacity,n,o);r._isBlending=r._isBlending||p,r._needsDraw=r._needsDraw||p||r._wasBlending}}let h=0;for(let d=0;d<i.length;d++){let l=i[d];c(l),this._providesCoverage(this.coverage,l.level)&&(h=Math.max(h,l.level))}if(h>0)for(let d in this._tilesToDraw)d<h&&delete this._tilesToDraw[d]},_blendTile:function(i,n,r,o,a,c,h){let d=1e3*this.blendTime,l,p;return i.blendStart||(i.blendStart=c),l=c-i.blendStart,p=d?Math.min(1,l/d):1,o===h&&(p=1,l=d),this.alwaysBlend&&(p*=a),i.opacity=p,p===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),l<d},_updateLevel:function(i,n,r,o,a,c){var h=o.getBoundingBox().getTopLeft(),d=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:h,bottomright:d,currenttime:a,best:c}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var l=this._getCornerTiles(i,h,d),p=l.topLeft,f=l.bottomRight,m=this.source.getNumTiles(i),v=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(f.x+=1,this.wrapHorizontal||(f.x=Math.min(f.x,m.x-1)));for(var w=Math.max(0,(f.x-p.x)*(f.y-p.y)),T=new Array(w),A=0,F=p.x;F<=f.x;F++)for(var H=p.y;H<=f.y;H++){var q;if(this.getFlip()){var J=(m.x+F%m.x)%m.x;q=F+m.x-J-J-1}else q=F;if(o.intersection(this.getTileBounds(i,q,H))!==null){var D=this._updateTile(q,H,i,r,v,m,a,c);c=D.bestTiles,T[A]=D.tile,A+=1}}return{bestTiles:c,updatedTiles:T}},_positionTile:function(i,n,r,o,a){var c=i.bounds.getTopLeft();c.x*=this._scaleSpring.current.value,c.y*=this._scaleSpring.current.value,c.x+=this._xSpring.current.value,c.y+=this._ySpring.current.value;var h=i.bounds.getSize();h.x*=this._scaleSpring.current.value,h.y*=this._scaleSpring.current.value,i.positionedBounds.x=c.x,i.positionedBounds.y=c.y,i.positionedBounds.width=h.x,i.positionedBounds.height=h.y;var d=r.pixelFromPointNoRotate(c,!0),l=r.pixelFromPointNoRotate(c,!1),p=r.deltaPixelsFromPointsNoRotate(h,!0),f=r.deltaPixelsFromPointsNoRotate(h,!1),m=l.plus(f.divide(2)),v=o.squaredDistanceTo(m);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(p=p.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(p.x+=.75),i.isBottomMost&&this.wrapVertical&&(p.y+=.75)),i.position=d,i.size=p,i.squaredDistance=v,i.visibility=a},_updateTile:function(i,n,r,o,a,c,h,d){var l=this._getTile(i,n,r,h,c);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:l}),this._setCoverage(this.coverage,r,i,n,!1);var p=l.loaded||l.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,p),!l.exists)return{bestTiles:d,tile:l};if(l.loaded&&l.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(l,this.source.tileOverlap,this.viewport,a,o),!l.loaded)if(l.context2D)this._setTileLoaded(l);else{var f=this._tileCache.getImageRecord(l.cacheKey);f&&this._setTileLoaded(l,f.getData())}return l.loading?this._tilesLoading++:p||(d=this._compareTiles(d,l,this.maxTilesPerFrame)),{bestTiles:d,tile:l}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var c,h,d=1/this.source.aspectRatio;this.wrapVertical?(c=e.positiveModulo(n.y,d),h=e.positiveModulo(r.y,d)):(c=Math.max(0,n.y),h=Math.min(d,r.y));var l=this.source.getTileAtPoint(i,new e.Point(o,c)),p=this.source.getTileAtPoint(i,new e.Point(a,h)),f=this.source.getNumTiles(i);return this.wrapHorizontal&&(l.x+=f.x*Math.floor(n.x),p.x+=f.x*Math.floor(r.x)),this.wrapVertical&&(l.y+=f.y*Math.floor(n.y/d),p.y+=f.y*Math.floor(r.y/d)),{topLeft:l,bottomRight:p}},_getTile:function(i,n,r,o,a){var c,h,d,l,p,f,m,v,w,T,A=this.tilesMatrix,F=this.source;return A[r]||(A[r]={}),A[r][i]||(A[r][i]={}),(!A[r][i][n]||!A[r][i][n].flipped!=!this.flipped)&&(c=(a.x+i%a.x)%a.x,h=(a.y+n%a.y)%a.y,d=this.getTileBounds(r,i,n),l=F.getTileBounds(r,c,h,!0),p=F.tileExists(r,c,h),f=F.getTileUrl(r,c,h),m=F.getTilePostData(r,c,h),this.loadTilesWithAjax?(v=F.getTileAjaxHeaders(r,c,h),e.isPlainObject(this.ajaxHeaders)&&(v=e.extend({},this.ajaxHeaders,v))):v=null,w=F.getContext2D?F.getContext2D(r,c,h):void 0,T=new e.Tile(r,i,n,d,p,f,w,this.loadTilesWithAjax,v,l,m,F.getTileHashKey(r,c,h,f,v,m)),this.getFlip()?c===0&&(T.isRightMost=!0):c===a.x-1&&(T.isRightMost=!0),h===a.y-1&&(T.isBottomMost=!0),T.flipped=this.flipped,A[r][i][n]=T),T=A[r][i][n],T.lastTouchTime=o,T},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,c){r._onTileLoad(i,n,o,a,c)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var c=this,h=function(){var d=c.source,l=d.getClosestLevel();c._setTileLoaded(i,r,l,a)};h()},_setTileLoaded:function(i,n,r,o){var a=0,c=!1,h=this;function d(){return c&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,l}function l(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=h.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||h._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:h}),h.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:h,tileRequest:o}),h._needsDraw=!0)}var p=d();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:d}),c=!0,p()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,c,h,d;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(h in a)if(Object.prototype.hasOwnProperty.call(a,h)){c=a[h];for(d in c)if(Object.prototype.hasOwnProperty.call(c,d)&&!c[d])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,c=this._imagesLoaded[r.tile.cacheKey];if(c||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),c=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),c.addTile(r.tile),r.tile.cacheImageRecord=c,this._imagesLoadedCount>this._maxImageCacheCount){for(var h=null,d=-1,l=null,p,f,m,v,w,T,A=this._tilesLoaded.length-1;A>=0;A--)if(T=this._tilesLoaded[A],p=T.tile,!(p.level<=o||p.beingDrawn)){if(!h){h=p,d=A,l=T;continue}v=p.lastTouchTime,f=h.lastTouchTime,w=p.level,m=h.level,(v<f||v===f&&w>m)&&(h=p,d=A,l=T)}h&&d>=0&&(this._unloadTile(l),a=d)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let c=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var h=this._imagesLoaded[o.cacheKey];h&&(h.removeTile(o),h.getTileCount()||(h.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,c&&(c.canvas.width=0,c.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:c,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,c=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,h=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,d=c+h,l;!i.rows&&a?l=a:l=Math.ceil(this._items.length/o);var p=0,f=0,m,v,w,T,A;this.setAutoRefigureSizes(!1);for(var F=0;F<this._items.length;F++)F&&F%l===0&&(r==="horizontal"?(f+=d,p=0):(p+=d,f=0)),m=this._items[F],v=m.getBounds(),v.width>v.height?w=c:w=c*(v.width/v.height),T=w*(v.height/v.width),A=new e.Point(p+(c-w)/2,f+(c-T)/2),m.setPosition(A,n),m.setWidth(w,n),r==="horizontal"?p+=d:f+=d;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var c=o.getClippedBounds().getBoundingBox(),h=c.x,d=c.y,l=c.x+c.width,p=c.y+c.height,f=1;f<this._items.length;f++)o=this._items[f],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),c=o.getClippedBounds().getBoundingBox(),h=Math.min(h,c.x),d=Math.min(d,c.y),l=Math.max(l,c.x+c.width),p=Math.max(p,c.y+c.height);this._homeBounds=new e.Rect(h,d,l-h,p-d),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(Mc);var Ju=Mc.exports;const et=Ku(Ju);var mi={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(s){(function(){var t=function(){this.init()};t.prototype={init:function(){var l=this||e;return l._counter=1e3,l._html5AudioPool=[],l.html5PoolSize=10,l._codecs={},l._howls=[],l._muted=!1,l._volume=1,l._canPlayEvent="canplaythrough",l._navigator=typeof window<"u"&&window.navigator?window.navigator:null,l.masterGain=null,l.noAudio=!1,l.usingWebAudio=!0,l.autoSuspend=!0,l.ctx=null,l.autoUnlock=!0,l._setup(),l},volume:function(l){var p=this||e;if(l=parseFloat(l),p.ctx||d(),typeof l<"u"&&l>=0&&l<=1){if(p._volume=l,p._muted)return p;p.usingWebAudio&&p.masterGain.gain.setValueAtTime(l,e.ctx.currentTime);for(var f=0;f<p._howls.length;f++)if(!p._howls[f]._webAudio)for(var m=p._howls[f]._getSoundIds(),v=0;v<m.length;v++){var w=p._howls[f]._soundById(m[v]);w&&w._node&&(w._node.volume=w._volume*l)}return p}return p._volume},mute:function(l){var p=this||e;p.ctx||d(),p._muted=l,p.usingWebAudio&&p.masterGain.gain.setValueAtTime(l?0:p._volume,e.ctx.currentTime);for(var f=0;f<p._howls.length;f++)if(!p._howls[f]._webAudio)for(var m=p._howls[f]._getSoundIds(),v=0;v<m.length;v++){var w=p._howls[f]._soundById(m[v]);w&&w._node&&(w._node.muted=l?!0:w._muted)}return p},stop:function(){for(var l=this||e,p=0;p<l._howls.length;p++)l._howls[p].stop();return l},unload:function(){for(var l=this||e,p=l._howls.length-1;p>=0;p--)l._howls[p].unload();return l.usingWebAudio&&l.ctx&&typeof l.ctx.close<"u"&&(l.ctx.close(),l.ctx=null,d()),l},codecs:function(l){return(this||e)._codecs[l.replace(/^x-/,"")]},_setup:function(){var l=this||e;if(l.state=l.ctx&&l.ctx.state||"suspended",l._autoSuspend(),!l.usingWebAudio)if(typeof Audio<"u")try{var p=new Audio;typeof p.oncanplaythrough>"u"&&(l._canPlayEvent="canplay")}catch{l.noAudio=!0}else l.noAudio=!0;try{var p=new Audio;p.muted&&(l.noAudio=!0)}catch{}return l.noAudio||l._setupCodecs(),l},_setupCodecs:function(){var l=this||e,p=null;try{p=typeof Audio<"u"?new Audio:null}catch{return l}if(!p||typeof p.canPlayType!="function")return l;var f=p.canPlayType("audio/mpeg;").replace(/^no$/,""),m=l._navigator?l._navigator.userAgent:"",v=m.match(/OPR\/(\d+)/g),w=v&&parseInt(v[0].split("/")[1],10)<33,T=m.indexOf("Safari")!==-1&&m.indexOf("Chrome")===-1,A=m.match(/Version\/(.*?) /),F=T&&A&&parseInt(A[1],10)<15;return l._codecs={mp3:!!(!w&&(f||p.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!f,opus:!!p.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!p.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!p.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(p.canPlayType('audio/wav; codecs="1"')||p.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!p.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!p.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(p.canPlayType("audio/x-m4a;")||p.canPlayType("audio/m4a;")||p.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(p.canPlayType("audio/x-m4b;")||p.canPlayType("audio/m4b;")||p.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(p.canPlayType("audio/x-mp4;")||p.canPlayType("audio/mp4;")||p.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!F&&p.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!F&&p.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!p.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(p.canPlayType("audio/x-flac;")||p.canPlayType("audio/flac;")).replace(/^no$/,"")},l},_unlockAudio:function(){var l=this||e;if(!(l._audioUnlocked||!l.ctx)){l._audioUnlocked=!1,l.autoUnlock=!1,!l._mobileUnloaded&&l.ctx.sampleRate!==44100&&(l._mobileUnloaded=!0,l.unload()),l._scratchBuffer=l.ctx.createBuffer(1,1,22050);var p=function(f){for(;l._html5AudioPool.length<l.html5PoolSize;)try{var m=new Audio;m._unlocked=!0,l._releaseHtml5Audio(m)}catch{l.noAudio=!0;break}for(var v=0;v<l._howls.length;v++)if(!l._howls[v]._webAudio)for(var w=l._howls[v]._getSoundIds(),T=0;T<w.length;T++){var A=l._howls[v]._soundById(w[T]);A&&A._node&&!A._node._unlocked&&(A._node._unlocked=!0,A._node.load())}l._autoResume();var F=l.ctx.createBufferSource();F.buffer=l._scratchBuffer,F.connect(l.ctx.destination),typeof F.start>"u"?F.noteOn(0):F.start(0),typeof l.ctx.resume=="function"&&l.ctx.resume(),F.onended=function(){F.disconnect(0),l._audioUnlocked=!0,document.removeEventListener("touchstart",p,!0),document.removeEventListener("touchend",p,!0),document.removeEventListener("click",p,!0),document.removeEventListener("keydown",p,!0);for(var H=0;H<l._howls.length;H++)l._howls[H]._emit("unlock")}};return document.addEventListener("touchstart",p,!0),document.addEventListener("touchend",p,!0),document.addEventListener("click",p,!0),document.addEventListener("keydown",p,!0),l}},_obtainHtml5Audio:function(){var l=this||e;if(l._html5AudioPool.length)return l._html5AudioPool.pop();var p=new Audio().play();return p&&typeof Promise<"u"&&(p instanceof Promise||typeof p.then=="function")&&p.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(l){var p=this||e;return l._unlocked&&p._html5AudioPool.push(l),p},_autoSuspend:function(){var l=this;if(!(!l.autoSuspend||!l.ctx||typeof l.ctx.suspend>"u"||!e.usingWebAudio)){for(var p=0;p<l._howls.length;p++)if(l._howls[p]._webAudio){for(var f=0;f<l._howls[p]._sounds.length;f++)if(!l._howls[p]._sounds[f]._paused)return l}return l._suspendTimer&&clearTimeout(l._suspendTimer),l._suspendTimer=setTimeout(function(){if(l.autoSuspend){l._suspendTimer=null,l.state="suspending";var m=function(){l.state="suspended",l._resumeAfterSuspend&&(delete l._resumeAfterSuspend,l._autoResume())};l.ctx.suspend().then(m,m)}},3e4),l}},_autoResume:function(){var l=this;if(!(!l.ctx||typeof l.ctx.resume>"u"||!e.usingWebAudio))return l.state==="running"&&l.ctx.state!=="interrupted"&&l._suspendTimer?(clearTimeout(l._suspendTimer),l._suspendTimer=null):l.state==="suspended"||l.state==="running"&&l.ctx.state==="interrupted"?(l.ctx.resume().then(function(){l.state="running";for(var p=0;p<l._howls.length;p++)l._howls[p]._emit("resume")}),l._suspendTimer&&(clearTimeout(l._suspendTimer),l._suspendTimer=null)):l.state==="suspending"&&(l._resumeAfterSuspend=!0),l}};var e=new t,i=function(l){var p=this;if(!l.src||l.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}p.init(l)};i.prototype={init:function(l){var p=this;return e.ctx||d(),p._autoplay=l.autoplay||!1,p._format=typeof l.format!="string"?l.format:[l.format],p._html5=l.html5||!1,p._muted=l.mute||!1,p._loop=l.loop||!1,p._pool=l.pool||5,p._preload=typeof l.preload=="boolean"||l.preload==="metadata"?l.preload:!0,p._rate=l.rate||1,p._sprite=l.sprite||{},p._src=typeof l.src!="string"?l.src:[l.src],p._volume=l.volume!==void 0?l.volume:1,p._xhr={method:l.xhr&&l.xhr.method?l.xhr.method:"GET",headers:l.xhr&&l.xhr.headers?l.xhr.headers:null,withCredentials:l.xhr&&l.xhr.withCredentials?l.xhr.withCredentials:!1},p._duration=0,p._state="unloaded",p._sounds=[],p._endTimers={},p._queue=[],p._playLock=!1,p._onend=l.onend?[{fn:l.onend}]:[],p._onfade=l.onfade?[{fn:l.onfade}]:[],p._onload=l.onload?[{fn:l.onload}]:[],p._onloaderror=l.onloaderror?[{fn:l.onloaderror}]:[],p._onplayerror=l.onplayerror?[{fn:l.onplayerror}]:[],p._onpause=l.onpause?[{fn:l.onpause}]:[],p._onplay=l.onplay?[{fn:l.onplay}]:[],p._onstop=l.onstop?[{fn:l.onstop}]:[],p._onmute=l.onmute?[{fn:l.onmute}]:[],p._onvolume=l.onvolume?[{fn:l.onvolume}]:[],p._onrate=l.onrate?[{fn:l.onrate}]:[],p._onseek=l.onseek?[{fn:l.onseek}]:[],p._onunlock=l.onunlock?[{fn:l.onunlock}]:[],p._onresume=[],p._webAudio=e.usingWebAudio&&!p._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(p),p._autoplay&&p._queue.push({event:"play",action:function(){p.play()}}),p._preload&&p._preload!=="none"&&p.load(),p},load:function(){var l=this,p=null;if(e.noAudio){l._emit("loaderror",null,"No audio support.");return}typeof l._src=="string"&&(l._src=[l._src]);for(var f=0;f<l._src.length;f++){var m,v;if(l._format&&l._format[f])m=l._format[f];else{if(v=l._src[f],typeof v!="string"){l._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}m=/^data:audio\/([^;,]+);/i.exec(v),m||(m=/\.([^.]+)$/.exec(v.split("?",1)[0])),m&&(m=m[1].toLowerCase())}if(m||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),m&&e.codecs(m)){p=l._src[f];break}}if(!p){l._emit("loaderror",null,"No codec support for selected audio sources.");return}return l._src=p,l._state="loading",window.location.protocol==="https:"&&p.slice(0,5)==="http:"&&(l._html5=!0,l._webAudio=!1),new n(l),l._webAudio&&o(l),l},play:function(l,p){var f=this,m=null;if(typeof l=="number")m=l,l=null;else{if(typeof l=="string"&&f._state==="loaded"&&!f._sprite[l])return null;if(typeof l>"u"&&(l="__default",!f._playLock)){for(var v=0,w=0;w<f._sounds.length;w++)f._sounds[w]._paused&&!f._sounds[w]._ended&&(v++,m=f._sounds[w]._id);v===1?l=null:m=null}}var T=m?f._soundById(m):f._inactiveSound();if(!T)return null;if(m&&!l&&(l=T._sprite||"__default"),f._state!=="loaded"){T._sprite=l,T._ended=!1;var A=T._id;return f._queue.push({event:"play",action:function(){f.play(A)}}),A}if(m&&!T._paused)return p||f._loadQueue("play"),T._id;f._webAudio&&e._autoResume();var F=Math.max(0,T._seek>0?T._seek:f._sprite[l][0]/1e3),H=Math.max(0,(f._sprite[l][0]+f._sprite[l][1])/1e3-F),q=H*1e3/Math.abs(T._rate),J=f._sprite[l][0]/1e3,D=(f._sprite[l][0]+f._sprite[l][1])/1e3;T._sprite=l,T._ended=!1;var E=function(){T._paused=!1,T._seek=F,T._start=J,T._stop=D,T._loop=!!(T._loop||f._sprite[l][2])};if(F>=D){f._ended(T);return}var S=T._node;if(f._webAudio){var k=function(){f._playLock=!1,E(),f._refreshBuffer(T);var V=T._muted||f._muted?0:T._volume;S.gain.setValueAtTime(V,e.ctx.currentTime),T._playStart=e.ctx.currentTime,typeof S.bufferSource.start>"u"?T._loop?S.bufferSource.noteGrainOn(0,F,86400):S.bufferSource.noteGrainOn(0,F,H):T._loop?S.bufferSource.start(0,F,86400):S.bufferSource.start(0,F,H),q!==1/0&&(f._endTimers[T._id]=setTimeout(f._ended.bind(f,T),q)),p||setTimeout(function(){f._emit("play",T._id),f._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?k():(f._playLock=!0,f.once("resume",k),f._clearTimer(T._id))}else{var L=function(){S.currentTime=F,S.muted=T._muted||f._muted||e._muted||S.muted,S.volume=T._volume*e.volume(),S.playbackRate=T._rate;try{var V=S.play();if(V&&typeof Promise<"u"&&(V instanceof Promise||typeof V.then=="function")?(f._playLock=!0,E(),V.then(function(){f._playLock=!1,S._unlocked=!0,p?f._loadQueue():f._emit("play",T._id)}).catch(function(){f._playLock=!1,f._emit("playerror",T._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),T._ended=!0,T._paused=!0})):p||(f._playLock=!1,E(),f._emit("play",T._id)),S.playbackRate=T._rate,S.paused){f._emit("playerror",T._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}l!=="__default"||T._loop?f._endTimers[T._id]=setTimeout(f._ended.bind(f,T),q):(f._endTimers[T._id]=function(){f._ended(T),S.removeEventListener("ended",f._endTimers[T._id],!1)},S.addEventListener("ended",f._endTimers[T._id],!1))}catch(Ce){f._emit("playerror",T._id,Ce)}};S.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(S.src=f._src,S.load());var O=window&&window.ejecta||!S.readyState&&e._navigator.isCocoonJS;if(S.readyState>=3||O)L();else{f._playLock=!0,f._state="loading";var M=function(){f._state="loaded",L(),S.removeEventListener(e._canPlayEvent,M,!1)};S.addEventListener(e._canPlayEvent,M,!1),f._clearTimer(T._id)}}return T._id},pause:function(l){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"pause",action:function(){p.pause(l)}}),p;for(var f=p._getSoundIds(l),m=0;m<f.length;m++){p._clearTimer(f[m]);var v=p._soundById(f[m]);if(v&&!v._paused&&(v._seek=p.seek(f[m]),v._rateSeek=0,v._paused=!0,p._stopFade(f[m]),v._node))if(p._webAudio){if(!v._node.bufferSource)continue;typeof v._node.bufferSource.stop>"u"?v._node.bufferSource.noteOff(0):v._node.bufferSource.stop(0),p._cleanBuffer(v._node)}else(!isNaN(v._node.duration)||v._node.duration===1/0)&&v._node.pause();arguments[1]||p._emit("pause",v?v._id:null)}return p},stop:function(l,p){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"stop",action:function(){f.stop(l)}}),f;for(var m=f._getSoundIds(l),v=0;v<m.length;v++){f._clearTimer(m[v]);var w=f._soundById(m[v]);w&&(w._seek=w._start||0,w._rateSeek=0,w._paused=!0,w._ended=!0,f._stopFade(m[v]),w._node&&(f._webAudio?w._node.bufferSource&&(typeof w._node.bufferSource.stop>"u"?w._node.bufferSource.noteOff(0):w._node.bufferSource.stop(0),f._cleanBuffer(w._node)):(!isNaN(w._node.duration)||w._node.duration===1/0)&&(w._node.currentTime=w._start||0,w._node.pause(),w._node.duration===1/0&&f._clearSound(w._node))),p||f._emit("stop",w._id))}return f},mute:function(l,p){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"mute",action:function(){f.mute(l,p)}}),f;if(typeof p>"u")if(typeof l=="boolean")f._muted=l;else return f._muted;for(var m=f._getSoundIds(p),v=0;v<m.length;v++){var w=f._soundById(m[v]);w&&(w._muted=l,w._interval&&f._stopFade(w._id),f._webAudio&&w._node?w._node.gain.setValueAtTime(l?0:w._volume,e.ctx.currentTime):w._node&&(w._node.muted=e._muted?!0:l),f._emit("mute",w._id))}return f},volume:function(){var l=this,p=arguments,f,m;if(p.length===0)return l._volume;if(p.length===1||p.length===2&&typeof p[1]>"u"){var v=l._getSoundIds(),w=v.indexOf(p[0]);w>=0?m=parseInt(p[0],10):f=parseFloat(p[0])}else p.length>=2&&(f=parseFloat(p[0]),m=parseInt(p[1],10));var T;if(typeof f<"u"&&f>=0&&f<=1){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"volume",action:function(){l.volume.apply(l,p)}}),l;typeof m>"u"&&(l._volume=f),m=l._getSoundIds(m);for(var A=0;A<m.length;A++)T=l._soundById(m[A]),T&&(T._volume=f,p[2]||l._stopFade(m[A]),l._webAudio&&T._node&&!T._muted?T._node.gain.setValueAtTime(f,e.ctx.currentTime):T._node&&!T._muted&&(T._node.volume=f*e.volume()),l._emit("volume",T._id))}else return T=m?l._soundById(m):l._sounds[0],T?T._volume:0;return l},fade:function(l,p,f,m){var v=this;if(v._state!=="loaded"||v._playLock)return v._queue.push({event:"fade",action:function(){v.fade(l,p,f,m)}}),v;l=Math.min(Math.max(0,parseFloat(l)),1),p=Math.min(Math.max(0,parseFloat(p)),1),f=parseFloat(f),v.volume(l,m);for(var w=v._getSoundIds(m),T=0;T<w.length;T++){var A=v._soundById(w[T]);if(A){if(m||v._stopFade(w[T]),v._webAudio&&!A._muted){var F=e.ctx.currentTime,H=F+f/1e3;A._volume=l,A._node.gain.setValueAtTime(l,F),A._node.gain.linearRampToValueAtTime(p,H)}v._startFadeInterval(A,l,p,f,w[T],typeof m>"u")}}return v},_startFadeInterval:function(l,p,f,m,v,w){var T=this,A=p,F=f-p,H=Math.abs(F/.01),q=Math.max(4,H>0?m/H:m),J=Date.now();l._fadeTo=f,l._interval=setInterval(function(){var D=(Date.now()-J)/m;J=Date.now(),A+=F*D,A=Math.round(A*100)/100,F<0?A=Math.max(f,A):A=Math.min(f,A),T._webAudio?l._volume=A:T.volume(A,l._id,!0),w&&(T._volume=A),(f<p&&A<=f||f>p&&A>=f)&&(clearInterval(l._interval),l._interval=null,l._fadeTo=null,T.volume(f,l._id),T._emit("fade",l._id))},q)},_stopFade:function(l){var p=this,f=p._soundById(l);return f&&f._interval&&(p._webAudio&&f._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(f._interval),f._interval=null,p.volume(f._fadeTo,l),f._fadeTo=null,p._emit("fade",l)),p},loop:function(){var l=this,p=arguments,f,m,v;if(p.length===0)return l._loop;if(p.length===1)if(typeof p[0]=="boolean")f=p[0],l._loop=f;else return v=l._soundById(parseInt(p[0],10)),v?v._loop:!1;else p.length===2&&(f=p[0],m=parseInt(p[1],10));for(var w=l._getSoundIds(m),T=0;T<w.length;T++)v=l._soundById(w[T]),v&&(v._loop=f,l._webAudio&&v._node&&v._node.bufferSource&&(v._node.bufferSource.loop=f,f&&(v._node.bufferSource.loopStart=v._start||0,v._node.bufferSource.loopEnd=v._stop,l.playing(w[T])&&(l.pause(w[T],!0),l.play(w[T],!0)))));return l},rate:function(){var l=this,p=arguments,f,m;if(p.length===0)m=l._sounds[0]._id;else if(p.length===1){var v=l._getSoundIds(),w=v.indexOf(p[0]);w>=0?m=parseInt(p[0],10):f=parseFloat(p[0])}else p.length===2&&(f=parseFloat(p[0]),m=parseInt(p[1],10));var T;if(typeof f=="number"){if(l._state!=="loaded"||l._playLock)return l._queue.push({event:"rate",action:function(){l.rate.apply(l,p)}}),l;typeof m>"u"&&(l._rate=f),m=l._getSoundIds(m);for(var A=0;A<m.length;A++)if(T=l._soundById(m[A]),T){l.playing(m[A])&&(T._rateSeek=l.seek(m[A]),T._playStart=l._webAudio?e.ctx.currentTime:T._playStart),T._rate=f,l._webAudio&&T._node&&T._node.bufferSource?T._node.bufferSource.playbackRate.setValueAtTime(f,e.ctx.currentTime):T._node&&(T._node.playbackRate=f);var F=l.seek(m[A]),H=(l._sprite[T._sprite][0]+l._sprite[T._sprite][1])/1e3-F,q=H*1e3/Math.abs(T._rate);(l._endTimers[m[A]]||!T._paused)&&(l._clearTimer(m[A]),l._endTimers[m[A]]=setTimeout(l._ended.bind(l,T),q)),l._emit("rate",T._id)}}else return T=l._soundById(m),T?T._rate:l._rate;return l},seek:function(){var l=this,p=arguments,f,m;if(p.length===0)l._sounds.length&&(m=l._sounds[0]._id);else if(p.length===1){var v=l._getSoundIds(),w=v.indexOf(p[0]);w>=0?m=parseInt(p[0],10):l._sounds.length&&(m=l._sounds[0]._id,f=parseFloat(p[0]))}else p.length===2&&(f=parseFloat(p[0]),m=parseInt(p[1],10));if(typeof m>"u")return 0;if(typeof f=="number"&&(l._state!=="loaded"||l._playLock))return l._queue.push({event:"seek",action:function(){l.seek.apply(l,p)}}),l;var T=l._soundById(m);if(T)if(typeof f=="number"&&f>=0){var A=l.playing(m);A&&l.pause(m,!0),T._seek=f,T._ended=!1,l._clearTimer(m),!l._webAudio&&T._node&&!isNaN(T._node.duration)&&(T._node.currentTime=f);var F=function(){A&&l.play(m,!0),l._emit("seek",m)};if(A&&!l._webAudio){var H=function(){l._playLock?setTimeout(H,0):F()};setTimeout(H,0)}else F()}else if(l._webAudio){var q=l.playing(m)?e.ctx.currentTime-T._playStart:0,J=T._rateSeek?T._rateSeek-T._seek:0;return T._seek+(J+q*Math.abs(T._rate))}else return T._node.currentTime;return l},playing:function(l){var p=this;if(typeof l=="number"){var f=p._soundById(l);return f?!f._paused:!1}for(var m=0;m<p._sounds.length;m++)if(!p._sounds[m]._paused)return!0;return!1},duration:function(l){var p=this,f=p._duration,m=p._soundById(l);return m&&(f=p._sprite[m._sprite][1]/1e3),f},state:function(){return this._state},unload:function(){for(var l=this,p=l._sounds,f=0;f<p.length;f++)p[f]._paused||l.stop(p[f]._id),l._webAudio||(l._clearSound(p[f]._node),p[f]._node.removeEventListener("error",p[f]._errorFn,!1),p[f]._node.removeEventListener(e._canPlayEvent,p[f]._loadFn,!1),p[f]._node.removeEventListener("ended",p[f]._endFn,!1),e._releaseHtml5Audio(p[f]._node)),delete p[f]._node,l._clearTimer(p[f]._id);var m=e._howls.indexOf(l);m>=0&&e._howls.splice(m,1);var v=!0;for(f=0;f<e._howls.length;f++)if(e._howls[f]._src===l._src||l._src.indexOf(e._howls[f]._src)>=0){v=!1;break}return r&&v&&delete r[l._src],e.noAudio=!1,l._state="unloaded",l._sounds=[],l=null,null},on:function(l,p,f,m){var v=this,w=v["_on"+l];return typeof p=="function"&&w.push(m?{id:f,fn:p,once:m}:{id:f,fn:p}),v},off:function(l,p,f){var m=this,v=m["_on"+l],w=0;if(typeof p=="number"&&(f=p,p=null),p||f)for(w=0;w<v.length;w++){var T=f===v[w].id;if(p===v[w].fn&&T||!p&&T){v.splice(w,1);break}}else if(l)m["_on"+l]=[];else{var A=Object.keys(m);for(w=0;w<A.length;w++)A[w].indexOf("_on")===0&&Array.isArray(m[A[w]])&&(m[A[w]]=[])}return m},once:function(l,p,f){var m=this;return m.on(l,p,f,1),m},_emit:function(l,p,f){for(var m=this,v=m["_on"+l],w=v.length-1;w>=0;w--)(!v[w].id||v[w].id===p||l==="load")&&(setTimeout((function(T){T.call(this,p,f)}).bind(m,v[w].fn),0),v[w].once&&m.off(l,v[w].fn,v[w].id));return m._loadQueue(l),m},_loadQueue:function(l){var p=this;if(p._queue.length>0){var f=p._queue[0];f.event===l&&(p._queue.shift(),p._loadQueue()),l||f.action()}return p},_ended:function(l){var p=this,f=l._sprite;if(!p._webAudio&&l._node&&!l._node.paused&&!l._node.ended&&l._node.currentTime<l._stop)return setTimeout(p._ended.bind(p,l),100),p;var m=!!(l._loop||p._sprite[f][2]);if(p._emit("end",l._id),!p._webAudio&&m&&p.stop(l._id,!0).play(l._id),p._webAudio&&m){p._emit("play",l._id),l._seek=l._start||0,l._rateSeek=0,l._playStart=e.ctx.currentTime;var v=(l._stop-l._start)*1e3/Math.abs(l._rate);p._endTimers[l._id]=setTimeout(p._ended.bind(p,l),v)}return p._webAudio&&!m&&(l._paused=!0,l._ended=!0,l._seek=l._start||0,l._rateSeek=0,p._clearTimer(l._id),p._cleanBuffer(l._node),e._autoSuspend()),!p._webAudio&&!m&&p.stop(l._id,!0),p},_clearTimer:function(l){var p=this;if(p._endTimers[l]){if(typeof p._endTimers[l]!="function")clearTimeout(p._endTimers[l]);else{var f=p._soundById(l);f&&f._node&&f._node.removeEventListener("ended",p._endTimers[l],!1)}delete p._endTimers[l]}return p},_soundById:function(l){for(var p=this,f=0;f<p._sounds.length;f++)if(l===p._sounds[f]._id)return p._sounds[f];return null},_inactiveSound:function(){var l=this;l._drain();for(var p=0;p<l._sounds.length;p++)if(l._sounds[p]._ended)return l._sounds[p].reset();return new n(l)},_drain:function(){var l=this,p=l._pool,f=0,m=0;if(!(l._sounds.length<p)){for(m=0;m<l._sounds.length;m++)l._sounds[m]._ended&&f++;for(m=l._sounds.length-1;m>=0;m--){if(f<=p)return;l._sounds[m]._ended&&(l._webAudio&&l._sounds[m]._node&&l._sounds[m]._node.disconnect(0),l._sounds.splice(m,1),f--)}}},_getSoundIds:function(l){var p=this;if(typeof l>"u"){for(var f=[],m=0;m<p._sounds.length;m++)f.push(p._sounds[m]._id);return f}else return[l]},_refreshBuffer:function(l){var p=this;return l._node.bufferSource=e.ctx.createBufferSource(),l._node.bufferSource.buffer=r[p._src],l._panner?l._node.bufferSource.connect(l._panner):l._node.bufferSource.connect(l._node),l._node.bufferSource.loop=l._loop,l._loop&&(l._node.bufferSource.loopStart=l._start||0,l._node.bufferSource.loopEnd=l._stop||0),l._node.bufferSource.playbackRate.setValueAtTime(l._rate,e.ctx.currentTime),p},_cleanBuffer:function(l){var p=this,f=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!l.bufferSource)return p;if(e._scratchBuffer&&l.bufferSource&&(l.bufferSource.onended=null,l.bufferSource.disconnect(0),f))try{l.bufferSource.buffer=e._scratchBuffer}catch{}return l.bufferSource=null,p},_clearSound:function(l){var p=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);p||(l.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var n=function(l){this._parent=l,this.init()};n.prototype={init:function(){var l=this,p=l._parent;return l._muted=p._muted,l._loop=p._loop,l._volume=p._volume,l._rate=p._rate,l._seek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,p._sounds.push(l),l.create(),l},create:function(){var l=this,p=l._parent,f=e._muted||l._muted||l._parent._muted?0:l._volume;return p._webAudio?(l._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),l._node.gain.setValueAtTime(f,e.ctx.currentTime),l._node.paused=!0,l._node.connect(e.masterGain)):e.noAudio||(l._node=e._obtainHtml5Audio(),l._errorFn=l._errorListener.bind(l),l._node.addEventListener("error",l._errorFn,!1),l._loadFn=l._loadListener.bind(l),l._node.addEventListener(e._canPlayEvent,l._loadFn,!1),l._endFn=l._endListener.bind(l),l._node.addEventListener("ended",l._endFn,!1),l._node.src=p._src,l._node.preload=p._preload===!0?"auto":p._preload,l._node.volume=f*e.volume(),l._node.load()),l},reset:function(){var l=this,p=l._parent;return l._muted=p._muted,l._loop=p._loop,l._volume=p._volume,l._rate=p._rate,l._seek=0,l._rateSeek=0,l._paused=!0,l._ended=!0,l._sprite="__default",l._id=++e._counter,l},_errorListener:function(){var l=this;l._parent._emit("loaderror",l._id,l._node.error?l._node.error.code:0),l._node.removeEventListener("error",l._errorFn,!1)},_loadListener:function(){var l=this,p=l._parent;p._duration=Math.ceil(l._node.duration*10)/10,Object.keys(p._sprite).length===0&&(p._sprite={__default:[0,p._duration*1e3]}),p._state!=="loaded"&&(p._state="loaded",p._emit("load"),p._loadQueue()),l._node.removeEventListener(e._canPlayEvent,l._loadFn,!1)},_endListener:function(){var l=this,p=l._parent;p._duration===1/0&&(p._duration=Math.ceil(l._node.duration*10)/10,p._sprite.__default[1]===1/0&&(p._sprite.__default[1]=p._duration*1e3),p._ended(l)),l._node.removeEventListener("ended",l._endFn,!1)}};var r={},o=function(l){var p=l._src;if(r[p]){l._duration=r[p].duration,h(l);return}if(/^data:[^;]+;base64,/.test(p)){for(var f=atob(p.split(",")[1]),m=new Uint8Array(f.length),v=0;v<f.length;++v)m[v]=f.charCodeAt(v);c(m.buffer,l)}else{var w=new XMLHttpRequest;w.open(l._xhr.method,p,!0),w.withCredentials=l._xhr.withCredentials,w.responseType="arraybuffer",l._xhr.headers&&Object.keys(l._xhr.headers).forEach(function(T){w.setRequestHeader(T,l._xhr.headers[T])}),w.onload=function(){var T=(w.status+"")[0];if(T!=="0"&&T!=="2"&&T!=="3"){l._emit("loaderror",null,"Failed loading audio file with status: "+w.status+".");return}c(w.response,l)},w.onerror=function(){l._webAudio&&(l._html5=!0,l._webAudio=!1,l._sounds=[],delete r[p],l.load())},a(w)}},a=function(l){try{l.send()}catch{l.onerror()}},c=function(l,p){var f=function(){p._emit("loaderror",null,"Decoding audio data failed.")},m=function(v){v&&p._sounds.length>0?(r[p._src]=v,h(p,v)):f()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(l).then(m).catch(f):e.ctx.decodeAudioData(l,m,f)},h=function(l,p){p&&!l._duration&&(l._duration=p.duration),Object.keys(l._sprite).length===0&&(l._sprite={__default:[0,l._duration*1e3]}),l._state!=="loaded"&&(l._state="loaded",l._emit("load"),l._loadQueue())},d=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var l=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),p=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),f=p?parseInt(p[1],10):null;if(l&&f&&f<9){var m=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!m&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};s.Howler=e,s.Howl=i,typeof Mn<"u"?(Mn.HowlerGlobal=t,Mn.Howler=e,Mn.Howl=i,Mn.Sound=n):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=i,window.Sound=n)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var n=i._howls.length-1;n>=0;n--)i._howls[n].stereo(e);return i},HowlerGlobal.prototype.pos=function(e,i,n){var r=this;if(!r.ctx||!r.ctx.listener)return r;if(i=typeof i!="number"?r._pos[1]:i,n=typeof n!="number"?r._pos[2]:n,typeof e=="number")r._pos=[e,i,n],typeof r.ctx.listener.positionX<"u"?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]);else return r._pos;return r},HowlerGlobal.prototype.orientation=function(e,i,n,r,o,a){var c=this;if(!c.ctx||!c.ctx.listener)return c;var h=c._orientation;if(i=typeof i!="number"?h[1]:i,n=typeof n!="number"?h[2]:n,r=typeof r!="number"?h[3]:r,o=typeof o!="number"?h[4]:o,a=typeof a!="number"?h[5]:a,typeof e=="number")c._orientation=[e,i,n,r,o,a],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(e,i,n,r,o,a);else return h;return c},Howl.prototype.init=function(e){return function(i){var n=this;return n._orientation=i.orientation||[1,0,0],n._stereo=i.stereo||null,n._pos=i.pos||null,n._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},n._onstereo=i.onstereo?[{fn:i.onstereo}]:[],n._onpos=i.onpos?[{fn:i.onpos}]:[],n._onorientation=i.onorientation?[{fn:i.onorientation}]:[],e.call(this,i)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,i){var n=this;if(!n._webAudio)return n;if(n._state!=="loaded")return n._queue.push({event:"stereo",action:function(){n.stereo(e,i)}}),n;var r=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof e=="number")n._stereo=e,n._pos=[e,0,0];else return n._stereo;for(var o=n._getSoundIds(i),a=0;a<o.length;a++){var c=n._soundById(o[a]);if(c)if(typeof e=="number")c._stereo=e,c._pos=[e,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&t(c,r),r==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(e,0,0):c._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),n._emit("stereo",c._id);else return c._stereo}return n},Howl.prototype.pos=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(e,i,n,r)}}),o;if(i=typeof i!="number"?0:i,n=typeof n!="number"?-.5:n,typeof r>"u")if(typeof e=="number")o._pos=[e,i,n];else return o._pos;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._pos=[e,i,n],h._node&&((!h._panner||h._panner.pan)&&t(h,"spatial"),typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setPosition(e,i,n)),o._emit("pos",h._id);else return h._pos}return o},Howl.prototype.orientation=function(e,i,n,r){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(e,i,n,r)}}),o;if(i=typeof i!="number"?o._orientation[1]:i,n=typeof n!="number"?o._orientation[2]:n,typeof r>"u")if(typeof e=="number")o._orientation=[e,i,n];else return o._orientation;for(var a=o._getSoundIds(r),c=0;c<a.length;c++){var h=o._soundById(a[c]);if(h)if(typeof e=="number")h._orientation=[e,i,n],h._node&&(h._panner||(h._pos||(h._pos=o._pos||[0,0,-.5]),t(h,"spatial")),typeof h._panner.orientationX<"u"?(h._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(n,Howler.ctx.currentTime)):h._panner.setOrientation(e,i,n)),o._emit("orientation",h._id);else return h._orientation}return o},Howl.prototype.pannerAttr=function(){var e=this,i=arguments,n,r,o;if(!e._webAudio)return e;if(i.length===0)return e._pannerAttr;if(i.length===1)if(typeof i[0]=="object")n=i[0],typeof r>"u"&&(n.pannerAttr||(n.pannerAttr={coneInnerAngle:n.coneInnerAngle,coneOuterAngle:n.coneOuterAngle,coneOuterGain:n.coneOuterGain,distanceModel:n.distanceModel,maxDistance:n.maxDistance,refDistance:n.refDistance,rolloffFactor:n.rolloffFactor,panningModel:n.panningModel}),e._pannerAttr={coneInnerAngle:typeof n.pannerAttr.coneInnerAngle<"u"?n.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof n.pannerAttr.coneOuterAngle<"u"?n.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof n.pannerAttr.coneOuterGain<"u"?n.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof n.pannerAttr.distanceModel<"u"?n.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof n.pannerAttr.maxDistance<"u"?n.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof n.pannerAttr.refDistance<"u"?n.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof n.pannerAttr.rolloffFactor<"u"?n.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof n.pannerAttr.panningModel<"u"?n.pannerAttr.panningModel:e._panningModel});else return o=e._soundById(parseInt(i[0],10)),o?o._pannerAttr:e._pannerAttr;else i.length===2&&(n=i[0],r=parseInt(i[1],10));for(var a=e._getSoundIds(r),c=0;c<a.length;c++)if(o=e._soundById(a[c]),o){var h=o._pannerAttr;h={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:h.coneOuterAngle,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:h.coneOuterGain,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:h.distanceModel,maxDistance:typeof n.maxDistance<"u"?n.maxDistance:h.maxDistance,refDistance:typeof n.refDistance<"u"?n.refDistance:h.refDistance,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:h.rolloffFactor,panningModel:typeof n.panningModel<"u"?n.panningModel:h.panningModel};var d=o._panner;d||(o._pos||(o._pos=e._pos||[0,0,-.5]),t(o,"spatial"),d=o._panner),d.coneInnerAngle=h.coneInnerAngle,d.coneOuterAngle=h.coneOuterAngle,d.coneOuterGain=h.coneOuterGain,d.distanceModel=h.distanceModel,d.maxDistance=h.maxDistance,d.refDistance=h.refDistance,d.rolloffFactor=h.rolloffFactor,d.panningModel=h.panningModel}return e},Sound.prototype.init=function(e){return function(){var i=this,n=i._parent;i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,e.call(this),i._stereo?n.stereo(i._stereo):i._pos&&n.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var i=this,n=i._parent;return i._orientation=n._orientation,i._stereo=n._stereo,i._pos=n._pos,i._pannerAttr=n._pannerAttr,i._stereo?n.stereo(i._stereo):i._pos?n.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,n._refreshBuffer(i)),e.call(this)}}(Sound.prototype.reset);var t=function(e,i){i=i||"spatial",i==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(mi);class $u{constructor(){this.sounds=new Map,this.currentSound=null,this.previousSound=null,this.isPlaying=!1,this.currentHotspotId=null,this.preloadQueue=[],this.isPreloading=!1,this.preloadedCount=0,this.maxPreloadCount=5,this.crossfadeEnabled=!0,this.crossfadeDuration=500,this.isCrossfading=!1,this.masterVolume=.8,this.isMuted=!1,this.placeholderUrl="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWTAkPVqzq67JlGgBGqOLwvW0eBSuJ0fXYgjQHF2m+9N+PWw4KU6vn57RiGAA+nODyvmkfBjiS1/TNeSsFG3TI7+CMMAgZbsHy55ZNDAlVre3psmYVAEWo4vK+bCAELIHO8tiJOAcZaLvt559NEAxQqOPwtmMcBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizAJHWq+8+OWTAkPVqzq67RmGgBGqOLyvmwhBjiS1/PMeS0GI3fH8N+RQAoUXrTp66hVFApGnt/yvmwhBiuBzvLZiTYIG2m98OScTgwO",this.placeholderDuration=2e3,this.onPlaybackStart=null,this.onPlaybackEnd=null,this.onProgress=null,this.onError=null,this.onCrossfadeStart=null,this.onCrossfadeEnd=null,mi.Howler.autoUnlock=!0,mi.Howler.html5PoolSize=10,mi.Howler.usingWebAudio=!0,this.state="idle",console.log("AudioEngine initialized")}async resumeContext(){if(mi.Howler.ctx&&mi.Howler.ctx.state==="suspended")try{await mi.Howler.ctx.resume(),console.log("AudioContext resumed")}catch(t){console.error("Failed to resume AudioContext:",t)}}async preloadHotspots(t){const e=t.filter(i=>i.audioUrl).map(i=>({id:i.id,url:i.audioUrl}));this.preloadQueue.push(...e),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedCount<this.maxPreloadCount;){const{id:t,url:e}=this.preloadQueue.shift();this.sounds.has(t)||(await this.loadSound(t,e),this.preloadedCount++)}this.isPreloading=!1}async loadSound(t,e){return new Promise(i=>{const n=new Audio;n.addEventListener("error",()=>{console.log(`Audio not found for ${t}, using placeholder`),this.createSound(t,this.placeholderUrl,!0),i()}),n.addEventListener("canplaythrough",()=>{this.createSound(t,e,!1),i()}),n.src=e})}createSound(t,e,i=!1){const n=new mi.Howl({src:[e],html5:!0,preload:!0,volume:this.masterVolume,onload:()=>{console.log(`Sound loaded: ${t} (placeholder: ${i})`)},onend:()=>this.handlePlaybackEnd(t),onloaderror:(r,o)=>{console.error(`Failed to load sound ${t}:`,o),this.onError&&this.onError(t,o)},onplayerror:(r,o)=>{console.error(`Failed to play sound ${t}:`,o),this.onError&&this.onError(t,o)}});this.sounds.set(t,{howl:n,isPlaceholder:i,duration:i?this.placeholderDuration:null})}async play(t){if(await this.resumeContext(),this.currentHotspotId===t&&this.currentSound){this.isPlaying?this.pause():this.resume();return}this.sounds.has(t)||(this.state="loading",await this.loadSound(t,`/audio/hotspot_${t}.mp3`));const e=this.sounds.get(t);if(!e){console.error(`No sound found for hotspot: ${t}`);return}const i=e.howl;this.crossfadeEnabled&&this.currentSound&&this.isPlaying?this.crossfade(this.currentSound,i,t):(this.currentSound&&this.currentSound.stop(),this.currentSound=i,this.currentHotspotId=t,this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.onPlaybackStart&&this.onPlaybackStart(t),this.startProgressTracking())}crossfade(t,e,i){if(this.isCrossfading)return;console.log(`Crossfading to hotspot: ${i}`),this.isCrossfading=!0,this.state="crossfading";const n=this.crossfadeDuration,r=20,o=n/r;let a=0;this.onCrossfadeStart&&this.onCrossfadeStart(this.currentHotspotId,i),e.volume(0),e.play();const c=setInterval(()=>{a++;const h=a/r;t.volume(this.masterVolume*(1-h)),e.volume(this.masterVolume*h),a>=r&&(clearInterval(c),t.stop(),t.volume(this.masterVolume),this.previousSound=t,this.currentSound=e,this.currentHotspotId=i,this.isCrossfading=!1,this.state="playing",this.onCrossfadeEnd&&this.onCrossfadeEnd(i),this.startProgressTracking())},o)}pause(){this.currentSound&&this.isPlaying&&(this.currentSound.pause(),this.isPlaying=!1,this.state="paused",this.stopProgressTracking(),console.log("Playback paused"))}resume(){this.currentSound&&!this.isPlaying&&(this.currentSound.play(),this.isPlaying=!0,this.state="playing",this.startProgressTracking(),console.log("Playback resumed"))}stop(){this.currentSound&&(this.currentSound.stop(),this.currentSound=null,this.currentHotspotId=null,this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),console.log("Playback stopped"))}skip(t){if(this.currentSound&&this.currentSound.playing()){const e=this.currentSound.seek()||0,i=this.currentSound.duration(),n=Math.max(0,Math.min(i,e+t));this.currentSound.seek(n),console.log(`Skipped to ${n.toFixed(1)}s`)}}setVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),mi.Howler.volume(this.masterVolume),console.log(`Master volume set to ${(this.masterVolume*100).toFixed(0)}%`)}toggleMute(){return this.isMuted=!this.isMuted,mi.Howler.mute(this.isMuted),console.log(`Audio ${this.isMuted?"muted":"unmuted"}`),this.isMuted}getProgress(){if(!this.currentSound)return{current:0,duration:0,percent:0};const t=this.currentSound.seek()||0,e=this.sounds.get(this.currentHotspotId),i=e!=null&&e.isPlaceholder?this.placeholderDuration/1e3:this.currentSound.duration()||0,n=i>0?t/i*100:0;return{current:t,duration:i,percent:n}}seekTo(t){this.currentSound&&this.currentSound.playing()&&this.currentSound.seek(t)}seekToPercent(t){if(this.currentSound){const e=this.currentSound.duration(),i=t/100*e;this.seekTo(i)}}startProgressTracking(){this.stopProgressTracking(),this.progressInterval=setInterval(()=>{if(this.onProgress&&this.currentSound&&this.isPlaying){const t=this.getProgress();this.onProgress(t)}},100)}stopProgressTracking(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}handlePlaybackEnd(t){console.log(`Playback ended for hotspot: ${t}`),t===this.currentHotspotId&&(this.isPlaying=!1,this.state="idle",this.stopProgressTracking(),this.onPlaybackEnd&&this.onPlaybackEnd(t))}getState(){return{state:this.state,isPlaying:this.isPlaying,currentHotspotId:this.currentHotspotId,isMuted:this.isMuted,volume:this.masterVolume,isCrossfading:this.isCrossfading,preloadedCount:this.sounds.size,progress:this.getProgress()}}setCrossfade(t,e=500){this.crossfadeEnabled=t,this.crossfadeDuration=Math.max(100,Math.min(2e3,e)),console.log(`Crossfade ${t?"enabled":"disabled"} (${this.crossfadeDuration}ms)`)}unloadSound(t){const e=this.sounds.get(t);e&&(e.howl.unload(),this.sounds.delete(t),this.preloadedCount=Math.max(0,this.preloadedCount-1))}destroy(){this.stop(),this.stopProgressTracking(),this.sounds.forEach(t=>{t.howl.unload()}),this.sounds.clear(),this.preloadQueue=[],this.preloadedCount=0,this.isPreloading=!1,console.log("AudioEngine destroyed")}playTemporalSound(t,e,i=50){(!e||isNaN(e)||!isFinite(e))&&(console.warn(`Invalid frequency for temporal sound: ${e}`),e=1e3),(!i||isNaN(i)||i<=0)&&(i=50),this.resumeContext(),this.uiAudioContext||(this.uiAudioContext=new(window.AudioContext||window.webkitAudioContext));try{const n=this.uiAudioContext,r=n.createOscillator(),o=n.createGain();r.connect(o),o.connect(n.destination),r.frequency.value=e,r.type=t==="explore"?"square":"sine";const a=n.currentTime,c=.005,h=i/1e3;o.gain.setValueAtTime(0,a),o.gain.linearRampToValueAtTime(.15,a+c),o.gain.exponentialRampToValueAtTime(.001,a+h),r.start(a),r.stop(a+h),console.log(`Temporal sound played: ${t} at ${e}Hz for ${i}ms`)}catch(n){console.error("Error playing temporal sound:",n)}}playTemporalTick(t=.5){const i=3e3+1e3*(!isNaN(t)&&isFinite(t)?Math.min(1,Math.max(0,t)):.5);this.playTemporalSound("explore",i,50)}playTemporalBoop(){this.playTemporalSound("preview",800,100)}playTemporalThunk(t=.5){const i=200+200*(1-(!isNaN(t)&&isFinite(t)?Math.min(1,Math.max(0,t)):.5));this.playTemporalSound("activate",i,150)}}class ed{constructor(){this.overlays=new Map,this.activeOverlay=null,this.preloadQueue=[],this.isPreloading=!1,this.maxPreloadCount=3,this.preloadedImages=new Map,this.onOverlayOpen=null,this.onOverlayClose=null,this.onImageLoaded=null,this.onImageError=null,console.log("ImageOverlayManager initialized")}loadHotspots(t){t.forEach(e=>{e.image_url_1&&this.overlays.set(e.id,{hotspotId:e.id,imageUrls:[e.image_url_1],autoReveal:e.overlay_auto_reveal||!1,displayMode:e.overlay_display_mode||"modal",showButton:e.show_images_button!==!1,access:e.overlay_access||"free",isLoaded:!1})}),console.log(`Loaded ${this.overlays.size} image overlays`)}async preloadImages(t){const e=[];t.forEach(i=>{const n=this.overlays.get(i);n&&!n.isLoaded&&n.imageUrls.forEach(r=>{this.preloadedImages.has(r)||e.push({url:r,hotspotId:i})})}),this.preloadQueue.push(...e),!this.isPreloading&&this.preloadQueue.length>0&&this.processPreloadQueue()}async processPreloadQueue(){for(this.isPreloading=!0;this.preloadQueue.length>0&&this.preloadedImages.size<this.maxPreloadCount;){const{url:t,hotspotId:e}=this.preloadQueue.shift();try{await this.loadImage(t,e)}catch(i){console.error(`Failed to preload image: ${t}`,i)}}this.isPreloading=!1}loadImage(t,e){return new Promise((i,n)=>{const r=new Image;r.onload=()=>{this.preloadedImages.set(t,r);const o=this.overlays.get(e);o&&(o.isLoaded=!0),this.onImageLoaded&&this.onImageLoaded(t,e),console.log(`Image loaded: ${t}`),i(r)},r.onerror=o=>{this.onImageError&&this.onImageError(t,e,o),console.error(`Failed to load image: ${t}`),n(o)},r.crossOrigin="anonymous",r.src=t})}shouldAutoReveal(t){const e=this.overlays.get(t);return e?e.autoReveal:!1}shouldShowButton(t){const e=this.overlays.get(t);return e?e.showButton:!0}getOverlay(t){return this.overlays.get(t)}openOverlay(t){const e=this.overlays.get(t);if(!e)return console.warn(`No overlay found for hotspot: ${t}`),null;if(this.activeOverlay&&this.closeOverlay(),this.activeOverlay=t,!e.isLoaded){const i=e.imageUrls[0];this.loadImage(i,t).catch(console.error)}return this.onOverlayOpen&&this.onOverlayOpen(t,e),e}closeOverlay(){if(this.activeOverlay){const t=this.activeOverlay;this.activeOverlay=null,this.onOverlayClose&&this.onOverlayClose(t)}}getImage(t){return this.preloadedImages.get(t)}hasAccess(t,e="free"){const i=this.overlays.get(t);if(!i)return!1;const n={free:0,gated:1,supporter:2},r=n[i.access]||0;return(n[e]||0)>=r}unloadImages(t){t.forEach(e=>{const i=this.overlays.get(e);i&&(i.imageUrls.forEach(n=>{this.preloadedImages.delete(n)}),i.isLoaded=!1)})}getMetrics(){return{totalOverlays:this.overlays.size,preloadedImages:this.preloadedImages.size,queueLength:this.preloadQueue.length,activeOverlay:this.activeOverlay}}destroy(){this.closeOverlay(),this.overlays.clear(),this.preloadedImages.clear(),this.preloadQueue=[],console.log("ImageOverlayManager destroyed")}}class td{constructor(t){An(this,"handleVisibilityChange",()=>{document.hidden&&(console.log("Page hidden - performing cleanup"),this.performHighPressureCleanup())});An(this,"handleFreeze",()=>{console.log("Page freezing - emergency cleanup"),this.performEmergencyCleanup()});this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),cleanupCount:0,memoryPressure:"normal"},this.config={warningThreshold:100,highThreshold:150,criticalThreshold:200,cacheLimits:{normal:{tiles:500,hotspots:150},high:{tiles:200,hotspots:100},critical:{tiles:50,hotspots:50}},monitorInterval:5e3,cleanupInterval:3e4,aggressiveCleanupDelay:6e4,hasMemoryAPI:"memory"in performance,hasGC:typeof window.gc=="function",isMobile:/Android|iPhone|iPad/i.test(navigator.userAgent)},this.config.isMobile&&(this.config.warningThreshold=50,this.config.highThreshold=75,this.config.criticalThreshold=100,this.config.monitorInterval=3e3),this.intervals={},this.metrics={currentUsage:0,peakUsage:0,cleanups:0,gcCalls:0}}start(){this.state.isActive||(this.state.isActive=!0,this.intervals.monitor=setInterval(()=>this.checkMemory(),this.config.monitorInterval),this.intervals.cleanup=setInterval(()=>this.performScheduledCleanup(),this.config.cleanupInterval),this.intervals.aggressive=setInterval(()=>this.performAggressiveCleanup(),this.config.aggressiveCleanupDelay),document.addEventListener("visibilitychange",this.handleVisibilityChange),"onfreeze"in document&&document.addEventListener("freeze",this.handleFreeze),console.log("MemoryManager started"))}stop(){this.state.isActive=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("freeze",this.handleFreeze),console.log("MemoryManager stopped")}checkMemory(){if(!this.config.hasMemoryAPI)return;const t=performance.memory.usedJSHeapSize/1048576,e=performance.memory.jsHeapSizeLimit/1048576,i=t/e*100;this.metrics.currentUsage=t,this.metrics.peakUsage=Math.max(this.metrics.peakUsage,t);const n=this.state.memoryPressure;if(t>this.config.criticalThreshold||i>80?this.state.memoryPressure="critical":t>this.config.highThreshold||i>60?this.state.memoryPressure="high":this.state.memoryPressure="normal",this.state.memoryPressure!==n)switch(console.log(`Memory pressure changed: ${n}  ${this.state.memoryPressure} (${t.toFixed(0)}MB, ${i.toFixed(0)}%)`),this.state.memoryPressure){case"critical":this.performEmergencyCleanup();break;case"high":this.performHighPressureCleanup();break}this.updateCacheLimits()}updateCacheLimits(){const t=this.config.cacheLimits[this.state.memoryPressure];this.viewer.maxImageCacheCount!==t.tiles&&(this.viewer.maxImageCacheCount=t.tiles,console.log(`Adjusted tile cache limit to ${t.tiles}`))}performScheduledCleanup(){this.state.memoryPressure!=="normal"&&(console.log("Performing scheduled cleanup"),this.cleanupTileCache(),this.metrics.cleanups++)}performHighPressureCleanup(){console.log("High memory pressure - performing cleanup"),this.cleanupTileCache(!0),window.audioEngine&&window.audioEngine.destroy,this.suggestGC(),this.metrics.cleanups++}performEmergencyCleanup(){var e;console.warn("CRITICAL: Emergency memory cleanup");const t=(e=this.viewer.world)==null?void 0:e.getItemAt(0);t&&(t._tileCache&&t._tileCache.clearTilesFor(t),this.viewer.maxImageCacheCount=30,window.tileOptimizer&&window.tileOptimizer.clearOldTiles(),window.spatialIndex&&window.spatialIndex.queryCache.clear(),this.forceGC(),this.clearUnusedImages(),this.metrics.cleanups++,this.state.lastCleanup=Date.now())}performAggressiveCleanup(){this.state.isActive&&this.metrics.currentUsage>this.config.warningThreshold&&(console.log("Performing aggressive cleanup"),this.cleanupTileCache(!0),this.clearUnusedImages(),this.suggestGC())}cleanupTileCache(t=!1){var r,o;const e=(r=this.viewer.world)==null?void 0:r.getItemAt(0);if(!(e!=null&&e._tileCache))return;const i=e._tileCache,n=((o=i._tilesLoaded)==null?void 0:o.length)||i._imagesLoadedCount||0;if(t||n>this.config.cacheLimits[this.state.memoryPressure].tiles){const a=t?Math.floor(this.config.cacheLimits[this.state.memoryPressure].tiles*.5):this.config.cacheLimits[this.state.memoryPressure].tiles,c=n-a;c>0&&(console.log(`Removing ${c} tiles from cache (current: ${n})`),i.clearTilesFor(e))}}clearUnusedImages(){const t=document.querySelectorAll("img");let e=0;t.forEach(i=>{!this.isElementVisible(i)&&i.src&&(i.removeAttribute("src"),e++)}),e>0&&console.log(`Cleared ${e} unused images`)}isElementVisible(t){const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}suggestGC(){this.config.hasGC&&(console.log("Suggesting garbage collection"),"requestIdleCallback"in window?requestIdleCallback(()=>{window.gc(),this.metrics.gcCalls++}):setTimeout(()=>{window.gc(),this.metrics.gcCalls++},100))}forceGC(){this.config.hasGC&&(console.log("Forcing immediate garbage collection"),window.gc(),this.metrics.gcCalls++)}getMetrics(){const t={...this.metrics,memoryPressure:this.state.memoryPressure,cacheLimits:this.config.cacheLimits[this.state.memoryPressure]};if(this.config.hasMemoryAPI){const e=performance.memory.jsHeapSizeLimit/1048576;t.usagePercentage=(this.metrics.currentUsage/e*100).toFixed(1)+"%",t.totalLimit=e.toFixed(0)+"MB"}return t}destroy(){this.stop(),this.viewer=null}}class id{constructor(){this.modes={direct:{name:"Direct (Classic)",description:"Tap to select and zoom immediately",mobile:!0,desktop:!0},temporal:{name:"Temporal (Hold)",description:"Hold duration determines action",mobile:!0,desktop:!0,thresholds:{explore:300,preview:500,activate:800}}},this.currentMode=localStorage.getItem("interactionMode")||"direct",this.temporalSettings={exploreThreshold:300,previewThreshold:500,activateThreshold:800},this.onModeChange=null}getCurrentMode(){return this.currentMode}setMode(t){return this.modes[t]?(this.currentMode=t,localStorage.setItem("interactionMode",t),this.onModeChange&&this.onModeChange(t),console.log(`Interaction mode changed to: ${this.modes[t].name}`),!0):!1}getModeConfig(){return this.modes[this.currentMode]}getTemporalThresholds(){return this.temporalSettings}updateTemporalThreshold(t,e){this.temporalSettings[t+"Threshold"]!==void 0&&(this.temporalSettings[t+"Threshold"]=e,localStorage.setItem(`temporal_${t}`,e))}}class nd{constructor(t=25){this.queue=[],this.running=new Set,this.maxConcurrent=t}add(t,e){this.queue.push({element:t,animationCallback:e}),this.process()}async process(){for(;this.running.size<this.maxConcurrent&&this.queue.length>0;){const{element:t,animationCallback:e}=this.queue.shift(),i=t.getAttribute("data-hotspot-id");this.running.add(i),e().then(()=>{this.running.delete(i),this.process()}).catch(()=>{this.running.delete(i),this.process()})}}clear(){this.queue=[],this.running.clear()}clearFinished(){this.running.forEach(t=>{const e=document.querySelector(`[data-hotspot-id="${t}"]`);if(e){const i=e.getElementsByTagName("path");for(let n of i)n.currentAnimation&&n.currentAnimation.playState==="finished"&&(n.currentAnimation=null,this.running.delete(t))}})}}const hi=class hi{constructor(t={}){this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Object.assign(this,{viewer:t.viewer,spatialIndex:t.spatialIndex,onHotspotHover:t.onHotspotHover||(()=>{}),onHotspotClick:t.onHotspotClick||(()=>{}),visibilityCheckInterval:t.visibilityCheckInterval||100,batchSize:t.batchSize||50,renderDebounceTime:t.renderDebounceTime||16,debugMode:t.debugMode||!1}),this.lastViewportBounds=null,this.lastViewportZoom=null,this.significantChangeThreshold=.1,this.overlays=new Map,this.visibleOverlays=new Set,this.hoveredHotspot=null,this.selectedHotspot=null,this.animationQueue=new nd(this.isMobile?hi.MAX_CONCURRENT_ANIMATIONS_MOBILE:hi.MAX_CONCURRENT_ANIMATIONS),this.colorPalettes={tech:{shadow:"rgba(0, 0, 0, 0.3)",glow:"#00ffff",contrast:"rgba(0, 0, 0, 1)",main:"#ffffff"},enchantedJournal:{shadow:"rgba(47, 79, 79, 0.4)",glow:"#FFD700",glow2:"#DDA0DD",contrast:"rgba(160, 82, 45, 0.8)",main:"#A0522D"},moonlitManuscript:{shadow:"rgba(47, 79, 79, 0.5)",glow:"#87CEEB",glow2:"#4682B4",contrast:"rgba(70, 130, 180, 0.9)",main:"#4682B4"}},this.timingEasing="cubic-bezier(0.36, 0.45, 0.63, 0.53)",this.currentPalette="moonlitManuscript",this.colorScheme=this.colorPalettes[this.currentPalette],window.hotspotColorScheme=this.colorScheme,window.hotspotPalettes=this.colorPalettes,window.setHotspotPalette=e=>{this.colorPalettes[e]&&(this.currentPalette=e,this.colorScheme=this.colorPalettes[e],window.hotspotColorScheme=this.colorScheme,this.refreshAllHotspotStyles())},window.hotspotColorScheme=this.colorScheme,this.isDragging=!1,this.dragStartTime=0,this.dragStartPoint=null,this.clickTimeThreshold=300,this.clickDistThreshold=this.isMobile?12:8,this.hotspotAreas=new Map,this.activePointers=new Map,this.primaryPointerId=null,this.lastPointerDownTime=0,this.lastPointerDownPoint=null,this.isPinching=!1,this.isAnimationInProgress=!1,this.pendingVisibilityUpdate=!1,this.animationIndex=0,this.performanceMode=!1,this.animationRegistry=new Set,this.interactionModeManager=new id,this.interactionModeManager.onModeChange=()=>{console.log("Interaction mode changed in renderer")},this.temporalState={isHolding:!1,holdStartTime:0,holdTimer:null,currentPhase:null,feedbackGiven:new Set},this.lastZoom=0,this.initStyles(),this.init()}normalizePath(t,e){const i=e?t[0]:t;let n="";return i.forEach(([r,o],a)=>{a===0?n+=`M ${Math.round(r)} ${Math.round(o)} `:n+=`L ${Math.round(r)} ${Math.round(o)} `}),n+="Z",n}initStyles(){}optimizeSafariLayers(){if(!this.isSafari)return;let t=1e-4;this.overlays.forEach(e=>{e.element.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(n=>{n.style.transform=`translateZ(${t}px)`,t+=1e-4})})}async init(){if(!this.viewer.world.getItemCount()){this.viewer.addOnceHandler("open",()=>this.init());return}if(!document.getElementById("hotspot-animations-fix")){const n=document.createElement("style");n.id="hotspot-animations-fix",n.textContent=`
        .hotspot-hover path,
        .hotspot-selected path {
            animation-play-state: running !important;
        }
    `,document.head.appendChild(n)}const e=this.viewer.world.getItemAt(0).getContentSize();this.svg=this.createSVG(e);const i=document.createElement("style");i.textContent=`
        @keyframes revealWidth {
            from { width: 0%; }
            to { width: 110%; }
        }
    `,document.head.appendChild(i),this.viewer.addOverlay({element:this.svg,location:new et.Rect(0,0,1,e.y/e.x),placement:et.Placement.TOP_LEFT}),this.createMaskDefs(),this.pathDefs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.pathDefs.id="path-definitions",this.svg.insertBefore(this.pathDefs,this.svg.firstChild),this.createClipPathDefs(),this.createSVGFilters(),await this.loadHotspotsInBatches(),this.optimizeForSafari(),this.optimizeSafariLayers(),this.setupMouseTracking(),this.setupDragDetection(),this.viewer.addHandler("zoom",()=>{this.currentZoom=this.viewer.viewport.getZoom();const n=this.lastZoom||0;if((n<=8&&this.currentZoom>8||n>8&&this.currentZoom<=8)&&(this.clearAnimationRegistryForZoomChange(),n>8&&this.currentZoom<=8&&this.overlays.forEach(r=>{this.resetStaticTransitions(r.element)})),this.lastZoom=this.currentZoom,this.hoveredHotspot){const r=this.overlays.get(this.hoveredHotspot.id);r&&this.applyStyle(r.element,this.hoveredHotspot.type,"hover")}if(this.selectedHotspot&&this.selectedHotspot!==this.hoveredHotspot){const r=this.overlays.get(this.selectedHotspot.id);r&&this.applyStyle(r.element,this.selectedHotspot.type,"selected")}}),this.startVisibilityTracking(),this.cleanupInterval=setInterval(()=>{this.animationQueue&&this.animationQueue.clearFinished(),this.overlays.forEach(n=>{const r=n.element.getElementsByTagName("path");for(let o of r)o.currentAnimation&&o.currentAnimation.playState==="finished"&&(o.currentAnimation=null)})},5e3),window.nativeHotspotRenderer=this}createSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
               width="${t.x}" height="${t.y}" 
               viewBox="0 0 ${t.x} ${t.y}"
               style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
        </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}async loadHotspotsInBatches(){const t=this.spatialIndex.getAllHotspots(),e=Math.ceil(t.length/this.batchSize);for(let i=0;i<e;i++)t.slice(i*this.batchSize,(i+1)*this.batchSize).forEach(r=>this.createHotspotOverlay(r)),i<e-1&&await new Promise(r=>setTimeout(r,0));console.log(`Loaded ${t.length} hotspots in ${e} batches`)}createGroup(t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return Object.assign(e.style,{cursor:"pointer",pointerEvents:"fill",opacity:this.debugMode?"1":"0",transition:"opacity 0.2s ease-out","-webkit-tap-highlight-color":"transparent",transform:"translateZ(0)","-webkit-transform":"translateZ(0)","will-change":"transform, opacity"}),e.setAttribute("data-hotspot-id",t.id),e}createHotspotWrapper(t){const e=document.createElement("div");return e.className="hotspot-wrapper",e.setAttribute("data-hotspot-wrapper-id",t),this.isSafari&&(e.style.position="absolute",e.style.transform="translateZ(0)",e.style.webkitTransform="translateZ(0)",e.style.willChange="filter",e.style.contain="layout style paint",this.isMobile?e.classList.add("hotspot-wrapper-ios"):e.classList.add("hotspot-wrapper-desktop")),e}createHotspotOverlay(t){const e=this.createGroup(t),i=t.shape==="multipolygon",n=this.normalizePath(t.coordinates,i);if(this.isSafari){const h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("d",n),h.setAttribute("fill","none"),h.setAttribute("stroke",this.colorScheme.glow2||this.colorScheme.glow),h.setAttribute("stroke-width","12"),h.setAttribute("opacity","0"),h.setAttribute("vector-effect","non-scaling-stroke"),h.style.pointerEvents="none",h.classList.add("glow-layer-3"),e.appendChild(h);const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d",n),d.setAttribute("fill","none"),d.setAttribute("stroke",this.colorScheme.glow),d.setAttribute("stroke-width","8"),d.setAttribute("opacity","0"),d.setAttribute("vector-effect","non-scaling-stroke"),d.style.pointerEvents="none",d.classList.add("glow-layer-2"),e.appendChild(d);const l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d",n),l.setAttribute("fill","none"),l.setAttribute("stroke",this.colorScheme.main),l.setAttribute("stroke-width","5"),l.setAttribute("opacity","0"),l.setAttribute("vector-effect","non-scaling-stroke"),l.style.pointerEvents="none",l.classList.add("glow-layer-1"),e.appendChild(l)}const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",n),r.setAttribute("fill","none"),r.setAttribute("stroke","transparent"),r.setAttribute("vector-effect","non-scaling-stroke"),r.style.pointerEvents="fill",r.classList.add("main-path"),e.appendChild(r);const o=r.getTotalLength();if(e.removeChild(r),r.setAttribute("data-real-length",o),this.isSafari){const h=e.querySelector(".glow-layer-1"),d=e.querySelector(".glow-layer-2"),l=e.querySelector(".glow-layer-3");[h,d,l].forEach(p=>{p&&p.setAttribute("data-real-length",o)})}if(i&&t.coordinates.length>1){const h=`mask-${t.id}-${this.maskCounter++}`,d=document.createElementNS("http://www.w3.org/2000/svg","mask");d.setAttribute("id",h);const l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x","0"),l.setAttribute("y","0"),l.setAttribute("width","100%"),l.setAttribute("height","100%"),l.setAttribute("fill","white"),d.appendChild(l),t.coordinates.forEach((p,f)=>{if(f>0){const m=document.createElementNS("http://www.w3.org/2000/svg","path"),v=p.reduce((w,[T,A],F)=>w+(F===0?"M":"L")+`${Math.round(T)},${Math.round(A)}`,"")+"Z";m.setAttribute("d",v),m.setAttribute("fill","black"),m.setAttribute("stroke","black"),m.setAttribute("stroke-width","10"),d.appendChild(m)}}),this.defs.appendChild(d),r.setAttribute("mask",`url(#${h})`)}this.applyStyle(e,t.type,"normal"),e.appendChild(r),this.svg.appendChild(e);const a=this.calculateBounds(t.coordinates),c=this.calculateArea(a);this.overlays.set(t.id,{element:e,hotspot:t,bounds:a,area:c,isVisible:!1}),this.hotspotAreas.set(t.id,c)}setupDragDetection(){this.viewer.addHandler("canvas-drag",()=>{this.isDragging=!0}),this.viewer.addHandler("canvas-drag-end",()=>{this.isDragging=!1})}setupMouseTracking(){this.svg.style.pointerEvents="auto",(this.isMobile||this.isSafari)&&this.svg.addEventListener("click",e=>{if(console.log("SVG click handler for iOS/Safari",{target:e.target.tagName,isMobile:this.isMobile}),e.target.tagName==="path"||e.target.tagName==="g"||e.target.closest("g[data-hotspot-id]"))return;const i=this.viewer.element.getBoundingClientRect(),n=new et.Point(e.clientX-i.left,e.clientY-i.top),r=this.viewer.viewport.pointFromPixel(n),o=this.viewer.viewport.viewportToImageCoordinates(r),a=this.findSmallestHotspotAtPoint(o);a&&(console.log("iOS/Safari: Found hotspot at SVG click position:",a.id),e.stopPropagation(),e.preventDefault(),this.activateHotspot(a))},!0);const t=this.viewer.container;t.addEventListener("pointerdown",this.handlePointerDown.bind(this)),t.addEventListener("pointermove",this.handlePointerMove.bind(this)),t.addEventListener("pointerup",this.handlePointerUp.bind(this)),t.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.svg.addEventListener("mousemove",e=>{if(this.interactionModeManager.getCurrentMode()==="temporal"){this.svg.style.cursor="default";return}const i=this.viewer.element.getBoundingClientRect(),n=new et.Point(e.clientX-i.left,e.clientY-i.top),r=this.viewer.viewport.pointFromPixel(n),o=this.viewer.viewport.viewportToImageCoordinates(r),a=this.findSmallestHotspotAtPoint(o);if(a!==this.hoveredHotspot){if(console.log("HOVER CHANGE DETECTED!",a==null?void 0:a.id),this.hoveredHotspot){const c=this.overlays.get(this.hoveredHotspot.id);c&&(console.log("Applying normal style to previous"),this.applyStyle(c.element,this.hoveredHotspot.type,this.hoveredHotspot===this.selectedHotspot?"selected":"normal"))}if(this.hoveredHotspot=a,this.onHotspotHover(a),a){const c=this.overlays.get(a.id);c&&(console.log("Applying hover style to new hotspot"),this.applyStyle(c.element,a.type,"hover"))}}this.svg.style.cursor=a?"pointer":"default"}),this.isMobile&&this.svg.addEventListener("touchmove",e=>{if(e.preventDefault(),this.interactionModeManager.getCurrentMode()==="temporal")return;const i=e.touches[0],n=this.viewer.element.getBoundingClientRect(),r=new et.Point(i.clientX-n.left,i.clientY-n.top),o=this.viewer.viewport.pointFromPixel(r),a=this.viewer.viewport.viewportToImageCoordinates(o),c=this.findSmallestHotspotAtPoint(a);if(c!==this.hoveredHotspot){if(console.log("Touch hover change detected:",c==null?void 0:c.id),this.hoveredHotspot){const h=this.overlays.get(this.hoveredHotspot.id);h&&this.applyStyle(h.element,this.hoveredHotspot.type,this.hoveredHotspot===this.selectedHotspot?"selected":"normal")}if(this.hoveredHotspot=c,this.onHotspotHover(c),c){const h=this.overlays.get(c.id);h&&this.applyStyle(h.element,c.type,"hover")}}},{passive:!1})}handlePointerDown(t){this.updatesPaused&&(console.warn("Updates were paused during interaction - forcing resume"),this.resumeUpdates()),console.log("handlePointerDown",{pointerId:t.pointerId,activePointersBefore:this.activePointers.size,interactionMode:this.interactionModeManager.getCurrentMode()}),this.activePointers.set(t.pointerId,{x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Date.now()}),this.isMobile&&t.preventDefault(),this.activePointers.size===1&&(this.primaryPointerId=t.pointerId,this.lastPointerDownTime=Date.now(),this.lastPointerDownPoint={x:t.clientX,y:t.clientY},this.interactionModeManager.getCurrentMode()==="temporal"&&this.startTemporalHold(t))}handlePointerMove(t){if(this.activePointers.has(t.pointerId)){const e=this.activePointers.get(t.pointerId);e.x=t.clientX,e.y=t.clientY,this.activePointers.size>=2&&(this.isPinching=!0)}}handlePointerUp(t){if(console.log("handlePointerUp start",{pointerId:t.pointerId,hasPointer:this.activePointers.has(t.pointerId),activePointers:this.activePointers.size,interactionMode:this.interactionModeManager.getCurrentMode()}),!this.activePointers.has(t.pointerId))return;const e=this.activePointers.get(t.pointerId),i=Date.now()-e.startTime,n=Math.sqrt(Math.pow(t.clientX-e.startX,2)+Math.pow(t.clientY-e.startY,2));if(this.temporalState.holdTimer&&(clearTimeout(this.temporalState.holdTimer),this.temporalState.holdTimer=null),console.log("handlePointerUp checks",{isPrimary:t.pointerId===this.primaryPointerId,primaryPointerId:this.primaryPointerId,activePointers:this.activePointers.size,isPinching:this.isPinching,isDragging:this.isDragging,duration:i,clickTimeThreshold:this.clickTimeThreshold,distance:n,clickDistThreshold:this.clickDistThreshold,interactionMode:this.interactionModeManager.getCurrentMode()}),t.pointerId===this.primaryPointerId&&this.activePointers.size===1&&!this.isPinching&&!this.isDragging&&n<this.clickDistThreshold&&(this.interactionModeManager.getCurrentMode()==="temporal"?this.handleTemporalModeRelease(t,i):i<this.clickTimeThreshold&&(console.log("Direct mode click detected"),this.handleClick(t),this.forceIOSRedraw())),this.temporalState.isHolding=!1,this.temporalState.holdStartTime=0,this.temporalState.currentPhase=null,this.temporalState.feedbackGiven.clear(),this.temporalState.targetHotspot){const r=this.overlays.get(this.temporalState.targetHotspot.id);r&&r.element&&(r.element.classList.remove("hotspot-temporal-explore","hotspot-temporal-activate"),r.element.style.filter="",r.element.style.transform="")}this.hideTemporalProgressIndicator(),this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handleTemporalModeRelease(t,e){const i=this.interactionModeManager.getTemporalThresholds();console.log("Temporal mode release:",{duration:e,thresholds:i,finalPhase:this.temporalState.currentPhase});const n=this.viewer.element.getBoundingClientRect(),r=new et.Point(t.clientX-n.left,t.clientY-n.top),o=this.viewer.viewport.pointFromPixel(r),a=this.viewer.viewport.viewportToImageCoordinates(o),c=this.findSmallestHotspotAtPoint(a);if(!c){console.log("No hotspot found at release position");return}e<i.exploreThreshold?(console.log("Temporal: Exploration phase completed"),this.handleTemporalExplore(c)):e>=i.exploreThreshold&&e<i.activateThreshold?(console.log("Temporal: Preview/Selection phase completed"),this.handleTemporalPreview(c)):(console.log("Temporal: Activation phase completed"),this.handleTemporalActivate(c))}handleTemporalExplore(t){console.log("Exploring hotspot:",t.id),window.audioEngine&&this.playTemporalSound("explore",t),this.temporalState.feedbackGiven.has("explore")||this.flashHotspot(t,100)}handleTemporalPreview(t){console.log("Previewing hotspot:",t.id),this.selectedHotspot=t,this.onHotspotHover(t),this.overlays.forEach((e,i)=>{const n=i===t.id?"selected":"normal";this.applyStyle(e.element,e.hotspot.type,n)}),window.audioEngine&&this.playTemporalSound("preview",t)}handleTemporalActivate(t){console.log("Activating hotspot:",t.id),this.activateHotspot(t),window.audioEngine&&this.playTemporalSound("activate",t)}flashHotspot(t,e){const i=this.overlays.get(t.id);if(!i)return;const n=i.element,r=n.style.opacity;n.style.transition=`opacity ${e/2}ms ease-out`,n.style.opacity="1",setTimeout(()=>{n.style.opacity=r,setTimeout(()=>{n.style.transition=""},e/2)},e/2)}playTemporalSound(t,e){console.log(`Playing ${t} sound for hotspot ${e.id}`);const i=this.overlays.get(e.id),n=i?i.bounds:null,r=n?(n.maxX-n.minX)*(n.maxY-n.minY):1e3,o=Math.min(1,r/1e4);if(t==="explore"){console.log(" Tick!");const a=3e3+1e3*o;this.playBeep(a,50)}else if(t==="preview")console.log(" Boop!"),this.playBeep(800,100);else if(t==="activate"){console.log(" Thunk!");const a=200+200*(1-o);this.playBeep(a,150)}}startTemporalHold(t){const e=this.viewer.element.getBoundingClientRect(),i=new et.Point(t.clientX-e.left,t.clientY-e.top),n=this.viewer.viewport.pointFromPixel(i),r=this.viewer.viewport.viewportToImageCoordinates(n),o=this.findSmallestHotspotAtPoint(r);if(!o){console.log("No hotspot at pointer down position");return}this.temporalState.isHolding=!0,this.temporalState.holdStartTime=Date.now(),this.temporalState.targetHotspot=o,this.temporalState.feedbackGiven.clear();const a=this.interactionModeManager.getTemporalThresholds();this.scheduleTemporalFeedback(o,a),this.updateTemporalProgressIndicator(t.clientX,t.clientY,0),this.animateTemporalProgress()}scheduleTemporalFeedback(t,e){this.temporalState.holdTimer&&clearTimeout(this.temporalState.holdTimer),this.giveTemporalFeedback("touchDown",t),this.temporalState.holdTimer=setTimeout(()=>{this.temporalState.isHolding&&(this.temporalState.currentPhase="explore",this.giveTemporalFeedback("explore",t),this.temporalState.holdTimer=setTimeout(()=>{this.temporalState.isHolding&&(this.temporalState.currentPhase="preview",this.giveTemporalFeedback("preview",t),this.temporalState.holdTimer=setTimeout(()=>{this.temporalState.isHolding&&(this.temporalState.currentPhase="activate",this.giveTemporalFeedback("activate",t))},e.activateThreshold-e.previewThreshold))},e.previewThreshold-e.exploreThreshold))},e.exploreThreshold)}giveTemporalFeedback(t,e){this.temporalState.feedbackGiven.has(t)||(this.temporalState.feedbackGiven.add(t),console.log(`Temporal feedback: ${t} for hotspot ${e.id}`),this.applyTemporalVisualFeedback(t,e),this.playTemporalAudio(t,e),this.playTemporalHaptic(t))}applyTemporalVisualFeedback(t,e){const i=this.overlays.get(e.id);if(!i)return;const n=i.element;n.getElementsByTagName("path");const r=n.querySelector(".main-path");switch(r&&(r.style.transition="none",r.style.animation="none"),t){case"touchDown":n.style.transition="opacity 50ms ease-out",n.style.opacity="0.3",r&&(r.style.stroke="transparent",r.style.strokeWidth="0",r.style.opacity="0");break;case"explore":n.style.opacity="0.5",r&&(r.style.stroke,r.style.opacity,r.style.transition=`all ${200/2}ms ease-out`,r.style.stroke=this.colorScheme.main,r.style.strokeWidth="2px",r.style.opacity="0.6",setTimeout(()=>{r.style.transition=`all ${200/2}ms ease-in`,r.style.stroke="transparent",r.style.opacity="0"},200/2)),n.style.animation="temporalPulse 200ms ease-out";break;case"preview":n.style.opacity="0.7",n.style.animation="none",r&&(r.style.transition="all 100ms ease-out",r.style.stroke=this.colorScheme.main,r.style.strokeWidth="2px",r.style.strokeDasharray="none",r.style.strokeDashoffset="0",r.style.opacity="1",r.style.filter=this.isSafari?"none":`drop-shadow(0 0 3px ${this.colorScheme.glow})`);break;case"activate":n.style.opacity="1",n.style.filter="brightness(1.2)",r&&(r.style.strokeWidth="2.5px",r.style.filter=this.isSafari?"none":`drop-shadow(0 0 6px ${this.colorScheme.glow})`);break}}playTemporalAudio(t,e){if(!window.audioEngine)return;const i=this.getHotspotBounds(e);let n=.5;if(i&&i.width&&i.height){const r=i.width*i.height;r>0&&!isNaN(r)&&(n=Math.min(1,Math.max(0,r/1e4)))}switch(console.log(`Temporal audio - phase: ${t}, size: ${n.toFixed(2)}`),t){case"touchDown":window.audioEngine.playTemporalSound("touch",2e3,20);break;case"explore":window.audioEngine.playTemporalTick(n);break;case"preview":window.audioEngine.playTemporalBoop();break;case"activate":window.audioEngine.playTemporalThunk(n);break}}playBeep(t,e){if(!(!window.AudioContext&&!window.webkitAudioContext))try{const i=new(window.AudioContext||window.webkitAudioContext),n=i.createOscillator(),r=i.createGain();n.connect(r),r.connect(i.destination),n.frequency.value=t,n.type="sine",r.gain.setValueAtTime(0,i.currentTime),r.gain.linearRampToValueAtTime(.1,i.currentTime+.01),r.gain.linearRampToValueAtTime(.1,i.currentTime+e/1e3-.01),r.gain.linearRampToValueAtTime(0,i.currentTime+e/1e3),n.start(i.currentTime),n.stop(i.currentTime+e/1e3)}catch(i){console.warn("Could not play beep:",i)}}playTemporalHaptic(t){if(!(!navigator.vibrate||!this.isMobile))switch(t){case"touchDown":navigator.vibrate(10);break;case"explore":navigator.vibrate(20);break;case"preview":navigator.vibrate([30,10,30]);break;case"activate":navigator.vibrate(100);break}}createTemporalProgressIndicator(){if(this.temporalProgressElement)return;this.temporalProgressElement=document.createElement("div"),this.temporalProgressElement.className="temporal-progress-indicator",this.temporalProgressElement.style.cssText=`
        position: fixed;
        width: 60px;
        height: 60px;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        pointer-events: none;
        z-index: 10000;
        display: none;
        transform: translate(-50%, -50%);
    `;const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.style.cssText="position: absolute; top: -2px; left: -2px; width: 64px; height: 64px; transform: rotate(-90deg);",t.innerHTML=`
        <circle cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="4"/>
        <circle cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="4"
                stroke-dasharray="188.5" stroke-dashoffset="188.5" class="progress-ring"/>
    `,this.temporalProgressElement.appendChild(t),document.body.appendChild(this.temporalProgressElement)}updateTemporalProgressIndicator(t,e,i){this.temporalProgressElement||this.createTemporalProgressIndicator(),this.temporalProgressElement.style.display="block",this.temporalProgressElement.style.left=t+"px",this.temporalProgressElement.style.top=e+"px";const n=this.temporalProgressElement.querySelector(".progress-ring");if(n){const r=188.5-188.5*i;n.style.strokeDashoffset=r,n.style.transition="stroke-dashoffset 100ms linear"}}hideTemporalProgressIndicator(){this.temporalProgressElement&&(this.temporalProgressElement.style.display="none")}animateTemporalProgress(){if(!this.temporalState.isHolding){this.hideTemporalProgressIndicator();return}const t=Date.now()-this.temporalState.holdStartTime,i=this.interactionModeManager.getTemporalThresholds().activateThreshold+200,n=Math.min(1,t/i),r=this.activePointers.get(this.primaryPointerId);r&&this.updateTemporalProgressIndicator(r.x,r.y,n),this.temporalState.isHolding&&n<1?requestAnimationFrame(()=>this.animateTemporalProgress()):this.hideTemporalProgressIndicator()}handlePointerCancel(t){this.activePointers.delete(t.pointerId),this.activePointers.size===0&&(this.primaryPointerId=null,this.isPinching=!1)}handleClick(t){var a;if(console.log("handleClick called",{isDragging:this.isDragging,isPinching:this.isPinching,activePointers:this.activePointers.size,targetTag:t.target.tagName,targetClass:((a=t.target.className)==null?void 0:a.baseVal)||t.target.className,timestamp:Date.now()}),t.target.closest(".openseadragon-controls"))return;if(this.isMobile&&this.hoveredHotspot){console.log("Using cached hover hotspot for mobile click"),t.stopPropagation(),t.preventDefault(),this.activateHotspot(this.hoveredHotspot);return}const e=this.viewer.element.getBoundingClientRect(),i=new et.Point(t.clientX-e.left,t.clientY-e.top),n=this.viewer.viewport.pointFromPixel(i),r=this.viewer.viewport.viewportToImageCoordinates(n),o=this.findSmallestHotspotAtPoint(r);o?(t.stopPropagation(),t.preventDefault(),this.activateHotspot(o)):this.selectedHotspot&&(this.deselectHotspot(),this.onHotspotClick&&this.onHotspotClick(null))}activateHotspot(t){console.log(" iOS DEBUG: activateHotspot called:",{hotspotId:t.id,timestamp:Date.now(),isSafari:this.isSafari,isMobile:this.isMobile}),this.selectedHotspot=t,this.selectionTimestamp=Date.now(),this.onHotspotClick(t),this.overlays.forEach((e,i)=>{var r;const n=i===t.id?"selected":i===((r=this.hoveredHotspot)==null?void 0:r.id)?"hover":"normal";i===t.id&&console.log(" iOS DEBUG: Applying selected style to:",i),this.applyStyle(e.element,e.hotspot.type,n)})}deselectHotspot(){console.log("Deselecting hotspot"),this.selectedHotspot=null,this.selectionTimestamp=null,this.overlays.forEach((t,e)=>{var n;const i=e===((n=this.hoveredHotspot)==null?void 0:n.id)?"hover":"normal";this.applyStyle(t.element,t.hotspot.type,i)})}instantDeselect(){var t;if(console.log("Instant deselecting hotspot"),this.selectedHotspot){const e=this.overlays.get(this.selectedHotspot.id);if(e&&e.element){const i=e.element.getElementsByTagName("path");for(let n of i)n.style.filter="none",n.style.stroke="rgba(255, 255, 255, 0)",n.style.strokeWidth="0",n.style.opacity="0",n.style.transition="none",n.style.animation="none";e.element.style.opacity="0",e.element.style.transition="none",e.element.style.animation="none",e.element.style.filter="none"}((t=this.hoveredHotspot)==null?void 0:t.id)===this.selectedHotspot.id&&(this.hoveredHotspot=null)}this.selectedHotspot=null,this.selectionTimestamp=null}findSmallestHotspotAtPoint(t){const e=[];return this.overlays.forEach((i,n)=>{i.isVisible&&this.isPointInHotspot(t,i)&&e.push({hotspot:i.hotspot,area:i.area})}),e.length===0?null:(e.sort((i,n)=>i.area-n.area),e[0].hotspot)}isPointInHotspot(t,e){const i=e.hotspot,n=e.bounds;return t.x<n.minX||t.x>n.maxX||t.y<n.minY||t.y>n.maxY?!1:i.shape==="polygon"?this.pointInPolygon(t.x,t.y,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(r=>this.pointInPolygon(t.x,t.y,r)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}applyStyle(t,e,i){t.getElementsByTagName("path");const n=t.querySelector(".main-path"),o=`${t.getAttribute("data-hotspot-id")}-${i}`,a=this.animationRegistry||(this.animationRegistry=new Set),c=a.has(o),h=this.viewer.viewport.getZoom(),d=h>8,p=t.getAttribute("data-current-state")!==i;if(this.interactionModeManager.getCurrentMode()==="temporal"&&(i==="hover"||i==="selected"&&this.temporalState.isHolding)){t.style.opacity="0",n&&(n.style.stroke="transparent",n.style.strokeWidth="0",n.style.filter="none");return}const m=i!=="normal"&&p,v=t.getAttribute("data-last-zoom")||"0",w=parseFloat(v)>8&&h<=8;if(t.setAttribute("data-last-zoom",h.toString()),this.animationRegistry&&(w||p)&&this.animationRegistry.delete(o),!(!p&&c&&!w&&!m)){if((i==="hover"||i==="selected")&&d){console.log("Smart static mode at zoom:",h.toFixed(2)),t.setAttribute("class",`hotspot-${e} hotspot-${i}`),t.setAttribute("data-current-state",i),t.setAttribute("data-animation-active","false"),n&&(n.style.transition="all 0.15s ease-out",n.style.fill="none",n.style.stroke=this.colorScheme.main,n.style.strokeWidth=i==="selected"?"2.5px":"2px",n.style.opacity=i==="selected"?"0.85":"0.7",n.style.strokeDasharray="none",n.style.strokeDashoffset="0",this.isSafari||(n.style.filter=`drop-shadow(0 0 3px ${this.colorScheme.glow})`)),this.isSafari&&t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach((A,F)=>{A.style.transition="opacity 0.15s ease-out",A.style.strokeDasharray="none",A.style.strokeDashoffset="0";const H=i==="selected"?["0.5","0.3","0.2"]:["0.4","0.2","0.1"];A.style.opacity=H[F]||"0"}),t.style.opacity="1";return}if(!(!p&&c&&!w&&!m)&&!((i==="hover"||i==="selected")&&t.getAttribute("data-animation-active")==="true")){if(t.setAttribute("class",`hotspot-${e} hotspot-${i}`),t.setAttribute("data-current-state",i),i==="hover"||i==="selected"){if(this.isSafari){const T=t.querySelector(".glow-layer-1"),A=t.querySelector(".glow-layer-2"),F=t.querySelector(".glow-layer-3"),H=t.getAttribute("data-hotspot-id"),q=this.getAnimationDuration(H);[{element:n,delay:0,opacity:"1"},{element:T,delay:0,opacity:i==="selected"?"0.7":"0.6"},{element:A,delay:0,opacity:i==="selected"?"0.5":"0.4"},{element:F,delay:0,opacity:i==="selected"?"0.3":"0.2"}].forEach(({element:D,delay:E,opacity:S})=>{if(D){const k=D.getTotalLength?D.getTotalLength():parseFloat(D.getAttribute("data-real-length"))||100,L=k*1.2;if(D.style.strokeDasharray=`${k} ${k}`,D.style.strokeDashoffset=`${L}px`,D.style.opacity="0",D.style.transition="none",D.style.animation="none",D.style.display="none",D.offsetHeight,D.style.display="",D.offsetHeight,D.style.vectorEffect="non-scaling-stroke",D.style.paintOrder="stroke",D.style.transform=`translateZ(${E*.001}px)`,D.style.willChange="stroke-dashoffset, opacity",D.animate){const O=D.animate([{strokeDashoffset:`${L}px`,opacity:"0",offset:0},{strokeDashoffset:`${k}px`,opacity:S*.3,offset:.1},{strokeDashoffset:"0px",opacity:S,offset:1}],{duration:q*1e3,delay:E,easing:this.timingEasing,fill:"forwards"});t.setAttribute("data-animation-active","true"),a.add(o),D.currentAnimation=O}else D.style.strokeDashoffset="0",D.style.opacity=S;i==="selected"?(E===150&&(D.style.filter="blur(1px)"),E===100&&(D.style.filter="blur(2px)"),E===50&&(D.style.filter="blur(3px)")):(E===150&&(D.style.filter="none"),E===100&&(D.style.filter="blur(1px)"),E===50&&(D.style.filter="blur(2px)"))}})}if(n&&!this.isSafari){n.currentAnimation&&(n.currentAnimation.cancel(),n.currentAnimation=null),n.style.animation="none",n.style.strokeDasharray="",n.style.strokeDashoffset="",n.offsetWidth,n.style.fill="none",this.isSafari?(n.style.stroke=this.colorScheme.main,n.style.strokeWidth=i==="selected"?"2.5px":"2px",n.style.filter="none",n.style.opacity="1"):(this.colorScheme.glow2?n.style.filter=`
                        drop-shadow(0 0 4px ${this.colorScheme.shadow})
                        drop-shadow(0 0 3px ${this.colorScheme.glow})
                        drop-shadow(0 0 10px ${this.colorScheme.glow2})
                        drop-shadow(0 0 20px ${this.colorScheme.glow2})
                    `:n.style.filter=`
                        drop-shadow(0 0 6px rgba(0, 0, 0, 0.8))
                        drop-shadow(0 0 3px ${this.colorScheme.glow})
                        drop-shadow(0 0 10px ${this.colorScheme.glow})
                    `,n.style.stroke=this.colorScheme.main,n.style.strokeWidth=i==="selected"?"2.5px":"2px",n.style.opacity="1");const T=parseFloat(n.getAttribute("data-real-length"))||100;n.style.strokeDasharray=T,n.style.strokeDashoffset=T;const A=t.getAttribute("data-hotspot-id");let F=this.getAnimationDuration(A);if(n.animate){const q=this.viewer.viewport.getZoom()>2,J=()=>{const D=i==="selected"?"0.85":"0.7";return n.currentAnimation=n.animate([{strokeDashoffset:T,opacity:"0.3",offset:0},{strokeDashoffset:"0",opacity:D,offset:1}],{duration:F*1e3,easing:this.timingEasing,fill:"forwards"}),n.currentAnimation.onfinish=()=>{n.currentAnimation=null},n.currentAnimation.finished};q?this.animationQueue.add(t,J):J(),t.setAttribute("data-animation-active","true"),a.add(o)}else n.style.strokeDasharray=T,n.style.strokeDashoffset="0",n.style.opacity=i==="selected"?"0.85":"0.7"}}else{if(this.animationRegistry){const T=t.getAttribute("data-hotspot-id");this.animationRegistry.delete(`${T}-hover`),this.animationRegistry.delete(`${T}-selected`)}t.setAttribute("data-animation-active","false"),this.isSafari&&t.querySelectorAll(".glow-layer-1, .glow-layer-2, .glow-layer-3").forEach(A=>{A.style.animation="none",A.currentAnimation&&(A.currentAnimation.cancel(),A.currentAnimation=null),A.offsetWidth;const F=parseFloat(A.getAttribute("data-real-length"))||100;A.style.strokeDasharray=`${F} ${F}`,A.style.strokeDashoffset=F,A.style.transition="opacity 0.2s ease-out",A.style.opacity="0",A.style.filter="none"}),n&&(n.currentAnimation&&(n.currentAnimation.cancel(),n.currentAnimation=null),n.getAnimations().forEach(T=>T.cancel()),n.style.animation="none",n.style.strokeDasharray="",n.style.strokeDashoffset="",n.offsetWidth,n.style.transition="opacity 0.2s ease-out",n.style.fill="none",n.style.stroke="transparent",n.style.strokeWidth="0",n.style.filter="none",n.style.opacity="0")}t.style.opacity=i==="hover"||i==="selected"?"1":"0"}}}resetStaticTransitions(t){const e=t.getElementsByTagName("path");for(let i of e)i.style.transition="none",i.offsetWidth}clearAnimationRegistryForZoomChange(){if(this.animationRegistry){const t=new Set;this.hoveredHotspot&&t.add(`${this.hoveredHotspot.id}-hover`),this.selectedHotspot&&t.add(`${this.selectedHotspot.id}-selected`);const e=[];this.animationRegistry.forEach((i,n)=>{t.has(n)||e.push(n)}),e.forEach(i=>this.animationRegistry.delete(i))}}refreshAllHotspotStyles(){console.log("Refreshing all hotspot styles with palette:",this.currentPalette),this.overlays.forEach((t,e)=>{var i,n;if(t.isVisible){const r=e===((i=this.selectedHotspot)==null?void 0:i.id)?"selected":e===((n=this.hoveredHotspot)==null?void 0:n.id)?"hover":"normal";r!=="normal"&&(this.applyStyle(t.element,t.hotspot.type,"normal"),setTimeout(()=>{this.applyStyle(t.element,t.hotspot.type,r)},50))}}),this.updateFilterColors(),this.updateWrapperStyles()}updateWrapperStyles(){this.isSafari}updateFilterColors(){const t=this.svg.querySelector('#hotspot-glow-selected feFlood[result="innerColor"]'),e=this.svg.querySelector('#hotspot-glow-selected feFlood[result="outerColor"]'),i=this.svg.querySelector('#hotspot-glow-selected feFlood[result="midColor"]'),n=this.svg.querySelector('#hotspot-glow-hover feFlood[result="innerColor"]'),r=this.svg.querySelector('#hotspot-glow-hover feFlood[result="outerColor"]');t&&t.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),e&&e.setAttribute("flood-color",this.colorScheme.glow2||"#4682B4"),i&&i.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),n&&n.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),r&&r.setAttribute("flood-color",this.colorScheme.main||"#4682B4")}calculateBounds(t){let e={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};const i=n=>{n.forEach(([r,o])=>{e.minX=Math.min(e.minX,r),e.minY=Math.min(e.minY,o),e.maxX=Math.max(e.maxX,r),e.maxY=Math.max(e.maxY,o)})};return Array.isArray(t[0])&&typeof t[0][0]=="number"?i(t):t.forEach(i),e}getHotspotBounds(t){const e=this.overlays.get(t.id);return e&&e.bounds?e.bounds:this.calculateBounds(t.coordinates)}calculateArea(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}getAnimationDuration(t){var p,f;const e=this.isMobile?.9:1.2,i=((f=(p=this.viewer)==null?void 0:p.viewport)==null?void 0:f.getZoom())||1,n=1,r=5,o=3,a=1,h=(Math.max(n,Math.min(r,i))-n)/(r-n),d=o-h*(o-a);return e*d}calculateGlowIntensity(){return 1}optimizeForSafari(){/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&this.overlays.forEach(e=>{const i=e.element.getElementsByTagName("path");for(let n of i)n.style.transform="translateZ(0)",n.style.webkitBackfaceVisibility="hidden"})}createSimpleSVG(t){const e=`<svg xmlns="http://www.w3.org/2000/svg" 
           width="${t.x}" height="${t.y}" 
           viewBox="0 0 ${t.x} ${t.y}"
           style="position: absolute; width: 100%; height: 100%; pointer-events: auto;">
    </svg>`;return new DOMParser().parseFromString(e,"image/svg+xml").documentElement}startVisibilityTracking(){let t=null,e=0;this.isMobile;const i=()=>{if(t&&clearTimeout(t),this.isAnimationInProgress||this.viewer.isAnimating()){this.pendingVisibilityUpdate=!0;return}const r=Date.now()-e,o=this.viewer.viewport.getZoom()<5?100:50;if(r<o){t=setTimeout(()=>{i()},o-r);return}t=setTimeout(()=>{e=Date.now(),this.updateVisibility()},this.renderDebounceTime)};this.viewer.addHandler("animation",i),this.viewer.addHandler("animation-finish",()=>{!this.updatesPaused&&!this.isAnimationInProgress&&this.updateVisibility()}),this.isMobile||this.viewer.addHandler("viewport-change",i),this.updateVisibility()}updateVisibility(){var f,m;if(this.updatesPaused||this.isAnimationInProgress){console.log("updateVisibility BLOCKED - animation in progress"),this.pendingVisibilityUpdate=!0;return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.zoomSpring.target.value;if(Math.abs(t-e)>.001){console.log("updateVisibility SKIPPED - viewer is zooming"),this.pendingVisibilityUpdate=!0;return}if(this.viewer.isAnimating()){console.log("updateVisibility SKIPPED - viewer is animating"),this.pendingVisibilityUpdate=!0;return}const n=this.viewer.viewport.getBounds();if(this.lastViewportBounds&&this.lastViewportZoom){const v=Math.abs(n.x-this.lastViewportBounds.x)>this.significantChangeThreshold||Math.abs(n.y-this.lastViewportBounds.y)>this.significantChangeThreshold||Math.abs(n.width-this.lastViewportBounds.width)>this.significantChangeThreshold||Math.abs(n.height-this.lastViewportBounds.height)>this.significantChangeThreshold,w=Math.abs(t-this.lastViewportZoom)>.1;if(!v&&!w)return}this.lastViewportBounds=n,this.lastViewportZoom=t;const r=this.viewer.viewport;if(r.getZoom()<1.5){const v=(f=this.selectedHotspot)==null?void 0:f.id,w=(m=this.hoveredHotspot)==null?void 0:m.id;requestAnimationFrame(()=>{this.overlays.forEach(T=>{const A=T.hotspot.id===v||T.hotspot.id===w;T.element.style.opacity=A?"1":"0",T.isVisible=!0})});return}const a=r.viewportToImageCoordinates(n.getTopLeft()),c=r.viewportToImageCoordinates(n.getBottomRight()),h={minX:a.x,minY:a.y,maxX:c.x,maxY:c.y},d=(h.maxX-h.minX)*.2;h.minX-=d,h.minY-=d,h.maxX+=d,h.maxY+=d;const l=[];let p=0;this.overlays.forEach((v,w)=>{v.bounds.maxX<h.minX||v.bounds.minX>h.maxX||v.bounds.maxY<h.minY||v.bounds.minY>h.maxY?v.isVisible&&(l.push({element:v.element,opacity:"0"}),v.isVisible=!1,this.visibleOverlays.delete(w)):(p++,v.isVisible||(l.push({element:v.element,opacity:"1"}),v.isVisible=!0,this.visibleOverlays.add(w)))}),l.length>0&&requestAnimationFrame(()=>{l.forEach(v=>{v.element.style.opacity=v.opacity})}),Math.abs(t-this.lastViewportZoom)>.5&&requestAnimationFrame(()=>{this.viewer.world.getItemCount()>0&&this.viewer.updateOverlay(this.svg)}),p>100&&console.log(`Performance note: ${p} hotspots visible`),p>hi.HIGH_HOTSPOT_COUNT_THRESHOLD&&this.animationQueue&&(this.animationQueue.clearFinished(),this.animationQueue.running.size>hi.MAX_CONCURRENT_ANIMATIONS&&(this.animationQueue.clear(),console.log("Animation queue cleared due to high hotspot count"))),this.checkPerformanceMode()}forceIOSRedraw(){this.isMobile&&this.viewer&&this.svg&&(this.svg.style.display="none",this.svg.offsetHeight,this.svg.style.display="",this.viewer.updateOverlay(this.svg))}checkPerformanceMode(){const t=this.visibleOverlays.size;t>hi.HIGH_HOTSPOT_COUNT_THRESHOLD&&!this.performanceMode?(this.performanceMode=!0,this.svg.classList.add("performance-mode"),console.log("Performance mode enabled - simplifying animations")):t<hi.HIGH_HOTSPOT_COUNT_THRESHOLD*.8&&this.performanceMode&&(this.performanceMode=!1,this.svg.classList.remove("performance-mode"))}updateVisibilityLazy(){if(this.updatesPaused){console.log("updateVisibilityLazy SKIPPED - updates are paused");return}console.log("updateVisibilityLazy starting - mobile optimized");const t=this.viewer.viewport;if(t.getZoom(),this.viewer.isAnimating()){console.log("updateVisibilityLazy deferred - still animating"),setTimeout(()=>this.updateVisibilityLazy(),100);return}const e=t.getBounds(),i=t.viewportToImageCoordinates(e.getTopLeft()),n=t.viewportToImageCoordinates(e.getBottomRight()),r={minX:i.x,minY:i.y,maxX:n.x,maxY:n.y},o=(r.maxX-r.minX)*.2;Object.keys(r).forEach(p=>{r[p]+=p.startsWith("min")?-o:o});const a=Array.from(this.overlays.entries());let c=0,h=0;const d=30,l=()=>{const p=performance.now();for(h=0;c<a.length&&h<d&&performance.now()-p<8;){const[f,m]=a[c],v=this.boundsIntersect(m.bounds,r);v!==m.isVisible&&(m.element.style.opacity=v?"1":"0",m.isVisible=v,v?this.visibleOverlays.add(f):this.visibleOverlays.delete(f)),c++,h++}c<a.length?"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:50}):requestAnimationFrame(l):this.viewer.world.getItemCount()>0&&requestAnimationFrame(()=>{this.viewer.updateOverlay(this.svg),console.log("updateVisibilityLazy complete")})};"requestIdleCallback"in window?requestIdleCallback(()=>l(),{timeout:100}):setTimeout(()=>requestAnimationFrame(l),50)}boundsIntersect(t,e){return!(t.maxX<e.minX||t.minX>e.maxX||t.maxY<e.minY||t.minY>e.maxY)}createMaskDefs(){this.defs||(this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.svg.insertBefore(this.defs,this.svg.firstChild),this.maskCounter=0)}createClipPathDefs(){this.defs||this.createMaskDefs();const t=document.createElementNS("http://www.w3.org/2000/svg","defs");t.id="clip-path-defs",this.svg.insertBefore(t,this.svg.firstChild),this.clipDefs=t}createSVGFilters(){const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","filter");e.setAttribute("id","hotspot-glow-selected"),e.setAttribute("x","-100%"),e.setAttribute("y","-100%"),e.setAttribute("width","300%"),e.setAttribute("height","300%"),e.setAttribute("filterUnits","objectBoundingBox"),e.setAttribute("primitiveUnits","userSpaceOnUse"),e.setAttribute("color-interpolation-filters","sRGB");const i=document.createElementNS("http://www.w3.org/2000/svg","feMorphology");i.setAttribute("operator","dilate"),i.setAttribute("radius","2"),i.setAttribute("in","SourceAlpha"),i.setAttribute("result","expanded");const n=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");n.setAttribute("in","expanded"),n.setAttribute("stdDeviation","3"),n.setAttribute("result","blur1");const r=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");r.setAttribute("in","expanded"),r.setAttribute("stdDeviation","8"),r.setAttribute("result","blur2");const o=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");o.setAttribute("in","expanded"),o.setAttribute("stdDeviation","15"),o.setAttribute("result","blur3");const a=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");a.setAttribute("in","blur1"),a.setAttribute("result","glow1");const c=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");c.setAttribute("type","linear"),c.setAttribute("slope","0.8"),c.setAttribute("intercept","0"),a.appendChild(c);const h=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");h.setAttribute("in","blur2"),h.setAttribute("result","glow2");const d=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");d.setAttribute("type","linear"),d.setAttribute("slope","0.5"),d.setAttribute("intercept","0"),h.appendChild(d);const l=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");l.setAttribute("in","blur3"),l.setAttribute("result","glow3");const p=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");p.setAttribute("type","linear"),p.setAttribute("slope","0.3"),p.setAttribute("intercept","0"),l.appendChild(p);const f=document.createElementNS("http://www.w3.org/2000/svg","feFlood");f.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),f.setAttribute("result","innerColor");const m=document.createElementNS("http://www.w3.org/2000/svg","feFlood");m.setAttribute("flood-color",this.colorScheme.glow2||"#4682B4"),m.setAttribute("result","outerColor");const v=document.createElementNS("http://www.w3.org/2000/svg","feComposite");v.setAttribute("in","innerColor"),v.setAttribute("in2","glow1"),v.setAttribute("operator","in"),v.setAttribute("result","innerGlow");const w=document.createElementNS("http://www.w3.org/2000/svg","feComposite");w.setAttribute("in","outerColor"),w.setAttribute("in2","glow3"),w.setAttribute("operator","in"),w.setAttribute("result","outerGlow");const T=document.createElementNS("http://www.w3.org/2000/svg","feFlood");T.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),T.setAttribute("result","midColor");const A=document.createElementNS("http://www.w3.org/2000/svg","feComposite");A.setAttribute("in","midColor"),A.setAttribute("in2","glow2"),A.setAttribute("operator","in"),A.setAttribute("result","midGlow");const F=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),H=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");H.setAttribute("in","outerGlow");const q=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");q.setAttribute("in","midGlow");const J=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");J.setAttribute("in","innerGlow");const D=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");D.setAttribute("in","SourceGraphic"),F.appendChild(H),F.appendChild(q),F.appendChild(J),F.appendChild(D),e.appendChild(i),e.appendChild(n),e.appendChild(r),e.appendChild(o),e.appendChild(a),e.appendChild(h),e.appendChild(l),e.appendChild(f),e.appendChild(m),e.appendChild(v),e.appendChild(w),e.appendChild(T),e.appendChild(A),e.appendChild(F);const E=document.createElementNS("http://www.w3.org/2000/svg","filter");E.setAttribute("id","hotspot-glow-hover"),E.setAttribute("x","-80%"),E.setAttribute("y","-80%"),E.setAttribute("width","260%"),E.setAttribute("height","260%"),E.setAttribute("filterUnits","objectBoundingBox"),E.setAttribute("primitiveUnits","userSpaceOnUse"),E.setAttribute("color-interpolation-filters","sRGB");const S=document.createElementNS("http://www.w3.org/2000/svg","feMorphology");S.setAttribute("operator","dilate"),S.setAttribute("radius","1"),S.setAttribute("in","SourceAlpha"),S.setAttribute("result","expanded");const k=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");k.setAttribute("in","expanded"),k.setAttribute("stdDeviation","2"),k.setAttribute("result","blur1");const L=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");L.setAttribute("in","expanded"),L.setAttribute("stdDeviation","6"),L.setAttribute("result","blur2");const O=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");O.setAttribute("in","blur1"),O.setAttribute("result","glow1");const M=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");M.setAttribute("type","linear"),M.setAttribute("slope","0.6"),O.appendChild(M);const V=document.createElementNS("http://www.w3.org/2000/svg","feComponentTransfer");V.setAttribute("in","blur2"),V.setAttribute("result","glow2");const Ce=document.createElementNS("http://www.w3.org/2000/svg","feFuncA");Ce.setAttribute("type","linear"),Ce.setAttribute("slope","0.3"),V.appendChild(Ce);const Ie=document.createElementNS("http://www.w3.org/2000/svg","feFlood");Ie.setAttribute("flood-color",this.colorScheme.glow||"#87CEEB"),Ie.setAttribute("result","innerColor");const Oe=document.createElementNS("http://www.w3.org/2000/svg","feFlood");Oe.setAttribute("flood-color",this.colorScheme.main||"#4682B4"),Oe.setAttribute("result","outerColor");const ne=document.createElementNS("http://www.w3.org/2000/svg","feComposite");ne.setAttribute("in","innerColor"),ne.setAttribute("in2","glow1"),ne.setAttribute("operator","in"),ne.setAttribute("result","innerGlow");const Te=document.createElementNS("http://www.w3.org/2000/svg","feComposite");Te.setAttribute("in","outerColor"),Te.setAttribute("in2","glow2"),Te.setAttribute("operator","in"),Te.setAttribute("result","outerGlow");const Se=document.createElementNS("http://www.w3.org/2000/svg","feMerge"),dt=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");dt.setAttribute("in","outerGlow");const We=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");We.setAttribute("in","innerGlow");const te=document.createElementNS("http://www.w3.org/2000/svg","feMergeNode");te.setAttribute("in","SourceGraphic"),Se.appendChild(dt),Se.appendChild(We),Se.appendChild(te),E.appendChild(S),E.appendChild(k),E.appendChild(L),E.appendChild(O),E.appendChild(V),E.appendChild(Ie),E.appendChild(Oe),E.appendChild(ne),E.appendChild(Te),E.appendChild(Se),t.appendChild(e),t.appendChild(E),this.svg.insertBefore(t,this.svg.firstChild)}zoomToHotspot(t){const e=this.overlays.get(t.id);if(!e)return;const i=e.bounds,n=this.viewer.world.getItemAt(0).getContentSize(),r=new et.Rect(i.minX/n.x,i.minY/n.y,(i.maxX-i.minX)/n.x,(i.maxY-i.minY)/n.y),o=e.area,a=n.x*n.y,c=o/a,h=c<.01?1:c<.05?.7:c<.1?.5:.3,d=r.width*h,l=r.height*h,p=new et.Rect(r.x-d,r.y-l,r.width+d*2,r.height+l*2);this.viewer.viewport.fitBounds(p,!1)}getOverlapMetrics(){const t=[],e=Array.from(this.overlays.values());for(let i=0;i<e.length;i++)for(let n=i+1;n<e.length;n++)this.boundsIntersect(e[i].bounds,e[n].bounds)&&t.push({hotspot1:e[i].hotspot.id,hotspot2:e[n].hotspot.id,area1:e[i].area,area2:e[n].area});return{totalOverlaps:t.length,overlaps:t}}setDebugMode(t){this.debugMode=t,this.initStyles(),this.overlays.forEach((e,i)=>{var r,o;const n=i===((r=this.selectedHotspot)==null?void 0:r.id)?"selected":i===((o=this.hoveredHotspot)==null?void 0:o.id)?"hover":"normal";this.applyStyle(e.element,e.hotspot.type,n)})}pauseUpdates(){console.log("pauseUpdates called - blocking all visibility updates"),this.updatesPaused=!0,this.isAnimationInProgress=!0,this.selectedHotspot&&this.overlays.forEach((t,e)=>{var i;e!==this.selectedHotspot.id&&e!==((i=this.hoveredHotspot)==null?void 0:i.id)&&(t.element.style.visibility="hidden")})}resumeUpdates(){console.log("resumeUpdates called - unblocking updates"),this.updatesPaused=!1,this.isAnimationInProgress=!1,this.overlays.forEach(t=>{t.element.style.visibility="visible"}),this.pendingVisibilityUpdate&&(this.pendingVisibilityUpdate=!1,this.isMobile?this.updateVisibilityLazy():this.updateVisibility())}hideOverlay(){console.log("Hiding entire SVG overlay"),this.svg&&(this.svg.style.display="none")}showOverlay(){console.log("Showing SVG overlay"),this.svg&&(this.svg.style.display="")}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.mouseTracker&&this.mouseTracker.destroy(),this.viewer.removeAllHandlers("animation"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("animation-update"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeHandler("canvas-drag"),this.viewer.removeHandler("canvas-drag-end"),this.viewer.removeHandler("zoom"),this.svg&&(this.svg.removeEventListener("pointerdown",this.handlePointerDown),this.svg.removeEventListener("pointermove",this.handlePointerMove),this.svg.removeEventListener("pointerup",this.handlePointerUp),this.svg.removeEventListener("pointercancel",this.handlePointerCancel),this.viewer.removeOverlay(this.svg)),this.animationQueue&&(this.animationQueue.clear(),this.animationQueue=null),this.overlays.forEach(e=>{const i=e.element.getElementsByTagName("path");for(let n of i)n.style.animation="none",n.style.transition="none"});const t=document.getElementById("hotspot-animations");t&&t.remove(),this.overlays.clear(),this.visibleOverlays.clear(),this.hotspotAreas.clear(),this.pathDefs&&this.pathDefs.remove(),this.viewer=null,window.nativeHotspotRenderer===this&&(window.nativeHotspotRenderer=null)}};An(hi,"MAX_CONCURRENT_ANIMATIONS",25),An(hi,"MAX_CONCURRENT_ANIMATIONS_MOBILE",15),An(hi,"HIGH_HOTSPOT_COUNT_THRESHOLD",100);let yo=hi;class rd{constructor(t){this.viewer=t,this.isMonitoring=!1,this.frameCount=0,this.lastTime=performance.now(),this.fpsHistory=[],this.frameTimes=[],this.thresholds={fps:{target:60,good:55,acceptable:45,poor:30,critical:20},frameTime:{target:16.67,warning:20},memory:{warning:250,critical:300}},this.metrics=this.getDefaultMetrics(),this.performanceHistory=[],this.loadTimes=[],this.config={historySize:{fps:60,performance:300,frameTimes:60,loadTimes:50},intervals:{monitoring:250,debug:100},optimization:{cooldown:1e3}},this.lastOptimization=Date.now(),this.intervals={}}getDefaultMetrics(){return{currentFPS:60,averageFPS:60,minFPS:60,maxFPS:60,frameTime:16.67,maxFrameTime:16.67,droppedFrames:0,tileLoadTime:0,visibleTiles:0,cachedTiles:0,tilesLoading:0,memoryUsage:0,memoryLimit:0,gcCount:0,renderMode:"static",drawCalls:0,canvasSize:0,zoomLevel:1,viewportCoverage:0,hotspotCount:0,performanceScore:100}}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.measureFrame(),this.intervals.monitoring=setInterval(()=>{this.updateMetrics(),this.analyzePerformance()},this.config.intervals.monitoring),this.setupEventHandlers(),console.log("Performance monitoring started - Target: 60 FPS"))}stop(){this.isMonitoring=!1,Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.removeEventHandlers(),console.log("Performance monitoring stopped")}pauseMonitoring(){this.isPaused=!0,console.log("Performance monitoring paused")}resumeMonitoring(){this.isPaused=!1,console.log("Performance monitoring resumed")}setupEventHandlers(){const t={"tile-loaded":this.onTileLoaded,"tile-load-failed":this.onTileLoadFailed,"animation-start":()=>this.metrics.renderMode="animating","animation-finish":()=>this.metrics.renderMode="static"};Object.entries(t).forEach(([e,i])=>this.viewer.addHandler(e,i.bind(this)))}removeEventHandlers(){["tile-loaded","tile-load-failed","animation-start","animation-finish"].forEach(t=>this.viewer.removeAllHandlers(t))}measureFrame(){if(!this.isMonitoring||this.isPaused)return;const t=performance.now(),e=t-this.lastTime;this.updateFrameMetrics(e),this.lastTime=t,this.frameCount++,this.rafId=requestAnimationFrame(()=>this.measureFrame())}updateFrameMetrics(t){if(this.frameTimes.push(t),this.trimArray(this.frameTimes,this.config.historySize.frameTimes),t>0){const e=1e3/t;this.fpsHistory.push(e),this.trimArray(this.fpsHistory,this.config.historySize.fps),this.metrics.currentFPS=e,t>20&&this.metrics.droppedFrames++}}updateMetrics(){this.updateFPSMetrics(),this.updateFrameTimeMetrics(),this.updateViewerMetrics(),this.updateTileMetrics(),this.updateMemoryMetrics(),this.calculatePerformanceScore(),this.trackPerformanceHistory()}updateFPSMetrics(){this.fpsHistory.length!==0&&(this.metrics.averageFPS=Math.round(this.average(this.fpsHistory)),this.metrics.minFPS=Math.round(Math.min(...this.fpsHistory)),this.metrics.maxFPS=Math.round(Math.max(...this.fpsHistory)))}updateFrameTimeMetrics(){this.frameTimes.length!==0&&(this.metrics.frameTime=this.average(this.frameTimes).toFixed(2),this.metrics.maxFrameTime=Math.max(...this.frameTimes).toFixed(2))}updateViewerMetrics(){this.metrics.zoomLevel=this.viewer.viewport.getZoom(!0).toFixed(2);const t=this.viewer.drawer.canvas;t&&(this.metrics.canvasSize=`${t.width}${t.height}`);const i=this.viewer.viewport.getBounds(),n=this.viewer.world.getHomeBounds(),r=i.width*i.height/(n.width*n.height);this.metrics.viewportCoverage=Math.min(100,r*100).toFixed(1)}updateTileMetrics(){var i,n;const t=this.viewer.world;if(t.getItemCount()===0)return;const e=t.getItemAt(0);if(e){if(this.metrics.visibleTiles=((i=e._tilesToDraw)==null?void 0:i.length)||0,e._tileCache){const r=e._tileCache;this.metrics.cachedTiles=((n=r._tilesLoaded)==null?void 0:n.length)||r._imagesLoadedCount||0}window.tileOptimizer&&(this.metrics.tilesLoading=window.tileOptimizer.getStats().loadingCount)}}updateMemoryMetrics(){performance.memory&&(this.metrics.memoryUsage=Math.round(performance.memory.usedJSHeapSize/1048576),this.metrics.memoryLimit=Math.round(performance.memory.jsHeapSizeLimit/1048576))}calculatePerformanceScore(){const{fps:t,frameTime:e,memory:i}=this.thresholds,n={fps:Math.min(100,this.metrics.averageFPS/t.target*100)*.5,frameTime:Math.min(100,e.target/parseFloat(this.metrics.frameTime)*100)*.2,memory:this.metrics.memoryLimit>0?Math.max(0,Math.min(100,(1-this.metrics.memoryUsage/this.metrics.memoryLimit)*100))*.2:20,droppedFrames:Math.max(0,100-Math.min(100,this.metrics.droppedFrames*2))*.1};this.metrics.performanceScore=Math.round(Object.values(n).reduce((r,o)=>r+o,0))}trackPerformanceHistory(){this.performanceHistory.push({timestamp:Date.now(),fps:this.metrics.averageFPS,memory:this.metrics.memoryUsage,tiles:this.metrics.visibleTiles,score:this.metrics.performanceScore}),this.trimArray(this.performanceHistory,this.config.historySize.performance)}analyzePerformance(){const t=Date.now();if(t-this.lastOptimization<this.config.optimization.cooldown)return;const{fps:e}=this.thresholds,i=this.metrics.averageFPS,n=this.metrics.performanceScore,r=this.getPerformanceTrend(),o=[{condition:i<e.critical||n<30,action:this.applyCriticalOptimizations,log:"CRITICAL"},{condition:i<e.poor||n<50,action:this.applyAggressiveOptimizations,log:"Poor"},{condition:i<e.good||n<80,action:this.applyModerateOptimizations,log:"Below target"},{condition:i>e.target&&n>90&&(r==="improving"||r==="stable"),action:this.restoreQualitySettings,log:null}];for(const a of o)if(a.condition){a.log&&console[a.log==="CRITICAL"?"error":"warn"](`${a.log} performance: Score ${n}, FPS: ${i}`),a.action.call(this),this.lastOptimization=t;break}}getPerformanceTrend(){if(this.performanceHistory.length<20)return"stable";const t=this.performanceHistory.slice(-10),e=this.performanceHistory.slice(-20,-10),i=this.average(t.map(o=>o.score)),n=this.average(e.map(o=>o.score)),r=i-n;return r>5?"improving":r<-5?"declining":"stable"}applyCriticalOptimizations(){Object.assign(this.viewer,{imageLoaderLimit:2,maxImageCacheCount:100,smoothTileEdgesMinZoom:1/0,alwaysBlend:!1,immediateRender:!0,animationTime:.5,springStiffness:10}),window.gc&&window.gc(),console.log("Applied critical performance optimizations")}applyAggressiveOptimizations(){this.viewer.imageLoaderLimit=Math.max(3,this.viewer.imageLoaderLimit-1),this.viewer.maxImageCacheCount=Math.max(200,this.viewer.maxImageCacheCount-50),this.viewer.animationTime=Math.max(.8,this.viewer.animationTime-.1),console.log("Applied aggressive performance optimizations")}applyModerateOptimizations(){this.viewer.imageLoaderLimit>4&&(this.viewer.imageLoaderLimit--,console.log("Applied moderate performance optimizations"))}restoreQualitySettings(){var i;const t=(i=window.performanceConfig)==null?void 0:i.viewer;if(!t)return;[{prop:"imageLoaderLimit",delta:1,op:"increase"},{prop:"maxImageCacheCount",delta:50,op:"increase"},{prop:"animationTime",delta:.1,op:"decrease"}].forEach(({prop:n,delta:r,op:o})=>{const a=this.viewer[n],c=t[n];o==="increase"&&a<c?this.viewer[n]=Math.min(c,a+r):o==="decrease"&&a>c&&(this.viewer[n]=Math.max(c,a-r))})}onTileLoaded(t){var e;(e=t.tile)!=null&&e.loadTime&&(this.metrics.tileLoadTime=this.metrics.tileLoadTime*.9+t.tile.loadTime*.1)}onTileLoadFailed(t){console.warn("Tile load failed:",t.tile)}trackLoadTime(t){this.loadTimes.push(t),this.trimArray(this.loadTimes,this.config.historySize.loadTimes),this.averageLoadTime=this.average(this.loadTimes)}getMetrics(){const t=this.getPerformanceLevel();return{...this.metrics,performanceLevel:t,trend:this.getPerformanceTrend(),warnings:this.getWarnings(),recommendations:this.getRecommendations()}}getPerformanceLevel(){const{averageFPS:t,performanceScore:e}=this.metrics,{fps:i}=this.thresholds;return[{name:"excellent",condition:t>=i.target&&e>=90},{name:"good",condition:t>=i.good&&e>=80},{name:"acceptable",condition:t>=i.acceptable&&e>=60},{name:"poor",condition:t>=i.poor&&e>=40},{name:"critical",condition:!0}].find(r=>r.condition).name}getWarnings(){const t=this.metrics,e=this.thresholds;return[{condition:t.averageFPS<e.fps.acceptable,message:`Low FPS: ${t.averageFPS} (target: ${e.fps.target})`},{condition:t.droppedFrames>100,message:`Dropped frames: ${t.droppedFrames}`},{condition:parseFloat(t.frameTime)>e.frameTime.warning,message:`High frame time: ${t.frameTime}ms`},{condition:t.memoryUsage>e.memory.critical,message:`High memory: ${t.memoryUsage}MB`},{condition:t.cachedTiles>2e3,message:`Large cache: ${t.cachedTiles} tiles`},{condition:t.tileLoadTime>300,message:`Slow tile loading: ${Math.round(t.tileLoadTime)}ms`}].filter(n=>n.condition).map(n=>n.message)}getRecommendations(){const t=[],e=this.metrics,i=this.thresholds;return e.averageFPS<i.fps.acceptable&&(e.renderMode==="animating"&&t.push("Reduce animation time for smoother transitions"),e.cachedTiles>1e3&&t.push("Clear tile cache to free memory"),e.visibleTiles>50&&t.push("Zoom in to reduce visible tiles")),e.memoryUsage>i.memory.warning&&t.push("Consider reloading the page to clear memory"),e.tileLoadTime>200&&t.push("Check network connection or reduce concurrent tile loads"),t}enableDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.style.cssText=`
            position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 12px; font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px; border-radius: 6px; z-index: 9999; min-width: 180px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `,document.body.appendChild(this.debugOverlay),this.intervals.debug=setInterval(()=>this.updateDebugOverlay(),this.config.intervals.debug))}updateDebugOverlay(){if(!this.isMonitoring||!this.debugOverlay)return;const t=this.getMetrics(),e={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"},i=t.currentFPS<55?"#FF9800":"#4CAF50",n=t.memoryUsage>250?"#FF9800":"#4CAF50";this.debugOverlay.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">
                Performance Monitor
                <span style="float: right; color: ${e[t.performanceLevel]};">
                    ${t.performanceScore}%
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>FPS:</span>
                <span style="color: ${i};">
                    ${t.currentFPS.toFixed(0)} (avg: ${t.averageFPS})
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Zoom:</span>
                <span>${t.zoomLevel}x</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Memory:</span>
                <span style="color: ${n};">
                    ${t.memoryUsage}MB
                </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Status:</span>
                <span style="color: ${e[t.performanceLevel]}; font-weight: 500;">
                    ${t.performanceLevel}
                </span>
            </div>
        `}disableDebugOverlay(){this.debugOverlay&&(this.debugOverlay.remove(),this.debugOverlay=null),this.intervals.debug&&(clearInterval(this.intervals.debug),delete this.intervals.debug)}average(t){return t.reduce((e,i)=>e+i,0)/t.length}trimArray(t,e){for(;t.length>e;)t.shift()}}class sd{constructor(t){this.viewer=t,this.state={isZoomingActive:!1,lastBlendTime:null,lastStiffness:null,isAnimating:!1,isZooming:!1,isPanning:!1,renderMode:"static",consecutiveStaticFrames:0,canvasOptimized:!1,lastFrameTime:performance.now(),isCinematicZoom:!1,frameSkipCount:0},this.lastInteraction=Date.now(),this.lastZoomLevel=null,this.lastCenter=null,this.lastOptimizationTime=0,this.zoomStartLevel=null,this.zoomVelocity=0,this.config={animationEndDelay:80,pixelPerfectDelay:50,zoomThreshold:.005,panThreshold:.005,smoothTransitionDuration:150,staticFramesBeforeOptimize:5,optimizationCooldown:100,forceGPU:!0,frameSkipThreshold:33,zoomVelocityThreshold:.03},this.timers={},this.setupEventHandlers(),this.applyInitialOptimizations(),this.setupAggressiveZoomOptimization(),window.renderOptimizer=this}setupEventHandlers(){Object.entries({"animation-start":()=>this.handleAnimationStart(),"animation-finish":()=>this.handleAnimationFinish(),animation:()=>this.handleAnimation(),"viewport-change":()=>this.handleViewportChange(),"canvas-press":()=>this.handleInteraction("press"),"canvas-drag":()=>this.handleInteraction("drag"),"canvas-drag-end":()=>this.handleInteraction("drag-end"),"canvas-scroll":()=>this.handleInteraction("scroll"),"canvas-pinch":()=>this.handleInteraction("pinch")}).forEach(([e,i])=>this.viewer.addHandler(e,i))}applyInitialOptimizations(){const t=this.viewer.container;t&&Object.assign(t.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden",perspective:"1000px"}),setTimeout(()=>this.applyCanvasOptimizations(),100)}handleAnimationStart(){this.clearTimers(),this.state.isAnimating=!0,this.state.consecutiveStaticFrames=0,this.setRenderMode("animation")}handleAnimationFinish(){this.state.isAnimating=!1,this.timers.animationEnd=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}handleAnimation(){const t=performance.now(),e=t-this.state.lastFrameTime;if(this.state.lastFrameTime=t,this.viewer.viewport.getZoom()<3&&e>20&&this.state.isZooming){if(this.state.frameSkipCount++,this.state.frameSkipCount%2===0)return}else this.state.frameSkipCount=0;Date.now()-this.lastInteraction>100&&!this.isCurrentlyAnimating()?(this.state.consecutiveStaticFrames++,this.state.consecutiveStaticFrames>=this.config.staticFramesBeforeOptimize&&this.setRenderMode("static")):this.state.consecutiveStaticFrames=0}setupAggressiveZoomOptimization(){let t=null,e=!1;this.viewer.addHandler("zoom",()=>{if(!e){if(e=!0,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!1,i.globalAlpha=1}this.viewer.skipTileDrawing=!0}t&&clearTimeout(t),t=setTimeout(()=>{if(e=!1,this.viewer.drawer&&this.viewer.drawer.context){const i=this.viewer.drawer.context;i.imageSmoothingEnabled=!0,i.globalAlpha=1}this.viewer.skipTileDrawing=!1,this.viewer.forceRedraw(),t=null},150)})}handleViewportChange(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getCenter(!0);if(this.lastZoomLevel!==null){const i=Math.abs(t-this.lastZoomLevel);this.zoomVelocity=this.zoomVelocity*.7+i*.3,this.state.isZooming=i>this.config.zoomThreshold||this.zoomVelocity>this.config.zoomVelocityThreshold,this.applyZoomOptimizations(this.state.isZooming),this.state.isZooming?(this.lastInteraction=Date.now(),this.zoomStartLevel||(this.zoomStartLevel=this.lastZoomLevel)):this.zoomStartLevel&&(this.zoomStartLevel=null,this.scheduleStaticMode())}if(this.lastCenter!==null){const i=Math.sqrt(Math.pow(e.x-this.lastCenter.x,2)+Math.pow(e.y-this.lastCenter.y,2));this.state.isPanning=i>this.config.panThreshold,this.state.isPanning&&(this.lastInteraction=Date.now())}this.lastZoomLevel=t,this.lastCenter=e}applyZoomOptimizations(t){var i,n;if(!(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||!((n=(i=window.performanceConfig)==null?void 0:i.renderOptimization)!=null&&n.zoomOptimizations))){if(t&&!this.state.isZoomingActive){if(this.state.isZoomingActive=!0,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&(this.state.lastBlendTime=r.blendTime,r.blendTime=0)}this.state.lastStiffness=this.viewer.viewport.zoomSpring.springStiffness,this.viewer.viewport.zoomSpring.springStiffness=10,this.viewer.viewport.centerSpringX.springStiffness=10,this.viewer.viewport.centerSpringY.springStiffness=10,this.viewer.immediateRender=!0,window.tileCleanupManager&&window.tileCleanupManager.pauseCleanup(2e3)}else if(!t&&this.state.isZoomingActive){if(this.state.isZoomingActive=!1,this.viewer.world.getItemCount()>0){const r=this.viewer.world.getItemAt(0);r&&this.state.lastBlendTime!==null&&(r.blendTime=this.state.lastBlendTime)}this.state.lastStiffness!==null&&(this.viewer.viewport.zoomSpring.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringX.springStiffness=this.state.lastStiffness,this.viewer.viewport.centerSpringY.springStiffness=this.state.lastStiffness),this.viewer.immediateRender=!1}}}handleInteraction(t){var i;this.lastInteraction=Date.now();const e={press:()=>this.setRenderMode("animation"),drag:()=>{this.state.isPanning=!0,this.setRenderMode("animation")},"drag-end":()=>{this.state.isPanning=!1,this.scheduleStaticMode()},scroll:()=>{this.state.isZooming=!0,this.setRenderMode("animation")},pinch:()=>{this.state.isZooming=!0,this.setRenderMode("animation")}};(i=e[t])==null||i.call(e)}setRenderMode(t){var i,n;if(this.state.renderMode===t)return;const e=this.state.renderMode;this.state.renderMode=t,t==="animation"?(this.removeCanvasOptimizations(),this.disablePixelPerfect()):t==="static"&&requestAnimationFrame(()=>{this.applyCanvasOptimizations(),this.enablePixelPerfect()}),(n=(i=window.performanceConfig)==null?void 0:i.debug)!=null&&n.logPerformance&&console.log(`Render mode: ${e}  ${t}`)}scheduleStaticMode(){this.clearTimers(),this.timers.interaction=setTimeout(()=>{this.isCurrentlyAnimating()||this.setRenderMode("static")},this.config.animationEndDelay)}applyCanvasOptimizations(){var n,r;const t=Date.now();if(t-this.lastOptimizationTime<this.config.optimizationCooldown)return;const e=(n=this.viewer.drawer)==null?void 0:n.canvas,i=(r=this.viewer.drawer)==null?void 0:r.context;!e||!i||(Object.assign(e.style,{transform:"translateZ(0)",willChange:"transform",backfaceVisibility:"hidden"}),this.setContextSmoothing(i,!0),i.imageSmoothingQuality="high",this.state.canvasOptimized=!0,this.lastOptimizationTime=t)}removeCanvasOptimizations(){var e;const t=(e=this.viewer.drawer)==null?void 0:e.context;t&&(this.setContextSmoothing(t,!0),t.imageSmoothingQuality="medium",this.state.canvasOptimized=!1)}setContextSmoothing(t,e){["imageSmoothingEnabled","msImageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled"].forEach(n=>{n in t&&(t[n]=e)})}clearTimers(){Object.entries(this.timers).forEach(([t,e])=>{clearTimeout(e),delete this.timers[t]})}disablePixelPerfect(){this.applyTileStyles({imageRendering:"auto",filter:"none",transform:"translateZ(0)"})}enablePixelPerfect(){this.state.renderMode==="static"&&requestAnimationFrame(()=>{this.applyTileStyles({imageRendering:"auto",transform:"translateZ(0)",willChange:"auto",backfaceVisibility:"hidden"})})}applyTileStyles(t){this.viewer.container.querySelectorAll(".openseadragon-tile").forEach(i=>Object.assign(i.style,t))}isCurrentlyAnimating(){return this.state.isAnimating||this.state.isZooming||this.state.isPanning}getRenderMode(){return this.state.renderMode}getStatus(){return{...this.state,timeSinceInteraction:Date.now()-this.lastInteraction,zoomVelocity:this.zoomVelocity.toFixed(4),isOptimized:this.state.canvasOptimized}}updateConfig(t){Object.assign(this.config,t)}startCinematicZoom(){if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){console.log("Skipping ALL cinematic zoom optimizations on mobile"),this.state.isCinematicZoom=!1;return}this.state.isCinematicZoom=!0,this.cinematicBackup={immediateRender:this.viewer.immediateRender,maxTilesPerFrame:this.viewer.maxTilesPerFrame,smoothTileEdges:this.viewer.smoothTileEdgesMinZoom,preserveViewport:this.viewer.preserveViewport},this.viewer.immediateRender=!0,this.viewer.maxTilesPerFrame=2,this.viewer.smoothTileEdgesMinZoom=1/0,this.viewer.preserveViewport=!0,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=1),window.canvasOverlayManager&&window.canvasOverlayManager.prepareForZoom(),console.log("Cinematic zoom optimization started")}endCinematicZoom(){var t,e;this.state.isCinematicZoom&&(this.state.isCinematicZoom=!1,this.cinematicBackup&&(this.viewer.immediateRender=this.cinematicBackup.immediateRender,this.viewer.maxTilesPerFrame=this.cinematicBackup.maxTilesPerFrame,this.viewer.smoothTileEdgesMinZoom=this.cinematicBackup.smoothTileEdges,this.viewer.imageLoader&&(this.viewer.imageLoader.jobLimit=((e=(t=window.performanceConfig)==null?void 0:t.viewer)==null?void 0:e.imageLoaderLimit)||6)),this.viewer.forceRedraw(),window.canvasOverlayManager&&window.canvasOverlayManager.endZoom(),console.log("Cinematic zoom optimization ended"))}destroy(){this.clearTimers(),["animation-start","animation-finish","animation","viewport-change","canvas-press","canvas-drag","canvas-drag-end","canvas-scroll","canvas-pinch"].forEach(t=>this.viewer.removeAllHandlers(t)),this.removeCanvasOptimizations(),this.viewer=null}}function kc(s,t,e=0,i=s.length-1,n=od){for(;i>e;){if(i-e>600){const c=i-e+1,h=t-e+1,d=Math.log(c),l=.5*Math.exp(2*d/3),p=.5*Math.sqrt(d*l*(c-l)/c)*(h-c/2<0?-1:1),f=Math.max(e,Math.floor(t-h*l/c+p)),m=Math.min(i,Math.floor(t+(c-h)*l/c+p));kc(s,t,f,m,n)}const r=s[t];let o=e,a=i;for(hr(s,e,t),n(s[i],r)>0&&hr(s,e,i);o<a;){for(hr(s,o,a),o++,a--;n(s[o],r)<0;)o++;for(;n(s[a],r)>0;)a--}n(s[e],r)===0?hr(s,e,a):(a++,hr(s,a,i)),a<=t&&(e=a+1),t<=a&&(i=a-1)}}function hr(s,t,e){const i=s[t];s[t]=s[e],s[e]=i}function od(s,t){return s<t?-1:s>t?1:0}class ad{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const i=[];if(!Kr(t,e))return i;const n=this.toBBox,r=[];for(;e;){for(let o=0;o<e.children.length;o++){const a=e.children[o],c=e.leaf?n(a):a;Kr(t,c)&&(e.leaf?i.push(a):so(t,c)?this._all(a,i):r.push(a))}e=r.pop()}return i}collides(t){let e=this.data;if(!Kr(t,e))return!1;const i=[];for(;e;){for(let n=0;n<e.children.length;n++){const r=e.children[n],o=e.leaf?this.toBBox(r):r;if(Kr(t,o)){if(e.leaf||so(t,o))return!0;i.push(r)}}e=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const i=this.data;this.data=e,e=i}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=kn([]),this}remove(t,e){if(!t)return this;let i=this.data;const n=this.toBBox(t),r=[],o=[];let a,c,h;for(;i||r.length;){if(i||(i=r.pop(),c=r[r.length-1],a=o.pop(),h=!0),i.leaf){const d=ld(t,i.children,e);if(d!==-1)return i.children.splice(d,1),r.push(i),this._condense(r),this}!h&&!i.leaf&&so(i,n)?(r.push(i),o.push(a),a=0,c=i,i=i.children[0]):c?(a++,i=c.children[a],h=!1):i=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,n){const r=i-e+1;let o=this._maxEntries,a;if(r<=o)return a=kn(t.slice(e,i+1)),In(a,this.toBBox),a;n||(n=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,n-1))),a=kn([]),a.leaf=!1,a.height=n;const c=Math.ceil(r/o),h=c*Math.ceil(Math.sqrt(o));nl(t,e,i,h,this.compareMinX);for(let d=e;d<=i;d+=h){const l=Math.min(d+h-1,i);nl(t,d,l,c,this.compareMinY);for(let p=d;p<=l;p+=c){const f=Math.min(p+c-1,l);a.children.push(this._build(t,p,f,n-1))}}return In(a,this.toBBox),a}_chooseSubtree(t,e,i,n){for(;n.push(e),!(e.leaf||n.length-1===i);){let r=1/0,o=1/0,a;for(let c=0;c<e.children.length;c++){const h=e.children[c],d=ro(h),l=ud(t,h)-d;l<o?(o=l,r=d<r?d:r,a=h):l===o&&d<r&&(r=d,a=h)}e=a||e.children[0]}return e}_insert(t,e,i){const n=i?t:this.toBBox(t),r=[],o=this._chooseSubtree(n,this.data,e,r);for(o.children.push(t),dr(o,n);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(n,r,e)}_split(t,e){const i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);const o=this._chooseSplitIndex(i,r,n),a=kn(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,In(i,this.toBBox),In(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)}_splitRoot(t,e){this.data=kn([t,e]),this.data.height=t.height+1,this.data.leaf=!1,In(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let n,r=1/0,o=1/0;for(let a=e;a<=i-e;a++){const c=ur(t,0,a,this.toBBox),h=ur(t,a,i,this.toBBox),d=dd(c,h),l=ro(c)+ro(h);d<r?(r=d,n=a,o=l<o?l:o):d===r&&l<o&&(o=l,n=a)}return n||i-e}_chooseSplitAxis(t,e,i){const n=t.leaf?this.compareMinX:cd,r=t.leaf?this.compareMinY:hd,o=this._allDistMargin(t,e,i,n),a=this._allDistMargin(t,e,i,r);o<a&&t.children.sort(n)}_allDistMargin(t,e,i,n){t.children.sort(n);const r=this.toBBox,o=ur(t,0,e,r),a=ur(t,i-e,i,r);let c=Qr(o)+Qr(a);for(let h=e;h<i-e;h++){const d=t.children[h];dr(o,t.leaf?r(d):d),c+=Qr(o)}for(let h=i-e-1;h>=e;h--){const d=t.children[h];dr(a,t.leaf?r(d):d),c+=Qr(a)}return c}_adjustParentBBoxes(t,e,i){for(let n=i;n>=0;n--)dr(e[n],t)}_condense(t){for(let e=t.length-1,i;e>=0;e--)t[e].children.length===0?e>0?(i=t[e-1].children,i.splice(i.indexOf(t[e]),1)):this.clear():In(t[e],this.toBBox)}}function ld(s,t,e){if(!e)return t.indexOf(s);for(let i=0;i<t.length;i++)if(e(s,t[i]))return i;return-1}function In(s,t){ur(s,0,s.children.length,t,s)}function ur(s,t,e,i,n){n||(n=kn(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let r=t;r<e;r++){const o=s.children[r];dr(n,s.leaf?i(o):o)}return n}function dr(s,t){return s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY),s}function cd(s,t){return s.minX-t.minX}function hd(s,t){return s.minY-t.minY}function ro(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function Qr(s){return s.maxX-s.minX+(s.maxY-s.minY)}function ud(s,t){return(Math.max(t.maxX,s.maxX)-Math.min(t.minX,s.minX))*(Math.max(t.maxY,s.maxY)-Math.min(t.minY,s.minY))}function dd(s,t){const e=Math.max(s.minX,t.minX),i=Math.max(s.minY,t.minY),n=Math.min(s.maxX,t.maxX),r=Math.min(s.maxY,t.maxY);return Math.max(0,n-e)*Math.max(0,r-i)}function so(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function Kr(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function kn(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function nl(s,t,e,i,n){const r=[t,e];for(;r.length;){if(e=r.pop(),t=r.pop(),e-t<=i)continue;const o=t+Math.ceil((e-t)/i/2)*i;kc(s,o,t,e,n),r.push(t,o,o,e)}}class pd{constructor(){this.tree=new ad(9),this.hotspots=new Map,this.queryCache=new Map,this.cacheSize=50,this.lastCacheClear=Date.now()}loadHotspots(t){const e=performance.now();this.tree.clear(),this.hotspots.clear(),this.queryCache.clear();const i=[];t.forEach(r=>{const o=this.calculateBoundingBox(r.coordinates);this.hotspots.set(r.id,{...r,bbox:o}),i.push({minX:o.minX,minY:o.minY,maxX:o.maxX,maxY:o.maxY,id:r.id})}),this.tree.load(i);const n=performance.now()-e;console.log(`Spatial index built in ${n.toFixed(2)}ms for ${i.length} hotspots`)}queryViewport(t,e=1){const i=`${t.minX.toFixed(2)},${t.minY.toFixed(2)},${t.maxX.toFixed(2)},${t.maxY.toFixed(2)},${e.toFixed(2)}`;if(this.queryCache.has(i))return this.queryCache.get(i);Date.now()-this.lastCacheClear>1e3&&(this.queryCache.clear(),this.lastCacheClear=Date.now());const r=this.tree.search({minX:t.minX,minY:t.minY,maxX:t.maxX,maxY:t.maxY}).map(o=>this.hotspots.get(o.id));return this.queryCache.size<this.cacheSize&&this.queryCache.set(i,r),r}getHotspotAtPoint(t,e){const i=this.tree.search({minX:t,minY:e,maxX:t,maxY:e});for(const n of i){const r=this.hotspots.get(n.id);if(this.isPointInHotspot(t,e,r))return r}return null}calculateBoundingBox(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{for(const c of a)e=Math.min(e,c[0]),i=Math.min(i,c[1]),n=Math.max(n,c[0]),r=Math.max(r,c[1])};if(t.length>0&&typeof t[0][0]=="number")o(t);else for(const a of t)o(a);return{minX:e,minY:i,maxX:n,maxY:r}}isPointInHotspot(t,e,i){return i.shape==="polygon"?this.pointInPolygon(t,e,i.coordinates):i.shape==="multipolygon"?i.coordinates.some(n=>this.pointInPolygon(t,e,n)):!1}pointInPolygon(t,e,i){let n=!1;const r=i.length;let o=i[0][0],a=i[0][1];for(let c=1;c<=r;c++){const h=i[c%r][0],d=i[c%r][1];if(e>Math.min(a,d)&&e<=Math.max(a,d)&&t<=Math.max(o,h)&&a!==d){const l=(e-a)*(h-o)/(d-a)+o;(o===h||t<=l)&&(n=!n)}o=h,a=d}return n}getAllHotspots(){return Array.from(this.hotspots.values())}clear(){this.tree.clear(),this.hotspots.clear(),this.queryCache.clear()}}class fd{constructor(t){this.viewer=t,this.state={isActive:!1,lastCleanup:Date.now(),lastDeepCleanup:Date.now(),cleanupCount:0,tilesRemoved:0,currentPressure:"normal"},this.config={normalCleanupInterval:3e4,elevatedCleanupInterval:15e3,highCleanupInterval:5e3,criticalCleanupInterval:1e3,deepCleanupInterval:6e4,maxTileAge:{normal:6e4,elevated:3e4,high:15e3,critical:5e3},cacheThresholds:{normal:400,elevated:200,high:100,critical:50},keepDistance:{normal:2,elevated:1.5,high:1.2,critical:1},fpsThresholds:{good:55,acceptable:40,poor:25,critical:15}},this.intervals={},this.tileAccessTimes=new Map,this.metrics={totalCleaned:0,lastCleanupDuration:0,averageCleanupTime:0,cleanupRuns:0},this.handleTileLoaded=this.handleTileLoaded.bind(this),this.handleViewportChange=this.handleViewportChange.bind(this)}start(){this.state.isActive||(this.state.isActive=!0,this.viewer.addHandler("tile-loaded",this.handleTileLoaded),this.viewer.addHandler("viewport-change",this.handleViewportChange),this.updateCleanupInterval(),this.intervals.deepCleanup=setInterval(()=>this.performDeepCleanup(),this.config.deepCleanupInterval),this.intervals.monitor=setInterval(()=>this.monitorPerformance(),2e3),console.log("TileCleanupManager started"))}stop(){this.state.isActive=!1,this.viewer.removeHandler("tile-loaded",this.handleTileLoaded),this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.tileAccessTimes.clear(),console.log("TileCleanupManager stopped")}handleTileLoaded(t){if(!t.tile)return;const e=this.getTileKey(t.tile);this.tileAccessTimes.set(e,Date.now())}handleViewportChange(){var i;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0);if(!t||!t._tilesToDraw)return;const e=Date.now();t._tilesToDraw.forEach(n=>{const r=this.getTileKey(n);this.tileAccessTimes.set(r,e)})}getTileKey(t){return`${t.level}_${t.x}_${t.y}`}monitorPerformance(){var i,n;const t=((n=(i=window.performanceMonitor)==null?void 0:i.getMetrics())==null?void 0:n.averageFPS)||60,e=this.state.currentPressure;t<this.config.fpsThresholds.critical?this.state.currentPressure="critical":t<this.config.fpsThresholds.poor?this.state.currentPressure="high":t<this.config.fpsThresholds.acceptable?this.state.currentPressure="elevated":this.state.currentPressure="normal",e!==this.state.currentPressure&&(console.log(`Tile cleanup pressure changed: ${e}  ${this.state.currentPressure} (FPS: ${t})`),this.updateCleanupInterval(),this.state.currentPressure==="critical"&&this.performCleanup())}updateCleanupInterval(){this.intervals.cleanup&&clearInterval(this.intervals.cleanup);const e={normal:this.config.normalCleanupInterval,elevated:this.config.elevatedCleanupInterval,high:this.config.highCleanupInterval,critical:this.config.criticalCleanupInterval}[this.state.currentPressure];this.intervals.cleanup=setInterval(()=>this.performCleanup(),e)}performCleanup(){var F;if(!this.state.isActive)return;if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&!(this.viewer.viewport.getZoom()===this.viewer.viewport.zoomSpring.target.value&&this.viewer.viewport.getCenter().equals(this.viewer.viewport.centerSpringX.target.value))){console.log("Skipping tile cleanup on mobile - viewport changing");return}const e=performance.now(),i=(F=this.viewer.world)==null?void 0:F.getItemAt(0);if(!i||!i._tileCache||this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value)return;const r=this.state.currentPressure,o=this.config.maxTileAge[r],a=this.config.cacheThresholds[r],c=this.config.keepDistance[r],h=Date.now(),l=this.viewer.viewport.getBounds(),p={x:l.x-l.width*(c-1)/2,y:l.y-l.height*(c-1)/2,width:l.width*c,height:l.height*c},m=i._tileCache._tilesLoaded||[],v=m.length;if(v===0)return;const w=new Set;i._tilesToDraw&&i._tilesToDraw.forEach(H=>{const q=this.getTileKey(H);w.add(q)});const T=[];if(m.forEach(H=>{const q=this.getTileKey(H);if(w.has(q))return;const J=this.tileAccessTimes.get(q)||0,D=h-J;let E=!1;if(D>o&&(E=!0),!E&&r!=="normal"){const S=H.bounds;S&&(!(S.x+S.width<p.x||S.x>p.x+p.width||S.y+S.height<p.y||S.y>p.y+p.height)||(E=!0))}E&&T.push(H)}),v>a){const H=v-a;if(H>T.length){const q=m.filter(D=>{const E=this.getTileKey(D);return!T.includes(D)&&!w.has(E)});q.sort((D,E)=>{const S=this.getTileKey(D),k=this.getTileKey(E),L=this.tileAccessTimes.get(S)||0,O=this.tileAccessTimes.get(k)||0;return L-O});const J=H-T.length;T.push(...q.slice(0,J))}}T.length>0&&(T.forEach(H=>{const q=this.getTileKey(H);this.tileAccessTimes.delete(q),H.unload&&H.unload()}),this.state.tilesRemoved+=T.length,this.metrics.totalCleaned+=T.length,console.log(`Cleaned ${T.length} tiles (pressure: ${r}, cache was: ${v}, kept ${w.size} visible)`));const A=performance.now()-e;this.metrics.lastCleanupDuration=A,this.metrics.cleanupRuns++,this.metrics.averageCleanupTime=(this.metrics.averageCleanupTime*(this.metrics.cleanupRuns-1)+A)/this.metrics.cleanupRuns,this.state.lastCleanup=h,this.state.cleanupCount++}performDeepCleanup(){if(!this.state.isActive)return;if(this.viewer.isAnimating||window.renderOptimizer&&window.renderOptimizer.isCurrentlyAnimating()||this.viewer.viewport.zoomSpring.current.value!==this.viewer.viewport.zoomSpring.target.value){console.log("Skipping deep cleanup during animation");return}console.log("Performing deep tile cleanup");const e=performance.now(),i=Date.now(),n=3e5,r=[];this.tileAccessTimes.forEach((a,c)=>{i-a>n&&r.push(c)}),r.forEach(a=>this.tileAccessTimes.delete(a)),window.gc&&(window.gc(),console.log("Forced garbage collection after deep cleanup"));const o=performance.now()-e;this.state.lastDeepCleanup=i,console.log(`Deep cleanup completed in ${o.toFixed(2)}ms, cleared ${r.length} old tracking entries`)}forceCleanup(){console.log("Forcing immediate tile cleanup"),this.performCleanup()}getMetrics(){var i,n,r;const t=(i=this.viewer.world)==null?void 0:i.getItemAt(0),e=((r=(n=t==null?void 0:t._tileCache)==null?void 0:n._tilesLoaded)==null?void 0:r.length)||0;return{...this.metrics,currentCacheSize:e,pressure:this.state.currentPressure,cleanupCount:this.state.cleanupCount,tilesRemoved:this.state.tilesRemoved,trackingSize:this.tileAccessTimes.size,cacheThreshold:this.config.cacheThresholds[this.state.currentPressure]}}setPressure(t){["normal","elevated","high","critical"].includes(t)&&(this.state.currentPressure=t,this.updateCleanupInterval())}pauseCleanup(t=1e3){this.intervals.cleanup&&(clearInterval(this.intervals.cleanup),setTimeout(()=>{this.state.isActive&&this.updateCleanupInterval()},t))}destroy(){this.stop(),this.viewer=null,this.tileAccessTimes.clear()}}class md{constructor(t){this.viewer=t,this.worker=null,this.isInitialized=!1,this.state={pendingRequests:new Map,requestId:0,workerReady:!1,capabilities:null,lastError:null},this.config={workerPath:"/tile-worker.js",maxRetries:3,retryDelay:1e3,requestTimeout:1e4,maxCacheSize:200,enableOffscreenCanvas:!0},this.metrics={requestsSent:0,requestsCompleted:0,requestsFailed:0,cacheHits:0,averageProcessTime:0,totalProcessTime:0},this.handleWorkerMessage=this.handleWorkerMessage.bind(this),this.handleWorkerError=this.handleWorkerError.bind(this)}async initialize(){if(!this.isInitialized)try{if(typeof Worker>"u")throw new Error("Web Workers not supported");this.worker=new Worker(this.config.workerPath),this.worker.onmessage=this.handleWorkerMessage,this.worker.onerror=this.handleWorkerError,await this.waitForWorkerReady(),await this.sendToWorker("init",{config:{maxCacheSize:this.config.maxCacheSize}}),this.isInitialized=!0,console.log("TileWorkerManager initialized with capabilities:",this.state.capabilities)}catch(t){throw console.error("Failed to initialize TileWorkerManager:",t),this.state.lastError=t,t}}async processTile(t,e=2){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Tile processing timeout"))},this.config.requestTimeout);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tile:t}),this.worker.postMessage({type:"process-tile",requestId:i,data:{tile:this.serializeTile(t),priority:e}}),this.metrics.requestsSent++})}async processBatch(t,e=[]){this.isInitialized||await this.initialize();const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),this.metrics.requestsFailed++,r(new Error("Batch processing timeout"))},this.config.requestTimeout*t.length);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o,startTime:performance.now(),tiles:t}),this.worker.postMessage({type:"batch-process",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),priorities:e}}),this.metrics.requestsSent++})}async prioritizeTiles(t,e){if(this.isInitialized||await this.initialize(),t.length>100){console.log("TileWorkerManager: Too many tiles, using simple priority");const n=t.map(r=>{const o=(r.bounds.minX+r.bounds.maxX)/2,a=(r.bounds.minY+r.bounds.maxY)/2,c=(e.bounds.minX+e.bounds.maxX)/2,h=(e.bounds.minY+e.bounds.maxY)/2,d=Math.sqrt(Math.pow(o-c,2)+Math.pow(a-h,2));return d<.5?0:d<1?1:2});return{tiles:t,priorities:n}}const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),n({tiles:t,priorities:t.map(()=>1)})},50);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:"prioritize",requestId:i,data:{tiles:t.map(a=>this.serializeTile(a)),viewport:{bounds:e.bounds,zoom:e.zoom}}})})}clearCache(t=!1,e=null){this.worker&&this.worker.postMessage({type:"clear-cache",data:{selective:t,maxAge:e}})}async getStats(){if(!this.isInitialized)return this.metrics;const t=this.generateRequestId();return new Promise(e=>{const i=setTimeout(()=>{this.state.pendingRequests.delete(t),e(this.metrics)},1e3);this.state.pendingRequests.set(t,{resolve:e,reject:()=>{},timeout:i}),this.worker.postMessage({type:"get-stats",requestId:t})})}handleWorkerMessage(t){const{type:e,requestId:i,data:n}=t.data;switch(e){case"ready":this.state.workerReady=!0;break;case"initialized":this.state.capabilities=n.capabilities,this.handleRequestComplete(i,n);break;case"tile-ready":this.handleTileReady(i,n);break;case"tile-error":this.handleTileError(i,n);break;case"batch-complete":this.handleRequestComplete(i,n);break;case"priorities-calculated":this.handleRequestComplete(i,n);break;case"stats":this.handleStatsReceived(i,n);break;case"cache-cleared":console.log("Worker cache cleared:",n);break;default:console.warn("Unknown worker message type:",e)}}handleWorkerError(t){console.error("Worker error:",t),this.state.lastError=t,this.state.pendingRequests.forEach((e,i)=>{clearTimeout(e.timeout),e.reject(t)}),this.state.pendingRequests.clear(),this.isInitialized=!1,setTimeout(()=>this.initialize(),this.config.retryDelay)}handleTileReady(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n=performance.now()-i.startTime;this.updateMetrics(n,e.cached),i.resolve({...e,processingTime:n})}handleTileError(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),this.metrics.requestsFailed++,i.reject(new Error(e.error)))}handleRequestComplete(t,e){const i=this.state.pendingRequests.get(t);i&&(clearTimeout(i.timeout),this.state.pendingRequests.delete(t),i.resolve(e))}handleStatsReceived(t,e){const i=this.state.pendingRequests.get(t);if(!i)return;clearTimeout(i.timeout),this.state.pendingRequests.delete(t);const n={...this.metrics,worker:e};i.resolve(n)}updateMetrics(t,e){this.metrics.requestsCompleted++,e&&this.metrics.cacheHits++,this.metrics.totalProcessTime+=t,this.metrics.averageProcessTime=this.metrics.totalProcessTime/this.metrics.requestsCompleted}serializeTile(t){return{level:t.level,x:t.x,y:t.y,bounds:t.bounds?{minX:t.bounds.x||t.bounds.minX,minY:t.bounds.y||t.bounds.minY,maxX:(t.bounds.x||t.bounds.minX)+(t.bounds.width||0),maxY:(t.bounds.y||t.bounds.minY)+(t.bounds.height||0)}:null,url:t.url||null}}generateRequestId(){return++this.state.requestId}async waitForWorkerReady(){return new Promise(t=>{if(this.state.workerReady){t();return}const e=setInterval(()=>{this.state.workerReady&&(clearInterval(e),t())},100);setTimeout(()=>{clearInterval(e),t()},5e3)})}async sendToWorker(t,e){const i=this.generateRequestId();return new Promise((n,r)=>{const o=setTimeout(()=>{this.state.pendingRequests.delete(i),r(new Error(`Worker request timeout: ${t}`))},5e3);this.state.pendingRequests.set(i,{resolve:n,reject:r,timeout:o}),this.worker.postMessage({type:t,requestId:i,data:e})})}destroy(){this.worker&&(this.state.pendingRequests.forEach(t=>{clearTimeout(t.timeout),t.reject(new Error("Worker destroyed"))}),this.state.pendingRequests.clear(),this.worker.terminate(),this.worker=null),this.isInitialized=!1,this.viewer=null}}class gd{constructor(t){this.viewer=t,this.state={isActive:!1,tileQueue:[],loadingTiles:new Set,tilePriorities:new Map,loadTimes:[],averageLoadTime:0,lastCleanup:Date.now(),useWorker:!0,workerReady:!1},this.config={predictiveRadius:1.5,priorityLevels:5,maxConcurrentLoads:6,cleanupInterval:3e4,tileTimeout:1e4,maxLoadTimeHistory:50,adaptiveLoading:!0,webpSupport:this.detectWebPSupport(),workerBatchSize:10,workerEnabled:!0},this.intervals={},this.workerManager=null,this.config.workerEnabled&&this.initializeWorker(),this.workerMetrics={tilesProcessedByWorker:0,workerProcessingTime:0,workerErrors:0},this.handleViewportChange=this.handleViewportChange.bind(this)}async initializeWorker(){try{this.workerManager=new md(this.viewer),await this.workerManager.initialize(),this.state.workerReady=!0,console.log("TileOptimizer: Web Worker initialized successfully")}catch(t){console.warn("TileOptimizer: Failed to initialize Web Worker, falling back to main thread",t),this.state.useWorker=!1,this.state.workerReady=!1}}start(){this.state.isActive||(this.state.isActive=!0,setTimeout(()=>{this.viewer.addHandler("viewport-change",this.handleViewportChange)},100),this.intervals.cleanup=setInterval(()=>this.performCleanup(),this.config.cleanupInterval),this.intervals.queue=setInterval(()=>this.processQueue(),50),this.intervals.worker=setInterval(()=>this.processWorkerBatch(),100),console.log("TileOptimizer started with Web Worker support:",this.state.workerReady))}stop(){this.state.isActive=!1,this.viewer.removeHandler("viewport-change",this.handleViewportChange),Object.values(this.intervals).forEach(t=>clearInterval(t)),this.intervals={},this.state.tileQueue=[],this.state.loadingTiles.clear(),this.state.tilePriorities.clear(),this.workerManager&&(this.workerManager.destroy(),this.workerManager=null),console.log("TileOptimizer stopped")}handleViewportChange(){this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||(this.predictiveLoad(),this.state.workerReady&&this.state.tileQueue.length>0&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},{timeout:100}):setTimeout(()=>{this.viewer.isAnimating()||this.updateWorkerPriorities()},50)))}shouldSkipPredictiveLoad(){return!!(this.viewer.isAnimating()||window.renderOptimizer&&window.renderOptimizer.state.isCinematicZoom||this.state.tileQueue.length>100)}async updateWorkerPriorities(){try{const t=this.viewer.viewport,e=t.getBounds(),i={bounds:{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height},zoom:t.getZoom()},n=this.state.tileQueue.slice(0,50),r=await this.workerManager.prioritizeTiles(n,i);r.tiles&&r.priorities&&(r.tiles.forEach((o,a)=>{const c=r.priorities[a],h=this.state.tileQueue.find(d=>d.level===o.level&&d.x===o.x&&d.y===o.y);h&&(h.priority=c)}),this.sortQueue())}catch(t){console.warn("Failed to update worker priorities:",t)}}calculateTilePriority(t,e,i){const n=this.viewer.viewport,r=n.getBounds(),o=n.getCenter(),a=n.getZoom();if(a<2&&this.viewer.source.getTileWidth(t)*a<32)return 999;const c=this.viewer.source.getTileWidth(t),h=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):c,d=(e+.5)*c/this.viewer.source.width,l=(i+.5)*h/this.viewer.source.height,p=Math.sqrt(Math.pow(d-o.x,2)+Math.pow(l-o.y,2)),f={left:e*c/this.viewer.source.width,top:i*h/this.viewer.source.height,right:(e+1)*c/this.viewer.source.width,bottom:(i+1)*h/this.viewer.source.height};return f.right<r.x||f.left>r.x+r.width||f.bottom<r.y||f.top>r.y+r.height?p<r.width*this.config.predictiveRadius?1:2:a<3?Math.abs(d-o.x)+Math.abs(l-o.y)<.2?0:1:0}enqueueTile(t,e,i,n){const r=`${t}_${e}_${i}`;if(this.state.loadingTiles.has(r))return;const o=this.state.tileQueue.findIndex(c=>c.key===r);if(o>=0){n<this.state.tileQueue[o].priority&&(this.state.tileQueue[o].priority=n,this.sortQueue());return}const a={level:t,x:e,y:i,key:r,priority:n,timestamp:Date.now(),bounds:this.calculateTileBounds(t,e,i)};this.state.tileQueue.push(a),this.sortQueue()}calculateTileBounds(t,e,i){const n=this.viewer.source.getTileWidth(t),r=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(t):n,o=this.viewer.source.width,a=this.viewer.source.height;return{minX:e*n/o,minY:i*r/a,maxX:(e+1)*n/o,maxY:(i+1)*r/a}}async processWorkerBatch(){if(!this.state.isActive||!this.state.workerReady||this.state.tileQueue.length===0)return;const t=this.state.tileQueue.filter(e=>e.priority<=1).slice(0,this.config.workerBatchSize);if(t.length!==0)try{const e=t.map(r=>r.priority),i=performance.now();await this.workerManager.processBatch(t,e);const n=performance.now()-i;this.workerMetrics.tilesProcessedByWorker+=t.length,this.workerMetrics.workerProcessingTime+=n,t.forEach(r=>{const o=this.state.tileQueue.findIndex(a=>a.key===r.key);o>=0&&this.state.tileQueue.splice(o,1)})}catch(e){console.error("Worker batch processing failed:",e),this.workerMetrics.workerErrors++}}processQueue(){var e;if(!(!this.state.isActive||this.state.tileQueue.length===0||this.state.loadingTiles.size>=this.config.maxConcurrentLoads||!((e=this.viewer.world)!=null&&e.getItemAt(0))))for(;this.state.loadingTiles.size<this.config.maxConcurrentLoads&&this.state.tileQueue.length>0;){const i=this.state.tileQueue.shift();Date.now()-i.timestamp>this.config.tileTimeout||(this.state.loadingTiles.add(i.key),this.viewer.forceRedraw())}}sortQueue(){this.state.tileQueue.sort((t,e)=>t.priority!==e.priority?t.priority-e.priority:t.timestamp-e.timestamp)}predictiveLoad(){var p;if(this.shouldSkipPredictiveLoad()||!((p=this.viewer.world)==null?void 0:p.getItemAt(0))||!this.viewer.source)return;const e=this.viewer.viewport,i=e.getBounds(),n={x:i.x-i.width*(this.config.predictiveRadius-1)/2,y:i.y-i.height*(this.config.predictiveRadius-1)/2,width:i.width*this.config.predictiveRadius,height:i.height*this.config.predictiveRadius},r=e.getZoom(),o=Math.max(0,Math.min(Math.floor(Math.log2(r)),this.viewer.source.maxLevel||14)),a=this.viewer.source.getTileWidth(o),c=this.viewer.source.getTileHeight?this.viewer.source.getTileHeight(o):a,h=this.viewer.source.width,d=this.viewer.source.height,l={startX:Math.max(0,Math.floor(n.x*h/a)),endX:Math.min(Math.ceil(h/a)-1,Math.ceil((n.x+n.width)*h/a)),startY:Math.max(0,Math.floor(n.y*d/c)),endY:Math.min(Math.ceil(d/c)-1,Math.ceil((n.y+n.height)*d/c))};for(let f=l.startX;f<=l.endX;f++)for(let m=l.startY;m<=l.endY;m++){const v=this.calculateTilePriority(o,f,m);this.enqueueTile(o,f,m,v)}}trackLoadTime(t){this.state.loadTimes.push(t),this.state.loadTimes.length>this.config.maxLoadTimeHistory&&this.state.loadTimes.shift(),this.state.averageLoadTime=this.state.loadTimes.reduce((e,i)=>e+i,0)/this.state.loadTimes.length,this.adjustLoadingStrategy()}removeTileFromLoading(t){this.state.loadingTiles.delete(t)}get loadingTiles(){return this.state.loadingTiles}adjustLoadingStrategy(){const t=this.state.averageLoadTime,e=this.config.maxConcurrentLoads;t>500&&e>2?(this.config.maxConcurrentLoads--,console.log(`Reduced concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`)):t<200&&e<8&&(this.config.maxConcurrentLoads++,console.log(`Increased concurrent loads to ${this.config.maxConcurrentLoads} (avg: ${t.toFixed(0)}ms)`))}performCleanup(){const t=Date.now();this.state.tileQueue=this.state.tileQueue.filter(e=>t-e.timestamp<this.config.tileTimeout),this.state.loadingTiles.clear(),this.state.lastCleanup=t,this.workerManager&&this.workerManager.clearCache(!0,6e4)}clearOldTiles(){this.performCleanup(),window.gc&&window.gc()}detectWebPSupport(){const t=document.createElement("canvas");t.width=t.height=1;const e=t.getContext("2d");e.fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,1,1);try{return t.toDataURL("image/webp").indexOf("image/webp")===5}catch{return!1}}async getStats(){const t=this.workerManager?await this.workerManager.getStats():null;return{queueLength:this.state.tileQueue.length,loadingCount:this.state.loadingTiles.size,averageLoadTime:this.state.averageLoadTime.toFixed(0)+"ms",maxConcurrentLoads:this.config.maxConcurrentLoads,webpSupported:this.config.webpSupport,workerEnabled:this.state.workerReady,workerMetrics:{...this.workerMetrics,averageWorkerTime:this.workerMetrics.tilesProcessedByWorker>0?(this.workerMetrics.workerProcessingTime/this.workerMetrics.tilesProcessedByWorker).toFixed(2)+"ms":"0ms"},workerStats:t}}}let Jr=new Map,$r=null,oo=null;function vd(s){if(console.log("=== APPLYING OPTIMIZED TILE CASCADE FIX ==="),/Android|iPhone|iPad/i.test(navigator.userAgent)){console.log("TileCascadeFix disabled on mobile for testing");return}if(!s){console.error("OpenSeadragon not provided - cannot apply tile cascade fix");return}const e=s.TiledImage.prototype._getLevelsInterval,i=s.TiledImage.prototype._updateLevels;if(!e){console.error("_getLevelsInterval method not found - cannot apply fix");return}s.TiledImage.prototype._getLevelsInterval=function(){const n=this.viewer.viewport.getZoom();if($r!==null&&Math.abs(n-$r)<.01&&Jr.has(this))return Jr.get(this);const r=e.call(this);if(!r||typeof r.lowestLevel>"u")return r;let o=r;if(n<3){const a=/Android|iPhone|iPad/i.test(navigator.userAgent),c=Math.floor(Math.log2(n*1024/256)),h=Math.max(8,Math.min(12,c+11)),d=a?4:3;o={lowestLevel:Math.max(8,h-Math.floor(d/2)),highestLevel:Math.min(14,h+Math.floor(d/2))},o.highestLevel-o.lowestLevel>d-1&&(o.lowestLevel=o.highestLevel-(d-1))}return Jr.set(this,o),$r=n,oo&&clearTimeout(oo),oo=setTimeout(()=>{Jr.clear(),$r=null},100),o},i&&(s.TiledImage.prototype._updateLevels=function(){if(this.viewer.isAnimating())return;const n=i.call(this);if(this.viewer.viewport.getZoom()<3&&this._tilesToDraw){const o=this._getLevelsInterval();this._tilesToDraw=this._tilesToDraw.filter(a=>a.level>=o.lowestLevel&&a.level<=o.highestLevel)}return n}),console.log("=== OPTIMIZED TILE CASCADE FIX APPLIED ===")}class yd{constructor(t){this.viewer=t,this.cacheEnabled=!0,this.cacheTimeout=50,this.lastUpdate=0,this.cachedViewport=null,this.viewportPadding=.2,this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0},this.boundUpdate=this.update.bind(this)}getCurrentViewport(){const t=performance.now();return this.cacheEnabled&&this.cachedViewport&&t-this.lastUpdate<this.cacheTimeout?(this.metrics.cacheHits++,this.cachedViewport):(this.metrics.cacheMisses++,this.update())}update(){const t=performance.now(),e=this.viewer.viewport,i=e.getBounds(),n=e.viewportToImageCoordinates(i.getTopLeft()),r=e.viewportToImageCoordinates(i.getBottomRight()),o=r.x-n.x,a=r.y-n.y,c=o*this.viewportPadding,h=a*this.viewportPadding,d=this.viewer.world.getItemAt(0),l=d?d.getContentSize():{x:1,y:1},f={bounds:{minX:Math.max(0,n.x-c),minY:Math.max(0,n.y-h),maxX:Math.min(l.x,r.x+c),maxY:Math.min(l.y,r.y+h)},zoom:e.getZoom(!0),center:e.getCenter(!0),rotation:e.getRotation(),containerSize:e.getContainerSize(),imageBounds:{minX:n.x,minY:n.y,maxX:r.x,maxY:r.y},pixelRatio:this.calculatePixelRatio(),levelOfDetail:this.getLevelOfDetail()};this.cachedViewport=f,this.lastUpdate=performance.now();const m=this.lastUpdate-t;return this.metrics.lastUpdateDuration=m,this.metrics.totalUpdates++,this.metrics.averageUpdateTime=(this.metrics.averageUpdateTime*(this.metrics.totalUpdates-1)+m)/this.metrics.totalUpdates,f}isPointInViewport(t,e,i=!1){const n=this.getCurrentViewport(),r=i?n.bounds:n.imageBounds;return t>=r.minX&&t<=r.maxX&&e>=r.minY&&e<=r.maxY}isBoxInViewport(t,e,i,n,r=!0){const o=this.getCurrentViewport(),a=r?o.bounds:o.imageBounds;return!(i<a.minX||t>a.maxX||n<a.minY||e>a.maxY)}imageToPixel(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new et.Point(t,e));return this.viewer.viewport.pixelFromPoint(i)}pixelToImage(t,e){const i=this.viewer.viewport.pointFromPixel(new et.Point(t,e));return this.viewer.viewport.viewportToImageCoordinates(i)}calculatePixelRatio(){const t=this.viewer.viewport,e=t.getContainerSize(),i=t.getBounds(),n=this.viewer.world.getItemAt(0);if(!n)return 1;const r=n.getContentSize(),o=i.width*r.x;return e.x/o}getLevelOfDetail(){const t=this.viewer.viewport.getZoom(!0),e=this.viewer.viewport.getMaxZoom(),i=t/e;return i<.1?0:i<.3?1:i<.6?2:3}shouldRenderHighQuality(){return this.getLevelOfDetail()>=2}getViewportCoverage(){const t=this.getCurrentViewport(),e=this.viewer.world.getItemAt(0);if(!e)return 1;const i=e.getContentSize(),n=(t.imageBounds.maxX-t.imageBounds.minX)*(t.imageBounds.maxY-t.imageBounds.minY),r=i.x*i.y;return n/r}getMetrics(){const t=this.metrics.cacheHits+this.metrics.cacheMisses>0?this.metrics.cacheHits/(this.metrics.cacheHits+this.metrics.cacheMisses)*100:0;return{...this.metrics,cacheEfficiency:t.toFixed(1)+"%",currentZoom:this.viewer.viewport.getZoom(!0).toFixed(2),viewportCoverage:(this.getViewportCoverage()*100).toFixed(1)+"%"}}resetMetrics(){this.metrics={cacheHits:0,cacheMisses:0,lastUpdateDuration:0,totalUpdates:0,averageUpdateTime:0}}getVisibleImageArea(){const t=this.getCurrentViewport();return{x:t.imageBounds.minX,y:t.imageBounds.minY,width:t.imageBounds.maxX-t.imageBounds.minX,height:t.imageBounds.maxY-t.imageBounds.minY}}setCacheEnabled(t){this.cacheEnabled=t,t||(this.cachedViewport=null)}setCacheTimeout(t){this.cacheTimeout=Math.max(0,t)}setViewportPadding(t){this.viewportPadding=Math.max(0,Math.min(1,t))}destroy(){this.viewer=null,this.cachedViewport=null}}class rl{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=50,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}getCachedViewportRect(){const t=performance.now();return(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t),this.cachedViewportRect}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],c=t[(r+1)%n],h=Math.atan2(a[1]-o[1],a[0]-o[0]);let l=Math.atan2(c[1]-a[1],c[0]-a[0])-h;for(;l>Math.PI;)l-=2*Math.PI;for(;l<-Math.PI;)l+=2*Math.PI;const p=Math.sqrt(Math.pow(c[0]-a[0],2)+Math.pow(c[1]-a[1],2)),f=Math.abs(l)/(p+1e-10);e+=f,i=Math.max(i,f)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let d=0;d<e;d++){const l=t[(d+1)%e];n+=Math.sqrt(Math.pow(t[d][0]-l[0],2)+Math.pow(t[d][1]-l[1],2))}const o=n/e*3;for(let d=0;d<e;d++)for(let l=0;l<e;l++){if(d===l)continue;Math.sqrt(Math.pow(t[d][0]-t[l][0],2)+Math.pow(t[d][1]-t[l][1],2))<o&&i[d]++}const a=Math.max(...i),c=i.reduce((d,l)=>d+l,0)/e,h=i.reduce((d,l)=>d+Math.pow(l-c,2),0)/e;return{maxDensity:a,avgDensity:c,variance:h,uniformityScore:1-Math.sqrt(h)/(c+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation()):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation()))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getCachedViewportRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const r=this.calculateAdaptivePolygonExpansion(i),o=this.expandPolygon(i,r),a=[];let c=0,h=0;o.forEach(([l,p])=>{const f=this.viewer.viewport.imageToViewportCoordinates(new et.Point(l,p)),m=this.viewer.viewport.viewportToWindowCoordinates(f);c+=m.x,h+=m.y}),c/=o.length,h/=o.length;let d=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(d=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([l,p])=>{const f=this.viewer.viewport.imageToViewportCoordinates(new et.Point(l,p)),m=this.viewer.viewport.viewportToWindowCoordinates(f),v=c+(m.x-c)*d,w=h+(m.y-h)*d;a.push(`${v},${w}`)}),a.length>0)if(this.useClipPath){const l=e.width,p=e.height,f=`0,0 ${l},0 ${l},${p} 0,${p} 0,0`,m=a.slice().reverse().join(" "),v=`polygon(${f} ${m})`;this.overlayElement.style.clipPath=v,this.overlayElement.style.webkitClipPath=v}else{const l=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,f=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(l)))}`;this.overlayElement.style.mask=`url("${f}")`,this.overlayElement.style.webkitMask=`url("${f}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new et.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new et.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,c=o*this.viewer.container.clientHeight,d=Math.max(a,c)*.75;return Math.max(50,Math.min(500,d))}trackFocusReference(){if(!this.state.selectedHotspot)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.8?n=1:i<=.3?n=0:n=(i-.3)/(.8-.3);let r=1;if(this.state.selectedHotspot&&e){const o=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0],a=this.viewer.viewport.viewportToImageCoordinates(e),c={x:a.x,y:a.y};if(this.isPointInPolygon(c,o))r=1;else{const h=this.calculateDistanceToPolygon(c,o),d=this.getHotspotBounds(this.state.selectedHotspot),l=(d.width+d.height)/2,p=h/l,f=.1,m=.3;p<=f?r=1:p>=m?r=0:r=1-(p-f)/(m-f)}}return r<.1?r:Math.min(n,r)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const c=e[o][0],h=e[o][1],d=e[a][0],l=e[a][1];h>n!=l>n&&i<(d-c)*(n-h)/(l-h)+c&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const c=e.x+a*n,h=e.y+a*r;return Math.sqrt(Math.pow(t.x-c,2)+Math.pow(t.y-h,2))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t);this.calculateZunicRosinConvexity(t);const i=this.calculateDiscreteRoughness(t);let n=0;return i.maxCurvature>10&&(n=Math.max(n,.5)),(e.aspectRatio>3||e.aspectRatio<.33)&&(n=Math.max(n,.4)),1+n*.1}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const c=o-n,h=a-r;return[n+c*e,r+h*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class sl{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.85,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.25,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.zoomConfig={fadeStartZoom:2,fadeEndZoom:4,minCoverageRatio:1,enableZoomFade:!1},this.useEllipse=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0},this.tuningParams={circleMultiplier:.22,ellipseMultiplierX:1.2,ellipseMultiplierY:1.15,gradientMultiplier:1.5,pixelRadiusMultiplier:1,adaptivePaddingMultiplier:1.3,offsetX:0,offsetY:0},window.safariTuning=this.tuningParams,this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.zoomUpdateTimeout=null,this.lastUpdateTime=0,this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.lastPositionUpdate=0,this.positionUpdateThrottle=16,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=100,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[c,h]=i,d=n*(a-h)-r*(o-c)+o*h-c*a;if(Math.abs(d)<1e-10)return this.minCircleTrivial([t,e]);const l=(n*n+r*r)*(h-a)+(o*o+a*a)*(r-h)+(c*c+h*h)*(a-r),p=(n*n+r*r)*(o-c)+(o*o+a*a)*(c-n)+(c*c+h*h)*(n-o),f=-l/(2*d),m=-p/(2*d),v=n-f,w=r-m,T=Math.sqrt(v*v+w*w);return{x:f,y:m,r:T}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonArea(t),r=i.width*i.height,o=n/r,a=this.calculateConvexHull(t),c=this.calculatePolygonArea(a),h=n/c;let d=1;return h<.6?d=1.4:o<.7?d=1.3:d=1.2,this.isMobile&&(d*=.8),e*d*this.tuningParams.adaptivePaddingMultiplier}calculateEllipseFromPolygon(t){var h,d;const e=((h=this.state.selectedHotspot)==null?void 0:h.id)||`${t.length}_${JSON.stringify(t.slice(0,3))}`;if(this.ellipseCache.has(e)){const l=this.ellipseCache.get(e);return this.useEllipse=l.useEllipse,l.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=i.width/i.height,r=(Math.max(i.width,i.height)-Math.min(i.width,i.height))/(i.width+i.height);let o=!1;if(n<=1.5&&r<=.3?o=!1:n>2||r>.5?o=!0:o=Math.abs(i.width-i.height)/Math.max(i.width,i.height)>.3,console.log("Shape decision:",{hotspotId:(d=this.state.selectedHotspot)==null?void 0:d.id,aspectRatio:n.toFixed(2),elongationIndex:r.toFixed(2),useEllipse:o}),!o)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const a=1.2,c={radiusX:i.width/2*a*this.tuningParams.ellipseMultiplierX,radiusY:i.height/2*a*this.tuningParams.ellipseMultiplierY,rotation:0,aspectRatio:n,centerX:i.centerX,centerY:i.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:c}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.ellipseCache.clear()},5e3),c}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],c=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const h=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);c*h<0&&e++}}return Math.min(e/(i*.5),1)}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),c=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-c}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],c=i[r];if((a[0]-o[0])*(c[1]-o[1])-(a[1]-o[1])*(c[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height,o=this.calculateElongationIndex(n);return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,elongationIndex:o,vertexDensity:t.length/i}}calculateElongationIndex(t){const e=Math.max(t.width,t.height),i=Math.min(t.width,t.height);return(e-i)/(e+i)}calculateZoomAwareOpacity(t){if(!this.viewer||!this.zoomConfig.enableZoomFade)return t;const e=this.viewer.viewport.getZoom();if(e<=this.zoomConfig.fadeStartZoom)return t;if(e>=this.zoomConfig.fadeEndZoom)return 0;const i=this.zoomConfig.fadeEndZoom-this.zoomConfig.fadeStartZoom,n=(e-this.zoomConfig.fadeStartZoom)/i,r=1-Math.pow(1-n,2);return t*(1-r)}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement)),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}applyInitialStyles(){const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"block",visibility:"hidden","-webkit-mask-image":this.createGradientMask(50,50,0,0),"mask-image":this.createGradientMask(50,50,0,0),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const l=o.radiusX*n*this.tuningParams.ellipseMultiplierX,p=o.radiusY*n*this.tuningParams.ellipseMultiplierY,m=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(v=>{const w=l*v.position,T=p*v.position,A=(w+T)/2;return`rgba(0,0,0,${v.opacity}) ${A*this.tuningParams.gradientMultiplier}px`}).join(", ");return`radial-gradient(ellipse ${l*this.tuningParams.gradientMultiplier}px ${p*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%, 
        rgba(0,0,0,0) 0px,
        ${m})`}const c=i*n*this.tuningParams.circleMultiplier,d=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(l=>{const p=c+c*this.tuningParams.gradientMultiplier*.8*l.position;return`rgba(0,0,0,${l.opacity}) ${p}px`}).join(", ");return`radial-gradient(circle ${c*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%,
    rgba(0,0,0,0) 0px,
    rgba(0,0,0,0) ${c}px,
    ${d})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&(this.cachedViewportRect=null,this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.zoomUpdateTimeout=setTimeout(()=>{this.checkAutoDeselect()},100))}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&!this.animationFrame&&this.startAnimation()}),this.resizeHandler=()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()},window.addEventListener("resize",this.resizeHandler)}selectHotspot(t){var e,i;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(e=this.state.selectedHotspot)==null?void 0:e.id}),((i=this.state.selectedHotspot)==null?void 0:i.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.overlayElement&&(this.overlayElement.style.display="block",this.overlayElement.style.visibility="visible"),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,setTimeout(()=>{this.trackFocusReference()},800),console.log("Starting animation..."),this.startAnimation()):(console.log("Deselecting hotspot"),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation())}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;if(this.isUpdatingPosition){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,requestAnimationFrame(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()}));return}const t=performance.now();if(t-this.lastPositionUpdate<this.positionUpdateThrottle){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,setTimeout(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()},this.positionUpdateThrottle-(t-this.lastPositionUpdate)));return}this.isUpdatingPosition=!0,this.lastPositionUpdate=t;try{const e=this.state.selectedHotspot,i=this.getPerformanceMode();let n="full",r;if(i==="reduced"){const w=e.shape==="polygon"?e.coordinates:e.coordinates[0],T=this.simplifyPolygon(w,.5),A={...e,coordinates:e.shape==="polygon"?T:[T]};r=this.calculateSpotlightGeometry(A),n="simplified"}else r=this.calculateSpotlightGeometry(e);(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t);const o=this.cachedViewportRect,a=this.viewer.viewport.imageToViewportCoordinates(new et.Point(r.center.x,r.center.y)),c=this.viewer.viewport.viewportToWindowCoordinates(a);console.log("Coordinate conversion debug:",{imageCenter:r.center,viewportPoint:{x:a.x,y:a.y},windowPoint:{x:c.x,y:c.y},viewerSize:{width:this.viewer.container.clientWidth,height:this.viewer.container.clientHeight}});const h=c.x/o.width*100+this.tuningParams.offsetX,d=c.y/o.height*100+this.tuningParams.offsetY;this.state.targetPosition={x:h,y:d};const l=this.viewer.world.getItemAt(0).getContentSize(),p=r.radius/l.x,f=this.viewer.viewport.getZoom(),m=p*o.width*f,v=this.getHotspotBounds(e);if(v){const w=v.width/l.x*o.width*f,T=v.height/l.y*o.height*f,F=Math.max(w,T)/2*this.zoomConfig.minCoverageRatio;this.state.targetRadius=Math.max(F,m*this.tuningParams.pixelRadiusMultiplier)}else this.state.targetRadius=Math.max(80,Math.min(400,m*this.tuningParams.pixelRadiusMultiplier));if(console.log("Zoom-aware radius:",{currentZoom:f.toFixed(2),targetRadius:this.state.targetRadius.toFixed(0),willFade:f>this.zoomConfig.fadeStartZoom}),r.ellipseData){const w=r.ellipseData.radiusX/l.x*o.width*f,T=r.ellipseData.radiusY/l.y*o.height*f;this.useEllipse||(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:r.ellipseData.rotation}),this.ellipseData.targetRadiusX=w,this.ellipseData.targetRadiusY=T,this.ellipseData.rotation=r.ellipseData.rotation,this.useEllipse=!0}else this.useEllipse&&(this.ellipseData.targetRadiusX=this.state.targetRadius,this.ellipseData.targetRadiusY=this.state.targetRadius),this.useEllipse=!1;console.log("Spotlight position debug:",{hotspotId:e.id,hotspotCenter:r.center,windowPoint:c,viewportRect:{width:o.width,height:o.height},percentages:{x:h,y:d},radius:{geometric:r.radius,inViewport:p,inPixels:m,final:this.state.targetRadius},currentState:{x:this.state.currentPosition.x,y:this.state.currentPosition.y,radius:this.state.currentRadius},ellipseData:this.ellipseData,useEllipse:this.useEllipse,geometryQuality:n}),this.aspectRatio=r.aspectRatio,this.state.isAnimating?this.animationFrame||this.startAnimation():(this.state.currentPosition={...this.state.targetPosition},this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0&&(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY),this.applySpotlightStyles())}finally{this.isUpdatingPosition=!1}}invalidateViewportCache(){this.cachedViewportRect=null,this.viewportRectCacheTime=0}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateEllipseFromPolygon(e);if(n&&this.useEllipse)return{center:{x:n.centerX,y:n.centerY},radius:Math.max(n.radiusX,n.radiusY),aspectRatio:n.aspectRatio,bounds:i,ellipseData:n,useEllipse:!0};{const r=this.calculateMinimumEnclosingCircle(e);r.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),r.r=Math.max(i.width,i.height)/2);const o=this.calculateAdaptivePadding(e,r.r);return{center:{x:r.x,y:r.y},radius:r.r+o,aspectRatio:i.width/i.height,bounds:i,ellipseData:null,useEllipse:!1}}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let h=0,d=o-1;h<o;d=h++){const l=e[h][0],p=e[h][1],f=e[d][0],m=e[d][1],v=l*m-f*p;i+=v,n+=(l+f)*v,r+=(p+m)*v}i*=.5;const a=n/(6*i),c=r/(6*i);if(!isFinite(a)||!isFinite(c)){let h=0,d=0;return e.forEach(([l,p])=>{h+=l,d+=p}),{x:h/e.length,y:d/e.length}}return{x:a,y:c}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||this.isUpdatingPosition)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<2e3)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return console.log("calculateFocusScore: Missing data, returning 1.0"),1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new et.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y));if(this.useEllipse&&this.ellipseData){const a=this.viewer.world.getItemAt(0).getContentSize();this.viewer.container.getBoundingClientRect(),this.viewer.viewport.getZoom();const c=this.ellipseData.radiusX/a.x,h=this.ellipseData.radiusY/a.y,d=this.calculateEllipseDistance(o.x,o.y,e.x,e.y,c,h,this.ellipseData.rotation),l=.5,p=.2;d<=l?r=1:d>=l+p?r=0:r=1-(d-l)/p}else{const a=e.x-o.x,c=e.y-o.y,h=Math.sqrt(a*a+c*c),d=.01,l=.02;h<=d?r=1:h>=d+l?r=0:r=1-(h-d)/l}}return r<.1?r:i>=.8&&r>.9?1:Math.min(n,r)}calculateEllipseDistance(t,e,i,n,r,o,a){const c=a*Math.PI/180,h=Math.cos(c),d=Math.sin(c),l=i-t,p=n-e,f=l*h+p*d,m=-l*d+p*h;return Math.sqrt(f*f/(r*r)+m*m/(o*o))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,this.overlayElement&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block"),this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity*this.config.maxOpacity,i=this.calculateZoomAwareOpacity(e),n=i-this.state.opacity,r=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(n)>.001?(this.state.opacity+=n*r,this.state.opacity=Math.max(0,Math.min(this.config.maxOpacity,this.state.opacity))):this.state.opacity=i;const o=this.state.targetScale-this.state.scale;Math.abs(o)>.01?this.state.scale+=o*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const a=this.state.targetPosition.x-this.state.currentPosition.x,c=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(a)>.1||Math.abs(c)>.1?(this.state.currentPosition.x+=a*this.config.positionSpeed,this.state.currentPosition.y+=c*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const h=this.state.targetRadius-this.state.currentRadius;if(Math.abs(h)>1?this.state.currentRadius+=h*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const l=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,p=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(l)>1||Math.abs(p)>1?(this.ellipseData.radiusX+=l*this.config.radiusSpeed,this.ellipseData.radiusY+=p*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(n)<=.001&&Math.abs(a)<=.1&&Math.abs(c)<=.1&&Math.abs(h)<=1&&Math.abs(o)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&(this.overlayElement.style.visibility="visible"),this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none"),e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none",this.overlayElement.style.visibility="hidden")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([c,h])=>{e=Math.min(e,c),i=Math.min(i,h),n=Math.max(n,c),r=Math.max(r,h)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),c=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-c[0],2)+Math.pow(t[1]-c[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}forceRecalculation(){this.state.selectedHotspot&&(this.ellipseCache.clear(),this.updateSpotlightPosition(),!this.state.isAnimating&&this.applySpotlightStyles())}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.cachedViewportRect=null,this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const c=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=c,t.style.webkitMaskImage=c,o++,requestAnimationFrame(a)}else{const c=performance.now()-r,h=o/c*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${h.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){if(!(!this.state.selectedHotspot||!this.useEllipse)&&window.performanceMonitor){const t=window.performanceMonitor.getMetrics();t.averageFPS<45&&this.useEllipse&&(console.warn("Disabling ellipses due to low FPS:",t.averageFPS),this.useEllipse=!1,this.config.useEllipse=!1,setTimeout(()=>{this.config.useEllipse=!0},1e4))}}}class ni{static create(t){const e=this.detectBrowser();return console.log("Browser detection:",{isSafari:e.isSafari,isIOS:e.isIOS,isWebKit:e.isWebKit,userAgent:navigator.userAgent}),e.isSafari||e.isIOS?(console.log("Using SafariOverlayManager for WebKit-based browser"),new sl(t)):(console.log("Using CSSOverlayManager (default)"),new rl(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r=n&&!i&&/Mac/.test(e),o="WebkitAppearance"in document.documentElement.style&&!window.chrome,a=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:o,isIOSChrome:a,isMacOSSafari:r,isWebKitBased:n||i||a}}static setPreference(t){return t==="css"||t==="safari"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css' or 'safari'.`),!1)}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t){const e=this.getCurrentType();return e==="safari"?(console.log("Creating SafariOverlayManager (forced)"),new sl(t)):e==="css"?(console.log("Creating CSSOverlayManager (forced)"),new rl(t)):this.create(t)}}var wd=Y('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),_d=Y('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),Td=Y('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),bd=Y('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),xd=Y('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),Ed=Y('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),Sd=Y('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),Pd=Y("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),Cd=Y('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+)">'),Ad=Y('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+)">'),Rd=Y("<input type=range class=volume-slider min=0 max=100>"),Id=Y("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+: Skip</span><span>M: Mute</span><span>Esc: Minimize"),Dd=Y('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),Md=Y("<div>");const ol=()=>wd(),al=()=>_d(),kd=()=>Td(),Od=()=>bd(),Fd=()=>xd(),Ld=()=>Ed(),Vd=()=>Sd();function Bd(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=pe(!0),[r,o]=pe(!1),[a,c]=pe(0),[h,d]=pe(0),[l,p]=pe(0),[f,m]=pe(80),[v,w]=pe(!1),[T,A]=pe(!1),[F,H]=pe(!0),[q,J]=pe(!1);dn(()=>{e()&&r()&&i()&&(J(!0),setTimeout(()=>J(!1),500))});const D=()=>window.innerWidth<=768;dn(()=>{t&&(t.onProgress=ne=>{T()||(c(ne.percent),d(ne.current),p(ne.duration))},t.onPlaybackStart=()=>{o(!0),i()&&F()?(n(!1),H(!1)):i()||H(!1)},t.onPlaybackEnd=()=>{o(!1),c(0),d(0)},t.setVolume(f()/100))}),dn(()=>{const ne=Te=>{if(e()&&Te.target.tagName!=="INPUT")switch(Te.key){case" ":i()||(Te.preventDefault(),E());break;case"ArrowLeft":Te.shiftKey&&!i()&&(Te.preventDefault(),k());break;case"ArrowRight":Te.shiftKey&&!i()&&(Te.preventDefault(),S());break;case"m":case"M":i()||L();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",ne),Un(()=>window.removeEventListener("keydown",ne))}),dn(()=>{if(t){const ne=t.getState();o(ne.isPlaying),w(ne.isMuted)}});const E=()=>{!t||!e()||(r()?t.pause():t.resume())},S=()=>{t&&t.skip(15)},k=()=>{t&&t.skip(-15)},L=()=>{if(!t)return;const ne=t.toggleMute();w(ne)},O=ne=>{if(!t)return;const Te=ne.currentTarget.getBoundingClientRect(),Se=(ne.clientX-Te.left)/Te.width*100;t.seekToPercent(Se),c(Se)},M=ne=>{if(!T())return;const Te=ne.currentTarget.getBoundingClientRect(),Se=Math.max(0,Math.min(100,(ne.clientX-Te.left)/Te.width*100));c(Se)},V=()=>{T()&&t&&(t.seekToPercent(a()),A(!1))},Ce=ne=>{const Te=parseInt(ne.target.value);m(Te),t&&(t.setVolume(Te/100),Te>0&&v()&&(t.toggleMute(),w(!1)))},Ie=ne=>{if(!ne||isNaN(ne))return"0:00";const Te=Math.floor(ne/60),Se=Math.floor(ne%60);return`${Te}:${Se.toString().padStart(2,"0")}`},Oe=()=>{const ne=e();return ne?ne.narrationTitle||`Hotspot ${ne.id}`:""};return be(qe,{get when(){return e()},get children(){var ne=Md();return ne.addEventListener("mouseleave",V),ne.$$mouseup=V,ie(ne,be(qe,{get when(){return i()},get children(){var Te=Pd(),Se=Te.firstChild,dt=Se.nextSibling,We=dt.firstChild;return Se.$$click=()=>{r()?E():n(!1)},ie(Se,(()=>{var te=Rt(()=>!!r());return()=>te()?be(al,{}):be(ol,{})})()),ie(We,Oe),$e(te=>{var ct=`btn-play-mini ${r()?"playing":""} ${q()?"changing":""}`,rt=r()?"Pause":"Play";return ct!==te.e&&Bn(Se,te.e=ct),rt!==te.t&&Yt(Se,"title",te.t=rt),te},{e:void 0,t:void 0}),Te}}),null),ie(ne,be(qe,{get when(){return!i()},get children(){var Te=Dd(),Se=Te.firstChild,dt=Se.firstChild,We=dt.nextSibling,te=Se.nextSibling,ct=te.firstChild,rt=ct.nextSibling,Kt=rt.firstChild,St=Kt.firstChild,ei=St.nextSibling,xi=rt.nextSibling,qt=te.nextSibling,kt=qt.firstChild,Ot=kt.firstChild,Wt=kt.nextSibling,wt=Wt.firstChild;return ie(dt,Oe),We.$$click=()=>n(!0),ie(We,be(Vd,{})),ie(ct,()=>Ie(h())),rt.$$mousemove=M,rt.$$mousedown=()=>A(!0),rt.$$click=O,ie(xi,()=>Ie(l())),ie(kt,be(qe,{get when(){return!D()},get children(){var ke=Cd();return ke.$$click=k,ie(ke,be(kd,{})),ke}}),Ot),Ot.$$click=E,ie(Ot,be(qe,{get when(){return!r()},get children(){return be(ol,{})}}),null),ie(Ot,be(qe,{get when(){return r()},get children(){return be(al,{})}}),null),ie(kt,be(qe,{get when(){return!D()},get children(){var ke=Ad();return ke.$$click=S,ie(ke,be(Od,{})),ke}}),null),wt.$$click=L,ie(wt,be(qe,{get when(){return Rt(()=>!v())()&&f()>0},get children(){return be(Fd,{})}}),null),ie(wt,be(qe,{get when(){return v()||f()===0},get children(){return be(Ld,{})}}),null),ie(Wt,be(qe,{get when(){return!D()},get children(){var ke=Rd();return ke.$$input=Ce,$e(()=>Yt(ke,"title",`Volume: ${f()}%`)),$e(()=>ke.value=f()),ke}}),null),ie(Te,be(qe,{when:!1,get children(){return Id()}}),null),$e(ke=>{var Pt=`${a()}%`,y=`${a()}%`,R=`btn-play ${r()?"playing":""}`,B=r()?"Pause (Space)":"Play (Space)",X=v()?"Unmute (M)":"Mute (M)";return Pt!==ke.e&&((ke.e=Pt)!=null?St.style.setProperty("width",Pt):St.style.removeProperty("width")),y!==ke.t&&((ke.t=y)!=null?ei.style.setProperty("left",y):ei.style.removeProperty("left")),R!==ke.a&&Bn(Ot,ke.a=R),B!==ke.o&&Yt(Ot,"title",ke.o=B),X!==ke.i&&Yt(wt,"title",ke.i=X),ke},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),Te}}),null),$e(()=>Bn(ne,`audio-player ${i()?"minimized":""} ${D()?"mobile":"desktop"}`)),ne}})}Yn(["mouseup","click","mousedown","mousemove","input"]);var Nd=Y('<div><button><svg class=media-button-icon width=16 height=16 viewBox="0 0 16 16"fill=none><path d="M2 4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4Z"stroke=currentColor stroke-width=1.5></path><circle cx=8 cy=8 r=2.5 stroke=currentColor stroke-width=1.5></circle><path d="M2 11L5 8L7 10L10 7L14 11"stroke=currentColor stroke-width=1.5 stroke-linecap=round stroke-linejoin=round></path></svg><span class=media-button-text>');function Hd(s){const{hotspotId:t,onClick:e,isVisible:i=!0,position:n={x:0,y:0},isMobile:r=!1}=s,[o,a]=pe(!1),[c,h]=pe(!1),d=()=>"View Image",l=p=>{p.stopPropagation(),h(!0),e&&e(t),setTimeout(()=>h(!1),300)};return be(qe,{when:i,get children(){var p=Nd(),f=p.firstChild,m=f.firstChild,v=m.nextSibling;return Bn(p,`media-button-container ${r?"mobile":"desktop"}`),f.addEventListener("mouseleave",()=>a(!1)),f.addEventListener("mouseenter",()=>a(!0)),f.$$click=l,ie(v,d),$e(w=>{var T=`media-button ${o()?"hovered":""} ${c()?"clicked":""}`,A=d();return T!==w.e&&Bn(f,w.e=T),A!==w.t&&Yt(f,"title",w.t=A),w},{e:void 0,t:void 0}),p}})}Yn(["click"]);var zd=Y("<h3 class=modal-title>"),Ud=Y('<div class=modal-overlay-backdrop><div><button class=modal-close-button title="Close (Esc)"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M18 6L6 18M6 6l12 12"stroke=currentColor stroke-width=2 stroke-linecap=round></path></svg></button><div class=modal-image-container><img class=modal-image loading=lazy>',!0,!1,!1);function jd(s){const{imageUrl:t,isVisible:e,onClose:i,hotspotTitle:n}=s,r=o=>{o.target===o.currentTarget&&i()};return be(qe,{when:e,get children(){var o=Ud(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=h.firstChild;return o.$$click=r,Dc(c,"click",i),ie(a,be(qe,{when:n,get children(){var l=zd();return ie(l,n),l}}),h),Yt(d,"src",t),Yt(d,"alt",n||"Hotspot image"),$e(()=>Bn(a,`modal-overlay-content ${s.isLoading?"loading":""} ${s.hasError?"error":""}`)),o}})}Yn(["click"]);function qd(s){const{imageOverlayManager:t,currentHotspot:e}=s,[i,n]=pe(!1),[r,o]=pe(null),[a,c]=pe("modal"),[h,d]=pe(!1),[l,p]=pe(!1);let f=null,m=null;jo(()=>{t&&(f=(w,T)=>{console.log("Opening overlay for:",w);const A=T.imageUrls[0];A&&(o(A),c(T.displayMode||"modal"),d(!0),p(!1),n(!0),t.getImage(A)?d(!1):t.loadImage(A,w).then(()=>d(!1)).catch(()=>{p(!0),d(!1)}))},m=()=>{n(!1),o(null),t.closeOverlay()},t.onOverlayOpen=f,t.onOverlayClose=m,Un(()=>{t&&(t.onOverlayOpen=null,t.onOverlayClose=null)}))}),dn(()=>{if(!i())return;document.body.classList.add("modal-open");const w=T=>{T.key==="Escape"&&v()};window.addEventListener("keydown",w),Un(()=>{window.removeEventListener("keydown",w),document.body.classList.remove("modal-open")})});const v=()=>{m&&m()};return be(qe,{get when(){return Rt(()=>a()==="modal")()&&i()},get children(){return be(jd,{get imageUrl(){return r()},isVisible:!0,onClose:v,get hotspotTitle(){var w;return((w=e==null?void 0:e())==null?void 0:w.title)||"Image"},get isLoading(){return h()},get hasError(){return l()}})}})}const de={viewer:{imageLoaderLimit:4,maxImageCacheCount:2e3,minPixelRatio:.5,minZoomImageRatio:.5,smoothTileEdgesMinZoom:3,alwaysBlend:!0,immediateRender:!1,preserveViewport:!0,preserveImageSizeOnResize:!0,visibilityRatio:1,subPixelRendering:!1,imageSmoothingEnabled:!0,preload:!0,placeholderFillStyle:null,animationTime:.3,springStiffness:6,blendTime:.18,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,zoomPerScroll:1.2,zoomPerClick:2,minZoomLevel:.5,maxZoomLevel:40,defaultZoomLevel:1.1,maxZoomPixelRatio:6,loadTilesWithAjax:!0,ajaxHeaders:{"Cache-Control":"public, max-age=31536000, immutable"},timeout:6e4,minZoomImageRatio:.8,maxTilesPerFrame:6,tileRetryMax:1,tileRetryDelay:100,minimumPixelsPerTile:12,compositeOperation:null,smoothImageZoom:!1,constrainDuringPan:!0,wrapHorizontal:!1,wrapVertical:!1,navigatorAutoResize:!0,showNavigator:!1,drawer:"canvas",debugMode:!1,webglOptions:{antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!0,powerPreference:"high-performance"}},hotspots:{batchSize:50,visibilityCheckInterval:100,renderDebounceTime:16,maxVisibleHotspots:100,minZoomForHotspots:3},viewport:{updateDebounce:8},memory:{maxCachedImages:300,criticalMemoryThreshold:200},network:{maxConcurrentRequests:6},mobile:{maxImageCacheCount:50,imageLoaderLimit:2,animationTime:.2,springStiffness:12,immediateRender:!1,blendTime:.1,maxTilesPerFrame:3,minPixelRatio:.5,minZoomImageRatio:.9,visibilityRatio:1,smoothTileEdgesMinZoom:1/0,alwaysBlend:!0,preserveImageSizeOnResize:!1,maxZoomPixelRatio:2},debug:{warnThreshold:{fps:45}}},Wd=()=>{var e;const s=navigator.userAgent.toLowerCase(),t=navigator.platform.toLowerCase();return{isSafari:/^((?!chrome|android|crios|fxios).)*safari/i.test(s),isChrome:/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),isFirefox:/firefox|fxios/i.test(s),isEdge:/edge|edg/i.test(s),isIOS:/ipad|iphone|ipod/.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isAndroid:/android/.test(s),isMac:/mac/.test(t),isWindows:/win/.test(t),isMobile:/android|iphone|ipad|ipod/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,isTablet:/ipad|android(?!.*mobile)/i.test(s)||t==="macintel"&&navigator.maxTouchPoints>1,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isLowEndDevice:navigator.hardwareConcurrency<=2||navigator.deviceMemory<=2,isHighEndDevice:navigator.hardwareConcurrency>=8&&navigator.deviceMemory>=8,deviceMemory:navigator.deviceMemory||4,cpuCores:navigator.hardwareConcurrency||4,connectionType:((e=navigator.connection)==null?void 0:e.effectiveType)||"4g",pixelRatio:window.devicePixelRatio||1,isHighDPI:window.devicePixelRatio>1.5}},Gd=()=>{const s=Wd();return(s.isSafari||s.isIOS)&&(de.viewer.drawer="canvas",de.viewer.maxImageCacheCount=200,console.log("Safari/iOS detected - forcing canvas drawer and limiting cache")),s.isAndroid&&(de.viewer.drawer="canvas",console.log("Android detected - forcing canvas drawer for compatibility")),s.isMobile&&(Object.assign(de.viewer,{drawer:"canvas",imageLoaderLimit:de.mobile.imageLoaderLimit,maxImageCacheCount:de.mobile.maxImageCacheCount,animationTime:de.mobile.animationTime,springStiffness:de.mobile.springStiffness,immediateRender:de.mobile.immediateRender,blendTime:de.mobile.blendTime,smoothImageZoom:!1,maxTilesPerFrame:de.mobile.maxTilesPerFrame,visibilityRatio:de.mobile.visibilityRatio,minPixelRatio:de.mobile.minPixelRatio,minZoomImageRatio:de.mobile.minZoomImageRatio,smoothTileEdgesMinZoom:de.mobile.smoothTileEdgesMinZoom,alwaysBlend:de.mobile.alwaysBlend,preserveImageSizeOnResize:de.mobile.preserveImageSizeOnResize,maxZoomPixelRatio:de.mobile.maxZoomPixelRatio,gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchToZoom:!0,dragToPan:!0,pinchRotate:!1}}),de.hotspots.batchSize=25,de.hotspots.maxVisibleHotspots=50,de.hotspots.renderDebounceTime=32,de.memory.maxCachedImages=50,console.log("Mobile device detected - applied aggressive performance optimizations")),s.isLowEndDevice&&(de.viewer.animationTime=.2,de.viewer.springStiffness=12,de.viewer.maxImageCacheCount=Math.min(150,de.viewer.maxImageCacheCount),de.viewer.imageLoaderLimit=2,de.viewer.maxTilesPerFrame=2,de.memory.maxCachedImages=150,de.network.maxConcurrentRequests=3,de.hotspots.maxVisibleHotspots=50,de.viewer.minPixelRatio=.7,console.log("Low-end device detected - reduced resource usage but maintained quality settings")),s.isHighEndDevice&&!s.isMobile&&(de.viewer.maxImageCacheCount=800,de.viewer.imageLoaderLimit=8,de.viewer.maxTilesPerFrame=6,de.memory.maxCachedImages=500,de.network.maxConcurrentRequests=8,de.viewer.minPixelRatio=.4,de.viewer.maxZoomPixelRatio=8,console.log("High-end device detected - increased resource limits and quality")),s.isHighDPI&&!s.isMobile&&(de.viewer.minPixelRatio=Math.min(.5,de.viewer.minPixelRatio),de.viewer.maxZoomPixelRatio=Math.max(4,s.pixelRatio*2)),(s.connectionType==="slow-2g"||s.connectionType==="2g")&&(de.viewer.imageLoaderLimit=1,de.network.maxConcurrentRequests=2,de.viewer.timeout=12e4,console.log("Slow connection detected - reduced concurrent requests")),s},ao=Gd();function Zd(s,t){const e=de;if(s<20&&s>0)return e.viewer.imageLoaderLimit=1,e.viewer.maxTilesPerFrame=1,e.viewer.animationTime=.1,e.viewer.springStiffness=15,e.viewer.immediateRender=!0,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=50,e.viewer.minPixelRatio=.8,console.error("Emergency performance mode activated"),"emergency";if(s<30&&s>0)return e.viewer.imageLoaderLimit=2,e.viewer.maxTilesPerFrame=2,e.viewer.animationTime=.2,e.viewer.springStiffness=12,e.viewer.blendTime=0,e.viewer.maxImageCacheCount=100,e.viewer.minPixelRatio=.7,console.warn("Critical performance mode activated"),"critical";if(s<45&&s>0)return e.viewer.imageLoaderLimit=Math.max(3,e.viewer.imageLoaderLimit-1),e.viewer.maxTilesPerFrame=Math.max(3,e.viewer.maxTilesPerFrame-1),"reduced";if(s>55){const i=ao.isHighEndDevice?8:ao.isMobile?2:6;return e.viewer.imageLoaderLimit<i&&(e.viewer.imageLoaderLimit=Math.min(i,e.viewer.imageLoaderLimit+1)),e.viewer.maxTilesPerFrame<4&&(e.viewer.maxTilesPerFrame=Math.min(4,e.viewer.maxTilesPerFrame+1)),e.viewer.minPixelRatio=ao.isMobile?.8:.5,"normal"}return t>e.memory.criticalMemoryThreshold?(e.viewer.maxImageCacheCount=Math.max(50,Math.floor(e.viewer.maxImageCacheCount*.5)),console.warn(`High memory usage: ${t}MB - Reduced cache to ${e.viewer.maxImageCacheCount}`),"memory-limited"):"normal"}const Xd=(s,t,e,i,n=null)=>(i&&(s.animationTime=.2,s.springStiffness=12,s.blendTime=0,s.immediateRender=!0,s.imageLoaderLimit=2,s.maxImageCacheCount=50,s.visibilityRatio=1,s.maxTilesPerFrame=2),{tileSources:n||t,prefixUrl:"https://cdn.jsdelivr.net/npm/openseadragon@5.0.1/build/openseadragon/images/",drawer:e,imageSmoothingEnabled:s.imageSmoothingEnabled,smoothTileEdgesMinZoom:s.smoothTileEdgesMinZoom,alwaysBlend:s.alwaysBlend,placeholderFillStyle:s.placeholderFillStyle,opacity:1,preload:s.preload,compositeOperation:s.compositeOperation,...s.drawer==="webgl"?{webglOptions:s.webglOptions}:{},immediateRender:s.immediateRender,imageLoaderLimit:s.imageLoaderLimit,maxImageCacheCount:s.maxImageCacheCount,timeout:s.timeout,loadTilesWithAjax:s.loadTilesWithAjax,ajaxHeaders:s.ajaxHeaders,visibilityRatio:s.visibilityRatio,minPixelRatio:s.minPixelRatio,defaultZoomLevel:s.defaultZoomLevel,minZoomLevel:s.minZoomLevel,maxZoomPixelRatio:s.maxZoomPixelRatio,constrainDuringPan:s.constrainDuringPan,wrapHorizontal:s.wrapHorizontal,wrapVertical:s.wrapVertical,animationTime:s.animationTime,springStiffness:s.springStiffness,blendTime:s.blendTime,zoomPerScroll:1.1,zoomPerClick:1.5,showNavigationControl:!1,showZoomControl:!1,showHomeControl:!1,showFullPageControl:!1,showRotationControl:!1,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:!0,flickMomentum:0},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,flickEnabled:s.flickEnabled,flickMinSpeed:s.flickMinSpeed,flickMomentum:s.flickMomentum,pinchToZoom:!0,dragToPan:!0},dblClickDistThreshold:20,clickDistThreshold:10,clickTimeThreshold:300,debugMode:s.debugMode,crossOriginPolicy:"Anonymous",ajaxWithCredentials:!1,preserveViewport:!0,preserveImageSizeOnResize:s.preserveImageSizeOnResize,maxTilesPerFrame:s.maxTilesPerFrame,smoothImageZoom:s.smoothImageZoom,subPixelRendering:!1,minimumPixelsPerTile:s.minimumPixelsPerTile||12}),Yd=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream;if(/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||t||e)return console.log("Mobile/Safari detected - forcing canvas drawer for performance"),"canvas";const n=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),r=/firefox|fxios/i.test(s);return n||r?(console.log("Desktop Chrome/Firefox detected - using webgl drawer"),"webgl"):(console.log("Default browser detected - using canvas drawer"),"canvas")},Me=()=>{const s=navigator.userAgent.toLowerCase();if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(s))return!0;const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<=768;return e&&i},Qd=(s,t,e)=>{let i;if(s.coordinates){let T=1/0,A=1/0,F=-1/0,H=-1/0;(J=>{Array.isArray(J[0])&&typeof J[0][0]=="number"?J.forEach(([D,E])=>{T=Math.min(T,D),A=Math.min(A,E),F=Math.max(F,D),H=Math.max(H,E)}):J.forEach(D=>{D.forEach(([E,S])=>{T=Math.min(T,E),A=Math.min(A,S),F=Math.max(F,E),H=Math.max(H,S)})})})(s.coordinates),i={minX:T,minY:A,maxX:F,maxY:H}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new et.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new et.Point(i.maxX,i.maxY)),a=o.x-r.x,c=o.y-r.y,h=r.x+a/2,d=r.y+c/2,l=t.viewport.getAspectRatio(),p=a/c,f=e?.85:.8;let m,v;p>l?(m=a/f,v=m/l):(v=c/f,m=v*l);const w=new et.Rect(h-m/2,d-v/2,m,v);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:h,y:d},dimensions:{width:m,height:v},aspectRatios:{hotspot:p.toFixed(2),viewport:l.toFixed(2)},paddingFactor:f,zoomBounds:w}),w};var Kd=Y('<img class=preview-image alt="Loading preview">'),Jd=Y("<div class=viewer-loading><p>Loading high-resolution artwork..."),$d=Y('<div style=margin-bottom:12px;><button style="width:100%;padding:10px;font-size:11px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.7);font-weight:500;transition:all 0.2s;">Fine-Tuning of spotlight'),ep=Y('<div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Hotspot Colors</div><div style=font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:10px;></div><button style="width:100%;padding:8px;font-size:11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Next Palette'),tp=Y('<div class=debug-info><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Performance</div><div style=color:rgba(255,255,255,0.9);font-size:11px;line-height:1.7;><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Hovered</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Selected</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Type</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Total hotspots</span><span style=color:rgba(255,255,255,0.9);></span></div><div style=display:flex;justify-content:space-between;><span style=color:rgba(255,255,255,0.6);>Renderer</span><span style=color:rgba(255,255,255,0.9);></span></div></div></div><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Zoom Control</div><div class=zoom-speed-control><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Cinematic Zoom Speed: <!>x</label><input type=range min=0.5 max=2.5 step=0.1 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;><div style=font-size:10px;color:rgba(255,255,255,0.4);margin-top:6px;>Duration: <!>s</div></div></div><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Interaction Mode</div><div style=font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:10px;>Current: </div><button style="width:100%;padding:8px;font-size:11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Switch to <!> Mode</button><div style=font-size:10px;color:rgba(255,255,255,0.4);margin-top:6px;></div></div><div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.08);"><div style=font-size:11px;color:rgba(255,255,255,0.5);font-weight:500;margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;>Overlay System</div><div style=font-size:11px;color:rgba(255,255,255,0.8);margin-bottom:10px;></div><button style="width:100%;padding:8px;font-size:11px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Switch Mode'),ip=Y('<div><div><div style=font-size:12px;color:#FFFFFF;font-weight:600;letter-spacing:0.5px;text-align:center;>SPOTLIGHT FINE-TUNING</div><button></button></div><div class=floating-panel-scrollable><div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Circle Size: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Ellipse X: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Ellipse Y: </label><input type=range max=3.0 step=0.05 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Gradient Spread: </label><input type=range max=5.0 step=0.1 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Offset X: <!>%</label><input type=range min=-10 max=10 step=0.5 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><div style=margin-bottom:10px;><label style=font-size:10px;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px;>Offset Y: <!>%</label><input type=range min=-10 max=10 step=0.5 style=width:100%;height:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none;border-radius:2px;cursor:pointer;></div><button style="margin-top:16px;padding:10px;font-size:11px;width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:rgba(255,255,255,0.8);transition:all 0.2s;font-weight:500;">Copy Current Values'),np=Y("<div class=expand-button-container><button class=expand-button><span class=expand-icon></span><span>Full View"),rp=Y("<div class=fullscreen-button-container><button class=fullscreen-button>"),sp=Y("<div class=viewer-container><div class=openseadragon-viewer>"),op=Y('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3">'),ap=Y('<svg width=18 height=18 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">');let Dn=[];function lp(s){var oi,Ei,Si,pi,ir,sn;let t,e=null,i={};const[n,r]=pe(!0),[o,a]=pe(null),[c,h]=pe(null),[d,l]=pe(!1),[p,f]=pe(!1),[m,v]=pe(!1),[w,T]=pe(!1),[A,F]=pe(!1),[H,q]=pe(!1),[J,D]=pe(null),[E,S]=pe(!1),[k,L]=pe({x:0,y:0}),[O,M]=pe(null),[V,Ce]=pe({}),[Ie,Oe]=pe(parseInt(localStorage.getItem("debugLevel")??(Me()?"0":"1"))),[ne,Te]=pe(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[Se,dt]=pe(((oi=window.safariTuning)==null?void 0:oi.circleMultiplier)||(Me()?.8:1.2)),[We,te]=pe(((Ei=window.safariTuning)==null?void 0:Ei.ellipseMultiplierX)||(Me()?.8:1.15)),[ct,rt]=pe(((Si=window.safariTuning)==null?void 0:Si.ellipseMultiplierY)||(Me()?.8:1.15)),[Kt,St]=pe(((pi=window.safariTuning)==null?void 0:pi.gradientMultiplier)||(Me()?1:1.5)),[ei,xi]=pe(((ir=window.safariTuning)==null?void 0:ir.offsetX)||0),[qt,kt]=pe(((sn=window.safariTuning)==null?void 0:sn.offsetY)||0),[Ot,Wt]=pe(!1),[wt,ke]=pe({x:0,y:0}),[Pt,y]=pe(!1),[R,B]=pe({x:0,y:0}),[X,$]=pe(0),[ce,Z]=pe(null),[we,Le]=pe(localStorage.getItem("interactionMode")||"direct"),Ae=()=>{i.handleKeyPress&&window.removeEventListener("keydown",i.handleKeyPress),Object.values(i).forEach(K=>{typeof K=="number"&&clearInterval(K)}),V().resizeObserver&&t&&V().resizeObserver.disconnect(),Object.values(V()).forEach(K=>{K&&typeof K.destroy=="function"&&K.destroy()}),e&&e.destroy(),["performanceMonitor","viewer","tileOptimizer"].forEach(K=>{(window[K]===V()[K]||window[K]===e)&&delete window[K]})};jo(async()=>{var jt,ot,_t,at,ht;try{Dn=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${Dn.length} hotspots`)}catch(He){console.error("Failed to load hotspots:",He),Dn=[]}const K=new Image;K.onload=()=>f(!0),K.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`;const ue=de.viewer;`${s.artworkId}${s.artworkId}`;const re={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:`/images/tiles/${s.artworkId}_1024/${s.artworkId}_files/`,Format:"jpg",Overlap:"2",TileSize:"1024",Size:{Width:"11244",Height:"6543"}},minLevel:8,maxLevel:14},j=Me(),oe=Yd(),ge=Xd(ue,re,oe,j,re);/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&(ge.drawer="canvas",ge.smoothTileEdgesMinZoom=1/0,ge.immediateRender=!0),e=et({element:t,...ge,updatePixelDensityRatio:!1});const fe={spatialIndex:new pd,viewportManager:new yd(e),audioEngine:new $u,performanceMonitor:new rd(e),renderOptimizer:new sd(e),tileOptimizer:new gd(e),memoryManager:new td(e),tileCleanupManager:new fd(e),imageOverlayManager:new ed,overlayManager:ni.createWithOverride(e)};console.log("Creating overlay manager..."),console.log("Overlay manager type:",(jt=fe.overlayManager)==null?void 0:jt.constructor.name),console.log("Overlay manager instance:",fe.overlayManager),fe.tileOptimizer.state.isActive=!1,setTimeout(()=>{fe.tileOptimizer.state.isActive=!0},1e3),Ce(fe),console.log("About to initialize overlay manager..."),console.log("Is overlay manager present?",!!fe.overlayManager),console.log("Does it have initialize method?",typeof((ot=fe.overlayManager)==null?void 0:ot.initialize)),fe.overlayManager.initialize(),console.log("Overlay manager initialized"),console.log("Is initialized flag:",(_t=fe.overlayManager)==null?void 0:_t.isInitialized),console.log("Overlay element created?",!!((at=fe.overlayManager)!=null&&at.overlayElement)),window.overlayManager=fe.overlayManager,console.log("Overlay manager set on window:",(ht=window.overlayManager)==null?void 0:ht.constructor.name),window.audioEngine=fe.audioEngine,fe.audioEngine.onPlaybackEnd=He=>{console.log(`Finished playing audio for hotspot ${He}`)},fe.spatialIndex.loadHotspots(Dn),fe.imageOverlayManager.loadHotspots(Dn),window.viewer=e,window.performanceMonitor=fe.performanceMonitor,window.tileOptimizer=fe.tileOptimizer,window.tileCleanupManager=fe.tileCleanupManager,fe.performanceMonitor.start(),fe.memoryManager.start(),fe.tileOptimizer.start(),fe.tileCleanupManager.start(),Ie()>=1?fe.performanceMonitor.enableDebugOverlay():fe.performanceMonitor.disableDebugOverlay(),I(),C(),U(),Q(),document.addEventListener("fullscreenchange",()=>{T(!!document.fullscreenElement)}),document.addEventListener("fullscreenchange",()=>{T(!!document.fullscreenElement)});const Je=He=>{if(Pt()){const ti=He.touches?He.touches[0].clientX:He.clientX,Ct=He.touches?He.touches[0].clientY:He.clientY;ke({x:ti-R().x,y:Ct-R().y})}},ze=He=>{Pt()&&(He.preventDefault(),Je(He))},nt=()=>{y(!1)};window.addEventListener("mousemove",Je),window.addEventListener("mouseup",nt),window.addEventListener("touchmove",ze,{passive:!1}),window.addEventListener("touchend",nt),Un(()=>{window.removeEventListener("mousemove",Je),window.removeEventListener("mouseup",nt),window.removeEventListener("touchmove",ze),window.removeEventListener("touchend",nt)}),Un(Ae)});const he=()=>{let K=null,ue=null,re="idle",j=0,oe=null;e.addHandler("zoom",ge=>{const le=e.viewport.getZoom();if(j++,oe&&clearTimeout(oe),!ue||Math.abs(le-ue)>.01){const fe=ue?le-ue:0,Je=Math.abs(fe);re==="idle"?(re="accelerating",K=performance.now(),e.viewport.centerSpringX.animationTime=.4,e.viewport.centerSpringY.animationTime=.4,e.viewport.zoomSpring.animationTime=.4,e.imageLoader&&j>3&&(e.imageLoader.jobLimit=Math.max(1,e.imageLoader.jobLimit-1))):re==="accelerating"&&j>5&&(re="cruising",e.viewport.zoomSpring.animationTime=.2,e.imageLoader&&(e.imageLoader.jobLimit=1,Je>.1&&e.imageLoader.clear())),ue=le}oe=setTimeout(()=>{re!=="idle"&&(re="decelerating",e.viewport.centerSpringX.animationTime=.3,e.viewport.centerSpringY.animationTime=.3,e.viewport.zoomSpring.animationTime=.3,e.imageLoader&&(e.imageLoader.jobLimit=3),setTimeout(()=>{re="idle",j=0,e.imageLoader&&(e.imageLoader.jobLimit=de.viewer.imageLoaderLimit),e.forceRedraw(),K&&(performance.now()-K,K=null)},200))},100)})},Xe=()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(K=>clearTimeout(K)),window.expandToFullViewTimeouts=[])},x=()=>{let K=1,ue=null;e.addHandler("zoom",re=>{const j=e.viewport.getZoom();re.speed,ue&&clearTimeout(ue);let oe=1;j<2?oe=.6:j<3.5?oe=.8:oe=1;const ge=oe-K;if(K+=ge*.3,e.drawer){e.drawer.imageSmoothingEnabled=K>.7;const le=Math.floor((1-K)*3);e.skipTileRatio=le}ue=setTimeout(()=>{const le=setInterval(()=>{K+=.1,K>=1&&(K=1,e.drawer.imageSmoothingEnabled=!0,e.skipTileRatio=0,e.forceRedraw(),clearInterval(le))},50)},200)})},b=K=>{"requestIdleCallback"in window?requestIdleCallback(K,{timeout:200}):setTimeout(K,50)},C=()=>{const K={centerX:e.viewport.centerSpringX.springStiffness,centerY:e.viewport.centerSpringY.springStiffness,zoom:e.viewport.zoomSpring.springStiffness};e.addHandler("zoom-click",ue=>{if(ue.quick)return;const re=e.viewport.getZoom(),j=ue.zoom,oe=Math.abs(Math.log2(j)-Math.log2(re)),ge=Math.min(.8,.3+oe*.15);e.viewport.zoomSpring.animationTime=ge;const le=Math.max(4,8-oe);e.viewport.zoomSpring.springStiffness=le,setTimeout(()=>{e.viewport.zoomSpring.animationTime=de.viewer.animationTime,e.viewport.zoomSpring.springStiffness=K.zoom},ge*1e3+100)})},I=()=>{if(e.drawer&&e.drawer.getType&&e.drawer.getType()!=="webgl"){let re=0;e.addHandler("tile-drawing",j=>{const oe=e.viewport.getZoom();j.tile;const ge=j.tile.size,le=j.tile.level,fe=e.skipTileRatio||0;if(fe>0&&(re++,re%(fe+1)!==0)){j.preventDefaultAction=!0;return}if(oe<2&&ge*oe<24){j.preventDefaultAction=!0;return}const Je=Math.floor(Math.log2(oe));Math.abs(le-Je)>2&&e.skipTileRatio>0&&(j.preventDefaultAction=!0)})}e.addHandler("open",()=>{if(Me()){let oe=0;const ge=33;e.addHandler("update-viewport",le=>{const fe=performance.now();if(e.isAnimating()&&fe-oe<ge){le.preventDefaultAction=!0;return}oe=fe})}e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,Me()&&(e.viewport.minZoomLevel=.5,e.viewport.minZoomImageRatio=.3),x(),he(),vd(et),e.viewport.minZoomLevel=.8,e.viewport.minZoomImageRatio=.5,console.log("Viewer ready - initializing systems"),console.log("Using drawer:",e.drawer.getType?e.drawer.getType():"canvas"),l(!0),r(!1);const j=e.world.getItemAt(0).getBounds();e.viewport.fitBounds(j,!0),e.viewport.applyConstraints(!0),Me()&&setTimeout(()=>{const oe=e.world.getItemAt(0);if(oe){const ge=oe.getBounds();e.viewport.fitBoundsWithConstraints(ge,!1)}},100),e.viewport.getHomeBounds(),setTimeout(()=>me(),100)}),e.addHandler("zoom",()=>{V().tileCleanupManager&&V().tileCleanupManager.setPressure("normal"),A()&&e.imageLoader&&e.imageLoader.clear()}),e.addHandler("pan",()=>{V().tileCleanupManager&&V().tileCleanupManager.setPressure("normal")}),e.addHandler("tile-loaded",re=>{var j;if(re.tile&&V().tileOptimizer){const oe=re.tile.loadTime||((j=re.tiledImage)==null?void 0:j.lastResetTime)||100;V().tileOptimizer.trackLoadTime(oe);const ge=`${re.tile.level||0}_${re.tile.x||0}_${re.tile.y||0}`;V().tileOptimizer.loadingTiles.delete(ge)}}),e.addHandler("animation",()=>{if(V().performanceMonitor){const re=V().performanceMonitor.getMetrics();if(re.averageFPS<de.debug.warnThreshold.fps){const j=Zd(re.averageFPS,re.memoryUsage);if(V().tileCleanupManager){const oe={emergency:"critical",critical:"critical",reduced:"high","memory-limited":"high",normal:"normal"};V().tileCleanupManager.setPressure(oe[j]||"normal")}}}}),e.addHandler("animation-finish",()=>{console.log("animation-finish fired",{isZoomingToHotspot:A(),isExpandingToFullView:H()}),A()&&(console.log("animation-finish: Setting isZoomingToHotspot to false"),F(!1),V().renderer&&(console.log("animation-finish: Calling resumeUpdates"),V().renderer.resumeUpdates(),V().renderer.updateVisibility()),V().renderOptimizer&&V().renderOptimizer.endCinematicZoom())}),e.addHandler("animation-start",re=>{A()&&V().tileCleanupManager&&V().tileCleanupManager.pauseCleanup(3e3)});const K=()=>{i.updateTimer&&clearTimeout(i.updateTimer),i.updateTimer=setTimeout(()=>{b(()=>{const{viewportManager:re,spatialIndex:j,audioEngine:oe}=V();if(!re||!j||!oe)return;const ge=re.getCurrentViewport(),le=j.queryViewport(ge.bounds,ge.zoom);oe.preloadHotspots(le)})},de.viewport.updateDebounce)};e.addHandler("viewport-change",K);let ue=!1;e.addHandler("animation-start",()=>{Me()&&(A()||H())&&(ue=!0,e.removeHandler("viewport-change",K))}),e.addHandler("animation-finish",()=>{ue&&(ue=!1,e.addHandler("viewport-change",K),setTimeout(K,100))}),e.addHandler("canvas-click",re=>{!re.preventDefaultAction&&V().renderer&&re.quick&&V().renderer.selectedHotspot&&(V().renderer.selectedHotspot=null,h(null),V().overlayManager&&V().overlayManager.selectHotspot(null))}),Me()&&e.addHandler("canvas-click",re=>{const j=e.container.clientWidth,oe=e.container.clientHeight,ge=100,le=re.position.x<ge&&re.position.y<ge,fe=re.position.x>j-ge&&re.position.y<ge,Je=re.position.x<ge&&re.position.y>oe-ge,ze=re.position.x>j-ge&&re.position.y>oe-ge;if(le||fe||Je||ze){const nt=X()+1;if($(nt),ce()&&clearTimeout(ce()),nt>=3){const ot=Ie()===0?1:0;if(Oe(ot),localStorage.setItem("debugLevel",ot.toString()),V().performanceMonitor)if(ot===1)V().performanceMonitor.enableDebugOverlay(),V().performanceMonitor.start();else{V().performanceMonitor.disableDebugOverlay();const _t=document.querySelector(".performance-overlay");_t&&(_t.style.display="none")}console.log(`Debug mode: ${ot===1?"ON":"OFF"}`),$(0)}else Z(setTimeout(()=>{$(0)},1e3))}})},U=()=>{const K={"+":()=>e.viewport.zoomBy(de.viewer.zoomPerScroll),"=":()=>e.viewport.zoomBy(de.viewer.zoomPerScroll),"-":()=>e.viewport.zoomBy(1/de.viewer.zoomPerScroll),_:()=>e.viewport.zoomBy(1/de.viewer.zoomPerScroll),0:()=>it(),f:()=>e.viewport.fitBounds(e.world.getHomeBounds()),F:()=>e.viewport.fitBounds(e.world.getHomeBounds()),c:()=>{if(Me())return;const re=Ie()===0?1:0;Oe(re),localStorage.setItem("debugLevel",re.toString()),V().performanceMonitor&&(re===1?V().performanceMonitor.enableDebugOverlay():V().performanceMonitor.disableDebugOverlay()),V().renderer&&V().renderer.setDebugMode(re===1),console.log(`Debug mode: ${re===1?"ON":"OFF"}`)}};i.handleKeyPress=ue=>{const re=document.activeElement;if(re&&(re.tagName==="INPUT"||re.tagName==="TEXTAREA"||re.contentEditable==="true"))return;const j=K[ue.key];j&&e&&(ue.preventDefault(),j(),e.viewport.applyConstraints())},window.addEventListener("keydown",i.handleKeyPress)},Q=()=>{const K=new ResizeObserver(ue=>{if(!(!(e!=null&&e.viewport)||!e.isOpen()))for(let re of ue){const{width:j,height:oe}=re.contentRect;j>0&&oe>0&&requestAnimationFrame(()=>{try{e&&e.viewport&&e.isOpen()&&(e.viewport.resize(),e.viewport.applyConstraints(),e.forceRedraw())}catch(ge){ge.message&&!ge.message.includes("undefined")&&console.warn("Resize error:",ge)}})}});K.observe(t),Ce(ue=>({...ue,resizeObserver:K}))},me=()=>{if(!e)return;const K=new yo({viewer:e,spatialIndex:V().spatialIndex,onHotspotHover:a,onHotspotClick:ve,visibilityCheckInterval:de.hotspots.visibilityCheckInterval,batchSize:de.hotspots.batchSize,renderDebounceTime:de.hotspots.renderDebounceTime,maxVisibleHotspots:de.hotspots.maxVisibleHotspots,minZoomForHotspots:de.hotspots.minZoomForHotspots,debugMode:Ie()===2});Ce(ue=>({...ue,renderer:K})),console.log("Using NativeHotspotRenderer for all platforms")},Ne=async K=>{if(console.log("zoomToHotspot called",{hotspotId:K.id,isZoomingToHotspot:A(),viewer:!!e}),!e||A()||H()){console.log("zoomToHotspot BLOCKED",{noViewer:!e,isZoomingToHotspot:A(),isExpandingToFullView:H()});return}const ue=Qd(K,e,Me());if(!ue)return;const re=Me()?2.8:1.8,j=Me()?1.5:re*ne(),oe=4/ne();let ge;F(!0),V().overlayManager&&V().overlayManager.startZoomAnimation&&V().overlayManager.startZoomAnimation(),console.log("Starting cinematic zoom to hotspot:",K.id),ge=setTimeout(()=>{console.log("Safety timeout: forcing isZoomingToHotspot to false"),F(!1),V().renderer&&V().renderer.resumeUpdates()},j*1e3+500);const le={animationTime:e.animationTime,springStiffness:e.springStiffness};if(V().tileCleanupManager&&V().tileCleanupManager.pauseCleanup(j*1e3+500),e.imageLoader&&e.imageLoader.clear(),V().renderOptimizer&&V().renderOptimizer.startCinematicZoom(),V().performanceMonitor&&Me()&&V().performanceMonitor.pauseMonitoring(),V().renderer&&(Me()||V().renderer.pauseUpdates(),Me()&&V().renderer.hideOverlay()),Me()){console.log("DEBUG: Mobile animation with preload");try{let at;if(e.viewport.getZoomForBounds)at=e.viewport.getZoomForBounds(ue);else{const Ct=e.viewport.getBounds(),Ft=Ct.width/ue.width,ii=Ct.height/ue.height;at=Math.min(Ft,ii)*e.viewport.getZoom()}const ht=ue.getCenter();console.log("DEBUG: Mobile animation params",{currentZoom:e.viewport.getZoom(),targetZoom:at,center:ht});const He=e.viewport.getZoom(),ti=5;if(at/He>ti){console.log("DEBUG: Large zoom jump detected, using stepped approach");const Ct=He*ti;e.viewport.zoomTo(Ct,ht,!0),e.forceRedraw(),setTimeout(()=>{e.viewport.panTo(ht),e.viewport.zoomTo(at);let Ft=0;const ii=setInterval(()=>{e.forceRedraw(),Ft++,Ft>10&&clearInterval(ii)},100)},200)}else{e.viewport.centerSpringX.animationTime=j,e.viewport.centerSpringY.animationTime=j,e.viewport.zoomSpring.animationTime=j;const Ct=new et.Point(ht.x,ht.y);e.viewport.panTo(Ct),e.viewport.zoomTo(at);const Ft=setInterval(()=>{e.forceRedraw()},100);setTimeout(()=>{clearInterval(Ft)},j*1e3+200)}}catch(at){console.error("Mobile animation error:",at),e.viewport.fitBounds(ue,!1)}setTimeout(()=>{v(!0),console.log("Full View button should now be visible on mobile")},j*1e3+200);return}setTimeout(()=>{v(!0),console.log("Full View button should now be visible")},j*1e3+200),e.animationTime=j,e.springStiffness=oe,e.viewport.centerSpringX.animationTime=j,e.viewport.centerSpringY.animationTime=j,e.viewport.zoomSpring.animationTime=j,e.viewport.centerSpringX.springStiffness=oe,e.viewport.centerSpringY.springStiffness=oe,e.viewport.zoomSpring.springStiffness=oe,e.viewport.applyConstraints(),console.log("Springs configured with animTime:",j),V().viewportManager&&V().viewportManager.setCacheEnabled(!1);const fe=e.viewport.getBounds();console.log("DEBUG: Manual zoom attempt",{from:fe,to:ue});const Je=e.viewport.getBounds(),ze=Je.width/ue.width,nt=Je.height/ue.height,jt=Math.min(ze,nt)*e.viewport.getZoom(),ot=ue.getCenter();console.log("Manual zoom calculation:",{currentZoom:e.viewport.getZoom(),targetZoom:jt,animTime:j,center:ot}),e.viewport.panTo(ot,!1),e.viewport.zoomTo(jt,null,!1),console.log("DEBUG: Zoom animation started",{currentZoom:e.viewport.getZoom(),targetBounds:ue,springValues:{centerX:e.viewport.centerSpringX.target.value,centerY:e.viewport.centerSpringY.target.value,zoom:e.viewport.zoomSpring.target.value},animationTime:e.animationTime,isAnimating:e.isAnimating()});const _t=setInterval(()=>{console.log("DEBUG: Animation progress",{isAnimating:e.isAnimating(),currentZoom:e.viewport.getZoom(),zoomSpringCurrent:e.viewport.zoomSpring.current.value,zoomSpringTarget:e.viewport.zoomSpring.target.value})},100);setTimeout(()=>clearInterval(_t),2e3),setTimeout(()=>{V().viewportManager&&V().viewportManager.setCacheEnabled(!0)},j*1e3),setTimeout(()=>{clearTimeout(ge),console.log("Setting isZoomingToHotspot to false"),F(!1),e.animationTime=le.animationTime,e.springStiffness=le.springStiffness,e.viewport.centerSpringX.animationTime=le.animationTime,e.viewport.centerSpringY.animationTime=le.animationTime,e.viewport.zoomSpring.animationTime=le.animationTime,e.viewport.centerSpringX.springStiffness=le.springStiffness,e.viewport.centerSpringY.springStiffness=le.springStiffness,e.viewport.zoomSpring.springStiffness=le.springStiffness,V().renderOptimizer&&V().renderOptimizer.endCinematicZoom(),V().performanceMonitor&&Me()&&V().performanceMonitor.resumeMonitoring(),V().overlayManager&&V().overlayManager.endZoomAnimation&&V().overlayManager.endZoomAnimation()},j*1e3+1e3),setTimeout(()=>{V().renderer&&(console.log("Animation complete - restoring hotspots"),Me()?(V().renderer.showOverlay(),setTimeout(()=>{"requestIdleCallback"in window?requestIdleCallback(()=>{V().renderer.resumeUpdates(),V().renderer.updateVisibilityLazy()},{timeout:1e3}):setTimeout(()=>{V().renderer.resumeUpdates(),V().renderer.updateVisibilityLazy()},300)},200)):(V().renderer.resumeUpdates(),setTimeout(()=>{V().renderer.updateVisibility(),e.forceRedraw()},100)))},j*1e3+300)},ve=async K=>{var re,j,oe,ge,le,fe,Je,ze;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:K?K.id:"null (deselecting)",isZoomingToHotspot:A(),isExpandingToFullView:H(),timestamp:Date.now()}),console.log("Components available?",!!V()),console.log("OverlayManager available?",!!((re=V())!=null&&re.overlayManager)),console.log("OverlayManager type:",(oe=(j=V())==null?void 0:j.overlayManager)==null?void 0:oe.constructor.name),console.log("OverlayManager initialized?",(le=(ge=V())==null?void 0:ge.overlayManager)==null?void 0:le.isInitialized),!K){h(null),S(!1),D(null),M(null),V().overlayManager?(console.log("Calling overlayManager.clearSelection()"),V().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(H()&&(console.log("Interrupting Full View animation for hotspot click"),e.viewport.stopAnimation(),Xe(),q(!1),V().renderOptimizer&&V().renderOptimizer.endCinematicZoom(),V().renderer&&(V().renderer.resumeUpdates(),Me()&&V().renderer.showOverlay()),await new Promise(nt=>setTimeout(nt,50))),A()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),F(!1)),S(!1),h(K),D(K),(fe=V())!=null&&fe.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(K==null?void 0:K.id)||"null"),console.log("Hotspot data being passed:",K),console.log("OverlayManager method exists?",typeof V().overlayManager.selectHotspot);try{V().overlayManager.selectHotspot(K),console.log("selectHotspot call completed")}catch(nt){console.error("Error calling selectHotspot:",nt)}console.log("Hotspot data being passed:",{id:K.id,shape:K.shape,hasCoordinates:!!K.coordinates,coordinatesLength:(Je=K.coordinates)==null?void 0:Je.length}),V().overlayManager.selectHotspot(K)}else console.error("No overlay manager available in components!"),console.error("Components object:",V());(K.image_url_1||((ze=V().imageOverlayManager)==null?void 0:ze.getOverlay(K.id)))&&(V().imageOverlayManager.shouldAutoReveal(K.id)?pt(K.id):V().imageOverlayManager.shouldShowButton(K.id)&&(M(K),S(!0))),console.log("Zooming to hotspot:",K.id),await Ne(K)};window.artworkViewerHandleHotspotClick=ve;const pt=K=>{console.log("Media button clicked for:",K),S(!1),V().imageOverlayManager&&V().imageOverlayManager.openOverlay(K)},it=()=>{if(console.log("expandToFullView START",{isExpandingToFullView:H(),isZoomingToHotspot:A()}),window.expandToFullViewTimeouts||(window.expandToFullViewTimeouts=[]),!e||H())return;A()&&(console.log("Force resetting isZoomingToHotspot in expandToFullView"),F(!1),V().renderOptimizer&&V().renderOptimizer.endCinematicZoom(),V().renderer&&V().renderer.resumeUpdates()),v(!1),q(!0);const K=e.world.getItemAt(0);if(!K){q(!1);return}const ue=K.getBounds(),j=e.viewport.getBounds().getCenter(),oe=ue.getCenter(),ge=Math.sqrt(Math.pow(oe.x-j.x,2)+Math.pow(oe.y-j.y,2)),le=Math.min(1.5,Math.max(1.2,ge*.4+1)),fe=Math.max(6,10-ge*1.5),Je=setTimeout(()=>{console.log("Safety timeout: forcing isExpandingToFullView to false (was:",H(),")"),q(!1)},le*1e3+500);window.expandToFullViewTimeouts.push(Je);const ze={animationTime:e.animationTime,springStiffness:e.springStiffness};if(console.log("expandToFullView animation params:",{distance:ge,animTime:le,stiffness:fe,currentAnimationTime:e.animationTime,currentStiffness:e.springStiffness}),V().tileCleanupManager&&V().tileCleanupManager.pauseCleanup(le*1e3+500),e.imageLoader&&e.imageLoader.clear(),V().renderOptimizer&&V().renderOptimizer.startCinematicZoom(),V().renderer&&(V().renderer.pauseUpdates(),Me()&&V().renderer.hideOverlay()),e.animationTime=le,e.springStiffness=fe,e.viewport.centerSpringX.animationTime=le,e.viewport.centerSpringY.animationTime=le,e.viewport.zoomSpring.animationTime=le,e.viewport.centerSpringX.springStiffness=fe,e.viewport.centerSpringY.springStiffness=fe,e.viewport.zoomSpring.springStiffness=fe*.85,e.viewport.centerSpringX.resetTo(e.viewport.centerSpringX.current.value),e.viewport.centerSpringY.resetTo(e.viewport.centerSpringY.current.value),e.viewport.zoomSpring.resetTo(e.viewport.zoomSpring.current.value),console.log("expandToFullView executing fitBounds"),console.log("Springs after reset:",{centerXTime:e.viewport.centerSpringX.animationTime,zoomTime:e.viewport.zoomSpring.animationTime}),Me())e.viewport.fitBounds(ue,!1);else{const _t=ue.x+ue.width/2,at=ue.y+ue.height/2,ht=new et.Rect(_t-ue.width*1.01/2,at-ue.height*1.01/2,ue.width*1.01,ue.height*1.01);e.viewport.fitBounds(ht,!1)}console.log("expandToFullView animation started",{actualAnimTime:e.animationTime,actualStiffness:e.springStiffness,timestamp:Date.now()});const nt=setTimeout(()=>{clearTimeout(Je),q(!1),e.animationTime=ze.animationTime,e.springStiffness=ze.springStiffness,e.viewport.centerSpringX.animationTime=ze.animationTime,e.viewport.centerSpringY.animationTime=ze.animationTime,e.viewport.zoomSpring.animationTime=ze.animationTime,e.viewport.centerSpringX.springStiffness=ze.springStiffness,e.viewport.centerSpringY.springStiffness=ze.springStiffness,e.viewport.zoomSpring.springStiffness=ze.springStiffness,V().renderOptimizer&&V().renderOptimizer.endCinematicZoom()},le*1e3+200);window.expandToFullViewTimeouts.push(nt);const jt=setTimeout(()=>{V().renderer&&(Me()&&V().renderer.showOverlay(),setTimeout(()=>{V().renderer.resumeUpdates(),V().renderer.updateVisibility(),e.forceRedraw()},200))},le*1e3+100);window.expandToFullViewTimeouts.push(jt)},si=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(K=>{console.log(`Error attempting to enable fullscreen: ${K.message}`)})};return[(()=>{var K=sp(),ue=K.firstChild;ie(K,be(qe,{get when(){return Rt(()=>!!p())()&&!d()},get children(){var j=Kd();return $e(()=>Yt(j,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),j}}),ue);var re=t;return typeof re=="function"?Yu(re,ue):t=ue,ie(K,be(qe,{get when(){return n()},get children(){return Jd()}}),null),ie(K,be(qe,{get when(){return Rt(()=>!!d())()&&Ie()===1},get children(){var j=tp(),oe=j.firstChild,ge=oe.firstChild,le=ge.nextSibling,fe=le.firstChild,Je=fe.firstChild,ze=Je.nextSibling,nt=fe.nextSibling,jt=nt.firstChild,ot=jt.nextSibling,_t=nt.nextSibling,at=_t.firstChild,ht=at.nextSibling,He=_t.nextSibling,ti=He.firstChild,Ct=ti.nextSibling,Ft=He.nextSibling,ii=Ft.firstChild,Li=ii.nextSibling,on=oe.nextSibling,Tn=on.firstChild,Pi=Tn.nextSibling,Ci=Pi.firstChild,Ai=Ci.firstChild,fi=Ai.nextSibling;fi.nextSibling;var Gt=Ci.nextSibling,Ri=Gt.nextSibling,an=Ri.firstChild,_e=an.nextSibling;_e.nextSibling;var Ge=on.nextSibling,Vi=Ge.firstChild,ai=Vi.nextSibling;ai.firstChild;var Zt=ai.nextSibling,ln=Zt.firstChild,Bi=ln.nextSibling;Bi.nextSibling;var bn=Zt.nextSibling,xn=Ge.nextSibling,zr=xn.firstChild,nr=zr.nextSibling,rr=nr.nextSibling;return ie(ze,()=>{var xe;return((xe=o())==null?void 0:xe.id)||"none"}),ie(ot,()=>{var xe;return((xe=c())==null?void 0:xe.id)||"none"}),ie(ht,()=>{var xe;return((xe=o())==null?void 0:xe.type)||"none"}),ie(Ct,()=>Dn.length),ie(Li,(()=>{var xe=Rt(()=>{var Qe;return!!((Qe=e==null?void 0:e.drawer)!=null&&Qe.getType)});return()=>xe()?e.drawer.getType():"canvas"})()),ie(Ci,()=>ne().toFixed(1),fi),Gt.$$input=xe=>{const Qe=parseFloat(xe.target.value);Te(Qe),localStorage.setItem("zoomSpeedMultiplier",Qe.toString())},ie(Ri,()=>((Me()?2.8:1.8)*ne()).toFixed(1),_e),ie(ai,()=>we()==="direct"?"Direct (Classic)":"Temporal (Hold)",null),Zt.$$click=()=>{const xe=we()==="direct"?"temporal":"direct";Le(xe),localStorage.setItem("interactionMode",xe),V().renderer&&V().renderer.interactionModeManager&&V().renderer.interactionModeManager.setMode(xe)},Zt.addEventListener("mouseleave",xe=>{xe.target.style.background="rgba(255,255,255,0.05)",xe.target.style.borderColor="rgba(255,255,255,0.1)"}),Zt.addEventListener("mouseenter",xe=>{xe.target.style.background="rgba(255,255,255,0.1)",xe.target.style.borderColor="rgba(255,255,255,0.2)"}),ie(Zt,()=>we()==="direct"?"Temporal":"Direct",Bi),ie(bn,()=>we()==="direct"?"Tap = immediate selection + zoom":"Hold < 0.3s = explore | 0.3-0.5s = preview | > 0.5s = activate"),ie(nr,()=>{const xe=ni.getCurrentType(),Qe=ni.detectBrowser(),Lt=!!xe;return`${xe==="safari"||!xe&&(Qe.isSafari||Qe.isIOS)?"Apple Mode":"Standard Mode"}  ${Lt?"Manual":"Auto"}`}),rr.$$click=()=>{const Qe=(ni.getCurrentType()||(ni.detectBrowser().isWebKitBased?"safari":"css"))==="css"?"safari":"css";ni.setPreference(Qe),window.location.reload()},rr.addEventListener("mouseleave",xe=>{xe.target.style.background="rgba(255,255,255,0.05)",xe.target.style.borderColor="rgba(255,255,255,0.1)"}),rr.addEventListener("mouseenter",xe=>{xe.target.style.background="rgba(255,255,255,0.1)",xe.target.style.borderColor="rgba(255,255,255,0.2)"}),ie(j,be(qe,{get when(){return ni.getCurrentType()==="safari"||ni.detectBrowser().isWebKitBased&&!ni.getCurrentType()},get children(){return[(()=>{var xe=$d(),Qe=xe.firstChild;return Qe.$$click=()=>{const li=Me()?window.innerHeight*.8:500,xt=(window.innerWidth-240)/2,Ue=Me()?(window.innerHeight-li)/2:(window.innerHeight-500)/2;ke({x:xt,y:Math.max(Me()?20:50,Ue)}),Wt(!0)},Qe.addEventListener("mouseleave",Lt=>{Lt.target.style.background="rgba(255,255,255,0.03)",Lt.target.style.borderColor="rgba(255,255,255,0.08)"}),Qe.addEventListener("mouseenter",Lt=>{Lt.target.style.background="rgba(255,255,255,0.05)",Lt.target.style.borderColor="rgba(255,255,255,0.15)"}),xe})(),(()=>{var xe=ep(),Qe=xe.firstChild,Lt=Qe.nextSibling,li=Lt.nextSibling;return ie(Lt,()=>{var Ue;const xt=((Ue=window.nativeHotspotRenderer)==null?void 0:Ue.currentPalette)||"tech";return xt==="enchantedJournal"?"Enchanted Journal":xt==="moonlitManuscript"?"Moonlit Manuscript":"Tech (Original)"}),li.$$click=()=>{var Ni;const xt=["tech","enchantedJournal","moonlitManuscript"],En=(xt.indexOf(((Ni=window.nativeHotspotRenderer)==null?void 0:Ni.currentPalette)||"tech")+1)%xt.length,cn=xt[En];window.setHotspotPalette&&(window.setHotspotPalette(cn),e.forceRedraw())},li.addEventListener("mouseleave",xt=>{xt.target.style.background="rgba(255,255,255,0.05)",xt.target.style.borderColor="rgba(255,255,255,0.1)"}),li.addEventListener("mouseenter",xt=>{xt.target.style.background="rgba(255,255,255,0.1)",xt.target.style.borderColor="rgba(255,255,255,0.2)"}),xe})()]}}),null),$e(xe=>as(j,`
    background: rgba(20,20,20,0.95); 
    padding: ${Me()?"12px":"16px"}; 
    border-radius: 12px; 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border: 1px solid rgba(255,255,255,0.1); 
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    ${Me()?"max-height: 70vh; overflow-y: auto; width: 90%; max-width: 300px;":""}
`,xe)),$e(()=>Gt.value=ne()),j}}),null),ie(K,be(qe,{get when(){return Rt(()=>!!Ot())()&&(ni.getCurrentType()==="safari"||ni.detectBrowser().isWebKitBased&&!ni.getCurrentType())},get children(){var j=ip(),oe=j.firstChild,ge=oe.firstChild,le=ge.nextSibling,fe=oe.nextSibling,Je=fe.firstChild,ze=Je.firstChild;ze.firstChild;var nt=ze.nextSibling,jt=Je.nextSibling,ot=jt.firstChild;ot.firstChild;var _t=ot.nextSibling,at=jt.nextSibling,ht=at.firstChild;ht.firstChild;var He=ht.nextSibling,ti=at.nextSibling,Ct=ti.firstChild;Ct.firstChild;var Ft=Ct.nextSibling,ii=ti.nextSibling,Li=ii.firstChild,on=Li.firstChild,Tn=on.nextSibling;Tn.nextSibling;var Pi=Li.nextSibling,Ci=ii.nextSibling,Ai=Ci.firstChild,fi=Ai.firstChild,Gt=fi.nextSibling;Gt.nextSibling;var Ri=Ai.nextSibling,an=Ci.nextSibling;return j.style.setProperty("position","fixed"),j.style.setProperty("width","220px"),j.style.setProperty("background","rgba(20,20,20,0.85)"),j.style.setProperty("border","1px solid rgba(255,255,255,0.2)"),j.style.setProperty("borderRadius","12px"),j.style.setProperty("boxShadow","0 8px 32px rgba(0,0,0,0.6)"),j.style.setProperty("zIndex","10000"),j.style.setProperty("userSelect","none"),j.style.setProperty("backdropFilter","blur(20px)"),j.style.setProperty("-webkit-backdrop-filter","blur(20px)"),j.style.setProperty("display","flex"),j.style.setProperty("flexDirection","column"),j.style.setProperty("overflowY","auto"),j.style.setProperty("overflowX","hidden"),oe.$$touchstart=_e=>{const Ge=_e.touches[0];y(!0),B({x:Ge.clientX-wt().x,y:Ge.clientY-wt().y})},oe.$$mousedown=_e=>{y(!0),B({x:_e.clientX-wt().x,y:_e.clientY-wt().y})},oe.style.setProperty("position","relative"),oe.style.setProperty("padding","12px 40px 12px 16px"),oe.style.setProperty("borderBottom","1px solid rgba(255,255,255,0.1)"),oe.style.setProperty("cursor","grab"),oe.style.setProperty("background","rgba(255,255,255,0.03)"),oe.style.setProperty("borderRadius","12px 12px 0 0"),le.$$click=()=>Wt(!1),le.addEventListener("mouseleave",_e=>{_e.target.style.background="transparent",_e.target.style.color="rgba(255,255,255,0.5)"}),le.addEventListener("mouseenter",_e=>{_e.target.style.background="rgba(255,255,255,0.1)",_e.target.style.color="rgba(255,255,255,0.8)"}),le.style.setProperty("position","absolute"),le.style.setProperty("top","8px"),le.style.setProperty("right","8px"),le.style.setProperty("background","transparent"),le.style.setProperty("border","none"),le.style.setProperty("color","rgba(255,255,255,0.5)"),le.style.setProperty("fontSize","16px"),le.style.setProperty("cursor","pointer"),le.style.setProperty("padding","4px"),le.style.setProperty("width","24px"),le.style.setProperty("height","24px"),le.style.setProperty("display","flex"),le.style.setProperty("alignItems","center"),le.style.setProperty("justifyContent","center"),le.style.setProperty("borderRadius","4px"),le.style.setProperty("transition","all 0.2s"),fe.style.setProperty("padding","16px"),fe.style.setProperty("overflowY","auto"),fe.style.setProperty("overflowX","hidden"),fe.style.setProperty("flex","1"),fe.style.setProperty("WebkitOverflowScrolling","touch"),fe.style.setProperty("scrollbarWidth","thin"),fe.style.setProperty("scrollbarColor","rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05)"),ie(ze,()=>Se().toFixed(2),null),nt.$$input=_e=>{const Ge=parseFloat(_e.target.value);dt(Ge),window.safariTuning&&(window.safariTuning.circleMultiplier=Ge,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},ie(ot,()=>We().toFixed(2),null),_t.$$input=_e=>{const Ge=parseFloat(_e.target.value);te(Ge),window.safariTuning&&(window.safariTuning.ellipseMultiplierX=Ge,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},ie(ht,()=>ct().toFixed(2),null),He.$$input=_e=>{const Ge=parseFloat(_e.target.value);rt(Ge),window.safariTuning&&(window.safariTuning.ellipseMultiplierY=Ge,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},ie(Ct,()=>Kt().toFixed(2),null),Ft.$$input=_e=>{const Ge=parseFloat(_e.target.value);St(Ge),window.safariTuning&&(window.safariTuning.gradientMultiplier=Ge,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},ie(Li,()=>ei().toFixed(1),Tn),Pi.$$input=_e=>{const Ge=parseFloat(_e.target.value);xi(Ge),window.safariTuning&&(window.safariTuning.offsetX=Ge,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},ie(Ai,()=>qt().toFixed(1),Gt),Ri.$$input=_e=>{const Ge=parseFloat(_e.target.value);kt(Ge),window.safariTuning&&(window.safariTuning.offsetY=Ge,V().overlayManager&&c()&&V().overlayManager.forceRecalculation())},an.$$click=()=>{console.log("Current tuning values:",window.safariTuning),navigator.clipboard.writeText(JSON.stringify(window.safariTuning,null,2)),alert("Tuning values copied to clipboard!")},an.addEventListener("mouseleave",_e=>{_e.target.style.background="rgba(255,255,255,0.05)",_e.target.style.borderColor="rgba(255,255,255,0.1)"}),an.addEventListener("mouseenter",_e=>{_e.target.style.background="rgba(255,255,255,0.1)",_e.target.style.borderColor="rgba(255,255,255,0.2)"}),$e(_e=>{var Ge=`${wt().x}px`,Vi=`${wt().y}px`,ai=Pt()?"grabbing":"default",Zt=Me()?"80vh":"none",ln=Me()?"0.2":"0.1",Bi=Me()?"0.2":"0.5",bn=Me()?"0.2":"0.5",xn=Me()?"0.1":"0.3";return Ge!==_e.e&&((_e.e=Ge)!=null?j.style.setProperty("left",Ge):j.style.removeProperty("left")),Vi!==_e.t&&((_e.t=Vi)!=null?j.style.setProperty("top",Vi):j.style.removeProperty("top")),ai!==_e.a&&((_e.a=ai)!=null?j.style.setProperty("cursor",ai):j.style.removeProperty("cursor")),Zt!==_e.o&&((_e.o=Zt)!=null?j.style.setProperty("maxHeight",Zt):j.style.removeProperty("maxHeight")),ln!==_e.i&&Yt(nt,"min",_e.i=ln),Bi!==_e.n&&Yt(_t,"min",_e.n=Bi),bn!==_e.s&&Yt(He,"min",_e.s=bn),xn!==_e.h&&Yt(Ft,"min",_e.h=xn),_e},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),$e(()=>nt.value=Se()),$e(()=>_t.value=We()),$e(()=>He.value=ct()),$e(()=>Ft.value=Kt()),$e(()=>Pi.value=ei()),$e(()=>Ri.value=qt()),j}}),null),ie(K,be(qe,{get when(){return Rt(()=>!!d())()&&m()},get children(){var j=np(),oe=j.firstChild;return oe.$$click=it,j}}),null),ie(K,be(qe,{get when(){return Rt(()=>!!d())()&&Me()},get children(){var j=rp(),oe=j.firstChild;return oe.$$click=si,ie(oe,(()=>{var ge=Rt(()=>!!w());return()=>ge()?op():ap()})()),$e(()=>Yt(oe,"title",w()?"Exit fullscreen":"Enter fullscreen")),j}}),null),ie(K,be(qe,{get when(){return Rt(()=>!!E())()&&O()},get children(){return be(Hd,{get hotspotId(){var j;return(j=O())==null?void 0:j.id},onClick:pt,get position(){return k()},get isMobile(){return Me()}})}}),null),ie(K,be(qe,{get when(){return Rt(()=>!!d())()&&V().imageOverlayManager},get children(){return be(qd,{get imageOverlayManager(){return V().imageOverlayManager},currentHotspot:O})}}),null),K})(),be(qe,{get when(){return Rt(()=>!!d())()&&V().audioEngine},get children(){return be(Bd,{get audioEngine(){return V().audioEngine},currentHotspot:J})}})]}Yn(["input","click","mousedown","touchstart"]);const cp=()=>{};var ll={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Oc=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},hp=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],c=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(c>>10)),t[i++]=String.fromCharCode(56320+(c&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},Fc={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,c=n+2<s.length,h=c?s[n+2]:0,d=r>>2,l=(r&3)<<4|a>>4;let p=(a&15)<<2|h>>6,f=h&63;c||(f=64,o||(p=64)),i.push(e[d],e[l],e[p],e[f])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(Oc(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):hp(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const h=n<s.length?e[s.charAt(n)]:64;++n;const l=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||h==null||l==null)throw new up;const p=r<<2|a>>4;if(i.push(p),h!==64){const f=a<<4&240|h>>2;if(i.push(f),l!==64){const m=h<<6&192|l;i.push(m)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class up extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const dp=function(s){const t=Oc(s);return Fc.encodeByteArray(t,!0)},ws=function(s){return dp(s).replace(/\./g,"")},pp=function(s){try{return Fc.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fp(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mp=()=>fp().__FIREBASE_DEFAULTS__,gp=()=>{if(typeof process>"u"||typeof ll>"u")return;const s=ll.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},vp=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&pp(s[1]);return t&&JSON.parse(t)},Wo=()=>{try{return cp()||mp()||gp()||vp()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},yp=s=>{var t,e;return(e=(t=Wo())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},wp=s=>{const t=yp(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},Lc=()=>{var s;return(s=Wo())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _p{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Go(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function Tp(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bp(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[ws(JSON.stringify(e)),ws(JSON.stringify(o)),""].join(".")}const yr={};function xp(){const s={prod:[],emulator:[]};for(const t of Object.keys(yr))yr[t]?s.emulator.push(t):s.prod.push(t);return s}function Ep(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let cl=!1;function Sp(s,t){if(typeof window>"u"||typeof document>"u"||!Go(window.location.host)||yr[s]===t||yr[s]||cl)return;yr[s]=t;function e(p){return`__firebase__banner__${p}`}const i="__firebase__banner",r=xp().prod.length>0;function o(){const p=document.getElementById(i);p&&p.remove()}function a(p){p.style.display="flex",p.style.background="#7faaf0",p.style.position="fixed",p.style.bottom="5px",p.style.left="5px",p.style.padding=".5em",p.style.borderRadius="5px",p.style.alignItems="center"}function c(p,f){p.setAttribute("width","24"),p.setAttribute("id",f),p.setAttribute("height","24"),p.setAttribute("viewBox","0 0 24 24"),p.setAttribute("fill","none"),p.style.marginLeft="-6px"}function h(){const p=document.createElement("span");return p.style.cursor="pointer",p.style.marginLeft="16px",p.style.fontSize="24px",p.innerHTML=" &times;",p.onclick=()=>{cl=!0,o()},p}function d(p,f){p.setAttribute("id",f),p.innerText="Learn more",p.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",p.setAttribute("target","__blank"),p.style.paddingLeft="5px",p.style.textDecoration="underline"}function l(){const p=Ep(i),f=e("text"),m=document.getElementById(f)||document.createElement("span"),v=e("learnmore"),w=document.getElementById(v)||document.createElement("a"),T=e("preprendIcon"),A=document.getElementById(T)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(p.created){const F=p.element;a(F),d(w,v);const H=h();c(A,T),F.append(A,m,w,H),document.body.appendChild(F)}r?(m.innerText="Preview backend disconnected.",A.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(A.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,m.innerText="Preview backend running in this workspace."),m.setAttribute("id",f)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",l):l()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Pp(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Cp(){var s;const t=(s=Wo())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function Ap(){return!Cp()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function Rp(){try{return typeof indexedDB=="object"}catch{return!1}}function Ip(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Dp="FirebaseError";class Qn extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=Dp,Object.setPrototypeOf(this,Qn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Vc.prototype.create)}}class Vc{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?Mp(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new Qn(n,a,i)}}function Mp(s,t){return s.replace(kp,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const kp=/\{\$([^}]+)}/g;function _s(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if(hl(r)&&hl(o)){if(!_s(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function hl(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ti(s){return s&&s._delegate?s._delegate:s}class Er{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const un="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Op{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new _p;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(Lp(t))try{this.getOrInitializeService({instanceIdentifier:un})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=un){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=un){return this.instances.has(t)}getOptions(t=un){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:Fp(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=un){return this.component?this.component.multipleInstances?t:un:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function Fp(s){return s===un?void 0:s}function Lp(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Vp{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new Op(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Be;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(Be||(Be={}));const Bp={debug:Be.DEBUG,verbose:Be.VERBOSE,info:Be.INFO,warn:Be.WARN,error:Be.ERROR,silent:Be.SILENT},Np=Be.INFO,Hp={[Be.DEBUG]:"log",[Be.VERBOSE]:"log",[Be.INFO]:"info",[Be.WARN]:"warn",[Be.ERROR]:"error"},zp=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=Hp[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class Bc{constructor(t){this.name=t,this._logLevel=Np,this._logHandler=zp,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Be))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?Bp[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Be.DEBUG,...t),this._logHandler(this,Be.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Be.VERBOSE,...t),this._logHandler(this,Be.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Be.INFO,...t),this._logHandler(this,Be.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Be.WARN,...t),this._logHandler(this,Be.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Be.ERROR,...t),this._logHandler(this,Be.ERROR,...t)}}const Up=(s,t)=>t.some(e=>s instanceof e);let ul,dl;function jp(){return ul||(ul=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function qp(){return dl||(dl=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Nc=new WeakMap,wo=new WeakMap,Hc=new WeakMap,lo=new WeakMap,Zo=new WeakMap;function Wp(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(ji(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&Nc.set(e,s)}).catch(()=>{}),Zo.set(t,s),t}function Gp(s){if(wo.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});wo.set(s,t)}let _o={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return wo.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Hc.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return ji(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function Zp(s){_o=s(_o)}function Xp(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(co(this),t,...e);return Hc.set(i,t.sort?t.sort():[t]),ji(i)}:qp().includes(s)?function(...t){return s.apply(co(this),t),ji(Nc.get(this))}:function(...t){return ji(s.apply(co(this),t))}}function Yp(s){return typeof s=="function"?Xp(s):(s instanceof IDBTransaction&&Gp(s),Up(s,jp())?new Proxy(s,_o):s)}function ji(s){if(s instanceof IDBRequest)return Wp(s);if(lo.has(s))return lo.get(s);const t=Yp(s);return t!==s&&(lo.set(s,t),Zo.set(t,s)),t}const co=s=>Zo.get(s);function Qp(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=ji(o);return i&&o.addEventListener("upgradeneeded",c=>{i(ji(o.result),c.oldVersion,c.newVersion,ji(o.transaction),c)}),e&&o.addEventListener("blocked",c=>e(c.oldVersion,c.newVersion,c)),a.then(c=>{r&&c.addEventListener("close",()=>r()),n&&c.addEventListener("versionchange",h=>n(h.oldVersion,h.newVersion,h))}).catch(()=>{}),a}const Kp=["get","getKey","getAll","getAllKeys","count"],Jp=["put","add","delete","clear"],ho=new Map;function pl(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(ho.get(t))return ho.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=Jp.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||Kp.includes(e)))return;const r=async function(o,...a){const c=this.transaction(o,n?"readwrite":"readonly");let h=c.store;return i&&(h=h.index(a.shift())),(await Promise.all([h[e](...a),n&&c.done]))[0]};return ho.set(t,r),r}Zp(s=>({...s,get:(t,e,i)=>pl(t,e)||s.get(t,e,i),has:(t,e)=>!!pl(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $p{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(ef(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function ef(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const To="@firebase/app",fl="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ki=new Bc("@firebase/app"),tf="@firebase/app-compat",nf="@firebase/analytics-compat",rf="@firebase/analytics",sf="@firebase/app-check-compat",of="@firebase/app-check",af="@firebase/auth",lf="@firebase/auth-compat",cf="@firebase/database",hf="@firebase/data-connect",uf="@firebase/database-compat",df="@firebase/functions",pf="@firebase/functions-compat",ff="@firebase/installations",mf="@firebase/installations-compat",gf="@firebase/messaging",vf="@firebase/messaging-compat",yf="@firebase/performance",wf="@firebase/performance-compat",_f="@firebase/remote-config",Tf="@firebase/remote-config-compat",bf="@firebase/storage",xf="@firebase/storage-compat",Ef="@firebase/firestore",Sf="@firebase/ai",Pf="@firebase/firestore-compat",Cf="firebase",Af="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bo="[DEFAULT]",Rf={[To]:"fire-core",[tf]:"fire-core-compat",[rf]:"fire-analytics",[nf]:"fire-analytics-compat",[of]:"fire-app-check",[sf]:"fire-app-check-compat",[af]:"fire-auth",[lf]:"fire-auth-compat",[cf]:"fire-rtdb",[hf]:"fire-data-connect",[uf]:"fire-rtdb-compat",[df]:"fire-fn",[pf]:"fire-fn-compat",[ff]:"fire-iid",[mf]:"fire-iid-compat",[gf]:"fire-fcm",[vf]:"fire-fcm-compat",[yf]:"fire-perf",[wf]:"fire-perf-compat",[_f]:"fire-rc",[Tf]:"fire-rc-compat",[bf]:"fire-gcs",[xf]:"fire-gcs-compat",[Ef]:"fire-fst",[Pf]:"fire-fst-compat",[Sf]:"fire-vertex","fire-js":"fire-js",[Cf]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ts=new Map,If=new Map,xo=new Map;function ml(s,t){try{s.container.addComponent(t)}catch(e){ki.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function bs(s){const t=s.name;if(xo.has(t))return ki.debug(`There were multiple attempts to register component ${t}.`),!1;xo.set(t,s);for(const e of Ts.values())ml(e,s);for(const e of If.values())ml(e,s);return!0}function Df(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function Mf(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const kf={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},qi=new Vc("app","Firebase",kf);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Of{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new Er("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw qi.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ff=Af;function zc(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:bo,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw qi.create("bad-app-name",{appName:String(n)});if(e||(e=Lc()),!e)throw qi.create("no-options");const r=Ts.get(n);if(r){if(_s(e,r.options)&&_s(i,r.config))return r;throw qi.create("duplicate-app",{appName:n})}const o=new Vp(n);for(const c of xo.values())o.addComponent(c);const a=new Of(e,i,o);return Ts.set(n,a),a}function Lf(s=bo){const t=Ts.get(s);if(!t&&s===bo&&Lc())return zc();if(!t)throw qi.create("no-app",{appName:s});return t}function Nn(s,t,e){var i;let n=(i=Rf[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),ki.warn(a.join(" "));return}bs(new Er(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vf="firebase-heartbeat-database",Bf=1,Sr="firebase-heartbeat-store";let uo=null;function Uc(){return uo||(uo=Qp(Vf,Bf,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(Sr)}catch(e){console.warn(e)}}}}).catch(s=>{throw qi.create("idb-open",{originalErrorMessage:s.message})})),uo}async function Nf(s){try{const e=(await Uc()).transaction(Sr),i=await e.objectStore(Sr).get(jc(s));return await e.done,i}catch(t){if(t instanceof Qn)ki.warn(t.message);else{const e=qi.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});ki.warn(e.message)}}}async function gl(s,t){try{const i=(await Uc()).transaction(Sr,"readwrite");await i.objectStore(Sr).put(t,jc(s)),await i.done}catch(e){if(e instanceof Qn)ki.warn(e.message);else{const i=qi.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});ki.warn(i.message)}}}function jc(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hf=1024,zf=30;class Uf{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new qf(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=vl();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>zf){const o=Wf(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){ki.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=vl(),{heartbeatsToSend:i,unsentEntries:n}=jf(this._heartbeatsCache.heartbeats),r=ws(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return ki.warn(e),""}}}function vl(){return new Date().toISOString().substring(0,10)}function jf(s,t=Hf){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),yl(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),yl(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class qf{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Rp()?Ip().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await Nf(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return gl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return gl(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function yl(s){return ws(JSON.stringify({version:2,heartbeats:s})).length}function Wf(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Gf(s){bs(new Er("platform-logger",t=>new $p(t),"PRIVATE")),bs(new Er("heartbeat",t=>new Uf(t),"PRIVATE")),Nn(To,fl,s),Nn(To,fl,"esm2017"),Nn("fire-js","")}Gf("");var wl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Wi,qc;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(D,E){function S(){}S.prototype=E.prototype,D.D=E.prototype,D.prototype=new S,D.prototype.constructor=D,D.C=function(k,L,O){for(var M=Array(arguments.length-2),V=2;V<arguments.length;V++)M[V-2]=arguments[V];return E.prototype[L].apply(k,M)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(D,E,S){S||(S=0);var k=Array(16);if(typeof E=="string")for(var L=0;16>L;++L)k[L]=E.charCodeAt(S++)|E.charCodeAt(S++)<<8|E.charCodeAt(S++)<<16|E.charCodeAt(S++)<<24;else for(L=0;16>L;++L)k[L]=E[S++]|E[S++]<<8|E[S++]<<16|E[S++]<<24;E=D.g[0],S=D.g[1],L=D.g[2];var O=D.g[3],M=E+(O^S&(L^O))+k[0]+3614090360&4294967295;E=S+(M<<7&4294967295|M>>>25),M=O+(L^E&(S^L))+k[1]+3905402710&4294967295,O=E+(M<<12&4294967295|M>>>20),M=L+(S^O&(E^S))+k[2]+606105819&4294967295,L=O+(M<<17&4294967295|M>>>15),M=S+(E^L&(O^E))+k[3]+3250441966&4294967295,S=L+(M<<22&4294967295|M>>>10),M=E+(O^S&(L^O))+k[4]+4118548399&4294967295,E=S+(M<<7&4294967295|M>>>25),M=O+(L^E&(S^L))+k[5]+1200080426&4294967295,O=E+(M<<12&4294967295|M>>>20),M=L+(S^O&(E^S))+k[6]+2821735955&4294967295,L=O+(M<<17&4294967295|M>>>15),M=S+(E^L&(O^E))+k[7]+4249261313&4294967295,S=L+(M<<22&4294967295|M>>>10),M=E+(O^S&(L^O))+k[8]+1770035416&4294967295,E=S+(M<<7&4294967295|M>>>25),M=O+(L^E&(S^L))+k[9]+2336552879&4294967295,O=E+(M<<12&4294967295|M>>>20),M=L+(S^O&(E^S))+k[10]+4294925233&4294967295,L=O+(M<<17&4294967295|M>>>15),M=S+(E^L&(O^E))+k[11]+2304563134&4294967295,S=L+(M<<22&4294967295|M>>>10),M=E+(O^S&(L^O))+k[12]+1804603682&4294967295,E=S+(M<<7&4294967295|M>>>25),M=O+(L^E&(S^L))+k[13]+4254626195&4294967295,O=E+(M<<12&4294967295|M>>>20),M=L+(S^O&(E^S))+k[14]+2792965006&4294967295,L=O+(M<<17&4294967295|M>>>15),M=S+(E^L&(O^E))+k[15]+1236535329&4294967295,S=L+(M<<22&4294967295|M>>>10),M=E+(L^O&(S^L))+k[1]+4129170786&4294967295,E=S+(M<<5&4294967295|M>>>27),M=O+(S^L&(E^S))+k[6]+3225465664&4294967295,O=E+(M<<9&4294967295|M>>>23),M=L+(E^S&(O^E))+k[11]+643717713&4294967295,L=O+(M<<14&4294967295|M>>>18),M=S+(O^E&(L^O))+k[0]+3921069994&4294967295,S=L+(M<<20&4294967295|M>>>12),M=E+(L^O&(S^L))+k[5]+3593408605&4294967295,E=S+(M<<5&4294967295|M>>>27),M=O+(S^L&(E^S))+k[10]+38016083&4294967295,O=E+(M<<9&4294967295|M>>>23),M=L+(E^S&(O^E))+k[15]+3634488961&4294967295,L=O+(M<<14&4294967295|M>>>18),M=S+(O^E&(L^O))+k[4]+3889429448&4294967295,S=L+(M<<20&4294967295|M>>>12),M=E+(L^O&(S^L))+k[9]+568446438&4294967295,E=S+(M<<5&4294967295|M>>>27),M=O+(S^L&(E^S))+k[14]+3275163606&4294967295,O=E+(M<<9&4294967295|M>>>23),M=L+(E^S&(O^E))+k[3]+4107603335&4294967295,L=O+(M<<14&4294967295|M>>>18),M=S+(O^E&(L^O))+k[8]+1163531501&4294967295,S=L+(M<<20&4294967295|M>>>12),M=E+(L^O&(S^L))+k[13]+2850285829&4294967295,E=S+(M<<5&4294967295|M>>>27),M=O+(S^L&(E^S))+k[2]+4243563512&4294967295,O=E+(M<<9&4294967295|M>>>23),M=L+(E^S&(O^E))+k[7]+1735328473&4294967295,L=O+(M<<14&4294967295|M>>>18),M=S+(O^E&(L^O))+k[12]+2368359562&4294967295,S=L+(M<<20&4294967295|M>>>12),M=E+(S^L^O)+k[5]+4294588738&4294967295,E=S+(M<<4&4294967295|M>>>28),M=O+(E^S^L)+k[8]+2272392833&4294967295,O=E+(M<<11&4294967295|M>>>21),M=L+(O^E^S)+k[11]+1839030562&4294967295,L=O+(M<<16&4294967295|M>>>16),M=S+(L^O^E)+k[14]+4259657740&4294967295,S=L+(M<<23&4294967295|M>>>9),M=E+(S^L^O)+k[1]+2763975236&4294967295,E=S+(M<<4&4294967295|M>>>28),M=O+(E^S^L)+k[4]+1272893353&4294967295,O=E+(M<<11&4294967295|M>>>21),M=L+(O^E^S)+k[7]+4139469664&4294967295,L=O+(M<<16&4294967295|M>>>16),M=S+(L^O^E)+k[10]+3200236656&4294967295,S=L+(M<<23&4294967295|M>>>9),M=E+(S^L^O)+k[13]+681279174&4294967295,E=S+(M<<4&4294967295|M>>>28),M=O+(E^S^L)+k[0]+3936430074&4294967295,O=E+(M<<11&4294967295|M>>>21),M=L+(O^E^S)+k[3]+3572445317&4294967295,L=O+(M<<16&4294967295|M>>>16),M=S+(L^O^E)+k[6]+76029189&4294967295,S=L+(M<<23&4294967295|M>>>9),M=E+(S^L^O)+k[9]+3654602809&4294967295,E=S+(M<<4&4294967295|M>>>28),M=O+(E^S^L)+k[12]+3873151461&4294967295,O=E+(M<<11&4294967295|M>>>21),M=L+(O^E^S)+k[15]+530742520&4294967295,L=O+(M<<16&4294967295|M>>>16),M=S+(L^O^E)+k[2]+3299628645&4294967295,S=L+(M<<23&4294967295|M>>>9),M=E+(L^(S|~O))+k[0]+4096336452&4294967295,E=S+(M<<6&4294967295|M>>>26),M=O+(S^(E|~L))+k[7]+1126891415&4294967295,O=E+(M<<10&4294967295|M>>>22),M=L+(E^(O|~S))+k[14]+2878612391&4294967295,L=O+(M<<15&4294967295|M>>>17),M=S+(O^(L|~E))+k[5]+4237533241&4294967295,S=L+(M<<21&4294967295|M>>>11),M=E+(L^(S|~O))+k[12]+1700485571&4294967295,E=S+(M<<6&4294967295|M>>>26),M=O+(S^(E|~L))+k[3]+2399980690&4294967295,O=E+(M<<10&4294967295|M>>>22),M=L+(E^(O|~S))+k[10]+4293915773&4294967295,L=O+(M<<15&4294967295|M>>>17),M=S+(O^(L|~E))+k[1]+2240044497&4294967295,S=L+(M<<21&4294967295|M>>>11),M=E+(L^(S|~O))+k[8]+1873313359&4294967295,E=S+(M<<6&4294967295|M>>>26),M=O+(S^(E|~L))+k[15]+4264355552&4294967295,O=E+(M<<10&4294967295|M>>>22),M=L+(E^(O|~S))+k[6]+2734768916&4294967295,L=O+(M<<15&4294967295|M>>>17),M=S+(O^(L|~E))+k[13]+1309151649&4294967295,S=L+(M<<21&4294967295|M>>>11),M=E+(L^(S|~O))+k[4]+4149444226&4294967295,E=S+(M<<6&4294967295|M>>>26),M=O+(S^(E|~L))+k[11]+3174756917&4294967295,O=E+(M<<10&4294967295|M>>>22),M=L+(E^(O|~S))+k[2]+718787259&4294967295,L=O+(M<<15&4294967295|M>>>17),M=S+(O^(L|~E))+k[9]+3951481745&4294967295,D.g[0]=D.g[0]+E&4294967295,D.g[1]=D.g[1]+(L+(M<<21&4294967295|M>>>11))&4294967295,D.g[2]=D.g[2]+L&4294967295,D.g[3]=D.g[3]+O&4294967295}i.prototype.u=function(D,E){E===void 0&&(E=D.length);for(var S=E-this.blockSize,k=this.B,L=this.h,O=0;O<E;){if(L==0)for(;O<=S;)n(this,D,O),O+=this.blockSize;if(typeof D=="string"){for(;O<E;)if(k[L++]=D.charCodeAt(O++),L==this.blockSize){n(this,k),L=0;break}}else for(;O<E;)if(k[L++]=D[O++],L==this.blockSize){n(this,k),L=0;break}}this.h=L,this.o+=E},i.prototype.v=function(){var D=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);D[0]=128;for(var E=1;E<D.length-8;++E)D[E]=0;var S=8*this.o;for(E=D.length-8;E<D.length;++E)D[E]=S&255,S/=256;for(this.u(D),D=Array(16),E=S=0;4>E;++E)for(var k=0;32>k;k+=8)D[S++]=this.g[E]>>>k&255;return D};function r(D,E){var S=a;return Object.prototype.hasOwnProperty.call(S,D)?S[D]:S[D]=E(D)}function o(D,E){this.h=E;for(var S=[],k=!0,L=D.length-1;0<=L;L--){var O=D[L]|0;k&&O==E||(S[L]=O,k=!1)}this.g=S}var a={};function c(D){return-128<=D&&128>D?r(D,function(E){return new o([E|0],0>E?-1:0)}):new o([D|0],0>D?-1:0)}function h(D){if(isNaN(D)||!isFinite(D))return l;if(0>D)return w(h(-D));for(var E=[],S=1,k=0;D>=S;k++)E[k]=D/S|0,S*=4294967296;return new o(E,0)}function d(D,E){if(D.length==0)throw Error("number format error: empty string");if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(D.charAt(0)=="-")return w(d(D.substring(1),E));if(0<=D.indexOf("-"))throw Error('number format error: interior "-" character');for(var S=h(Math.pow(E,8)),k=l,L=0;L<D.length;L+=8){var O=Math.min(8,D.length-L),M=parseInt(D.substring(L,L+O),E);8>O?(O=h(Math.pow(E,O)),k=k.j(O).add(h(M))):(k=k.j(S),k=k.add(h(M)))}return k}var l=c(0),p=c(1),f=c(16777216);s=o.prototype,s.m=function(){if(v(this))return-w(this).m();for(var D=0,E=1,S=0;S<this.g.length;S++){var k=this.i(S);D+=(0<=k?k:4294967296+k)*E,E*=4294967296}return D},s.toString=function(D){if(D=D||10,2>D||36<D)throw Error("radix out of range: "+D);if(m(this))return"0";if(v(this))return"-"+w(this).toString(D);for(var E=h(Math.pow(D,6)),S=this,k="";;){var L=H(S,E).g;S=T(S,L.j(E));var O=((0<S.g.length?S.g[0]:S.h)>>>0).toString(D);if(S=L,m(S))return O+k;for(;6>O.length;)O="0"+O;k=O+k}},s.i=function(D){return 0>D?0:D<this.g.length?this.g[D]:this.h};function m(D){if(D.h!=0)return!1;for(var E=0;E<D.g.length;E++)if(D.g[E]!=0)return!1;return!0}function v(D){return D.h==-1}s.l=function(D){return D=T(this,D),v(D)?-1:m(D)?0:1};function w(D){for(var E=D.g.length,S=[],k=0;k<E;k++)S[k]=~D.g[k];return new o(S,~D.h).add(p)}s.abs=function(){return v(this)?w(this):this},s.add=function(D){for(var E=Math.max(this.g.length,D.g.length),S=[],k=0,L=0;L<=E;L++){var O=k+(this.i(L)&65535)+(D.i(L)&65535),M=(O>>>16)+(this.i(L)>>>16)+(D.i(L)>>>16);k=M>>>16,O&=65535,M&=65535,S[L]=M<<16|O}return new o(S,S[S.length-1]&-2147483648?-1:0)};function T(D,E){return D.add(w(E))}s.j=function(D){if(m(this)||m(D))return l;if(v(this))return v(D)?w(this).j(w(D)):w(w(this).j(D));if(v(D))return w(this.j(w(D)));if(0>this.l(f)&&0>D.l(f))return h(this.m()*D.m());for(var E=this.g.length+D.g.length,S=[],k=0;k<2*E;k++)S[k]=0;for(k=0;k<this.g.length;k++)for(var L=0;L<D.g.length;L++){var O=this.i(k)>>>16,M=this.i(k)&65535,V=D.i(L)>>>16,Ce=D.i(L)&65535;S[2*k+2*L]+=M*Ce,A(S,2*k+2*L),S[2*k+2*L+1]+=O*Ce,A(S,2*k+2*L+1),S[2*k+2*L+1]+=M*V,A(S,2*k+2*L+1),S[2*k+2*L+2]+=O*V,A(S,2*k+2*L+2)}for(k=0;k<E;k++)S[k]=S[2*k+1]<<16|S[2*k];for(k=E;k<2*E;k++)S[k]=0;return new o(S,0)};function A(D,E){for(;(D[E]&65535)!=D[E];)D[E+1]+=D[E]>>>16,D[E]&=65535,E++}function F(D,E){this.g=D,this.h=E}function H(D,E){if(m(E))throw Error("division by zero");if(m(D))return new F(l,l);if(v(D))return E=H(w(D),E),new F(w(E.g),w(E.h));if(v(E))return E=H(D,w(E)),new F(w(E.g),E.h);if(30<D.g.length){if(v(D)||v(E))throw Error("slowDivide_ only works with positive integers.");for(var S=p,k=E;0>=k.l(D);)S=q(S),k=q(k);var L=J(S,1),O=J(k,1);for(k=J(k,2),S=J(S,2);!m(k);){var M=O.add(k);0>=M.l(D)&&(L=L.add(S),O=M),k=J(k,1),S=J(S,1)}return E=T(D,L.j(E)),new F(L,E)}for(L=l;0<=D.l(E);){for(S=Math.max(1,Math.floor(D.m()/E.m())),k=Math.ceil(Math.log(S)/Math.LN2),k=48>=k?1:Math.pow(2,k-48),O=h(S),M=O.j(E);v(M)||0<M.l(D);)S-=k,O=h(S),M=O.j(E);m(O)&&(O=p),L=L.add(O),D=T(D,M)}return new F(L,D)}s.A=function(D){return H(this,D).h},s.and=function(D){for(var E=Math.max(this.g.length,D.g.length),S=[],k=0;k<E;k++)S[k]=this.i(k)&D.i(k);return new o(S,this.h&D.h)},s.or=function(D){for(var E=Math.max(this.g.length,D.g.length),S=[],k=0;k<E;k++)S[k]=this.i(k)|D.i(k);return new o(S,this.h|D.h)},s.xor=function(D){for(var E=Math.max(this.g.length,D.g.length),S=[],k=0;k<E;k++)S[k]=this.i(k)^D.i(k);return new o(S,this.h^D.h)};function q(D){for(var E=D.g.length+1,S=[],k=0;k<E;k++)S[k]=D.i(k)<<1|D.i(k-1)>>>31;return new o(S,D.h)}function J(D,E){var S=E>>5;E%=32;for(var k=D.g.length-S,L=[],O=0;O<k;O++)L[O]=0<E?D.i(O+S)>>>E|D.i(O+S+1)<<32-E:D.i(O+S);return new o(L,D.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,qc=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=h,o.fromString=d,Wi=o}).apply(typeof wl<"u"?wl:typeof self<"u"?self:typeof window<"u"?window:{});var es=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Wc,pr,Gc,ls,Eo,Zc,Xc,Yc;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(u,g,_){return u==Array.prototype||u==Object.prototype||(u[g]=_.value),u};function e(u){u=[typeof globalThis=="object"&&globalThis,u,typeof window=="object"&&window,typeof self=="object"&&self,typeof es=="object"&&es];for(var g=0;g<u.length;++g){var _=u[g];if(_&&_.Math==Math)return _}throw Error("Cannot find global object")}var i=e(this);function n(u,g){if(g)e:{var _=i;u=u.split(".");for(var P=0;P<u.length-1;P++){var N=u[P];if(!(N in _))break e;_=_[N]}u=u[u.length-1],P=_[u],g=g(P),g!=P&&g!=null&&t(_,u,{configurable:!0,writable:!0,value:g})}}function r(u,g){u instanceof String&&(u+="");var _=0,P=!1,N={next:function(){if(!P&&_<u.length){var z=_++;return{value:g(z,u[z]),done:!1}}return P=!0,{done:!0,value:void 0}}};return N[Symbol.iterator]=function(){return N},N}n("Array.prototype.values",function(u){return u||function(){return r(this,function(g,_){return _})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function c(u){var g=typeof u;return g=g!="object"?g:u?Array.isArray(u)?"array":g:"null",g=="array"||g=="object"&&typeof u.length=="number"}function h(u){var g=typeof u;return g=="object"&&u!=null||g=="function"}function d(u,g,_){return u.call.apply(u.bind,arguments)}function l(u,g,_){if(!u)throw Error();if(2<arguments.length){var P=Array.prototype.slice.call(arguments,2);return function(){var N=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(N,P),u.apply(g,N)}}return function(){return u.apply(g,arguments)}}function p(u,g,_){return p=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:l,p.apply(null,arguments)}function f(u,g){var _=Array.prototype.slice.call(arguments,1);return function(){var P=_.slice();return P.push.apply(P,arguments),u.apply(this,P)}}function m(u,g){function _(){}_.prototype=g.prototype,u.aa=g.prototype,u.prototype=new _,u.prototype.constructor=u,u.Qb=function(P,N,z){for(var ee=Array(arguments.length-2),Ye=2;Ye<arguments.length;Ye++)ee[Ye-2]=arguments[Ye];return g.prototype[N].apply(P,ee)}}function v(u){const g=u.length;if(0<g){const _=Array(g);for(let P=0;P<g;P++)_[P]=u[P];return _}return[]}function w(u,g){for(let _=1;_<arguments.length;_++){const P=arguments[_];if(c(P)){const N=u.length||0,z=P.length||0;u.length=N+z;for(let ee=0;ee<z;ee++)u[N+ee]=P[ee]}else u.push(P)}}class T{constructor(g,_){this.i=g,this.j=_,this.h=0,this.g=null}get(){let g;return 0<this.h?(this.h--,g=this.g,this.g=g.next,g.next=null):g=this.i(),g}}function A(u){return/^[\s\xa0]*$/.test(u)}function F(){var u=a.navigator;return u&&(u=u.userAgent)?u:""}function H(u){return H[" "](u),u}H[" "]=function(){};var q=F().indexOf("Gecko")!=-1&&!(F().toLowerCase().indexOf("webkit")!=-1&&F().indexOf("Edge")==-1)&&!(F().indexOf("Trident")!=-1||F().indexOf("MSIE")!=-1)&&F().indexOf("Edge")==-1;function J(u,g,_){for(const P in u)g.call(_,u[P],P,u)}function D(u,g){for(const _ in u)g.call(void 0,u[_],_,u)}function E(u){const g={};for(const _ in u)g[_]=u[_];return g}const S="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function k(u,g){let _,P;for(let N=1;N<arguments.length;N++){P=arguments[N];for(_ in P)u[_]=P[_];for(let z=0;z<S.length;z++)_=S[z],Object.prototype.hasOwnProperty.call(P,_)&&(u[_]=P[_])}}function L(u){var g=1;u=u.split(":");const _=[];for(;0<g&&u.length;)_.push(u.shift()),g--;return u.length&&_.push(u.join(":")),_}function O(u){a.setTimeout(()=>{throw u},0)}function M(){var u=Te;let g=null;return u.g&&(g=u.g,u.g=u.g.next,u.g||(u.h=null),g.next=null),g}class V{constructor(){this.h=this.g=null}add(g,_){const P=Ce.get();P.set(g,_),this.h?this.h.next=P:this.g=P,this.h=P}}var Ce=new T(()=>new Ie,u=>u.reset());class Ie{constructor(){this.next=this.g=this.h=null}set(g,_){this.h=g,this.g=_,this.next=null}reset(){this.next=this.g=this.h=null}}let Oe,ne=!1,Te=new V,Se=()=>{const u=a.Promise.resolve(void 0);Oe=()=>{u.then(dt)}};var dt=()=>{for(var u;u=M();){try{u.h.call(u.g)}catch(_){O(_)}var g=Ce;g.j(u),100>g.h&&(g.h++,u.next=g.g,g.g=u)}ne=!1};function We(){this.s=this.s,this.C=this.C}We.prototype.s=!1,We.prototype.ma=function(){this.s||(this.s=!0,this.N())},We.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function te(u,g){this.type=u,this.g=this.target=g,this.defaultPrevented=!1}te.prototype.h=function(){this.defaultPrevented=!0};var ct=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var u=!1,g=Object.defineProperty({},"passive",{get:function(){u=!0}});try{const _=()=>{};a.addEventListener("test",_,g),a.removeEventListener("test",_,g)}catch{}return u}();function rt(u,g){if(te.call(this,u?u.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,u){var _=this.type=u.type,P=u.changedTouches&&u.changedTouches.length?u.changedTouches[0]:null;if(this.target=u.target||u.srcElement,this.g=g,g=u.relatedTarget){if(q){e:{try{H(g.nodeName);var N=!0;break e}catch{}N=!1}N||(g=null)}}else _=="mouseover"?g=u.fromElement:_=="mouseout"&&(g=u.toElement);this.relatedTarget=g,P?(this.clientX=P.clientX!==void 0?P.clientX:P.pageX,this.clientY=P.clientY!==void 0?P.clientY:P.pageY,this.screenX=P.screenX||0,this.screenY=P.screenY||0):(this.clientX=u.clientX!==void 0?u.clientX:u.pageX,this.clientY=u.clientY!==void 0?u.clientY:u.pageY,this.screenX=u.screenX||0,this.screenY=u.screenY||0),this.button=u.button,this.key=u.key||"",this.ctrlKey=u.ctrlKey,this.altKey=u.altKey,this.shiftKey=u.shiftKey,this.metaKey=u.metaKey,this.pointerId=u.pointerId||0,this.pointerType=typeof u.pointerType=="string"?u.pointerType:Kt[u.pointerType]||"",this.state=u.state,this.i=u,u.defaultPrevented&&rt.aa.h.call(this)}}m(rt,te);var Kt={2:"touch",3:"pen",4:"mouse"};rt.prototype.h=function(){rt.aa.h.call(this);var u=this.i;u.preventDefault?u.preventDefault():u.returnValue=!1};var St="closure_listenable_"+(1e6*Math.random()|0),ei=0;function xi(u,g,_,P,N){this.listener=u,this.proxy=null,this.src=g,this.type=_,this.capture=!!P,this.ha=N,this.key=++ei,this.da=this.fa=!1}function qt(u){u.da=!0,u.listener=null,u.proxy=null,u.src=null,u.ha=null}function kt(u){this.src=u,this.g={},this.h=0}kt.prototype.add=function(u,g,_,P,N){var z=u.toString();u=this.g[z],u||(u=this.g[z]=[],this.h++);var ee=Wt(u,g,P,N);return-1<ee?(g=u[ee],_||(g.fa=!1)):(g=new xi(g,this.src,z,!!P,N),g.fa=_,u.push(g)),g};function Ot(u,g){var _=g.type;if(_ in u.g){var P=u.g[_],N=Array.prototype.indexOf.call(P,g,void 0),z;(z=0<=N)&&Array.prototype.splice.call(P,N,1),z&&(qt(g),u.g[_].length==0&&(delete u.g[_],u.h--))}}function Wt(u,g,_,P){for(var N=0;N<u.length;++N){var z=u[N];if(!z.da&&z.listener==g&&z.capture==!!_&&z.ha==P)return N}return-1}var wt="closure_lm_"+(1e6*Math.random()|0),ke={};function Pt(u,g,_,P,N){if(Array.isArray(g)){for(var z=0;z<g.length;z++)Pt(u,g[z],_,P,N);return null}return _=Le(_),u&&u[St]?u.K(g,_,h(P)?!!P.capture:!1,N):y(u,g,_,!1,P,N)}function y(u,g,_,P,N,z){if(!g)throw Error("Invalid event type");var ee=h(N)?!!N.capture:!!N,Ye=Z(u);if(Ye||(u[wt]=Ye=new kt(u)),_=Ye.add(g,_,P,ee,z),_.proxy)return _;if(P=R(),_.proxy=P,P.src=u,P.listener=_,u.addEventListener)ct||(N=ee),N===void 0&&(N=!1),u.addEventListener(g.toString(),P,N);else if(u.attachEvent)u.attachEvent($(g.toString()),P);else if(u.addListener&&u.removeListener)u.addListener(P);else throw Error("addEventListener and attachEvent are unavailable.");return _}function R(){function u(_){return g.call(u.src,u.listener,_)}const g=ce;return u}function B(u,g,_,P,N){if(Array.isArray(g))for(var z=0;z<g.length;z++)B(u,g[z],_,P,N);else P=h(P)?!!P.capture:!!P,_=Le(_),u&&u[St]?(u=u.i,g=String(g).toString(),g in u.g&&(z=u.g[g],_=Wt(z,_,P,N),-1<_&&(qt(z[_]),Array.prototype.splice.call(z,_,1),z.length==0&&(delete u.g[g],u.h--)))):u&&(u=Z(u))&&(g=u.g[g.toString()],u=-1,g&&(u=Wt(g,_,P,N)),(_=-1<u?g[u]:null)&&X(_))}function X(u){if(typeof u!="number"&&u&&!u.da){var g=u.src;if(g&&g[St])Ot(g.i,u);else{var _=u.type,P=u.proxy;g.removeEventListener?g.removeEventListener(_,P,u.capture):g.detachEvent?g.detachEvent($(_),P):g.addListener&&g.removeListener&&g.removeListener(P),(_=Z(g))?(Ot(_,u),_.h==0&&(_.src=null,g[wt]=null)):qt(u)}}}function $(u){return u in ke?ke[u]:ke[u]="on"+u}function ce(u,g){if(u.da)u=!0;else{g=new rt(g,this);var _=u.listener,P=u.ha||u.src;u.fa&&X(u),u=_.call(P,g)}return u}function Z(u){return u=u[wt],u instanceof kt?u:null}var we="__closure_events_fn_"+(1e9*Math.random()>>>0);function Le(u){return typeof u=="function"?u:(u[we]||(u[we]=function(g){return u.handleEvent(g)}),u[we])}function Ae(){We.call(this),this.i=new kt(this),this.M=this,this.F=null}m(Ae,We),Ae.prototype[St]=!0,Ae.prototype.removeEventListener=function(u,g,_,P){B(this,u,g,_,P)};function he(u,g){var _,P=u.F;if(P)for(_=[];P;P=P.F)_.push(P);if(u=u.M,P=g.type||g,typeof g=="string")g=new te(g,u);else if(g instanceof te)g.target=g.target||u;else{var N=g;g=new te(P,u),k(g,N)}if(N=!0,_)for(var z=_.length-1;0<=z;z--){var ee=g.g=_[z];N=Xe(ee,P,!0,g)&&N}if(ee=g.g=u,N=Xe(ee,P,!0,g)&&N,N=Xe(ee,P,!1,g)&&N,_)for(z=0;z<_.length;z++)ee=g.g=_[z],N=Xe(ee,P,!1,g)&&N}Ae.prototype.N=function(){if(Ae.aa.N.call(this),this.i){var u=this.i,g;for(g in u.g){for(var _=u.g[g],P=0;P<_.length;P++)qt(_[P]);delete u.g[g],u.h--}}this.F=null},Ae.prototype.K=function(u,g,_,P){return this.i.add(String(u),g,!1,_,P)},Ae.prototype.L=function(u,g,_,P){return this.i.add(String(u),g,!0,_,P)};function Xe(u,g,_,P){if(g=u.i.g[String(g)],!g)return!0;g=g.concat();for(var N=!0,z=0;z<g.length;++z){var ee=g[z];if(ee&&!ee.da&&ee.capture==_){var Ye=ee.listener,At=ee.ha||ee.src;ee.fa&&Ot(u.i,ee),N=Ye.call(At,P)!==!1&&N}}return N&&!P.defaultPrevented}function x(u,g,_){if(typeof u=="function")_&&(u=p(u,_));else if(u&&typeof u.handleEvent=="function")u=p(u.handleEvent,u);else throw Error("Invalid listener argument");return 2147483647<Number(g)?-1:a.setTimeout(u,g||0)}function b(u){u.g=x(()=>{u.g=null,u.i&&(u.i=!1,b(u))},u.l);const g=u.h;u.h=null,u.m.apply(null,g)}class C extends We{constructor(g,_){super(),this.m=g,this.l=_,this.h=null,this.i=!1,this.g=null}j(g){this.h=arguments,this.g?this.i=!0:b(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function I(u){We.call(this),this.h=u,this.g={}}m(I,We);var U=[];function Q(u){J(u.g,function(g,_){this.g.hasOwnProperty(_)&&X(g)},u),u.g={}}I.prototype.N=function(){I.aa.N.call(this),Q(this)},I.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var me=a.JSON.stringify,Ne=a.JSON.parse,ve=class{stringify(u){return a.JSON.stringify(u,void 0)}parse(u){return a.JSON.parse(u,void 0)}};function pt(){}pt.prototype.h=null;function it(u){return u.h||(u.h=u.i())}function si(){}var oi={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Ei(){te.call(this,"d")}m(Ei,te);function Si(){te.call(this,"c")}m(Si,te);var pi={},ir=null;function sn(){return ir=ir||new Ae}pi.La="serverreachability";function K(u){te.call(this,pi.La,u)}m(K,te);function ue(u){const g=sn();he(g,new K(g))}pi.STAT_EVENT="statevent";function re(u,g){te.call(this,pi.STAT_EVENT,u),this.stat=g}m(re,te);function j(u){const g=sn();he(g,new re(g,u))}pi.Ma="timingevent";function oe(u,g){te.call(this,pi.Ma,u),this.size=g}m(oe,te);function ge(u,g){if(typeof u!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){u()},g)}function le(){this.g=!0}le.prototype.xa=function(){this.g=!1};function fe(u,g,_,P,N,z){u.info(function(){if(u.g)if(z)for(var ee="",Ye=z.split("&"),At=0;At<Ye.length;At++){var je=Ye[At].split("=");if(1<je.length){var Vt=je[0];je=je[1];var Bt=Vt.split("_");ee=2<=Bt.length&&Bt[1]=="type"?ee+(Vt+"="+je+"&"):ee+(Vt+"=redacted&")}}else ee=null;else ee=z;return"XMLHTTP REQ ("+P+") [attempt "+N+"]: "+g+`
`+_+`
`+ee})}function Je(u,g,_,P,N,z,ee){u.info(function(){return"XMLHTTP RESP ("+P+") [ attempt "+N+"]: "+g+`
`+_+`
`+z+" "+ee})}function ze(u,g,_,P){u.info(function(){return"XMLHTTP TEXT ("+g+"): "+jt(u,_)+(P?" "+P:"")})}function nt(u,g){u.info(function(){return"TIMEOUT: "+g})}le.prototype.info=function(){};function jt(u,g){if(!u.g)return g;if(!g)return null;try{var _=JSON.parse(g);if(_){for(u=0;u<_.length;u++)if(Array.isArray(_[u])){var P=_[u];if(!(2>P.length)){var N=P[1];if(Array.isArray(N)&&!(1>N.length)){var z=N[0];if(z!="noop"&&z!="stop"&&z!="close")for(var ee=1;ee<N.length;ee++)N[ee]=""}}}}return me(_)}catch{return g}}var ot={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},_t={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},at;function ht(){}m(ht,pt),ht.prototype.g=function(){return new XMLHttpRequest},ht.prototype.i=function(){return{}},at=new ht;function He(u,g,_,P){this.j=u,this.i=g,this.l=_,this.R=P||1,this.U=new I(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new ti}function ti(){this.i=null,this.g="",this.h=!1}var Ct={},Ft={};function ii(u,g,_){u.L=1,u.v=En(Qe(g)),u.m=_,u.P=!0,Li(u,null)}function Li(u,g){u.F=Date.now(),Pi(u),u.A=Qe(u.v);var _=u.A,P=u.R;Array.isArray(P)||(P=[String(P)]),Ma(_.i,"t",P),u.C=0,_=u.j.J,u.h=new ti,u.g=Qa(u.j,_?g:null,!u.m),0<u.O&&(u.M=new C(p(u.Y,u,u.g),u.O)),g=u.U,_=u.g,P=u.ca;var N="readystatechange";Array.isArray(N)||(N&&(U[0]=N.toString()),N=U);for(var z=0;z<N.length;z++){var ee=Pt(_,N[z],P||g.handleEvent,!1,g.h||g);if(!ee)break;g.g[ee.key]=ee}g=u.H?E(u.H):{},u.m?(u.u||(u.u="POST"),g["Content-Type"]="application/x-www-form-urlencoded",u.g.ea(u.A,u.u,u.m,g)):(u.u="GET",u.g.ea(u.A,u.u,null,g)),ue(),fe(u.i,u.u,u.A,u.l,u.R,u.m)}He.prototype.ca=function(u){u=u.target;const g=this.M;g&&Ii(u)==3?g.j():this.Y(u)},He.prototype.Y=function(u){try{if(u==this.g)e:{const Bt=Ii(this.g);var g=this.g.Ba();const Cn=this.g.Z();if(!(3>Bt)&&(Bt!=3||this.g&&(this.h.h||this.g.oa()||Na(this.g)))){this.J||Bt!=4||g==7||(g==8||0>=Cn?ue(3):ue(2)),Ai(this);var _=this.g.Z();this.X=_;t:if(on(this)){var P=Na(this.g);u="";var N=P.length,z=Ii(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Gt(this),fi(this);var ee="";break t}this.h.i=new a.TextDecoder}for(g=0;g<N;g++)this.h.h=!0,u+=this.h.i.decode(P[g],{stream:!(z&&g==N-1)});P.length=0,this.h.g+=u,this.C=0,ee=this.h.g}else ee=this.g.oa();if(this.o=_==200,Je(this.i,this.u,this.A,this.l,this.R,Bt,_),this.o){if(this.T&&!this.K){t:{if(this.g){var Ye,At=this.g;if((Ye=At.g?At.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!A(Ye)){var je=Ye;break t}}je=null}if(_=je)ze(this.i,this.l,_,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ri(this,_);else{this.o=!1,this.s=3,j(12),Gt(this),fi(this);break e}}if(this.P){_=!0;let ci;for(;!this.J&&this.C<ee.length;)if(ci=Tn(this,ee),ci==Ft){Bt==4&&(this.s=4,j(14),_=!1),ze(this.i,this.l,null,"[Incomplete Response]");break}else if(ci==Ct){this.s=4,j(15),ze(this.i,this.l,ee,"[Invalid Chunk]"),_=!1;break}else ze(this.i,this.l,ci,null),Ri(this,ci);if(on(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Bt!=4||ee.length!=0||this.h.h||(this.s=1,j(16),_=!1),this.o=this.o&&_,!_)ze(this.i,this.l,ee,"[Invalid Chunked Response]"),Gt(this),fi(this);else if(0<ee.length&&!this.W){this.W=!0;var Vt=this.j;Vt.g==this&&Vt.ba&&!Vt.M&&(Vt.j.info("Great, no buffering proxy detected. Bytes received: "+ee.length),to(Vt),Vt.M=!0,j(11))}}else ze(this.i,this.l,ee,null),Ri(this,ee);Bt==4&&Gt(this),this.o&&!this.J&&(Bt==4?Ga(this.j,this):(this.o=!1,Pi(this)))}else Du(this.g),_==400&&0<ee.indexOf("Unknown SID")?(this.s=3,j(12)):(this.s=0,j(13)),Gt(this),fi(this)}}}catch{}finally{}};function on(u){return u.g?u.u=="GET"&&u.L!=2&&u.j.Ca:!1}function Tn(u,g){var _=u.C,P=g.indexOf(`
`,_);return P==-1?Ft:(_=Number(g.substring(_,P)),isNaN(_)?Ct:(P+=1,P+_>g.length?Ft:(g=g.slice(P,P+_),u.C=P+_,g)))}He.prototype.cancel=function(){this.J=!0,Gt(this)};function Pi(u){u.S=Date.now()+u.I,Ci(u,u.I)}function Ci(u,g){if(u.B!=null)throw Error("WatchDog timer not null");u.B=ge(p(u.ba,u),g)}function Ai(u){u.B&&(a.clearTimeout(u.B),u.B=null)}He.prototype.ba=function(){this.B=null;const u=Date.now();0<=u-this.S?(nt(this.i,this.A),this.L!=2&&(ue(),j(17)),Gt(this),this.s=2,fi(this)):Ci(this,this.S-u)};function fi(u){u.j.G==0||u.J||Ga(u.j,u)}function Gt(u){Ai(u);var g=u.M;g&&typeof g.ma=="function"&&g.ma(),u.M=null,Q(u.U),u.g&&(g=u.g,u.g=null,g.abort(),g.ma())}function Ri(u,g){try{var _=u.j;if(_.G!=0&&(_.g==u||ai(_.h,u))){if(!u.K&&ai(_.h,u)&&_.G==3){try{var P=_.Da.g.parse(g)}catch{P=null}if(Array.isArray(P)&&P.length==3){var N=P;if(N[0]==0){e:if(!_.u){if(_.g)if(_.g.F+3e3<u.F)Zr(_),Wr(_);else break e;eo(_),j(18)}}else _.za=N[1],0<_.za-_.T&&37500>N[2]&&_.F&&_.v==0&&!_.C&&(_.C=ge(p(_.Za,_),6e3));if(1>=Vi(_.h)&&_.ca){try{_.ca()}catch{}_.ca=void 0}}else hn(_,11)}else if((u.K||_.g==u)&&Zr(_),!A(g))for(N=_.Da.g.parse(g),g=0;g<N.length;g++){let je=N[g];if(_.T=je[0],je=je[1],_.G==2)if(je[0]=="c"){_.K=je[1],_.ia=je[2];const Vt=je[3];Vt!=null&&(_.la=Vt,_.j.info("VER="+_.la));const Bt=je[4];Bt!=null&&(_.Aa=Bt,_.j.info("SVER="+_.Aa));const Cn=je[5];Cn!=null&&typeof Cn=="number"&&0<Cn&&(P=1.5*Cn,_.L=P,_.j.info("backChannelRequestTimeoutMs_="+P)),P=_;const ci=u.g;if(ci){const Yr=ci.g?ci.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Yr){var z=P.h;z.g||Yr.indexOf("spdy")==-1&&Yr.indexOf("quic")==-1&&Yr.indexOf("h2")==-1||(z.j=z.l,z.g=new Set,z.h&&(Zt(z,z.h),z.h=null))}if(P.D){const io=ci.g?ci.g.getResponseHeader("X-HTTP-Session-Id"):null;io&&(P.ya=io,Ue(P.I,P.D,io))}}_.G=3,_.l&&_.l.ua(),_.ba&&(_.R=Date.now()-u.F,_.j.info("Handshake RTT: "+_.R+"ms")),P=_;var ee=u;if(P.qa=Ya(P,P.J?P.ia:null,P.W),ee.K){ln(P.h,ee);var Ye=ee,At=P.L;At&&(Ye.I=At),Ye.B&&(Ai(Ye),Pi(Ye)),P.g=ee}else qa(P);0<_.i.length&&Gr(_)}else je[0]!="stop"&&je[0]!="close"||hn(_,7);else _.G==3&&(je[0]=="stop"||je[0]=="close"?je[0]=="stop"?hn(_,7):$s(_):je[0]!="noop"&&_.l&&_.l.ta(je),_.v=0)}}ue(4)}catch{}}var an=class{constructor(u,g){this.g=u,this.map=g}};function _e(u){this.l=u||10,a.PerformanceNavigationTiming?(u=a.performance.getEntriesByType("navigation"),u=0<u.length&&(u[0].nextHopProtocol=="hq"||u[0].nextHopProtocol=="h2")):u=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=u?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Ge(u){return u.h?!0:u.g?u.g.size>=u.j:!1}function Vi(u){return u.h?1:u.g?u.g.size:0}function ai(u,g){return u.h?u.h==g:u.g?u.g.has(g):!1}function Zt(u,g){u.g?u.g.add(g):u.h=g}function ln(u,g){u.h&&u.h==g?u.h=null:u.g&&u.g.has(g)&&u.g.delete(g)}_e.prototype.cancel=function(){if(this.i=Bi(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const u of this.g.values())u.cancel();this.g.clear()}};function Bi(u){if(u.h!=null)return u.i.concat(u.h.D);if(u.g!=null&&u.g.size!==0){let g=u.i;for(const _ of u.g.values())g=g.concat(_.D);return g}return v(u.i)}function bn(u){if(u.V&&typeof u.V=="function")return u.V();if(typeof Map<"u"&&u instanceof Map||typeof Set<"u"&&u instanceof Set)return Array.from(u.values());if(typeof u=="string")return u.split("");if(c(u)){for(var g=[],_=u.length,P=0;P<_;P++)g.push(u[P]);return g}g=[],_=0;for(P in u)g[_++]=u[P];return g}function xn(u){if(u.na&&typeof u.na=="function")return u.na();if(!u.V||typeof u.V!="function"){if(typeof Map<"u"&&u instanceof Map)return Array.from(u.keys());if(!(typeof Set<"u"&&u instanceof Set)){if(c(u)||typeof u=="string"){var g=[];u=u.length;for(var _=0;_<u;_++)g.push(_);return g}g=[],_=0;for(const P in u)g[_++]=P;return g}}}function zr(u,g){if(u.forEach&&typeof u.forEach=="function")u.forEach(g,void 0);else if(c(u)||typeof u=="string")Array.prototype.forEach.call(u,g,void 0);else for(var _=xn(u),P=bn(u),N=P.length,z=0;z<N;z++)g.call(void 0,P[z],_&&_[z],u)}var nr=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function rr(u,g){if(u){u=u.split("&");for(var _=0;_<u.length;_++){var P=u[_].indexOf("="),N=null;if(0<=P){var z=u[_].substring(0,P);N=u[_].substring(P+1)}else z=u[_];g(z,N?decodeURIComponent(N.replace(/\+/g," ")):"")}}}function xe(u){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,u instanceof xe){this.h=u.h,Lt(this,u.j),this.o=u.o,this.g=u.g,li(this,u.s),this.l=u.l;var g=u.i,_=new sr;_.i=g.i,g.g&&(_.g=new Map(g.g),_.h=g.h),xt(this,_),this.m=u.m}else u&&(g=String(u).match(nr))?(this.h=!1,Lt(this,g[1]||"",!0),this.o=cn(g[2]||""),this.g=cn(g[3]||"",!0),li(this,g[4]),this.l=cn(g[5]||"",!0),xt(this,g[6]||"",!0),this.m=cn(g[7]||"")):(this.h=!1,this.i=new sr(null,this.h))}xe.prototype.toString=function(){var u=[],g=this.j;g&&u.push(Ni(g,Ra,!0),":");var _=this.g;return(_||g=="file")&&(u.push("//"),(g=this.o)&&u.push(Ni(g,Ra,!0),"@"),u.push(encodeURIComponent(String(_)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),_=this.s,_!=null&&u.push(":",String(_))),(_=this.l)&&(this.g&&_.charAt(0)!="/"&&u.push("/"),u.push(Ni(_,_.charAt(0)=="/"?Tu:_u,!0))),(_=this.i.toString())&&u.push("?",_),(_=this.m)&&u.push("#",Ni(_,xu)),u.join("")};function Qe(u){return new xe(u)}function Lt(u,g,_){u.j=_?cn(g,!0):g,u.j&&(u.j=u.j.replace(/:$/,""))}function li(u,g){if(g){if(g=Number(g),isNaN(g)||0>g)throw Error("Bad port number "+g);u.s=g}else u.s=null}function xt(u,g,_){g instanceof sr?(u.i=g,Eu(u.i,u.h)):(_||(g=Ni(g,bu)),u.i=new sr(g,u.h))}function Ue(u,g,_){u.i.set(g,_)}function En(u){return Ue(u,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),u}function cn(u,g){return u?g?decodeURI(u.replace(/%25/g,"%2525")):decodeURIComponent(u):""}function Ni(u,g,_){return typeof u=="string"?(u=encodeURI(u).replace(g,wu),_&&(u=u.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),u):null}function wu(u){return u=u.charCodeAt(0),"%"+(u>>4&15).toString(16)+(u&15).toString(16)}var Ra=/[#\/\?@]/g,_u=/[#\?:]/g,Tu=/[#\?]/g,bu=/[#\?@]/g,xu=/#/g;function sr(u,g){this.h=this.g=null,this.i=u||null,this.j=!!g}function Hi(u){u.g||(u.g=new Map,u.h=0,u.i&&rr(u.i,function(g,_){u.add(decodeURIComponent(g.replace(/\+/g," ")),_)}))}s=sr.prototype,s.add=function(u,g){Hi(this),this.i=null,u=Sn(this,u);var _=this.g.get(u);return _||this.g.set(u,_=[]),_.push(g),this.h+=1,this};function Ia(u,g){Hi(u),g=Sn(u,g),u.g.has(g)&&(u.i=null,u.h-=u.g.get(g).length,u.g.delete(g))}function Da(u,g){return Hi(u),g=Sn(u,g),u.g.has(g)}s.forEach=function(u,g){Hi(this),this.g.forEach(function(_,P){_.forEach(function(N){u.call(g,N,P,this)},this)},this)},s.na=function(){Hi(this);const u=Array.from(this.g.values()),g=Array.from(this.g.keys()),_=[];for(let P=0;P<g.length;P++){const N=u[P];for(let z=0;z<N.length;z++)_.push(g[P])}return _},s.V=function(u){Hi(this);let g=[];if(typeof u=="string")Da(this,u)&&(g=g.concat(this.g.get(Sn(this,u))));else{u=Array.from(this.g.values());for(let _=0;_<u.length;_++)g=g.concat(u[_])}return g},s.set=function(u,g){return Hi(this),this.i=null,u=Sn(this,u),Da(this,u)&&(this.h-=this.g.get(u).length),this.g.set(u,[g]),this.h+=1,this},s.get=function(u,g){return u?(u=this.V(u),0<u.length?String(u[0]):g):g};function Ma(u,g,_){Ia(u,g),0<_.length&&(u.i=null,u.g.set(Sn(u,g),v(_)),u.h+=_.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const u=[],g=Array.from(this.g.keys());for(var _=0;_<g.length;_++){var P=g[_];const z=encodeURIComponent(String(P)),ee=this.V(P);for(P=0;P<ee.length;P++){var N=z;ee[P]!==""&&(N+="="+encodeURIComponent(String(ee[P]))),u.push(N)}}return this.i=u.join("&")};function Sn(u,g){return g=String(g),u.j&&(g=g.toLowerCase()),g}function Eu(u,g){g&&!u.j&&(Hi(u),u.i=null,u.g.forEach(function(_,P){var N=P.toLowerCase();P!=N&&(Ia(this,P),Ma(this,N,_))},u)),u.j=g}function Su(u,g){const _=new le;if(a.Image){const P=new Image;P.onload=f(zi,_,"TestLoadImage: loaded",!0,g,P),P.onerror=f(zi,_,"TestLoadImage: error",!1,g,P),P.onabort=f(zi,_,"TestLoadImage: abort",!1,g,P),P.ontimeout=f(zi,_,"TestLoadImage: timeout",!1,g,P),a.setTimeout(function(){P.ontimeout&&P.ontimeout()},1e4),P.src=u}else g(!1)}function Pu(u,g){const _=new le,P=new AbortController,N=setTimeout(()=>{P.abort(),zi(_,"TestPingServer: timeout",!1,g)},1e4);fetch(u,{signal:P.signal}).then(z=>{clearTimeout(N),z.ok?zi(_,"TestPingServer: ok",!0,g):zi(_,"TestPingServer: server error",!1,g)}).catch(()=>{clearTimeout(N),zi(_,"TestPingServer: error",!1,g)})}function zi(u,g,_,P,N){try{N&&(N.onload=null,N.onerror=null,N.onabort=null,N.ontimeout=null),P(_)}catch{}}function Cu(){this.g=new ve}function Au(u,g,_){const P=_||"";try{zr(u,function(N,z){let ee=N;h(N)&&(ee=me(N)),g.push(P+z+"="+encodeURIComponent(ee))})}catch(N){throw g.push(P+"type="+encodeURIComponent("_badmap")),N}}function Ur(u){this.l=u.Ub||null,this.j=u.eb||!1}m(Ur,pt),Ur.prototype.g=function(){return new jr(this.l,this.j)},Ur.prototype.i=function(u){return function(){return u}}({});function jr(u,g){Ae.call(this),this.D=u,this.o=g,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}m(jr,Ae),s=jr.prototype,s.open=function(u,g){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=u,this.A=g,this.readyState=1,ar(this)},s.send=function(u){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const g={headers:this.u,method:this.B,credentials:this.m,cache:void 0};u&&(g.body=u),(this.D||a).fetch(new Request(this.A,g)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,or(this)),this.readyState=0},s.Sa=function(u){if(this.g&&(this.l=u,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=u.headers,this.readyState=2,ar(this)),this.g&&(this.readyState=3,ar(this),this.g)))if(this.responseType==="arraybuffer")u.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in u){if(this.j=u.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;ka(this)}else u.text().then(this.Ra.bind(this),this.ga.bind(this))};function ka(u){u.j.read().then(u.Pa.bind(u)).catch(u.ga.bind(u))}s.Pa=function(u){if(this.g){if(this.o&&u.value)this.response.push(u.value);else if(!this.o){var g=u.value?u.value:new Uint8Array(0);(g=this.v.decode(g,{stream:!u.done}))&&(this.response=this.responseText+=g)}u.done?or(this):ar(this),this.readyState==3&&ka(this)}},s.Ra=function(u){this.g&&(this.response=this.responseText=u,or(this))},s.Qa=function(u){this.g&&(this.response=u,or(this))},s.ga=function(){this.g&&or(this)};function or(u){u.readyState=4,u.l=null,u.j=null,u.v=null,ar(u)}s.setRequestHeader=function(u,g){this.u.append(u,g)},s.getResponseHeader=function(u){return this.h&&this.h.get(u.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const u=[],g=this.h.entries();for(var _=g.next();!_.done;)_=_.value,u.push(_[0]+": "+_[1]),_=g.next();return u.join(`\r
`)};function ar(u){u.onreadystatechange&&u.onreadystatechange.call(u)}Object.defineProperty(jr.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(u){this.m=u?"include":"same-origin"}});function Oa(u){let g="";return J(u,function(_,P){g+=P,g+=":",g+=_,g+=`\r
`}),g}function Js(u,g,_){e:{for(P in _){var P=!1;break e}P=!0}P||(_=Oa(_),typeof u=="string"?_!=null&&encodeURIComponent(String(_)):Ue(u,g,_))}function lt(u){Ae.call(this),this.headers=new Map,this.o=u||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}m(lt,Ae);var Ru=/^https?$/i,Iu=["POST","PUT"];s=lt.prototype,s.Ha=function(u){this.J=u},s.ea=function(u,g,_,P){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+u);g=g?g.toUpperCase():"GET",this.D=u,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():at.g(),this.v=this.o?it(this.o):it(at),this.g.onreadystatechange=p(this.Ea,this);try{this.B=!0,this.g.open(g,String(u),!0),this.B=!1}catch(z){Fa(this,z);return}if(u=_||"",_=new Map(this.headers),P)if(Object.getPrototypeOf(P)===Object.prototype)for(var N in P)_.set(N,P[N]);else if(typeof P.keys=="function"&&typeof P.get=="function")for(const z of P.keys())_.set(z,P.get(z));else throw Error("Unknown input type for opt_headers: "+String(P));P=Array.from(_.keys()).find(z=>z.toLowerCase()=="content-type"),N=a.FormData&&u instanceof a.FormData,!(0<=Array.prototype.indexOf.call(Iu,g,void 0))||P||N||_.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[z,ee]of _)this.g.setRequestHeader(z,ee);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Ba(this),this.u=!0,this.g.send(u),this.u=!1}catch(z){Fa(this,z)}};function Fa(u,g){u.h=!1,u.g&&(u.j=!0,u.g.abort(),u.j=!1),u.l=g,u.m=5,La(u),qr(u)}function La(u){u.A||(u.A=!0,he(u,"complete"),he(u,"error"))}s.abort=function(u){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=u||7,he(this,"complete"),he(this,"abort"),qr(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),qr(this,!0)),lt.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?Va(this):this.bb())},s.bb=function(){Va(this)};function Va(u){if(u.h&&typeof o<"u"&&(!u.v[1]||Ii(u)!=4||u.Z()!=2)){if(u.u&&Ii(u)==4)x(u.Ea,0,u);else if(he(u,"readystatechange"),Ii(u)==4){u.h=!1;try{const ee=u.Z();e:switch(ee){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var g=!0;break e;default:g=!1}var _;if(!(_=g)){var P;if(P=ee===0){var N=String(u.D).match(nr)[1]||null;!N&&a.self&&a.self.location&&(N=a.self.location.protocol.slice(0,-1)),P=!Ru.test(N?N.toLowerCase():"")}_=P}if(_)he(u,"complete"),he(u,"success");else{u.m=6;try{var z=2<Ii(u)?u.g.statusText:""}catch{z=""}u.l=z+" ["+u.Z()+"]",La(u)}}finally{qr(u)}}}}function qr(u,g){if(u.g){Ba(u);const _=u.g,P=u.v[0]?()=>{}:null;u.g=null,u.v=null,g||he(u,"ready");try{_.onreadystatechange=P}catch{}}}function Ba(u){u.I&&(a.clearTimeout(u.I),u.I=null)}s.isActive=function(){return!!this.g};function Ii(u){return u.g?u.g.readyState:0}s.Z=function(){try{return 2<Ii(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(u){if(this.g){var g=this.g.responseText;return u&&g.indexOf(u)==0&&(g=g.substring(u.length)),Ne(g)}};function Na(u){try{if(!u.g)return null;if("response"in u.g)return u.g.response;switch(u.H){case"":case"text":return u.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in u.g)return u.g.mozResponseArrayBuffer}return null}catch{return null}}function Du(u){const g={};u=(u.g&&2<=Ii(u)&&u.g.getAllResponseHeaders()||"").split(`\r
`);for(let P=0;P<u.length;P++){if(A(u[P]))continue;var _=L(u[P]);const N=_[0];if(_=_[1],typeof _!="string")continue;_=_.trim();const z=g[N]||[];g[N]=z,z.push(_)}D(g,function(P){return P.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function lr(u,g,_){return _&&_.internalChannelParams&&_.internalChannelParams[u]||g}function Ha(u){this.Aa=0,this.i=[],this.j=new le,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=lr("failFast",!1,u),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=lr("baseRetryDelayMs",5e3,u),this.cb=lr("retryDelaySeedMs",1e4,u),this.Wa=lr("forwardChannelMaxRetries",2,u),this.wa=lr("forwardChannelRequestTimeoutMs",2e4,u),this.pa=u&&u.xmlHttpFactory||void 0,this.Xa=u&&u.Tb||void 0,this.Ca=u&&u.useFetchStreams||!1,this.L=void 0,this.J=u&&u.supportsCrossDomainXhr||!1,this.K="",this.h=new _e(u&&u.concurrentRequestLimit),this.Da=new Cu,this.P=u&&u.fastHandshake||!1,this.O=u&&u.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=u&&u.Rb||!1,u&&u.xa&&this.j.xa(),u&&u.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&u&&u.detectBufferingProxy||!1,this.ja=void 0,u&&u.longPollingTimeout&&0<u.longPollingTimeout&&(this.ja=u.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=Ha.prototype,s.la=8,s.G=1,s.connect=function(u,g,_,P){j(0),this.W=u,this.H=g||{},_&&P!==void 0&&(this.H.OSID=_,this.H.OAID=P),this.F=this.X,this.I=Ya(this,null,this.W),Gr(this)};function $s(u){if(za(u),u.G==3){var g=u.U++,_=Qe(u.I);if(Ue(_,"SID",u.K),Ue(_,"RID",g),Ue(_,"TYPE","terminate"),cr(u,_),g=new He(u,u.j,g),g.L=2,g.v=En(Qe(_)),_=!1,a.navigator&&a.navigator.sendBeacon)try{_=a.navigator.sendBeacon(g.v.toString(),"")}catch{}!_&&a.Image&&(new Image().src=g.v,_=!0),_||(g.g=Qa(g.j,null),g.g.ea(g.v)),g.F=Date.now(),Pi(g)}Xa(u)}function Wr(u){u.g&&(to(u),u.g.cancel(),u.g=null)}function za(u){Wr(u),u.u&&(a.clearTimeout(u.u),u.u=null),Zr(u),u.h.cancel(),u.s&&(typeof u.s=="number"&&a.clearTimeout(u.s),u.s=null)}function Gr(u){if(!Ge(u.h)&&!u.s){u.s=!0;var g=u.Ga;Oe||Se(),ne||(Oe(),ne=!0),Te.add(g,u),u.B=0}}function Mu(u,g){return Vi(u.h)>=u.h.j-(u.s?1:0)?!1:u.s?(u.i=g.D.concat(u.i),!0):u.G==1||u.G==2||u.B>=(u.Va?0:u.Wa)?!1:(u.s=ge(p(u.Ga,u,g),Za(u,u.B)),u.B++,!0)}s.Ga=function(u){if(this.s)if(this.s=null,this.G==1){if(!u){this.U=Math.floor(1e5*Math.random()),u=this.U++;const N=new He(this,this.j,u);let z=this.o;if(this.S&&(z?(z=E(z),k(z,this.S)):z=this.S),this.m!==null||this.O||(N.H=z,z=null),this.P)e:{for(var g=0,_=0;_<this.i.length;_++){t:{var P=this.i[_];if("__data__"in P.map&&(P=P.map.__data__,typeof P=="string")){P=P.length;break t}P=void 0}if(P===void 0)break;if(g+=P,4096<g){g=_;break e}if(g===4096||_===this.i.length-1){g=_+1;break e}}g=1e3}else g=1e3;g=ja(this,N,g),_=Qe(this.I),Ue(_,"RID",u),Ue(_,"CVER",22),this.D&&Ue(_,"X-HTTP-Session-Id",this.D),cr(this,_),z&&(this.O?g="headers="+encodeURIComponent(String(Oa(z)))+"&"+g:this.m&&Js(_,this.m,z)),Zt(this.h,N),this.Ua&&Ue(_,"TYPE","init"),this.P?(Ue(_,"$req",g),Ue(_,"SID","null"),N.T=!0,ii(N,_,null)):ii(N,_,g),this.G=2}}else this.G==3&&(u?Ua(this,u):this.i.length==0||Ge(this.h)||Ua(this))};function Ua(u,g){var _;g?_=g.l:_=u.U++;const P=Qe(u.I);Ue(P,"SID",u.K),Ue(P,"RID",_),Ue(P,"AID",u.T),cr(u,P),u.m&&u.o&&Js(P,u.m,u.o),_=new He(u,u.j,_,u.B+1),u.m===null&&(_.H=u.o),g&&(u.i=g.D.concat(u.i)),g=ja(u,_,1e3),_.I=Math.round(.5*u.wa)+Math.round(.5*u.wa*Math.random()),Zt(u.h,_),ii(_,P,g)}function cr(u,g){u.H&&J(u.H,function(_,P){Ue(g,P,_)}),u.l&&zr({},function(_,P){Ue(g,P,_)})}function ja(u,g,_){_=Math.min(u.i.length,_);var P=u.l?p(u.l.Na,u.l,u):null;e:{var N=u.i;let z=-1;for(;;){const ee=["count="+_];z==-1?0<_?(z=N[0].g,ee.push("ofs="+z)):z=0:ee.push("ofs="+z);let Ye=!0;for(let At=0;At<_;At++){let je=N[At].g;const Vt=N[At].map;if(je-=z,0>je)z=Math.max(0,N[At].g-100),Ye=!1;else try{Au(Vt,ee,"req"+je+"_")}catch{P&&P(Vt)}}if(Ye){P=ee.join("&");break e}}}return u=u.i.splice(0,_),g.D=u,P}function qa(u){if(!u.g&&!u.u){u.Y=1;var g=u.Fa;Oe||Se(),ne||(Oe(),ne=!0),Te.add(g,u),u.v=0}}function eo(u){return u.g||u.u||3<=u.v?!1:(u.Y++,u.u=ge(p(u.Fa,u),Za(u,u.v)),u.v++,!0)}s.Fa=function(){if(this.u=null,Wa(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var u=2*this.R;this.j.info("BP detection timer enabled: "+u),this.A=ge(p(this.ab,this),u)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,j(10),Wr(this),Wa(this))};function to(u){u.A!=null&&(a.clearTimeout(u.A),u.A=null)}function Wa(u){u.g=new He(u,u.j,"rpc",u.Y),u.m===null&&(u.g.H=u.o),u.g.O=0;var g=Qe(u.qa);Ue(g,"RID","rpc"),Ue(g,"SID",u.K),Ue(g,"AID",u.T),Ue(g,"CI",u.F?"0":"1"),!u.F&&u.ja&&Ue(g,"TO",u.ja),Ue(g,"TYPE","xmlhttp"),cr(u,g),u.m&&u.o&&Js(g,u.m,u.o),u.L&&(u.g.I=u.L);var _=u.g;u=u.ia,_.L=1,_.v=En(Qe(g)),_.m=null,_.P=!0,Li(_,u)}s.Za=function(){this.C!=null&&(this.C=null,Wr(this),eo(this),j(19))};function Zr(u){u.C!=null&&(a.clearTimeout(u.C),u.C=null)}function Ga(u,g){var _=null;if(u.g==g){Zr(u),to(u),u.g=null;var P=2}else if(ai(u.h,g))_=g.D,ln(u.h,g),P=1;else return;if(u.G!=0){if(g.o)if(P==1){_=g.m?g.m.length:0,g=Date.now()-g.F;var N=u.B;P=sn(),he(P,new oe(P,_)),Gr(u)}else qa(u);else if(N=g.s,N==3||N==0&&0<g.X||!(P==1&&Mu(u,g)||P==2&&eo(u)))switch(_&&0<_.length&&(g=u.h,g.i=g.i.concat(_)),N){case 1:hn(u,5);break;case 4:hn(u,10);break;case 3:hn(u,6);break;default:hn(u,2)}}}function Za(u,g){let _=u.Ta+Math.floor(Math.random()*u.cb);return u.isActive()||(_*=2),_*g}function hn(u,g){if(u.j.info("Error code "+g),g==2){var _=p(u.fb,u),P=u.Xa;const N=!P;P=new xe(P||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||Lt(P,"https"),En(P),N?Su(P.toString(),_):Pu(P.toString(),_)}else j(2);u.G=0,u.l&&u.l.sa(g),Xa(u),za(u)}s.fb=function(u){u?(this.j.info("Successfully pinged google.com"),j(2)):(this.j.info("Failed to ping google.com"),j(1))};function Xa(u){if(u.G=0,u.ka=[],u.l){const g=Bi(u.h);(g.length!=0||u.i.length!=0)&&(w(u.ka,g),w(u.ka,u.i),u.h.i.length=0,v(u.i),u.i.length=0),u.l.ra()}}function Ya(u,g,_){var P=_ instanceof xe?Qe(_):new xe(_);if(P.g!="")g&&(P.g=g+"."+P.g),li(P,P.s);else{var N=a.location;P=N.protocol,g=g?g+"."+N.hostname:N.hostname,N=+N.port;var z=new xe(null);P&&Lt(z,P),g&&(z.g=g),N&&li(z,N),_&&(z.l=_),P=z}return _=u.D,g=u.ya,_&&g&&Ue(P,_,g),Ue(P,"VER",u.la),cr(u,P),P}function Qa(u,g,_){if(g&&!u.J)throw Error("Can't create secondary domain capable XhrIo object.");return g=u.Ca&&!u.pa?new lt(new Ur({eb:_})):new lt(u.pa),g.Ha(u.J),g}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function Ka(){}s=Ka.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function Xr(){}Xr.prototype.g=function(u,g){return new Jt(u,g)};function Jt(u,g){Ae.call(this),this.g=new Ha(g),this.l=u,this.h=g&&g.messageUrlParams||null,u=g&&g.messageHeaders||null,g&&g.clientProtocolHeaderRequired&&(u?u["X-Client-Protocol"]="webchannel":u={"X-Client-Protocol":"webchannel"}),this.g.o=u,u=g&&g.initMessageHeaders||null,g&&g.messageContentType&&(u?u["X-WebChannel-Content-Type"]=g.messageContentType:u={"X-WebChannel-Content-Type":g.messageContentType}),g&&g.va&&(u?u["X-WebChannel-Client-Profile"]=g.va:u={"X-WebChannel-Client-Profile":g.va}),this.g.S=u,(u=g&&g.Sb)&&!A(u)&&(this.g.m=u),this.v=g&&g.supportsCrossDomainXhr||!1,this.u=g&&g.sendRawJson||!1,(g=g&&g.httpSessionIdParam)&&!A(g)&&(this.g.D=g,u=this.h,u!==null&&g in u&&(u=this.h,g in u&&delete u[g])),this.j=new Pn(this)}m(Jt,Ae),Jt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Jt.prototype.close=function(){$s(this.g)},Jt.prototype.o=function(u){var g=this.g;if(typeof u=="string"){var _={};_.__data__=u,u=_}else this.u&&(_={},_.__data__=me(u),u=_);g.i.push(new an(g.Ya++,u)),g.G==3&&Gr(g)},Jt.prototype.N=function(){this.g.l=null,delete this.j,$s(this.g),delete this.g,Jt.aa.N.call(this)};function Ja(u){Ei.call(this),u.__headers__&&(this.headers=u.__headers__,this.statusCode=u.__status__,delete u.__headers__,delete u.__status__);var g=u.__sm__;if(g){e:{for(const _ in g){u=_;break e}u=void 0}(this.i=u)&&(u=this.i,g=g!==null&&u in g?g[u]:void 0),this.data=g}else this.data=u}m(Ja,Ei);function $a(){Si.call(this),this.status=1}m($a,Si);function Pn(u){this.g=u}m(Pn,Ka),Pn.prototype.ua=function(){he(this.g,"a")},Pn.prototype.ta=function(u){he(this.g,new Ja(u))},Pn.prototype.sa=function(u){he(this.g,new $a)},Pn.prototype.ra=function(){he(this.g,"b")},Xr.prototype.createWebChannel=Xr.prototype.g,Jt.prototype.send=Jt.prototype.o,Jt.prototype.open=Jt.prototype.m,Jt.prototype.close=Jt.prototype.close,Yc=function(){return new Xr},Xc=function(){return sn()},Zc=pi,Eo={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},ot.NO_ERROR=0,ot.TIMEOUT=8,ot.HTTP_ERROR=6,ls=ot,_t.COMPLETE="complete",Gc=_t,si.EventType=oi,oi.OPEN="a",oi.CLOSE="b",oi.ERROR="c",oi.MESSAGE="d",Ae.prototype.listen=Ae.prototype.K,pr=si,lt.prototype.listenOnce=lt.prototype.L,lt.prototype.getLastError=lt.prototype.Ka,lt.prototype.getLastErrorCode=lt.prototype.Ba,lt.prototype.getStatus=lt.prototype.Z,lt.prototype.getResponseJson=lt.prototype.Oa,lt.prototype.getResponseText=lt.prototype.oa,lt.prototype.send=lt.prototype.ea,lt.prototype.setWithCredentials=lt.prototype.Ha,Wc=lt}).apply(typeof es<"u"?es:typeof self<"u"?self:typeof window<"u"?window:{});const _l="@firebase/firestore",Tl="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ht{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Ht.UNAUTHENTICATED=new Ht(null),Ht.GOOGLE_CREDENTIALS=new Ht("google-credentials-uid"),Ht.FIRST_PARTY=new Ht("first-party-uid"),Ht.MOCK_USER=new Ht("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Kn="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gn=new Bc("@firebase/firestore");function On(){return gn.logLevel}function ae(s,...t){if(gn.logLevel<=Be.DEBUG){const e=t.map(Xo);gn.debug(`Firestore (${Kn}): ${s}`,...e)}}function Oi(s,...t){if(gn.logLevel<=Be.ERROR){const e=t.map(Xo);gn.error(`Firestore (${Kn}): ${s}`,...e)}}function Xi(s,...t){if(gn.logLevel<=Be.WARN){const e=t.map(Xo);gn.warn(`Firestore (${Kn}): ${s}`,...e)}}function Xo(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ee(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,Qc(s,i,e)}function Qc(s,t,e){let i=`FIRESTORE (${Kn}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw Oi(i),new Error(i)}function Ze(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||Qc(t,n,i)}function Re(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const W={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class se extends Qn{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fn{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kc{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Zf{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(Ht.UNAUTHENTICATED))}shutdown(){}}class Xf{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class Yf{constructor(t){this.t=t,this.currentUser=Ht.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){Ze(this.o===void 0,42304);let i=this.i;const n=c=>this.i!==i?(i=this.i,e(c)):Promise.resolve();let r=new fn;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new fn,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const c=r;t.enqueueRetryable(async()=>{await c.promise,await n(this.currentUser)})},a=c=>{ae("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(c=>a(c)),setTimeout(()=>{if(!this.auth){const c=this.t.getImmediate({optional:!0});c?a(c):(ae("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new fn)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(ae("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(Ze(typeof i.accessToken=="string",31837,{l:i}),new Kc(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return Ze(t===null||typeof t=="string",2055,{h:t}),new Ht(t)}}class Qf{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=Ht.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Kf{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new Qf(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(Ht.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class bl{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Jf{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,Mf(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){Ze(this.o===void 0,3512);const i=r=>{r.error!=null&&ae("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,ae("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{ae("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):ae("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new bl(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(Ze(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new bl(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $f(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Jc(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yo{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=$f(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function De(s,t){return s<t?-1:s>t?1:0}function So(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return De(i,n);{const r=Jc(),o=em(r.encode(xl(s,e)),r.encode(xl(t,e)));return o!==0?o:De(i,n)}}e+=i>65535?2:1}return De(s.length,t.length)}function xl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function em(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return De(s[e],t[e]);return De(s.length,t.length)}function jn(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const El="__name__";class gi{constructor(t,e,i){e===void 0?e=0:e>t.length&&Ee(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&Ee(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return gi.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof gi?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=gi.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return De(t.length,e.length)}static compareSegments(t,e){const i=gi.isNumericId(t),n=gi.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?gi.extractNumericId(t).compare(gi.extractNumericId(e)):So(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return Wi.fromString(t.substring(4,t.length-2))}}class Ke extends gi{construct(t,e,i){return new Ke(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new se(W.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new Ke(e)}static emptyPath(){return new Ke([])}}const tm=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Dt extends gi{construct(t,e,i){return new Dt(t,e,i)}static isValidIdentifier(t){return tm.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Dt.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===El}static keyField(){return new Dt([El])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new se(W.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new se(W.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const c=t[n+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new se(W.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=c,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new se(W.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Dt(e)}static emptyPath(){return new Dt([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ye{constructor(t){this.path=t}static fromPath(t){return new ye(Ke.fromString(t))}static fromName(t){return new ye(Ke.fromString(t).popFirst(5))}static empty(){return new ye(Ke.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Ke.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Ke.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ye(new Ke(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $c(s,t,e){if(!e)throw new se(W.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function im(s,t,e,i){if(t===!0&&i===!0)throw new se(W.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function Sl(s){if(!ye.isDocumentKey(s))throw new se(W.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function Pl(s){if(ye.isDocumentKey(s))throw new se(W.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function eh(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function Fs(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":Ee(12329,{type:typeof s})}function Gi(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new se(W.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=Fs(s);throw new se(W.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vt(s,t){const e={typeString:s};return t&&(e.value=t),e}function Fr(s,t){if(!eh(s))throw new se(W.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new se(W.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Cl=-62135596800,Al=1e6;class tt{static now(){return tt.fromMillis(Date.now())}static fromDate(t){return tt.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*Al);return new tt(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new se(W.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new se(W.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<Cl)throw new se(W.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new se(W.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Al}_compareTo(t){return this.seconds===t.seconds?De(this.nanoseconds,t.nanoseconds):De(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:tt._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(Fr(t,tt._jsonSchema))return new tt(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-Cl;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}tt._jsonSchemaVersion="firestore/timestamp/1.0",tt._jsonSchema={type:vt("string",tt._jsonSchemaVersion),seconds:vt("number"),nanoseconds:vt("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pe{static fromTimestamp(t){return new Pe(t)}static min(){return new Pe(new tt(0,0))}static max(){return new Pe(new tt(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pr=-1;function nm(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=Pe.fromTimestamp(i===1e9?new tt(e+1,0):new tt(e,i));return new Yi(n,ye.empty(),t)}function rm(s){return new Yi(s.readTime,s.key,Pr)}class Yi{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new Yi(Pe.min(),ye.empty(),Pr)}static max(){return new Yi(Pe.max(),ye.empty(),Pr)}}function sm(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=ye.comparator(s.documentKey,t.documentKey),e!==0?e:De(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const om="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class am{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Jn(s){if(s.code!==W.FAILED_PRECONDITION||s.message!==om)throw s;ae("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class G{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ee(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new G((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof G?e:G.resolve(e)}catch(e){return G.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):G.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):G.reject(e)}static resolve(t){return new G((e,i)=>{e(t)})}static reject(t){return new G((e,i)=>{i(t)})}static waitFor(t){return new G((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},c=>i(c))}),o=!0,r===n&&e()})}static or(t){let e=G.resolve(!1);for(const i of t)e=e.next(n=>n?G.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new G((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let c=0;c<r;c++){const h=c;e(t[h]).next(d=>{o[h]=d,++a,a===r&&i(o)},d=>n(d))}})}static doWhile(t,e){return new G((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function lm(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function $n(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ls{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}Ls.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qo=-1;function Vs(s){return s==null}function xs(s){return s===0&&1/s==-1/0}function cm(s){return typeof s=="number"&&Number.isInteger(s)&&!xs(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const th="";function hm(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=Rl(t)),t=um(s.get(e),t);return Rl(t)}function um(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case th:e+="";break;default:e+=r}}return e}function Rl(s){return s+th+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Il(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function nn(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function ih(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class st{constructor(t,e){this.comparator=t,this.root=e||It.EMPTY}insert(t,e){return new st(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,It.BLACK,null,null))}remove(t){return new st(this.comparator,this.root.remove(t,this.comparator).copy(null,null,It.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new ts(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new ts(this.root,t,this.comparator,!1)}getReverseIterator(){return new ts(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new ts(this.root,t,this.comparator,!0)}}class ts{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class It{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??It.RED,this.left=n??It.EMPTY,this.right=r??It.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new It(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return It.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return It.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,It.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,It.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ee(43730,{key:this.key,value:this.value});if(this.right.isRed())throw Ee(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw Ee(27949);return t+(this.isRed()?0:1)}}It.EMPTY=null,It.RED=!0,It.BLACK=!1;It.EMPTY=new class{constructor(){this.size=0}get key(){throw Ee(57766)}get value(){throw Ee(16141)}get color(){throw Ee(16727)}get left(){throw Ee(29726)}get right(){throw Ee(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new It(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bt{constructor(t){this.comparator=t,this.data=new st(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Dl(this.data.getIterator())}getIteratorFrom(t){return new Dl(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof bt)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new bt(this.comparator);return e.data=t,e}}class Dl{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $t{constructor(t){this.fields=t,t.sort(Dt.comparator)}static empty(){return new $t([])}unionWith(t){let e=new bt(Dt.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new $t(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return jn(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nh extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mt{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new nh("Invalid base64 string: "+r):r}}(t);return new Mt(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new Mt(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return De(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Mt.EMPTY_BYTE_STRING=new Mt("");const dm=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Qi(s){if(Ze(!!s,39018),typeof s=="string"){let t=0;const e=dm.exec(s);if(Ze(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:ut(s.seconds),nanos:ut(s.nanos)}}function ut(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function Ki(s){return typeof s=="string"?Mt.fromBase64String(s):Mt.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const rh="server_timestamp",sh="__type__",oh="__previous_value__",ah="__local_write_time__";function Ko(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[sh])===null||e===void 0?void 0:e.stringValue)===rh}function Bs(s){const t=s.mapValue.fields[oh];return Ko(t)?Bs(t):t}function Cr(s){const t=Qi(s.mapValue.fields[ah].timestampValue);return new tt(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pm{constructor(t,e,i,n,r,o,a,c,h,d){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=c,this.useFetchStreams=h,this.isUsingEmulator=d}}const Es="(default)";class Ar{constructor(t,e){this.projectId=t,this.database=e||Es}static empty(){return new Ar("","")}get isDefaultDatabase(){return this.database===Es}isEqual(t){return t instanceof Ar&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lh="__type__",fm="__max__",is={mapValue:{}},ch="__vector__",Ss="value";function Ji(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?Ko(s)?4:gm(s)?9007199254740991:mm(s)?10:11:Ee(28295,{value:s})}function bi(s,t){if(s===t)return!0;const e=Ji(s);if(e!==Ji(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return Cr(s).isEqual(Cr(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=Qi(n.timestampValue),a=Qi(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return Ki(n.bytesValue).isEqual(Ki(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return ut(n.geoPointValue.latitude)===ut(r.geoPointValue.latitude)&&ut(n.geoPointValue.longitude)===ut(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return ut(n.integerValue)===ut(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=ut(n.doubleValue),a=ut(r.doubleValue);return o===a?xs(o)===xs(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return jn(s.arrayValue.values||[],t.arrayValue.values||[],bi);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(Il(o)!==Il(a))return!1;for(const c in o)if(o.hasOwnProperty(c)&&(a[c]===void 0||!bi(o[c],a[c])))return!1;return!0}(s,t);default:return Ee(52216,{left:s})}}function Rr(s,t){return(s.values||[]).find(e=>bi(e,t))!==void 0}function qn(s,t){if(s===t)return 0;const e=Ji(s),i=Ji(t);if(e!==i)return De(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return De(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=ut(r.integerValue||r.doubleValue),c=ut(o.integerValue||o.doubleValue);return a<c?-1:a>c?1:a===c?0:isNaN(a)?isNaN(c)?0:-1:1}(s,t);case 3:return Ml(s.timestampValue,t.timestampValue);case 4:return Ml(Cr(s),Cr(t));case 5:return So(s.stringValue,t.stringValue);case 6:return function(r,o){const a=Ki(r),c=Ki(o);return a.compareTo(c)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),c=o.split("/");for(let h=0;h<a.length&&h<c.length;h++){const d=De(a[h],c[h]);if(d!==0)return d}return De(a.length,c.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=De(ut(r.latitude),ut(o.latitude));return a!==0?a:De(ut(r.longitude),ut(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return kl(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,c,h,d;const l=r.fields||{},p=o.fields||{},f=(a=l[Ss])===null||a===void 0?void 0:a.arrayValue,m=(c=p[Ss])===null||c===void 0?void 0:c.arrayValue,v=De(((h=f==null?void 0:f.values)===null||h===void 0?void 0:h.length)||0,((d=m==null?void 0:m.values)===null||d===void 0?void 0:d.length)||0);return v!==0?v:kl(f,m)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===is.mapValue&&o===is.mapValue)return 0;if(r===is.mapValue)return 1;if(o===is.mapValue)return-1;const a=r.fields||{},c=Object.keys(a),h=o.fields||{},d=Object.keys(h);c.sort(),d.sort();for(let l=0;l<c.length&&l<d.length;++l){const p=So(c[l],d[l]);if(p!==0)return p;const f=qn(a[c[l]],h[d[l]]);if(f!==0)return f}return De(c.length,d.length)}(s.mapValue,t.mapValue);default:throw Ee(23264,{le:e})}}function Ml(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return De(s,t);const e=Qi(s),i=Qi(t),n=De(e.seconds,i.seconds);return n!==0?n:De(e.nanos,i.nanos)}function kl(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=qn(e[n],i[n]);if(r)return r}return De(e.length,i.length)}function Wn(s){return Po(s)}function Po(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=Qi(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return Ki(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return ye.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=Po(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${Po(e.fields[o])}`;return n+"}"}(s.mapValue):Ee(61005,{value:s})}function cs(s){switch(Ji(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=Bs(s);return t?16+cs(t):16;case 5:return 2*s.stringValue.length;case 6:return Ki(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+cs(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return nn(i.fields,(r,o)=>{n+=r.length+cs(o)}),n}(s.mapValue);default:throw Ee(13486,{value:s})}}function Ol(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function Co(s){return!!s&&"integerValue"in s}function Jo(s){return!!s&&"arrayValue"in s}function Fl(s){return!!s&&"nullValue"in s}function Ll(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function hs(s){return!!s&&"mapValue"in s}function mm(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[lh])===null||e===void 0?void 0:e.stringValue)===ch}function wr(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return nn(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=wr(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=wr(s.arrayValue.values[e]);return t}return Object.assign({},s)}function gm(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===fm}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qt{constructor(t){this.value=t}static empty(){return new Qt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!hs(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=wr(e)}setAll(t){let e=Dt.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const c=this.getFieldsMap(e);this.applyChanges(c,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=wr(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());hs(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return bi(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];hs(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){nn(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Qt(wr(this.value))}}function hh(s){const t=[];return nn(s.fields,(e,i)=>{const n=new Dt([e]);if(hs(i)){const r=hh(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new $t(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zt{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new zt(t,0,Pe.min(),Pe.min(),Pe.min(),Qt.empty(),0)}static newFoundDocument(t,e,i,n){return new zt(t,1,e,Pe.min(),i,n,0)}static newNoDocument(t,e){return new zt(t,2,e,Pe.min(),Pe.min(),Qt.empty(),0)}static newUnknownDocument(t,e){return new zt(t,3,e,Pe.min(),Pe.min(),Qt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(Pe.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Qt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Qt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Pe.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof zt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new zt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ps{constructor(t,e){this.position=t,this.inclusive=e}}function Vl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=ye.comparator(ye.fromName(o.referenceValue),e.key):i=qn(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function Bl(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!bi(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ir{constructor(t,e="asc"){this.field=t,this.dir=e}}function vm(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uh{}class gt extends uh{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new wm(t,e,i):e==="array-contains"?new bm(t,i):e==="in"?new xm(t,i):e==="not-in"?new Em(t,i):e==="array-contains-any"?new Sm(t,i):new gt(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new _m(t,i):new Tm(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(qn(e,this.value)):e!==null&&Ji(this.value)===Ji(e)&&this.matchesComparison(qn(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return Ee(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class di extends uh{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new di(t,e)}matches(t){return dh(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function dh(s){return s.op==="and"}function ph(s){return ym(s)&&dh(s)}function ym(s){for(const t of s.filters)if(t instanceof di)return!1;return!0}function Ao(s){if(s instanceof gt)return s.field.canonicalString()+s.op.toString()+Wn(s.value);if(ph(s))return s.filters.map(t=>Ao(t)).join(",");{const t=s.filters.map(e=>Ao(e)).join(",");return`${s.op}(${t})`}}function fh(s,t){return s instanceof gt?function(i,n){return n instanceof gt&&i.op===n.op&&i.field.isEqual(n.field)&&bi(i.value,n.value)}(s,t):s instanceof di?function(i,n){return n instanceof di&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&fh(o,n.filters[a]),!0):!1}(s,t):void Ee(19439)}function mh(s){return s instanceof gt?function(e){return`${e.field.canonicalString()} ${e.op} ${Wn(e.value)}`}(s):s instanceof di?function(e){return e.op.toString()+" {"+e.getFilters().map(mh).join(" ,")+"}"}(s):"Filter"}class wm extends gt{constructor(t,e,i){super(t,e,i),this.key=ye.fromName(i.referenceValue)}matches(t){const e=ye.comparator(t.key,this.key);return this.matchesComparison(e)}}class _m extends gt{constructor(t,e){super(t,"in",e),this.keys=gh("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class Tm extends gt{constructor(t,e){super(t,"not-in",e),this.keys=gh("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function gh(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>ye.fromName(i.referenceValue))}class bm extends gt{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Jo(e)&&Rr(e.arrayValue,this.value)}}class xm extends gt{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&Rr(this.value.arrayValue,e)}}class Em extends gt{constructor(t,e){super(t,"not-in",e)}matches(t){if(Rr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!Rr(this.value.arrayValue,e)}}class Sm extends gt{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Jo(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>Rr(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pm{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function Nl(s,t=null,e=[],i=[],n=null,r=null,o=null){return new Pm(s,t,e,i,n,r,o)}function $o(s){const t=Re(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>Ao(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),Vs(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>Wn(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>Wn(i)).join(",")),t.Pe=e}return t.Pe}function ea(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!vm(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!fh(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!Bl(s.startAt,t.startAt)&&Bl(s.endAt,t.endAt)}function Ro(s){return ye.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class er{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=c,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function Cm(s,t,e,i,n,r,o,a){return new er(s,t,e,i,n,r,o,a)}function ta(s){return new er(s)}function Hl(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function vh(s){return s.collectionGroup!==null}function _r(s){const t=Re(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new bt(Dt.comparator);return o.filters.forEach(c=>{c.getFlattenedFilters().forEach(h=>{h.isInequality()&&(a=a.add(h.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new Ir(r,i))}),e.has(Dt.keyField().canonicalString())||t.Te.push(new Ir(Dt.keyField(),i))}return t.Te}function vi(s){const t=Re(s);return t.Ie||(t.Ie=Am(t,_r(s))),t.Ie}function Am(s,t){if(s.limitType==="F")return Nl(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new Ir(n.field,r)});const e=s.endAt?new Ps(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new Ps(s.startAt.position,s.startAt.inclusive):null;return Nl(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function Io(s,t){const e=s.filters.concat([t]);return new er(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function Do(s,t,e){return new er(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function Ns(s,t){return ea(vi(s),vi(t))&&s.limitType===t.limitType}function yh(s){return`${$o(vi(s))}|lt:${s.limitType}`}function Fn(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>mh(n)).join(", ")}]`),Vs(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>Wn(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>Wn(n)).join(",")),`Target(${i})`}(vi(s))}; limitType=${s.limitType})`}function Hs(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):ye.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of _r(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,c){const h=Vl(o,a,c);return o.inclusive?h<=0:h<0}(i.startAt,_r(i),n)||i.endAt&&!function(o,a,c){const h=Vl(o,a,c);return o.inclusive?h>=0:h>0}(i.endAt,_r(i),n))}(s,t)}function Rm(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function wh(s){return(t,e)=>{let i=!1;for(const n of _r(s)){const r=Im(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function Im(s,t,e){const i=s.field.isKeyField()?ye.comparator(t.key,e.key):function(r,o,a){const c=o.data.field(r),h=a.data.field(r);return c!==null&&h!==null?qn(c,h):Ee(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return Ee(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yn{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){nn(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return ih(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Dm=new st(ye.comparator);function Fi(){return Dm}const _h=new st(ye.comparator);function fr(...s){let t=_h;for(const e of s)t=t.insert(e.key,e);return t}function Th(s){let t=_h;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function pn(){return Tr()}function bh(){return Tr()}function Tr(){return new yn(s=>s.toString(),(s,t)=>s.isEqual(t))}const Mm=new st(ye.comparator),km=new bt(ye.comparator);function Fe(...s){let t=km;for(const e of s)t=t.add(e);return t}const Om=new bt(De);function Fm(){return Om}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ia(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:xs(t)?"-0":t}}function xh(s){return{integerValue:""+s}}function Lm(s,t){return cm(t)?xh(t):ia(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zs{constructor(){this._=void 0}}function Vm(s,t,e){return s instanceof Cs?function(n,r){const o={fields:{[sh]:{stringValue:rh},[ah]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&Ko(r)&&(r=Bs(r)),r&&(o.fields[oh]=r),{mapValue:o}}(e,t):s instanceof Dr?Sh(s,t):s instanceof Mr?Ph(s,t):function(n,r){const o=Eh(n,r),a=zl(o)+zl(n.Ee);return Co(o)&&Co(n.Ee)?xh(a):ia(n.serializer,a)}(s,t)}function Bm(s,t,e){return s instanceof Dr?Sh(s,t):s instanceof Mr?Ph(s,t):e}function Eh(s,t){return s instanceof As?function(i){return Co(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class Cs extends zs{}class Dr extends zs{constructor(t){super(),this.elements=t}}function Sh(s,t){const e=Ch(t);for(const i of s.elements)e.some(n=>bi(n,i))||e.push(i);return{arrayValue:{values:e}}}class Mr extends zs{constructor(t){super(),this.elements=t}}function Ph(s,t){let e=Ch(t);for(const i of s.elements)e=e.filter(n=>!bi(n,i));return{arrayValue:{values:e}}}class As extends zs{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function zl(s){return ut(s.integerValue||s.doubleValue)}function Ch(s){return Jo(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function Nm(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof Dr&&n instanceof Dr||i instanceof Mr&&n instanceof Mr?jn(i.elements,n.elements,bi):i instanceof As&&n instanceof As?bi(i.Ee,n.Ee):i instanceof Cs&&n instanceof Cs}(s.transform,t.transform)}class Hm{constructor(t,e){this.version=t,this.transformResults=e}}class ui{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new ui}static exists(t){return new ui(void 0,t)}static updateTime(t){return new ui(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function us(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class Us{}function Ah(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new na(s.key,ui.none()):new Lr(s.key,s.data,ui.none());{const e=s.data,i=Qt.empty();let n=new bt(Dt.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new rn(s.key,i,new $t(n.toArray()),ui.none())}}function zm(s,t,e){s instanceof Lr?function(n,r,o){const a=n.value.clone(),c=jl(n.fieldTransforms,r,o.transformResults);a.setAll(c),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof rn?function(n,r,o){if(!us(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=jl(n.fieldTransforms,r,o.transformResults),c=r.data;c.setAll(Rh(n)),c.setAll(a),r.convertToFoundDocument(o.version,c).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function br(s,t,e,i){return s instanceof Lr?function(r,o,a,c){if(!us(r.precondition,o))return a;const h=r.value.clone(),d=ql(r.fieldTransforms,c,o);return h.setAll(d),o.convertToFoundDocument(o.version,h).setHasLocalMutations(),null}(s,t,e,i):s instanceof rn?function(r,o,a,c){if(!us(r.precondition,o))return a;const h=ql(r.fieldTransforms,c,o),d=o.data;return d.setAll(Rh(r)),d.setAll(h),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(l=>l.field))}(s,t,e,i):function(r,o,a){return us(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function Um(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=Eh(i.transform,n||null);r!=null&&(e===null&&(e=Qt.empty()),e.set(i.field,r))}return e||null}function Ul(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&jn(i,n,(r,o)=>Nm(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class Lr extends Us{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class rn extends Us{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Rh(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function jl(s,t,e){const i=new Map;Ze(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,Bm(o,a,e[n]))}return i}function ql(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,Vm(r,o,t))}return i}class na extends Us{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class jm extends Us{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qm{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&zm(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=br(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=br(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=bh();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const c=Ah(o,a);c!==null&&i.set(n.key,c),o.isValidDocument()||o.convertToNoDocument(Pe.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Fe())}isEqual(t){return this.batchId===t.batchId&&jn(this.mutations,t.mutations,(e,i)=>Ul(e,i))&&jn(this.baseMutations,t.baseMutations,(e,i)=>Ul(e,i))}}class ra{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){Ze(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return Mm}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new ra(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wm{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gm{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ft,Ve;function Zm(s){switch(s){case W.OK:return Ee(64938);case W.CANCELLED:case W.UNKNOWN:case W.DEADLINE_EXCEEDED:case W.RESOURCE_EXHAUSTED:case W.INTERNAL:case W.UNAVAILABLE:case W.UNAUTHENTICATED:return!1;case W.INVALID_ARGUMENT:case W.NOT_FOUND:case W.ALREADY_EXISTS:case W.PERMISSION_DENIED:case W.FAILED_PRECONDITION:case W.ABORTED:case W.OUT_OF_RANGE:case W.UNIMPLEMENTED:case W.DATA_LOSS:return!0;default:return Ee(15467,{code:s})}}function Ih(s){if(s===void 0)return Oi("GRPC error has no .code"),W.UNKNOWN;switch(s){case ft.OK:return W.OK;case ft.CANCELLED:return W.CANCELLED;case ft.UNKNOWN:return W.UNKNOWN;case ft.DEADLINE_EXCEEDED:return W.DEADLINE_EXCEEDED;case ft.RESOURCE_EXHAUSTED:return W.RESOURCE_EXHAUSTED;case ft.INTERNAL:return W.INTERNAL;case ft.UNAVAILABLE:return W.UNAVAILABLE;case ft.UNAUTHENTICATED:return W.UNAUTHENTICATED;case ft.INVALID_ARGUMENT:return W.INVALID_ARGUMENT;case ft.NOT_FOUND:return W.NOT_FOUND;case ft.ALREADY_EXISTS:return W.ALREADY_EXISTS;case ft.PERMISSION_DENIED:return W.PERMISSION_DENIED;case ft.FAILED_PRECONDITION:return W.FAILED_PRECONDITION;case ft.ABORTED:return W.ABORTED;case ft.OUT_OF_RANGE:return W.OUT_OF_RANGE;case ft.UNIMPLEMENTED:return W.UNIMPLEMENTED;case ft.DATA_LOSS:return W.DATA_LOSS;default:return Ee(39323,{code:s})}}(Ve=ft||(ft={}))[Ve.OK=0]="OK",Ve[Ve.CANCELLED=1]="CANCELLED",Ve[Ve.UNKNOWN=2]="UNKNOWN",Ve[Ve.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ve[Ve.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ve[Ve.NOT_FOUND=5]="NOT_FOUND",Ve[Ve.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ve[Ve.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ve[Ve.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ve[Ve.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ve[Ve.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ve[Ve.ABORTED=10]="ABORTED",Ve[Ve.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ve[Ve.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ve[Ve.INTERNAL=13]="INTERNAL",Ve[Ve.UNAVAILABLE=14]="UNAVAILABLE",Ve[Ve.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Xm=new Wi([4294967295,4294967295],0);function Wl(s){const t=Jc().encode(s),e=new qc;return e.update(t),new Uint8Array(e.digest())}function Gl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new Wi([e,i],0),new Wi([n,r],0)]}class sa{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new mr(`Invalid padding: ${e}`);if(i<0)throw new mr(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new mr(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new mr(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=Wi.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(Wi.fromNumber(i)));return n.compare(Xm)===1&&(n=new Wi([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=Wl(t),[i,n]=Gl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new sa(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=Wl(t),[i,n]=Gl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class mr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class js{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,Vr.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new js(Pe.min(),n,new st(De),Fi(),Fe())}}class Vr{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new Vr(i,e,Fe(),Fe(),Fe())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ds{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class Dh{constructor(t,e){this.targetId=t,this.De=e}}class Mh{constructor(t,e,i=Mt.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class Zl{constructor(){this.ve=0,this.Ce=Xl(),this.Fe=Mt.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Fe(),e=Fe(),i=Fe();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:Ee(38017,{changeType:r})}}),new Vr(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Xl()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,Ze(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class Ym{constructor(t){this.We=t,this.Ge=new Map,this.ze=Fi(),this.je=ns(),this.Je=ns(),this.He=new st(De)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:Ee(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(Ro(r))if(i===0){const o=new ye(r.path);this.Xe(e,o,zt.newNoDocument(o,Pe.min()))}else Ze(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),c=a?this.ut(a,t,o):1;if(c!==0){this.rt(e);const h=c===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,h)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=Ki(i).toUint8Array()}catch(c){if(c instanceof nh)return Xi("Decoding the base64 bloom filter in existence filter failed ("+c.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw c}try{a=new sa(o,n,r)}catch(c){return Xi(c instanceof mr?"BloomFilter error: ":"Applying bloom filter failed: ",c),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&Ro(a.target)){const c=new ye(a.target.path);this.Tt(c).has(o)||this.It(o,c)||this.Xe(o,c,zt.newNoDocument(c,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Fe();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(c=>{const h=this.st(c);return!h||h.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new js(t,e,this.He,this.ze,i);return this.ze=Fi(),this.je=ns(),this.Je=ns(),this.He=new st(De),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new Zl,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new bt(De),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new bt(De),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||ae("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new Zl),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function ns(){return new st(ye.comparator)}function Xl(){return new st(ye.comparator)}const Qm={asc:"ASCENDING",desc:"DESCENDING"},Km={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Jm={and:"AND",or:"OR"};class $m{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Mo(s,t){return s.useProto3Json||Vs(t)?t:{value:t}}function Rs(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function kh(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function eg(s,t){return Rs(s,t.toTimestamp())}function yi(s){return Ze(!!s,49232),Pe.fromTimestamp(function(e){const i=Qi(e);return new tt(i.seconds,i.nanos)}(s))}function oa(s,t){return ko(s,t).canonicalString()}function ko(s,t){const e=function(n){return new Ke(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function Oh(s){const t=Ke.fromString(s);return Ze(Nh(t),10190,{key:t.toString()}),t}function Oo(s,t){return oa(s.databaseId,t.path)}function po(s,t){const e=Oh(t);if(e.get(1)!==s.databaseId.projectId)throw new se(W.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new se(W.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new ye(Lh(e))}function Fh(s,t){return oa(s.databaseId,t)}function tg(s){const t=Oh(s);return t.length===4?Ke.emptyPath():Lh(t)}function Fo(s){return new Ke(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function Lh(s){return Ze(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Yl(s,t,e){return{name:Oo(s,t),fields:e.value.mapValue.fields}}function ig(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(h){return h==="NO_CHANGE"?0:h==="ADD"?1:h==="REMOVE"?2:h==="CURRENT"?3:h==="RESET"?4:Ee(39313,{state:h})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(h,d){return h.useProto3Json?(Ze(d===void 0||typeof d=="string",58123),Mt.fromBase64String(d||"")):(Ze(d===void 0||d instanceof Buffer||d instanceof Uint8Array,16193),Mt.fromUint8Array(d||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(h){const d=h.code===void 0?W.UNKNOWN:Ih(h.code);return new se(d,h.message||"")}(o);e=new Mh(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=po(s,i.document.name),r=yi(i.document.updateTime),o=i.document.createTime?yi(i.document.createTime):Pe.min(),a=new Qt({mapValue:{fields:i.document.fields}}),c=zt.newFoundDocument(n,r,o,a),h=i.targetIds||[],d=i.removedTargetIds||[];e=new ds(h,d,c.key,c)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=po(s,i.document),r=i.readTime?yi(i.readTime):Pe.min(),o=zt.newNoDocument(n,r),a=i.removedTargetIds||[];e=new ds([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=po(s,i.document),r=i.removedTargetIds||[];e=new ds([],r,n,null)}else{if(!("filter"in t))return Ee(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new Gm(n,r),a=i.targetId;e=new Dh(a,o)}}return e}function ng(s,t){let e;if(t instanceof Lr)e={update:Yl(s,t.key,t.value)};else if(t instanceof na)e={delete:Oo(s,t.key)};else if(t instanceof rn)e={update:Yl(s,t.key,t.data),updateMask:dg(t.fieldMask)};else{if(!(t instanceof jm))return Ee(16599,{Rt:t.type});e={verify:Oo(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof Cs)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof Dr)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Mr)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof As)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw Ee(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:eg(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:Ee(27497)}(s,t.precondition)),e}function rg(s,t){return s&&s.length>0?(Ze(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?yi(n.updateTime):yi(r);return o.isEqual(Pe.min())&&(o=yi(r)),new Hm(o,n.transformResults||[])}(e,t))):[]}function sg(s,t){return{documents:[Fh(s,t.path)]}}function og(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=Fh(s,n);const r=function(h){if(h.length!==0)return Bh(di.create(h,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(h){if(h.length!==0)return h.map(d=>function(p){return{field:Ln(p.field),direction:cg(p.dir)}}(d))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=Mo(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(h){return{before:h.inclusive,values:h.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(h){return{before:!h.inclusive,values:h.position}}(t.endAt)),{Vt:e,parent:n}}function ag(s){let t=tg(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){Ze(i===1,65062);const d=e.from[0];d.allDescendants?n=d.collectionId:t=t.child(d.collectionId)}let r=[];e.where&&(r=function(l){const p=Vh(l);return p instanceof di&&ph(p)?p.getFilters():[p]}(e.where));let o=[];e.orderBy&&(o=function(l){return l.map(p=>function(m){return new Ir(Vn(m.field),function(w){switch(w){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(m.direction))}(p))}(e.orderBy));let a=null;e.limit&&(a=function(l){let p;return p=typeof l=="object"?l.value:l,Vs(p)?null:p}(e.limit));let c=null;e.startAt&&(c=function(l){const p=!!l.before,f=l.values||[];return new Ps(f,p)}(e.startAt));let h=null;return e.endAt&&(h=function(l){const p=!l.before,f=l.values||[];return new Ps(f,p)}(e.endAt)),Cm(t,n,o,r,a,"F",c,h)}function lg(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Ee(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Vh(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=Vn(e.unaryFilter.field);return gt.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=Vn(e.unaryFilter.field);return gt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Vn(e.unaryFilter.field);return gt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Vn(e.unaryFilter.field);return gt.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return Ee(61313);default:return Ee(60726)}}(s):s.fieldFilter!==void 0?function(e){return gt.create(Vn(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return Ee(58110);default:return Ee(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return di.create(e.compositeFilter.filters.map(i=>Vh(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return Ee(1026)}}(e.compositeFilter.op))}(s):Ee(30097,{filter:s})}function cg(s){return Qm[s]}function hg(s){return Km[s]}function ug(s){return Jm[s]}function Ln(s){return{fieldPath:s.canonicalString()}}function Vn(s){return Dt.fromServerFormat(s.fieldPath)}function Bh(s){return s instanceof gt?function(e){if(e.op==="=="){if(Ll(e.value))return{unaryFilter:{field:Ln(e.field),op:"IS_NAN"}};if(Fl(e.value))return{unaryFilter:{field:Ln(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(Ll(e.value))return{unaryFilter:{field:Ln(e.field),op:"IS_NOT_NAN"}};if(Fl(e.value))return{unaryFilter:{field:Ln(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ln(e.field),op:hg(e.op),value:e.value}}}(s):s instanceof di?function(e){const i=e.getFilters().map(n=>Bh(n));return i.length===1?i[0]:{compositeFilter:{op:ug(e.op),filters:i}}}(s):Ee(54877,{filter:s})}function dg(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Nh(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ui{constructor(t,e,i,n,r=Pe.min(),o=Pe.min(),a=Mt.EMPTY_BYTE_STRING,c=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=c}withSequenceNumber(t){return new Ui(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new Ui(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new Ui(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new Ui(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pg{constructor(t){this.gt=t}}function fg(s){const t=ag({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?Do(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mg{constructor(){this.Dn=new gg}addToCollectionParentIndex(t,e){return this.Dn.add(e),G.resolve()}getCollectionParents(t,e){return G.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return G.resolve()}deleteFieldIndex(t,e){return G.resolve()}deleteAllFieldIndexes(t){return G.resolve()}createTargetIndexes(t,e){return G.resolve()}getDocumentsMatchingTarget(t,e){return G.resolve(null)}getIndexType(t,e){return G.resolve(0)}getFieldIndexes(t,e){return G.resolve([])}getNextCollectionGroupToUpdate(t){return G.resolve(null)}getMinOffset(t,e){return G.resolve(Yi.min())}getMinOffsetFromCollectionGroup(t,e){return G.resolve(Yi.min())}updateCollectionGroup(t,e,i){return G.resolve()}updateIndexEntries(t,e){return G.resolve()}}class gg{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new bt(Ke.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new bt(Ke.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ql={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Hh=41943040;class Xt{static withCacheSize(t){return new Xt(t,Xt.DEFAULT_COLLECTION_PERCENTILE,Xt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Xt.DEFAULT_COLLECTION_PERCENTILE=10,Xt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Xt.DEFAULT=new Xt(Hh,Xt.DEFAULT_COLLECTION_PERCENTILE,Xt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Xt.DISABLED=new Xt(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gn{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new Gn(0)}static ur(){return new Gn(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Kl="LruGarbageCollector",vg=1048576;function Jl([s,t],[e,i]){const n=De(s,e);return n===0?De(t,i):n}class yg{constructor(t){this.Tr=t,this.buffer=new bt(Jl),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();Jl(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class wg{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){ae(Kl,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){$n(e)?ae(Kl,"Ignoring IndexedDB error during garbage collection: ",e):await Jn(e)}await this.Rr(3e5)})}}class _g{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return G.resolve(Ls.ue);const i=new yg(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(ae("LruGarbageCollector","Garbage collection skipped; disabled"),G.resolve(Ql)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(ae("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ql):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,c,h;const d=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(l=>(l>this.params.maximumSequenceNumbersToCollect?(ae("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${l}`),n=this.params.maximumSequenceNumbersToCollect):n=l,o=Date.now(),this.nthSequenceNumber(t,n))).next(l=>(i=l,a=Date.now(),this.removeTargets(t,i,e))).next(l=>(r=l,c=Date.now(),this.removeOrphanedDocuments(t,i))).next(l=>(h=Date.now(),On()<=Be.DEBUG&&ae("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(c-a)+`ms
	Removed ${l} documents in `+(h-c)+`ms
Total Duration: ${h-d}ms`),G.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:l})))}}function Tg(s,t){return new _g(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bg{constructor(){this.changes=new yn(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,zt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?G.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xg{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Eg{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&br(i.mutation,n,$t.empty(),tt.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Fe()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Fe()){const n=pn();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=fr();return r.forEach((a,c)=>{o=o.insert(a,c.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=pn();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Fe()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=Fi();const o=Tr(),a=function(){return Tr()}();return e.forEach((c,h)=>{const d=i.get(h.key);n.has(h.key)&&(d===void 0||d.mutation instanceof rn)?r=r.insert(h.key,h):d!==void 0?(o.set(h.key,d.mutation.getFieldMask()),br(d.mutation,h,d.mutation.getFieldMask(),tt.now())):o.set(h.key,$t.empty())}),this.recalculateAndSaveOverlays(t,r).next(c=>(c.forEach((h,d)=>o.set(h,d)),e.forEach((h,d)=>{var l;return a.set(h,new xg(d,(l=o.get(h))!==null&&l!==void 0?l:null))}),a))}recalculateAndSaveOverlays(t,e){const i=Tr();let n=new st((o,a)=>o-a),r=Fe();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(c=>{const h=e.get(c);if(h===null)return;let d=i.get(c)||$t.empty();d=a.applyToLocalView(h,d),i.set(c,d);const l=(n.get(a.batchId)||Fe()).add(c);n=n.insert(a.batchId,l)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const c=a.getNext(),h=c.key,d=c.value,l=bh();d.forEach(p=>{if(!r.has(p)){const f=Ah(e.get(p),i.get(p));f!==null&&l.set(p,f),r=r.add(p)}}),o.push(this.documentOverlayCache.saveOverlays(t,h,l))}return G.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return ye.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):vh(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):G.resolve(pn());let a=Pr,c=r;return o.next(h=>G.forEach(h,(d,l)=>(a<l.largestBatchId&&(a=l.largestBatchId),r.get(d)?G.resolve():this.remoteDocumentCache.getEntry(t,d).next(p=>{c=c.insert(d,p)}))).next(()=>this.populateOverlays(t,h,r)).next(()=>this.computeViews(t,c,h,Fe())).next(d=>({batchId:a,changes:Th(d)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new ye(e)).next(i=>{let n=fr();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=fr();return this.indexManager.getCollectionParents(t,r).next(a=>G.forEach(a,c=>{const h=function(l,p){return new er(p,null,l.explicitOrderBy.slice(),l.filters.slice(),l.limit,l.limitType,l.startAt,l.endAt)}(e,c.child(r));return this.getDocumentsMatchingCollectionQuery(t,h,i,n).next(d=>{d.forEach((l,p)=>{o=o.insert(l,p)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((c,h)=>{const d=h.getKey();o.get(d)===null&&(o=o.insert(d,zt.newInvalidDocument(d)))});let a=fr();return o.forEach((c,h)=>{const d=r.get(c);d!==void 0&&br(d.mutation,h,$t.empty(),tt.now()),Hs(e,h)&&(a=a.insert(c,h))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sg{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return G.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:yi(n.createTime)}}(e)),G.resolve()}getNamedQuery(t,e){return G.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:fg(n.bundledQuery),readTime:yi(n.readTime)}}(e)),G.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pg{constructor(){this.overlays=new st(ye.comparator),this.kr=new Map}getOverlay(t,e){return G.resolve(this.overlays.get(e))}getOverlays(t,e){const i=pn();return G.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),G.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),G.resolve()}getOverlaysForCollection(t,e,i){const n=pn(),r=e.length+1,o=new ye(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const c=a.getNext().value,h=c.getKey();if(!e.isPrefixOf(h.path))break;h.path.length===r&&c.largestBatchId>i&&n.set(c.getKey(),c)}return G.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new st((h,d)=>h-d);const o=this.overlays.getIterator();for(;o.hasNext();){const h=o.getNext().value;if(h.getKey().getCollectionGroup()===e&&h.largestBatchId>i){let d=r.get(h.largestBatchId);d===null&&(d=pn(),r=r.insert(h.largestBatchId,d)),d.set(h.getKey(),h)}}const a=pn(),c=r.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((h,d)=>a.set(h,d)),!(a.size()>=n)););return G.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new Wm(e,i));let r=this.kr.get(e);r===void 0&&(r=Fe(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cg{constructor(){this.sessionToken=Mt.EMPTY_BYTE_STRING}getSessionToken(t){return G.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,G.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aa{constructor(){this.qr=new bt(Et.Qr),this.$r=new bt(Et.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new Et(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new Et(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new ye(new Ke([])),i=new Et(e,t),n=new Et(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new ye(new Ke([])),i=new Et(e,t),n=new Et(e,t+1);let r=Fe();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new Et(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class Et{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return ye.comparator(t.key,e.key)||De(t.Hr,e.Hr)}static Ur(t,e){return De(t.Hr,e.Hr)||ye.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ag{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new bt(Et.Qr)}checkEmpty(t){return G.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new qm(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new Et(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return G.resolve(o)}lookupMutationBatch(t,e){return G.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return G.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return G.resolve(this.mutationQueue.length===0?Qo:this.er-1)}getAllMutationBatches(t){return G.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new Et(e,0),n=new Et(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),G.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new bt(De);return e.forEach(n=>{const r=new Et(n,0),o=new Et(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),G.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;ye.isDocumentKey(r)||(r=r.child(""));const o=new Et(new ye(r),0);let a=new bt(De);return this.Yr.forEachWhile(c=>{const h=c.key.path;return!!i.isPrefixOf(h)&&(h.length===n&&(a=a.add(c.Hr)),!0)},o),G.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){Ze(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return G.forEach(e.mutations,n=>{const r=new Et(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new Et(e,0),n=this.Yr.firstAfterOrEqual(i);return G.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,G.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rg{constructor(t){this.ni=t,this.docs=function(){return new st(ye.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return G.resolve(i?i.document.mutableCopy():zt.newInvalidDocument(e))}getEntries(t,e){let i=Fi();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():zt.newInvalidDocument(n))}),G.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=Fi();const o=e.path,a=new ye(o.child("__id-9223372036854775808__")),c=this.docs.getIteratorFrom(a);for(;c.hasNext();){const{key:h,value:{document:d}}=c.getNext();if(!o.isPrefixOf(h.path))break;h.path.length>o.length+1||sm(rm(d),i)<=0||(n.has(d.key)||Hs(e,d))&&(r=r.insert(d.key,d.mutableCopy()))}return G.resolve(r)}getAllFromCollectionGroup(t,e,i,n){Ee(9500)}ri(t,e){return G.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new Ig(this)}getSize(t){return G.resolve(this.size)}}class Ig extends bg{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),G.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dg{constructor(t){this.persistence=t,this.ii=new yn(e=>$o(e),ea),this.lastRemoteSnapshotVersion=Pe.min(),this.highestTargetId=0,this.si=0,this.oi=new aa,this.targetCount=0,this._i=Gn.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),G.resolve()}getLastRemoteSnapshotVersion(t){return G.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return G.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),G.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),G.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new Gn(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,G.resolve()}updateTargetData(t,e){return this.hr(e),G.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,G.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),G.waitFor(r).next(()=>n)}getTargetCount(t){return G.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return G.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),G.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),G.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),G.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return G.resolve(i)}containsKey(t,e){return G.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zh{constructor(t,e){this.ai={},this.overlays={},this.ui=new Ls(0),this.ci=!1,this.ci=!0,this.li=new Cg,this.referenceDelegate=t(this),this.hi=new Dg(this),this.indexManager=new mg,this.remoteDocumentCache=function(n){return new Rg(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new pg(e),this.Ti=new Sg(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Pg,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new Ag(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){ae("MemoryPersistence","Starting transaction:",t);const n=new Mg(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return G.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class Mg extends am{constructor(t){super(),this.currentSequenceNumber=t}}class la{constructor(t){this.persistence=t,this.Ai=new aa,this.Ri=null}static Vi(t){return new la(t)}get mi(){if(this.Ri)return this.Ri;throw Ee(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),G.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),G.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),G.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return G.forEach(this.mi,i=>{const n=ye.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,Pe.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return G.or([()=>G.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class Is{constructor(t,e){this.persistence=t,this.gi=new yn(i=>hm(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=Tg(this,e)}static Vi(t,e){return new Is(t,e)}Ii(){}di(t){return G.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return G.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?G.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,Pe.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),G.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),G.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),G.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),G.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=cs(t.data.value)),e}Sr(t,e,i){return G.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return G.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ca{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Fe(),n=Fe();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new ca(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kg{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Og{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return Ap()?8:lm(Pp())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new kg;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(On()<=Be.DEBUG&&ae("QueryEngine","SDK will not create cache indexes for query:",Fn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),G.resolve()):(On()<=Be.DEBUG&&ae("QueryEngine","Query:",Fn(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(On()<=Be.DEBUG&&ae("QueryEngine","The SDK decides to create cache indexes for query:",Fn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,vi(e))):G.resolve())}ps(t,e){if(Hl(e))return G.resolve(null);let i=vi(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=Do(e,null,"F"),i=vi(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Fe(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(c=>{const h=this.bs(e,a);return this.Ds(e,h,o,c.readTime)?this.ps(t,Do(e,null,"F")):this.vs(t,h,e,c)}))})))}ys(t,e,i,n){return Hl(e)||n.isEqual(Pe.min())?G.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?G.resolve(null):(On()<=Be.DEBUG&&ae("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Fn(e)),this.vs(t,o,e,nm(n,Pr)).next(a=>a))})}bs(t,e){let i=new bt(wh(t));return e.forEach((n,r)=>{Hs(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return On()<=Be.DEBUG&&ae("QueryEngine","Using full collection scan to execute query:",Fn(e)),this.gs.getDocumentsMatchingQuery(t,e,Yi.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ha="LocalStore",Fg=3e8;class Lg{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new st(De),this.Ms=new yn(r=>$o(r),ea),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Eg(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function Vg(s,t,e,i){return new Lg(s,t,e,i)}async function Uh(s,t){const e=Re(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let c=Fe();for(const h of n){o.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}for(const h of r){a.push(h.batchId);for(const d of h.mutations)c=c.add(d.key)}return e.localDocuments.getDocuments(i,c).next(h=>({Bs:h,removedBatchIds:o,addedBatchIds:a}))})})}function Bg(s,t){const e=Re(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,c,h,d){const l=h.batch,p=l.keys();let f=G.resolve();return p.forEach(m=>{f=f.next(()=>d.getEntry(c,m)).next(v=>{const w=h.docVersions.get(m);Ze(w!==null,48541),v.version.compareTo(w)<0&&(l.applyToRemoteDocument(v,h),v.isValidDocument()&&(v.setReadTime(h.commitVersion),d.addEntry(v)))})}),f.next(()=>a.mutationQueue.removeMutationBatch(c,l))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let c=Fe();for(let h=0;h<a.mutationResults.length;++h)a.mutationResults[h].transformResults.length>0&&(c=c.add(a.batch.mutations[h].key));return c}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function jh(s){const t=Re(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function Ng(s,t){const e=Re(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((d,l)=>{const p=n.get(l);if(!p)return;a.push(e.hi.removeMatchingKeys(r,d.removedDocuments,l).next(()=>e.hi.addMatchingKeys(r,d.addedDocuments,l)));let f=p.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(l)!==null?f=f.withResumeToken(Mt.EMPTY_BYTE_STRING,Pe.min()).withLastLimboFreeSnapshotVersion(Pe.min()):d.resumeToken.approximateByteSize()>0&&(f=f.withResumeToken(d.resumeToken,i)),n=n.insert(l,f),function(v,w,T){return v.resumeToken.approximateByteSize()===0||w.snapshotVersion.toMicroseconds()-v.snapshotVersion.toMicroseconds()>=Fg?!0:T.addedDocuments.size+T.modifiedDocuments.size+T.removedDocuments.size>0}(p,f,d)&&a.push(e.hi.updateTargetData(r,f))});let c=Fi(),h=Fe();if(t.documentUpdates.forEach(d=>{t.resolvedLimboDocuments.has(d)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,d))}),a.push(Hg(r,o,t.documentUpdates).next(d=>{c=d.Ls,h=d.ks})),!i.isEqual(Pe.min())){const d=e.hi.getLastRemoteSnapshotVersion(r).next(l=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(d)}return G.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,c,h)).next(()=>c)}).then(r=>(e.Fs=n,r))}function Hg(s,t,e){let i=Fe(),n=Fe();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=Fi();return e.forEach((a,c)=>{const h=r.get(a);c.isFoundDocument()!==h.isFoundDocument()&&(n=n.add(a)),c.isNoDocument()&&c.version.isEqual(Pe.min())?(t.removeEntry(a,c.readTime),o=o.insert(a,c)):!h.isValidDocument()||c.version.compareTo(h.version)>0||c.version.compareTo(h.version)===0&&h.hasPendingWrites?(t.addEntry(c),o=o.insert(a,c)):ae(ha,"Ignoring outdated watch update for ",a,". Current version:",h.version," Watch version:",c.version)}),{Ls:o,ks:n}})}function zg(s,t){const e=Re(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=Qo),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function Ug(s,t){const e=Re(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,G.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new Ui(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function Lo(s,t,e){const i=Re(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!$n(o))throw o;ae(ha,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function $l(s,t,e){const i=Re(s);let n=Pe.min(),r=Fe();return i.persistence.runTransaction("Execute query","readwrite",o=>function(c,h,d){const l=Re(c),p=l.Ms.get(d);return p!==void 0?G.resolve(l.Fs.get(p)):l.hi.getTargetData(h,d)}(i,o,vi(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(c=>{r=c})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:Pe.min(),e?r:Fe())).next(a=>(jg(i,Rm(t),a),{documents:a,qs:r})))}function jg(s,t,e){let i=s.xs.get(t)||Pe.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class ec{constructor(){this.activeTargetIds=Fm()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class qg{constructor(){this.Fo=new ec,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new ec,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wg{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tc="ConnectivityMonitor";class ic{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){ae(tc,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){ae(tc,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rs=null;function Vo(){return rs===null?rs=function(){return 268435456+Math.round(2147483648*Math.random())}():rs++,"0x"+rs.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fo="RestConnection",Gg={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Zg{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===Es?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=Vo(),a=this.Go(t,e.toUriEncodedString());ae(fo,`Sending RPC '${t}' ${o}:`,a,i);const c={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(c,n,r);const{host:h}=new URL(a),d=Go(h);return this.jo(t,a,c,i,d).then(l=>(ae(fo,`Received RPC '${t}' ${o}: `,l),l),l=>{throw Xi(fo,`RPC '${t}' ${o} failed with error: `,l,"url: ",a,"request:",i),l})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Kn}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=Gg[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xg{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Nt="WebChannelConnection";class Yg extends Zg{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=Vo();return new Promise((a,c)=>{const h=new Wc;h.setWithCredentials(!0),h.listenOnce(Gc.COMPLETE,()=>{try{switch(h.getLastErrorCode()){case ls.NO_ERROR:const l=h.getResponseJson();ae(Nt,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(l)),a(l);break;case ls.TIMEOUT:ae(Nt,`RPC '${t}' ${o} timed out`),c(new se(W.DEADLINE_EXCEEDED,"Request time out"));break;case ls.HTTP_ERROR:const p=h.getStatus();if(ae(Nt,`RPC '${t}' ${o} failed with status:`,p,"response text:",h.getResponseText()),p>0){let f=h.getResponseJson();Array.isArray(f)&&(f=f[0]);const m=f==null?void 0:f.error;if(m&&m.status&&m.message){const v=function(T){const A=T.toLowerCase().replace(/_/g,"-");return Object.values(W).indexOf(A)>=0?A:W.UNKNOWN}(m.status);c(new se(v,m.message))}else c(new se(W.UNKNOWN,"Server responded with status "+h.getStatus()))}else c(new se(W.UNAVAILABLE,"Connection failed."));break;default:Ee(9055,{c_:t,streamId:o,l_:h.getLastErrorCode(),h_:h.getLastError()})}}finally{ae(Nt,`RPC '${t}' ${o} completed.`)}});const d=JSON.stringify(n);ae(Nt,`RPC '${t}' ${o} sending request:`,n),h.send(e,"POST",d,i,15)})}P_(t,e,i){const n=Vo(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=Yc(),a=Xc(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},h=this.longPollingOptions.timeoutSeconds;h!==void 0&&(c.longPollingTimeout=Math.round(1e3*h)),this.useFetchStreams&&(c.useFetchStreams=!0),this.zo(c.initMessageHeaders,e,i),c.encodeInitMessageHeaders=!0;const d=r.join("");ae(Nt,`Creating RPC '${t}' stream ${n}: ${d}`,c);const l=o.createWebChannel(d,c);this.T_(l);let p=!1,f=!1;const m=new Xg({Ho:w=>{f?ae(Nt,`Not sending because RPC '${t}' stream ${n} is closed:`,w):(p||(ae(Nt,`Opening RPC '${t}' stream ${n} transport.`),l.open(),p=!0),ae(Nt,`RPC '${t}' stream ${n} sending:`,w),l.send(w))},Yo:()=>l.close()}),v=(w,T,A)=>{w.listen(T,F=>{try{A(F)}catch(H){setTimeout(()=>{throw H},0)}})};return v(l,pr.EventType.OPEN,()=>{f||(ae(Nt,`RPC '${t}' stream ${n} transport opened.`),m.s_())}),v(l,pr.EventType.CLOSE,()=>{f||(f=!0,ae(Nt,`RPC '${t}' stream ${n} transport closed`),m.__(),this.I_(l))}),v(l,pr.EventType.ERROR,w=>{f||(f=!0,Xi(Nt,`RPC '${t}' stream ${n} transport errored. Name:`,w.name,"Message:",w.message),m.__(new se(W.UNAVAILABLE,"The operation could not be completed")))}),v(l,pr.EventType.MESSAGE,w=>{var T;if(!f){const A=w.data[0];Ze(!!A,16349);const F=A,H=(F==null?void 0:F.error)||((T=F[0])===null||T===void 0?void 0:T.error);if(H){ae(Nt,`RPC '${t}' stream ${n} received error:`,H);const q=H.status;let J=function(S){const k=ft[S];if(k!==void 0)return Ih(k)}(q),D=H.message;J===void 0&&(J=W.INTERNAL,D="Unknown error status: "+q+" with message "+H.message),f=!0,m.__(new se(J,D)),l.close()}else ae(Nt,`RPC '${t}' stream ${n} received:`,A),m.a_(A)}}),v(a,Zc.STAT_EVENT,w=>{w.stat===Eo.PROXY?ae(Nt,`RPC '${t}' stream ${n} detected buffering proxy`):w.stat===Eo.NOPROXY&&ae(Nt,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{m.o_()},0),m}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function mo(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qs(s){return new $m(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qh{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&ae("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nc="PersistentStream";class Wh{constructor(t,e,i,n,r,o,a,c){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=c,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new qh(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===W.RESOURCE_EXHAUSTED?(Oi(e.toString()),Oi("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===W.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new se(W.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return ae(nc,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(ae(nc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Qg extends Wh{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=ig(this.serializer,t),i=function(r){if(!("targetChange"in r))return Pe.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?Pe.min():o.readTime?yi(o.readTime):Pe.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=Fo(this.serializer),e.addTarget=function(r,o){let a;const c=o.target;if(a=Ro(c)?{documents:sg(r,c)}:{query:og(r,c).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=kh(r,o.resumeToken);const h=Mo(r,o.expectedCount);h!==null&&(a.expectedCount=h)}else if(o.snapshotVersion.compareTo(Pe.min())>0){a.readTime=Rs(r,o.snapshotVersion.toTimestamp());const h=Mo(r,o.expectedCount);h!==null&&(a.expectedCount=h)}return a}(this.serializer,t);const i=lg(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=Fo(this.serializer),e.removeTarget=t,this.k_(e)}}class Kg extends Wh{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return Ze(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,Ze(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){Ze(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=rg(t.writeResults,t.commitTime),i=yi(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=Fo(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>ng(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jg{}class $g extends Jg{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new se(W.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,ko(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===W.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new se(W.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,ko(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===W.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new se(W.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class ev{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?(Oi(e),this._a=!1):ae("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vn="RemoteStore";class tv{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{wn(this)&&(ae(vn,"Restarting streams for network reachability change."),await async function(c){const h=Re(c);h.Ia.add(4),await Br(h),h.Aa.set("Unknown"),h.Ia.delete(4),await Ws(h)}(this))})}),this.Aa=new ev(i,n)}}async function Ws(s){if(wn(s))for(const t of s.da)await t(!0)}async function Br(s){for(const t of s.da)await t(!1)}function Gh(s,t){const e=Re(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),fa(e)?pa(e):tr(e).x_()&&da(e,t))}function ua(s,t){const e=Re(s),i=tr(e);e.Ta.delete(t),i.x_()&&Zh(e,t),e.Ta.size===0&&(i.x_()?i.B_():wn(e)&&e.Aa.set("Unknown"))}function da(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Pe.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}tr(s).H_(t)}function Zh(s,t){s.Ra.$e(t),tr(s).Y_(t)}function pa(s){s.Ra=new Ym({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),tr(s).start(),s.Aa.aa()}function fa(s){return wn(s)&&!tr(s).M_()&&s.Ta.size>0}function wn(s){return Re(s).Ia.size===0}function Xh(s){s.Ra=void 0}async function iv(s){s.Aa.set("Online")}async function nv(s){s.Ta.forEach((t,e)=>{da(s,t)})}async function rv(s,t){Xh(s),fa(s)?(s.Aa.la(t),pa(s)):s.Aa.set("Unknown")}async function sv(s,t,e){if(s.Aa.set("Online"),t instanceof Mh&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){ae(vn,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await Ds(s,i)}else if(t instanceof ds?s.Ra.Ye(t):t instanceof Dh?s.Ra.it(t):s.Ra.et(t),!e.isEqual(Pe.min()))try{const i=await jh(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((c,h)=>{if(c.resumeToken.approximateByteSize()>0){const d=r.Ta.get(h);d&&r.Ta.set(h,d.withResumeToken(c.resumeToken,o))}}),a.targetMismatches.forEach((c,h)=>{const d=r.Ta.get(c);if(!d)return;r.Ta.set(c,d.withResumeToken(Mt.EMPTY_BYTE_STRING,d.snapshotVersion)),Zh(r,c);const l=new Ui(d.target,c,h,d.sequenceNumber);da(r,l)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){ae(vn,"Failed to raise snapshot:",i),await Ds(s,i)}}async function Ds(s,t,e){if(!$n(t))throw t;s.Ia.add(1),await Br(s),s.Aa.set("Offline"),e||(e=()=>jh(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{ae(vn,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await Ws(s)})}function Yh(s,t){return t().catch(e=>Ds(s,e,t))}async function Gs(s){const t=Re(s),e=$i(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:Qo;for(;ov(t);)try{const n=await zg(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,av(t,n)}catch(n){await Ds(t,n)}Qh(t)&&Kh(t)}function ov(s){return wn(s)&&s.Pa.length<10}function av(s,t){s.Pa.push(t);const e=$i(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function Qh(s){return wn(s)&&!$i(s).M_()&&s.Pa.length>0}function Kh(s){$i(s).start()}async function lv(s){$i(s).na()}async function cv(s){const t=$i(s);for(const e of s.Pa)t.X_(e.mutations)}async function hv(s,t,e){const i=s.Pa.shift(),n=ra.from(i,t,e);await Yh(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await Gs(s)}async function uv(s,t){t&&$i(s).Z_&&await async function(i,n){if(function(o){return Zm(o)&&o!==W.ABORTED}(n.code)){const r=i.Pa.shift();$i(i).N_(),await Yh(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await Gs(i)}}(s,t),Qh(s)&&Kh(s)}async function rc(s,t){const e=Re(s);e.asyncQueue.verifyOperationInProgress(),ae(vn,"RemoteStore received new credentials");const i=wn(e);e.Ia.add(3),await Br(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await Ws(e)}async function dv(s,t){const e=Re(s);t?(e.Ia.delete(2),await Ws(e)):t||(e.Ia.add(2),await Br(e),e.Aa.set("Unknown"))}function tr(s){return s.Va||(s.Va=function(e,i,n){const r=Re(e);return r.ia(),new Qg(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:iv.bind(null,s),e_:nv.bind(null,s),n_:rv.bind(null,s),J_:sv.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),fa(s)?pa(s):s.Aa.set("Unknown")):(await s.Va.stop(),Xh(s))})),s.Va}function $i(s){return s.ma||(s.ma=function(e,i,n){const r=Re(e);return r.ia(),new Kg(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:lv.bind(null,s),n_:uv.bind(null,s),ea:cv.bind(null,s),ta:hv.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await Gs(s)):(await s.ma.stop(),s.Pa.length>0&&(ae(vn,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ma{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new fn,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new ma(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new se(W.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ga(s,t){if(Oi("AsyncQueue",`${t}: ${s}`),$n(s))return new se(W.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hn{static emptySet(t){return new Hn(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||ye.comparator(e.key,i.key):(e,i)=>ye.comparator(e.key,i.key),this.keyedMap=fr(),this.sortedSet=new st(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Hn)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new Hn;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sc{constructor(){this.fa=new st(ye.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):Ee(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class Zn{constructor(t,e,i,n,r,o,a,c,h){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=c,this.hasCachedResults=h}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new Zn(t,e,Hn.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ns(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pv{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class fv{constructor(){this.queries=oc(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=Re(e),r=n.queries;n.queries=oc(),r.forEach((o,a)=>{for(const c of a.wa)c.onError(i)})})(this,new se(W.ABORTED,"Firestore shutting down"))}}function oc(){return new yn(s=>yh(s),Ns)}async function mv(s,t){const e=Re(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new pv,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=ga(o,`Initialization of query '${Fn(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&va(e)}async function gv(s,t){const e=Re(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function vv(s,t){const e=Re(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&va(e)}function yv(s,t,e){const i=Re(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function va(s){s.Da.forEach(t=>{t.next()})}var Bo,ac;(ac=Bo||(Bo={})).Fa="default",ac.Cache="cache";class wv{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new Zn(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=Zn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==Bo.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jh{constructor(t){this.key=t}}class $h{constructor(t){this.key=t}}class _v{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Fe(),this.mutatedKeys=Fe(),this.Xa=wh(t),this.eu=new Hn(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new sc,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const c=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,h=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((d,l)=>{const p=n.get(d),f=Hs(this.query,l)?l:null,m=!!p&&this.mutatedKeys.has(p.key),v=!!f&&(f.hasLocalMutations||this.mutatedKeys.has(f.key)&&f.hasCommittedMutations);let w=!1;p&&f?p.data.isEqual(f.data)?m!==v&&(i.track({type:3,doc:f}),w=!0):this.iu(p,f)||(i.track({type:2,doc:f}),w=!0,(c&&this.Xa(f,c)>0||h&&this.Xa(f,h)<0)&&(a=!0)):!p&&f?(i.track({type:0,doc:f}),w=!0):p&&!f&&(i.track({type:1,doc:p}),w=!0,(c||h)&&(a=!0)),w&&(f?(o=o.add(f),r=v?r.add(d):r.delete(d)):(o=o.delete(d),r=r.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),r=r.delete(d.key),i.track({type:1,doc:d})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((d,l)=>function(f,m){const v=w=>{switch(w){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ee(20277,{At:w})}};return v(f)-v(m)}(d.type,l.type)||this.Xa(d.doc,l.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],c=this.Za.size===0&&this.current&&!n?1:0,h=c!==this.Ya;return this.Ya=c,o.length!==0||h?{snapshot:new Zn(this.query,t.eu,r,o,t.mutatedKeys,c===0,h,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new sc,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Fe(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new $h(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new Jh(i))}),e}uu(t){this.Ha=t.qs,this.Za=Fe();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return Zn.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const ya="SyncEngine";class Tv{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class bv{constructor(t){this.key=t,this.lu=!1}}class xv{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new yn(a=>yh(a),Ns),this.Tu=new Map,this.Iu=new Set,this.du=new st(ye.comparator),this.Eu=new Map,this.Au=new aa,this.Ru={},this.Vu=new Map,this.mu=Gn.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function Ev(s,t,e=!0){const i=su(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await eu(i,t,e,!0),n}async function Sv(s,t){const e=su(s);await eu(e,t,!0,!1)}async function eu(s,t,e,i){const n=await Ug(s.localStore,vi(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await Pv(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&Gh(s.remoteStore,n),a}async function Pv(s,t,e,i,n){s.gu=(l,p,f)=>async function(v,w,T,A){let F=w.view.nu(T);F.Ds&&(F=await $l(v.localStore,w.query,!1).then(({documents:D})=>w.view.nu(D,F)));const H=A&&A.targetChanges.get(w.targetId),q=A&&A.targetMismatches.get(w.targetId)!=null,J=w.view.applyChanges(F,v.isPrimaryClient,H,q);return cc(v,w.targetId,J._u),J.snapshot}(s,l,p,f);const r=await $l(s.localStore,t,!0),o=new _v(t,r.qs),a=o.nu(r.documents),c=Vr.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),h=o.applyChanges(a,s.isPrimaryClient,c);cc(s,e,h._u);const d=new Tv(t,e,o);return s.Pu.set(t,d),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),h.snapshot}async function Cv(s,t,e){const i=Re(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!Ns(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await Lo(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&ua(i.remoteStore,n.targetId),No(i,n.targetId)}).catch(Jn)):(No(i,n.targetId),await Lo(i.localStore,n.targetId,!0))}async function Av(s,t){const e=Re(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),ua(e.remoteStore,i.targetId))}async function Rv(s,t,e){const i=Lv(s);try{const n=await function(o,a){const c=Re(o),h=tt.now(),d=a.reduce((f,m)=>f.add(m.key),Fe());let l,p;return c.persistence.runTransaction("Locally write mutations","readwrite",f=>{let m=Fi(),v=Fe();return c.Os.getEntries(f,d).next(w=>{m=w,m.forEach((T,A)=>{A.isValidDocument()||(v=v.add(T))})}).next(()=>c.localDocuments.getOverlayedDocuments(f,m)).next(w=>{l=w;const T=[];for(const A of a){const F=Um(A,l.get(A.key).overlayedDocument);F!=null&&T.push(new rn(A.key,F,hh(F.value.mapValue),ui.exists(!0)))}return c.mutationQueue.addMutationBatch(f,h,T,a)}).next(w=>{p=w;const T=w.applyToLocalDocumentSet(l,v);return c.documentOverlayCache.saveOverlays(f,w.batchId,T)})}).then(()=>({batchId:p.batchId,changes:Th(l)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,c){let h=o.Ru[o.currentUser.toKey()];h||(h=new st(De)),h=h.insert(a,c),o.Ru[o.currentUser.toKey()]=h}(i,n.batchId,e),await Nr(i,n.changes),await Gs(i.remoteStore)}catch(n){const r=ga(n,"Failed to persist write");e.reject(r)}}async function tu(s,t){const e=Re(s);try{const i=await Ng(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(Ze(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?Ze(o.lu,14607):n.removedDocuments.size>0&&(Ze(o.lu,42227),o.lu=!1))}),await Nr(e,i,t)}catch(i){await Jn(i)}}function lc(s,t,e){const i=Re(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const c=Re(o);c.onlineState=a;let h=!1;c.queries.forEach((d,l)=>{for(const p of l.wa)p.va(a)&&(h=!0)}),h&&va(c)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function Iv(s,t,e){const i=Re(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new st(ye.comparator);o=o.insert(r,zt.newNoDocument(r,Pe.min()));const a=Fe().add(r),c=new js(Pe.min(),new Map,new st(De),o,a);await tu(i,c),i.du=i.du.remove(r),i.Eu.delete(t),wa(i)}else await Lo(i.localStore,t,!1).then(()=>No(i,t,e)).catch(Jn)}async function Dv(s,t){const e=Re(s),i=t.batch.batchId;try{const n=await Bg(e.localStore,t);nu(e,i,null),iu(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await Nr(e,n)}catch(n){await Jn(n)}}async function Mv(s,t,e){const i=Re(s);try{const n=await function(o,a){const c=Re(o);return c.persistence.runTransaction("Reject batch","readwrite-primary",h=>{let d;return c.mutationQueue.lookupMutationBatch(h,a).next(l=>(Ze(l!==null,37113),d=l.keys(),c.mutationQueue.removeMutationBatch(h,l))).next(()=>c.mutationQueue.performConsistencyCheck(h)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(h,d,a)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(h,d)).next(()=>c.localDocuments.getDocuments(h,d))})}(i.localStore,t);nu(i,t,e),iu(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await Nr(i,n)}catch(n){await Jn(n)}}function iu(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function nu(s,t,e){const i=Re(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function No(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||ru(s,i)})}function ru(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&(ua(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),wa(s))}function cc(s,t,e){for(const i of e)i instanceof Jh?(s.Au.addReference(i.key,t),kv(s,i)):i instanceof $h?(ae(ya,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||ru(s,i.key)):Ee(19791,{yu:i})}function kv(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(ae(ya,"New document in limbo: "+e),s.Iu.add(i),wa(s))}function wa(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new ye(Ke.fromString(t)),i=s.mu.next();s.Eu.set(i,new bv(e)),s.du=s.du.insert(e,i),Gh(s.remoteStore,new Ui(vi(ta(e.path)),i,"TargetPurposeLimboResolution",Ls.ue))}}async function Nr(s,t,e){const i=Re(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,c)=>{o.push(i.gu(c,t,e).then(h=>{var d;if((h||e)&&i.isPrimaryClient){const l=h?!h.fromCache:(d=e==null?void 0:e.targetChanges.get(c.targetId))===null||d===void 0?void 0:d.current;i.sharedClientState.updateQueryState(c.targetId,l?"current":"not-current")}if(h){n.push(h);const l=ca.Es(c.targetId,h);r.push(l)}}))}),await Promise.all(o),i.hu.J_(n),await async function(c,h){const d=Re(c);try{await d.persistence.runTransaction("notifyLocalViewChanges","readwrite",l=>G.forEach(h,p=>G.forEach(p.Is,f=>d.persistence.referenceDelegate.addReference(l,p.targetId,f)).next(()=>G.forEach(p.ds,f=>d.persistence.referenceDelegate.removeReference(l,p.targetId,f)))))}catch(l){if(!$n(l))throw l;ae(ha,"Failed to update sequence numbers: "+l)}for(const l of h){const p=l.targetId;if(!l.fromCache){const f=d.Fs.get(p),m=f.snapshotVersion,v=f.withLastLimboFreeSnapshotVersion(m);d.Fs=d.Fs.insert(p,v)}}}(i.localStore,r))}async function Ov(s,t){const e=Re(s);if(!e.currentUser.isEqual(t)){ae(ya,"User change. New user:",t.toKey());const i=await Uh(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(c=>{c.reject(new se(W.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await Nr(e,i.Bs)}}function Fv(s,t){const e=Re(s),i=e.Eu.get(t);if(i&&i.lu)return Fe().add(i.key);{let n=Fe();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function su(s){const t=Re(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=tu.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Fv.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Iv.bind(null,t),t.hu.J_=vv.bind(null,t.eventManager),t.hu.pu=yv.bind(null,t.eventManager),t}function Lv(s){const t=Re(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Dv.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Mv.bind(null,t),t}class Ms{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=qs(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return Vg(this.persistence,new Og,t.initialUser,this.serializer)}Du(t){return new zh(la.Vi,this.serializer)}bu(t){return new qg}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}Ms.provider={build:()=>new Ms};class Vv extends Ms{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){Ze(this.persistence.referenceDelegate instanceof Is,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new wg(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?Xt.withCacheSize(this.cacheSizeBytes):Xt.DEFAULT;return new zh(i=>Is.Vi(i,e),this.serializer)}}class Ho{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>lc(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=Ov.bind(null,this.syncEngine),await dv(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new fv}()}createDatastore(t){const e=qs(t.databaseInfo.databaseId),i=function(r){return new Yg(r)}(t.databaseInfo);return function(r,o,a,c){return new $g(r,o,a,c)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new tv(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>lc(this.syncEngine,e,0),function(){return ic.C()?new ic:new Wg}())}createSyncEngine(t,e){return function(n,r,o,a,c,h,d){const l=new xv(n,r,o,a,c,h);return d&&(l.fu=!0),l}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=Re(n);ae(vn,"RemoteStore shutting down."),r.Ia.add(5),await Br(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}Ho.provider={build:()=>new Ho};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bv{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):Oi("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const en="FirestoreClient";class Nv{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=Ht.UNAUTHENTICATED,this.clientId=Yo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{ae(en,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(ae(en,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new fn;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=ga(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function go(s,t){s.asyncQueue.verifyOperationInProgress(),ae(en,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await Uh(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{Xi("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{ae("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{Xi("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function hc(s,t){s.asyncQueue.verifyOperationInProgress();const e=await Hv(s);ae(en,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>rc(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>rc(t.remoteStore,n)),s._onlineComponents=t}async function Hv(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){ae(en,"Using user provided OfflineComponentProvider");try{await go(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===W.FAILED_PRECONDITION||n.code===W.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;Xi("Error using user provided cache. Falling back to memory cache: "+e),await go(s,new Ms)}}else ae(en,"Using default OfflineComponentProvider"),await go(s,new Vv(void 0));return s._offlineComponents}async function ou(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(ae(en,"Using user provided OnlineComponentProvider"),await hc(s,s._uninitializedComponentsProvider._online)):(ae(en,"Using default OnlineComponentProvider"),await hc(s,new Ho))),s._onlineComponents}function zv(s){return ou(s).then(t=>t.syncEngine)}async function uc(s){const t=await ou(s),e=t.eventManager;return e.onListen=Ev.bind(null,t.syncEngine),e.onUnlisten=Cv.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=Sv.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=Av.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function au(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dc=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lu="firestore.googleapis.com",pc=!0;class fc{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new se(W.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=lu,this.ssl=pc}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:pc;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=Hh;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<vg)throw new se(W.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}im("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=au((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new se(W.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new se(W.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new se(W.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Zs{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new fc({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new se(W.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new se(W.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new fc(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new Zf;switch(i.type){case"firstParty":return new Kf(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new se(W.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=dc.get(e);i&&(ae("ComponentProvider","Removing Datastore"),dc.delete(e),i.terminate())}(this),Promise.resolve()}}function Uv(s,t,e,i={}){var n;s=Gi(s,Zs);const r=Go(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),c=`${t}:${e}`;r&&(Tp(`https://${c}`),Sp("Firestore",!0)),o.host!==lu&&o.host!==c&&Xi("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const h=Object.assign(Object.assign({},o),{host:c,ssl:r,emulatorOptions:i});if(!_s(h,a)&&(s._setSettings(h),i.mockUserToken)){let d,l;if(typeof i.mockUserToken=="string")d=i.mockUserToken,l=Ht.MOCK_USER;else{d=bp(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const p=i.mockUserToken.sub||i.mockUserToken.user_id;if(!p)throw new se(W.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new Ht(p)}s._authCredentials=new Xf(new Kc(d,l))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _n{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new _n(this.firestore,t,this._query)}}class yt{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Zi(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new yt(this.firestore,t,this._key)}toJSON(){return{type:yt._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(Fr(e,yt._jsonSchema))return new yt(t,i||null,new ye(Ke.fromString(e.referencePath)))}}yt._jsonSchemaVersion="firestore/documentReference/1.0",yt._jsonSchema={type:vt("string",yt._jsonSchemaVersion),referencePath:vt("string")};class Zi extends _n{constructor(t,e,i){super(t,e,ta(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new yt(this.firestore,null,new ye(t))}withConverter(t){return new Zi(this.firestore,t,this._path)}}function mc(s,t,...e){if(s=Ti(s),$c("collection","path",t),s instanceof Zs){const i=Ke.fromString(t,...e);return Pl(i),new Zi(s,null,i)}{if(!(s instanceof yt||s instanceof Zi))throw new se(W.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ke.fromString(t,...e));return Pl(i),new Zi(s.firestore,null,i)}}function zo(s,t,...e){if(s=Ti(s),arguments.length===1&&(t=Yo.newId()),$c("doc","path",t),s instanceof Zs){const i=Ke.fromString(t,...e);return Sl(i),new yt(s,null,new ye(i))}{if(!(s instanceof yt||s instanceof Zi))throw new se(W.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Ke.fromString(t,...e));return Sl(i),new yt(s.firestore,s instanceof Zi?s.converter:null,new ye(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gc="AsyncQueue";class vc{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new qh(this,"async_queue_retry"),this.oc=()=>{const i=mo();i&&ae(gc,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=mo();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=mo();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new fn;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!$n(t))throw t;ae(gc,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,Oi("INTERNAL UNHANDLED ERROR: ",yc(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=ma.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&Ee(47125,{hc:yc(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function yc(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wc(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class Xn extends Zs{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new vc,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new vc(t),this._firestoreClient=void 0,await t}}}function jv(s,t){const e=typeof s=="object"?s:Lf(),i=typeof s=="string"?s:Es,n=Df(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=wp("firestore");r&&Uv(n,...r)}return n}function cu(s){if(s._terminated)throw new se(W.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||qv(s),s._firestoreClient}function qv(s){var t,e,i;const n=s._freezeSettings(),r=function(a,c,h,d){return new pm(a,c,h,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,au(d.experimentalLongPollingOptions),d.useFetchStreams,d.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new Nv(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const c=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(c),_online:c}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ri{constructor(t){this._byteString=t}static fromBase64String(t){try{return new ri(Mt.fromBase64String(t))}catch(e){throw new se(W.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new ri(Mt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:ri._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(Fr(t,ri._jsonSchema))return ri.fromBase64String(t.bytes)}}ri._jsonSchemaVersion="firestore/bytes/1.0",ri._jsonSchema={type:vt("string",ri._jsonSchemaVersion),bytes:vt("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xs{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new se(W.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Dt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _a{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wi{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new se(W.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new se(W.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return De(this._lat,t._lat)||De(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:wi._jsonSchemaVersion}}static fromJSON(t){if(Fr(t,wi._jsonSchema))return new wi(t.latitude,t.longitude)}}wi._jsonSchemaVersion="firestore/geoPoint/1.0",wi._jsonSchema={type:vt("string",wi._jsonSchemaVersion),latitude:vt("number"),longitude:vt("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _i{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:_i._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(Fr(t,_i._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new _i(t.vectorValues);throw new se(W.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}_i._jsonSchemaVersion="firestore/vectorValue/1.0",_i._jsonSchema={type:vt("string",_i._jsonSchemaVersion),vectorValues:vt("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wv=/^__.*__$/;class Gv{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new rn(t,this.data,this.fieldMask,e,this.fieldTransforms):new Lr(t,this.data,e,this.fieldTransforms)}}class hu{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new rn(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function uu(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ee(40011,{Ec:s})}}class Ta{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new Ta(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return ks(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(uu(this.Ec)&&Wv.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class Zv{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||qs(t)}Dc(t,e,i,n=!1){return new Ta({Ec:t,methodName:e,bc:i,path:Dt.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ba(s){const t=s._freezeSettings(),e=qs(s._databaseId);return new Zv(s._databaseId,!!t.ignoreUndefinedProperties,e)}function Xv(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);xa("Data must be an object, but it was:",o,i);const a=du(i,o);let c,h;if(r.merge)c=new $t(o.fieldMask),h=o.fieldTransforms;else if(r.mergeFields){const d=[];for(const l of r.mergeFields){const p=Uo(t,l,e);if(!o.contains(p))throw new se(W.INVALID_ARGUMENT,`Field '${p}' is specified in your field mask but missing from your input data.`);fu(d,p)||d.push(p)}c=new $t(d),h=o.fieldTransforms.filter(l=>c.covers(l.field))}else c=null,h=o.fieldTransforms;return new Gv(new Qt(a),c,h)}class Ys extends _a{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Ys}}function Yv(s,t,e,i){const n=s.Dc(1,t,e);xa("Data must be an object, but it was:",n,i);const r=[],o=Qt.empty();nn(i,(c,h)=>{const d=Ea(t,c,e);h=Ti(h);const l=n.gc(d);if(h instanceof Ys)r.push(d);else{const p=Hr(h,l);p!=null&&(r.push(d),o.set(d,p))}});const a=new $t(r);return new hu(o,a,n.fieldTransforms)}function Qv(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[Uo(t,i,e)],c=[n];if(r.length%2!=0)throw new se(W.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let p=0;p<r.length;p+=2)a.push(Uo(t,r[p])),c.push(r[p+1]);const h=[],d=Qt.empty();for(let p=a.length-1;p>=0;--p)if(!fu(h,a[p])){const f=a[p];let m=c[p];m=Ti(m);const v=o.gc(f);if(m instanceof Ys)h.push(f);else{const w=Hr(m,v);w!=null&&(h.push(f),d.set(f,w))}}const l=new $t(h);return new hu(d,l,o.fieldTransforms)}function Kv(s,t,e,i=!1){return Hr(e,s.Dc(i?4:3,t))}function Hr(s,t){if(pu(s=Ti(s)))return xa("Unsupported field value:",t,s),du(s,t);if(s instanceof _a)return function(i,n){if(!uu(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let c=Hr(a,n.yc(o));c==null&&(c={nullValue:"NULL_VALUE"}),r.push(c),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=Ti(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return Lm(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=tt.fromDate(i);return{timestampValue:Rs(n.serializer,r)}}if(i instanceof tt){const r=new tt(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:Rs(n.serializer,r)}}if(i instanceof wi)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof ri)return{bytesValue:kh(n.serializer,i._byteString)};if(i instanceof yt){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:oa(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof _i)return function(o,a){return{mapValue:{fields:{[lh]:{stringValue:ch},[Ss]:{arrayValue:{values:o.toArray().map(h=>{if(typeof h!="number")throw a.wc("VectorValues must only contain numeric values.");return ia(a.serializer,h)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${Fs(i)}`)}(s,t)}function du(s,t){const e={};return ih(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):nn(s,(i,n)=>{const r=Hr(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function pu(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof tt||s instanceof wi||s instanceof ri||s instanceof yt||s instanceof _a||s instanceof _i)}function xa(s,t,e){if(!pu(e)||!eh(e)){const i=Fs(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function Uo(s,t,e){if((t=Ti(t))instanceof Xs)return t._internalPath;if(typeof t=="string")return Ea(s,t);throw ks("Field path arguments must be of type string or ",s,!1,void 0,e)}const Jv=new RegExp("[~\\*/\\[\\]]");function Ea(s,t,e){if(t.search(Jv)>=0)throw ks(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new Xs(...t.split("."))._internalPath}catch{throw ks(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function ks(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(r||o)&&(c+=" (found",r&&(c+=` in field ${i}`),o&&(c+=` in document ${n}`),c+=")"),new se(W.INVALID_ARGUMENT,a+s+c)}function fu(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mu{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new yt(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new $v(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Qs("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class $v extends mu{data(){return super.data()}}function Qs(s,t){return typeof t=="string"?Ea(s,t):t instanceof Xs?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ey(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new se(W.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Sa{}class gu extends Sa{}function ty(s,t,...e){let i=[];t instanceof Sa&&i.push(t),i=i.concat(e),function(r){const o=r.filter(c=>c instanceof Pa).length,a=r.filter(c=>c instanceof Ks).length;if(o>1||o>0&&a>0)throw new se(W.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class Ks extends gu{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new Ks(t,e,i)}_apply(t){const e=this._parse(t);return vu(t._query,e),new _n(t.firestore,t.converter,Io(t._query,e))}_parse(t){const e=ba(t.firestore);return function(r,o,a,c,h,d,l){let p;if(h.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new se(W.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){Tc(l,d);const m=[];for(const v of l)m.push(_c(c,r,v));p={arrayValue:{values:m}}}else p=_c(c,r,l)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||Tc(l,d),p=Kv(a,o,l,d==="in"||d==="not-in");return gt.create(h,d,p)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function iy(s,t,e){const i=t,n=Qs("where",s);return Ks._create(n,i,e)}class Pa extends Sa{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Pa(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:di.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const c of a)vu(o,c),o=Io(o,c)}(t._query,e),new _n(t.firestore,t.converter,Io(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class Ca extends gu{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new Ca(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new se(W.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new se(W.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Ir(r,o)}(t._query,this._field,this._direction);return new _n(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new er(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function ny(s,t="asc"){const e=t,i=Qs("orderBy",s);return Ca._create(i,e)}function _c(s,t,e){if(typeof(e=Ti(e))=="string"){if(e==="")throw new se(W.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!vh(t)&&e.indexOf("/")!==-1)throw new se(W.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(Ke.fromString(e));if(!ye.isDocumentKey(i))throw new se(W.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return Ol(s,new ye(i))}if(e instanceof yt)return Ol(s,e._key);throw new se(W.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Fs(e)}.`)}function Tc(s,t){if(!Array.isArray(s)||s.length===0)throw new se(W.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function vu(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new se(W.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new se(W.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class ry{convertValue(t,e="none"){switch(Ji(t)){case 0:return null;case 1:return t.booleanValue;case 2:return ut(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Ki(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw Ee(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return nn(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[Ss].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>ut(o.doubleValue));return new _i(r)}convertGeoPoint(t){return new wi(ut(t.latitude),ut(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=Bs(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(Cr(t));default:return null}}convertTimestamp(t){const e=Qi(t);return new tt(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=Ke.fromString(t);Ze(Nh(i),9688,{name:t});const n=new Ar(i.get(1),i.get(3)),r=new ye(i.popFirst(5));return n.isEqual(e)||Oi(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sy(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class gr{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class mn extends mu{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new ps(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(Qs("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new se(W.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=mn._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}mn._jsonSchemaVersion="firestore/documentSnapshot/1.0",mn._jsonSchema={type:vt("string",mn._jsonSchemaVersion),bundleSource:vt("string","DocumentSnapshot"),bundleName:vt("string"),bundle:vt("string")};class ps extends mn{data(t={}){return super.data(t)}}class zn{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new gr(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new ps(this._firestore,this._userDataWriter,i.key,i,new gr(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new se(W.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const c=new ps(n._firestore,n._userDataWriter,a.doc.key,a.doc,new gr(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:c,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const c=new ps(n._firestore,n._userDataWriter,a.doc.key,a.doc,new gr(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let h=-1,d=-1;return a.type!==0&&(h=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),d=o.indexOf(a.doc.key)),{type:oy(a.type),doc:c,oldIndex:h,newIndex:d}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new se(W.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=zn._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=Yo.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function oy(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ee(61501,{type:s})}}zn._jsonSchemaVersion="firestore/querySnapshot/1.0",zn._jsonSchema={type:vt("string",zn._jsonSchemaVersion),bundleSource:vt("string","QuerySnapshot"),bundleName:vt("string"),bundle:vt("string")};class yu extends ry{constructor(t){super(),this.firestore=t}convertBytes(t){return new ri(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new yt(this.firestore,null,e)}}function ay(s,t,e,...i){s=Gi(s,yt);const n=Gi(s.firestore,Xn),r=ba(n);let o;return o=typeof(t=Ti(t))=="string"||t instanceof Xs?Qv(r,"updateDoc",s._key,t,e,i):Yv(r,"updateDoc",s._key,t),Aa(n,[o.toMutation(s._key,ui.exists(!0))])}function ly(s){return Aa(Gi(s.firestore,Xn),[new na(s._key,ui.none())])}function cy(s,t){const e=Gi(s.firestore,Xn),i=zo(s),n=sy(s.converter,t);return Aa(e,[Xv(ba(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,ui.exists(!1))]).then(()=>i)}function hy(s,...t){var e,i,n;s=Ti(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||wc(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(wc(t[o])){const l=t[o];t[o]=(e=l.next)===null||e===void 0?void 0:e.bind(l),t[o+1]=(i=l.error)===null||i===void 0?void 0:i.bind(l),t[o+2]=(n=l.complete)===null||n===void 0?void 0:n.bind(l)}let c,h,d;if(s instanceof yt)h=Gi(s.firestore,Xn),d=ta(s._key.path),c={next:l=>{t[o]&&t[o](uy(h,s,l))},error:t[o+1],complete:t[o+2]};else{const l=Gi(s,_n);h=Gi(l.firestore,Xn),d=l._query;const p=new yu(h);c={next:f=>{t[o]&&t[o](new zn(h,p,l,f))},error:t[o+1],complete:t[o+2]},ey(s._query)}return function(p,f,m,v){const w=new Bv(v),T=new wv(f,w,m);return p.asyncQueue.enqueueAndForget(async()=>mv(await uc(p),T)),()=>{w.Ou(),p.asyncQueue.enqueueAndForget(async()=>gv(await uc(p),T))}}(cu(h),d,a,c)}function Aa(s,t){return function(i,n){const r=new fn;return i.asyncQueue.enqueueAndForget(async()=>Rv(await zv(i),n,r)),r.promise}(cu(s),t)}function uy(s,t,e){const i=e.docs.get(t._key),n=new yu(s);return new mn(s,n,t._key,i,new gr(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){Kn=n})(Ff),bs(new Er("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new Xn(new Yf(i.getProvider("auth-internal")),new Jf(o,i.getProvider("app-check-internal")),function(h,d){if(!Object.prototype.hasOwnProperty.apply(h.options,["projectId"]))throw new se(W.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ar(h.options.projectId,d)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),Nn(_l,Tl,t),Nn(_l,Tl,"esm2017")})();var dy="firebase",py="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Nn(dy,py,"app");const fy={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},my=zc(fy),ss=jv(my);var gy=Y('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),vy=Y("<div style=margin-bottom:12px;>"),yy=Y('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;"> Add feedback'),wy=Y("<div style=margin-top:16px;>"),_y=Y('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),Ty=Y('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),by=Y('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),xy=Y("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;>  </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),Ey=Y("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),Sy=Y('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function bc({updateId:s,updateTitle:t}){const[e,i]=pe([]),[n,r]=pe(""),[o,a]=pe(null),[c,h]=pe(""),[d,l]=pe(!1),[p,f]=pe(localStorage.getItem("feedbackAuthor")||"Deji"),[m,v]=pe(!1),[w,T]=pe(!1),[A,F]=pe(!1);dn(()=>{const E=ty(mc(ss,"feedbacks"),iy("updateId","==",s),ny("timestamp","desc")),S=hy(E,k=>{const L=[];k.forEach(O=>{L.push({id:O.id,...O.data()})}),i(L)});return()=>S()});const H=async E=>{if(E.preventDefault(),!!n().trim()){l(!0);try{await cy(mc(ss,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:p(),timestamp:new Date,edited:!1}),r(""),F(!1)}catch(S){console.error("Error adding feedback:",S)}l(!1)}},q=async E=>{if(c().trim())try{await ay(zo(ss,"feedbacks",E),{text:c(),edited:!0,editedAt:new Date}),a(null),h("")}catch(S){console.error("Error editing feedback:",S)}},J=async E=>{if(confirm("Delete this feedback?"))try{await ly(zo(ss,"feedbacks",E))}catch(S){console.error("Error deleting feedback:",S)}},D=E=>{if(!E)return"";const S=E.toDate?E.toDate():new Date(E),L=new Date-S,O=Math.floor(L/(1e3*60*60));return O<1?"Just now":O<24?`${O} hour${O>1?"s":""} ago`:O<48?"Yesterday":S.toLocaleDateString()};return(()=>{var E=wy();return ie(E,be(qe,{get when(){return e().length>0},get children(){var S=vy();return ie(S,be(Gu,{get each(){return Rt(()=>!!w())()?e():e().slice(0,2)},children:k=>(()=>{var L=Ty();return ie(L,be(qe,{get when(){return o()===k.id},get fallback(){return[(()=>{var O=by();return ie(O,()=>k.text),O})(),(()=>{var O=xy(),M=O.firstChild,V=M.firstChild,Ce=M.nextSibling,Ie=Ce.firstChild,Oe=Ie.nextSibling;return ie(M,()=>k.author,V),ie(M,()=>D(k.timestamp),null),ie(M,()=>k.edited&&" (edited)",null),Ie.$$click=()=>{a(k.id),h(k.text)},Oe.$$click=()=>J(k.id),O})()]},get children(){var O=_y(),M=O.firstChild,V=M.nextSibling,Ce=V.firstChild,Ie=Ce.nextSibling;return M.$$input=Oe=>h(Oe.target.value),Ce.$$click=()=>q(k.id),Ie.$$click=()=>{a(null),h("")},$e(()=>M.value=c()),O}})),L})()}),null),ie(S,be(qe,{get when(){return e().length>2},get children(){var k=gy();return k.$$click=()=>T(!w()),ie(k,(()=>{var L=Rt(()=>!!w());return()=>L()?` Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),k}}),null),S}}),null),ie(E,be(qe,{get when(){return!A()},get fallback(){return(()=>{var S=Sy(),k=S.firstChild,L=k.firstChild,O=L.firstChild,M=O.nextSibling,V=L.nextSibling,Ce=k.nextSibling,Ie=Ce.firstChild,Oe=Ie.nextSibling,ne=Oe.firstChild,Te=ne.nextSibling;return ie(M,p),V.$$click=()=>v(!m()),ie(S,be(qe,{get when(){return m()},get children(){var Se=Ey(),dt=Se.firstChild,We=dt.firstChild,te=We.nextSibling;return We.$$click=()=>{f("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),v(!1)},te.$$click=()=>{f("Deji"),localStorage.setItem("feedbackAuthor","Deji"),v(!1)},$e(ct=>{var rt=`background: ${p()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,Kt=`background: ${p()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return ct.e=as(We,rt,ct.e),ct.t=as(te,Kt,ct.t),ct},{e:void 0,t:void 0}),Se}}),Ce),Ce.addEventListener("submit",H),Ie.$$input=Se=>r(Se.target.value),ie(ne,()=>d()?"Posting...":"Post"),Te.$$click=()=>{F(!1),r("")},$e(Se=>{var dt=d(),We=d()||!n().trim(),te=`background: ${d()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${d()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return dt!==Se.e&&(Ie.disabled=Se.e=dt),We!==Se.t&&(ne.disabled=Se.t=We),Se.a=as(ne,te,Se.a),Se},{e:void 0,t:void 0,a:void 0}),$e(()=>Ie.value=n()),S})()},get children(){var S=yy();return S.$$click=()=>F(!0),S}}),null),E})()}Yn(["click","input"]);var Py=Y("<p><strong>What's new:</strong> Added an alternative interaction mode designed specifically for mobile, where every tap hits a hotspot. Works on desktop too for testing."),Cy=Y('<p><strong>How to try it:</strong><br> Press "C" to open debug menu (triple-tap any corner on mobile)<br> Find "Interaction Mode" section<br> Click "Switch to Temporal Mode"<br> Now try holding down on a hotspot'),Ay=Y("<p><strong>The three phases:</strong><br> Quick tap (under 0.3s) = Just explores, no selection<br> Medium hold (0.3-0.5s) = Selects hotspot, no zoom<br> Long hold (over 0.5s) = Full activation with zoom"),Ry=Y("<p><strong>Current status:</strong> The foundation is in place, but it still needs polish to feel truly fluid. Desktop works reasonably well, mobile needs more attention. Planning to tackle all the rough edges tomorrow."),Iy=Y("<p><strong>Why this mode?</strong> On mobile, with 600 dense hotspots and your finger covering the screen, it's easy to trigger zooms accidentally. This gives you control - explore freely, then commit to a hotspot when ready."),Dy=Y("<p><strong>Safari animations:</strong> Now working! Chrome/Firefox/Edge still have the edge visually, but Safari's functional. Requires Safari 13.1+ (2020 or newer)."),My=Y("<p><strong>Smart zoom behavior:</strong> Following Google Arts & Culture's approach, animations now adapt to zoom level. Below 8x zoom = full animations. Above 8x = quick 150ms transitions only. When you're examining details up close, decorative animations would just distract."),ky=Y("<p><strong>Next:</strong> Making the cinematic zoom buttery smooth when clicking hotspots. Also thinking the stroke animation makes sense for desktop, but mobile needs something snappier."),Oy=Y("<p><em>Personal note: Getting really excited - it's starting to take shape! :D"),Fy=Y("<p><strong>Current status:</strong> While the hover animations now work on Safari, the visual effect isn't as pronounced as on Chrome/Firefox. I'm quite proud of the result on chrome at the moment. I think it's quite satisfying."),Ly=Y("<p><strong>Recommendation:</strong> Use Chrome for now to see the intended visual impact. The difference is noticeable - Chrome displays richer glows and better depth."),Vy=Y("<p><strong>What's next:</strong> Working on Safari-specific optimizations to improve the visual quality without compromising performance."),By=Y("<p><strong>Following up on January 7th:</strong> The Safari issue is fixed! The stroke reveal animation now works properly on Safari desktop where you can actually hover."),Ny=Y("<p><strong>Next up</strong>: Making the animation more visible and impactful for desktop users, plus exploring touch-friendly animations for mobile devices."),Hy=Y("<p><strong>Responding to your feedback:</strong> You mentioned the hover effect felt static with just the white border appearing. I've implemented a first animation to bring more life to the interactions."),zy=Y(`<p><strong>What's new:</strong> A stroke reveal animation that progressively traces the hotspot outline when you hover. Instead of the border just "popping" into view, it now draws itself smoothly around the shape - like watching someone trace the contour with a pen.`),Uy=Y("<p><strong>Current settings:</strong><br> White stroke with subtle shadow for visibility<br> 1.2 second drawing animation<br> Works on Chrome, Firefox, and Edge"),jy=Y("<p><strong>Needs refinement:</strong> The animation is quite subtle right now - you might have to look closely to see the progressive drawing effect. I'll be adjusting the timing and visibility to make it more noticeable and satisfying."),qy=Y("<p><strong>Safari issue discovered:</strong> Just noticed the animation isn't working properly on Safari (There's always something with Safari ). Will fix this tomorrow along with the other refinements."),Wy=Y("<p><strong>Note:</strong> This is one hover effect I wanted to try first. I'm planning to experiment with additional animations to find what feels best for your artwork. Let me know your thoughts!"),Gy=Y("<p><strong>What's improved:</strong> The circular spotlight effect in Apple Mode (Safari/iOS) now adapts much better to different hotspot shapes."),Zy=Y("<p><strong>What changed:</strong><br> Spotlights are now tighter and more focused around each hotspot (both mobile and desktop)<br> Better detection of when to use circles vs ellipses based on hotspot shape"),Xy=Y("<p><strong>The result:</strong> Whether a hotspot is round, tall, wide, or irregular, the spotlight should now feel more natural and better frame the content the user is exploring."),Yy=Y("<p>Try clicking on different shaped hotspots - the spotlight should feel more consistent and purposeful now!"),Qy=Y("<p><strong>The issue:</strong> Some complex hotspots still extend outside the spotlight area after yesterday's improvements."),Ky=Y("<p><strong>Today's attempt:</strong> Since a single circular spotlight can't perfectly cover irregular shapes, I tried combining multiple circles at different positions to fill in the gaps. Unfortunately, Safari doesn't support this technique - it only displays one spotlight instead of blending them together like other browsers do."),Jy=Y("<p><strong>Next:</strong> Fine-tuning the spotlight sizing parameters to better fit each hotspot's unique shape."),$y=Y("<p><strong>What's improved:</strong> The spotlight effect on Safari and iOS devices now much better matches the actual hotspot shapes, especially on desktop Safari!"),ew=Y("<p><strong>Key changes:</strong><br> Spotlights now use elliptical shapes for elongated hotspots<br> Tighter, more precise spotlight coverage that follows the hotspot boundaries closely<br> Better visual consistency between the outline of the hotspot and the darkened area<br> Desktop Safari shows the most dramatic improvements, mobile iOS continues to be refined"),tw=Y("<p><strong>Still fine-tuning:</strong> Some complex hotspots have small areas that peek slightly outside the spotlight. Mobile Safari needs additional optimization for the same precision as desktop."),iw=Y("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),nw=Y('<p><strong>How it works:</strong><br> Type your feedback in the text box below any update<br> Click "Post Feedback" to send<br> Edit or delete your comments anytime<br> Everything syncs in real-time between us'),rw=Y('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),sw=Y("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),ow=Y("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),aw=Y("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),lw=Y("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),cw=Y("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),hw=Y("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),uw=Y("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),dw=Y("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br> Uses radial gradient masks instead of polygon cutouts<br> Provides a circular/elliptical spotlight effect around hotspots<br> Maintains smooth 60 FPS performance on all iOS devices"),pw=Y("<p><strong>What's Different:</strong><br> <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br> <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),fw=Y("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),mw=Y("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),gw=Y("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),vw=Y("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br> iPhone (Safari & Chrome)<br> iPad (Safari & Chrome)<br> Mac (Safari only - Chrome works fine!)"),yw=Y("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),ww=Y("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),_w=Y("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),Tw=Y("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),bw=Y("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),xw=Y("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),Ew=Y(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now  `),Sw=Y("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),Pw=Y(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),Cw=Y("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),Aw=Y("<p>Hey Deji! "),Rw=Y("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),Iw=Y("<p>I totally relate to your potato mode confession  We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),Dw=Y("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable  I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),Mw=Y(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),kw=Y("<p>Looking forward to showing you the improvements!<br>- Leonard"),Ow=Y('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),Fw=Y(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn></button></div><div class=update-section style="background:linear-gradient(135deg, #1a1f2e 0%, #1e2330 100%);border:1px solid rgba(0, 136, 204, 0.3);margin-bottom:20px;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);"><h4 style="color:#0088cc;margin:0 0 16px 0;font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px;"><span style=font-size:20px;></span> Communication Update</h4><p style="color:rgba(255, 255, 255, 0.85);margin:0 0 20px 0;font-size:14px;line-height:1.6;">Our Upwork channel is no longer available. I've reached out via your business contacts and remain fully committed to your project.</p><div style="background:rgba(0, 136, 204, 0.1);padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;"><a href=https://t.me/LeonardCote target=_blank style="display:inline-flex;align-items:center;gap:8px;background:#0088cc;color:white;padding:10px 24px;border-radius:6px;text-decoration:none;font-weight:500;font-size:15px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0, 136, 204, 0.3);"><svg width=16 height=16 viewBox="0 0 24 24"fill=currentColor><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.223-.548.223l.188-2.85 5.18-4.68c.223-.198-.054-.308-.346-.111l-6.4 4.02-2.76-.918c-.6-.187-.612-.6.125-.89l10.782-4.156c.5-.18.94.12.78.88z"></path></svg>Message me on Telegram</a><p style="color:rgba(255, 255, 255, 0.6);margin:12px 0 0 0;font-size:13px;text-align:center;">or email: <a href=mailto:leonard.cote08@gmail.com style=color:#0088cc;text-decoration:none;>leonard.cote08@gmail.com</a></p></div><p style="color:rgba(255, 255, 255, 0.7);margin:0;font-size:13px;line-height:1.5;">The project continues to progress. All updates are posted here.<br><em style=opacity:0.8;>Platform details can be discussed when we connect.</em></p></div><div class=message-toggle><button class=toggle-btn>`),xc=Y("<div class=update-section><h4> (<!>)"),Lw=Y("<div class=app-container>"),Vw=Y("<div class=loading-screen><p>Loading Interactive Art Diary...");function Bw({onClose:s}){const[t,e]=pe(!1),i=[{id:"temporal-mode-jan11",date:"January 11",title:" New Interaction Mode: Temporal (Mobile-First Experiment)",content:[Py(),Cy(),Ay(),Ry(),Iy()]},{id:"safari-compatibility-jan10",date:"January 10",title:" Safari Compatibility & Smart Zoom Update",content:[Dy(),My(),ky(),Oy()]},{id:"safari-visual-jan9",date:"January 9",title:"Visual Effects - Browser Differences",content:[Fy(),Ly(),Vy()]},{id:"safari-fix-jan8",date:"January 8",title:" Safari Issue Resolved",content:[By(),Ny()]},{id:"hover-animations-jan7",date:"January 7 - night",title:" Hover Animation Update",content:[Hy(),zy(),Uy(),jy(),qy(),Wy()]},{id:"spotlight-refinements-july7",date:"July 7",title:" Apple Mode Spotlight Improvements",content:[Gy(),Zy(),Xy(),Yy()]},{id:"spotlight-coverage-july5",date:"July 5",title:" Working on Complete Hotspot Coverage for Safari/iOS",content:[Qy(),Ky(),Jy()]},{id:"spotlight-improvements-july4",date:"July 4",title:" Spotlight Effect Improvements for Safari/iOS",content:[$y(),ew(),tw()]},{id:"feedback-system-july3",date:"July 3 - night",title:" New: Direct Feedback System",content:[iw(),nw(),rw(),sw()]},{id:"border-experiment-july3",date:"July 3",title:" Border Experiment for Apple Mode",content:[ow(),aw(),lw(),cw(),hw()]},{id:"safari-solution-july2",date:"July 2",title:" Safari/iOS Spotlight Solution Implemented",content:[uw(),dw(),pw(),fw(),mw()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:" Spotlight Effect - Browser Compatibility",content:[gw(),vw(),yw(),ww(),_w(),Tw()]},{id:"zoom-speed-july1",date:"July 1",title:" Zoom Speed Control & Performance Update",content:[bw(),xw(),Ew(),Sw()]},{id:"performance-june30",date:"June 30",title:" Performance Breakthrough",content:Pw()},{id:"focus-mode-june29",date:"June 29",title:" New Feature",content:Cw()},{id:"personal-june28",date:"June 28",title:" Personal Message",content:[Aw(),Rw(),Iw(),Dw(),Mw(),kw()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=Fw(),a=o.firstChild,c=a.firstChild,h=c.nextSibling,d=a.nextSibling,l=d.nextSibling,p=l.firstChild;return Dc(h,"click",s),ie(o,()=>n.map(f=>(()=>{var m=xc(),v=m.firstChild,w=v.firstChild,T=w.nextSibling;return T.nextSibling,ie(v,()=>f.title,w),ie(v,()=>f.date,T),ie(m,()=>f.content,null),ie(m,be(bc,{get updateId(){return f.id},get updateTitle(){return f.title}}),null),m})()),l),p.$$click=()=>e(!t()),ie(p,()=>t()?" Hide previous updates":"+ Show previous updates"),ie(o,be(qe,{get when(){return t()},get children(){var f=Ow();return f.firstChild,ie(f,()=>r.map(m=>(()=>{var v=xc(),w=v.firstChild,T=w.firstChild,A=T.nextSibling;return A.nextSibling,ie(w,()=>m.title,T),ie(w,()=>m.date,A),ie(v,()=>m.content,null),ie(v,be(bc,{get updateId(){return m.id},get updateTitle(){return m.title}}),null),v})()),null),f}}),null),o})()}function Nw(){const[s,t]=pe(!1),[e]=pe("zebra"),[i,n]=pe(!0),r=()=>{n(!1)};return jo(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var o=Lw();return ie(o,(()=>{var a=Rt(()=>!!i());return()=>a()&&be(Bw,{onClose:r})})(),null),ie(o,(()=>{var a=Rt(()=>!!s());return()=>a()?be(lp,{get artworkId(){return e()}}):Vw()})(),null),o})()}Yn(["click"]);const Hw=document.getElementById("root");Xu(()=>be(Nw,{}),Hw);
