(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const _h=!1,Th=(s,t)=>s===t,Eh=Symbol("solid-track"),Er={equals:Th};let iu=ou;const vi=1,xr=2,nu={owned:null,cleanups:null,context:null,owner:null};var it=null;let ys=null,xh=null,Qe=null,Et=null,Yt=null,Ur=0;function gr(s,t){const e=Qe,i=it,n=s.length===0,r=t===void 0?i:t,o=n?nu:{owned:null,cleanups:null,context:r?r.context:null,owner:r},a=n?s:()=>s(()=>jt(()=>Rn(o)));it=o,Qe=null;try{return Bn(a,!0)}finally{Qe=e,it=i}}function oe(s,t){t=t?Object.assign({},Er,t):Er;const e={value:s,observers:null,observerSlots:null,comparator:t.equals||void 0},i=n=>(typeof n=="function"&&(n=n(e.value)),su(e,n));return[ru.bind(e),i]}function Ve(s,t,e){const i=io(s,t,!1,vi);Nn(i)}function Ui(s,t,e){iu=Ch;const i=io(s,t,!1,vi);i.user=!0,Yt?Yt.push(i):Nn(i)}function Ot(s,t,e){e=e?Object.assign({},Er,e):Er;const i=io(s,t,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=e.equals||void 0,Nn(i),ru.bind(i)}function jt(s){if(Qe===null)return s();const t=Qe;Qe=null;try{return s()}finally{Qe=t}}function to(s){Ui(()=>jt(s))}function Cn(s){return it===null||(it.cleanups===null?it.cleanups=[s]:it.cleanups.push(s)),s}function bh(s){const t=Ot(s),e=Ot(()=>Rs(t()));return e.toArray=()=>{const i=e();return Array.isArray(i)?i:i!=null?[i]:[]},e}function ru(){if(this.sources&&this.state)if(this.state===vi)Nn(this);else{const s=Et;Et=null,Bn(()=>Sr(this),!1),Et=s}if(Qe){const s=this.observers?this.observers.length:0;Qe.sources?(Qe.sources.push(this),Qe.sourceSlots.push(s)):(Qe.sources=[this],Qe.sourceSlots=[s]),this.observers?(this.observers.push(Qe),this.observerSlots.push(Qe.sources.length-1)):(this.observers=[Qe],this.observerSlots=[Qe.sources.length-1])}return this.value}function su(s,t,e){let i=s.value;return(!s.comparator||!s.comparator(i,t))&&(s.value=t,s.observers&&s.observers.length&&Bn(()=>{for(let n=0;n<s.observers.length;n+=1){const r=s.observers[n],o=ys&&ys.running;o&&ys.disposed.has(r),(o?!r.tState:!r.state)&&(r.pure?Et.push(r):Yt.push(r),r.observers&&au(r)),o||(r.state=vi)}if(Et.length>1e6)throw Et=[],new Error},!1)),t}function Nn(s){if(!s.fn)return;Rn(s);const t=Ur;Sh(s,s.value,t)}function Sh(s,t,e){let i;const n=it,r=Qe;Qe=it=s;try{i=s.fn(t)}catch(o){return s.pure&&(s.state=vi,s.owned&&s.owned.forEach(Rn),s.owned=null),s.updatedAt=e+1,lu(o)}finally{Qe=r,it=n}(!s.updatedAt||s.updatedAt<=e)&&(s.updatedAt!=null&&"observers"in s?su(s,i):s.value=i,s.updatedAt=e)}function io(s,t,e,i=vi,n){const r={fn:s,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:it,context:it?it.context:null,pure:e};return it===null||it!==nu&&(it.owned?it.owned.push(r):it.owned=[r]),r}function br(s){if(s.state===0)return;if(s.state===xr)return Sr(s);if(s.suspense&&jt(s.suspense.inFallback))return s.suspense.effects.push(s);const t=[s];for(;(s=s.owner)&&(!s.updatedAt||s.updatedAt<Ur);)s.state&&t.push(s);for(let e=t.length-1;e>=0;e--)if(s=t[e],s.state===vi)Nn(s);else if(s.state===xr){const i=Et;Et=null,Bn(()=>Sr(s,t[0]),!1),Et=i}}function Bn(s,t){if(Et)return s();let e=!1;t||(Et=[]),Yt?e=!0:Yt=[],Ur++;try{const i=s();return Ph(e),i}catch(i){e||(Yt=null),Et=null,lu(i)}}function Ph(s){if(Et&&(ou(Et),Et=null),s)return;const t=Yt;Yt=null,t.length&&Bn(()=>iu(t),!1)}function ou(s){for(let t=0;t<s.length;t++)br(s[t])}function Ch(s){let t,e=0;for(t=0;t<s.length;t++){const i=s[t];i.user?s[e++]=i:br(i)}for(t=0;t<e;t++)br(s[t])}function Sr(s,t){s.state=0;for(let e=0;e<s.sources.length;e+=1){const i=s.sources[e];if(i.sources){const n=i.state;n===vi?i!==t&&(!i.updatedAt||i.updatedAt<Ur)&&br(i):n===xr&&Sr(i,t)}}}function au(s){for(let t=0;t<s.observers.length;t+=1){const e=s.observers[t];e.state||(e.state=xr,e.pure?Et.push(e):Yt.push(e),e.observers&&au(e))}}function Rn(s){let t;if(s.sources)for(;s.sources.length;){const e=s.sources.pop(),i=s.sourceSlots.pop(),n=e.observers;if(n&&n.length){const r=n.pop(),o=e.observerSlots.pop();i<n.length&&(r.sourceSlots[o]=i,n[i]=r,e.observerSlots[i]=o)}}if(s.tOwned){for(t=s.tOwned.length-1;t>=0;t--)Rn(s.tOwned[t]);delete s.tOwned}if(s.owned){for(t=s.owned.length-1;t>=0;t--)Rn(s.owned[t]);s.owned=null}if(s.cleanups){for(t=s.cleanups.length-1;t>=0;t--)s.cleanups[t]();s.cleanups=null}s.state=0}function Rh(s){return s instanceof Error?s:new Error(typeof s=="string"?s:"Unknown error",{cause:s})}function lu(s,t=it){throw Rh(s)}function Rs(s){if(typeof s=="function"&&!s.length)return Rs(s());if(Array.isArray(s)){const t=[];for(let e=0;e<s.length;e++){const i=Rs(s[e]);Array.isArray(i)?t.push.apply(t,i):t.push(i)}return t}return s}const Ih=Symbol("fallback");function Ma(s){for(let t=0;t<s.length;t++)s[t]()}function Ah(s,t,e={}){let i=[],n=[],r=[],o=0,a=t.length>1?[]:null;return Cn(()=>Ma(r)),()=>{let l=s()||[],u=l.length,h,d;return l[Eh],jt(()=>{let m,v,_,E,b,k,V,W,z;if(u===0)o!==0&&(Ma(r),r=[],i=[],n=[],o=0,a&&(a=[])),e.fallback&&(i=[Ih],n[0]=gr(j=>(r[0]=j,e.fallback())),o=1);else if(o===0){for(n=new Array(u),d=0;d<u;d++)i[d]=l[d],n[d]=gr(f);o=u}else{for(_=new Array(u),E=new Array(u),a&&(b=new Array(u)),k=0,V=Math.min(o,u);k<V&&i[k]===l[k];k++);for(V=o-1,W=u-1;V>=k&&W>=k&&i[V]===l[W];V--,W--)_[W]=n[V],E[W]=r[V],a&&(b[W]=a[V]);for(m=new Map,v=new Array(W+1),d=W;d>=k;d--)z=l[d],h=m.get(z),v[d]=h===void 0?-1:h,m.set(z,d);for(h=k;h<=V;h++)z=i[h],d=m.get(z),d!==void 0&&d!==-1?(_[d]=n[h],E[d]=r[h],a&&(b[d]=a[h]),d=v[d],m.set(z,d)):r[h]();for(d=k;d<u;d++)d in _?(n[d]=_[d],r[d]=E[d],a&&(a[d]=b[d],a[d](d))):n[d]=gr(f);n=n.slice(0,o=u),i=l.slice(0)}return n});function f(m){if(r[d]=m,a){const[v,_]=oe(d);return a[d]=_,t(l[d],v)}return t(l[d])}}}function ge(s,t){return jt(()=>s(t||{}))}const uu=s=>`Stale read from <${s}>.`;function Is(s){const t="fallback"in s&&{fallback:()=>s.fallback};return Ot(Ah(()=>s.each,s.children,t||void 0))}function ke(s){const t=s.keyed,e=Ot(()=>s.when,void 0,void 0),i=t?e:Ot(e,void 0,{equals:(n,r)=>!n==!r});return Ot(()=>{const n=i();if(n){const r=s.children;return typeof r=="function"&&r.length>0?jt(()=>r(t?n:()=>{if(!jt(i))throw uu("Show");return e()})):r}return s.fallback},void 0,void 0)}function Dh(s){const t=bh(()=>s.children),e=Ot(()=>{const i=t(),n=Array.isArray(i)?i:[i];let r=()=>{};for(let o=0;o<n.length;o++){const a=o,l=n[o],u=r,h=Ot(()=>u()?void 0:l.when,void 0,void 0),d=l.keyed?h:Ot(h,void 0,{equals:(f,m)=>!f==!m});r=()=>u()||(d()?[a,h,l]:void 0)}return r});return Ot(()=>{const i=e()();if(!i)return s.fallback;const[n,r,o]=i,a=o.children;return typeof a=="function"&&a.length>0?jt(()=>a(o.keyed?r():()=>{var u;if(((u=jt(e)())==null?void 0:u[0])!==n)throw uu("Match");return r()})):a},void 0,void 0)}function ar(s){return s}const Rt=s=>Ot(()=>s());function Mh(s,t,e){let i=e.length,n=t.length,r=i,o=0,a=0,l=t[n-1].nextSibling,u=null;for(;o<n||a<r;){if(t[o]===e[a]){o++,a++;continue}for(;t[n-1]===e[r-1];)n--,r--;if(n===o){const h=r<i?a?e[a-1].nextSibling:e[r-a]:l;for(;a<r;)s.insertBefore(e[a++],h)}else if(r===a)for(;o<n;)(!u||!u.has(t[o]))&&t[o].remove(),o++;else if(t[o]===e[r-1]&&e[a]===t[n-1]){const h=t[--n].nextSibling;s.insertBefore(e[a++],t[o++].nextSibling),s.insertBefore(e[--r],h),t[n]=e[r]}else{if(!u){u=new Map;let d=a;for(;d<r;)u.set(e[d],d++)}const h=u.get(t[o]);if(h!=null)if(a<h&&h<r){let d=o,f=1,m;for(;++d<n&&d<r&&!((m=u.get(t[d]))==null||m!==h+f);)f++;if(f>h-a){const v=t[o];for(;a<h;)s.insertBefore(e[a++],v)}else s.replaceChild(e[a++],t[o++])}else o++;else t[o++].remove()}}}const ka="_$DX_DELEGATE";function kh(s,t,e,i={}){let n;return gr(r=>{n=r,t===document?s():ie(t,s(),t.firstChild?null:void 0,e)},i.owner),()=>{n(),t.textContent=""}}function B(s,t,e,i){let n;const r=()=>{const a=document.createElement("template");return a.innerHTML=s,a.content.firstChild},o=()=>(n||(n=r())).cloneNode(!0);return o.cloneNode=o,o}function Ji(s,t=window.document){const e=t[ka]||(t[ka]=new Set);for(let i=0,n=s.length;i<n;i++){const r=s[i];e.has(r)||(e.add(r),t.addEventListener(r,Oh))}}function ni(s,t,e){e==null?s.removeAttribute(t):s.setAttribute(t,e)}function Ze(s,t){t==null?s.removeAttribute("class"):s.className=t}function Fh(s,t,e,i){Array.isArray(e)?(s[`$$${t}`]=e[0],s[`$$${t}Data`]=e[1]):s[`$$${t}`]=e}function Tn(s,t,e){if(!t)return e?ni(s,"style"):t;const i=s.style;if(typeof t=="string")return i.cssText=t;typeof e=="string"&&(i.cssText=e=void 0),e||(e={}),t||(t={});let n,r;for(r in e)t[r]==null&&i.removeProperty(r),delete e[r];for(r in t)n=t[r],n!==e[r]&&(i.setProperty(r,n),e[r]=n);return e}function cu(s,t,e){return jt(()=>s(t,e))}function ie(s,t,e,i){if(e!==void 0&&!i&&(i=[]),typeof t!="function")return Pr(s,t,i,e);Ve(n=>Pr(s,t(),n,e),i)}function Oh(s){let t=s.target;const e=`$$${s.type}`,i=s.target,n=s.currentTarget,r=l=>Object.defineProperty(s,"target",{configurable:!0,value:l}),o=()=>{const l=t[e];if(l&&!t.disabled){const u=t[`${e}Data`];if(u!==void 0?l.call(t,u,s):l.call(t,s),s.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(s.target)&&r(t.host),!0},a=()=>{for(;o()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(s,"currentTarget",{configurable:!0,get(){return t||document}}),s.composedPath){const l=s.composedPath();r(l[0]);for(let u=0;u<l.length-2&&(t=l[u],!!o());u++){if(t._$host){t=t._$host,a();break}if(t.parentNode===n)break}}else a();r(i)}function Pr(s,t,e,i,n){for(;typeof e=="function";)e=e();if(t===e)return e;const r=typeof t,o=i!==void 0;if(s=o&&e[0]&&e[0].parentNode||s,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===e))return e;if(o){let a=e[0];a&&a.nodeType===3?a.data!==t&&(a.data=t):a=document.createTextNode(t),e=Li(s,e,i,a)}else e!==""&&typeof e=="string"?e=s.firstChild.data=t:e=s.textContent=t}else if(t==null||r==="boolean")e=Li(s,e,i);else{if(r==="function")return Ve(()=>{let a=t();for(;typeof a=="function";)a=a();e=Pr(s,a,e,i)}),()=>e;if(Array.isArray(t)){const a=[],l=e&&Array.isArray(e);if(As(a,t,e,n))return Ve(()=>e=Pr(s,a,e,i,!0)),()=>e;if(a.length===0){if(e=Li(s,e,i),o)return e}else l?e.length===0?Fa(s,a,i):Mh(s,e,a):(e&&Li(s),Fa(s,a));e=a}else if(t.nodeType){if(Array.isArray(e)){if(o)return e=Li(s,e,i,t);Li(s,e,null,t)}else e==null||e===""||!s.firstChild?s.appendChild(t):s.replaceChild(t,s.firstChild);e=t}}return e}function As(s,t,e,i){let n=!1;for(let r=0,o=t.length;r<o;r++){let a=t[r],l=e&&e[s.length],u;if(!(a==null||a===!0||a===!1))if((u=typeof a)=="object"&&a.nodeType)s.push(a);else if(Array.isArray(a))n=As(s,a,l)||n;else if(u==="function")if(i){for(;typeof a=="function";)a=a();n=As(s,Array.isArray(a)?a:[a],Array.isArray(l)?l:[l])||n}else s.push(a),n=!0;else{const h=String(a);l&&l.nodeType===3&&l.data===h?s.push(l):s.push(document.createTextNode(h))}}return n}function Fa(s,t,e=null){for(let i=0,n=t.length;i<n;i++)s.insertBefore(t[i],e)}function Li(s,t,e,i){if(e===void 0)return s.textContent="";const n=i||document.createTextNode("");if(t.length){let r=!1;for(let o=t.length-1;o>=0;o--){const a=t[o];if(n!==a){const l=a.parentNode===s;!r&&!o?l?s.replaceChild(n,a):s.insertBefore(n,e):l&&a.remove()}else r=!0}}else s.insertBefore(n,e);return[n]}const Vh="modulepreload",Lh=function(s){return"/"+s},Oa={},Nh=function(t,e,i){let n=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(e.map(l=>{if(l=Lh(l),l in Oa)return;Oa[l]=!0;const u=l.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":Vh,u||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),u)return new Promise((f,m)=>{d.addEventListener("load",f),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return n.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},Jw=()=>{const s=navigator.userAgent,t=/^((?!chrome|android).)*safari/i.test(s),e=/iPad|iPhone|iPod/.test(s)&&!window.MSStream,i=/android/i.test(s),n=/Android|iPhone|iPad|iPod/i.test(s)||"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1;if(n||t||e||i)return console.log("Mobile/Safari/iOS/Android detected - FORCING canvas drawer (Research: WebGL regression in 5.0.0+)"),"canvas";if(t&&!n)return console.log("Desktop Safari detected - using canvas drawer (WebKit compatibility)"),"canvas";const r=/chrome|crios/i.test(s)&&!/edge|edg/i.test(s),o=/firefox|fxios/i.test(s);return r||o?(console.log("Desktop Chrome/Firefox detected - using canvas drawer (Research: Better tile performance)"),"canvas"):(console.log("Unknown browser detected - defaulting to canvas drawer"),"canvas")},He=()=>{var o;const s=navigator.userAgent.toLowerCase();if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(s)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1)return!0;const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<=768,n=window.innerWidth<=1024;return e&&i||e&&n&&navigator.maxTouchPoints>1?!0:/mobi|tablet/i.test(s)||((o=navigator.userAgentData)==null?void 0:o.mobile)||!1};var Bh=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function zh(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var hu={exports:{}};(function(s){//! openseadragon 5.0.1
//! Built on 2024-12-09
//! Git commit: v5.0.1-0-480de92d
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/
function t(e){return new t.Viewer(e)}(function(e){e.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var i={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n=Object.prototype.toString,r=Object.prototype.hasOwnProperty;e.isFunction=function(o){return e.type(o)==="function"},e.isArray=Array.isArray||function(o){return e.type(o)==="array"},e.isWindow=function(o){return o&&typeof o=="object"&&"setInterval"in o},e.type=function(o){return o==null?String(o):i[n.call(o)]||"object"},e.isPlainObject=function(o){if(!o||t.type(o)!=="object"||o.nodeType||e.isWindow(o)||o.constructor&&!r.call(o,"constructor")&&!r.call(o.constructor.prototype,"isPrototypeOf"))return!1;var a;for(var l in o)a=l;return a===void 0||r.call(o,a)},e.isEmptyObject=function(o){for(var a in o)return!1;return!0},e.freezeObject=function(o){return Object.freeze?e.freezeObject=Object.freeze:e.freezeObject=function(a){return a},e.freezeObject(o)},e.supportsCanvas=function(){var o=document.createElement("canvas");return!!(e.isFunction(o.getContext)&&o.getContext("2d"))}(),e.isCanvasTainted=function(o){var a=!1;try{o.getContext("2d").getImageData(0,0,1,1)}catch{a=!0}return a},e.supportsAddEventListener=function(){return!!(document.documentElement.addEventListener&&document.addEventListener)}(),e.supportsRemoveEventListener=function(){return!!(document.documentElement.removeEventListener&&document.removeEventListener)}(),e.supportsEventListenerOptions=function(){var o=0;if(e.supportsAddEventListener)try{var a={get capture(){return o++,!1},get once(){return o++,!1},get passive(){return o++,!1}};window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch{o=0}return o>=3}(),e.getCurrentPixelDensityRatio=function(){if(e.supportsCanvas){var o=document.createElement("canvas").getContext("2d"),a=window.devicePixelRatio||1,l=o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1;return Math.max(a,1)/l}else return 1},e.pixelDensityRatio=e.getCurrentPixelDensityRatio()})(t),function(e){e.extend=function(){var l,u,h,d,f,m,v=arguments[0]||{},_=arguments.length,E=!1,b=1;for(typeof v=="boolean"&&(E=v,v=arguments[1]||{},b=2),typeof v!="object"&&!t.isFunction(v)&&(v={}),_===b&&(v=this,--b);b<_;b++)if(l=arguments[b],l!==null||l!==void 0)for(u in l){var k=Object.getOwnPropertyDescriptor(l,u);if(k!==void 0){if(k.get||k.set){Object.defineProperty(v,u,k);continue}d=k.value}else{e.console.warn('Could not copy inherited property "'+u+'".');continue}v!==d&&(E&&d&&(t.isPlainObject(d)||(f=t.isArray(d)))?(h=v[u],f?(f=!1,m=h&&t.isArray(h)?h:[]):m=h&&t.isPlainObject(h)?h:{},v[u]=t.extend(E,m,d)):d!==void 0&&(v[u]=d))}return v};var i=function(){if(typeof navigator!="object")return!1;var l=navigator.userAgent;return typeof l!="string"?!1:l.indexOf("iPhone")!==-1||l.indexOf("iPad")!==-1||l.indexOf("iPod")!==-1};e.extend(e,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:i(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(l,u){return function(){var h=arguments;return h===void 0&&(h=[]),u.apply(l,h)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(l){return e._viewers.get(this.getElement(l))},getElement:function(l){return typeof l=="string"&&(l=document.getElementById(l)),l},getElementPosition:function(l){var u=new e.Point,h,d;for(l=e.getElement(l),h=e.getElementStyle(l).position==="fixed",d=a(l,h);d;)u.x+=l.offsetLeft,u.y+=l.offsetTop,h&&(u=u.plus(e.getPageScroll())),l=d,h=e.getElementStyle(l).position==="fixed",d=a(l,h);return u},getElementOffset:function(l){l=e.getElement(l);var u=l&&l.ownerDocument,h,d,f={top:0,left:0};return u?(h=u.documentElement,typeof l.getBoundingClientRect<"u"&&(f=l.getBoundingClientRect()),d=u===u.window?u:u.nodeType===9?u.defaultView||u.parentWindow:!1,new e.Point(f.left+(d.pageXOffset||h.scrollLeft)-(h.clientLeft||0),f.top+(d.pageYOffset||h.scrollTop)-(h.clientTop||0))):new e.Point},getElementSize:function(l){return l=e.getElement(l),new e.Point(l.clientWidth,l.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(l){return l=e.getElement(l),l.currentStyle}:function(l){return l=e.getElement(l),window.getComputedStyle(l,"")},getCssPropertyWithVendorPrefix:function(l){var u={};return e.getCssPropertyWithVendorPrefix=function(h){if(u[h]!==void 0)return u[h];var d=document.createElement("div").style,f=null;if(d[h]!==void 0)f=h;else for(var m=["Webkit","Moz","MS","O","webkit","moz","ms","o"],v=e.capitalizeFirstLetter(h),_=0;_<m.length;_++){var E=m[_]+v;if(d[E]!==void 0){f=E;break}}return u[h]=f,f},e.getCssPropertyWithVendorPrefix(l)},capitalizeFirstLetter:function(l){return l.charAt(0).toUpperCase()+l.slice(1)},positiveModulo:function(l,u){var h=l%u;return h<0&&(h+=u),h},pointInElement:function(l,u){l=e.getElement(l);var h=e.getElementOffset(l),d=e.getElementSize(l);return u.x>=h.x&&u.x<h.x+d.x&&u.y<h.y+d.y&&u.y>=h.y},getMousePosition:function(l){if(typeof l.pageX=="number")e.getMousePosition=function(u){var h=new e.Point;return h.x=u.pageX,h.y=u.pageY,h};else if(typeof l.clientX=="number")e.getMousePosition=function(u){var h=new e.Point;return h.x=u.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,h.y=u.clientY+document.body.scrollTop+document.documentElement.scrollTop,h};else throw new Error("Unknown event mouse position, no known technique.");return e.getMousePosition(l)},getPageScroll:function(){var l=document.documentElement||{},u=document.body||{};if(typeof window.pageXOffset=="number")e.getPageScroll=function(){return new e.Point(window.pageXOffset,window.pageYOffset)};else if(u.scrollLeft||u.scrollTop)e.getPageScroll=function(){return new e.Point(document.body.scrollLeft,document.body.scrollTop)};else if(l.scrollLeft||l.scrollTop)e.getPageScroll=function(){return new e.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)};else return new e.Point(0,0);return e.getPageScroll()},setPageScroll:function(l){if(typeof window.scrollTo<"u")e.setPageScroll=function(d){window.scrollTo(d.x,d.y)};else{var u=e.getPageScroll();if(u.x===l.x&&u.y===l.y)return;document.body.scrollLeft=l.x,document.body.scrollTop=l.y;var h=e.getPageScroll();if(h.x!==u.x&&h.y!==u.y){e.setPageScroll=function(d){document.body.scrollLeft=d.x,document.body.scrollTop=d.y};return}if(document.documentElement.scrollLeft=l.x,document.documentElement.scrollTop=l.y,h=e.getPageScroll(),h.x!==u.x&&h.y!==u.y){e.setPageScroll=function(d){document.documentElement.scrollLeft=d.x,document.documentElement.scrollTop=d.y};return}e.setPageScroll=function(d){}}e.setPageScroll(l)},getWindowSize:function(){var l=document.documentElement||{},u=document.body||{};if(typeof window.innerWidth=="number")e.getWindowSize=function(){return new e.Point(window.innerWidth,window.innerHeight)};else if(l.clientWidth||l.clientHeight)e.getWindowSize=function(){return new e.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else if(u.clientWidth||u.clientHeight)e.getWindowSize=function(){return new e.Point(document.body.clientWidth,document.body.clientHeight)};else throw new Error("Unknown window size, no known technique.");return e.getWindowSize()},makeCenteredNode:function(l){l=e.getElement(l);var u=[e.makeNeutralElement("div"),e.makeNeutralElement("div"),e.makeNeutralElement("div")];return e.extend(u[0].style,{display:"table",height:"100%",width:"100%"}),e.extend(u[1].style,{display:"table-row"}),e.extend(u[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),u[0].appendChild(u[1]),u[1].appendChild(u[2]),u[2].appendChild(l),u[0]},makeNeutralElement:function(l){var u=document.createElement(l),h=u.style;return h.background="transparent none",h.border="none",h.margin="0px",h.padding="0px",h.position="static",u},now:function(){return Date.now?e.now=Date.now:e.now=function(){return new Date().getTime()},e.now()},makeTransparentImage:function(l){var u=e.makeNeutralElement("img");return u.src=l,u},setElementOpacity:function(l,u,h){var d,f;l=e.getElement(l),h&&!e.Browser.alpha&&(u=Math.round(u)),e.Browser.opacity?l.style.opacity=u<1?u:"":u<1?(d=Math.round(100*u),f="alpha(opacity="+d+")",l.style.filter=f):l.style.filter=""},setElementTouchActionNone:function(l){l=e.getElement(l),typeof l.style.touchAction<"u"?l.style.touchAction="none":typeof l.style.msTouchAction<"u"&&(l.style.msTouchAction="none")},setElementPointerEvents:function(l,u){l=e.getElement(l),typeof l.style<"u"&&typeof l.style.pointerEvents<"u"&&(l.style.pointerEvents=u)},setElementPointerEventsNone:function(l){e.setElementPointerEvents(l,"none")},addClass:function(l,u){l=e.getElement(l),l.className?(" "+l.className+" ").indexOf(" "+u+" ")===-1&&(l.className+=" "+u):l.className=u},indexOf:function(l,u,h){return Array.prototype.indexOf?this.indexOf=function(d,f,m){return d.indexOf(f,m)}:this.indexOf=function(d,f,m){var v,_=m||0,E;if(!d)throw new TypeError;if(E=d.length,E===0||_>=E)return-1;for(_<0&&(_=E-Math.abs(_)),v=_;v<E;v++)if(d[v]===f)return v;return-1},this.indexOf(l,u,h)},removeClass:function(l,u){var h,d=[],f;for(l=e.getElement(l),h=l.className.split(/\s+/),f=0;f<h.length;f++)h[f]&&h[f]!==u&&d.push(h[f]);l.className=d.join(" ")},normalizeEventListenerOptions:function(l){var u;return typeof l<"u"?typeof l=="boolean"?u=e.supportsEventListenerOptions?{capture:l}:l:u=e.supportsEventListenerOptions?l:typeof l.capture<"u"?l.capture:!1:u=e.supportsEventListenerOptions?{capture:!1}:!1,u},addEvent:function(){if(e.supportsAddEventListener)return function(l,u,h,d){d=e.normalizeEventListenerOptions(d),l=e.getElement(l),l.addEventListener(u,h,d)};if(document.documentElement.attachEvent&&document.attachEvent)return function(l,u,h){l=e.getElement(l),l.attachEvent("on"+u,h)};throw new Error("No known event model.")}(),removeEvent:function(){if(e.supportsRemoveEventListener)return function(l,u,h,d){d=e.normalizeEventListenerOptions(d),l=e.getElement(l),l.removeEventListener(u,h,d)};if(document.documentElement.detachEvent&&document.detachEvent)return function(l,u,h){l=e.getElement(l),l.detachEvent("on"+u,h)};throw new Error("No known event model.")}(),cancelEvent:function(l){l.preventDefault()},eventIsCanceled:function(l){return l.defaultPrevented},stopEvent:function(l){l.stopPropagation()},createCallback:function(l,u){console.error("The createCallback function is deprecated and will be removed in future versions. Please use alternativeFunction instead.");var h=[],d;for(d=2;d<arguments.length;d++)h.push(arguments[d]);return function(){var f=h.concat([]),m;for(m=0;m<arguments.length;m++)f.push(arguments[m]);return u.apply(l,f)}},getUrlParameter:function(l){var u=o[l];return u||null},getUrlProtocol:function(l){var u=l.match(/^([a-z]+:)\/\//i);return u===null?window.location.protocol:u[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest)return e.createAjaxRequest=function(){return new XMLHttpRequest},new XMLHttpRequest;throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(l,u,h){var d,f,m,v;e.isPlainObject(l)&&(u=l.success,h=l.error,d=l.withCredentials,f=l.headers,m=l.responseType||null,v=l.postData||null,l=l.url);var _=e.getUrlProtocol(l),E=e.createAjaxRequest();if(!e.isFunction(u))throw new Error("makeAjaxRequest requires a success callback");E.onreadystatechange=function(){E.readyState===4&&(E.onreadystatechange=function(){},E.status>=200&&E.status<300||E.status===0&&_!=="http:"&&_!=="https:"?u(E):e.isFunction(h)?h(E):e.console.error("AJAX request returned %d: %s",E.status,l))};var b=v?"POST":"GET";try{if(E.open(b,l,!0),m&&(E.responseType=m),f)for(var k in f)Object.prototype.hasOwnProperty.call(f,k)&&f[k]&&E.setRequestHeader(k,f[k]);d&&(E.withCredentials=!0),E.send(v)}catch(V){e.console.error("%s while making AJAX request: %s",V.name,V.message),E.onreadystatechange=function(){},e.isFunction(h)&&h(E,V)}return E},jsonp:function(l){var u,h=l.url,d=document.head||document.getElementsByTagName("head")[0]||document.documentElement,f=l.callbackName||"openseadragon"+e.now(),m=window[f],v="$1"+f+"$2",_=l.param||"callback",E=l.callback;h=h.replace(/(=)\?(&|$)|\?\?/i,v),h+=(/\?/.test(h)?"&":"?")+_+"="+f,window[f]=function(b){if(m)window[f]=m;else try{delete window[f]}catch{}E&&e.isFunction(E)&&E(b)},u=document.createElement("script"),(l.async!==void 0||l.async!==!1)&&(u.async="async"),l.scriptCharset&&(u.charset=l.scriptCharset),u.src=h,u.onload=u.onreadystatechange=function(b,k){(k||!u.readyState||/loaded|complete/.test(u.readyState))&&(u.onload=u.onreadystatechange=null,d&&u.parentNode&&d.removeChild(u),u=void 0)},d.insertBefore(u,d.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(l){if(window.DOMParser)e.parseXml=function(u){var h=null,d;return d=new DOMParser,h=d.parseFromString(u,"text/xml"),h};else throw new Error("Browser doesn't support XML DOM.");return e.parseXml(l)},parseJSON:function(l){return e.parseJSON=window.JSON.parse,e.parseJSON(l)},imageFormatSupported:function(l){return l=l||"",!!r[l.toLowerCase()]},setImageFormatsSupported:function(l){e.extend(r,l)}});var n=function(l){};e.console=window.console||{log:n,debug:n,info:n,warn:n,error:n,assert:n},e.Browser={vendor:e.BROWSERS.UNKNOWN,version:0,alpha:!0};var r={avif:!0,bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},o={};(function(){var l=navigator.appVersion,u=navigator.userAgent,h;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(u.substring(u.indexOf("MSIE")+5,u.indexOf(";",u.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(u.indexOf("Edge")>=0?(e.Browser.vendor=e.BROWSERS.EDGE,e.Browser.version=parseFloat(u.substring(u.indexOf("Edge")+5))):u.indexOf("Edg")>=0?(e.Browser.vendor=e.BROWSERS.CHROMEEDGE,e.Browser.version=parseFloat(u.substring(u.indexOf("Edg")+4))):u.indexOf("Firefox")>=0?(e.Browser.vendor=e.BROWSERS.FIREFOX,e.Browser.version=parseFloat(u.substring(u.indexOf("Firefox")+8))):u.indexOf("Safari")>=0?(e.Browser.vendor=u.indexOf("Chrome")>=0?e.BROWSERS.CHROME:e.BROWSERS.SAFARI,e.Browser.version=parseFloat(u.substring(u.substring(0,u.indexOf("Safari")).lastIndexOf("/")+1,u.indexOf("Safari")))):(h=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),h.exec(u)!==null&&(e.Browser.vendor=e.BROWSERS.IE,e.Browser.version=parseFloat(RegExp.$1))));break;case"Opera":e.Browser.vendor=e.BROWSERS.OPERA,e.Browser.version=parseFloat(l);break}var d=window.location.search.substring(1),f=d.split("&"),m,v,_;for(_=0;_<f.length;_++)if(m=f[_],v=m.indexOf("="),v>0){var E=m.substring(0,v),b=m.substring(v+1);try{o[E]=decodeURIComponent(b)}catch{e.console.error("Ignoring malformed URL parameter: %s=%s",E,b)}}e.Browser.alpha=!(e.Browser.vendor===e.BROWSERS.CHROME&&e.Browser.version<2),e.Browser.opacity=!0,e.Browser.vendor===e.BROWSERS.IE&&e.console.error("Internet Explorer is not supported by OpenSeadragon")})(),function(l){var u=l.requestAnimationFrame||l.mozRequestAnimationFrame||l.webkitRequestAnimationFrame||l.msRequestAnimationFrame,h=l.cancelAnimationFrame||l.mozCancelAnimationFrame||l.webkitCancelAnimationFrame||l.msCancelAnimationFrame;if(u&&h)e.requestAnimationFrame=function(){return u.apply(l,arguments)},e.cancelAnimationFrame=function(){return h.apply(l,arguments)};else{var d=[],f=[],m=0,v;e.requestAnimationFrame=function(_){return d.push([++m,_]),v||(v=setInterval(function(){if(d.length){var E=e.now(),b=f;for(f=d,d=b;f.length;)f.shift()[1](E)}else clearInterval(v),v=void 0},1e3/50)),m},e.cancelAnimationFrame=function(_){var E,b;for(E=0,b=d.length;E<b;E+=1)if(d[E][0]===_){d.splice(E,1);return}for(E=0,b=f.length;E<b;E+=1)if(f[E][0]===_){f.splice(E,1);return}}}}(window);function a(l,u){return u&&l!==document.body?document.body:l.offsetParent}}(t),function(e,i){s.exports?s.exports=i():e.OpenSeadragon=i()}(Bh,function(){return t}),function(e){class i{constructor(r){r||(r=[0,0,0,0,0,0,0,0,0]),this.values=r}static makeIdentity(){return new i([1,0,0,0,1,0,0,0,1])}static makeTranslation(r,o){return new i([1,0,0,0,1,0,r,o,1])}static makeRotation(r){var o=Math.cos(r),a=Math.sin(r);return new i([o,-a,0,a,o,0,0,0,1])}static makeScaling(r,o){return new i([r,0,0,0,o,0,0,0,1])}multiply(r){let o=this.values,a=r.values;var l=o[0*3+0],u=o[0*3+1],h=o[0*3+2],d=o[1*3+0],f=o[1*3+1],m=o[1*3+2],v=o[2*3+0],_=o[2*3+1],E=o[2*3+2],b=a[0*3+0],k=a[0*3+1],V=a[0*3+2],W=a[1*3+0],z=a[1*3+1],j=a[1*3+2],D=a[2*3+0],x=a[2*3+1],I=a[2*3+2];return new i([b*l+k*d+V*v,b*u+k*f+V*_,b*h+k*m+V*E,W*l+z*d+j*v,W*u+z*f+j*_,W*h+z*m+j*E,D*l+x*d+I*v,D*u+x*f+I*_,D*h+x*m+I*E])}}e.Mat3=i}(t),function(e){var i={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};document.exitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.fullscreenElement},i.requestFullScreen=function(n){return n.requestFullscreen().catch(function(r){e.console.error("Fullscreen request failed: ",r)})},i.exitFullScreen=function(){document.exitFullscreen().catch(function(n){e.console.error("Error while exiting fullscreen: ",n)})},i.fullScreenEventName="fullscreenchange",i.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.msFullscreenElement},i.requestFullScreen=function(n){return n.msRequestFullscreen()},i.exitFullScreen=function(){document.msExitFullscreen()},i.fullScreenEventName="MSFullscreenChange",i.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitFullscreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullscreen()},i.exitFullScreen=function(){document.webkitExitFullscreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},i.requestFullScreen=function(n){return n.webkitRequestFullScreen()},i.exitFullScreen=function(){document.webkitCancelFullScreen()},i.fullScreenEventName="webkitfullscreenchange",i.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(i.supportsFullScreen=!0,i.getFullScreenElement=function(){return document.mozFullScreenElement},i.requestFullScreen=function(n){return n.mozRequestFullScreen()},i.exitFullScreen=function(){document.mozCancelFullScreen()},i.fullScreenEventName="mozfullscreenchange",i.fullScreenErrorEventName="mozfullscreenerror"),i.isFullScreen=function(){return i.getFullScreenElement()!==null},i.cancelFullScreen=function(){e.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),i.exitFullScreen()},e.extend(e,i)}(t),function(e){e.EventSource=function(){this.events={},this._rejectedEventList={}},e.EventSource.prototype={addOnceHandler:function(i,n,r,o,a){var l=this;o=o||1;var u=0,h=function(d){return u++,u===o&&l.removeHandler(i,h),n(d)};return this.addHandler(i,h,r,a)},addHandler:function(i,n,r,o){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var a=this.events[i];if(a||(this.events[i]=a=[]),n&&e.isFunction(n)){var l=a.length,u={handler:n,userData:r||null,priority:o||0};for(a[l]=u;l>0&&a[l-1].priority<a[l].priority;)a[l]=a[l-1],a[l-1]=u,l--}return!0},removeHandler:function(i,n){var r=this.events[i],o=[],a;if(r&&e.isArray(r)){for(a=0;a<r.length;a++)r[a].handler!==n&&o.push(r[a]);this.events[i]=o}},numberOfHandlers:function(i){var n=this.events[i];return n?n.length:0},removeAllHandlers:function(i){if(i)this.events[i]=[];else for(var n in this.events)this.events[n]=[]},getHandler:function(i){var n=this.events[i];return!n||!n.length?null:(n=n.length===1?[n[0]]:Array.apply(null,n),function(r,o){var a,l=n.length;for(a=0;a<l;a++)n[a]&&(o.eventSource=r,o.userData=n[a].userData,n[a].handler(o))})},raiseEvent:function(i,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,i))return e.console.error(`Error adding handler for ${i}. ${this._rejectedEventList[i]}`),!1;var r=this.getHandler(i);return r&&r(this,n||{}),!0},rejectEventHandler(i,n=""){this._rejectedEventList[i]=n},allowEventHandler(i){delete this._rejectedEventList[i]}}}(t),function(e){var i={};e.MouseTracker=function(T){var w=arguments;e.isPlainObject(T)||(T={element:w[0],clickTimeThreshold:w[1],clickDistThreshold:w[2]}),this.hash=Math.random(),this.element=e.getElement(T.element),this.clickTimeThreshold=T.clickTimeThreshold||e.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=T.clickDistThreshold||e.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=T.dblClickTimeThreshold||e.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=T.dblClickDistThreshold||e.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=T.userData||null,this.stopDelay=T.stopDelay||50,this.preProcessEventHandler=T.preProcessEventHandler||null,this.contextMenuHandler=T.contextMenuHandler||null,this.enterHandler=T.enterHandler||null,this.leaveHandler=T.leaveHandler||null,this.exitHandler=T.exitHandler||null,this.overHandler=T.overHandler||null,this.outHandler=T.outHandler||null,this.pressHandler=T.pressHandler||null,this.nonPrimaryPressHandler=T.nonPrimaryPressHandler||null,this.releaseHandler=T.releaseHandler||null,this.nonPrimaryReleaseHandler=T.nonPrimaryReleaseHandler||null,this.moveHandler=T.moveHandler||null,this.scrollHandler=T.scrollHandler||null,this.clickHandler=T.clickHandler||null,this.dblClickHandler=T.dblClickHandler||null,this.dragHandler=T.dragHandler||null,this.dragEndHandler=T.dragEndHandler||null,this.pinchHandler=T.pinchHandler||null,this.stopHandler=T.stopHandler||null,this.keyDownHandler=T.keyDownHandler||null,this.keyUpHandler=T.keyUpHandler||null,this.keyHandler=T.keyHandler||null,this.focusHandler=T.focusHandler||null,this.blurHandler=T.blurHandler||null;var C=this;i[this.hash]={click:function(A){V(C,A)},dblclick:function(A){W(C,A)},keydown:function(A){z(C,A)},keyup:function(A){j(C,A)},keypress:function(A){D(C,A)},focus:function(A){x(C,A)},blur:function(A){I(C,A)},contextmenu:function(A){M(C,A)},wheel:function(A){F(C,A)},mousewheel:function(A){O(C,A)},DOMMouseScroll:function(A){O(C,A)},MozMousePixelScroll:function(A){O(C,A)},losecapture:function(A){ne(C,A)},mouseenter:function(A){X(C,A)},mouseleave:function(A){Se(C,A)},mouseover:function(A){Re(C,A)},mouseout:function(A){tt(C,A)},mousedown:function(A){We(C,A)},mouseup:function(A){pt(C,A)},mousemove:function(A){st(C,A)},touchstart:function(A){ee(C,A)},touchend:function(A){ae(C,A)},touchmove:function(A){q(C,A)},touchcancel:function(A){Q(C,A)},gesturestart:function(A){J(C,A)},gesturechange:function(A){se(C,A)},gotpointercapture:function(A){xe(C,A)},lostpointercapture:function(A){pe(C,A)},pointerenter:function(A){X(C,A)},pointerleave:function(A){Se(C,A)},pointerover:function(A){Re(C,A)},pointerout:function(A){tt(C,A)},pointerdown:function(A){We(C,A)},pointerup:function(A){pt(C,A)},pointermove:function(A){st(C,A)},pointercancel:function(A){mt(C,A)},pointerupcaptured:function(A){lt(C,A)},pointermovecaptured:function(A){ot(C,A)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1},this.hasGestureHandlers=!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler),this.hasScrollHandler=!!this.scrollHandler,e.MouseTracker.havePointerEvents&&e.setElementPointerEvents(this.element,"auto"),this.exitHandler&&e.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead."),T.startDisabled||this.setTracking(!0)},e.MouseTracker.prototype={destroy:function(){l(this),this.element=null,i[this.hash]=null,delete i[this.hash]},isTracking:function(){return i[this.hash].tracking},setTracking:function(T){return T?a(this):l(this),this},getActivePointersListByType:function(T){var w=i[this.hash],C,A=w?w.activePointersLists.length:0,U;for(C=0;C<A;C++)if(w.activePointersLists[C].type===T)return w.activePointersLists[C];return U=new e.MouseTracker.GesturePointList(T),w&&w.activePointersLists.push(U),U},getActivePointerCount:function(){var T=i[this.hash],w,C=T.activePointersLists.length,A=0;for(w=0;w<C;w++)A+=T.activePointersLists[w].getLength();return A},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var n=function(){try{return window.self!==window.top}catch{return!0}}();function r(T){try{return T.addEventListener&&T.removeEventListener}catch{return!1}}e.MouseTracker.gesturePointVelocityTracker=function(){var T=[],w=0,C=0,A=function(De,me){return De.hash.toString()+me.type+me.id.toString()},U=function(){var De,me=T.length,Ke,je,Dt=e.now(),kt,qt,Zt;for(kt=Dt-C,C=Dt,De=0;De<me;De++)Ke=T[De],je=Ke.gPoint,je.direction=Math.atan2(je.currentPos.y-Ke.lastPos.y,je.currentPos.x-Ke.lastPos.x),qt=Ke.lastPos.distanceTo(je.currentPos),Ke.lastPos=je.currentPos,Zt=1e3*qt/(kt+1),je.speed=.75*Zt+.25*je.speed},$=function(De,me){var Ke=A(De,me);T.push({guid:Ke,gPoint:me,lastPos:me.currentPos}),T.length===1&&(C=e.now(),w=window.setInterval(U,50))},fe=function(De,me){var Ke=A(De,me),je,Dt=T.length;for(je=0;je<Dt;je++)if(T[je].guid===Ke){T.splice(je,1),Dt--,Dt===0&&window.clearInterval(w);break}};return{addPoint:$,removePoint:fe}}(),e.MouseTracker.captureElement=document,e.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll",e.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",e.MouseTracker.wheelEventName],e.MouseTracker.wheelEventName==="DOMMouseScroll"&&e.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent?(e.MouseTracker.havePointerEvents=!0,e.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),e.MouseTracker.havePointerCapture=function(){var T=document.createElement("div");return e.isFunction(T.setPointerCapture)&&e.isFunction(T.releasePointerCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")):(e.MouseTracker.havePointerEvents=!1,e.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove"),e.MouseTracker.mousePointerId="legacy-mouse",e.MouseTracker.havePointerCapture=function(){var T=document.createElement("div");return e.isFunction(T.setCapture)&&e.isFunction(T.releaseCapture)}(),e.MouseTracker.havePointerCapture&&e.MouseTracker.subscribeEvents.push("losecapture"),"ontouchstart"in window&&e.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&e.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")),e.MouseTracker.GesturePointList=function(T){this._gPoints=[],this.type=T,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},e.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(T){return this._gPoints.push(T)},removeById:function(T){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].id===T){this._gPoints.splice(w,1);break}return this._gPoints.length},getByIndex:function(T){return T<this._gPoints.length?this._gPoints[T]:null},getById:function(T){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].id===T)return this._gPoints[w];return null},getPrimary:function(T){var w,C=this._gPoints.length;for(w=0;w<C;w++)if(this._gPoints[w].isPrimary)return this._gPoints[w];return null},addContact:function(){++this.contacts,this.contacts>1&&(this.type==="mouse"||this.type==="pen")&&(e.console.warn("GesturePointList.addContact() Implausible contacts value"),this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};function o(T){var w=i[T.hash],C,A,U,$,fe,De=w.activePointersLists.length;for(C=0;C<De;C++)if(U=w.activePointersLists[C],U.getLength()>0){for(fe=[],$=U.asArray(),A=0;A<$.length;A++)fe.push($[A]);for(A=0;A<fe.length;A++)Oe(T,U,fe[A])}for(C=0;C<De;C++)w.activePointersLists.pop();w.sentDragEvent=!1}function a(T){var w=i[T.hash],C,A;if(!w.tracking){for(A=0;A<e.MouseTracker.subscribeEvents.length;A++)C=e.MouseTracker.subscribeEvents[A],e.addEvent(T.element,C,w[C],C===e.MouseTracker.wheelEventName?{passive:!1,capture:!1}:!1);o(T),w.tracking=!0}}function l(T){var w=i[T.hash],C,A;if(w.tracking){for(A=0;A<e.MouseTracker.subscribeEvents.length;A++)C=e.MouseTracker.subscribeEvents[A],e.removeEvent(T.element,C,w[C],!1);o(T),w.tracking=!1}}function u(T,w){var C=i[T.hash];if(w==="pointerevent")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(w==="mouse")return{upName:"pointerup",upHandler:C.pointerupcaptured,moveName:"pointermove",moveHandler:C.pointermovecaptured};if(w==="touch")return{upName:"touchend",upHandler:C.touchendcaptured,moveName:"touchmove",moveHandler:C.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function h(T,w){var C;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents)try{T.element.setPointerCapture(w.id)}catch{e.console.warn("setPointerCapture() called on invalid pointer ID");return}else T.element.setCapture(!0);else C=u(T,e.MouseTracker.havePointerEvents?"pointerevent":w.type),n&&r(window.top)&&e.addEvent(window.top,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0),e.addEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0);L(T,w,!0)}function d(T,w){var C,A,U;if(e.MouseTracker.havePointerCapture)if(e.MouseTracker.havePointerEvents){if(A=T.getActivePointersListByType(w.type),U=A.getById(w.id),!U||!U.captured)return;try{T.element.releasePointerCapture(w.id)}catch{}}else T.element.releaseCapture();else C=u(T,e.MouseTracker.havePointerEvents?"pointerevent":w.type),n&&r(window.top)&&e.removeEvent(window.top,C.upName,C.upHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.moveName,C.moveHandler,!0),e.removeEvent(e.MouseTracker.captureElement,C.upName,C.upHandler,!0);L(T,w,!1)}function f(T){return e.MouseTracker.havePointerEvents?T.pointerId:e.MouseTracker.mousePointerId}function m(T){return e.MouseTracker.havePointerEvents&&T.pointerType?T.pointerType:"mouse"}function v(T){return e.MouseTracker.havePointerEvents?T.isPrimary:!0}function _(T){return e.getMousePosition(T)}function E(T,w){return b(_(T),w)}function b(T,w){var C=e.getElementOffset(w);return T.minus(C)}function k(T,w){return new e.Point((T.x+w.x)/2,(T.y+w.y)/2)}function V(T,w){var C={originalEvent:w,eventType:"click",pointerType:"mouse",isEmulated:!1};P(T,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(w),C.stopPropagation&&e.stopEvent(w)}function W(T,w){var C={originalEvent:w,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};P(T,C),C.preventDefault&&!C.defaultPrevented&&e.cancelEvent(w),C.stopPropagation&&e.stopEvent(w)}function z(T,w){var C=null,A={originalEvent:w,eventType:"keydown",pointerType:"",isEmulated:!1};P(T,A),T.keyDownHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:T,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:A.preventDefault||A.defaultPrevented,userData:T.userData},T.keyDownHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function j(T,w){var C=null,A={originalEvent:w,eventType:"keyup",pointerType:"",isEmulated:!1};P(T,A),T.keyUpHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:T,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:A.preventDefault||A.defaultPrevented,userData:T.userData},T.keyUpHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function D(T,w){var C=null,A={originalEvent:w,eventType:"keypress",pointerType:"",isEmulated:!1};P(T,A),T.keyHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:T,keyCode:w.keyCode?w.keyCode:w.charCode,ctrl:w.ctrlKey,shift:w.shiftKey,alt:w.altKey,meta:w.metaKey,originalEvent:w,preventDefault:A.preventDefault||A.defaultPrevented,userData:T.userData},T.keyHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function x(T,w){var C={originalEvent:w,eventType:"focus",pointerType:"",isEmulated:!1};P(T,C),T.focusHandler&&!C.preventGesture&&T.focusHandler({eventSource:T,originalEvent:w,userData:T.userData})}function I(T,w){var C={originalEvent:w,eventType:"blur",pointerType:"",isEmulated:!1};P(T,C),T.blurHandler&&!C.preventGesture&&T.blurHandler({eventSource:T,originalEvent:w,userData:T.userData})}function M(T,w){var C=null,A={originalEvent:w,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};P(T,A),T.contextMenuHandler&&!A.preventGesture&&!A.defaultPrevented&&(C={eventSource:T,position:b(_(w),T.element),originalEvent:A.originalEvent,preventDefault:A.preventDefault||A.defaultPrevented,userData:T.userData},T.contextMenuHandler(C)),(C&&C.preventDefault||A.preventDefault&&!A.defaultPrevented)&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function F(T,w){R(T,w,w)}function O(T,w){var C={target:w.target||w.srcElement,type:"wheel",shiftKey:w.shiftKey||!1,clientX:w.clientX,clientY:w.clientY,pageX:w.pageX?w.pageX:w.clientX,pageY:w.pageY?w.pageY:w.clientY,deltaMode:w.type==="MozMousePixelScroll"?0:1,deltaX:0,deltaZ:0};e.MouseTracker.wheelEventName==="mousewheel"?C.deltaY=-w.wheelDelta/e.DEFAULT_SETTINGS.pixelsPerWheelLine:C.deltaY=w.detail,R(T,C,w)}function R(T,w,C){var A=0,U,$=null;A=w.deltaY?w.deltaY<0?1:-1:0,U={originalEvent:w,eventType:"wheel",pointerType:"mouse",isEmulated:w!==C},P(T,U),T.scrollHandler&&!U.preventGesture&&!U.defaultPrevented&&($={eventSource:T,pointerType:"mouse",position:E(w,T.element),scroll:A,shift:w.shiftKey,isTouchEvent:!1,originalEvent:C,preventDefault:U.preventDefault||U.defaultPrevented,userData:T.userData},T.scrollHandler($)),U.stopPropagation&&e.stopEvent(C),($&&$.preventDefault||U.preventDefault&&!U.defaultPrevented)&&e.cancelEvent(C)}function ne(T,w){var C={id:e.MouseTracker.mousePointerId,type:"mouse"},A={originalEvent:w,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};P(T,A),w.target===T.element&&L(T,C,!1),A.stopPropagation&&e.stopEvent(w)}function ee(T,w){var C,A,U=w.changedTouches.length,$,fe=T.getActivePointersListByType("touch");C=e.now(),fe.getLength()>w.touches.length-U&&e.console.warn("Tracked touch contact count doesn't match event.touches.length");var De={originalEvent:w,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};for(P(T,De),A=0;A<U;A++)$={id:w.changedTouches[A].identifier,type:"touch",isPrimary:fe.getLength()===0,currentPos:_(w.changedTouches[A]),currentTime:C},Y(T,De,$),ye(T,De,$,0),L(T,$,!0);De.preventDefault&&!De.defaultPrevented&&e.cancelEvent(w),De.stopPropagation&&e.stopEvent(w)}function ae(T,w){var C,A,U=w.changedTouches.length,$;C=e.now();var fe={originalEvent:w,eventType:"pointerup",pointerType:"touch",isEmulated:!1};for(P(T,fe),A=0;A<U;A++)$={id:w.changedTouches[A].identifier,type:"touch",currentPos:_(w.changedTouches[A]),currentTime:C},Pe(T,fe,$,0),L(T,$,!1),te(T,fe,$);fe.preventDefault&&!fe.defaultPrevented&&e.cancelEvent(w),fe.stopPropagation&&e.stopEvent(w)}function q(T,w){var C,A,U=w.changedTouches.length,$;C=e.now();var fe={originalEvent:w,eventType:"pointermove",pointerType:"touch",isEmulated:!1};for(P(T,fe),A=0;A<U;A++)$={id:w.changedTouches[A].identifier,type:"touch",currentPos:_(w.changedTouches[A]),currentTime:C},Te(T,fe,$);fe.preventDefault&&!fe.defaultPrevented&&e.cancelEvent(w),fe.stopPropagation&&e.stopEvent(w)}function Q(T,w){var C=w.changedTouches.length,A,U,$={originalEvent:w,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};for(P(T,$),A=0;A<C;A++)U={id:w.changedTouches[A].identifier,type:"touch"},de(T,$,U);$.stopPropagation&&e.stopEvent(w)}function J(T,w){return e.eventIsCanceled(w)||w.preventDefault(),!1}function se(T,w){return e.eventIsCanceled(w)||w.preventDefault(),!1}function xe(T,w){var C={originalEvent:w,eventType:"gotpointercapture",pointerType:m(w),isEmulated:!1};P(T,C),w.target===T.element&&L(T,{id:w.pointerId,type:m(w)},!0),C.stopPropagation&&e.stopEvent(w)}function pe(T,w){var C={originalEvent:w,eventType:"lostpointercapture",pointerType:m(w),isEmulated:!1};P(T,C),w.target===T.element&&L(T,{id:w.pointerId,type:m(w)},!1),C.stopPropagation&&e.stopEvent(w)}function X(T,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerenter",pointerType:C.type,isEmulated:!1};P(T,A),Y(T,A,C)}function Se(T,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerleave",pointerType:C.type,isEmulated:!1};P(T,A),te(T,A,C)}function Re(T,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerover",pointerType:C.type,isEmulated:!1};P(T,A),he(T,A,C),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function tt(T,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointerout",pointerType:C.type,isEmulated:!1};P(T,A),Z(T,A,C),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function We(T,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()},A=e.MouseTracker.havePointerEvents&&C.type==="touch",U={originalEvent:w,eventType:"pointerdown",pointerType:C.type,isEmulated:!1};P(T,U),ye(T,U,C,w.button),U.preventDefault&&!U.defaultPrevented&&e.cancelEvent(w),U.stopPropagation&&e.stopEvent(w),U.shouldCapture&&(A?L(T,C,!0):h(T,C))}function pt(T,w){xt(T,w)}function lt(T,w){var C=T.getActivePointersListByType(m(w));C.getById(w.pointerId)&&xt(T,w),e.stopEvent(w)}function xt(T,w){var C;C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()};var A={originalEvent:w,eventType:"pointerup",pointerType:C.type,isEmulated:!1};P(T,A),Pe(T,A,C,w.button),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w),A.shouldReleaseCapture&&(w.target===T.element?d(T,C):L(T,C,!1))}function st(T,w){gt(T,w)}function ot(T,w){var C=T.getActivePointersListByType(m(w));C.getById(w.pointerId)&&gt(T,w),e.stopEvent(w)}function gt(T,w){var C={id:f(w),type:m(w),isPrimary:v(w),currentPos:_(w),currentTime:e.now()},A={originalEvent:w,eventType:"pointermove",pointerType:C.type,isEmulated:!1};P(T,A),Te(T,A,C),A.preventDefault&&!A.defaultPrevented&&e.cancelEvent(w),A.stopPropagation&&e.stopEvent(w)}function mt(T,w){var C={id:w.pointerId,type:m(w)},A={originalEvent:w,eventType:"pointercancel",pointerType:C.type,isEmulated:!1};P(T,A),de(T,A,C),A.stopPropagation&&e.stopEvent(w)}function le(T,w){return w.speed=0,w.direction=0,w.contactPos=w.currentPos,w.contactTime=w.currentTime,w.lastPos=w.currentPos,w.lastTime=w.currentTime,T.add(w)}function Oe(T,w,C){var A,U=w.getById(C.id);return U?(U.captured&&(e.console.warn("stopTrackingPointer() called on captured pointer"),d(T,U)),w.removeContact(),A=w.removeById(C.id)):A=w.getLength(),A}function g(T,w){switch(w.eventType){case"pointermove":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!T.hasGestureHandlers,w.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break;case"pointerdown":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!T.hasGestureHandlers,w.stopPropagation=!1;break;case"pointerup":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!T.hasGestureHandlers,w.stopPropagation=!1;break;case"wheel":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!1,w.preventGesture=!T.hasScrollHandler,w.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":w.isStoppable=!0,w.isCancelable=!1,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break;case"click":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!!T.clickHandler,w.preventGesture=!1,w.stopPropagation=!1;break;case"dblclick":w.isStoppable=!0,w.isCancelable=!0,w.preventDefault=!!T.dblClickHandler,w.preventGesture=!1,w.stopPropagation=!1;break;case"focus":case"blur":case"pointerenter":case"pointerleave":default:w.isStoppable=!1,w.isCancelable=!1,w.preventDefault=!1,w.preventGesture=!1,w.stopPropagation=!1;break}}function P(T,w){w.eventSource=T,w.eventPhase=w.originalEvent&&typeof w.originalEvent.eventPhase<"u"?w.originalEvent.eventPhase:0,w.defaultPrevented=e.eventIsCanceled(w.originalEvent),w.shouldCapture=!1,w.shouldReleaseCapture=!1,w.userData=T.userData,g(T,w),T.preProcessEventHandler&&T.preProcessEventHandler(w)}function L(T,w,C){var A=T.getActivePointersListByType(w.type),U=A.getById(w.id);U?C&&!U.captured?(U.captured=!0,A.captureCount++):!C&&U.captured&&(U.captured=!1,A.captureCount--,A.captureCount<0&&(A.captureCount=0,e.console.warn("updatePointerCaptured() - pointsList.captureCount went negative"))):e.console.warn("updatePointerCaptured() called on untracked pointer")}function Y(T,w,C){var A=T.getActivePointersListByType(C.type),U;U=A.getById(C.id),U?(U.insideElement=!0,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime,C=U):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,le(A,C)),T.enterHandler&&T.enterHandler({eventSource:T,pointerType:C.type,position:b(C.currentPos,T.element),buttons:A.buttons,pointers:T.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData})}function te(T,w,C){var A=T.getActivePointersListByType(C.type),U,$;U=A.getById(C.id),U?(U.captured?(U.insideElement=!1,U.lastPos=U.currentPos,U.lastTime=U.currentTime,U.currentPos=C.currentPos,U.currentTime=C.currentTime):Oe(T,A,U),C=U):(C.captured=!1,C.insideElementPressed=!1),(T.leaveHandler||T.exitHandler)&&($={eventSource:T,pointerType:C.type,position:C.currentPos&&b(C.currentPos,T.element),buttons:A.buttons,pointers:T.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData},T.leaveHandler&&T.leaveHandler($),T.exitHandler&&T.exitHandler($))}function he(T,w,C){var A,U;A=T.getActivePointersListByType(C.type),U=A.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),T.overHandler&&T.overHandler({eventSource:T,pointerType:C.type,position:b(C.currentPos,T.element),buttons:A.buttons,pointers:T.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData})}function Z(T,w,C){var A,U;A=T.getActivePointersListByType(C.type),U=A.getById(C.id),U?C=U:(C.captured=!1,C.insideElementPressed=!1),T.outHandler&&T.outHandler({eventSource:T,pointerType:C.type,position:C.currentPos&&b(C.currentPos,T.element),buttons:A.buttons,pointers:T.getActivePointerCount(),insideElementPressed:C.insideElementPressed,buttonDownAny:A.buttons!==0,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData})}function ye(T,w,C,A){var U=i[T.hash],$=T.getActivePointersListByType(C.type),fe;if(typeof w.originalEvent.buttons<"u"?$.buttons=w.originalEvent.buttons:A===0?$.buttons|=1:A===1?$.buttons|=4:A===2?$.buttons|=2:A===3?$.buttons|=8:A===4?$.buttons|=16:A===5&&($.buttons|=32),A!==0){w.shouldCapture=!1,w.shouldReleaseCapture=!1,T.nonPrimaryPressHandler&&!w.preventGesture&&!w.defaultPrevented&&(w.preventDefault=!0,T.nonPrimaryPressHandler({eventSource:T,pointerType:C.type,position:b(C.currentPos,T.element),button:A,buttons:$.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData}));return}fe=$.getById(C.id),fe?(fe.insideElementPressed=!0,fe.insideElement=!0,fe.originalTarget=w.originalEvent.target,fe.contactPos=C.currentPos,fe.contactTime=C.currentTime,fe.lastPos=fe.currentPos,fe.lastTime=fe.currentTime,fe.currentPos=C.currentPos,fe.currentTime=C.currentTime,C=fe):(C.captured=!1,C.insideElementPressed=!0,C.insideElement=!0,C.originalTarget=w.originalEvent.target,le($,C)),$.addContact(),!w.preventGesture&&!w.defaultPrevented?(w.shouldCapture=!0,w.shouldReleaseCapture=!1,w.preventDefault=!0,(T.dragHandler||T.dragEndHandler||T.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.addPoint(T,C),$.contacts===1?T.pressHandler&&!w.preventGesture&&T.pressHandler({eventSource:T,pointerType:C.type,position:b(C.contactPos,T.element),buttons:$.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData}):$.contacts===2&&T.pinchHandler&&C.type==="touch"&&(U.pinchGPoints=$.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=k(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(w.shouldCapture=!1,w.shouldReleaseCapture=!1)}function Pe(T,w,C,A){var U=i[T.hash],$=T.getActivePointersListByType(C.type),fe,De,me,Ke=!1,je;if(typeof w.originalEvent.buttons<"u"?$.buttons=w.originalEvent.buttons:A===0?$.buttons^=-2:A===1?$.buttons^=-5:A===2?$.buttons^=-3:A===3?$.buttons^=-9:A===4?$.buttons^=-17:A===5&&($.buttons^=-33),w.shouldCapture=!1,A!==0){w.shouldReleaseCapture=!1,T.nonPrimaryReleaseHandler&&!w.preventGesture&&!w.defaultPrevented&&(w.preventDefault=!0,T.nonPrimaryReleaseHandler({eventSource:T,pointerType:C.type,position:b(C.currentPos,T.element),button:A,buttons:$.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData}));return}me=$.getById(C.id),me?($.removeContact(),me.captured&&(Ke=!0),me.lastPos=me.currentPos,me.lastTime=me.currentTime,me.currentPos=C.currentPos,me.currentTime=C.currentTime,me.insideElement||Oe(T,$,me),fe=me.currentPos,De=me.currentTime):(C.captured=!1,C.insideElementPressed=!1,C.insideElement=!0,le($,C),me=C),!w.preventGesture&&!w.defaultPrevented&&(Ke?(w.shouldReleaseCapture=!0,w.preventDefault=!0,(T.dragHandler||T.dragEndHandler||T.pinchHandler)&&e.MouseTracker.gesturePointVelocityTracker.removePoint(T,me),$.contacts===0?(T.releaseHandler&&fe&&T.releaseHandler({eventSource:T,pointerType:me.type,position:b(fe,T.element),buttons:$.buttons,insideElementPressed:me.insideElementPressed,insideElementReleased:me.insideElement,isTouchEvent:me.type==="touch",originalEvent:w.originalEvent,userData:T.userData}),T.dragEndHandler&&U.sentDragEvent&&T.dragEndHandler({eventSource:T,pointerType:me.type,position:b(me.currentPos,T.element),speed:me.speed,direction:me.direction,shift:w.originalEvent.shiftKey,isTouchEvent:me.type==="touch",originalEvent:w.originalEvent,userData:T.userData}),U.sentDragEvent=!1,(T.clickHandler||T.dblClickHandler)&&me.insideElement&&(je=De-me.contactTime<=T.clickTimeThreshold&&me.contactPos.distanceTo(fe)<=T.clickDistThreshold,T.clickHandler&&T.clickHandler({eventSource:T,pointerType:me.type,position:b(me.currentPos,T.element),quick:je,shift:w.originalEvent.shiftKey,isTouchEvent:me.type==="touch",originalEvent:w.originalEvent,originalTarget:me.originalTarget,userData:T.userData}),T.dblClickHandler&&je&&($.clicks++,$.clicks===1?(U.lastClickPos=fe,U.dblClickTimeOut=setTimeout(function(){$.clicks=0},T.dblClickTimeThreshold)):$.clicks===2&&(clearTimeout(U.dblClickTimeOut),$.clicks=0,U.lastClickPos.distanceTo(fe)<=T.dblClickDistThreshold&&T.dblClickHandler({eventSource:T,pointerType:me.type,position:b(me.currentPos,T.element),shift:w.originalEvent.shiftKey,isTouchEvent:me.type==="touch",originalEvent:w.originalEvent,userData:T.userData}),U.lastClickPos=null)))):$.contacts===2&&T.pinchHandler&&me.type==="touch"&&(U.pinchGPoints=$.asArray(),U.lastPinchDist=U.currentPinchDist=U.pinchGPoints[0].currentPos.distanceTo(U.pinchGPoints[1].currentPos),U.lastPinchCenter=U.currentPinchCenter=k(U.pinchGPoints[0].currentPos,U.pinchGPoints[1].currentPos))):(w.shouldReleaseCapture=!1,T.releaseHandler&&fe&&(T.releaseHandler({eventSource:T,pointerType:me.type,position:b(fe,T.element),buttons:$.buttons,insideElementPressed:me.insideElementPressed,insideElementReleased:me.insideElement,isTouchEvent:me.type==="touch",originalEvent:w.originalEvent,userData:T.userData}),w.preventDefault=!0)))}function Te(T,w,C){var A=i[T.hash],U=T.getActivePointersListByType(C.type),$,fe,De;if(typeof w.originalEvent.buttons<"u"&&(U.buttons=w.originalEvent.buttons),$=U.getById(C.id),$)$.lastPos=$.currentPos,$.lastTime=$.currentTime,$.currentPos=C.currentPos,$.currentTime=C.currentTime;else return;w.shouldCapture=!1,w.shouldReleaseCapture=!1,T.stopHandler&&C.type==="mouse"&&(clearTimeout(T.stopTimeOut),T.stopTimeOut=setTimeout(function(){Le(T,w.originalEvent,C.type)},T.stopDelay)),U.contacts===0?T.moveHandler&&T.moveHandler({eventSource:T,pointerType:C.type,position:b(C.currentPos,T.element),buttons:U.buttons,isTouchEvent:C.type==="touch",originalEvent:w.originalEvent,userData:T.userData}):U.contacts===1?(T.moveHandler&&($=U.asArray()[0],T.moveHandler({eventSource:T,pointerType:$.type,position:b($.currentPos,T.element),buttons:U.buttons,isTouchEvent:$.type==="touch",originalEvent:w.originalEvent,userData:T.userData})),T.dragHandler&&!w.preventGesture&&!w.defaultPrevented&&($=U.asArray()[0],De=$.currentPos.minus($.lastPos),T.dragHandler({eventSource:T,pointerType:$.type,position:b($.currentPos,T.element),buttons:U.buttons,delta:De,speed:$.speed,direction:$.direction,shift:w.originalEvent.shiftKey,isTouchEvent:$.type==="touch",originalEvent:w.originalEvent,userData:T.userData}),w.preventDefault=!0,A.sentDragEvent=!0)):U.contacts===2&&(T.moveHandler&&(fe=U.asArray(),T.moveHandler({eventSource:T,pointerType:fe[0].type,position:b(k(fe[0].currentPos,fe[1].currentPos),T.element),buttons:U.buttons,isTouchEvent:fe[0].type==="touch",originalEvent:w.originalEvent,userData:T.userData})),T.pinchHandler&&C.type==="touch"&&!w.preventGesture&&!w.defaultPrevented&&(De=A.pinchGPoints[0].currentPos.distanceTo(A.pinchGPoints[1].currentPos),De!==A.currentPinchDist&&(A.lastPinchDist=A.currentPinchDist,A.currentPinchDist=De,A.lastPinchCenter=A.currentPinchCenter,A.currentPinchCenter=k(A.pinchGPoints[0].currentPos,A.pinchGPoints[1].currentPos),T.pinchHandler({eventSource:T,pointerType:"touch",gesturePoints:A.pinchGPoints,lastCenter:b(A.lastPinchCenter,T.element),center:b(A.currentPinchCenter,T.element),lastDistance:A.lastPinchDist,distance:A.currentPinchDist,shift:w.originalEvent.shiftKey,originalEvent:w.originalEvent,userData:T.userData}),w.preventDefault=!0)))}function de(T,w,C){var A=T.getActivePointersListByType(C.type),U;U=A.getById(C.id),U&&Oe(T,A,U)}function Le(T,w,C){T.stopHandler&&T.stopHandler({eventSource:T,pointerType:C,position:E(w,T.element),buttons:T.getActivePointersListByType(C).buttons,isTouchEvent:C==="touch",originalEvent:w,userData:T.userData})}}(t),function(e){e.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},e.Control=function(i,n,r){var o=i.parentNode;typeof n=="number"&&(e.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),n={anchor:n}),n.attachToViewer=typeof n.attachToViewer>"u"?!0:n.attachToViewer,this.autoFade=typeof n.autoFade>"u"?!0:n.autoFade,this.element=i,this.anchor=n.anchor,this.container=r,this.anchor===e.ControlAnchor.ABSOLUTE?(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top=typeof n.top=="number"?n.top+"px":n.top,this.wrapper.style.left=typeof n.left=="number"?n.left+"px":n.left,this.wrapper.style.height=typeof n.height=="number"?n.height+"px":n.height,this.wrapper.style.width=typeof n.width=="number"?n.width+"px":n.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=e.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor===e.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),n.attachToViewer?this.anchor===e.ControlAnchor.TOP_RIGHT||this.anchor===e.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):o.appendChild(this.wrapper)},e.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.anchor!==e.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return this.wrapper.style.display!=="none"},setVisible:function(i){this.wrapper.style.display=i?this.anchor===e.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(i){e.setElementOpacity(this.wrapper,i,!0)}}}(t),function(e){e.ControlDock=function(n){var r=["topleft","topright","bottomright","bottomleft"],o,a;for(e.extend(!0,this,{id:"controldock-"+e.now()+"-"+Math.floor(Math.random()*1e6),container:e.makeNeutralElement("div"),controls:[]},n),this.container.onsubmit=function(){return!1},this.element&&(this.element=e.getElement(this.element),this.element.appendChild(this.container),e.getElementStyle(this.element).position==="static"&&(this.element.style.position="relative"),this.container.style.width="100%",this.container.style.height="100%"),a=0;a<r.length;a++)o=r[a],this.controls[o]=e.makeNeutralElement("div"),this.controls[o].style.position="absolute",o.match("left")&&(this.controls[o].style.left="0px"),o.match("right")&&(this.controls[o].style.right="0px"),o.match("top")&&(this.controls[o].style.top="0px"),o.match("bottom")&&(this.controls[o].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},e.ControlDock.prototype={addControl:function(n,r){n=e.getElement(n);var o=null;if(!(i(this,n)>=0)){switch(r.anchor){case e.ControlAnchor.TOP_RIGHT:o=this.controls.topright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.BOTTOM_RIGHT:o=this.controls.bottomright,n.style.position="relative",n.style.paddingRight="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.BOTTOM_LEFT:o=this.controls.bottomleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingBottom="0px";break;case e.ControlAnchor.TOP_LEFT:o=this.controls.topleft,n.style.position="relative",n.style.paddingLeft="0px",n.style.paddingTop="0px";break;case e.ControlAnchor.ABSOLUTE:o=this.container,n.style.margin="0px",n.style.padding="0px";break;default:case e.ControlAnchor.NONE:o=this.container,n.style.margin="0px",n.style.padding="0px";break}this.controls.push(new e.Control(n,r,o)),n.style.display="inline-block"}},removeControl:function(n){n=e.getElement(n);var r=i(this,n);return r>=0&&(this.controls[r].destroy(),this.controls.splice(r,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var n;for(n=this.controls.length-1;n>=0;n--)if(this.controls[n].isVisible())return!0;return!1},setControlsEnabled:function(n){var r;for(r=this.controls.length-1;r>=0;r--)this.controls[r].setVisible(n);return this}};function i(n,r){var o=n.controls,a;for(a=o.length-1;a>=0;a--)if(o[a].element===r)return a;return-1}}(t),function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(t),function(e){var i={},n=1;e.Viewer=function(g){var P=arguments,L=this,Y;e.isPlainObject(g)||(g={id:P[0],xmlPath:P.length>1?P[1]:void 0,prefixUrl:P.length>2?P[2]:void 0,controls:P.length>3?P[3]:void 0,overlays:P.length>4?P[4]:void 0}),g.config&&(e.extend(!0,g,g.config),delete g.config);let te=["useCanvas"];if(g.drawerOptions=Object.assign({},te.reduce((Z,ye)=>(Z[ye]=g[ye],delete g[ye],Z),{}),g.drawerOptions),e.extend(!0,this,{id:g.id,hash:g.hash||n++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},e.DEFAULT_SETTINGS,g),typeof this.hash>"u")throw new Error("A hash must be defined, either by specifying options.id or options.hash.");typeof i[this.hash]<"u"&&e.console.warn("Hash "+this.hash+" has already been used."),i[this.hash]={fsBoundsDelta:new e.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._updatePixelDensityRatioBind=null,this._lastScrollTime=e.now(),e.EventSource.call(this),this.addHandler("open-failed",function(Z){var ye=e.getString("Errors.OpenFailed",Z.eventSource,Z.message);L._showMessage(ye)}),e.ControlDock.call(this,g),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=e.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",function(Z){Z.width="100%",Z.height="100%",Z.overflow="hidden",Z.position="absolute",Z.top="0px",Z.left="0px"}(this.canvas.style),e.setElementTouchActionNone(this.canvas),g.tabIndex!==""&&(this.canvas.tabIndex=g.tabIndex===void 0?0:g.tabIndex),this.container.className="openseadragon-container",function(Z){Z.width="100%",Z.height="100%",Z.position="relative",Z.overflow="hidden",Z.left="0px",Z.top="0px",Z.textAlign="left"}(this.container.style),e.setElementTouchActionNone(this.container),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new e.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:e.delegate(this,E),keyDownHandler:e.delegate(this,b),keyHandler:e.delegate(this,k),clickHandler:e.delegate(this,V),dblClickHandler:e.delegate(this,W),dragHandler:e.delegate(this,z),dragEndHandler:e.delegate(this,j),enterHandler:e.delegate(this,D),leaveHandler:e.delegate(this,x),pressHandler:e.delegate(this,I),releaseHandler:e.delegate(this,M),nonPrimaryPressHandler:e.delegate(this,F),nonPrimaryReleaseHandler:e.delegate(this,O),scrollHandler:e.delegate(this,ae),pinchHandler:e.delegate(this,R),focusHandler:e.delegate(this,ne),blurHandler:e.delegate(this,ee)}),this.outerTracker=new e.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:e.delegate(this,q),leaveHandler:e.delegate(this,Q)}),this.toolbar&&(this.toolbar=new e.ControlDock({element:this.toolbar})),this.bindStandardControls(),i[this.hash].prevContainerSize=r(this.container),window.ResizeObserver?(this._autoResizePolling=!1,this._resizeObserver=new ResizeObserver(function(){i[L.hash].needsResize=!0}),this._resizeObserver.observe(this.container,{})):this._autoResizePolling=!0,this.world=new e.World({viewer:this}),this.world.addHandler("add-item",function(Z){L.source=L.world.getItemAt(0).source,i[L.hash].forceRedraw=!0,L._updateRequestId||(L._updateRequestId=u(L,J))}),this.world.addHandler("remove-item",function(Z){L.world.getItemCount()?L.source=L.world.getItemAt(0).source:L.source=null,i[L.hash].forceRedraw=!0}),this.world.addHandler("metrics-change",function(Z){L.viewport&&L.viewport._setContentBounds(L.world.getHomeBounds(),L.world.getContentFactor())}),this.world.addHandler("item-index-change",function(Z){L.source=L.world.getItemAt(0).source}),this.viewport=new e.Viewport({containerSize:i[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new e.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:g.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay}),this.tileCache=new e.TileCache({maxImageCacheCount:this.maxImageCacheCount}),Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")&&(e.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)'),this.drawerOptions.useCanvas||(this.drawer=e.HTMLDrawer),delete this.drawerOptions.useCanvas);let he=Array.isArray(this.drawer)?this.drawer:[this.drawer];he.length===0&&(he=[e.DEFAULT_SETTINGS.drawer].flat(),e.console.warn("No valid drawers were selected. Using the default value.")),this.drawer=null;for(const Z of he)if(this.requestDrawer(Z,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer)throw e.console.error("No drawer could be created!"),"Error with creating the selected drawer(s)";for(this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled),this.overlaysContainer=e.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(Y=this.buttonGroup.buttons.indexOf(this.rotateLeft),this.buttonGroup.buttons.splice(Y,1),this.buttonGroup.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(Y=this.buttonGroup.buttons.indexOf(this.rotateRight),this.buttonGroup.buttons.splice(Y,1),this.buttonGroup.element.removeChild(this.rotateRight.element))),this._addUpdatePixelDensityRatioEvent(),this.showNavigator&&(this.navigator=new e.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),Y=0;Y<this.customControls.length;Y++)this.addControl(this.customControls[Y].id,{anchor:this.customControls[Y].anchor});e.requestAnimationFrame(function(){d(L)}),e._viewers.set(this.element,this)},e.extend(e.Viewer.prototype,e.EventSource.prototype,e.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(g){return e.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(g)},openTileSource:function(g){return e.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(g)},get buttons(){return e.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup"),this.buttonGroup},open:function(g,P){var L=this;if(this.close(),!g)return this;if(this.sequenceMode&&e.isArray(g))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),typeof P<"u"&&!isNaN(P)&&(this.initialPage=P),this.tileSources=g,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),this._updateSequenceButtons(this._sequenceIndex),this;if(e.isArray(g)||(g=[g]),!g.length)return this;this._opening=!0;for(var Y=g.length,te=0,he=0,Z,ye=function(){if(te+he===Y)if(te){(L._firstOpen||!L.preserveViewport)&&(L.viewport.goHome(!0),L.viewport.update()),L._firstOpen=!1;var de=g[0];if(de.tileSource&&(de=de.tileSource),L.overlays&&!L.preserveOverlays)for(var Le=0;Le<L.overlays.length;Le++)L.currentOverlays[Le]=a(L,L.overlays[Le]);L._drawOverlays(),L._opening=!1,L.raiseEvent("open",{source:de})}else L._opening=!1,L.raiseEvent("open-failed",Z)},Pe=function(de){(!e.isPlainObject(de)||!de.tileSource)&&(de={tileSource:de}),de.index!==void 0&&(e.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete de.index),de.collectionImmediately===void 0&&(de.collectionImmediately=!0);var Le=de.success;de.success=function(w){if(te++,de.tileSource.overlays)for(var C=0;C<de.tileSource.overlays.length;C++)L.addOverlay(de.tileSource.overlays[C]);Le&&Le(w),ye()};var T=de.error;de.error=function(w){he++,Z||(Z=w),T&&T(w),ye()},L.addTiledImage(de)},Te=0;Te<g.length;Te++)Pe(g[Te]);return this},close:function(){return i[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),i[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(i[this.hash]){if(this.raiseEvent("before-destroy"),this._removeUpdatePixelDensityRatioEvent(),this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this._resizeObserver&&this._resizeObserver.disconnect(),this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),this._updateRequestId!==null&&(e.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.navigator&&(this.navigator.destroy(),i[this.navigator.hash]=null,delete i[this.navigator.hash],this.navigator=null),this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();if(this.paging&&this.paging.destroy(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.container.onsubmit=null,this.clearControls(),this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),i[this.hash]=null,delete i[this.hash],this.canvas=null,this.container=null,e._viewers.delete(this.element),this.element=null,this.raiseEvent("destroy"),this.removeAllHandlers()}},requestDrawer(g,P){const L={mainDrawer:!0,redrawImmediately:!0,drawerOptions:null};P=e.extend(!0,L,P);const Y=P.mainDrawer,te=P.redrawImmediately,he=P.drawerOptions,Z=this.drawer;let ye=null;if(g&&g.prototype instanceof e.DrawerBase?(ye=g,g="custom"):typeof g=="string"&&(ye=e.determineDrawer(g)),ye||e.console.warn("Unsupported drawer! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase."),ye&&ye.isSupported()){Z&&Y&&Z.destroy();const Pe=new ye({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:he||this.drawerOptions[g]});return Y&&(this.drawer=Pe,te&&this.forceRedraw()),Pe}return!1},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(g){return this.innerTracker.setTracking(g),this.outerTracker.setTracking(g),this.raiseEvent("mouse-enabled",{enabled:g}),this},areControlsEnabled:function(){var g=this.controls.length,P;for(P=0;P<this.controls.length;P++)g=g&&this.controls[P].isVisible();return g},setControlsEnabled:function(g){return g?m(this):d(this),this.raiseEvent("controls-enabled",{enabled:g}),this},setDebugMode:function(g){for(var P=0;P<this.world.getItemCount();P++)this.world.getItemAt(P).debugMode=g;this.debugMode=g,this.forceRedraw()},setAjaxHeaders:function(g,P){if(g===null&&(g={}),!e.isPlainObject(g)){console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}if(P===void 0&&(P=!0),this.ajaxHeaders=g,P){for(var L=0;L<this.world.getItemCount();L++)this.world.getItemAt(L)._updateAjaxHeaders(!0);if(this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0),this.referenceStrip&&this.referenceStrip.miniViewers)for(var Y in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[Y].setAjaxHeaders(this.ajaxHeaders,!0)}},addButton:function(g){this.buttonGroup.addButton(g)},isFullPage:function(){return i[this.hash]&&i[this.hash].fullPage},setFullPage:function(g){var P=document.body,L=P.style,Y=document.documentElement.style,te=this,he,Z;if(g===this.isFullPage())return this;var ye={fullPage:g,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",ye),ye.preventDefaultAction)return this;if(g&&this.element){for(this.elementSize=e.getElementSize(this.element),this.pageScroll=e.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=L.margin,this.docMargin=Y.margin,L.margin="0",Y.margin="0",this.bodyPadding=L.padding,this.docPadding=Y.padding,L.padding="0",Y.padding="0",this.bodyWidth=L.width,this.docWidth=Y.width,L.width="100%",Y.width="100%",this.bodyHeight=L.height,this.docHeight=Y.height,L.height="100%",Y.height="100%",this.bodyDisplay=L.display,L.display="block",this.previousBody=[],i[this.hash].prevElementParent=this.element.parentNode,i[this.hash].prevNextSibling=this.element.nextSibling,i[this.hash].prevElementWidth=this.element.style.width,i[this.hash].prevElementHeight=this.element.style.height,he=P.childNodes.length,Z=0;Z<he;Z++)this.previousBody.push(P.childNodes[0]),P.removeChild(P.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,P.appendChild(this.toolbar.element),e.addClass(this.toolbar.element,"fullpage")),e.addClass(this.element,"fullpage"),P.appendChild(this.element),this.element.style.height="100vh",this.element.style.width="100vw",this.toolbar&&this.toolbar.element&&(this.element.style.height=e.getElementSize(this.element).y-e.getElementSize(this.toolbar.element).y+"px"),i[this.hash].fullPage=!0,e.delegate(this,q)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,L.margin=this.bodyMargin,Y.margin=this.docMargin,L.padding=this.bodyPadding,Y.padding=this.docPadding,L.width=this.bodyWidth,Y.width=this.docWidth,L.height=this.bodyHeight,Y.height=this.docHeight,L.display=this.bodyDisplay,P.removeChild(this.element),he=this.previousBody.length,Z=0;Z<he;Z++)P.appendChild(this.previousBody.shift());e.removeClass(this.element,"fullpage"),i[this.hash].prevElementParent.insertBefore(this.element,i[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(P.removeChild(this.toolbar.element),e.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=i[this.hash].prevElementWidth,this.element.style.height=i[this.hash].prevElementHeight;var Pe=0,Te=function(){e.setPageScroll(te.pageScroll);var de=e.getPageScroll();Pe++,Pe<10&&(de.x!==te.pageScroll.x||de.y!==te.pageScroll.y)&&e.requestAnimationFrame(Te)};e.requestAnimationFrame(Te),i[this.hash].fullPage=!1,e.delegate(this,Q)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage:g}),this},setFullScreen:function(g){var P=this;if(!e.supportsFullScreen)return this.setFullPage(g);if(e.isFullScreen()===g)return this;var L={fullScreen:g,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",L),L.preventDefaultAction)return this;if(g){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var Y=function(){var te=e.isFullScreen();te||(e.removeEvent(document,e.fullScreenEventName,Y),e.removeEvent(document,e.fullScreenErrorEventName,Y),P.setFullPage(!1),P.isFullPage()&&(P.element.style.width=P.fullPageStyleWidth,P.element.style.height=P.fullPageStyleHeight)),P.navigator&&P.viewport&&setTimeout(function(){P.navigator.update(P.viewport)}),P.raiseEvent("full-screen",{fullScreen:te})};e.addEvent(document,e.fullScreenEventName,Y),e.addEvent(document,e.fullScreenErrorEventName,Y),e.requestFullScreen(document.body)}else e.exitFullScreen();return this},isVisible:function(){return this.container.style.visibility!=="hidden"},isFullScreen:function(){return e.isFullScreen()&&this.isFullPage()},setVisible:function(g){return this.container.style.visibility=g?"":"hidden",this.raiseEvent("visible",{visible:g}),this},addTiledImage:function(g){e.console.assert(g,"[Viewer.addTiledImage] options is required"),e.console.assert(g.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),e.console.assert(!g.replace||g.index>-1&&g.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var P=this;g.replace&&(g.replaceItem=P.world.getItemAt(g.index)),this._hideMessage(),g.placeholderFillStyle===void 0&&(g.placeholderFillStyle=this.placeholderFillStyle),g.opacity===void 0&&(g.opacity=this.opacity),g.preload===void 0&&(g.preload=this.preload),g.compositeOperation===void 0&&(g.compositeOperation=this.compositeOperation),g.crossOriginPolicy===void 0&&(g.crossOriginPolicy=g.tileSource.crossOriginPolicy!==void 0?g.tileSource.crossOriginPolicy:this.crossOriginPolicy),g.ajaxWithCredentials===void 0&&(g.ajaxWithCredentials=this.ajaxWithCredentials),g.loadTilesWithAjax===void 0&&(g.loadTilesWithAjax=this.loadTilesWithAjax),e.isPlainObject(g.ajaxHeaders)||(g.ajaxHeaders={});var L={options:g};function Y(Z){for(var ye=0;ye<P._loadQueue.length;ye++)if(P._loadQueue[ye]===L){P._loadQueue.splice(ye,1);break}P._loadQueue.length===0&&te(L),P.raiseEvent("add-item-failed",Z),g.error&&g.error(Z)}function te(Z){P.collectionMode&&(P.world.arrange({immediately:Z.options.collectionImmediately,rows:P.collectionRows,columns:P.collectionColumns,layout:P.collectionLayout,tileSize:P.collectionTileSize,tileMargin:P.collectionTileMargin}),P.world.setAutoRefigureSizes(!0))}if(e.isArray(g.tileSource)){setTimeout(function(){Y({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:g.tileSource,options:g})});return}this._loadQueue.push(L);function he(){for(var Z,ye,Pe;P._loadQueue.length&&(Z=P._loadQueue[0],!!Z.tileSource);){if(P._loadQueue.splice(0,1),Z.options.replace){var Te=P.world.getIndexOfItem(Z.options.replaceItem);Te!==-1&&(Z.options.index=Te),P.world.removeItem(Z.options.replaceItem)}ye=new e.TiledImage({viewer:P,source:Z.tileSource,viewport:P.viewport,drawer:P.drawer,tileCache:P.tileCache,imageLoader:P.imageLoader,x:Z.options.x,y:Z.options.y,width:Z.options.width,height:Z.options.height,fitBounds:Z.options.fitBounds,fitBoundsPlacement:Z.options.fitBoundsPlacement,clip:Z.options.clip,placeholderFillStyle:Z.options.placeholderFillStyle,opacity:Z.options.opacity,preload:Z.options.preload,degrees:Z.options.degrees,flipped:Z.options.flipped,compositeOperation:Z.options.compositeOperation,springStiffness:P.springStiffness,animationTime:P.animationTime,minZoomImageRatio:P.minZoomImageRatio,wrapHorizontal:P.wrapHorizontal,wrapVertical:P.wrapVertical,maxTilesPerFrame:P.maxTilesPerFrame,immediateRender:P.immediateRender,blendTime:P.blendTime,alwaysBlend:P.alwaysBlend,minPixelRatio:P.minPixelRatio,smoothTileEdgesMinZoom:P.smoothTileEdgesMinZoom,iOSDevice:P.iOSDevice,crossOriginPolicy:Z.options.crossOriginPolicy,ajaxWithCredentials:Z.options.ajaxWithCredentials,loadTilesWithAjax:Z.options.loadTilesWithAjax,ajaxHeaders:Z.options.ajaxHeaders,debugMode:P.debugMode,subPixelRoundingForTransparency:P.subPixelRoundingForTransparency}),P.collectionMode&&P.world.setAutoRefigureSizes(!1),P.navigator&&(Pe=e.extend({},Z.options,{replace:!1,originalTiledImage:ye,tileSource:Z.tileSource}),P.navigator.addTiledImage(Pe)),P.world.addItem(ye,{index:Z.options.index}),P._loadQueue.length===0&&te(Z),P.world.getItemCount()===1&&!P.preserveViewport&&P.viewport.goHome(!0),Z.options.success&&Z.options.success({item:ye})}}o(this,g.tileSource,g,function(Z){L.tileSource=Z,he()},function(Z){Z.options=g,Y(Z),he()})},addSimpleImage:function(g){e.console.assert(g,"[Viewer.addSimpleImage] options is required"),e.console.assert(g.url,"[Viewer.addSimpleImage] options.url is required");var P=e.extend({},g,{tileSource:{type:"image",url:g.url}});delete P.url,this.addTiledImage(P)},addLayer:function(g){var P=this;e.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var L=e.extend({},g,{success:function(Y){P.raiseEvent("add-layer",{options:g,drawer:Y.item})},error:function(Y){P.raiseEvent("add-layer-failed",Y)}});return this.addTiledImage(L),this},getLayerAtLevel:function(g){return e.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(g)},getLevelOfLayer:function(g){return e.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(g)},getLayersCount:function(){return e.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(g,P){return e.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(g,P)},removeLayer:function(g){return e.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(g)},forceRedraw:function(){return i[this.hash].forceRedraw=!0,this},forceResize:function(){i[this.hash].needsResize=!0,i[this.hash].forceResize=!0},bindSequenceControls:function(){var g=e.delegate(this,v),P=e.delegate(this,_),L=e.delegate(this,this.goToNextPage),Y=e.delegate(this,this.goToPreviousPage),te=this.navImages,he=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(he=!1),this.previousButton=new e.Button({element:this.previousButton?e.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.PreviousPage"),srcRest:X(this.prefixUrl,te.previous.REST),srcGroup:X(this.prefixUrl,te.previous.GROUP),srcHover:X(this.prefixUrl,te.previous.HOVER),srcDown:X(this.prefixUrl,te.previous.DOWN),onRelease:Y,onFocus:g,onBlur:P}),this.nextButton=new e.Button({element:this.nextButton?e.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.NextPage"),srcRest:X(this.prefixUrl,te.next.REST),srcGroup:X(this.prefixUrl,te.next.GROUP),srcHover:X(this.prefixUrl,te.next.HOVER),srcDown:X(this.prefixUrl,te.next.DOWN),onRelease:L,onFocus:g,onBlur:P}),this.navPrevNextWrap||this.previousButton.disable(),(!this.tileSources||!this.tileSources.length)&&this.nextButton.disable(),he&&(this.paging=new e.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:e.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||e.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var g=e.delegate(this,Se),P=e.delegate(this,tt),L=e.delegate(this,lt),Y=e.delegate(this,Re),te=e.delegate(this,xt),he=e.delegate(this,ot),Z=e.delegate(this,gt),ye=e.delegate(this,mt),Pe=e.delegate(this,le),Te=e.delegate(this,Oe),de=e.delegate(this,v),Le=e.delegate(this,_),T=this.navImages,w=[],C=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(C=!1),this.showZoomControl&&(w.push(this.zoomInButton=new e.Button({element:this.zoomInButton?e.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomIn"),srcRest:X(this.prefixUrl,T.zoomIn.REST),srcGroup:X(this.prefixUrl,T.zoomIn.GROUP),srcHover:X(this.prefixUrl,T.zoomIn.HOVER),srcDown:X(this.prefixUrl,T.zoomIn.DOWN),onPress:g,onRelease:P,onClick:L,onEnter:g,onExit:P,onFocus:de,onBlur:Le})),w.push(this.zoomOutButton=new e.Button({element:this.zoomOutButton?e.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.ZoomOut"),srcRest:X(this.prefixUrl,T.zoomOut.REST),srcGroup:X(this.prefixUrl,T.zoomOut.GROUP),srcHover:X(this.prefixUrl,T.zoomOut.HOVER),srcDown:X(this.prefixUrl,T.zoomOut.DOWN),onPress:Y,onRelease:P,onClick:te,onEnter:Y,onExit:P,onFocus:de,onBlur:Le}))),this.showHomeControl&&w.push(this.homeButton=new e.Button({element:this.homeButton?e.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Home"),srcRest:X(this.prefixUrl,T.home.REST),srcGroup:X(this.prefixUrl,T.home.GROUP),srcHover:X(this.prefixUrl,T.home.HOVER),srcDown:X(this.prefixUrl,T.home.DOWN),onRelease:he,onFocus:de,onBlur:Le})),this.showFullPageControl&&w.push(this.fullPageButton=new e.Button({element:this.fullPageButton?e.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.FullPage"),srcRest:X(this.prefixUrl,T.fullpage.REST),srcGroup:X(this.prefixUrl,T.fullpage.GROUP),srcHover:X(this.prefixUrl,T.fullpage.HOVER),srcDown:X(this.prefixUrl,T.fullpage.DOWN),onRelease:Z,onFocus:de,onBlur:Le})),this.showRotationControl&&(w.push(this.rotateLeftButton=new e.Button({element:this.rotateLeftButton?e.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateLeft"),srcRest:X(this.prefixUrl,T.rotateleft.REST),srcGroup:X(this.prefixUrl,T.rotateleft.GROUP),srcHover:X(this.prefixUrl,T.rotateleft.HOVER),srcDown:X(this.prefixUrl,T.rotateleft.DOWN),onRelease:ye,onFocus:de,onBlur:Le})),w.push(this.rotateRightButton=new e.Button({element:this.rotateRightButton?e.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.RotateRight"),srcRest:X(this.prefixUrl,T.rotateright.REST),srcGroup:X(this.prefixUrl,T.rotateright.GROUP),srcHover:X(this.prefixUrl,T.rotateright.HOVER),srcDown:X(this.prefixUrl,T.rotateright.DOWN),onRelease:Pe,onFocus:de,onBlur:Le}))),this.showFlipControl&&w.push(this.flipButton=new e.Button({element:this.flipButton?e.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:e.getString("Tooltips.Flip"),srcRest:X(this.prefixUrl,T.flip.REST),srcGroup:X(this.prefixUrl,T.flip.GROUP),srcHover:X(this.prefixUrl,T.flip.HOVER),srcDown:X(this.prefixUrl,T.flip.DOWN),onRelease:Te,onFocus:de,onBlur:Le})),C?(this.buttonGroup=new e.ButtonGroup({buttons:w,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttonGroup.element,this.addHandler("open",e.delegate(this,st)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||e.ControlAnchor.TOP_LEFT})):this.customButtons=w),this},currentPage:function(){return this._sequenceIndex},goToPage:function(g){return this.tileSources&&g>=0&&g<this.tileSources.length&&(this._sequenceIndex=g,this._updateSequenceButtons(g),this.open(this.tileSources[g]),this.referenceStrip&&this.referenceStrip.setFocus(g),this.raiseEvent("page",{page:g})),this},addOverlay:function(g,P,L,Y){var te;if(e.isPlainObject(g)?te=g:te={element:g,location:P,placement:L,onDraw:Y},g=e.getElement(te.element),l(this.currentOverlays,g)>=0)return this;var he=a(this,te);return this.currentOverlays.push(he),he.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element:g,location:te.location,placement:te.placement}),this},updateOverlay:function(g,P,L){var Y;return g=e.getElement(g),Y=l(this.currentOverlays,g),Y>=0&&(this.currentOverlays[Y].update(P,L),i[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element:g,location:P,placement:L})),this},removeOverlay:function(g){var P;return g=e.getElement(g),P=l(this.currentOverlays,g),P>=0&&(this.currentOverlays[P].destroy(),this.currentOverlays.splice(P,1),i[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element:g})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return i[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(g){var P;return g=e.getElement(g),P=l(this.currentOverlays,g),P>=0?this.currentOverlays[P]:null},_updateSequenceButtons:function(g){this.nextButton&&(!this.tileSources||this.tileSources.length-1===g?this.navPrevNextWrap||this.nextButton.disable():this.nextButton.enable()),this.previousButton&&(g>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(g){this._hideMessage();var P=e.makeNeutralElement("div");P.appendChild(document.createTextNode(g)),this.messageDiv=e.makeCenteredNode(P),e.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var g=this.messageDiv;g&&(g.parentNode.removeChild(g),delete this.messageDiv)},gestureSettingsByDeviceType:function(g){switch(g){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var g,P=this.currentOverlays.length;for(g=0;g<P;g++)this.currentOverlays[g].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new e.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else e.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this),e.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){e.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var g=e.pixelDensityRatio,P=e.getCurrentPixelDensityRatio();g!==P&&(e.pixelDensityRatio=P,this.forceResize())},goToPreviousPage:function(){var g=this._sequenceIndex-1;this.navPrevNextWrap&&g<0&&(g+=this.tileSources.length),this.goToPage(g)},goToNextPage:function(){var g=this._sequenceIndex+1;this.navPrevNextWrap&&g>=this.tileSources.length&&(g=0),this.goToPage(g)},isAnimating:function(){return i[this.hash].animating}});function r(g){return g=e.getElement(g),new e.Point(g.clientWidth===0?1:g.clientWidth,g.clientHeight===0?1:g.clientHeight)}function o(g,P,L,Y,te){var he=g;if(e.type(P)==="string"){if(P.match(/^\s*<.*>\s*$/))P=e.parseXml(P);else if(P.match(/^\s*[{[].*[}\]]\s*$/))try{var Z=e.parseJSON(P);P=Z}catch{}}function ye(Pe,Te){Pe.ready?Y(Pe):(Pe.addHandler("ready",function(){Y(Pe)}),Pe.addHandler("open-failed",function(de){te({message:de.message,source:Te})}))}setTimeout(function(){if(e.type(P)==="string")P=new e.TileSource({url:P,crossOriginPolicy:L.crossOriginPolicy!==void 0?L.crossOriginPolicy:g.crossOriginPolicy,ajaxWithCredentials:g.ajaxWithCredentials,ajaxHeaders:L.ajaxHeaders?L.ajaxHeaders:g.ajaxHeaders,splitHashDataForPost:g.splitHashDataForPost,success:function(Le){Y(Le.tileSource)}}),P.addHandler("open-failed",function(Le){te(Le)});else if(e.isPlainObject(P)||P.nodeType)if(P.crossOriginPolicy===void 0&&(L.crossOriginPolicy!==void 0||g.crossOriginPolicy!==void 0)&&(P.crossOriginPolicy=L.crossOriginPolicy!==void 0?L.crossOriginPolicy:g.crossOriginPolicy),P.ajaxWithCredentials===void 0&&(P.ajaxWithCredentials=g.ajaxWithCredentials),e.isFunction(P.getTileUrl)){var Pe=new e.TileSource(P);Pe.getTileUrl=P.getTileUrl,Y(Pe)}else{var Te=e.TileSource.determineType(he,P);if(!Te){te({message:"Unable to load TileSource",source:P});return}var de=Te.prototype.configure.apply(he,[P]);ye(new Te(de),P)}else ye(P,P)})}function a(g,P){if(P instanceof e.Overlay)return P;var L=null;if(P.element)L=e.getElement(P.element);else{var Y=P.id?P.id:"openseadragon-overlay-"+Math.floor(Math.random()*1e7);L=e.getElement(P.id),L||(L=document.createElement("a"),L.href="#/overlay/"+Y),L.id=Y,e.addClass(L,P.className?P.className:"openseadragon-overlay")}var te=P.location,he=P.width,Z=P.height;if(!te){var ye=P.x,Pe=P.y;if(P.px!==void 0){var Te=g.viewport.imageToViewportRectangle(new e.Rect(P.px,P.py,he||0,Z||0));ye=Te.x,Pe=Te.y,he=he!==void 0?Te.width:void 0,Z=Z!==void 0?Te.height:void 0}te=new e.Point(ye,Pe)}var de=P.placement;return de&&e.type(de)==="string"&&(de=e.Placement[P.placement.toUpperCase()]),new e.Overlay({element:L,location:te,placement:de,onDraw:P.onDraw,checkResize:P.checkResize,width:he,height:Z,rotationMode:P.rotationMode})}function l(g,P){var L;for(L=g.length-1;L>=0;L--)if(g[L].element===P)return L;return-1}function u(g,P){return e.requestAnimationFrame(function(){P(g)})}function h(g){e.requestAnimationFrame(function(){f(g)})}function d(g){g.autoHideControls&&(g.controlsShouldFade=!0,g.controlsFadeBeginTime=e.now()+g.controlsFadeDelay,window.setTimeout(function(){h(g)},g.controlsFadeDelay))}function f(g){var P,L,Y,te;if(g.controlsShouldFade){for(P=e.now(),L=P-g.controlsFadeBeginTime,Y=1-L/g.controlsFadeLength,Y=Math.min(1,Y),Y=Math.max(0,Y),te=g.controls.length-1;te>=0;te--)g.controls[te].autoFade&&g.controls[te].setOpacity(Y);Y>0&&h(g)}}function m(g){var P;for(g.controlsShouldFade=!1,P=g.controls.length-1;P>=0;P--)g.controls[P].setOpacity(1)}function v(){m(this)}function _(){d(this)}function E(g){var P={tracker:g.eventSource,position:g.position,originalEvent:g.originalEvent,preventDefault:g.preventDefault};this.raiseEvent("canvas-contextmenu",P),g.preventDefault=P.preventDefault}function b(g){var P={originalEvent:g.originalEvent,preventDefaultAction:!1,preventVerticalPan:g.preventVerticalPan||!this.panVertical,preventHorizontalPan:g.preventHorizontalPan||!this.panHorizontal};if(this.raiseEvent("canvas-key",P),!P.preventDefaultAction&&!g.ctrl&&!g.alt&&!g.meta)switch(g.keyCode){case 38:P.preventVerticalPan||(g.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 40:P.preventVerticalPan||(g.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 37:P.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 39:P.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 48:this.viewport.goHome(),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 87:P.preventVerticalPan||(g.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,-40))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 83:P.preventVerticalPan||(g.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(0,40))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 65:P.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(-40,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 68:P.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new e.Point(40,0))),this.viewport.applyConstraints()),g.preventDefault=!0;break;case 82:g.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement),this.viewport.applyConstraints(),g.preventDefault=!0;break;case 70:this.viewport.toggleFlip(),g.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:g.preventDefault=!1;break}else g.preventDefault=!1}function k(g){var P={originalEvent:g.originalEvent};this.raiseEvent("canvas-key-press",P)}function V(g){var P,L=document.activeElement===this.canvas;L||this.canvas.focus(),this.viewport.flipped&&(g.position.x=this.viewport.getContainerSize().x-g.position.x);var Y={tracker:g.eventSource,position:g.position,quick:g.quick,shift:g.shift,originalEvent:g.originalEvent,originalTarget:g.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",Y),!Y.preventDefaultAction&&this.viewport&&g.quick&&(P=this.gestureSettingsByDeviceType(g.pointerType),P.clickToZoom===!0&&(this.viewport.zoomBy(g.shift?1/this.zoomPerClick:this.zoomPerClick,P.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints()),P.dblClickDragToZoom&&(i[this.hash].draggingToZoom===!0?(i[this.hash].lastClickTime=null,i[this.hash].draggingToZoom=!1):i[this.hash].lastClickTime=e.now()))}function W(g){var P,L={tracker:g.eventSource,position:g.position,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",L),!L.preventDefaultAction&&this.viewport&&(P=this.gestureSettingsByDeviceType(g.pointerType),P.dblClickToZoom&&(this.viewport.zoomBy(g.shift?1/this.zoomPerClick:this.zoomPerClick,P.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints()))}function z(g){var P,L={tracker:g.eventSource,pointerType:g.pointerType,position:g.position,delta:g.delta,speed:g.speed,direction:g.direction,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag",L),P=this.gestureSettingsByDeviceType(g.pointerType),!L.preventDefaultAction&&this.viewport){if(P.dblClickDragToZoom&&i[this.hash].draggingToZoom){var Y=Math.pow(this.zoomPerDblClickDrag,g.delta.y/50);this.viewport.zoomBy(Y)}else if(P.dragToPan&&!i[this.hash].draggingToZoom){if(this.panHorizontal||(g.delta.x=0),this.panVertical||(g.delta.y=0),this.viewport.flipped&&(g.delta.x=-g.delta.x),this.constrainDuringPan){var te=this.viewport.deltaPointsFromPixels(g.delta.negate());this.viewport.centerSpringX.target.value+=te.x,this.viewport.centerSpringY.target.value+=te.y;var he=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=te.x,this.viewport.centerSpringY.target.value-=te.y,he.xConstrained&&(g.delta.x=0),he.yConstrained&&(g.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(g.delta.negate()),P.flickEnabled&&!this.constrainDuringPan)}}}function j(g){var P,L={tracker:g.eventSource,pointerType:g.pointerType,position:g.position,speed:g.speed,direction:g.direction,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1};if(this.raiseEvent("canvas-drag-end",L),P=this.gestureSettingsByDeviceType(g.pointerType),!L.preventDefaultAction&&this.viewport){if(!i[this.hash].draggingToZoom&&P.dragToPan&&P.flickEnabled&&g.speed>=P.flickMinSpeed){var Y=0;this.panHorizontal&&(Y=P.flickMomentum*g.speed*Math.cos(g.direction));var te=0;this.panVertical&&(te=P.flickMomentum*g.speed*Math.sin(g.direction));var he=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),Z=this.viewport.pointFromPixel(new e.Point(he.x-Y,he.y-te));this.viewport.panTo(Z,!1)}this.viewport.applyConstraints()}P.dblClickDragToZoom&&i[this.hash].draggingToZoom===!0&&(i[this.hash].draggingToZoom=!1)}function D(g){this.raiseEvent("canvas-enter",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function x(g){this.raiseEvent("canvas-exit",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function I(g){var P;if(this.raiseEvent("canvas-press",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElementReleased,originalEvent:g.originalEvent}),P=this.gestureSettingsByDeviceType(g.pointerType),P.dblClickDragToZoom){var L=i[this.hash].lastClickTime,Y=e.now();if(L===null)return;Y-L<this.dblClickTimeThreshold&&(i[this.hash].draggingToZoom=!0),i[this.hash].lastClickTime=null}}function M(g){this.raiseEvent("canvas-release",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,insideElementPressed:g.insideElementPressed,insideElementReleased:g.insideElementReleased,originalEvent:g.originalEvent})}function F(g){this.raiseEvent("canvas-nonprimary-press",{tracker:g.eventSource,position:g.position,pointerType:g.pointerType,button:g.button,buttons:g.buttons,originalEvent:g.originalEvent})}function O(g){this.raiseEvent("canvas-nonprimary-release",{tracker:g.eventSource,position:g.position,pointerType:g.pointerType,button:g.button,buttons:g.buttons,originalEvent:g.originalEvent})}function R(g){var P,L,Y,te,he={tracker:g.eventSource,pointerType:g.pointerType,gesturePoints:g.gesturePoints,lastCenter:g.lastCenter,center:g.center,lastDistance:g.lastDistance,distance:g.distance,shift:g.shift,originalEvent:g.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};if(this.raiseEvent("canvas-pinch",he),this.viewport&&(P=this.gestureSettingsByDeviceType(g.pointerType),P.pinchToZoom&&(!he.preventDefaultPanAction||!he.preventDefaultZoomAction)&&(L=this.viewport.pointFromPixel(g.center,!0),P.zoomToRefPoint&&!he.preventDefaultPanAction&&(Y=this.viewport.pointFromPixel(g.lastCenter,!0),te=Y.minus(L),this.panHorizontal||(te.x=0),this.panVertical||(te.y=0),this.viewport.panBy(te,!0)),he.preventDefaultZoomAction||this.viewport.zoomBy(g.distance/g.lastDistance,L,!0),this.viewport.applyConstraints()),P.pinchRotate&&!he.preventDefaultRotateAction)){var Z=Math.atan2(g.gesturePoints[0].currentPos.y-g.gesturePoints[1].currentPos.y,g.gesturePoints[0].currentPos.x-g.gesturePoints[1].currentPos.x),ye=Math.atan2(g.gesturePoints[0].lastPos.y-g.gesturePoints[1].lastPos.y,g.gesturePoints[0].lastPos.x-g.gesturePoints[1].lastPos.x);L=this.viewport.pointFromPixel(g.center,!0),this.viewport.rotateTo(this.viewport.getRotation(!0)+(Z-ye)*(180/Math.PI),L,!0)}}function ne(g){this.raiseEvent("canvas-focus",{tracker:g.eventSource,originalEvent:g.originalEvent})}function ee(g){this.raiseEvent("canvas-blur",{tracker:g.eventSource,originalEvent:g.originalEvent})}function ae(g){var P,L,Y,te,he;te=e.now(),he=te-this._lastScrollTime,he>this.minScrollDeltaTime?(this._lastScrollTime=te,P={tracker:g.eventSource,position:g.position,scroll:g.scroll,shift:g.shift,originalEvent:g.originalEvent,preventDefaultAction:!1,preventDefault:!0},this.raiseEvent("canvas-scroll",P),!P.preventDefaultAction&&this.viewport&&(this.viewport.flipped&&(g.position.x=this.viewport.getContainerSize().x-g.position.x),L=this.gestureSettingsByDeviceType(g.pointerType),L.scrollToZoom&&(Y=Math.pow(this.zoomPerScroll,g.scroll),this.viewport.zoomBy(Y,L.zoomToRefPoint?this.viewport.pointFromPixel(g.position,!0):null),this.viewport.applyConstraints())),g.preventDefault=P.preventDefault):g.preventDefault=!0}function q(g){i[this.hash].mouseInside=!0,m(this),this.raiseEvent("container-enter",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function Q(g){g.pointers<1&&(i[this.hash].mouseInside=!1,i[this.hash].animating||d(this)),this.raiseEvent("container-exit",{tracker:g.eventSource,pointerType:g.pointerType,position:g.position,buttons:g.buttons,pointers:g.pointers,insideElementPressed:g.insideElementPressed,buttonDownAny:g.buttonDownAny,originalEvent:g.originalEvent})}function J(g){xe(g),g.isOpen()?g._updateRequestId=u(g,J):g._updateRequestId=!1}function se(g,P){var L=g.viewport,Y=L.getZoom(),te=L.getCenter();L.resize(P,g.preserveImageSizeOnResize),L.panTo(te,!0);var he;if(g.preserveImageSizeOnResize)he=i[g.hash].prevContainerSize.x/P.x;else{var Z=new e.Point(0,0),ye=new e.Point(i[g.hash].prevContainerSize.x,i[g.hash].prevContainerSize.y).distanceTo(Z),Pe=new e.Point(P.x,P.y).distanceTo(Z);he=Pe/ye*i[g.hash].prevContainerSize.x/P.x}L.zoomTo(Y*he,null,!0),i[g.hash].prevContainerSize=P,i[g.hash].forceRedraw=!0,i[g.hash].needsResize=!1,i[g.hash].forceResize=!1}function xe(g){if(!(g._opening||!i[g.hash])){if(g.autoResize||i[g.hash].forceResize){var P;if(g._autoResizePolling){P=r(g.container);var L=i[g.hash].prevContainerSize;P.equals(L)||(i[g.hash].needsResize=!0)}i[g.hash].needsResize&&se(g,P||r(g.container))}var Y=g.viewport.update(),te=g.world.update(Y)||Y;Y&&g.raiseEvent("viewport-change"),g.referenceStrip&&(te=g.referenceStrip.update(g.viewport)||te);var he=i[g.hash].animating;!he&&te&&(g.raiseEvent("animation-start"),m(g));var Z=he&&!te;Z&&(i[g.hash].animating=!1),(te||Z||i[g.hash].forceRedraw||g.world.needsDraw())&&(pe(g),g._drawOverlays(),g.navigator&&g.navigator.update(g.viewport),i[g.hash].forceRedraw=!1,te&&g.raiseEvent("animation")),Z&&(g.raiseEvent("animation-finish"),i[g.hash].mouseInside||d(g)),i[g.hash].animating=te}}function pe(g){g.imageLoader.clear(),g.world.draw(),g.raiseEvent("update-viewport",{})}function X(g,P){return g?g+P:P}function Se(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=this.zoomPerSecond,i[this.hash].zooming=!0,We(this)}function Re(){i[this.hash].lastZoomTime=e.now(),i[this.hash].zoomFactor=1/this.zoomPerSecond,i[this.hash].zooming=!0,We(this)}function tt(){i[this.hash].zooming=!1}function We(g){e.requestAnimationFrame(e.delegate(g,pt))}function pt(){var g,P,L;i[this.hash].zooming&&this.viewport&&(g=e.now(),P=g-i[this.hash].lastZoomTime,L=Math.pow(i[this.hash].zoomFactor,P/1e3),this.viewport.zoomBy(L),this.viewport.applyConstraints(),i[this.hash].lastZoomTime=g,We(this))}function lt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function xt(){this.viewport&&(i[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function st(){this.buttonGroup&&(this.buttonGroup.emulateEnter(),this.buttonGroup.emulateLeave())}function ot(){this.viewport&&this.viewport.goHome()}function gt(){this.isFullPage()&&!e.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttonGroup&&this.buttonGroup.emulateLeave(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function mt(){if(this.viewport){var g=this.viewport.getRotation();this.viewport.flipped?g+=this.rotationIncrement:g-=this.rotationIncrement,this.viewport.setRotation(g)}}function le(){if(this.viewport){var g=this.viewport.getRotation();this.viewport.flipped?g-=this.rotationIncrement:g+=this.rotationIncrement,this.viewport.setRotation(g)}}function Oe(){this.viewport.toggleFlip()}e.determineDrawer=function(g){for(let P in t){const L=t[P],Y=L.prototype;if(Y&&Y instanceof t.DrawerBase&&e.isFunction(Y.getType)&&Y.getType.call(L)===g)return L}return null}}(t),function(e){e.Navigator=function(u){var h=u.viewer,d=this,f,m;u.element||u.id?(u.element?(u.id&&e.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead."),u.element.id?u.id=u.element.id:u.id="navigator-"+e.now(),this.element=u.element):this.element=document.getElementById(u.id),u.controlOptions={anchor:e.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(u.id="navigator-"+e.now(),this.element=e.makeNeutralElement("div"),u.controlOptions={anchor:e.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:u.autoFade},u.position&&(u.position==="BOTTOM_RIGHT"?u.controlOptions.anchor=e.ControlAnchor.BOTTOM_RIGHT:u.position==="BOTTOM_LEFT"?u.controlOptions.anchor=e.ControlAnchor.BOTTOM_LEFT:u.position==="TOP_RIGHT"?u.controlOptions.anchor=e.ControlAnchor.TOP_RIGHT:u.position==="TOP_LEFT"?u.controlOptions.anchor=e.ControlAnchor.TOP_LEFT:u.position==="ABSOLUTE"&&(u.controlOptions.anchor=e.ControlAnchor.ABSOLUTE,u.controlOptions.top=u.top,u.controlOptions.left=u.left,u.controlOptions.height=u.height,u.controlOptions.width=u.width))),this.element.id=u.id,this.element.className+=" navigator",u=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.navigatorSizeRatio},u,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:u.animationTime,autoResize:!1,minZoomImageRatio:1,background:u.background,opacity:u.opacity,borderColor:u.borderColor,displayRegionColor:u.displayRegionColor}),u.minPixelRatio=this.minPixelRatio=h.minPixelRatio,e.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new e.Point(1,1),this.totalBorderWidths=new e.Point(this.borderWidth*2,this.borderWidth*2).minus(this.fudge),u.controlOptions.anchor!==e.ControlAnchor.NONE&&function(E,b){E.margin="0px",E.border=b+"px solid "+u.borderColor,E.padding="0px",E.background=u.background,E.opacity=u.opacity,E.overflow="hidden"}(this.element.style,this.borderWidth),this.displayRegion=e.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(E,b){E.position="relative",E.top="0px",E.left="0px",E.fontSize="0px",E.overflow="hidden",E.border=b+"px solid "+u.displayRegionColor,E.margin="0px",E.padding="0px",E.background="transparent",E.float="left",E.cssFloat="left",E.zIndex=999999999,E.cursor="default",E.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth),e.setElementPointerEventsNone(this.displayRegion),e.setElementTouchActionNone(this.displayRegion),this.displayRegionContainer=e.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",e.setElementPointerEventsNone(this.displayRegionContainer),e.setElementTouchActionNone(this.displayRegionContainer),h.addControl(this.element,u.controlOptions),this._resizeWithViewer=u.controlOptions.anchor!==e.ControlAnchor.ABSOLUTE&&u.controlOptions.anchor!==e.ControlAnchor.NONE,u.width&&u.height?(this.setWidth(u.width),this.setHeight(u.height)):this._resizeWithViewer&&(f=e.getElementSize(h.element),this.element.style.height=Math.round(f.y*u.sizeRatio)+"px",this.element.style.width=Math.round(f.x*u.sizeRatio)+"px",this.oldViewerSize=f,m=e.getElementSize(this.element),this.elementArea=m.x*m.y),this.oldContainerSize=new e.Point(0,0),e.Viewer.apply(this,[u]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function v(E,b){a(d.displayRegionContainer,E),a(d.displayRegion,-E),d.viewport.setRotation(E,b)}if(u.navigatorRotate){var _=u.viewer.viewport?u.viewer.viewport.getRotation():u.viewer.degrees||0;v(_,!0),u.viewer.addHandler("rotate",function(E){v(E.degrees,E.immediately)})}this.innerTracker.destroy(),this.innerTracker=new e.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:e.delegate(this,n),clickHandler:e.delegate(this,i),releaseHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),preProcessEventHandler:function(E){E.eventType==="wheel"&&(E.preventDefault=!0)}}),this.outerTracker.userData="Navigator.outerTracker",e.setElementPointerEventsNone(this.canvas),e.setElementPointerEventsNone(this.container),this.addHandler("reset-size",function(){d.viewport&&d.viewport.goHome(!0)}),h.world.addHandler("item-index-change",function(E){window.setTimeout(function(){var b=d.world.getItemAt(E.previousIndex);d.world.setItemIndex(b,E.newIndex)},1)}),h.world.addHandler("remove-item",function(E){var b=E.item,k=d._getMatchingItem(b);k&&d.world.removeItem(k)}),this.update(h.viewport)},e.extend(e.Navigator.prototype,e.EventSource.prototype,e.Viewer.prototype,{updateSize:function(){if(this.viewport){var u=new e.Point(this.container.clientWidth===0?1:this.container.clientWidth,this.container.clientHeight===0?1:this.container.clientHeight);u.equals(this.oldContainerSize)||(this.viewport.resize(u,!0),this.viewport.goHome(!0),this.oldContainerSize=u,this.world.update(),this.world.draw(),this.update(this.viewer.viewport))}},setWidth:function(u){this.width=u,this.element.style.width=typeof u=="number"?u+"px":u,this._resizeWithViewer=!1,this.updateSize()},setHeight:function(u){this.height=u,this.element.style.height=typeof u=="number"?u+"px":u,this._resizeWithViewer=!1,this.updateSize()},setFlip:function(u){return this.viewport.setFlip(u),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(u){l(this.canvas,u),l(this.element,u)},update:function(u){var h,d,f,m,v,_;if(u||(u=this.viewer.viewport),h=e.getElementSize(this.viewer.element),this._resizeWithViewer&&h.x&&h.y&&!h.equals(this.oldViewerSize)&&(this.oldViewerSize=h,this.maintainSizeRatio||!this.elementArea?(d=h.x*this.sizeRatio,f=h.y*this.sizeRatio):(d=Math.sqrt(this.elementArea*(h.x/h.y)),f=this.elementArea/d),this.element.style.width=Math.round(d)+"px",this.element.style.height=Math.round(f)+"px",this.elementArea||(this.elementArea=d*f),this.updateSize()),u&&this.viewport){if(m=u.getBoundsNoRotate(!0),v=this.viewport.pixelFromPointNoRotate(m.getTopLeft(),!1),_=this.viewport.pixelFromPointNoRotate(m.getBottomRight(),!1).minus(this.totalBorderWidths),!this.navigatorRotate){var E=u.getRotation(!0);a(this.displayRegion,-E)}var b=this.displayRegion.style;b.display=this.world.getItemCount()?"block":"none",b.top=v.y.toFixed(2)+"px",b.left=v.x.toFixed(2)+"px";var k=_.x-v.x,V=_.y-v.y;b.width=Math.round(Math.max(k,0))+"px",b.height=Math.round(Math.max(V,0))+"px"}},addTiledImage:function(u){var h=this,d=u.originalTiledImage;delete u.original;var f=e.extend({},u,{success:function(m){var v=m.item;v._originalForNavigator=d,h._matchBounds(v,d,!0),h._matchOpacity(v,d),h._matchCompositeOperation(v,d);function _(){h._matchBounds(v,d)}function E(){h._matchOpacity(v,d)}function b(){h._matchCompositeOperation(v,d)}d.addHandler("bounds-change",_),d.addHandler("clip-change",_),d.addHandler("opacity-change",E),d.addHandler("composite-operation-change",b)}});return e.Viewer.prototype.addTiledImage.apply(this,[f])},destroy:function(){return e.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(u){for(var h=this.world.getItemCount(),d,f=0;f<h;f++)if(d=this.world.getItemAt(f),d._originalForNavigator===u)return d;return null},_matchBounds:function(u,h,d){var f=h.getBoundsNoRotate();u.setPosition(f.getTopLeft(),d),u.setWidth(f.width,d),u.setRotation(h.getRotation(),d),u.setClip(h.getClip()),u.setFlip(h.getFlip())},_matchOpacity:function(u,h){u.setOpacity(h.opacity)},_matchCompositeOperation:function(u,h){u.setCompositeOperation(h.compositeOperation)}});function i(u){var h={tracker:u.eventSource,position:u.position,quick:u.quick,shift:u.shift,originalEvent:u.originalEvent,preventDefaultAction:!1};if(this.viewer.raiseEvent("navigator-click",h),!h.preventDefaultAction&&u.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(u.position.x=this.viewport.getContainerSize().x-u.position.x);var d=this.viewport.pointFromPixel(u.position);this.panVertical?this.panHorizontal||(d.x=this.viewer.viewport.getCenter(!0).x):d.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(d),this.viewer.viewport.applyConstraints()}}function n(u){var h={tracker:u.eventSource,position:u.position,delta:u.delta,speed:u.speed,direction:u.direction,shift:u.shift,originalEvent:u.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",h),!h.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(u.delta.x=0),this.panVertical||(u.delta.y=0),this.viewer.viewport.flipped&&(u.delta.x=-u.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(u.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function r(u){u.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function o(u){var h={tracker:u.eventSource,position:u.position,scroll:u.scroll,shift:u.shift,originalEvent:u.originalEvent,preventDefault:u.preventDefault};this.viewer.raiseEvent("navigator-scroll",h),u.preventDefault=h.preventDefault}function a(u,h){l(u,"rotate("+h+"deg)")}function l(u,h){u.style.webkitTransform=h,u.style.mozTransform=h,u.style.msTransform=h,u.style.oTransform=h,u.style.transform=h}}(t),function(e){var i={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};e.extend(e,{getString:function(n){var r=n.split("."),o=null,a=arguments,l=i,u;for(u=0;u<r.length-1;u++)l=l[r[u]]||{};return o=l[r[u]],typeof o!="string"&&(e.console.error("Untranslated source string:",n),o=""),o.replace(/\{\d+\}/g,function(h){var d=parseInt(h.match(/\d+/),10)+1;return d<a.length?a[d]:""})},setString:function(n,r){var o=n.split("."),a=i,l;for(l=0;l<o.length-1;l++)a[o[l]]||(a[o[l]]={}),a=a[o[l]];a[o[l]]=r}})}(t),function(e){e.Point=function(i,n){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0},e.Point.prototype={clone:function(){return new e.Point(this.x,this.y)},plus:function(i){return new e.Point(this.x+i.x,this.y+i.y)},minus:function(i){return new e.Point(this.x-i.x,this.y-i.y)},times:function(i){return new e.Point(this.x*i,this.y*i)},divide:function(i){return new e.Point(this.x/i,this.y/i)},negate:function(){return new e.Point(-this.x,-this.y)},distanceTo:function(i){return Math.sqrt(Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2))},squaredDistanceTo:function(i){return Math.pow(this.x-i.x,2)+Math.pow(this.y-i.y,2)},apply:function(i){return new e.Point(i(this.x),i(this.y))},equals:function(i){return i instanceof e.Point&&this.x===i.x&&this.y===i.y},rotate:function(i,n){n=n||new e.Point(0,0);var r,o;if(i%90===0){var a=e.positiveModulo(i,360);switch(a){case 0:r=1,o=0;break;case 90:r=0,o=1;break;case 180:r=-1,o=0;break;case 270:r=0,o=-1;break}}else{var l=i*Math.PI/180;r=Math.cos(l),o=Math.sin(l)}var u=r*(this.x-n.x)-o*(this.y-n.y)+n.x,h=o*(this.x-n.x)+r*(this.y-n.y)+n.y;return new e.Point(u,h)},toString:function(){return"("+Math.round(this.x*100)/100+","+Math.round(this.y*100)/100+")"}}}(t),function(e){e.TileSource=function(n,r,o,a,l,u){var h=this,d=arguments,f,m;if(e.isPlainObject(n)?f=n:f={width:d[0],height:d[1],tileSize:d[2],tileOverlap:d[3],minLevel:d[4],maxLevel:d[5]},e.EventSource.call(this),e.extend(!0,this,f),!this.success){for(m=0;m<arguments.length;m++)if(e.isFunction(arguments[m])){this.success=arguments[m];break}}this.success&&this.addHandler("ready",function(v){h.success(v)}),e.type(arguments[0])==="string"&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new e.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=f.width&&f.height?f.width/f.height:1,this.dimensions=new e.Point(f.width,f.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=f.tileOverlap?f.tileOverlap:0,this.minLevel=f.minLevel?f.minLevel:0,this.maxLevel=f.maxLevel!==void 0&&f.maxLevel!==null?f.maxLevel:f.width&&f.height?Math.ceil(Math.log(Math.max(f.width,f.height))/Math.log(2)):0,this.success&&e.isFunction(this.success)&&this.success(this))},e.TileSource.prototype={getTileSize:function(n){return e.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(n){return this._tileWidth?this._tileWidth:this.getTileSize(n)},getTileHeight:function(n){return this._tileHeight?this._tileHeight:this.getTileSize(n)},setMaxLevel:function(n){this.maxLevel=n,this._memoizeLevelScale()},getLevelScale:function(n){return this._memoizeLevelScale(),this.getLevelScale(n)},_memoizeLevelScale:function(){var n={},r;for(r=0;r<=this.maxLevel;r++)n[r]=1/Math.pow(2,this.maxLevel-r);this.getLevelScale=function(o){return n[o]}},getNumTiles:function(n){var r=this.getLevelScale(n),o=Math.ceil(r*this.dimensions.x/this.getTileWidth(n)),a=Math.ceil(r*this.dimensions.y/this.getTileHeight(n));return new e.Point(o,a)},getPixelRatio:function(n){var r=this.dimensions.times(this.getLevelScale(n)),o=1/r.x*e.pixelDensityRatio,a=1/r.y*e.pixelDensityRatio;return new e.Point(o,a)},getClosestLevel:function(){var n,r;for(n=this.minLevel+1;n<=this.maxLevel&&(r=this.getNumTiles(n),!(r.x>1||r.y>1));n++);return n-1},getTileAtPoint:function(n,r){var o=r.x>=0&&r.x<=1&&r.y>=0&&r.y<=1/this.aspectRatio;e.console.assert(o,"[TileSource.getTileAtPoint] must be called with a valid point.");var a=this.dimensions.x*this.getLevelScale(n),l=r.x*a,u=r.y*a,h=Math.floor(l/this.getTileWidth(n)),d=Math.floor(u/this.getTileHeight(n));r.x>=1&&(h=this.getNumTiles(n).x-1);var f=1e-15;return r.y>=1/this.aspectRatio-f&&(d=this.getNumTiles(n).y-1),new e.Point(h,d)},getTileBounds:function(n,r,o,a){var l=this.dimensions.times(this.getLevelScale(n)),u=this.getTileWidth(n),h=this.getTileHeight(n),d=r===0?0:u*r-this.tileOverlap,f=o===0?0:h*o-this.tileOverlap,m=u+(r===0?1:2)*this.tileOverlap,v=h+(o===0?1:2)*this.tileOverlap,_=1/l.x;return m=Math.min(m,l.x-d),v=Math.min(v,l.y-f),a?new e.Rect(0,0,m,v):new e.Rect(d*_,f*_,m*_,v*_)},getImageInfo:function(n){var r=this,o,a,l,u,h,d,f;n&&(h=n.split("/"),d=h[h.length-1],f=d.lastIndexOf("."),f>-1&&(h[h.length-1]=d.slice(0,f)));var m=null;if(this.splitHashDataForPost){var v=n.indexOf("#");v!==-1&&(m=n.substring(v+1),n=n.substr(0,v))}a=function(_){typeof _=="string"&&(_=e.parseXml(_));var E=e.TileSource.determineType(r,_,n);if(!E){r.raiseEvent("open-failed",{message:"Unable to load TileSource",source:n});return}u=E.prototype.configure.apply(r,[_,n,m]),u.ajaxWithCredentials===void 0&&(u.ajaxWithCredentials=r.ajaxWithCredentials),l=new E(u),r.ready=!0,r.raiseEvent("ready",{tileSource:l})},n.match(/\.js$/)?(o=n.split("/").pop().replace(".js",""),e.jsonp({url:n,async:!1,callbackName:o,callback:a})):e.makeAjaxRequest({url:n,postData:m,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(_){var E=i(_);a(E)},error:function(_,E){var b;try{b="HTTP "+_.status+" attempting to load TileSource: "+n}catch{var k;typeof E>"u"||!E.toString?k="Unknown error":k=E.toString(),b=k+" attempting to load TileSource: "+n}e.console.error(b),r.raiseEvent("open-failed",{message:b,source:n,postData:m})}})},supports:function(n,r){return!1},configure:function(n,r,o){throw new Error("Method not implemented.")},getTileUrl:function(n,r,o){throw new Error("Method not implemented.")},getTilePostData:function(n,r,o){return null},getTileAjaxHeaders:function(n,r,o){return{}},getTileHashKey:function(n,r,o,a,l,u){function h(d){return l?d+"+"+JSON.stringify(l):d}return h(typeof a!="string"?n+"/"+r+"_"+o:a)},tileExists:function(n,r,o){var a=this.getNumTiles(n);return n>=this.minLevel&&n<=this.maxLevel&&r>=0&&o>=0&&r<a.x&&o<a.y},hasTransparency:function(n,r,o,a){return!!n||r.match(".png")},downloadTileStart:function(n){var r=n.userData,o=new Image;r.image=o,r.request=null;var a=function(l){if(!o){n.finish(null,r.request,"Image load failed: undefined Image instance.");return}o.onload=o.onerror=o.onabort=null,n.finish(l?null:o,r.request,l)};o.onload=function(){a()},o.onabort=o.onerror=function(){a("Image load aborted.")},n.loadWithAjax?r.request=e.makeAjaxRequest({url:n.src,withCredentials:n.ajaxWithCredentials,headers:n.ajaxHeaders,responseType:"arraybuffer",postData:n.postData,success:function(l){var u;try{u=new window.Blob([l.response])}catch(f){var h=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(f.name==="TypeError"&&h){var d=new h;d.append(l.response),u=d.getBlob()}}u.size===0?a("Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(u)},error:function(l){a("Image load aborted - XHR error")}}):(n.crossOriginPolicy!==!1&&(o.crossOrigin=n.crossOriginPolicy),o.src=n.src)},downloadTileAbort:function(n){n.userData.request&&n.userData.request.abort();var r=n.userData.image;n.userData.image&&(r.onload=r.onerror=r.onabort=null)},createTileCache:function(n,r,o){n._data=r},destroyTileCache:function(n){n._data=null,n._renderedContext=null},getTileCacheData:function(n){return n._data},getTileCacheDataAsImage:function(n){return n._data},getTileCacheDataAsContext2D:function(n){if(!n._renderedContext){var r=document.createElement("canvas");r.width=n._data.width,r.height=n._data.height,n._renderedContext=r.getContext("2d"),n._renderedContext.drawImage(n._data,0,0),n._data=null}return n._renderedContext}},e.extend(!0,e.TileSource.prototype,e.EventSource.prototype);function i(n){var r=n.responseText,o=n.status,a,l;if(n){if(n.status!==200&&n.status!==0)throw o=n.status,a=o===404?"Not Found":n.statusText,new Error(e.getString("Errors.Status",o,a))}else throw new Error(e.getString("Errors.Security"));if(r.match(/^\s*<.*/))try{l=n.responseXML&&n.responseXML.documentElement?n.responseXML:e.parseXml(r)}catch{l=n.responseText}else if(r.match(/\s*[{[].*/))try{l=e.parseJSON(r)}catch{l=r}else l=r;return l}e.TileSource.determineType=function(n,r,o){var a;for(a in t)if(a.match(/.+TileSource$/)&&e.isFunction(t[a])&&e.isFunction(t[a].prototype.supports)&&t[a].prototype.supports.call(n,r,o))return t[a];return e.console.error("No TileSource was able to open %s %s",o,r),null}}(t),function(e){e.DziTileSource=function(r,o,a,l,u,h,d,f,m){var v,_,E,b;if(e.isPlainObject(r)?b=r:b={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=b.tilesUrl,this.fileFormat=b.fileFormat,this.displayRects=b.displayRects,this.displayRects)for(v=this.displayRects.length-1;v>=0;v--)for(_=this.displayRects[v],E=_.minLevel;E<=_.maxLevel;E++)this._levelRects[E]||(this._levelRects[E]=[]),this._levelRects[E].push(_);e.TileSource.apply(this,[b])},e.extend(e.DziTileSource.prototype,e.TileSource.prototype,{supports:function(r,o){var a;return r.Image?a=r.Image.xmlns:r.documentElement&&(r.documentElement.localName==="Image"||r.documentElement.tagName==="Image")&&(a=r.documentElement.namespaceURI),a=(a||"").toLowerCase(),a.indexOf("schemas.microsoft.com/deepzoom/2008")!==-1||a.indexOf("schemas.microsoft.com/deepzoom/2009")!==-1},configure:function(r,o,a){var l;return e.isPlainObject(r)?l=n(this,r):l=i(this,r),o&&!l.tilesUrl&&(l.tilesUrl=o.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/"),o.search(/\.(dzi|xml|js)\?/)!==-1?l.queryParams=o.match(/\?.*/):l.queryParams=""),l},getTileUrl:function(r,o,a){return[this.tilesUrl,r,"/",o,"_",a,".",this.fileFormat,this.queryParams].join("")},tileExists:function(r,o,a){var l=this._levelRects[r],u,h,d,f,m,v,_;if(this.minLevel&&r<this.minLevel||this.maxLevel&&r>this.maxLevel)return!1;if(!l||!l.length)return!0;for(_=l.length-1;_>=0;_--)if(u=l[_],!(r<u.minLevel||r>u.maxLevel)&&(h=this.getLevelScale(r),d=u.x*h,f=u.y*h,m=d+u.width*h,v=f+u.height*h,d=Math.floor(d/this._tileWidth),f=Math.floor(f/this._tileWidth),m=Math.ceil(m/this._tileWidth),v=Math.ceil(v/this._tileWidth),d<=o&&o<m&&f<=a&&a<v))return!0;return!1}});function i(r,o){if(!o||!o.documentElement)throw new Error(e.getString("Errors.Xml"));var a=o.documentElement,l=a.localName||a.tagName,u=o.documentElement.namespaceURI,h=null,d=[],f,m,v,_,E;if(l==="Image")try{if(_=a.getElementsByTagName("Size")[0],_===void 0&&(_=a.getElementsByTagNameNS(u,"Size")[0]),h={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(_.getAttribute("Height"),10),Width:parseInt(_.getAttribute("Width"),10)}}},!e.imageFormatSupported(h.Image.Format))throw new Error(e.getString("Errors.ImageFormat",h.Image.Format.toUpperCase()));for(f=a.getElementsByTagName("DisplayRect"),f===void 0&&(f=a.getElementsByTagNameNS(u,"DisplayRect")[0]),E=0;E<f.length;E++)m=f[E],v=m.getElementsByTagName("Rect")[0],v===void 0&&(v=m.getElementsByTagNameNS(u,"Rect")[0]),d.push({Rect:{X:parseInt(v.getAttribute("X"),10),Y:parseInt(v.getAttribute("Y"),10),Width:parseInt(v.getAttribute("Width"),10),Height:parseInt(v.getAttribute("Height"),10),MinLevel:parseInt(m.getAttribute("MinLevel"),10),MaxLevel:parseInt(m.getAttribute("MaxLevel"),10)}});return d.length&&(h.Image.DisplayRect=d),n(r,h)}catch(V){throw V instanceof Error?V:new Error(e.getString("Errors.Dzi"))}else{if(l==="Collection")throw new Error(e.getString("Errors.Dzc"));if(l==="Error"){var b=a.getElementsByTagName("Message")[0],k=b.firstChild.nodeValue;throw new Error(k)}}throw new Error(e.getString("Errors.Dzi"))}function n(r,o){var a=o.Image,l=a.Url,u=a.Format,h=a.Size,d=a.DisplayRect||[],f=parseInt(h.Width,10),m=parseInt(h.Height,10),v=parseInt(a.TileSize,10),_=parseInt(a.Overlap,10),E=[],b,k;for(k=0;k<d.length;k++)b=d[k].Rect,E.push(new e.DisplayRect(parseInt(b.X,10),parseInt(b.Y,10),parseInt(b.Width,10),parseInt(b.Height,10),parseInt(b.MinLevel,10),parseInt(b.MaxLevel,10)));return e.extend(!0,{width:f,height:m,tileSize:v,tileOverlap:_,minLevel:null,maxLevel:null,tilesUrl:l,fileFormat:u,displayRects:E},o)}}(t),function(e){e.IIIFTileSource=function(a){if(e.extend(!0,this,a),this._id=this["@id"]||this.id||this.identifier||null,!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");if(a.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=a.version,this.tile_width&&this.tile_height)a.tileWidth=this.tile_width,a.tileHeight=this.tile_height;else if(this.tile_width)a.tileSize=this.tile_width;else if(this.tile_height)a.tileSize=this.tile_height;else if(this.tiles)if(this.tiles.length===1)a.tileWidth=this.tiles[0].width,a.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var l=0;l<this.tiles.length;l++)for(var u=0;u<this.tiles[l].scaleFactors.length;u++){var h=this.tiles[l].scaleFactors[u];this.scale_factors.push(h),a.tileSizePerScaleFactor[h]={width:this.tiles[l].width,height:this.tiles[l].height||this.tiles[l].width}}}else if(i(a)){for(var d=Math.min(this.height,this.width),f=[256,512,1024],m=[],v=0;v<f.length;v++)f[v]<=d&&m.push(f[v]);m.length>0?a.tileSize=Math.max.apply(null,m):a.tileSize=d}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,a.levels=n(this),e.extend(!0,a,{width:a.levels[a.levels.length-1].width,height:a.levels[a.levels.length-1].height,tileSize:Math.max(a.height,a.width),tileOverlap:0,minLevel:0,maxLevel:a.levels.length-1}),this.levels=a.levels):e.console.error("Nothing in the info.json to construct image pyramids from");if(!a.maxLevel&&!this.emulateLegacyImagePyramid)if(!this.scale_factors)a.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));else{var _=Math.max.apply(null,this.scale_factors);a.maxLevel=Math.round(Math.log(_)*Math.LOG2E)}if(this.sizes){var E=this.sizes.length;(E===a.maxLevel||E===a.maxLevel+1)&&(this.levelSizes=this.sizes.slice().sort((b,k)=>b.width-k.width),E===a.maxLevel&&this.levelSizes.push({width:this.width,height:this.height}))}e.TileSource.apply(this,[a])},e.extend(e.IIIFTileSource.prototype,e.TileSource.prototype,{supports:function(a,l){return a.protocol&&a.protocol==="http://iiif.io/api/image"||a["@context"]&&(a["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||a["@context"]==="http://iiif.io/api/image/1/context.json")||a.profile&&a.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0||a.identifier&&a.width&&a.height?!0:!!(a.documentElement&&a.documentElement.tagName==="info"&&a.documentElement.namespaceURI==="http://library.stanford.edu/iiif/image-api/ns/")},configure:function(a,l,u){if(e.isPlainObject(a)){if(!a["@context"])a["@context"]="http://iiif.io/api/image/1.0/context.json",a["@id"]=l.replace("/info.json",""),a.version=1;else{var d=a["@context"];if(Array.isArray(d)){for(var f=0;f<d.length;f++)if(typeof d[f]=="string"&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(d[f])||d[f]==="http://library.stanford.edu/iiif/image-api/1.1/context.json")){d=d[f];break}}switch(d){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":a.version=1;break;case"http://iiif.io/api/image/2/context.json":a.version=2;break;case"http://iiif.io/api/image/3/context.json":a.version=3;break;default:e.console.error("Data has a @context property which contains no known IIIF context URI.")}}if(a.preferredFormats){for(var m=0;m<a.preferredFormats.length;m++)if(t.imageFormatSupported(a.preferredFormats[m])){a.tileFormat=a.preferredFormats[m];break}}return a}else{var h=r(a);return h["@context"]="http://iiif.io/api/image/1.0/context.json",h["@id"]=l.replace("/info.xml",""),h.version=1,h}},getTileWidth:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileWidth.call(this,a);var l=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[l]?this.tileSizePerScaleFactor[l].width:this._tileWidth},getTileHeight:function(a){if(this.emulateLegacyImagePyramid)return e.TileSource.prototype.getTileHeight.call(this,a);var l=Math.pow(2,this.maxLevel-a);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[l]?this.tileSizePerScaleFactor[l].height:this._tileHeight},getLevelScale:function(a){if(this.emulateLegacyImagePyramid){var l=NaN;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(l=this.levels[a].width/this.levels[this.maxLevel].width),l}return e.TileSource.prototype.getLevelScale.call(this,a)},getNumTiles:function(a){if(this.emulateLegacyImagePyramid){var l=this.getLevelScale(a);return l?new e.Point(1,1):new e.Point(0,0)}if(this.levelSizes){var u=this.levelSizes[a],h=Math.ceil(u.width/this.getTileWidth(a)),d=Math.ceil(u.height/this.getTileHeight(a));return new e.Point(h,d)}else return e.TileSource.prototype.getNumTiles.call(this,a)},getTileAtPoint:function(a,l){if(this.emulateLegacyImagePyramid)return new e.Point(0,0);if(this.levelSizes){var u=l.x>=0&&l.x<=1&&l.y>=0&&l.y<=1/this.aspectRatio;e.console.assert(u,"[TileSource.getTileAtPoint] must be called with a valid point.");var h=this.levelSizes[a].width,d=l.x*h,f=l.y*h,m=Math.floor(d/this.getTileWidth(a)),v=Math.floor(f/this.getTileHeight(a));l.x>=1&&(m=this.getNumTiles(a).x-1);var _=1e-15;return l.y>=1/this.aspectRatio-_&&(v=this.getNumTiles(a).y-1),new e.Point(m,v)}return e.TileSource.prototype.getTileAtPoint.call(this,a,l)},getTileUrl:function(a,l,u){if(this.emulateLegacyImagePyramid){var h=null;return this.levels.length>0&&a>=this.minLevel&&a<=this.maxLevel&&(h=this.levels[a].url),h}var d="0",f=Math.pow(.5,this.maxLevel-a),m,v,_,E,b,k,V,W,z,j,D,x,I,M,F,O;return this.levelSizes?(m=this.levelSizes[a].width,v=this.levelSizes[a].height):(m=Math.ceil(this.width*f),v=Math.ceil(this.height*f)),_=this.getTileWidth(a),E=this.getTileHeight(a),b=Math.round(_/f),k=Math.round(E/f),this.version===1?F="native."+this.tileFormat:F="default."+this.tileFormat,m<_&&v<E?(this.version===2&&m===this.width?x="full":this.version===3&&m===this.width&&v===this.height?x="max":this.version===3?x=m+","+v:x=m+",",V="full"):(W=l*b,z=u*k,j=Math.min(b,this.width-W),D=Math.min(k,this.height-z),l===0&&u===0&&j===this.width&&D===this.height?V="full":V=[W,z,j,D].join(","),I=Math.min(_,m-l*_),M=Math.min(E,v-u*E),this.version===2&&I===this.width?x="full":this.version===3&&I===this.width&&M===this.height?x="max":this.version===3?x=I+","+M:x=I+","),O=[this._id,V,x,d,F].join("/"),O},__testonly__:{canBeTiled:i,constructLevels:n}});function i(a){var l=["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"],u=Array.isArray(a.profile)?a.profile[0]:a.profile,h=l.indexOf(u)!==-1,d=!1;return a.version===2&&a.profile.length>1&&a.profile[1].supports&&(d=a.profile[1].supports.indexOf("sizeByW")!==-1),a.version===3&&a.extraFeatures&&(d=a.extraFeatures.indexOf("sizeByWh")!==-1),!h||d}function n(a){for(var l=[],u=0;u<a.sizes.length;u++)l.push({url:a._id+"/full/"+a.sizes[u].width+","+(a.version===3?a.sizes[u].height:"")+"/0/default."+a.tileFormat,width:a.sizes[u].width,height:a.sizes[u].height});return l.sort(function(h,d){return h.width-d.width})}function r(a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var l=a.documentElement,u=l.tagName,h=null;if(u==="info")try{return h={},o(l,h),h}catch(d){throw d instanceof Error?d:new Error(e.getString("Errors.IIIF"))}throw new Error(e.getString("Errors.IIIF"))}function o(a,l,u){var h,d;if(a.nodeType===3&&u)d=a.nodeValue.trim(),d.match(/^\d*$/)&&(d=Number(d)),l[u]?(e.isArray(l[u])||(l[u]=[l[u]]),l[u].push(d)):l[u]=d;else if(a.nodeType===1)for(h=0;h<a.childNodes.length;h++)o(a.childNodes[h],l,a.nodeName)}}(t),function(e){e.OsmTileSource=function(i,n,r,o,a){var l;e.isPlainObject(i)?l=i:l={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]},(!l.width||!l.height)&&(l.width=65572864,l.height=65572864),l.tileSize||(l.tileSize=256,l.tileOverlap=0),l.tilesUrl||(l.tilesUrl="http://tile.openstreetmap.org/"),l.minLevel=8,e.TileSource.apply(this,[l])},e.extend(e.OsmTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="openstreetmaps"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){return this.tilesUrl+(i-8)+"/"+n+"/"+r+".png"}})}(t),function(e){e.TmsTileSource=function(i,n,r,o,a){var l;e.isPlainObject(i)?l=i:l={width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var u=Math.ceil(l.width/256)*256,h=Math.ceil(l.height/256)*256,d;u>h?d=u/256:d=h/256,l.maxLevel=Math.ceil(Math.log(d)/Math.log(2))-1,l.tileSize=256,l.width=u,l.height=h,e.TileSource.apply(this,[l])},e.extend(e.TmsTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="tiledmapservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=this.getNumTiles(i).y-1;return this.tilesUrl+i+"/"+n+"/"+(o-r)+".png"}})}(t),function(e){e.ZoomifyTileSource=function(i){typeof i.tileSize>"u"&&(i.tileSize=256),typeof i.fileFormat>"u"&&(i.fileFormat="jpg",this.fileFormat=i.fileFormat);var n={x:i.width,y:i.height};for(i.imageSizes=[{x:i.width,y:i.height}],i.gridSize=[this._getGridSize(i.width,i.height,i.tileSize)];parseInt(n.x,10)>i.tileSize||parseInt(n.y,10)>i.tileSize;)n.x=Math.floor(n.x/2),n.y=Math.floor(n.y/2),i.imageSizes.push({x:n.x,y:n.y}),i.gridSize.push(this._getGridSize(n.x,n.y,i.tileSize));i.imageSizes.reverse(),i.gridSize.reverse(),i.minLevel=0,i.maxLevel=i.gridSize.length-1,t.TileSource.apply(this,[i])},e.extend(e.ZoomifyTileSource.prototype,e.TileSource.prototype,{_getGridSize:function(i,n,r){return{x:Math.ceil(i/r),y:Math.ceil(n/r)}},_calculateAbsoluteTileNumber:function(i,n,r){for(var o=0,a={},l=0;l<i;l++)a=this.gridSize[l],o+=a.x*a.y;return a=this.gridSize[i],o+=a.x*r+n,o},supports:function(i,n){return i.type&&i.type==="zoomifytileservice"},configure:function(i,n,r){return i},getTileUrl:function(i,n,r){var o=0,a=this._calculateAbsoluteTileNumber(i,n,r);return o=Math.floor(a/256),this.tilesUrl+"TileGroup"+o+"/"+i+"-"+n+"-"+r+"."+this.fileFormat}})}(t),function(e){e.LegacyTileSource=function(o){var a,l,u;e.isArray(o)&&(a={type:"legacy-image-pyramid",levels:o}),a.levels=i(a.levels),a.levels.length>0?(l=a.levels[a.levels.length-1].width,u=a.levels[a.levels.length-1].height):(l=0,u=0,e.console.error("No supported image formats found")),e.extend(!0,a,{width:l,height:u,tileSize:Math.max(u,l),tileOverlap:0,minLevel:0,maxLevel:a.levels.length>0?a.levels.length-1:0}),e.TileSource.apply(this,[a]),this.levels=a.levels},e.extend(e.LegacyTileSource.prototype,e.TileSource.prototype,{supports:function(o,a){return o.type&&o.type==="legacy-image-pyramid"||o.documentElement&&o.documentElement.getAttribute("type")==="legacy-image-pyramid"},configure:function(o,a,l){var u;return e.isPlainObject(o)?u=r(this,o):u=n(this,o),u},getLevelScale:function(o){var a=NaN;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(a=this.levels[o].width/this.levels[this.maxLevel].width),a},getNumTiles:function(o){var a=this.getLevelScale(o);return a?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(o,a,l){var u=null;return this.levels.length>0&&o>=this.minLevel&&o<=this.maxLevel&&(u=this.levels[o].url),u}});function i(o){var a=[],l,u;for(u=0;u<o.length;u++)l=o[u],l.height&&l.width&&l.url?a.push({url:l.url,width:Number(l.width),height:Number(l.height)}):e.console.error("Unsupported image format: %s",l.url?l.url:"<no URL>");return a.sort(function(h,d){return h.height-d.height})}function n(o,a){if(!a||!a.documentElement)throw new Error(e.getString("Errors.Xml"));var l=a.documentElement,u=l.tagName,h=null,d=[],f,m;if(u==="image")try{for(h={type:l.getAttribute("type"),levels:[]},d=l.getElementsByTagName("level"),m=0;m<d.length;m++)f=d[m],h.levels.push({url:f.getAttribute("url"),width:parseInt(f.getAttribute("width"),10),height:parseInt(f.getAttribute("height"),10)});return r(o,h)}catch(v){throw v instanceof Error?v:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if(u==="collection")throw new Error("Legacy Image Pyramid Collections not yet supported.");if(u==="error")throw new Error("Error: "+a)}throw new Error("Unknown element "+u)}function r(o,a){return a.levels}}(t),function(e){e.ImageTileSource=function(i){i=e.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},i),e.TileSource.apply(this,[i])},e.extend(e.ImageTileSource.prototype,e.TileSource.prototype,{supports:function(i,n){return i.type&&i.type==="image"},configure:function(i,n,r){return i},getImageInfo:function(i){var n=this._image=new Image,r=this;this.crossOriginPolicy&&(n.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(n.useCredentials=this.ajaxWithCredentials),e.addEvent(n,"load",function(){r.width=n.naturalWidth,r.height=n.naturalHeight,r.aspectRatio=r.width/r.height,r.dimensions=new e.Point(r.width,r.height),r._tileWidth=r.width,r._tileHeight=r.height,r.tileOverlap=0,r.minLevel=0,r.levels=r._buildLevels(),r.maxLevel=r.levels.length-1,r.ready=!0,r.raiseEvent("ready",{tileSource:r})}),e.addEvent(n,"error",function(){r.raiseEvent("open-failed",{message:"Error loading image at "+i,source:i})}),n.src=i},getLevelScale:function(i){var n=NaN;return i>=this.minLevel&&i<=this.maxLevel&&(n=this.levels[i].width/this.levels[this.maxLevel].width),n},getNumTiles:function(i){var n=this.getLevelScale(i);return n?new e.Point(1,1):new e.Point(0,0)},getTileUrl:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].url),o},getContext2D:function(i,n,r){var o=null;return i>=this.minLevel&&i<=this.maxLevel&&(o=this.levels[i].context2D),o},destroy:function(i){this._freeupCanvasMemory(i)},_buildLevels:function(){var i=[{url:this._image.src,width:this._image.naturalWidth,height:this._image.naturalHeight}];if(!this.buildPyramid||!e.supportsCanvas)return delete this._image,i;var n=this._image.naturalWidth,r=this._image.naturalHeight,o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=n,o.height=r,a.drawImage(this._image,0,0,n,r),i[0].context2D=a,delete this._image,e.isCanvasTainted(o))return i;for(;n>=2&&r>=2;){n=Math.floor(n/2),r=Math.floor(r/2);var l=document.createElement("canvas"),u=l.getContext("2d");l.width=n,l.height=r,u.drawImage(o,0,0,n,r),i.splice(0,0,{context2D:u,width:n,height:r}),o=l,a=u}return i},_freeupCanvasMemory:function(i){for(var n=0;n<this.levels.length;n++)this.levels[n].context2D&&(this.levels[n].context2D.canvas.height=0,this.levels[n].context2D.canvas.width=0,i&&i.raiseEvent("image-unloaded",{context2D:this.levels[n].context2D}))}})}(t),function(e){e.TileSourceCollection=function(i,n,r,o){e.console.error("TileSourceCollection is deprecated; use World instead")}}(t),function(e){e.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},e.Button=function(u){var h=this;e.EventSource.call(this),e.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},u),this.element=u.element||e.makeNeutralElement("div"),u.element||(this.imgRest=e.makeTransparentImage(this.srcRest),this.imgGroup=e.makeTransparentImage(this.srcGroup),this.imgHover=e.makeTransparentImage(this.srcHover),this.imgDown=e.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,e.setElementPointerEventsNone(this.imgRest),e.setElementPointerEventsNone(this.imgGroup),e.setElementPointerEventsNone(this.imgHover),e.setElementPointerEventsNone(this.imgDown),this.element.style.position="relative",e.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=e.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new e.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(d){d.insideElementPressed?(a(h,e.ButtonState.DOWN),h.raiseEvent("enter",{originalEvent:d.originalEvent})):d.buttonDownAny||a(h,e.ButtonState.HOVER)},focusHandler:function(d){h.tracker.enterHandler(d),h.raiseEvent("focus",{originalEvent:d.originalEvent})},leaveHandler:function(d){l(h,e.ButtonState.GROUP),d.insideElementPressed&&h.raiseEvent("exit",{originalEvent:d.originalEvent})},blurHandler:function(d){h.tracker.leaveHandler(d),h.raiseEvent("blur",{originalEvent:d.originalEvent})},pressHandler:function(d){a(h,e.ButtonState.DOWN),h.raiseEvent("press",{originalEvent:d.originalEvent})},releaseHandler:function(d){d.insideElementPressed&&d.insideElementReleased?(l(h,e.ButtonState.HOVER),h.raiseEvent("release",{originalEvent:d.originalEvent})):d.insideElementPressed?l(h,e.ButtonState.GROUP):a(h,e.ButtonState.HOVER)},clickHandler:function(d){d.quick&&h.raiseEvent("click",{originalEvent:d.originalEvent})},keyHandler:function(d){d.keyCode===13?(h.raiseEvent("click",{originalEvent:d.originalEvent}),h.raiseEvent("release",{originalEvent:d.originalEvent}),d.preventDefault=!0):d.preventDefault=!1}}),l(this,e.ButtonState.REST)},e.extend(e.Button.prototype,e.EventSource.prototype,{notifyGroupEnter:function(){a(this,e.ButtonState.GROUP)},notifyGroupExit:function(){l(this,e.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,this.tracker.setTracking(!1),e.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,this.tracker.setTracking(!0),e.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()},destroy:function(){this.imgRest&&(this.element.removeChild(this.imgRest),this.imgRest=null),this.imgGroup&&(this.element.removeChild(this.imgGroup),this.imgGroup=null),this.imgHover&&(this.element.removeChild(this.imgHover),this.imgHover=null),this.imgDown&&(this.element.removeChild(this.imgDown),this.imgDown=null),this.removeAllHandlers(),this.tracker.destroy(),this.element=null}});function i(u){e.requestAnimationFrame(function(){n(u)})}function n(u){var h,d,f;u.shouldFade&&(h=e.now(),d=h-u.fadeBeginTime,f=1-d/u.fadeLength,f=Math.min(1,f),f=Math.max(0,f),u.imgGroup&&e.setElementOpacity(u.imgGroup,f,!0),f>0&&i(u))}function r(u){u.shouldFade=!0,u.fadeBeginTime=e.now()+u.fadeDelay,window.setTimeout(function(){i(u)},u.fadeDelay)}function o(u){u.shouldFade=!1,u.imgGroup&&e.setElementOpacity(u.imgGroup,1,!0)}function a(u,h){u.element.disabled||(h>=e.ButtonState.GROUP&&u.currentState===e.ButtonState.REST&&(o(u),u.currentState=e.ButtonState.GROUP),h>=e.ButtonState.HOVER&&u.currentState===e.ButtonState.GROUP&&(u.imgHover&&(u.imgHover.style.visibility=""),u.currentState=e.ButtonState.HOVER),h>=e.ButtonState.DOWN&&u.currentState===e.ButtonState.HOVER&&(u.imgDown&&(u.imgDown.style.visibility=""),u.currentState=e.ButtonState.DOWN))}function l(u,h){u.element.disabled||(h<=e.ButtonState.HOVER&&u.currentState===e.ButtonState.DOWN&&(u.imgDown&&(u.imgDown.style.visibility="hidden"),u.currentState=e.ButtonState.HOVER),h<=e.ButtonState.GROUP&&u.currentState===e.ButtonState.HOVER&&(u.imgHover&&(u.imgHover.style.visibility="hidden"),u.currentState=e.ButtonState.GROUP),h<=e.ButtonState.REST&&u.currentState===e.ButtonState.GROUP&&(r(u),u.currentState=e.ButtonState.REST))}}(t),function(e){e.ButtonGroup=function(i){e.extend(!0,this,{buttons:[],clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:e.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},i);var n=this.buttons.concat([]),r=this,o;if(this.element=i.element||e.makeNeutralElement("div"),!i.group)for(this.element.style.display="inline-block",o=0;o<n.length;o++)this.element.appendChild(n[o].element);e.setElementTouchActionNone(this.element),this.tracker=new e.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(a){var l;for(l=0;l<r.buttons.length;l++)r.buttons[l].notifyGroupEnter()},leaveHandler:function(a){var l;if(!a.insideElementPressed)for(l=0;l<r.buttons.length;l++)r.buttons[l].notifyGroupExit()}})},e.ButtonGroup.prototype={addButton:function(i){this.buttons.push(i),this.element.appendChild(i.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var i=this.buttons.pop();this.element.removeChild(i.element),i.destroy()}this.tracker.destroy(),this.element=null}}}(t),function(e){e.Rect=function(i,n,r,o,a){this.x=typeof i=="number"?i:0,this.y=typeof n=="number"?n:0,this.width=typeof r=="number"?r:0,this.height=typeof o=="number"?o:0,this.degrees=typeof a=="number"?a:0,this.degrees=e.positiveModulo(this.degrees,360);var l,u;this.degrees>=270?(l=this.getTopRight(),this.x=l.x,this.y=l.y,u=this.height,this.height=this.width,this.width=u,this.degrees-=270):this.degrees>=180?(l=this.getBottomRight(),this.x=l.x,this.y=l.y,this.degrees-=180):this.degrees>=90&&(l=this.getBottomLeft(),this.x=l.x,this.y=l.y,u=this.height,this.height=this.width,this.width=u,this.degrees-=90)},e.Rect.fromSummits=function(i,n,r){var o=i.distanceTo(n),a=i.distanceTo(r),l=n.minus(i),u=Math.atan(l.y/l.x);return l.x<0?u+=Math.PI:l.y<0&&(u+=2*Math.PI),new e.Rect(i.x,i.y,o,a,u/Math.PI*180)},e.Rect.prototype={clone:function(){return new e.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new e.Point(this.x,this.y)},getBottomRight:function(){return new e.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new e.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new e.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new e.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new e.Point(this.width,this.height)},equals:function(i){return i instanceof e.Rect&&this.x===i.x&&this.y===i.y&&this.width===i.width&&this.height===i.height&&this.degrees===i.degrees},times:function(i){return new e.Rect(this.x*i,this.y*i,this.width*i,this.height*i,this.degrees)},translate:function(i){return new e.Rect(this.x+i.x,this.y+i.y,this.width,this.height,this.degrees)},union:function(i){var n=this.getBoundingBox(),r=i.getBoundingBox(),o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),l=Math.max(n.x+n.width,r.x+r.width),u=Math.max(n.y+n.height,r.y+r.height);return new e.Rect(o,a,l-o,u-a)},intersection:function(i){var n=1e-10,r=[],o=this.getTopLeft();i.containsPoint(o,n)&&r.push(o);var a=this.getTopRight();i.containsPoint(a,n)&&r.push(a);var l=this.getBottomLeft();i.containsPoint(l,n)&&r.push(l);var u=this.getBottomRight();i.containsPoint(u,n)&&r.push(u);var h=i.getTopLeft();this.containsPoint(h,n)&&r.push(h);var d=i.getTopRight();this.containsPoint(d,n)&&r.push(d);var f=i.getBottomLeft();this.containsPoint(f,n)&&r.push(f);var m=i.getBottomRight();this.containsPoint(m,n)&&r.push(m);for(var v=this._getSegments(),_=i._getSegments(),E=0;E<v.length;E++)for(var b=v[E],k=0;k<_.length;k++){var V=_[k],W=z(b[0],b[1],V[0],V[1]);W&&r.push(W)}function z(O,R,ne,ee){var ae=R.minus(O),q=ee.minus(ne),Q=-q.x*ae.y+ae.x*q.y;if(Q===0)return null;var J=(ae.x*(O.y-ne.y)-ae.y*(O.x-ne.x))/Q,se=(q.x*(O.y-ne.y)-q.y*(O.x-ne.x))/Q;return-n<=J&&J<=1-n&&-n<=se&&se<=1-n?new e.Point(O.x+se*ae.x,O.y+se*ae.y):null}if(r.length===0)return null;for(var j=r[0].x,D=r[0].x,x=r[0].y,I=r[0].y,M=1;M<r.length;M++){var F=r[M];F.x<j&&(j=F.x),F.x>D&&(D=F.x),F.y<x&&(x=F.y),F.y>I&&(I=F.y)}return new e.Rect(j,x,D-j,I-x)},_getSegments:function(){var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight();return[[i,n],[n,o],[o,r],[r,i]]},rotate:function(i,n){if(i=e.positiveModulo(i,360),i===0)return this.clone();n=n||this.getCenter();var r=this.getTopLeft().rotate(i,n),o=this.getTopRight().rotate(i,n),a=o.minus(r);a=a.apply(function(u){var h=1e-15;return Math.abs(u)<h?0:u});var l=Math.atan(a.y/a.x);return a.x<0?l+=Math.PI:a.y<0&&(l+=2*Math.PI),new e.Rect(r.x,r.y,this.width,this.height,l/Math.PI*180)},getBoundingBox:function(){if(this.degrees===0)return this.clone();var i=this.getTopLeft(),n=this.getTopRight(),r=this.getBottomLeft(),o=this.getBottomRight(),a=Math.min(i.x,n.x,r.x,o.x),l=Math.max(i.x,n.x,r.x,o.x),u=Math.min(i.y,n.y,r.y,o.y),h=Math.max(i.y,n.y,r.y,o.y);return new e.Rect(a,u,l-a,h-u)},getIntegerBoundingBox:function(){var i=this.getBoundingBox(),n=Math.floor(i.x),r=Math.floor(i.y),o=Math.ceil(i.width+i.x-n),a=Math.ceil(i.height+i.y-r);return new e.Rect(n,r,o,a)},containsPoint:function(i,n){n=n||0;var r=this.getTopLeft(),o=this.getTopRight(),a=this.getBottomLeft(),l=o.minus(r),u=a.minus(r);return(i.x-r.x)*l.x+(i.y-r.y)*l.y>=-n&&(i.x-o.x)*l.x+(i.y-o.y)*l.y<=n&&(i.x-r.x)*u.x+(i.y-r.y)*u.y>=-n&&(i.x-a.x)*u.x+(i.y-a.y)*u.y<=n},toString:function(){return"["+Math.round(this.x*100)/100+", "+Math.round(this.y*100)/100+", "+Math.round(this.width*100)/100+"x"+Math.round(this.height*100)/100+", "+Math.round(this.degrees*100)/100+"deg]"}}}(t),function(e){var i={};e.ReferenceStrip=function(f){var m=this,v=f.viewer,_=e.getElementSize(v.element),E,b,k;for(f.id||(f.id="referencestrip-"+e.now(),this.element=e.makeNeutralElement("div"),this.element.id=f.id,this.element.className="referencestrip"),f=e.extend(!0,{sizeRatio:e.DEFAULT_SETTINGS.referenceStripSizeRatio,position:e.DEFAULT_SETTINGS.referenceStripPosition,scroll:e.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:e.DEFAULT_SETTINGS.clickTimeThreshold},f,{element:this.element}),e.extend(this,f),i[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,this.element.tabIndex=0,b=this.element.style,b.marginTop="0px",b.marginRight="0px",b.marginBottom="0px",b.marginLeft="0px",b.left="0px",b.bottom="0px",b.border="0px",b.background="#000",b.position="relative",e.setElementTouchActionNone(this.element),e.setElementOpacity(this.element,.8),this.viewer=v,this.tracker=new e.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:e.delegate(this,n),dragHandler:e.delegate(this,r),scrollHandler:e.delegate(this,o),enterHandler:e.delegate(this,l),leaveHandler:e.delegate(this,u),keyDownHandler:e.delegate(this,h),keyHandler:e.delegate(this,d),preProcessEventHandler:function(V){V.eventType==="wheel"&&(V.preventDefault=!0)}}),f.width&&f.height?(this.element.style.width=f.width+"px",this.element.style.height=f.height+"px",v.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):f.scroll==="horizontal"?(this.element.style.width=_.x*f.sizeRatio*v.tileSources.length+12*v.tileSources.length+"px",this.element.style.height=_.y*f.sizeRatio+"px",v.addControl(this.element,{anchor:e.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=_.y*f.sizeRatio*v.tileSources.length+12*v.tileSources.length+"px",this.element.style.width=_.x*f.sizeRatio+"px",v.addControl(this.element,{anchor:e.ControlAnchor.TOP_LEFT})),this.panelWidth=_.x*this.sizeRatio+8,this.panelHeight=_.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},k=0;k<v.tileSources.length;k++)E=e.makeNeutralElement("div"),E.id=this.element.id+"-"+k,E.style.width=m.panelWidth+"px",E.style.height=m.panelHeight+"px",E.style.display="inline",E.style.float="left",E.style.cssFloat="left",E.style.padding="2px",e.setElementTouchActionNone(E),e.setElementPointerEventsNone(E),this.element.appendChild(E),E.activePanel=!1,this.panels.push(E);a(this,this.scroll==="vertical"?_.y:_.x,0),this.setFocus(0)},e.ReferenceStrip.prototype={setFocus:function(f){var m=this.element.querySelector("#"+this.element.id+"-"+f),v=e.getElementSize(this.viewer.canvas),_=Number(this.element.style.width.replace("px","")),E=Number(this.element.style.height.replace("px","")),b=-Number(this.element.style.marginLeft.replace("px","")),k=-Number(this.element.style.marginTop.replace("px","")),V;this.currentSelected!==m&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=m,this.currentSelected.style.background="#999",this.scroll==="horizontal"?(V=Number(f)*(this.panelWidth+3),V>b+v.x-this.panelWidth?(V=Math.min(V,_-v.x),this.element.style.marginLeft=-V+"px",a(this,v.x,-V)):V<b&&(V=Math.max(0,V-v.x/2),this.element.style.marginLeft=-V+"px",a(this,v.x,-V))):(V=Number(f)*(this.panelHeight+3),V>k+v.y-this.panelHeight?(V=Math.min(V,E-v.y),this.element.style.marginTop=-V+"px",a(this,v.y,-V)):V<k&&(V=Math.max(0,V-v.y/2),this.element.style.marginTop=-V+"px",a(this,v.y,-V))),this.currentPage=f,l.call(this,{eventSource:this.tracker}))},update:function(){return!!i[this.id].animating},destroy:function(){if(this.miniViewers)for(var f in this.miniViewers)this.miniViewers[f].destroy();this.tracker.destroy(),this.element&&this.viewer.removeControl(this.element)}};function n(f){if(f.quick){var m;this.scroll==="horizontal"?m=Math.floor(f.position.x/(this.panelWidth+4)):m=Math.floor(f.position.y/this.panelHeight),this.viewer.goToPage(m)}this.element.focus()}function r(f){if(this.dragging=!0,this.element){var m=Number(this.element.style.marginLeft.replace("px","")),v=Number(this.element.style.marginTop.replace("px","")),_=Number(this.element.style.width.replace("px","")),E=Number(this.element.style.height.replace("px","")),b=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?-f.delta.x>0?m>-(_-b.x)&&(this.element.style.marginLeft=m+f.delta.x*2+"px",a(this,b.x,m+f.delta.x*2)):-f.delta.x<0&&m<0&&(this.element.style.marginLeft=m+f.delta.x*2+"px",a(this,b.x,m+f.delta.x*2)):-f.delta.y>0?v>-(E-b.y)&&(this.element.style.marginTop=v+f.delta.y*2+"px",a(this,b.y,v+f.delta.y*2)):-f.delta.y<0&&v<0&&(this.element.style.marginTop=v+f.delta.y*2+"px",a(this,b.y,v+f.delta.y*2))}}function o(f){if(this.element){var m=Number(this.element.style.marginLeft.replace("px","")),v=Number(this.element.style.marginTop.replace("px","")),_=Number(this.element.style.width.replace("px","")),E=Number(this.element.style.height.replace("px","")),b=e.getElementSize(this.viewer.canvas);this.scroll==="horizontal"?f.scroll>0?m>-(_-b.x)&&(this.element.style.marginLeft=m-f.scroll*60+"px",a(this,b.x,m-f.scroll*60)):f.scroll<0&&m<0&&(this.element.style.marginLeft=m-f.scroll*60+"px",a(this,b.x,m-f.scroll*60)):f.scroll<0?v>b.y-E&&(this.element.style.marginTop=v+f.scroll*60+"px",a(this,b.y,v+f.scroll*60)):f.scroll>0&&v<0&&(this.element.style.marginTop=v+f.scroll*60+"px",a(this,b.y,v+f.scroll*60)),f.preventDefault=!0}}function a(f,m,v){var _,E,b,k,V,W;for(f.scroll==="horizontal"?_=f.panelWidth:_=f.panelHeight,E=Math.ceil(m/_)+5,b=Math.ceil((Math.abs(v)+m)/_)+1,E=b-E,E=E<0?0:E,V=E;V<b&&V<f.panels.length;V++)if(W=f.panels[V],!W.activePanel){var z,j=f.viewer.tileSources[V];j.referenceStripThumbnailUrl?z={type:"image",url:j.referenceStripThumbnailUrl}:z=j,k=new e.Viewer({id:W.id,tileSources:[z],element:W,navigatorSizeRatio:f.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:f.viewer.loadTilesWithAjax,ajaxHeaders:f.viewer.ajaxHeaders,drawer:"canvas"}),e.setElementPointerEventsNone(k.canvas),e.setElementPointerEventsNone(k.container),k.innerTracker.setTracking(!1),k.outerTracker.setTracking(!1),f.miniViewers[W.id]=k,W.activePanel=!0}}function l(f){var m=f.eventSource.element;this.scroll==="horizontal"?m.style.marginBottom="0px":m.style.marginLeft="0px"}function u(f){var m=f.eventSource.element;this.scroll==="horizontal"?m.style.marginBottom="-"+e.getElementSize(m).y/2+"px":m.style.marginLeft="-"+e.getElementSize(m).x/2+"px"}function h(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 38:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 40:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 37:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 39:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}function d(f){if(!f.ctrl&&!f.alt&&!f.meta)switch(f.keyCode){case 61:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 45:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 48:case 119:case 87:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;case 115:case 83:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 97:o.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),f.preventDefault=!0;break;case 100:o.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),f.preventDefault=!0;break;default:f.preventDefault=!1;break}else f.preventDefault=!1}}(t),function(e){e.DisplayRect=function(i,n,r,o,a,l){e.Rect.apply(this,[i,n,r,o]),this.minLevel=a,this.maxLevel=l},e.extend(e.DisplayRect.prototype,e.Rect.prototype)}(t),function(e){e.Spring=function(n){var r=arguments;typeof n!="object"&&(n={initial:r.length&&typeof r[0]=="number"?r[0]:void 0,springStiffness:r.length>1?r[1].springStiffness:5,animationTime:r.length>1?r[1].animationTime:1.5}),e.console.assert(typeof n.springStiffness=="number"&&n.springStiffness!==0,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),e.console.assert(typeof n.animationTime=="number"&&n.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),n.exponential&&(this._exponential=!0,delete n.exponential),e.extend(!0,this,n),this.current={value:typeof this.initial=="number"?this.initial:this._exponential?0:1,time:e.now()},e.console.assert(!this._exponential||this.current.value!==0,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},e.Spring.prototype={resetTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=n,this.start.time=this.target.time=this.current.time=e.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(n){e.console.assert(!this._exponential||n!==0,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=n,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(n){this.start.value+=n,this.target.value+=n,this._exponential&&(e.console.assert(this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(n){this._exponential=n,this._exponential&&(e.console.assert(this.current.value!==0&&this.target.value!==0&&this.start.value!==0,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){this.current.time=e.now();let n,r;if(this._exponential?(n=this.start._logValue,r=this.target._logValue):(n=this.start.value,r=this.target.value),this.current.time>=this.target.time)this.current.value=this.target.value;else{let o=n+(r-n)*i(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time));this._exponential?this.current.value=Math.exp(o):this.current.value=o}return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}};function i(n,r){return(1-Math.exp(n*-r))/(1-Math.exp(-n))}}(t),function(e){e.ImageJob=function(n){e.extend(!0,this,{timeout:e.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},n),this.data=null,this.userData={},this.errorMsg=null},e.ImageJob.prototype={start:function(){this.tries++;var n=this,r=this.abort;this.jobId=window.setTimeout(function(){n.finish(null,null,"Image load exceeded timeout ("+n.timeout+" ms)")},this.timeout),this.abort=function(){n.source.downloadTileAbort(n),typeof r=="function"&&r()},this.source.downloadTileStart(this)},finish:function(n,r,o){this.data=n,this.request=r,this.errorMsg=o,this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},e.ImageLoader=function(n){e.extend(!0,this,{jobLimit:e.DEFAULT_SETTINGS.imageLoaderLimit,timeout:e.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},n)},e.ImageLoader.prototype={addJob:function(n){if(!n.source){e.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var r=e.TileSource.prototype;n.source={downloadTileStart:r.downloadTileStart,downloadTileAbort:r.downloadTileAbort}}var o=this,a=function(h){i(o,h,n.callback)},l={src:n.src,tile:n.tile||{},source:n.source,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.loadWithAjax?n.ajaxHeaders:null,crossOriginPolicy:n.crossOriginPolicy,ajaxWithCredentials:n.ajaxWithCredentials,postData:n.postData,callback:a,abort:n.abort,timeout:this.timeout},u=new e.ImageJob(l);!this.jobLimit||this.jobsInProgress<this.jobLimit?(u.start(),this.jobsInProgress++):this.jobQueue.push(u)},clear:function(){for(var n=0;n<this.jobQueue.length;n++){var r=this.jobQueue[n];typeof r.abort=="function"&&r.abort()}this.jobQueue=[]}};function i(n,r,o){r.errorMsg!==""&&(r.data===null||r.data===void 0)&&r.tries<1+n.tileRetryMax&&n.failedTiles.push(r);var a;n.jobsInProgress--,(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.jobQueue.length>0&&(a=n.jobQueue.shift(),a.start(),n.jobsInProgress++),n.tileRetryMax>0&&n.jobQueue.length===0&&(!n.jobLimit||n.jobsInProgress<n.jobLimit)&&n.failedTiles.length>0&&(a=n.failedTiles.shift(),setTimeout(function(){a.start()},n.tileRetryDelay),n.jobsInProgress++),o(r.data,r.errorMsg,r.request)}}(t),function(e){e.Tile=function(i,n,r,o,a,l,u,h,d,f,m,v){this.level=i,this.x=n,this.y=r,this.bounds=o,this.positionedBounds=new t.Rect(o.x,o.y,o.width,o.height),this.sourceBounds=f,this.exists=a,this._url=l,this.postData=m,this.context2D=u,this.loadWithAjax=h,this.ajaxHeaders=d,v===void 0&&(e.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used."),v=e.TileSource.prototype.getTileHashKey(i,n,r,l,d,m)),this.cacheKey=v,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.style=null,this.position=null,this.size=null,this.flipped=!1,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.hasTransparency=!1,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},e.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return console.warn("Tile.prototype._hasTransparencyChannel() has been deprecated and will be removed in the future. Use TileSource.prototype.hasTransparency() instead."),!!this.context2D||this.getUrl().match(".png")},get image(){return e.console.error("[Tile.image] property has been deprecated. Use [Tile.prototype.getImage] instead."),this.getImage()},get url(){return e.console.error("[Tile.url] property has been deprecated. Use [Tile.prototype.getUrl] instead."),this.getUrl()},getImage:function(){return this.cacheImageRecord.getImage()},getUrl:function(){return typeof this._url=="function"?this._url():this._url},getCanvasContext:function(){return this.context2D||this.cacheImageRecord&&this.cacheImageRecord.getRenderedContext()},getScaleForEdgeSmoothing:function(){var i;if(this.cacheImageRecord)i=this.cacheImageRecord.getRenderedContext();else if(this.context2D)i=this.context2D;else return e.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;return i.canvas.width/(this.size.x*e.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(i,n,r){var o=Math.max(1,Math.ceil((r.x-n.x)/2)),a=Math.max(1,Math.ceil((r.y-n.y)/2));return new e.Point(o,a).minus(this.position.times(e.pixelDensityRatio).times(i||1).apply(function(l){return l%1}))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(t),function(e){e.OverlayPlacement=e.Placement,e.OverlayRotationMode=e.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),e.Overlay=function(i,n,r){var o;e.isPlainObject(i)?o=i:o={element:i,location:n,placement:r},this.elementWrapper=document.createElement("div"),this.element=o.element,this.elementWrapper.appendChild(this.element),this.element.id?this.elementWrapper.id="overlay-wrapper-"+this.element.id:this.elementWrapper.id="overlay-wrapper",this.style=this.elementWrapper.style,this._init(o)},e.Overlay.prototype={_init:function(i){this.location=i.location,this.placement=i.placement===void 0?e.Placement.TOP_LEFT:i.placement,this.onDraw=i.onDraw,this.checkResize=i.checkResize===void 0?!0:i.checkResize,this.width=i.width===void 0?null:i.width,this.height=i.height===void 0?null:i.height,this.rotationMode=i.rotationMode||e.OverlayRotationMode.EXACT,this.location instanceof e.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=e.Placement.TOP_LEFT),this.scales=this.width!==null&&this.height!==null,this.bounds=new e.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(i,n){var r=e.Placement.properties[this.placement];r&&(r.isHorizontallyCentered?i.x-=n.x/2:r.isRight&&(i.x-=n.x),r.isVerticallyCentered?i.y-=n.y/2:r.isBottom&&(i.y-=n.y))},destroy:function(){var i=this.elementWrapper,n=this.style;i.parentNode&&(i.parentNode.removeChild(i),i.prevElementParent&&(n.display="none",document.body.appendChild(i))),this.onDraw=null,n.top="",n.left="",n.position="",this.width!==null&&(n.width=""),this.height!==null&&(n.height="");var r=e.getCssPropertyWithVendorPrefix("transformOrigin"),o=e.getCssPropertyWithVendorPrefix("transform");r&&o&&(n[r]="",n[o]="")},drawHTML:function(i,n){var r=this.elementWrapper;r.parentNode!==i&&(r.prevElementParent=r.parentNode,r.prevNextSibling=r.nextSibling,i.appendChild(r),this.style.position="absolute",this.size=e.getElementSize(this.elementWrapper));var o=this._getOverlayPositionAndSize(n),a=o.position,l=this.size=o.size,u="";n.overlayPreserveContentDirection&&(u=n.flipped?" scaleX(-1)":" scaleX(1)");var h=n.flipped?-o.rotate:o.rotate,d=n.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(a,l,this.element);else{var f=this.style,m=this.element.style;m.display="block",f.left=a.x+"px",f.top=a.y+"px",this.width!==null&&(m.width=l.x+"px"),this.height!==null&&(m.height=l.y+"px");var v=e.getCssPropertyWithVendorPrefix("transformOrigin"),_=e.getCssPropertyWithVendorPrefix("transform");v&&_&&(h&&!n.flipped?(m[_]="",f[v]=this._getTransformOrigin(),f[_]="rotate("+h+"deg)"):!h&&n.flipped?(m[_]=u,f[v]=this._getTransformOrigin(),f[_]=d):h&&n.flipped?(m[_]=u,f[v]=this._getTransformOrigin(),f[_]="rotate("+h+"deg)"+d):(m[_]="",f[v]="",f[_]="")),f.display="flex"}},_getOverlayPositionAndSize:function(i){var n=i.pixelFromPoint(this.location,!0),r=this._getSizeInPixels(i);this.adjust(n,r);var o=0;if(i.getRotation(!0)&&this.rotationMode!==e.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX&&this.width!==null&&this.height!==null){var a=new e.Rect(n.x,n.y,r.x,r.y),l=this._getBoundingBox(a,i.getRotation(!0));n=l.getTopLeft(),r=l.getSize()}else o=i.getRotation(!0);return i.flipped&&(n.x=i.getContainerSize().x-n.x),{position:n,size:r,rotate:o}},_getSizeInPixels:function(i){var n=this.size.x,r=this.size.y;if(this.width!==null||this.height!==null){var o=i.deltaPixelsFromPointsNoRotate(new e.Point(this.width||0,this.height||0),!0);this.width!==null&&(n=o.x),this.height!==null&&(r=o.y)}if(this.checkResize&&(this.width===null||this.height===null)){var a=this.size=e.getElementSize(this.elementWrapper);this.width===null&&(n=a.x),this.height===null&&(r=a.y)}return new e.Point(n,r)},_getBoundingBox:function(i,n){var r=this._getPlacementPoint(i);return i.rotate(n,r).getBoundingBox()},_getPlacementPoint:function(i){var n=new e.Point(i.x,i.y),r=e.Placement.properties[this.placement];return r&&(r.isHorizontallyCentered?n.x+=i.width/2:r.isRight&&(n.x+=i.width),r.isVerticallyCentered?n.y+=i.height/2:r.isBottom&&(n.y+=i.height)),n},_getTransformOrigin:function(){var i="",n=e.Placement.properties[this.placement];return n&&(n.isLeft?i="left":n.isRight&&(i="right"),n.isTop?i+=" top":n.isBottom&&(i+=" bottom")),i},update:function(i,n){var r=e.isPlainObject(i)?i:{location:i,placement:n};this._init({location:r.location||this.location,placement:r.placement!==void 0?r.placement:this.placement,onDraw:r.onDraw||this.onDraw,checkResize:r.checkResize||this.checkResize,width:r.width!==void 0?r.width:this.width,height:r.height!==void 0?r.height:this.height,rotationMode:r.rotationMode||this.rotationMode})},getBounds:function(i){e.console.assert(i,"A viewport must now be passed to Overlay.getBounds.");var n=this.width,r=this.height;if(n===null||r===null){var o=i.deltaPointsFromPixelsNoRotate(this.size,!0);n===null&&(n=o.x),r===null&&(r=o.y)}var a=this.location.clone();return this.adjust(a,new e.Point(n,r)),this._adjustBoundsForRotation(i,new e.Rect(a.x,a.y,n,r))},_adjustBoundsForRotation:function(i,n){if(!i||i.getRotation(!0)===0||this.rotationMode===e.OverlayRotationMode.EXACT)return n;if(this.rotationMode===e.OverlayRotationMode.BOUNDING_BOX){if(this.width===null||this.height===null)return n;var r=this._getOverlayPositionAndSize(i);return i.viewerElementToViewportRectangle(new e.Rect(r.position.x,r.position.y,r.size.x,r.size.y))}return n.rotate(-i.getRotation(!0),this._getPlacementPoint(n))}}}(t),function(e){const i=e;i.DrawerBase=class{constructor(r){e.console.assert(r.viewer,"[Drawer] options.viewer is required"),e.console.assert(r.viewport,"[Drawer] options.viewport is required"),e.console.assert(r.element,"[Drawer] options.element is required"),this.viewer=r.viewer,this.viewport=r.viewport,this.debugGridColor=typeof r.debugGridColor=="string"?[r.debugGridColor]:r.debugGridColor||e.DEFAULT_SETTINGS.debugGridColor,this.options=r.options||{},this.container=e.getElement(r.element),this._renderingTarget=this._createDrawingElement(),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",e.setElementOpacity(this.canvas,this.viewer.opacity,!0),e.setElementPointerEventsNone(this.canvas),e.setElementTouchActionNone(this.canvas),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._checkForAPIOverrides()}get canvas(){return this._renderingTarget}get element(){return e.console.error("Drawer.element is deprecated. Use Drawer.container instead."),this.container}getType(){e.console.error("Drawer.getType must be implemented by child class")}static isSupported(){e.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){return e.console.error("Drawer._createDrawingElement must be implemented by child class"),null}draw(r){e.console.error("Drawer.draw must be implemented by child class")}canRotate(){e.console.error("Drawer.canRotate must be implemented by child class")}destroy(){e.console.error("Drawer.destroy must be implemented by child class")}minimumOverlapRequired(r){return!1}setImageSmoothingEnabled(r){e.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(r){e.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){e.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}_checkForAPIOverrides(){if(this._createDrawingElement===e.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===e.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===e.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===e.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===e.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(r){var o=this.viewport.pixelFromPointNoRotate(r.getTopLeft(),!0),a=this.viewport.deltaPixelsFromPointsNoRotate(r.getSize(),!0);return new e.Rect(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio,a.x*e.pixelDensityRatio,a.y*e.pixelDensityRatio)}viewportCoordToDrawerCoord(r){var o=this.viewport.pixelFromPointNoRotate(r,!0);return new e.Point(o.x*e.pixelDensityRatio,o.y*e.pixelDensityRatio)}_calculateCanvasSize(){var r=e.pixelDensityRatio,o=this.viewport.getContainerSize();return new i.Point(Math.round(o.x*r),Math.round(o.y*r))}_raiseTiledImageDrawnEvent(r,o){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:r,tiles:o})}_raiseDrawerErrorEvent(r,o){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:r,drawer:this,error:o})}}}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(o){super(o),this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event"),this.viewer.allowEventHandler("tile-drawn")}static isSupported(){return!0}getType(){return"html"}minimumOverlapRequired(o){return!0}_createDrawingElement(){return e.makeNeutralElement("div")}draw(o){var a=this;this._prepareNewFrame(),o.forEach(function(l){l.opacity!==0&&a._drawTiles(l)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(o){var a=o.getTilesToDraw().map(h=>h.tile);if(!(o.opacity===0||a.length===0&&!o.placeholderFillStyle))for(var l=a.length-1;l>=0;l--){var u=a[l];this._drawTile(u),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:o,tile:u})}}_drawTile(o){e.console.assert(o,"[Drawer._drawTile] tile is required");let a=this.canvas;if(!o.cacheImageRecord){e.console.warn("[Drawer._drawTileToHTML] attempting to draw tile %s when it's not cached",o.toString());return}if(!o.loaded){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",o.toString());return}if(!o.element){var l=o.getImage();if(!l)return;o.element=e.makeNeutralElement("div"),o.imgElement=l.cloneNode(),o.imgElement.style.msInterpolationMode="nearest-neighbor",o.imgElement.style.width="100%",o.imgElement.style.height="100%",o.style=o.element.style,o.style.position="absolute"}o.element.parentNode!==a&&a.appendChild(o.element),o.imgElement.parentNode!==o.element&&o.element.appendChild(o.imgElement),o.style.top=o.position.y+"px",o.style.left=o.position.x+"px",o.style.height=o.size.y+"px",o.style.width=o.size.x+"px",o.flipped&&(o.style.transform="scaleX(-1)"),e.setElementOpacity(o.element,o.opacity)}}e.HTMLDrawer=n}(t),function(e){const i=e;class n extends i.DrawerBase{constructor(h){super(h),this.context=this.canvas.getContext("2d"),this.sketchCanvas=null,this.sketchContext=null,this._imageSmoothingEnabled=!0,this.viewer.allowEventHandler("tile-drawn"),this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return e.supportsCanvas}getType(){return"canvas"}_createDrawingElement(){let h=e.makeNeutralElement("canvas"),d=this._calculateCanvasSize();return h.width=d.x,h.height=d.y,h}draw(h){this._prepareNewFrame(),this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const d of h)d.opacity!==0&&this._drawTiles(d)}canRotate(){return!0}destroy(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null,this.container.removeChild(this.canvas)}minimumOverlapRequired(h){return!0}setImageSmoothingEnabled(h){this._imageSmoothingEnabled=!!h,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw()}drawDebuggingRect(h){var d=this.context;d.save(),d.lineWidth=2*e.pixelDensityRatio,d.strokeStyle=this.debugGridColor[0],d.fillStyle=this.debugGridColor[0],d.strokeRect(h.x*e.pixelDensityRatio,h.y*e.pixelDensityRatio,h.width*e.pixelDensityRatio,h.height*e.pixelDensityRatio),d.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(h,d,f,m){this.viewer.raiseEvent("tile-drawing",{tiledImage:h,context:d,tile:f,rendered:m})}_prepareNewFrame(){var h=this._calculateCanvasSize();if((this.canvas.width!==h.x||this.canvas.height!==h.y)&&(this.canvas.width=h.x,this.canvas.height=h.y,this._updateImageSmoothingEnabled(this.context),this.sketchCanvas!==null)){var d=this._calculateSketchCanvasSize();this.sketchCanvas.width=d.x,this.sketchCanvas.height=d.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}_clear(h,d){var f=this._getContext(h);if(d)f.clearRect(d.x,d.y,d.width,d.height);else{var m=f.canvas;f.clearRect(0,0,m.width,m.height)}}_drawTiles(h){var d=h.getTilesToDraw().map(O=>O.tile);if(!(h.opacity===0||d.length===0&&!h.placeholderFillStyle)){var f=d[0],m;f&&(m=h.opacity<1||h.compositeOperation&&h.compositeOperation!=="source-over"||!h._isBottomItem()&&h.source.hasTransparency(f.context2D,f.getUrl(),f.ajaxHeaders,f.postData));var v,_,E=this.viewport.getZoom(!0),b=h.viewportToImageZoom(E);d.length>1&&b>h.smoothTileEdgesMinZoom&&!h.iOSDevice&&h.getRotation(!0)%360===0&&(m=!0,v=f.getScaleForEdgeSmoothing(),_=f.getTranslationForEdgeSmoothing(v,this._getCanvasSize(!1),this._getCanvasSize(!0)));var k;m&&(v||(k=this.viewport.viewportToViewerElementRectangle(h.getClippedBounds(!0)).getIntegerBoundingBox(),k=k.times(e.pixelDensityRatio)),this._clear(!0,k)),v||this._setRotations(h,m);var V=!1;if(h._clip){this._saveContext(m);var W=h.imageToViewportRectangle(h._clip,!0);W=W.rotate(-h.getRotation(!0),h._getRotationPoint(!0));var z=this.viewportToDrawerRectangle(W);v&&(z=z.times(v)),_&&(z=z.translate(_)),this._setClip(z,m),V=!0}if(h._croppingPolygons){var j=this;V||this._saveContext(m);try{var D=h._croppingPolygons.map(function(O){return O.map(function(R){var ne=h.imageToViewportCoordinates(R.x,R.y,!0).rotate(-h.getRotation(!0),h._getRotationPoint(!0)),ee=j.viewportCoordToDrawerCoord(ne);return v&&(ee=ee.times(v)),_&&(ee=ee.plus(_)),ee})});this._clipWithPolygons(D,m)}catch(O){e.console.error(O)}V=!0}if(h._hasOpaqueTile=!1,h.placeholderFillStyle&&h._hasOpaqueTile===!1){let O=this.viewportToDrawerRectangle(h.getBoundsNoRotate(!0));v&&(O=O.times(v)),_&&(O=O.translate(_));let R=null;typeof h.placeholderFillStyle=="function"?R=h.placeholderFillStyle(h,this.context):R=h.placeholderFillStyle,this._drawRectangle(O,R,m)}var x=l(h.subPixelRoundingForTransparency),I=!1;if(x===e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS)I=!0;else if(x===e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST){var M=this.viewer&&this.viewer.isAnimating();I=!M}for(var F=0;F<d.length;F++)f=d[F],this._drawTile(f,h,m,v,_,I,h.source),this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:h,tile:f});V&&this._restoreContext(m),v||(h.getRotation(!0)%360!==0&&this._restoreRotationChanges(m),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(m)),m&&(v&&this._setRotations(h),this.blendSketch({opacity:h.opacity,scale:v,translate:_,compositeOperation:h.compositeOperation,bounds:k}),v&&(h.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(!1))),this._drawDebugInfo(h,d),this._raiseTiledImageDrawnEvent(h,d)}}_drawDebugInfo(h,d){if(h.debugMode)for(var f=d.length-1;f>=0;f--){var m=d[f];try{this._drawDebugInfoOnTile(m,d.length,f,h)}catch(v){e.console.error(v)}}}_clipWithPolygons(h,d){var f=this._getContext(d);f.beginPath();for(const m of h)for(const[v,_]of m.entries())f[v===0?"moveTo":"lineTo"](_.x,_.y);f.clip()}_drawTile(h,d,f,m,v,_,E){e.console.assert(h,"[Drawer._drawTile] tile is required"),e.console.assert(d,"[Drawer._drawTile] drawingHandler is required");var b=this._getContext(f);m=m||1,this._drawTileToCanvas(h,b,d,m,v,_,E)}_drawTileToCanvas(h,d,f,m,v,_,E){var b=h.position.times(e.pixelDensityRatio),k=h.size.times(e.pixelDensityRatio),V;if(!h.context2D&&!h.cacheImageRecord){e.console.warn("[Drawer._drawTileToCanvas] attempting to draw tile %s when it's not cached",h.toString());return}if(V=h.getCanvasContext(),!h.loaded||!V){e.console.warn("Attempting to draw tile %s when it's not yet loaded.",h.toString());return}d.save(),typeof m=="number"&&m!==1&&(b=b.times(m),k=k.times(m)),v instanceof e.Point&&(b=b.plus(v)),d.globalAlpha===1&&h.hasTransparency&&(_&&(b.x=Math.round(b.x),b.y=Math.round(b.y),k.x=Math.round(k.x),k.y=Math.round(k.y)),d.clearRect(b.x,b.y,k.x,k.y)),this._raiseTileDrawingEvent(f,d,h,V);var W,z;h.sourceBounds?(W=Math.min(h.sourceBounds.width,V.canvas.width),z=Math.min(h.sourceBounds.height,V.canvas.height)):(W=V.canvas.width,z=V.canvas.height),d.translate(b.x+k.x/2,0),h.flipped&&d.scale(-1,1),d.drawImage(V.canvas,0,0,W,z,-k.x/2,b.y,k.x,k.y),d.restore()}_getContext(h){var d=this.context;if(h){if(this.sketchCanvas===null){this.sketchCanvas=document.createElement("canvas");var f=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=f.x,this.sketchCanvas.height=f.y,this.sketchContext=this.sketchCanvas.getContext("2d"),this.viewport.getRotation()===0){var m=this;this.viewer.addHandler("rotate",function v(){if(m.viewport.getRotation()!==0){m.viewer.removeHandler("rotate",v);var _=m._calculateSketchCanvasSize();m.sketchCanvas.width=_.x,m.sketchCanvas.height=_.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}d=this.sketchContext}return d}_saveContext(h){this._getContext(h).save()}_restoreContext(h){this._getContext(h).restore()}_setClip(h,d){var f=this._getContext(d);f.beginPath(),f.rect(h.x,h.y,h.width,h.height),f.clip()}_drawRectangle(h,d,f){var m=this._getContext(f);m.save(),m.fillStyle=d,m.fillRect(h.x,h.y,h.width,h.height),m.restore()}blendSketch(h,d,f,m){var v=h;e.isPlainObject(v)||(v={opacity:h,scale:d,translate:f,compositeOperation:m}),h=v.opacity,m=v.compositeOperation;var _=v.bounds;if(this.context.save(),this.context.globalAlpha=h,m&&(this.context.globalCompositeOperation=m),_)_.x<0&&(_.width+=_.x,_.x=0),_.x+_.width>this.canvas.width&&(_.width=this.canvas.width-_.x),_.y<0&&(_.height+=_.y,_.y=0),_.y+_.height>this.canvas.height&&(_.height=this.canvas.height-_.y),this.context.drawImage(this.sketchCanvas,_.x,_.y,_.width,_.height,_.x,_.y,_.width,_.height);else{d=v.scale||1,f=v.translate;var E=f instanceof e.Point?f:new e.Point(0,0),b=0,k=0;if(f){var V=this.sketchCanvas.width-this.canvas.width,W=this.sketchCanvas.height-this.canvas.height;b=Math.round(V/2),k=Math.round(W/2)}this.context.drawImage(this.sketchCanvas,E.x-b*d,E.y-k*d,(this.canvas.width+2*b)*d,(this.canvas.height+2*k)*d,-b,-k,this.canvas.width+2*b,this.canvas.height+2*k)}this.context.restore()}_drawDebugInfoOnTile(h,d,f,m){var v=this.viewer.world.getIndexOfItem(m)%this.debugGridColor.length,_=this.context;_.save(),_.lineWidth=2*e.pixelDensityRatio,_.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",_.strokeStyle=this.debugGridColor[v],_.fillStyle=this.debugGridColor[v],this._setRotations(m),this._viewportFlipped&&this._flip({point:h.position.plus(h.size.divide(2))}),_.strokeRect(h.position.x*e.pixelDensityRatio,h.position.y*e.pixelDensityRatio,h.size.x*e.pixelDensityRatio,h.size.y*e.pixelDensityRatio);var E=(h.position.x+h.size.x/2)*e.pixelDensityRatio,b=(h.position.y+h.size.y/2)*e.pixelDensityRatio;_.translate(E,b);const k=this.viewport.getRotation(!0);_.rotate(Math.PI/180*-k),_.translate(-E,-b),h.x===0&&h.y===0&&(_.fillText("Zoom: "+this.viewport.getZoom(),h.position.x*e.pixelDensityRatio,(h.position.y-30)*e.pixelDensityRatio),_.fillText("Pan: "+this.viewport.getBounds().toString(),h.position.x*e.pixelDensityRatio,(h.position.y-20)*e.pixelDensityRatio)),_.fillText("Level: "+h.level,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+20)*e.pixelDensityRatio),_.fillText("Column: "+h.x,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+30)*e.pixelDensityRatio),_.fillText("Row: "+h.y,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+40)*e.pixelDensityRatio),_.fillText("Order: "+f+" of "+d,(h.position.x+10)*e.pixelDensityRatio,(h.position.y+50)*e.pixelDensityRatio),_.fillText("Size: "+h.size.toString(),(h.position.x+10)*e.pixelDensityRatio,(h.position.y+60)*e.pixelDensityRatio),_.fillText("Position: "+h.position.toString(),(h.position.x+10)*e.pixelDensityRatio,(h.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),m.getRotation(!0)%360!==0&&this._restoreRotationChanges(),_.restore()}_updateImageSmoothingEnabled(h){h.msImageSmoothingEnabled=this._imageSmoothingEnabled,h.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(h){var d=this._getContext(h).canvas;return new e.Point(d.width,d.height)}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(h,d=!1){var f=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:d,saveContext:f}),f=!1),h.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:h.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(h._getRotationPoint(!0),!0),useSketch:d,saveContext:f})}_offsetForRotation(h){var d=h.point?h.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(h.useSketch);f.save(),f.translate(d.x,d.y),f.rotate(Math.PI/180*h.degrees),f.translate(-d.x,-d.y)}_flip(h){h=h||{};var d=h.point?h.point.times(e.pixelDensityRatio):this._getCanvasCenter(),f=this._getContext(h.useSketch);f.translate(d.x,0),f.scale(-1,1),f.translate(-d.x,0)}_restoreRotationChanges(h){var d=this._getContext(h);d.restore()}_calculateCanvasSize(){var h=e.pixelDensityRatio,d=this.viewport.getContainerSize();return{x:Math.round(d.x*h),y:Math.round(d.y*h)}}_calculateSketchCanvasSize(){var h=this._calculateCanvasSize();if(this.viewport.getRotation()===0)return h;var d=Math.ceil(Math.sqrt(h.x*h.x+h.y*h.y));return{x:d,y:d}}}e.CanvasDrawer=n;var r=e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function o(u){return u!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&u!==e.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&u!==e.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function a(u){return o(u)?r:u}function l(u){if(typeof u=="number")return a(u);if(!u||!e.Browser)return r;var h=u[e.Browser.vendor];return o(h)&&(h=u["*"]),a(h)}}(t),function(e){const i=e;i.WebGLDrawer=class extends i.DrawerBase{constructor(r){super(r),this._destroyed=!1,this._TextureMap=new Map,this._TileMap=new Map,this._gl=null,this._firstPass=null,this._secondPass=null,this._glFrameBuffer=null,this._renderToTexture=null,this._glFramebufferToCanvasTransform=null,this._outputCanvas=null,this._outputContext=null,this._clippingCanvas=null,this._clippingContext=null,this._renderingCanvas=null,this._backupCanvasDrawer=null,this._imageSmoothingEnabled=!0,this._boundToTileReady=o=>this._tileReadyHandler(o),this._boundToImageUnloaded=o=>this._imageUnloadedHandler(o),this.viewer.addHandler("tile-ready",this._boundToTileReady),this.viewer.addHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event"),this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event"),this._setupCanvases(),this._setupRenderer(),this.context=this._outputContext}destroy(){if(this._destroyed)return;let r=this._gl;var o=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS);for(let l=0;l<o;++l)r.activeTexture(r.TEXTURE0+l),r.bindTexture(r.TEXTURE_2D,null),r.bindTexture(r.TEXTURE_CUBE_MAP,null);r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this._unloadTextures(),r.deleteBuffer(this._secondPass.bufferOutputPosition),r.deleteFramebuffer(this._glFrameBuffer),this._renderingCanvas.width=this._renderingCanvas.height=1,this._clippingCanvas.width=this._clippingCanvas.height=1,this._outputCanvas.width=this._outputCanvas.height=1,this._renderingCanvas=null,this._clippingCanvas=this._clippingContext=null,this._outputCanvas=this._outputContext=null;let a=r.getExtension("WEBGL_lose_context");a&&a.loseContext(),this.viewer.removeHandler("tile-ready",this._boundToTileReady),this.viewer.removeHandler("image-unloaded",this._boundToImageUnloaded),this.viewer.removeHandler("resize",this._resizeHandler),this._gl=null,this._backupCanvasDrawer&&(this._backupCanvasDrawer.destroy(),this._backupCanvasDrawer=null),this.container.removeChild(this.canvas),this.viewer.drawer===this&&(this.viewer.drawer=null),this._destroyed=!0}canRotate(){return!0}static isSupported(){let r=document.createElement("canvas"),o=e.isFunction(r.getContext)&&r.getContext("webgl"),a=o&&o.getExtension("WEBGL_lose_context");return a&&a.loseContext(),!!o}getType(){return"webgl"}minimumOverlapRequired(r){return r.isTainted()}_createDrawingElement(){let r=e.makeNeutralElement("canvas"),o=this._calculateCanvasSize();return r.width=o.x,r.height=o.y,r}_getBackupCanvasDrawer(){return this._backupCanvasDrawer||(this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1}),this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden")),this._backupCanvasDrawer}draw(r){let o=this._gl;const a=this.viewport.getBoundsNoRotateWithMargins(!0);let l={bounds:a,center:new i.Point(a.x+a.width/2,a.y+a.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180},u=this.viewport.flipped?-1:1,h=e.Mat3.makeTranslation(-l.center.x,-l.center.y),d=e.Mat3.makeScaling(2/l.bounds.width*u,-2/l.bounds.height),f=e.Mat3.makeRotation(-l.rotation),m=d.multiply(f).multiply(h);o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let v=!1;r.forEach((_,E)=>{if(_.isTainted()){v&&(this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT),v=!1);const b=this._getBackupCanvasDrawer();b.draw([_]),this._outputContext.drawImage(b.canvas,0,0)}else{let b=_.getTilesToDraw();if(_.placeholderFillStyle&&_._hasOpaqueTile===!1&&this._drawPlaceholder(_),b.length===0||_.getOpacity()===0)return;let k=b[0],V=_.compositeOperation||this.viewer.compositeOperation||_._clip||_._croppingPolygons||_.debugMode,W=V||_.opacity<1||k.hasTransparency;V&&(v&&this._outputContext.drawImage(this._renderingCanvas,0,0),o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),o.useProgram(this._firstPass.shaderProgram),W?(o.bindFramebuffer(o.FRAMEBUFFER,this._glFrameBuffer),o.clear(o.COLOR_BUFFER_BIT)):o.bindFramebuffer(o.FRAMEBUFFER,null);let z=m,j=_.getRotation(!0);if(j%360!==0){let O=e.Mat3.makeRotation(-j*Math.PI/180),R=_.getBoundsNoRotate(!0).getCenter(),ne=e.Mat3.makeTranslation(R.x,R.y),ee=e.Mat3.makeTranslation(-R.x,-R.y),ae=ne.multiply(O).multiply(ee);z=m.multiply(ae)}let D=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(D<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${D}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);let x=new Float32Array(D*12),I=new Array(D),M=new Array(D),F=new Array(D);for(let O=0;O<b.length;O++){let R=b[O].tile,ne=O%D,ee=ne+1,ae=R.getCanvasContext(),q=ae?this._TextureMap.get(ae.canvas):null;if(q||(this._tileReadyHandler({tile:R,tiledImage:_}),q=ae?this._TextureMap.get(ae.canvas):null),q&&this._getTileData(R,_,q,z,ne,x,I,M,F),ee===D||O===b.length-1){for(let Q=0;Q<=ee;Q++)o.activeTexture(o.TEXTURE0+Q),o.bindTexture(o.TEXTURE_2D,I[Q]);o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.bufferData(o.ARRAY_BUFFER,x,o.DYNAMIC_DRAW),M.forEach((Q,J)=>{o.uniformMatrix3fv(this._firstPass.uTransformMatrices[J],!1,Q)}),o.uniform1fv(this._firstPass.uOpacities,new Float32Array(F)),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),o.vertexAttribPointer(this._firstPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),o.vertexAttribPointer(this._firstPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._firstPass.bufferIndex),o.vertexAttribPointer(this._firstPass.aIndex,1,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6*ee)}}W&&(o.useProgram(this._secondPass.shaderProgram),o.bindFramebuffer(o.FRAMEBUFFER,null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this._renderToTexture),this._gl.uniform1f(this._secondPass.uOpacityMultiplier,_.opacity),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),o.vertexAttribPointer(this._secondPass.aTexturePosition,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),o.vertexAttribPointer(this._secondPass.aOutputPosition,2,o.FLOAT,!1,0,0),o.drawArrays(o.TRIANGLES,0,6)),v=!0,V&&(this._applyContext2dPipeline(_,b,E),v=!1,o.bindFramebuffer(o.FRAMEBUFFER,null),o.clear(o.COLOR_BUFFER_BIT)),E===0&&this._raiseTiledImageDrawnEvent(_,b.map(O=>O.tile))}}),v&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(r){this._imageSmoothingEnabled!==r&&(this._imageSmoothingEnabled=r,this._unloadTextures(),this.viewer.world.draw())}drawDebuggingRect(r){let o=this._outputContext;o.save(),o.lineWidth=2*e.pixelDensityRatio,o.strokeStyle=this.debugGridColor[0],o.fillStyle=this.debugGridColor[0],o.strokeRect(r.x*e.pixelDensityRatio,r.y*e.pixelDensityRatio,r.width*e.pixelDensityRatio,r.height*e.pixelDensityRatio),o.restore()}_getTextureDataFromTile(r){return r.getCanvasContext().canvas}_applyContext2dPipeline(r,o,a){if(this._outputContext.save(),this._outputContext.globalCompositeOperation=a===0?null:r.compositeOperation||this.viewer.compositeOperation,r._croppingPolygons||r._clip?(this._renderToClippingCanvas(r),this._outputContext.drawImage(this._clippingCanvas,0,0)):this._outputContext.drawImage(this._renderingCanvas,0,0),this._outputContext.restore(),r.debugMode){const l=this.viewer.viewport.getFlip();l&&this._flip(),this._drawDebugInfo(o,r,l),l&&this._flip()}}_getTileData(r,o,a,l,u,h,d,f,m){let v=a.texture,_=a.position;h.set(_,u*12);let E=this._calculateOverlapFraction(r,o),b=r.positionedBounds.width*E.x,k=r.positionedBounds.height*E.y,V=r.positionedBounds.x+(r.x===0?0:b),W=r.positionedBounds.y+(r.y===0?0:k),z=r.positionedBounds.x+r.positionedBounds.width-(r.isRightMost?0:b),j=r.positionedBounds.y+r.positionedBounds.height-(r.isBottomMost?0:k),D=z-V,x=j-W,I=new e.Mat3([D,0,0,0,x,0,V,W,1]);if(r.flipped){let F=e.Mat3.makeTranslation(.5,0),O=e.Mat3.makeTranslation(-.5,0),R=F.multiply(e.Mat3.makeScaling(-1,1)).multiply(O);I=I.multiply(R)}let M=l.multiply(I);m[u]=r.opacity,d[u]=v,f[u]=M.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let r=this._gl;r||e.console.error("_setupCanvases must be called before _setupRenderer"),this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1),this._makeFirstPassShaderProgram(),this._makeSecondPassShaderProgram(),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this._glFrameBuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let r=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),o=()=>[...Array(r).keys()].map(v=>`uniform mat3 u_matrix_${v};`).join(`
`),a=()=>[...Array(r).keys()].map(v=>`${v>0?"else ":""}if(int(a_index) == ${v}) { transform_matrix = u_matrix_${v}; }`).join(`
`);const l=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${o()} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${a()}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `,u=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${r}];
            // our opacities
            uniform float u_opacities[${r}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${r}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let h=this._gl,d=this.constructor.initShaderProgram(h,l,u);h.useProgram(d),this._firstPass={shaderProgram:d,aOutputPosition:h.getAttribLocation(d,"a_output_position"),aTexturePosition:h.getAttribLocation(d,"a_texture_position"),aIndex:h.getAttribLocation(d,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(v=>h.getUniformLocation(d,`u_matrix_${v}`)),uImages:h.getUniformLocation(d,"u_images"),uOpacities:h.getUniformLocation(d,"u_opacities"),bufferOutputPosition:h.createBuffer(),bufferTexturePosition:h.createBuffer(),bufferIndex:h.createBuffer()},h.uniform1iv(this._firstPass.uImages,[...Array(r).keys()]);let f=new Float32Array(r*12);for(let v=0;v<r;++v)f.set(Float32Array.from(this._unitQuad),v*12);h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferOutputPosition),h.bufferData(h.ARRAY_BUFFER,f,h.STATIC_DRAW),h.enableVertexAttribArray(this._firstPass.aOutputPosition),h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferTexturePosition),h.enableVertexAttribArray(this._firstPass.aTexturePosition),h.bindBuffer(h.ARRAY_BUFFER,this._firstPass.bufferIndex);let m=[...Array(this._glNumTextures).keys()].map(v=>Array(6).fill(v)).flat();h.bufferData(h.ARRAY_BUFFER,new Float32Array(m),h.STATIC_DRAW),h.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){const r=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,o=`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `;let a=this._gl,l=this.constructor.initShaderProgram(a,r,o);a.useProgram(l),this._secondPass={shaderProgram:l,aOutputPosition:a.getAttribLocation(l,"a_output_position"),aTexturePosition:a.getAttribLocation(l,"a_texture_position"),uMatrix:a.getUniformLocation(l,"u_matrix"),uImage:a.getUniformLocation(l,"u_image"),uOpacityMultiplier:a.getUniformLocation(l,"u_opacity_multiplier"),bufferOutputPosition:a.createBuffer(),bufferTexturePosition:a.createBuffer()},a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferOutputPosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.STATIC_DRAW),a.enableVertexAttribArray(this._secondPass.aOutputPosition),a.bindBuffer(a.ARRAY_BUFFER,this._secondPass.bufferTexturePosition),a.bufferData(a.ARRAY_BUFFER,this._unitQuad,a.DYNAMIC_DRAW),a.enableVertexAttribArray(this._secondPass.aTexturePosition);let u=e.Mat3.makeScaling(2,2).multiply(e.Mat3.makeTranslation(-.5,-.5));a.uniformMatrix3fv(this._secondPass.uMatrix,!1,u.values)}_resizeRenderer(){let r=this._gl,o=this._renderingCanvas.width,a=this._renderingCanvas.height;r.viewport(0,0,o,a),r.deleteTexture(this._renderToTexture),this._renderToTexture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this._renderToTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,a,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this._textureFilter()),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let r=this;this._outputCanvas=this.canvas,this._outputContext=this._outputCanvas.getContext("2d"),this._renderingCanvas=document.createElement("canvas"),this._clippingCanvas=document.createElement("canvas"),this._clippingContext=this._clippingCanvas.getContext("2d"),this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width,this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height,this._gl=this._renderingCanvas.getContext("webgl"),this._resizeHandler=function(){r._outputCanvas!==r.viewer.drawer.canvas&&(r._outputCanvas.style.width=r.viewer.drawer.canvas.clientWidth+"px",r._outputCanvas.style.height=r.viewer.drawer.canvas.clientHeight+"px");let o=r._calculateCanvasSize();(r._outputCanvas.width!==o.x||r._outputCanvas.height!==o.y)&&(r._outputCanvas.width=o.x,r._outputCanvas.height=o.y),r._renderingCanvas.style.width=r._outputCanvas.clientWidth+"px",r._renderingCanvas.style.height=r._outputCanvas.clientHeight+"px",r._renderingCanvas.width=r._clippingCanvas.width=r._outputCanvas.width,r._renderingCanvas.height=r._clippingCanvas.height=r._outputCanvas.height,r._resizeRenderer()},this.viewer.addHandler("resize",this._resizeHandler)}_makeQuadVertexBuffer(r,o,a,l){return new Float32Array([r,l,o,l,r,a,r,a,o,l,o,a])}_tileReadyHandler(r){let o=r.tile,a=r.tiledImage;if(a.isTainted())return;let l=o.getCanvasContext(),u=l&&l.canvas;if(!u||e.isCanvasTainted(u)){a.isTainted()||(a.setTainted(!0),e.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?"),this._raiseDrawerErrorEvent(a,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage."));return}if(!this._TextureMap.get(u)){let d=this._gl,f=d.createTexture(),m,v=a.source.tileOverlap,_,E;if(o.sourceBounds?(_=Math.min(o.sourceBounds.width,u.width)/u.width,E=Math.min(o.sourceBounds.height,u.height)/u.height):(_=1,E=1),v>0){let k=this._calculateOverlapFraction(o,a),V=(o.x===0?0:k.x)*_,W=(o.y===0?0:k.y)*E,z=(o.isRightMost?1:1-k.x)*_,j=(o.isBottomMost?1:1-k.y)*E;m=this._makeQuadVertexBuffer(V,z,W,j)}else _===1&&E===1?m=this._unitQuad:m=this._makeQuadVertexBuffer(0,_,0,E);let b={texture:f,position:m};this._TextureMap.set(u,b),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,f),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,this._textureFilter()),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,this._textureFilter()),this._uploadImageData(l)}}_calculateOverlapFraction(r,o){let a=o.source.tileOverlap,l=r.sourceBounds.width,u=r.sourceBounds.height,h=(r.x===0?0:a)+(r.isRightMost?0:a),d=(r.y===0?0:a)+(r.isBottomMost?0:a),f=a/(l+h),m=a/(u+d);return{x:f,y:m}}_unloadTextures(){Array.from(this._TextureMap.keys()).forEach(o=>{this._cleanupImageData(o)})}_uploadImageData(r){let o=this._gl,a=r.canvas;try{if(!a)throw r;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,a)}catch(l){e.console.error("Error uploading image data to WebGL",l)}}_imageUnloadedHandler(r){let o=r.context2D.canvas;this._cleanupImageData(o)}_cleanupImageData(r){let o=this._TextureMap.get(r);this._TextureMap.delete(r),o&&this._gl.deleteTexture(o.texture)}_setClip(){}_renderToClippingCanvas(r){if(this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height),this._clippingContext.save(),this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}if(r._clip){let a=[{x:r._clip.x,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y},{x:r._clip.x+r._clip.width,y:r._clip.y+r._clip.height},{x:r._clip.x,y:r._clip.y+r._clip.height}].map(l=>{let u=r.imageToViewportCoordinates(l.x,l.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(u)});this._clippingContext.beginPath(),a.forEach((l,u)=>{this._clippingContext[u===0?"moveTo":"lineTo"](l.x,l.y)}),this._clippingContext.clip(),this._setClip()}if(r._croppingPolygons){let o=r._croppingPolygons.map(a=>a.map(l=>{let u=r.imageToViewportCoordinates(l.x,l.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(u)}));this._clippingContext.beginPath(),o.forEach(a=>{a.forEach((l,u)=>{this._clippingContext[u===0?"moveTo":"lineTo"](l.x,l.y)})}),this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){const o=new e.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(o.x,0),this._clippingContext.scale(-1,1),this._clippingContext.translate(-o.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0),this._clippingContext.restore()}_setRotations(r){var o=!1;this.viewport.getRotation(!0)%360!==0&&(this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:o}),o=!1),r.getRotation(!0)%360!==0&&this._offsetForRotation({degrees:r.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(r._getRotationPoint(!0),!0),saveContext:o})}_offsetForRotation(r){var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.save(),a.translate(o.x,o.y),a.rotate(Math.PI/180*r.degrees),a.translate(-o.x,-o.y)}_flip(r){r=r||{};var o=r.point?r.point.times(e.pixelDensityRatio):this._getCanvasCenter(),a=this._outputContext;a.translate(o.x,0),a.scale(-1,1),a.translate(-o.x,0)}_drawDebugInfo(r,o,a){for(var l=r.length-1;l>=0;l--){var u=r[l].tile;try{this._drawDebugInfoOnTile(u,r.length,l,o,a)}catch(h){e.console.error(h)}}}_drawDebugInfoOnTile(r,o,a,l,u){var h=this.viewer.world.getIndexOfItem(l)%this.debugGridColor.length,d=this.context;d.save(),d.lineWidth=2*e.pixelDensityRatio,d.font="small-caps bold "+13*e.pixelDensityRatio+"px arial",d.strokeStyle=this.debugGridColor[h],d.fillStyle=this.debugGridColor[h],this._setRotations(l),u&&this._flip({point:r.position.plus(r.size.divide(2))}),d.strokeRect(r.position.x*e.pixelDensityRatio,r.position.y*e.pixelDensityRatio,r.size.x*e.pixelDensityRatio,r.size.y*e.pixelDensityRatio);var f=(r.position.x+r.size.x/2)*e.pixelDensityRatio,m=(r.position.y+r.size.y/2)*e.pixelDensityRatio;d.translate(f,m);const v=this.viewport.getRotation(!0);d.rotate(Math.PI/180*-v),d.translate(-f,-m),r.x===0&&r.y===0&&(d.fillText("Zoom: "+this.viewport.getZoom(),r.position.x*e.pixelDensityRatio,(r.position.y-30)*e.pixelDensityRatio),d.fillText("Pan: "+this.viewport.getBounds().toString(),r.position.x*e.pixelDensityRatio,(r.position.y-20)*e.pixelDensityRatio)),d.fillText("Level: "+r.level,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+20)*e.pixelDensityRatio),d.fillText("Column: "+r.x,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+30)*e.pixelDensityRatio),d.fillText("Row: "+r.y,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+40)*e.pixelDensityRatio),d.fillText("Order: "+a+" of "+o,(r.position.x+10)*e.pixelDensityRatio,(r.position.y+50)*e.pixelDensityRatio),d.fillText("Size: "+r.size.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+60)*e.pixelDensityRatio),d.fillText("Position: "+r.position.toString(),(r.position.x+10)*e.pixelDensityRatio,(r.position.y+70)*e.pixelDensityRatio),this.viewport.getRotation(!0)%360!==0&&this._restoreRotationChanges(),l.getRotation(!0)%360!==0&&this._restoreRotationChanges(),d.restore()}_drawPlaceholder(r){const o=r.getBounds(!0),a=this.viewportToDrawerRectangle(r.getBounds(!0)),l=this._outputContext;let u;typeof r.placeholderFillStyle=="function"?u=r.placeholderFillStyle(r,l):u=r.placeholderFillStyle,this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)}),l.fillStyle=u,l.translate(a.x,a.y),l.rotate(Math.PI/180*o.degrees),l.translate(-a.x,-a.y),l.fillRect(a.x,a.y,a.width,a.height),this._restoreRotationChanges()}_getCanvasCenter(){return new e.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){var r=this._outputContext;r.restore()}static initShaderProgram(r,o,a){function l(f,m,v){const _=f.createShader(m);return f.shaderSource(_,v),f.compileShader(_),f.getShaderParameter(_,f.COMPILE_STATUS)?_:(e.console.error(`An error occurred compiling the shaders: ${f.getShaderInfoLog(_)}`),f.deleteShader(_),null)}const u=l(r,r.VERTEX_SHADER,o),h=l(r,r.FRAGMENT_SHADER,a),d=r.createProgram();return r.attachShader(d,u),r.attachShader(d,h),r.linkProgram(d),r.getProgramParameter(d,r.LINK_STATUS)?d:(e.console.error(`Unable to initialize the shader program: ${r.getProgramInfoLog(d)}`),null)}}}(t),function(e){e.Viewport=function(i){var n=arguments;n.length&&n[0]instanceof e.Point&&(i={containerSize:n[0],contentSize:n[1],config:n[2]}),i.config&&(e.extend(!0,i,i.config),delete i.config),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i.margins||{}),delete i.margins,i.initialDegrees=i.degrees,delete i.degrees,e.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:e.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:e.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:e.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:e.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:e.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:e.DEFAULT_SETTINGS.degrees,flipped:e.DEFAULT_SETTINGS.flipped,homeFillsViewer:e.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:e.DEFAULT_SETTINGS.silenceMultiImageWarnings},i),this._updateContainerInnerSize(),this.centerSpringX=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new e.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new e.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.degreesSpring=new e.Spring({initial:i.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value,this._setContentBounds(new e.Rect(0,0,1,1),1),this.goHome(!0),this.update()},e.Viewport.prototype={get degrees(){return e.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead."),this.getRotation()},set degrees(i){e.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead."),this.rotateTo(i)},resetContentSize:function(i){return e.console.assert(i,"[Viewport.resetContentSize] contentSize is required"),e.console.assert(i instanceof e.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),e.console.assert(i.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),e.console.assert(i.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new e.Rect(0,0,1,i.y/i.x),i.x),this},setHomeBounds:function(i,n){e.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(i,n)},_setContentBounds:function(i,n){e.console.assert(i,"[Viewport._setContentBounds] bounds is required"),e.console.assert(i instanceof e.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),e.console.assert(i.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),e.console.assert(i.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=i.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(n),this._contentBounds=i.rotate(this.getRotation()).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(n),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:n,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var i=this._contentAspectRatio/this.getAspectRatio(),n;return this.homeFillsViewer?n=i>=1?i:1:n=i>=1?1:i,n/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var i=this._contentBounds.getCenter(),n=1/this.getHomeZoom(),r=n/this.getAspectRatio();return new e.Rect(i.x-n/2,i.y-r/2,n,r)},goHome:function(i){return this.viewer&&this.viewer.raiseEvent("home",{immediately:i}),this.fitBounds(this.getHomeBounds(),i)},getMinZoom:function(){var i=this.getHomeZoom(),n=this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*i;return n},getMaxZoom:function(){var i=this.maxZoomLevel;return i||(i=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,i/=this._contentBounds.width),Math.max(i,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new e.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return e.extend({},this._margins)},setMargins:function(i){e.console.assert(e.type(i)==="object","[Viewport.setMargins] margins must be an object"),this._margins=e.extend({left:0,top:0,right:0,bottom:0},i),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(-this.getRotation(i))},getBoundsNoRotate:function(i){var n=this.getCenter(i),r=1/this.getZoom(i),o=r/this.getAspectRatio();return new e.Rect(n.x-r/2,n.y-o/2,r,o)},getBoundsWithMargins:function(i){return this.getBoundsNoRotateWithMargins(i).rotate(-this.getRotation(i),this.getCenter(i))},getBoundsNoRotateWithMargins:function(i){var n=this.getBoundsNoRotate(i),r=this._containerInnerSize.x*this.getZoom(i);return n.x-=this._margins.left/r,n.y-=this._margins.top/r,n.width+=(this._margins.left+this._margins.right)/r,n.height+=(this._margins.top+this._margins.bottom)/r,n},getCenter:function(i){var n=new e.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value),o,a,l,u,h,d,f,m;return i?n:this.zoomPoint?(o=this.pixelFromPoint(this.zoomPoint,!0),a=this.getZoom(),l=1/a,u=l/this.getAspectRatio(),h=new e.Rect(n.x-l/2,n.y-u/2,l,u),d=this._pixelFromPoint(this.zoomPoint,h),f=d.minus(o).rotate(-this.getRotation(!0)),m=f.divide(this._containerInnerSize.x*a),r.plus(m)):r},getZoom:function(i){return i?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(i){return Math.max(Math.min(i,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(i){var n=this.viewportToViewerElementRectangle(i).getBoundingBox(),r=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox(),o=!1,a=!1;if(!this.wrapHorizontal){var l=n.x+n.width,u=r.x+r.width,h,d,f;n.width>r.width?h=this.visibilityRatio*r.width:h=this.visibilityRatio*n.width,d=r.x-l+h,f=u-n.x-h,h>r.width?(n.x+=(d+f)/2,o=!0):f<0?(n.x+=f,o=!0):d>0&&(n.x+=d,o=!0)}if(!this.wrapVertical){var m=n.y+n.height,v=r.y+r.height,_,E,b;n.height>r.height?_=this.visibilityRatio*r.height:_=this.visibilityRatio*n.height,E=r.y-m+_,b=v-n.y-_,_>r.height?(n.y+=(E+b)/2,a=!0):b<0?(n.y+=b,a=!0):E>0&&(n.y+=E,a=!0)}var k=o||a,V=k?this.viewerElementToViewportRectangle(n):i.clone();return V.xConstrained=o,V.yConstrained=a,V.constraintApplied=k,V},_raiseConstraintsEvent:function(i){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:i})},applyConstraints:function(i){var n=this.getZoom(),r=this._applyZoomConstraints(n);n!==r&&this.zoomTo(r,this.zoomPoint,i);var o=this.getConstrainedBounds(!1);return o.constraintApplied&&(this.fitBounds(o,i),this._raiseConstraintsEvent(i)),this},ensureVisible:function(i){return this.applyConstraints(i)},_fitBounds:function(i,n){n=n||{};var r=n.immediately||!1,o=n.constraints||!1,a=this.getAspectRatio(),l=i.getCenter(),u=new e.Rect(i.x,i.y,i.width,i.height,i.degrees+this.getRotation()).getBoundingBox();u.getAspectRatio()>=a?u.height=u.width/a:u.width=u.height*a,u.x=l.x-u.width/2,u.y=l.y-u.height/2;var h=1/u.width;if(r)return this.panTo(l,!0),this.zoomTo(h,null,!0),o&&this.applyConstraints(!0),this;var d=this.getCenter(!0),f=this.getZoom(!0);this.panTo(d,!0),this.zoomTo(f,null,!0);var m=this.getBounds(),v=this.getZoom();if(v===0||Math.abs(h/v-1)<1e-8)return this.zoomTo(h,null,!0),this.panTo(l,r),o&&this.applyConstraints(!1),this;if(o){this.panTo(l,!1),h=this._applyZoomConstraints(h),this.zoomTo(h,null,!1);var _=this.getConstrainedBounds();this.panTo(d,!0),this.zoomTo(f,null,!0),this.fitBounds(_)}else{var E=u.rotate(-this.getRotation()),b=E.getTopLeft().times(h).minus(m.getTopLeft().times(v)).divide(h-v);this.zoomTo(h,b,r)}return this},fitBounds:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!1})},fitBoundsWithConstraints:function(i,n){return this._fitBounds(i,{immediately:n,constraints:!0})},fitVertically:function(i){var n=new e.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(n,i)},fitHorizontally:function(i){var n=new e.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(n,i)},getConstrainedBounds:function(i){var n,r;return n=this.getBounds(i),r=this._applyBoundaryConstraints(n),r},panBy:function(i,n){var r=new e.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(r.plus(i),n)},panTo:function(i,n){return n?(this.centerSpringX.resetTo(i.x),this.centerSpringY.resetTo(i.y)):(this.centerSpringX.springTo(i.x),this.centerSpringY.springTo(i.y)),this.viewer&&this.viewer.raiseEvent("pan",{center:i,immediately:n}),this},zoomBy:function(i,n,r){return this.zoomTo(this.zoomSpring.target.value*i,n,r)},zoomTo:function(i,n,r){var o=this;return this.zoomPoint=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r?this._adjustCenterSpringsForZoomPoint(function(){o.zoomSpring.resetTo(i)}):this.zoomSpring.springTo(i),this.viewer&&this.viewer.raiseEvent("zoom",{zoom:i,refPoint:n,immediately:r}),this},setRotation:function(i,n){return this.rotateTo(i,null,n)},getRotation:function(i){return i?this.degreesSpring.current.value:this.degreesSpring.target.value},setRotationWithPivot:function(i,n,r){return this.rotateTo(i,n,r)},rotateTo:function(i,n,r){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===i&&this.degreesSpring.isAtTargetValue())return this;if(this.rotationPivot=n instanceof e.Point&&!isNaN(n.x)&&!isNaN(n.y)?n:null,r)if(this.rotationPivot){var o=i-this._oldDegrees;if(!o)return this.rotationPivot=null,this;this._rotateAboutPivot(i)}else this.degreesSpring.resetTo(i);else{var a=e.positiveModulo(this.degreesSpring.current.value,360),l=e.positiveModulo(i,360),u=l-a;u>180?l-=360:u<-180&&(l+=360);var h=a-l;this.degreesSpring.resetTo(i+h),this.degreesSpring.springTo(i)}return this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees:i,immediately:!!r,pivot:this.rotationPivot||this.getCenter()}),this},rotateBy:function(i,n,r){return this.rotateTo(this.degreesSpring.target.value+i,n,r)},resize:function(i,n){var r=this.getBoundsNoRotate(),o=r,a;this.containerSize.x=i.x,this.containerSize.y=i.y,this._updateContainerInnerSize(),n&&(a=i.x/this.containerSize.x,o.width=r.width*a,o.height=o.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:i,maintain:n});var l=this.fitBounds(o,!0);return this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:i,maintain:n}),l},_updateContainerInnerSize:function(){this._containerInnerSize=new e.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var i=this;this._adjustCenterSpringsForZoomPoint(function(){i.zoomSpring.update()}),this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null),this.centerSpringX.update(),this.centerSpringY.update(),this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var n=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._oldDegrees=this.degreesSpring.current.value;var r=n||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue();return r},_rotateAboutPivot:function(i){var n=i===!0,r=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(r.x),this.centerSpringY.shiftBy(r.y),n?this.degreesSpring.update():this.degreesSpring.resetTo(i);var o=this.degreesSpring.current.value-this._oldDegrees,a=r.rotate(o*-1).times(-1);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y)},_adjustCenterSpringsForZoomPoint:function(i){if(this.zoomPoint){var n=this.pixelFromPoint(this.zoomPoint,!0);i();var r=this.pixelFromPoint(this.zoomPoint,!0),o=r.minus(n),a=this.deltaPointsFromPixels(o,!0);this.centerSpringX.shiftBy(a.x),this.centerSpringY.shiftBy(a.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else i()},deltaPixelsFromPointsNoRotate:function(i,n){return i.times(this._containerInnerSize.x*this.getZoom(n))},deltaPixelsFromPoints:function(i,n){return this.deltaPixelsFromPointsNoRotate(i.rotate(this.getRotation(n)),n)},deltaPointsFromPixelsNoRotate:function(i,n){return i.divide(this._containerInnerSize.x*this.getZoom(n))},deltaPointsFromPixels:function(i,n){return this.deltaPointsFromPixelsNoRotate(i,n).rotate(-this.getRotation(n))},pixelFromPointNoRotate:function(i,n){return this._pixelFromPointNoRotate(i,this.getBoundsNoRotate(n))},pixelFromPoint:function(i,n){return this._pixelFromPoint(i,this.getBoundsNoRotate(n))},_pixelFromPointNoRotate:function(i,n){return i.minus(n.getTopLeft()).times(this._containerInnerSize.x/n.width).plus(new e.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(i,n){return this._pixelFromPointNoRotate(i.rotate(this.getRotation(!0),this.getCenter(!0)),n)},pointFromPixelNoRotate:function(i,n){var r=this.getBoundsNoRotate(n);return i.minus(new e.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/r.width).plus(r.getTopLeft())},pointFromPixel:function(i,n){return this.pointFromPixelNoRotate(i,n).rotate(-this.getRotation(n),this.getCenter(n))},_viewportToImageDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i*this._contentSizeNoRotate.x/r,n*this._contentSizeNoRotate.x/r)},viewportToImageCoordinates:function(i,n){if(i instanceof e.Point)return this.viewportToImageCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.viewportToImageCoordinates(i,n,!0)}}return this._viewportToImageDelta(i-this._contentBoundsNoRotate.x,n-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(i,n){var r=this._contentBoundsNoRotate.width;return new e.Point(i/this._contentSizeNoRotate.x*r,n/this._contentSizeNoRotate.x*r)},imageToViewportCoordinates:function(i,n){if(i instanceof e.Point)return this.imageToViewportCoordinates(i.x,i.y);if(this.viewer){var r=this.viewer.world.getItemCount();if(r>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(r===1){var o=this.viewer.world.getItemAt(0);return o.imageToViewportCoordinates(i,n,!0)}}var a=this._imageToViewportDelta(i,n);return a.x+=this._contentBoundsNoRotate.x,a.y+=this._contentBoundsNoRotate.y,a},imageToViewportRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var l=this.viewer.world.getItemCount();if(l>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(l===1){var u=this.viewer.world.getItemAt(0);return u.imageToViewportRectangle(i,n,r,o,!0)}}var h=this.imageToViewportCoordinates(a.x,a.y),d=this._imageToViewportDelta(a.width,a.height);return new e.Rect(h.x,h.y,d.x,d.y,a.degrees)},viewportToImageRectangle:function(i,n,r,o){var a=i;if(a instanceof e.Rect||(a=new e.Rect(i,n,r,o)),this.viewer){var l=this.viewer.world.getItemCount();if(l>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(l===1){var u=this.viewer.world.getItemAt(0);return u.viewportToImageRectangle(i,n,r,o,!0)}}var h=this.viewportToImageCoordinates(a.x,a.y),d=this._viewportToImageDelta(a.width,a.height);return new e.Rect(h.x,h.y,d.x,d.y,a.degrees)},viewerElementToImageCoordinates:function(i){var n=this.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");var n=this.imageToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(i){return this.pointFromPixel(i,!0)},viewportToViewerElementCoordinates:function(i){return this.pixelFromPoint(i,!0)},viewerElementToViewportRectangle:function(i){return e.Rect.fromSummits(this.pointFromPixel(i.getTopLeft(),!0),this.pointFromPixel(i.getTopRight(),!0),this.pointFromPixel(i.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(i){return e.Rect.fromSummits(this.pixelFromPoint(i.getTopLeft(),!0),this.pixelFromPoint(i.getTopRight(),!0),this.pixelFromPoint(i.getBottomLeft(),!0))},windowToViewportCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var n=i.minus(e.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(n)},viewportToWindowCoordinates:function(i){e.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");var n=this.viewportToViewerElementCoordinates(i);return n.plus(e.getElementPosition(this.viewer.element))},viewportToImageZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.viewportToImageZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,l=this._contentBoundsNoRotate.width,u=a/o*l;return i*u},imageToViewportZoom:function(i){if(this.viewer){var n=this.viewer.world.getItemCount();if(n>1)this.silenceMultiImageWarnings||e.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(n===1){var r=this.viewer.world.getItemAt(0);return r.imageToViewportZoom(i)}}var o=this._contentSizeNoRotate.x,a=this._containerInnerSize.x,l=this._contentBoundsNoRotate.width,u=o/a/l;return i*u},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(i){return this.flipped===i?this:(this.flipped=i,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:i}),this)},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(i,n=!0,r=!1){e.console.assert(!isNaN(i),"[Viewport.setMaxZoomPixelRatio] ratio must be a number"),!isNaN(i)&&(this.maxZoomPixelRatio=i,n&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(r))}}}(t),function(e){e.TiledImage=function(i){this._initialized=!1,e.console.assert(i.tileCache,"[TiledImage] options.tileCache is required"),e.console.assert(i.drawer,"[TiledImage] options.drawer is required"),e.console.assert(i.viewer,"[TiledImage] options.viewer is required"),e.console.assert(i.imageLoader,"[TiledImage] options.imageLoader is required"),e.console.assert(i.source,"[TiledImage] options.source is required"),e.console.assert(!i.clip||i.clip instanceof e.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),e.EventSource.call(this),this._tileCache=i.tileCache,delete i.tileCache,this._drawer=i.drawer,delete i.drawer,this._imageLoader=i.imageLoader,delete i.imageLoader,i.clip instanceof e.Rect&&(this._clip=i.clip.clone()),delete i.clip;var n=i.x||0;delete i.x;var r=i.y||0;delete i.y,this.normHeight=i.source.dimensions.y/i.source.dimensions.x,this.contentAspectX=i.source.dimensions.x/i.source.dimensions.y;var o=1;i.width?(o=i.width,delete i.width,i.height&&(e.console.error("specifying both width and height to a tiledImage is not supported"),delete i.height)):i.height&&(o=i.height/this.normHeight,delete i.height);var a=i.fitBounds;delete i.fitBounds;var l=i.fitBoundsPlacement||t.Placement.CENTER;delete i.fitBoundsPlacement;var u=i.degrees||0;delete i.degrees;var h=i.ajaxHeaders;delete i.ajaxHeaders,e.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:e.DEFAULT_SETTINGS.springStiffness,animationTime:e.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:e.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:e.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:e.DEFAULT_SETTINGS.wrapVertical,immediateRender:e.DEFAULT_SETTINGS.immediateRender,blendTime:e.DEFAULT_SETTINGS.blendTime,alwaysBlend:e.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:e.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:e.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:e.DEFAULT_SETTINGS.iOSDevice,debugMode:e.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:e.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:e.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:e.DEFAULT_SETTINGS.placeholderFillStyle,opacity:e.DEFAULT_SETTINGS.opacity,preload:e.DEFAULT_SETTINGS.preload,compositeOperation:e.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:e.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:e.DEFAULT_SETTINGS.maxTilesPerFrame},i),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new e.Spring({initial:n,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new e.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new e.Spring({initial:o,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new e.Spring({initial:u,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),a&&this.fitBounds(a,l,!0),this._ownAjaxHeaders={},this.setAjaxHeaders(h,!1),this._initialized=!0},e.extend(e.TiledImage.prototype,e.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(i){i!==this._fullyLoaded&&(this._fullyLoaded=i,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=e.now(),this._needsDraw=!0},update:function(i){let n=this._xSpring.update(),r=this._ySpring.update(),o=this._scaleSpring.update(),a=this._degreesSpring.update(),l=n||r||o||a||this._needsUpdate;if(l||i||!this._fullyLoaded){let u=this._updateLevelsForViewport();this._setFullyLoaded(u)}return this._needsUpdate=!1,l?(this._updateForScale(),this._raiseBoundsChange(),this._needsDraw=!0,!0):!1},setDrawn:function(){return this._needsDraw=this._isBlending||this._wasBlending,this._needsDraw},setTainted(i){this._isTainted=i},isTainted(){return this._isTainted},destroy:function(){this.reset(),this.source.destroy&&this.source.destroy(this.viewer)},getBounds:function(i){return this.getBoundsNoRotate(i).rotate(this.getRotation(i),this._getRotationPoint(i))},getBoundsNoRotate:function(i){return i?new e.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new e.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return e.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(i){var n=this.getBoundsNoRotate(i);if(this._clip){var r=i?this._worldWidthCurrent:this._worldWidthTarget,o=r/this.source.dimensions.x,a=this._clip.times(o);n=new e.Rect(n.x+a.x,n.y+a.y,a.width,a.height)}return n.rotate(this.getRotation(i),this._getRotationPoint(i))},getTileBounds:function(i,n,r){var o=this.source.getNumTiles(i),a=(o.x+n%o.x)%o.x,l=(o.y+r%o.y)%o.y,u=this.source.getTileBounds(i,a,l);return this.getFlip()&&(u.x=Math.max(0,1-u.x-u.width)),u.x+=(n-a)/o.x,u.y+=this._worldHeightCurrent/this._worldWidthCurrent*((r-l)/o.y),u},getContentSize:function(){return new e.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var i=this.imageToWindowCoordinates(new e.Point(0,0)),n=this.imageToWindowCoordinates(this.getContentSize());return new e.Point(n.x-i.x,n.y-i.y)},_viewportToImageDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i*(this.source.dimensions.x/o),n*(this.source.dimensions.y*this.contentAspectX/o))},viewportToImageCoordinates:function(i,n,r){var o;return i instanceof e.Point?(r=n,o=i):o=new e.Point(i,n),o=o.rotate(-this.getRotation(r),this._getRotationPoint(r)),r?this._viewportToImageDelta(o.x-this._xSpring.current.value,o.y-this._ySpring.current.value):this._viewportToImageDelta(o.x-this._xSpring.target.value,o.y-this._ySpring.target.value)},_imageToViewportDelta:function(i,n,r){var o=r?this._scaleSpring.current.value:this._scaleSpring.target.value;return new e.Point(i/this.source.dimensions.x*o,n/this.source.dimensions.y/this.contentAspectX*o)},imageToViewportCoordinates:function(i,n,r){i instanceof e.Point&&(r=n,n=i.y,i=i.x);var o=this._imageToViewportDelta(i,n,r);return r?(o.x+=this._xSpring.current.value,o.y+=this._ySpring.current.value):(o.x+=this._xSpring.target.value,o.y+=this._ySpring.target.value),o.rotate(this.getRotation(r),this._getRotationPoint(r))},imageToViewportRectangle:function(i,n,r,o,a){var l=i;l instanceof e.Rect?a=n:l=new e.Rect(i,n,r,o);var u=this.imageToViewportCoordinates(l.getTopLeft(),a),h=this._imageToViewportDelta(l.width,l.height,a);return new e.Rect(u.x,u.y,h.x,h.y,l.degrees+this.getRotation(a))},viewportToImageRectangle:function(i,n,r,o,a){var l=i;i instanceof e.Rect?a=n:l=new e.Rect(i,n,r,o);var u=this.viewportToImageCoordinates(l.getTopLeft(),a),h=this._viewportToImageDelta(l.width,l.height,a);return new e.Rect(u.x,u.y,h.x,h.y,l.degrees-this.getRotation(a))},viewerElementToImageCoordinates:function(i){var n=this.viewport.pointFromPixel(i,!0);return this.viewportToImageCoordinates(n)},imageToViewerElementCoordinates:function(i){var n=this.imageToViewportCoordinates(i);return this.viewport.pixelFromPoint(n,!0)},windowToImageCoordinates:function(i){var n=i.minus(t.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(n)},imageToWindowCoordinates:function(i){var n=this.imageToViewerElementCoordinates(i);return n.plus(t.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(i){var n=this._scaleSpring.current.value;return i=i.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new e.Rect((i.x-this._xSpring.current.value)/n,(i.y-this._ySpring.current.value)/n,i.width/n,i.height/n,i.degrees)},viewportToImageZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return n*i},imageToViewportZoom:function(i){var n=this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x;return i/n},setPosition:function(i,n){var r=this._xSpring.target.value===i.x&&this._ySpring.target.value===i.y;if(n){if(r&&this._xSpring.current.value===i.x&&this._ySpring.current.value===i.y)return;this._xSpring.resetTo(i.x),this._ySpring.resetTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._xSpring.springTo(i.x),this._ySpring.springTo(i.y),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},setWidth:function(i,n){this._setScale(i,n)},setHeight:function(i,n){this._setScale(i/this.normHeight,n)},setCroppingPolygons:function(i){var n=function(o){return o instanceof e.Point||typeof o.x=="number"&&typeof o.y=="number"},r=function(o){return o.map(function(a){try{if(n(a))return{x:a.x,y:a.y};throw new Error}catch{throw new Error("A Provided cropping polygon point is not supported")}})};try{if(!e.isArray(i))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=i.map(function(o){return r(o)}),this._needsDraw=!0}catch(o){e.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),e.console.error(o),this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null,this._needsDraw=!0},fitBounds:function(i,n,r){n=n||e.Placement.CENTER;var o=e.Placement.properties[n],a=this.contentAspectX,l=0,u=0,h=1,d=1;if(this._clip&&(a=this._clip.getAspectRatio(),h=this._clip.width/this.source.dimensions.x,d=this._clip.height/this.source.dimensions.y,i.getAspectRatio()>a?(l=this._clip.x/this._clip.height*i.height,u=this._clip.y/this._clip.height*i.height):(l=this._clip.x/this._clip.width*i.width,u=this._clip.y/this._clip.width*i.width)),i.getAspectRatio()>a){var f=i.height/d,m=0;o.isHorizontallyCentered?m=(i.width-i.height*a)/2:o.isRight&&(m=i.width-i.height*a),this.setPosition(new e.Point(i.x-l+m,i.y-u),r),this.setHeight(f,r)}else{var v=i.width/h,_=0;o.isVerticallyCentered?_=(i.height-i.width/a)/2:o.isBottom&&(_=i.height-i.width/a),this.setPosition(new e.Point(i.x-l,i.y-u+_),r),this.setWidth(v,r)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(i){e.console.assert(!i||i instanceof e.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),i instanceof e.Rect?this._clip=i.clone():this._clip=null,this._needsUpdate=!0,this._needsDraw=!0,this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(i){this.flipped=i},get flipped(){return this._flipped},set flipped(i){let n=this._flipped!==!!i;this._flipped=!!i,n&&(this.update(!0),this._needsDraw=!0,this._raiseBoundsChange())},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(i){let n=this._wrapHorizontal!==!!i;this._wrapHorizontal=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get wrapVertical(){return this._wrapVertical},set wrapVertical(i){let n=this._wrapVertical!==!!i;this._wrapVertical=!!i,this._initialized&&n&&(this.update(!0),this._needsDraw=!0)},get debugMode(){return this._debugMode},set debugMode(i){this._debugMode=!!i,this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(i){this.opacity=i},get opacity(){return this._opacity},set opacity(i){i!==this.opacity&&(this._opacity=i,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(i){this._preload=!!i,this._needsDraw=!0},getRotation:function(i){return i?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(i,n){this._degreesSpring.target.value===i&&this._degreesSpring.isAtTargetValue()||(n?this._degreesSpring.resetTo(i):this._degreesSpring.springTo(i),this._needsDraw=!0,this._needsUpdate=!0,this._raiseBoundsChange())},getDrawArea:function(){if(this._opacity===0&&!this._preload)return!1;var i=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var n=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));i=i.intersection(n)}return i},getTilesToDraw:function(){let i=this._tilesToDraw.flat();return this._updateTilesInViewport(i),i=this._tilesToDraw.flat(),i.forEach(n=>{n.tile.beingDrawn=!0}),this._lastDrawn=i,i},_getRotationPoint:function(i){return this.getBoundsNoRotate(i).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(i){i!==this._compositeOperation&&(this._compositeOperation=i,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation}))},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(i){this.compositeOperation=i},setAjaxHeaders:function(i,n){if(i===null&&(i={}),!e.isPlainObject(i)){console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object");return}this._ownAjaxHeaders=i,this._updateAjaxHeaders(n)},_updateAjaxHeaders:function(i){if(i===void 0&&(i=!0),e.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=e.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders,i){var n,r,o,a;for(var l in this.tilesMatrix){n=this.source.getNumTiles(l);for(var u in this.tilesMatrix[l]){r=(n.x+u%n.x)%n.x;for(var h in this.tilesMatrix[l][u])if(o=(n.y+h%n.y)%n.y,a=this.tilesMatrix[l][u][h],a.loadWithAjax=this.loadTilesWithAjax,a.loadWithAjax){var d=this.source.getTileAjaxHeaders(l,r,o);a.ajaxHeaders=e.extend({},this.ajaxHeaders,d)}else a.ajaxHeaders=null}}for(var f=0;f<this._imageLoader.jobQueue.length;f++){var m=this._imageLoader.jobQueue[f];m.loadWithAjax=m.tile.loadWithAjax,m.ajaxHeaders=m.tile.loadWithAjax?m.tile.ajaxHeaders:null}}},_setScale:function(i,n){var r=this._scaleSpring.target.value===i;if(n){if(r&&this._scaleSpring.current.value===i)return;this._scaleSpring.resetTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}else{if(r)return;this._scaleSpring.springTo(i),this._updateForScale(),this._needsDraw=!0,this._needsUpdate=!0}r||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var i=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),n=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,r=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(n/this.minPixelRatio)/Math.log(2))));return r=Math.max(r,this.source.minLevel||0),i=Math.min(i,r),{lowestLevel:i,highestLevel:r}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval(),n=i.lowestLevel,r=i.highestLevel,o=[],a=this.getDrawArea(),l=e.now();if(this._lastDrawn.forEach(z=>{z.tile.beingDrawn=!1}),this._tilesToDraw=[],this._tilesLoading=0,this.loadingCoverage={},!a)return this._needsDraw=!1,this._fullyLoaded;var u=new Array(r-n+1);for(let z=0,j=r;j>=n;j--,z++)u[z]=j;for(let z=r+1;z<=this.source.maxLevel;z++){var h=this.tilesMatrix[z]&&this.tilesMatrix[z][0]&&this.tilesMatrix[z][0][0];if(h&&h.isBottomMost&&h.isRightMost&&h.loaded){u.push(z);break}}let d=!1;for(let z=0;z<u.length;z++){let j=u[z];var f=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(j),!0).x*this._scaleSpring.current.value;if(z===u.length-1||f>=this.minPixelRatio)d=!0;else if(!d)continue;var m=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(j),!1).x*this._scaleSpring.current.value,v=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,_=this.immediateRender?1:v,E=Math.min(1,(f-.5)/.5),b=_/Math.abs(_-m),k=this._updateLevel(j,E,b,a,l,o);o=k.bestTiles;var V=k.updatedTiles.filter(D=>D.loaded),W=function(D,x,I){return function(M){return{tile:M,level:D,levelOpacity:x,currentTime:I}}}(j,E,l);if(this._tilesToDraw[j]=V.map(W),this._providesCoverage(this.coverage,j))break}return o&&o.length>0?(o.forEach(function(z){z&&!z.context2D&&this._loadTile(z,l)},this),this._needsDraw=!0,!1):this._tilesLoading===0},_updateTilesInViewport:function(i){let n=e.now(),r=this;this._tilesLoading=0,this._wasBlending=this._isBlending,this._isBlending=!1,this.loadingCoverage={};let o=i.length?i[0].level:0;if(!this.getDrawArea())return;function l(h){let d=h.tile;if(d&&d.loaded){let f=r._blendTile(d,d.x,d.y,h.level,h.levelOpacity,n,o);r._isBlending=r._isBlending||f,r._needsDraw=r._needsDraw||f||r._wasBlending}}let u=0;for(let h=0;h<i.length;h++){let d=i[h];l(d),this._providesCoverage(this.coverage,d.level)&&(u=Math.max(u,d.level))}if(u>0)for(let h in this._tilesToDraw)h<u&&delete this._tilesToDraw[h]},_blendTile:function(i,n,r,o,a,l,u){let h=1e3*this.blendTime,d,f;return i.blendStart||(i.blendStart=l),d=l-i.blendStart,f=h?Math.min(1,d/h):1,o===u&&(f=1,d=h),this.alwaysBlend&&(f*=a),i.opacity=f,f===1&&(this._setCoverage(this.coverage,o,n,r,!0),this._hasOpaqueTile=!0),d<h},_updateLevel:function(i,n,r,o,a,l){var u=o.getBoundingBox().getTopLeft(),h=o.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:i,opacity:n,visibility:r,drawArea:o,topleft:u,bottomright:h,currenttime:a,best:l}),this._resetCoverage(this.coverage,i),this._resetCoverage(this.loadingCoverage,i);var d=this._getCornerTiles(i,u,h),f=d.topLeft,m=d.bottomRight,v=this.source.getNumTiles(i),_=this.viewport.pixelFromPoint(this.viewport.getCenter());this.getFlip()&&(m.x+=1,this.wrapHorizontal||(m.x=Math.min(m.x,v.x-1)));for(var E=Math.max(0,(m.x-f.x)*(m.y-f.y)),b=new Array(E),k=0,V=f.x;V<=m.x;V++)for(var W=f.y;W<=m.y;W++){var z;if(this.getFlip()){var j=(v.x+V%v.x)%v.x;z=V+v.x-j-j-1}else z=V;if(o.intersection(this.getTileBounds(i,z,W))!==null){var D=this._updateTile(z,W,i,r,_,v,a,l);l=D.bestTiles,b[k]=D.tile,k+=1}}return{bestTiles:l,updatedTiles:b}},_positionTile:function(i,n,r,o,a){var l=i.bounds.getTopLeft();l.x*=this._scaleSpring.current.value,l.y*=this._scaleSpring.current.value,l.x+=this._xSpring.current.value,l.y+=this._ySpring.current.value;var u=i.bounds.getSize();u.x*=this._scaleSpring.current.value,u.y*=this._scaleSpring.current.value,i.positionedBounds.x=l.x,i.positionedBounds.y=l.y,i.positionedBounds.width=u.x,i.positionedBounds.height=u.y;var h=r.pixelFromPointNoRotate(l,!0),d=r.pixelFromPointNoRotate(l,!1),f=r.deltaPixelsFromPointsNoRotate(u,!0),m=r.deltaPixelsFromPointsNoRotate(u,!1),v=d.plus(m.divide(2)),_=o.squaredDistanceTo(v);this.viewer.drawer.minimumOverlapRequired(this)&&(n||(f=f.plus(new e.Point(1,1))),i.isRightMost&&this.wrapHorizontal&&(f.x+=.75),i.isBottomMost&&this.wrapVertical&&(f.y+=.75)),i.position=h,i.size=f,i.squaredDistance=_,i.visibility=a},_updateTile:function(i,n,r,o,a,l,u,h){var d=this._getTile(i,n,r,u,l);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:d}),this._setCoverage(this.coverage,r,i,n,!1);var f=d.loaded||d.loading||this._isCovered(this.loadingCoverage,r,i,n);if(this._setCoverage(this.loadingCoverage,r,i,n,f),!d.exists)return{bestTiles:h,tile:d};if(d.loaded&&d.opacity===1&&this._setCoverage(this.coverage,r,i,n,!0),this._positionTile(d,this.source.tileOverlap,this.viewport,a,o),!d.loaded)if(d.context2D)this._setTileLoaded(d);else{var m=this._tileCache.getImageRecord(d.cacheKey);m&&this._setTileLoaded(d,m.getData())}return d.loading?this._tilesLoading++:f||(h=this._compareTiles(h,d,this.maxTilesPerFrame)),{bestTiles:h,tile:d}},_getCornerTiles:function(i,n,r){var o,a;this.wrapHorizontal?(o=e.positiveModulo(n.x,1),a=e.positiveModulo(r.x,1)):(o=Math.max(0,n.x),a=Math.min(1,r.x));var l,u,h=1/this.source.aspectRatio;this.wrapVertical?(l=e.positiveModulo(n.y,h),u=e.positiveModulo(r.y,h)):(l=Math.max(0,n.y),u=Math.min(h,r.y));var d=this.source.getTileAtPoint(i,new e.Point(o,l)),f=this.source.getTileAtPoint(i,new e.Point(a,u)),m=this.source.getNumTiles(i);return this.wrapHorizontal&&(d.x+=m.x*Math.floor(n.x),f.x+=m.x*Math.floor(r.x)),this.wrapVertical&&(d.y+=m.y*Math.floor(n.y/h),f.y+=m.y*Math.floor(r.y/h)),{topLeft:d,bottomRight:f}},_getTile:function(i,n,r,o,a){var l,u,h,d,f,m,v,_,E,b,k=this.tilesMatrix,V=this.source;return k[r]||(k[r]={}),k[r][i]||(k[r][i]={}),(!k[r][i][n]||!k[r][i][n].flipped!=!this.flipped)&&(l=(a.x+i%a.x)%a.x,u=(a.y+n%a.y)%a.y,h=this.getTileBounds(r,i,n),d=V.getTileBounds(r,l,u,!0),f=V.tileExists(r,l,u),m=V.getTileUrl(r,l,u),v=V.getTilePostData(r,l,u),this.loadTilesWithAjax?(_=V.getTileAjaxHeaders(r,l,u),e.isPlainObject(this.ajaxHeaders)&&(_=e.extend({},this.ajaxHeaders,_))):_=null,E=V.getContext2D?V.getContext2D(r,l,u):void 0,b=new e.Tile(r,i,n,h,f,m,E,this.loadTilesWithAjax,_,d,v,V.getTileHashKey(r,l,u,m,_,v)),this.getFlip()?l===0&&(b.isRightMost=!0):l===a.x-1&&(b.isRightMost=!0),u===a.y-1&&(b.isBottomMost=!0),b.flipped=this.flipped,k[r][i][n]=b),b=k[r][i][n],b.lastTouchTime=o,b},_loadTile:function(i,n){var r=this;i.loading=!0,this._imageLoader.addJob({src:i.getUrl(),tile:i,source:this.source,postData:i.postData,loadWithAjax:i.loadWithAjax,ajaxHeaders:i.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(o,a,l){r._onTileLoad(i,n,o,a,l)},abort:function(){i.loading=!1}})},_onTileLoad:function(i,n,r,o,a){if(r)i.exists=!0;else{e.console.error("Tile %s failed to load: %s - error: %s",i,i.getUrl(),o),this.viewer.raiseEvent("tile-load-failed",{tile:i,tiledImage:this,time:n,message:o,tileRequest:a}),i.loading=!1,i.exists=!1;return}if(n<this.lastResetTime){e.console.warn("Ignoring tile %s loaded before reset: %s",i,i.getUrl()),i.loading=!1;return}var l=this,u=function(){var h=l.source,d=h.getClosestLevel();l._setTileLoaded(i,r,d,a)};u()},_setTileLoaded:function(i,n,r,o){var a=0,l=!1,u=this;function h(){return l&&e.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously."),a++,d}function d(){a--,a===0&&(i.loading=!1,i.loaded=!0,i.hasTransparency=u.source.hasTransparency(i.context2D,i.getUrl(),i.ajaxHeaders,i.postData),i.context2D||u._tileCache.cacheTile({data:n,tile:i,cutoff:r,tiledImage:u}),u.viewer.raiseEvent("tile-ready",{tile:i,tiledImage:u,tileRequest:o}),u._needsDraw=!0)}var f=h();this.viewer.raiseEvent("tile-loaded",{tile:i,tiledImage:this,tileRequest:o,get image(){return e.console.error("[tile-loaded] event 'image' has been deprecated. Use 'data' property instead."),n},data:n,getCompletionCallback:h}),l=!0,f()},_compareTiles:function(i,n,r){return i?(i.push(n),this._sortTiles(i),i.length>r&&i.pop(),i):[n]},_sortTiles:function(i){i.sort(function(n,r){return n===null?1:r===null?-1:n.visibility===r.visibility?n.squaredDistance-r.squaredDistance:r.visibility-n.visibility})},_providesCoverage:function(i,n,r,o){var a,l,u,h;if(!i[n])return!1;if(r===void 0||o===void 0){a=i[n];for(u in a)if(Object.prototype.hasOwnProperty.call(a,u)){l=a[u];for(h in l)if(Object.prototype.hasOwnProperty.call(l,h)&&!l[h])return!1}return!0}return i[n][r]===void 0||i[n][r][o]===void 0||i[n][r][o]===!0},_isCovered:function(i,n,r,o){return r===void 0||o===void 0?this._providesCoverage(i,n+1):this._providesCoverage(i,n+1,2*r,2*o)&&this._providesCoverage(i,n+1,2*r,2*o+1)&&this._providesCoverage(i,n+1,2*r+1,2*o)&&this._providesCoverage(i,n+1,2*r+1,2*o+1)},_setCoverage:function(i,n,r,o,a){if(!i[n]){e.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",n);return}i[n][r]||(i[n][r]={}),i[n][r][o]=a},_resetCoverage:function(i,n){i[n]={}}})}(t),function(e){var i=function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=r.tile,this.tiledImage=r.tiledImage},n=function(r){e.console.assert(r,"[ImageRecord] options is required"),e.console.assert(r.data,"[ImageRecord] options.data is required"),this._tiles=[],r.create.apply(null,[this,r.data,r.ownerTile]),this._destroyImplementation=r.destroy.bind(null,this),this.getImage=r.getImage.bind(null,this),this.getData=r.getData.bind(null,this),this.getRenderedContext=r.getRenderedContext.bind(null,this)};n.prototype={destroy:function(){this._destroyImplementation(),this._tiles=null},addTile:function(r){e.console.assert(r,"[ImageRecord.addTile] tile is required"),this._tiles.push(r)},removeTile:function(r){for(var o=0;o<this._tiles.length;o++)if(this._tiles[o]===r){this._tiles.splice(o,1);return}e.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",r)},getTileCount:function(){return this._tiles.length}},e.TileCache=function(r){r=r||{},this._maxImageCacheCount=r.maxImageCacheCount||e.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},e.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(r){e.console.assert(r,"[TileCache.cacheTile] options is required"),e.console.assert(r.tile,"[TileCache.cacheTile] options.tile is required"),e.console.assert(r.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),e.console.assert(r.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var o=r.cutoff||0,a=this._tilesLoaded.length,l=this._imagesLoaded[r.tile.cacheKey];if(l||(r.data||(e.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future."),r.data=r.image),e.console.assert(r.data,"[TileCache.cacheTile] options.data is required to create an ImageRecord"),l=this._imagesLoaded[r.tile.cacheKey]=new n({data:r.data,ownerTile:r.tile,create:r.tiledImage.source.createTileCache,destroy:r.tiledImage.source.destroyTileCache,getImage:r.tiledImage.source.getTileCacheDataAsImage,getData:r.tiledImage.source.getTileCacheData,getRenderedContext:r.tiledImage.source.getTileCacheDataAsContext2D}),this._imagesLoadedCount++),l.addTile(r.tile),r.tile.cacheImageRecord=l,this._imagesLoadedCount>this._maxImageCacheCount){for(var u=null,h=-1,d=null,f,m,v,_,E,b,k=this._tilesLoaded.length-1;k>=0;k--)if(b=this._tilesLoaded[k],f=b.tile,!(f.level<=o||f.beingDrawn)){if(!u){u=f,h=k,d=b;continue}_=f.lastTouchTime,m=u.lastTouchTime,E=f.level,v=u.level,(_<m||_===m&&E>v)&&(u=f,h=k,d=b)}u&&h>=0&&(this._unloadTile(d),a=h)}this._tilesLoaded[a]=new i({tile:r.tile,tiledImage:r.tiledImage})},clearTilesFor:function(r){e.console.assert(r,"[TileCache.clearTilesFor] tiledImage is required");for(var o,a=0;a<this._tilesLoaded.length;++a)o=this._tilesLoaded[a],o.tiledImage===r&&(this._unloadTile(o),this._tilesLoaded.splice(a,1),a--)},getImageRecord:function(r){return e.console.assert(r,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[r]},_unloadTile:function(r){e.console.assert(r,"[TileCache._unloadTile] tileRecord is required");var o=r.tile,a=r.tiledImage;let l=o.getCanvasContext&&o.getCanvasContext();o.unload(),o.cacheImageRecord=null;var u=this._imagesLoaded[o.cacheKey];u&&(u.removeTile(o),u.getTileCount()||(u.destroy(),delete this._imagesLoaded[o.cacheKey],this._imagesLoadedCount--,l&&(l.canvas.width=0,l.canvas.height=0,a.viewer.raiseEvent("image-unloaded",{context2D:l,tile:o}))),a.viewer.raiseEvent("tile-unloaded",{tile:o,tiledImage:a}))}}}(t),function(e){e.World=function(i){var n=this;e.console.assert(i.viewer,"[World] options.viewer is required"),e.EventSource.call(this),this.viewer=i.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(r){n._autoRefigureSizes?n._figureSizes():n._needsSizesFigured=!0},this._figureSizes()},e.extend(e.World.prototype,e.EventSource.prototype,{addItem:function(i,n){if(e.console.assert(i,"[World.addItem] item is required"),e.console.assert(i instanceof e.TiledImage,"[World.addItem] only TiledImages supported at this time"),n=n||{},n.index!==void 0){var r=Math.max(0,Math.min(this._items.length,n.index));this._items.splice(r,0,i)}else this._items.push(i);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,i.addHandler("bounds-change",this._delegatedFigureSizes),i.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item:i})},getItemAt:function(i){return e.console.assert(i!==void 0,"[World.getItemAt] index is required"),this._items[i]},getIndexOfItem:function(i){return e.console.assert(i,"[World.getIndexOfItem] item is required"),e.indexOf(this._items,i)},getItemCount:function(){return this._items.length},setItemIndex:function(i,n){e.console.assert(i,"[World.setItemIndex] item is required"),e.console.assert(n!==void 0,"[World.setItemIndex] index is required");var r=this.getIndexOfItem(i);if(n>=this._items.length)throw new Error("Index bigger than number of layers.");n===r||r===-1||(this._items.splice(r,1),this._items.splice(n,0,i),this._needsDraw=!0,this.raiseEvent("item-index-change",{item:i,previousIndex:r,newIndex:n}))},removeItem:function(i){e.console.assert(i,"[World.removeItem] item is required");var n=e.indexOf(this._items,i);n!==-1&&(i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy(),this._items.splice(n,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(i))},removeAll:function(){this.viewer._cancelPendingImages();var i,n;for(n=0;n<this._items.length;n++)i=this._items[n],i.removeHandler("bounds-change",this._delegatedFigureSizes),i.removeHandler("clip-change",this._delegatedFigureSizes),i.destroy();var r=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,n=0;n<r.length;n++)i=r[n],this._raiseRemoveItem(i)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(i){for(var n=!1,r=0;r<this._items.length;r++)n=this._items[r].update(i)||n;return n},draw:function(){this.viewer.drawer.draw(this._items),this._needsDraw=!1,this._items.forEach(i=>{this._needsDraw=i.setDrawn()||this._needsDraw})},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(i){this._autoRefigureSizes=i,i&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(i){i=i||{};var n=i.immediately||!1,r=i.layout||e.DEFAULT_SETTINGS.collectionLayout,o=i.rows||e.DEFAULT_SETTINGS.collectionRows,a=i.columns||e.DEFAULT_SETTINGS.collectionColumns,l=i.tileSize||e.DEFAULT_SETTINGS.collectionTileSize,u=i.tileMargin||e.DEFAULT_SETTINGS.collectionTileMargin,h=l+u,d;!i.rows&&a?d=a:d=Math.ceil(this._items.length/o);var f=0,m=0,v,_,E,b,k;this.setAutoRefigureSizes(!1);for(var V=0;V<this._items.length;V++)V&&V%d===0&&(r==="horizontal"?(m+=h,f=0):(f+=h,m=0)),v=this._items[V],_=v.getBounds(),_.width>_.height?E=l:E=l*(_.width/_.height),b=E*(_.height/_.width),k=new e.Point(f+(l-E)/2,m+(l-b)/2),v.setPosition(k,n),v.setWidth(E,n),r==="horizontal"?f+=h:m+=h;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var i=this._homeBounds?this._homeBounds.clone():null,n=this._contentSize?this._contentSize.clone():null,r=this._contentFactor||0;if(!this._items.length)this._homeBounds=new e.Rect(0,0,1,1),this._contentSize=new e.Point(1,1),this._contentFactor=1;else{var o=this._items[0],a=o.getBounds();this._contentFactor=o.getContentSize().x/a.width;for(var l=o.getClippedBounds().getBoundingBox(),u=l.x,h=l.y,d=l.x+l.width,f=l.y+l.height,m=1;m<this._items.length;m++)o=this._items[m],a=o.getBounds(),this._contentFactor=Math.max(this._contentFactor,o.getContentSize().x/a.width),l=o.getClippedBounds().getBoundingBox(),u=Math.min(u,l.x),h=Math.min(h,l.y),d=Math.max(d,l.x+l.width),f=Math.max(f,l.y+l.height);this._homeBounds=new e.Rect(u,h,d-u,f-h),this._contentSize=new e.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}(this._contentFactor!==r||!this._homeBounds.equals(i)||!this._contentSize.equals(n))&&this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(i){this.raiseEvent("remove-item",{item:i})}})}(t)})(hu);var Hh=hu.exports;const It=zh(Hh);class Va{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||"ontouchstart"in window,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.7,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.animationFrame=null,this.lastUpdateTime=0,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=50,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}getCachedViewportRect(){const t=performance.now();return(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t),this.cachedViewportRect}calculateZunicRosinConvexity(t){const e=this.calculateConvexHull(t),i=this.calculatePolygonPerimeter(e);return this.calculatePolygonPerimeter(t)/i}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),l=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-l}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],l=i[r];if((a[0]-o[0])*(l[1]-o[1])-(a[1]-o[1])*(l[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculateDiscreteRoughness(t){let e=0,i=0;const n=t.length;for(let r=0;r<n;r++){const o=t[(r-1+n)%n],a=t[r],l=t[(r+1)%n],u=Math.atan2(a[1]-o[1],a[0]-o[0]);let d=Math.atan2(l[1]-a[1],l[0]-a[0])-u;for(;d>Math.PI;)d-=2*Math.PI;for(;d<-Math.PI;)d+=2*Math.PI;const f=Math.sqrt(Math.pow(l[0]-a[0],2)+Math.pow(l[1]-a[1],2)),m=Math.abs(d)/(f+1e-10);e+=m,i=Math.max(i,m)}return{avgCurvature:e/n,maxCurvature:i,roughnessScore:1-Math.exp(-e/n)}}analyzeVertexDensity(t){const e=t.length,i=new Array(e).fill(0);let n=0;for(let h=0;h<e;h++){const d=t[(h+1)%e];n+=Math.sqrt(Math.pow(t[h][0]-d[0],2)+Math.pow(t[h][1]-d[1],2))}const o=n/e*3;for(let h=0;h<e;h++)for(let d=0;d<e;d++){if(h===d)continue;Math.sqrt(Math.pow(t[h][0]-t[d][0],2)+Math.pow(t[h][1]-t[d][1],2))<o&&i[h]++}const a=Math.max(...i),l=i.reduce((h,d)=>h+d,0)/e,u=i.reduce((h,d)=>h+Math.pow(d-l,2),0)/e;return{maxDensity:a,avgDensity:l,variance:u,uniformityScore:1-Math.sqrt(u)/(l+1)}}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBoundsFromCoords(t),r=n.width*n.height;return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,vertexDensity:t.length/i}}getHotspotBoundsFromCoords(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;return t.forEach(([o,a])=>{e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)}),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}initialize(){if(this.isInitialized)return;this.overlayElement=document.createElement("div"),this.overlayElement.className="css-spotlight-overlay",this.useClipPath=this.isSafari||this.isIOS,this.useClipPath&&console.log("Using clip-path strategy for Safari/iOS");const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",transition:this.config.enableTransitions?`opacity ${this.config.transitionDuration}ms ease-out`:"none",willChange:"mask, opacity",transform:"translateZ(0)"};if(this.useClipPath,Object.assign(this.overlayElement.style,t),this.isSafari&&!document.getElementById("safari-mask-fix")){const e=document.createElement("style");e.id="safari-mask-fix",e.textContent=`
        .css-spotlight-overlay {
            -webkit-mask-composite: source-in;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translateZ(0);
        }
    `,document.head.appendChild(e)}this.viewer.container.appendChild(this.overlayElement),this.setupEventListeners(),this.isInitialized=!0,console.log("CSSOverlayManager initialized with dynamic SVG data URI masks")}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&this.startAnimation()})}selectHotspot(t){var e;((e=this.state.selectedHotspot)==null?void 0:e.id)!==(t==null?void 0:t.id)&&(this.state.selectedHotspot=t,t?(this.updateSpotlightPosition(),this.state.targetOpacity=1,setTimeout(()=>{this.trackFocusReference()},800),this.startAnimation()):(this.state.targetOpacity=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation()))}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;const t=this.state.selectedHotspot,e=this.getCachedViewportRect();let i=t.shape==="polygon"?t.coordinates:t.coordinates[0];this.getPerformanceMode()==="reduced"&&(i=this.simplifyPolygon(i,.5));const r=this.calculateAdaptivePolygonExpansion(i),o=this.expandPolygon(i,r),a=[];let l=0,u=0;o.forEach(([d,f])=>{const m=this.viewer.viewport.imageToViewportCoordinates(new It.Point(d,f)),v=this.viewer.viewport.viewportToWindowCoordinates(m);l+=v.x,u+=v.y}),l/=o.length,u/=o.length;let h=1;if(this.state.isAutoDeselecting&&this.state.targetOpacity===0&&this.state.opacity<1&&(h=Math.max(.1,this.state.opacity*this.state.opacity)),o.forEach(([d,f])=>{const m=this.viewer.viewport.imageToViewportCoordinates(new It.Point(d,f)),v=this.viewer.viewport.viewportToWindowCoordinates(m),_=l+(v.x-l)*h,E=u+(v.y-u)*h;a.push(`${_},${E}`)}),a.length>0)if(this.useClipPath){const d=e.width,f=e.height,m=`0,0 ${d},0 ${d},${f} 0,${f} 0,0`,v=a.slice().reverse().join(" "),_=`polygon(${m} ${v})`;this.overlayElement.style.clipPath=_,this.overlayElement.style.webkitClipPath=_}else{const d=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}" viewBox="0 0 ${e.width} ${e.height}">
            <defs>
                <mask id="spotlightMask" maskUnits="userSpaceOnUse">
                    <rect fill="white" x="0" y="0" width="100%" height="100%"/>
                    <polygon fill="black" points="${a.join(" ")}"/>
                </mask>
            </defs>
            <rect width="100%" height="100%" fill="black" mask="url(#spotlightMask)"/>
        </svg>`,m=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(d)))}`;this.overlayElement.style.mask=`url("${m}")`,this.overlayElement.style.webkitMask=`url("${m}")`,this.overlayElement.style.maskSize="100% 100%",this.overlayElement.style.webkitMaskSize="100% 100%",this.overlayElement.style.maskRepeat="no-repeat",this.overlayElement.style.webkitMaskRepeat="no-repeat"}this.state.isAnimating||this.applySpotlightStyles()}calculateSpotlightRadius(t,e){const i=this.viewer.viewport.imageToViewportCoordinates(new It.Point(t.x,t.y)),n=this.viewer.viewport.imageToViewportCoordinates(new It.Point(t.x+t.width,t.y+t.height)),r=n.x-i.x,o=n.y-i.y,a=r*this.viewer.container.clientWidth,l=o*this.viewer.container.clientHeight,h=Math.max(a,l)*.75;return Math.max(50,Math.min(500,h))}trackFocusReference(){if(!this.state.selectedHotspot)return;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16}}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||Date.now()-this.focusTracking.selectionTime<500)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return 1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.8?n=1:i<=.3?n=0:n=(i-.3)/(.8-.3);let r=1;if(this.state.selectedHotspot&&e){const o=this.state.selectedHotspot.shape==="polygon"?this.state.selectedHotspot.coordinates:this.state.selectedHotspot.coordinates[0],a=this.viewer.viewport.viewportToImageCoordinates(e),l={x:a.x,y:a.y};if(this.isPointInPolygon(l,o))r=1;else{const u=this.calculateDistanceToPolygon(l,o),h=this.getHotspotBounds(this.state.selectedHotspot),d=(h.width+h.height)/2,f=u/d,m=.1,v=.3;f<=m?r=1:f>=v?r=0:r=1-(f-m)/(v-m)}}return r<.1?r:Math.min(n,r)}isPointInPolygon(t,e){const i=t.x,n=t.y;let r=!1;for(let o=0,a=e.length-1;o<e.length;a=o++){const l=e[o][0],u=e[o][1],h=e[a][0],d=e[a][1];u>n!=d>n&&i<(h-l)*(n-u)/(d-u)+l&&(r=!r)}return r}calculateDistanceToPolygon(t,e){let i=1/0;for(let n=0;n<e.length;n++){const r=(n+1)%e.length,o=this.distanceToLineSegment(t,{x:e[n][0],y:e[n][1]},{x:e[r][0],y:e[r][1]});i=Math.min(i,o)}return i}distanceToLineSegment(t,e,i){const n=i.x-e.x,r=i.y-e.y,o=n*n+r*r;if(o===0)return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));let a=((t.x-e.x)*n+(t.y-e.y)*r)/o;a=Math.max(0,Math.min(1,a));const l=e.x+a*n,u=e.y+a*r;return Math.sqrt(Math.pow(t.x-l,2)+Math.pow(t.y-u,2))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.useClipPath&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath="")}startAnimation(){this.state.isAnimating||(this.state.isAnimating=!0,this.animate())}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t;const e=this.state.targetOpacity-this.state.opacity,i=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(e)>.01?this.state.opacity+=e*i:this.state.opacity=this.state.targetOpacity,this.state.targetOpacity===0&&this.state.opacity>0&&this.updateSpotlightPosition();const n=this.state.targetPosition.x-this.state.currentPosition.x,r=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(n)>.1||Math.abs(r)>.1?(this.state.currentPosition.x+=n*this.config.positionSpeed,this.state.currentPosition.y+=r*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const o=this.state.targetRadius-this.state.currentRadius;Math.abs(o)>1?this.state.currentRadius+=o*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.applySpotlightStyles(),Math.abs(e)<=.01&&Math.abs(n)<=.1&&Math.abs(r)<=.1&&Math.abs(o)<=1&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t;this.overlayElement.style.opacity=e,this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([l,u])=>{e=Math.min(e,l),i=Math.min(i,u),n=Math.max(n,l),r=Math.max(r,u)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}calculateAdaptivePolygonExpansion(t){const e=this.calculatePolygonMetrics(t);this.calculateZunicRosinConvexity(t);const i=this.calculateDiscreteRoughness(t);let n=0;return i.maxCurvature>10&&(n=Math.max(n,.5)),(e.aspectRatio>3||e.aspectRatio<.33)&&(n=Math.max(n,.4)),1+n*.1}logExpansionMetrics(t){this.lastExpansionMetrics&&console.log(`Expansion metrics for hotspot ${t}:`,this.lastExpansionMetrics)}expandPolygon(t,e){const i=this.getHotspotBoundsFromCoords(t),n=i.centerX,r=i.centerY;return t.map(([o,a])=>{const l=o-n,u=a-r;return[n+l*e,r+u*e]})}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.useClipPath&&this.overlayElement&&(this.overlayElement.style.clipPath="",this.overlayElement.style.webkitClipPath=""),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}}class La{constructor(t){this.viewer=t,this.overlayElement=null,this.isInitialized=!1,this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isWebKit="WebkitAppearance"in document.documentElement.style&&!window.chrome,this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.isMobile=this.isIOS||/Android/i.test(navigator.userAgent),this.isSafariOrWebKit=this.isSafari||this.isWebKit,this.supportsMaskImage=CSS.supports("-webkit-mask-image","radial-gradient(circle, black, transparent)"),this.state={selectedHotspot:null,currentPosition:{x:50,y:50},targetPosition:{x:50,y:50},currentRadius:0,targetRadius:0,opacity:0,targetOpacity:0,scale:1,targetScale:1,isAnimating:!1,isFadingOut:!1,isAutoDeselecting:!1},this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16},this.config={maxOpacity:.85,fadeSpeed:.15,fadeSpeedAutoDeselect:.5,positionSpeed:.2,radiusSpeed:.2,scaleSpeed:.25,baseRadius:150,updateThrottle:16,enableTransitions:!0,transitionDuration:300,maxGradientStops:4,useEllipse:!0,aspectRatioThreshold:1.1,memoryLimit:this.isIOS?50:200,enableAdvancedMetrics:!0,adaptiveQuality:!0,debugMetrics:!1},this.zoomConfig={fadeStartZoom:2,fadeEndZoom:4,minCoverageRatio:1,enableZoomFade:!1},this.useEllipse=!1,this.ellipseData={radiusX:100,radiusY:100,rotation:0},this.tuningParams={circleMultiplier:.22,ellipseMultiplierX:1.2,ellipseMultiplierY:1.15,gradientMultiplier:1.5,pixelRadiusMultiplier:1,adaptivePaddingMultiplier:1.3,offsetX:0,offsetY:0},window.safariTuning=this.tuningParams,this.ellipseCache=new Map,this.ellipseCacheTimeout=null,this.animationFrame=null,this.zoomUpdateTimeout=null,this.lastUpdateTime=0,this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.lastPositionUpdate=0,this.positionUpdateThrottle=16,this.cachedViewportRect=null,this.viewportRectCacheTime=0,this.viewportRectCacheDuration=100,this.memoryUsage=0,this.gradientCount=0,this.animate=this.animate.bind(this),this.updateSpotlightPosition=this.updateSpotlightPosition.bind(this)}calculateMinimumEnclosingCircle(t){const e=[...t];for(let i=e.length-1;i>0;i--){const n=Math.floor(Math.random()*(i+1));[e[i],e[n]]=[e[n],e[i]]}return this.welzl(e,[],e.length)}welzl(t,e,i){if(i===0||e.length===3)return this.minCircleTrivial(e);const n=t[i-1],r=this.welzl(t,e,i-1);return this.isInsideCircle(r,n)?r:this.welzl(t,[...e,n],i-1)}minCircleTrivial(t){if(t.length===0)return{x:0,y:0,r:0};if(t.length===1)return{x:t[0][0],y:t[0][1],r:0};if(t.length===2){const e=(t[0][0]+t[1][0])/2,i=(t[0][1]+t[1][1])/2,n=t[0][0]-t[1][0],r=t[0][1]-t[1][1],o=Math.sqrt(n*n+r*r)/2;return{x:e,y:i,r:o}}return this.circleFromThreePoints(t[0],t[1],t[2])}circleFromThreePoints(t,e,i){const[n,r]=t,[o,a]=e,[l,u]=i,h=n*(a-u)-r*(o-l)+o*u-l*a;if(Math.abs(h)<1e-10)return this.minCircleTrivial([t,e]);const d=(n*n+r*r)*(u-a)+(o*o+a*a)*(r-u)+(l*l+u*u)*(a-r),f=(n*n+r*r)*(o-l)+(o*o+a*a)*(l-n)+(l*l+u*u)*(n-o),m=-d/(2*h),v=-f/(2*h),_=n-m,E=r-v,b=Math.sqrt(_*_+E*E);return{x:m,y:v,r:b}}isInsideCircle(t,e){const i=e[0]-t.x,n=e[1]-t.y;return i*i+n*n<=t.r*t.r*1.0001}calculateAdaptivePadding(t,e){const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=this.calculatePolygonArea(t),r=i.width*i.height,o=n/r,a=this.calculateConvexHull(t),l=this.calculatePolygonArea(a),u=n/l;let h=1;return u<.6?h=1.4:o<.7?h=1.3:h=1.2,this.isMobile&&(h*=.8),e*h*this.tuningParams.adaptivePaddingMultiplier}calculateEllipseFromPolygon(t){var u,h;const e=((u=this.state.selectedHotspot)==null?void 0:u.id)||`${t.length}_${JSON.stringify(t.slice(0,3))}`;if(this.ellipseCache.has(e)){const d=this.ellipseCache.get(e);return this.useEllipse=d.useEllipse,d.data}const i=this.getHotspotBounds({coordinates:t,shape:"polygon"}),n=i.width/i.height,r=(Math.max(i.width,i.height)-Math.min(i.width,i.height))/(i.width+i.height);let o=!1;if(n<=1.5&&r<=.3?o=!1:n>2||r>.5?o=!0:o=Math.abs(i.width-i.height)/Math.max(i.width,i.height)>.3,console.log("Shape decision:",{hotspotId:(h=this.state.selectedHotspot)==null?void 0:h.id,aspectRatio:n.toFixed(2),elongationIndex:r.toFixed(2),useEllipse:o}),!o)return this.ellipseCache.set(e,{useEllipse:!1,data:null}),this.useEllipse=!1,null;const a=1.2,l={radiusX:i.width/2*a*this.tuningParams.ellipseMultiplierX,radiusY:i.height/2*a*this.tuningParams.ellipseMultiplierY,rotation:0,aspectRatio:n,centerX:i.centerX,centerY:i.centerY};return this.ellipseCache.set(e,{useEllipse:!0,data:l}),this.useEllipse=!0,this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.ellipseCacheTimeout=setTimeout(()=>{this.ellipseCache.clear()},5e3),l}calculateConvexityFactor(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=t[n],o=t[(n+1)%i],a=t[(n+2)%i],l=(o[0]-r[0])*(a[1]-o[1])-(o[1]-r[1])*(a[0]-o[0]);if(n>0){const u=(t[(n-1+i)%i][0]-t[(n-2+i)%i][0])*(t[n][1]-t[(n-1+i)%i][1])-(t[(n-1+i)%i][1]-t[(n-2+i)%i][1])*(t[n][0]-t[(n-1+i)%i][0]);l*u<0&&e++}}return Math.min(e/(i*.5),1)}calculateConvexHull(t){let e=0;for(let r=1;r<t.length;r++)(t[r][1]<t[e][1]||t[r][1]===t[e][1]&&t[r][0]<t[e][0])&&(e=r);const i=t.slice().sort((r,o)=>{if(r===t[e])return-1;if(o===t[e])return 1;const a=Math.atan2(r[1]-t[e][1],r[0]-t[e][0]),l=Math.atan2(o[1]-t[e][1],o[0]-t[e][0]);return a-l}),n=[i[0],i[1]];for(let r=2;r<i.length;r++){for(;n.length>1;){const o=n[n.length-2],a=n[n.length-1],l=i[r];if((a[0]-o[0])*(l[1]-o[1])-(a[1]-o[1])*(l[0]-o[0])>0)break;n.pop()}n.push(i[r])}return n}calculatePolygonArea(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i;e+=t[n][0]*t[r][1],e-=t[r][0]*t[n][1]}return Math.abs(e)/2}calculatePolygonPerimeter(t){let e=0;const i=t.length;for(let n=0;n<i;n++){const r=(n+1)%i,o=t[r][0]-t[n][0],a=t[r][1]-t[n][1];e+=Math.sqrt(o*o+a*a)}return e}calculatePolygonMetrics(t){const e=this.calculatePolygonArea(t),i=this.calculatePolygonPerimeter(t),n=this.getHotspotBounds({coordinates:t,shape:"polygon"}),r=n.width*n.height,o=this.calculateElongationIndex(n);return{area:e,perimeter:i,fillEfficiency:e/r,compactness:4*Math.PI*e/(i*i),aspectRatio:n.width/n.height,elongationIndex:o,vertexDensity:t.length/i}}calculateElongationIndex(t){const e=Math.max(t.width,t.height),i=Math.min(t.width,t.height);return(e-i)/(e+i)}calculateZoomAwareOpacity(t){if(!this.viewer||!this.zoomConfig.enableZoomFade)return t;const e=this.viewer.viewport.getZoom();if(e<=this.zoomConfig.fadeStartZoom)return t;if(e>=this.zoomConfig.fadeEndZoom)return 0;const i=this.zoomConfig.fadeEndZoom-this.zoomConfig.fadeStartZoom,n=(e-this.zoomConfig.fadeStartZoom)/i,r=1-Math.pow(1-n,2);return t*(1-r)}initialize(){if(console.log("SafariOverlayManager.initialize() called"),this.isInitialized){console.log("Already initialized, skipping");return}this.overlayElement=document.createElement("div"),this.overlayElement.className="safari-spotlight-overlay",console.log("Overlay element created:",this.overlayElement),this.applyInitialStyles(),console.log("Initial styles applied"),this.viewer.container.appendChild(this.overlayElement),console.log("Overlay element added to DOM"),console.log("Parent element:",this.viewer.container),console.log("Overlay element in DOM?",document.contains(this.overlayElement)),this.setupEventListeners(),console.log("Event listeners set up"),this.injectSafariStyles(),this.isInitialized=!0,console.log("SafariOverlayManager initialized successfully")}applyInitialStyles(){const t={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1000",backgroundColor:`rgba(0, 0, 0, ${this.config.maxOpacity})`,opacity:"0",display:"block",visibility:"hidden","-webkit-mask-image":this.createGradientMask(50,50,0,0),"mask-image":this.createGradientMask(50,50,0,0),"-webkit-mask-size":"100% 100%","mask-size":"100% 100%","-webkit-mask-repeat":"no-repeat","mask-repeat":"no-repeat","-webkit-transform":"translateZ(0)",transform:"translateZ(0)","-webkit-backface-visibility":"hidden","backface-visibility":"hidden","will-change":"transform, opacity",contain:"paint layout",isolation:"isolate"};console.log("Applying initial styles:",{backgroundColor:t.backgroundColor,opacity:t.opacity,zIndex:t.zIndex}),this.config.enableTransitions&&(t.transition=`opacity ${this.config.transitionDuration}ms ease-out`),Object.assign(this.overlayElement.style,t)}createGradientMask(t,e,i,n,r=!1,o=null){if(r&&o){const d=o.radiusX*n*this.tuningParams.ellipseMultiplierX,f=o.radiusY*n*this.tuningParams.ellipseMultiplierY,v=[{position:0,opacity:0},{position:.5,opacity:.15},{position:.8,opacity:.5},{position:1,opacity:1}].map(_=>{const E=d*_.position,b=f*_.position,k=(E+b)/2;return`rgba(0,0,0,${_.opacity}) ${k*this.tuningParams.gradientMultiplier}px`}).join(", ");return`radial-gradient(ellipse ${d*this.tuningParams.gradientMultiplier}px ${f*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%, 
        rgba(0,0,0,0) 0px,
        ${v})`}const l=i*n*this.tuningParams.circleMultiplier,h=[{position:0,opacity:0},{position:.19,opacity:.042},{position:.34,opacity:.126},{position:.47,opacity:.278},{position:.565,opacity:.382},{position:.65,opacity:.541},{position:.73,opacity:.738},{position:.802,opacity:.875},{position:.861,opacity:.942},{position:.91,opacity:.979},{position:.952,opacity:.992},{position:1,opacity:1}].map(d=>{const f=l+l*this.tuningParams.gradientMultiplier*.8*d.position;return`rgba(0,0,0,${d.opacity}) ${f}px`}).join(", ");return`radial-gradient(circle ${l*this.tuningParams.gradientMultiplier}px at ${t}% ${e}%,
    rgba(0,0,0,0) 0px,
    rgba(0,0,0,0) ${l}px,
    ${h})`}injectSafariStyles(){if(document.getElementById("safari-overlay-styles"))return;const t=document.createElement("style");t.id="safari-overlay-styles",t.textContent=`
            .safari-spotlight-overlay {
                /* Force GPU acceleration */
                -webkit-transform: translateZ(0.0001px);
                -webkit-perspective: 1000;
            }
            
            /* CSS custom properties for animation */
            @property --spotlight-x {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-y {
                syntax: '<percentage>';
                inherits: true;
                initial-value: 50%;
            }
            
            @property --spotlight-radius {
                syntax: '<length>';
                inherits: true;
                initial-value: 100px;
            }
            
            @property --spotlight-scale {
                syntax: '<number>';
                inherits: true;
                initial-value: 1;
            }
        `,document.head.appendChild(t)}setupEventListeners(){this.viewer.addHandler("viewport-change",()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()}),this.viewer.addHandler("zoom",()=>{this.state.selectedHotspot&&(this.cachedViewportRect=null,this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.zoomUpdateTimeout=setTimeout(()=>{this.checkAutoDeselect()},100))}),this.viewer.addHandler("animation-finish",()=>{this.state.selectedHotspot&&this.checkAutoDeselect()}),this.viewer.addHandler("pan",()=>{this.state.selectedHotspot&&!this.state.isAnimating&&!this.animationFrame&&this.startAnimation()}),this.resizeHandler=()=>{this.cachedViewportRect=null,this.state.selectedHotspot&&this.updateSpotlightPosition()},window.addEventListener("resize",this.resizeHandler)}selectHotspot(t){var e,i;if(console.log("SafariOverlayManager.selectHotspot called with:",(t==null?void 0:t.id)||"null"),console.log("Current state before selection:",{isInitialized:this.isInitialized,hasOverlayElement:!!this.overlayElement,currentSelected:(e=this.state.selectedHotspot)==null?void 0:e.id}),((i=this.state.selectedHotspot)==null?void 0:i.id)===(t==null?void 0:t.id)){console.log("Same hotspot already selected, skipping");return}this.state.selectedHotspot=t,t?(console.log("Selecting hotspot, updating position..."),this.overlayElement&&(this.overlayElement.style.display="block",this.overlayElement.style.visibility="visible"),this.updateSpotlightPosition(),this.state.targetOpacity=1,this.state.targetScale=1,console.log("State after selection:",{targetOpacity:this.state.targetOpacity,currentOpacity:this.state.opacity,targetScale:this.state.targetScale}),this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,setTimeout(()=>{this.trackFocusReference()},800),console.log("Starting animation..."),this.startAnimation()):(console.log("Deselecting hotspot"),this.state.targetOpacity=0,this.state.targetScale=0,this.state.targetRadius=0,this.resetFocusTracking(),this.startAnimation())}updateSpotlightPosition(){if(!this.state.selectedHotspot||!this.overlayElement)return;if(this.isUpdatingPosition){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,requestAnimationFrame(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()}));return}const t=performance.now();if(t-this.lastPositionUpdate<this.positionUpdateThrottle){this.positionUpdateScheduled||(this.positionUpdateScheduled=!0,setTimeout(()=>{this.positionUpdateScheduled=!1,this.updateSpotlightPosition()},this.positionUpdateThrottle-(t-this.lastPositionUpdate)));return}this.isUpdatingPosition=!0,this.lastPositionUpdate=t;try{const e=this.state.selectedHotspot,i=this.getPerformanceMode();let n="full",r;if(i==="reduced"){const E=e.shape==="polygon"?e.coordinates:e.coordinates[0],b=this.simplifyPolygon(E,.5),k={...e,coordinates:e.shape==="polygon"?b:[b]};r=this.calculateSpotlightGeometry(k),n="simplified"}else r=this.calculateSpotlightGeometry(e);(!this.cachedViewportRect||t-this.viewportRectCacheTime>this.viewportRectCacheDuration)&&(this.cachedViewportRect=this.viewer.container.getBoundingClientRect(),this.viewportRectCacheTime=t);const o=this.cachedViewportRect,a=this.viewer.viewport.imageToViewportCoordinates(new It.Point(r.center.x,r.center.y)),l=this.viewer.viewport.viewportToWindowCoordinates(a);console.log("Coordinate conversion debug:",{imageCenter:r.center,viewportPoint:{x:a.x,y:a.y},windowPoint:{x:l.x,y:l.y},viewerSize:{width:this.viewer.container.clientWidth,height:this.viewer.container.clientHeight}});const u=l.x/o.width*100+this.tuningParams.offsetX,h=l.y/o.height*100+this.tuningParams.offsetY;this.state.targetPosition={x:u,y:h};const d=this.viewer.world.getItemAt(0).getContentSize(),f=r.radius/d.x,m=this.viewer.viewport.getZoom(),v=f*o.width*m,_=this.getHotspotBounds(e);if(_){const E=_.width/d.x*o.width*m,b=_.height/d.y*o.height*m,V=Math.max(E,b)/2*this.zoomConfig.minCoverageRatio;this.state.targetRadius=Math.max(V,v*this.tuningParams.pixelRadiusMultiplier)}else this.state.targetRadius=Math.max(80,Math.min(400,v*this.tuningParams.pixelRadiusMultiplier));if(console.log("Zoom-aware radius:",{currentZoom:m.toFixed(2),targetRadius:this.state.targetRadius.toFixed(0),willFade:m>this.zoomConfig.fadeStartZoom}),r.ellipseData){const E=r.ellipseData.radiusX/d.x*o.width*m,b=r.ellipseData.radiusY/d.y*o.height*m;this.useEllipse||(this.ellipseData={radiusX:this.state.currentRadius,radiusY:this.state.currentRadius,rotation:r.ellipseData.rotation}),this.ellipseData.targetRadiusX=E,this.ellipseData.targetRadiusY=b,this.ellipseData.rotation=r.ellipseData.rotation,this.useEllipse=!0}else this.useEllipse&&(this.ellipseData.targetRadiusX=this.state.targetRadius,this.ellipseData.targetRadiusY=this.state.targetRadius),this.useEllipse=!1;console.log("Spotlight position debug:",{hotspotId:e.id,hotspotCenter:r.center,windowPoint:l,viewportRect:{width:o.width,height:o.height},percentages:{x:u,y:h},radius:{geometric:r.radius,inViewport:f,inPixels:v,final:this.state.targetRadius},currentState:{x:this.state.currentPosition.x,y:this.state.currentPosition.y,radius:this.state.currentRadius},ellipseData:this.ellipseData,useEllipse:this.useEllipse,geometryQuality:n}),this.aspectRatio=r.aspectRatio,this.state.isAnimating?this.animationFrame||this.startAnimation():(this.state.currentPosition={...this.state.targetPosition},this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0&&(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY),this.applySpotlightStyles())}finally{this.isUpdatingPosition=!1}}invalidateViewportCache(){this.cachedViewportRect=null,this.viewportRectCacheTime=0}calculateSpotlightGeometry(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0],i=this.getHotspotBounds(t),n=this.calculateEllipseFromPolygon(e);if(n&&this.useEllipse)return{center:{x:n.centerX,y:n.centerY},radius:Math.max(n.radiusX,n.radiusY),aspectRatio:n.aspectRatio,bounds:i,ellipseData:n,useEllipse:!0};{const r=this.calculateMinimumEnclosingCircle(e);r.r>Math.max(i.width,i.height)&&(console.warn("Welzl radius too large, using bounds-based calculation"),r.r=Math.max(i.width,i.height)/2);const o=this.calculateAdaptivePadding(e,r.r);return{center:{x:r.x,y:r.y},radius:r.r+o,aspectRatio:i.width/i.height,bounds:i,ellipseData:null,useEllipse:!1}}}calculatePolygonCentroid(t){const e=t.shape==="polygon"?t.coordinates:t.coordinates[0];let i=0,n=0,r=0;const o=e.length;for(let u=0,h=o-1;u<o;h=u++){const d=e[u][0],f=e[u][1],m=e[h][0],v=e[h][1],_=d*v-m*f;i+=_,n+=(d+m)*_,r+=(f+v)*_}i*=.5;const a=n/(6*i),l=r/(6*i);if(!isFinite(a)||!isFinite(l)){let u=0,h=0;return e.forEach(([d,f])=>{u+=d,h+=f}),{x:u/e.length,y:h/e.length}}return{x:a,y:l}}trackFocusReference(){if(!this.state.selectedHotspot){console.log("trackFocusReference: No selected hotspot");return}const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=this.getHotspotBounds(this.state.selectedHotspot);this.focusTracking={referenceZoom:t,referenceCenter:{x:e.x,y:e.y},hotspotCenter:i?{x:i.centerX,y:i.centerY}:null,selectionTime:Date.now(),lastCalculation:0,throttleInterval:16},console.log("Focus reference tracked:",this.focusTracking)}checkAutoDeselect(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom||this.isUpdatingPosition)return;const t=Date.now()-this.focusTracking.selectionTime;if(t<2e3)return;const e=this.calculateFocusScore(),i=e*this.config.maxOpacity,n=.1;console.log("Auto-deselect check:",{timeSinceSelection:t,focusScore:e,visibleOpacity:i,threshold:n,willDeselect:i<n}),i<n&&(console.log("Auto-deselecting: visible opacity below threshold",{focusScore:e.toFixed(3),visibleOpacity:i.toFixed(3),threshold:n}),this.autoDeselect())}calculateFocusScore(){if(!this.state.selectedHotspot||!this.focusTracking.referenceZoom)return console.log("calculateFocusScore: Missing data, returning 1.0"),1;const t=this.viewer.viewport.getZoom(),e=this.viewer.viewport.getCenter(),i=t/this.focusTracking.referenceZoom;let n=1;i>=.95?n=1:i<=.4?n=0:n=(i-.4)/(.95-.4);let r=1;if(this.focusTracking.hotspotCenter&&e){const o=this.viewer.viewport.imageToViewportCoordinates(new It.Point(this.focusTracking.hotspotCenter.x,this.focusTracking.hotspotCenter.y));if(this.useEllipse&&this.ellipseData){const a=this.viewer.world.getItemAt(0).getContentSize();this.viewer.container.getBoundingClientRect(),this.viewer.viewport.getZoom();const l=this.ellipseData.radiusX/a.x,u=this.ellipseData.radiusY/a.y,h=this.calculateEllipseDistance(o.x,o.y,e.x,e.y,l,u,this.ellipseData.rotation),d=.5,f=.2;h<=d?r=1:h>=d+f?r=0:r=1-(h-d)/f}else{const a=e.x-o.x,l=e.y-o.y,u=Math.sqrt(a*a+l*l),h=.01,d=.02;u<=h?r=1:u>=h+d?r=0:r=1-(u-h)/d}}return r<.1?r:i>=.8&&r>.9?1:Math.min(n,r)}calculateEllipseDistance(t,e,i,n,r,o,a){const l=a*Math.PI/180,u=Math.cos(l),h=Math.sin(l),d=i-t,f=n-e,m=d*u+f*h,v=-d*h+f*u;return Math.sqrt(m*m/(r*r)+v*v/(o*o))}autoDeselect(){console.log("Auto-deselecting hotspot"),this.state.opacity=0,this.state.targetOpacity=0,this.state.scale=0,this.state.targetScale=0,this.overlayElement.style.opacity="0",this.overlayElement.style.display="none",this.state.selectedHotspot=null,this.resetFocusTracking(),this.state.isAutoDeselecting=!1,this.state.isFadingOut=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.state.isAnimating=!1),window.nativeHotspotRenderer&&window.nativeHotspotRenderer.instantDeselect(),window.artworkViewerHandleHotspotClick&&window.artworkViewerHandleHotspotClick(null)}clearSelection(){this.selectHotspot(null)}startAnimation(){if(console.log("startAnimation called, isAnimating:",this.state.isAnimating),this.state.isAnimating){console.log("Already animating, skipping");return}this.positionUpdateScheduled=!1,this.isUpdatingPosition=!1,this.overlayElement&&this.overlayElement.style.display==="none"&&(this.overlayElement.style.display="block"),this.state.isAnimating=!0,console.log("Animation started"),this.animate()}animate(){const t=performance.now();if(t-this.lastUpdateTime<this.config.updateThrottle){this.animationFrame=requestAnimationFrame(this.animate);return}this.lastUpdateTime=t,this.performanceCheckCounter||(this.performanceCheckCounter=0),this.performanceCheckCounter++,this.performanceCheckCounter%60===0&&this.checkEllipsePerformance(),this.animateLogCount||(this.animateLogCount=0),this.animateLogCount<5&&this.animateLogCount++;const e=this.state.targetOpacity*this.config.maxOpacity,i=this.calculateZoomAwareOpacity(e),n=i-this.state.opacity,r=this.state.isAutoDeselecting?this.config.fadeSpeedAutoDeselect:this.config.fadeSpeed;Math.abs(n)>.001?(this.state.opacity+=n*r,this.state.opacity=Math.max(0,Math.min(this.config.maxOpacity,this.state.opacity))):this.state.opacity=i;const o=this.state.targetScale-this.state.scale;Math.abs(o)>.01?this.state.scale+=o*this.config.scaleSpeed:this.state.scale=this.state.targetScale;const a=this.state.targetPosition.x-this.state.currentPosition.x,l=this.state.targetPosition.y-this.state.currentPosition.y;Math.abs(a)>.1||Math.abs(l)>.1?(this.state.currentPosition.x+=a*this.config.positionSpeed,this.state.currentPosition.y+=l*this.config.positionSpeed):this.state.currentPosition={...this.state.targetPosition};const u=this.state.targetRadius-this.state.currentRadius;if(Math.abs(u)>1?this.state.currentRadius+=u*this.config.radiusSpeed:this.state.currentRadius=this.state.targetRadius,this.ellipseData&&this.ellipseData.targetRadiusX!==void 0){const d=this.ellipseData.targetRadiusX-this.ellipseData.radiusX,f=this.ellipseData.targetRadiusY-this.ellipseData.radiusY;Math.abs(d)>1||Math.abs(f)>1?(this.ellipseData.radiusX+=d*this.config.radiusSpeed,this.ellipseData.radiusY+=f*this.config.radiusSpeed):(this.ellipseData.radiusX=this.ellipseData.targetRadiusX,this.ellipseData.radiusY=this.ellipseData.targetRadiusY)}this.applySpotlightStyles(),Math.abs(n)<=.001&&Math.abs(a)<=.1&&Math.abs(l)<=.1&&Math.abs(u)<=1&&Math.abs(o)<=.01&&this.state.opacity===0&&!this.state.selectedHotspot?(this.state.isAnimating=!1,this.state.isAutoDeselecting=!1,this.overlayElement.style.display="none"):this.animationFrame=requestAnimationFrame(this.animate)}applySpotlightStyles(){this.state.opacity>0&&(this.overlayElement.style.visibility="visible"),this.state.opacity>0&&this.overlayElement.style.display==="none"&&(console.log("Making overlay visible"),this.overlayElement.style.display="block");const t=this.state.selectedHotspot?this.calculateFocusScore():1,e=this.state.opacity*t,i=this.createGradientMask(this.state.currentPosition.x,this.state.currentPosition.y,this.state.currentRadius,this.state.scale,this.useEllipse,this.ellipseData);this.overlayElement.style.opacity=e,this.overlayElement.style["-webkit-mask-image"]=i,this.overlayElement.style["mask-image"]=i,this.overlayElement.style["-webkit-transform"]="translateZ(0)",this.overlayElement.style.transform="translateZ(0)",e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none"),e===0&&!this.state.selectedHotspot&&(this.overlayElement.style.display="none",this.overlayElement.style.visibility="hidden")}getHotspotBounds(t){if(!t.coordinates)return null;let e=1/0,i=1/0,n=-1/0,r=-1/0;const o=a=>{a.forEach(([l,u])=>{e=Math.min(e,l),i=Math.min(i,u),n=Math.max(n,l),r=Math.max(r,u)})};return t.shape==="polygon"?o(t.coordinates):t.shape==="multipolygon"&&t.coordinates.forEach(a=>o(a)),{x:e,y:i,width:n-e,height:r-i,centerX:(e+n)/2,centerY:(i+r)/2}}resetFocusTracking(){this.focusTracking={referenceZoom:null,referenceCenter:null,hotspotCenter:null,selectionTime:null,lastCalculation:0,throttleInterval:16}}prepareForZoom(){}endZoom(){this.state.selectedHotspot&&this.updateSpotlightPosition()}getPerformanceMode(){if(!window.performanceMonitor)return"full";const t=window.performanceMonitor.getMetrics();return t.averageFPS<30?"reduced":t.averageFPS<45?"medium":"full"}simplifyPolygon(t,e){if(t.length<=3)return t;let i=0,n=0;const r=t.length;for(let o=1;o<r-1;o++){const a=this.perpendicularDistance(t[o],t[0],t[r-1]);a>i&&(i=a,n=o)}if(i>e){const o=this.simplifyPolygon(t.slice(0,n+1),e),a=this.simplifyPolygon(t.slice(n),e);return[...o.slice(0,-1),...a]}else return[t[0],t[r-1]]}perpendicularDistance(t,e,i){const n=i[0]-e[0],r=i[1]-e[1],o=Math.sqrt(n*n+r*r);if(o===0)return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2));const a=((t[0]-e[0])*n+(t[1]-e[1])*r)/(o*o),l=[e[0]+a*n,e[1]+a*r];return Math.sqrt(Math.pow(t[0]-l[0],2)+Math.pow(t[1]-l[1],2))}logPaddingMetrics(t){this.lastPaddingMetrics&&console.log(`Padding metrics for hotspot ${t}:`,this.lastPaddingMetrics)}forceRecalculation(){this.state.selectedHotspot&&(this.ellipseCache.clear(),this.updateSpotlightPosition(),!this.state.isAnimating&&this.applySpotlightStyles())}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ellipseCacheTimeout&&clearTimeout(this.ellipseCacheTimeout),this.zoomUpdateTimeout&&clearTimeout(this.zoomUpdateTimeout),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.isUpdatingPosition=!1,this.positionUpdateScheduled=!1,this.cachedViewportRect=null,this.viewer&&(this.viewer.removeAllHandlers("viewport-change"),this.viewer.removeAllHandlers("zoom"),this.viewer.removeAllHandlers("animation-finish"),this.viewer.removeAllHandlers("pan")),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement),this.overlayElement=null,this.viewer=null,this.isInitialized=!1}testGradientPerformance(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    `,document.body.appendChild(t);const e=[{stops:3,type:"circle"},{stops:7,type:"circle"},{stops:12,type:"circle"},{stops:5,type:"ellipse"}];e.forEach((i,n)=>{setTimeout(()=>{const r=performance.now();let o=0;const a=()=>{if(o<60){const l=i.type==="circle"?this.createGradientMask(50,50,150,1):this.createGradientMask(50,50,150,1,!0,{radiusX:200,radiusY:100,rotation:0});t.style.maskImage=l,t.style.webkitMaskImage=l,o++,requestAnimationFrame(a)}else{const l=performance.now()-r,u=o/l*1e3;console.log(`Config ${i.stops} stops (${i.type}): ${u.toFixed(1)} FPS`),n===e.length-1&&t.remove()}};a()},n*1500)})}checkEllipsePerformance(){if(!(!this.state.selectedHotspot||!this.useEllipse)&&window.performanceMonitor){const t=window.performanceMonitor.getMetrics();t.averageFPS<45&&this.useEllipse&&(console.warn("Disabling ellipses due to low FPS:",t.averageFPS),this.useEllipse=!1,this.config.useEllipse=!1,setTimeout(()=>{this.config.useEllipse=!0},1e4))}}}class bi{static create(t){const e=this.detectBrowser();return console.log("Browser detection:",{isSafari:e.isSafari,isIOS:e.isIOS,isWebKit:e.isWebKit,userAgent:navigator.userAgent}),e.isSafari||e.isIOS||e.isWebKit?(console.log("Using SafariOverlayManager for WebKit-based browser"),new La(t)):(console.log("Using CSSOverlayManager (default)"),new Va(t))}static detectBrowser(){const t=navigator.userAgent,e=navigator.platform,i=/iPad|iPhone|iPod/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1,n=/^((?!chrome|chromium|crios|android).)*safari/i.test(t),r=n&&!i&&/Mac/.test(e),o="WebkitAppearance"in document.documentElement.style&&!window.chrome,a=/CriOS/.test(t);return{isSafari:n,isIOS:i,isWebKit:o,isIOSChrome:a,isMacOSSafari:r,isWebKitBased:n||i||a}}static setPreference(t){return t==="css"||t==="safari"?(localStorage.setItem("overlayType",t),console.log(`Overlay preference set to: ${t}`),!0):(console.warn(`Invalid overlay type: ${t}. Use 'css' or 'safari'.`),!1)}static getCurrentType(){const e=new URLSearchParams(window.location.search).get("overlay");if(e==="css"||e==="safari")return console.log(`Overlay type forced via URL: ${e}`),e;const i=localStorage.getItem("overlayType");return i==="css"||i==="safari"?(console.log(`Overlay type from preference: ${i}`),i):null}static createWithOverride(t){const e=this.getCurrentType();return e==="safari"?(console.log("Creating SafariOverlayManager (forced)"),new La(t)):e==="css"?(console.log("Creating CSSOverlayManager (forced)"),new Va(t)):this.create(t)}}function Uh(){var me,Ke,je,Dt,kt,qt,Zt;const[s,t]=oe(!0),[e,i]=oe(!1),[n,r]=oe(!1);console.log("[useViewerState] Initializing state:",{isLoading:s(),viewerReady:e(),previewLoaded:n()});const[o,a]=oe(null),[l,u]=oe(null),[h,d]=oe(null),[f,m]=oe(null),[v,_]=oe(!1),[E,b]=oe(!1),[k,V]=oe(!1),[W,z]=oe({x:0,y:0}),[j,D]=oe(!1),[x,I]=oe(!1),[M,F]=oe({}),[O,R]=oe(null),[ne,ee]=oe(parseInt(localStorage.getItem("debugLevel")??"1")),[ae,q]=oe(parseFloat(localStorage.getItem("zoomSpeedMultiplier")||"1.0")),[Q,J]=oe(((me=window.safariTuning)==null?void 0:me.circleMultiplier)||(He()?.8:1.2)),[se,xe]=oe(((Ke=window.safariTuning)==null?void 0:Ke.ellipseMultiplierX)||(He()?.8:1.15)),[pe,X]=oe(((je=window.safariTuning)==null?void 0:je.ellipseMultiplierY)||(He()?.8:1.15)),[Se,Re]=oe(((Dt=window.safariTuning)==null?void 0:Dt.gradientMultiplier)||(He()?1:1.5)),[tt,We]=oe(((kt=window.safariTuning)==null?void 0:kt.offsetX)||0),[pt,lt]=oe(((qt=window.safariTuning)==null?void 0:qt.offsetY)||0),[xt,st]=oe(!1),[ot,gt]=oe({x:0,y:0}),[mt,le]=oe(!1),[Oe,g]=oe({x:0,y:0}),[P,L]=oe(0),[Y,te]=oe(null),[he,Z]=oe(localStorage.getItem("interactionMode")||(He()?"temporal":"direct")),[ye,Pe]=oe(localStorage.getItem("revealStyle")||"invert"),[Te,de]=oe({}),[Le,T]=oe(null),[w,C]=oe(((Zt=window.nativeHotspotRenderer)==null?void 0:Zt.currentPalette)||"tech"),[A,U]=oe(bi.getCurrentType()||(bi.detectBrowser().isWebKitBased?"safari":"css"));return{isLoading:s,setIsLoading:ut=>{console.log(`[useViewerState] setIsLoading called with: ${ut}`),t(ut)},viewerReady:e,setViewerReady:ut=>{console.log(`[useViewerState] setViewerReady called with: ${ut}`),i(ut)},previewLoaded:n,setPreviewLoaded:r,hoveredHotspot:o,setHoveredHotspot:a,selectedHotspot:l,setSelectedHotspot:u,currentPlayingHotspot:h,setCurrentPlayingHotspot:d,currentMediaHotspot:f,setCurrentMediaHotspot:m,showExpandButton:v,setShowExpandButton:_,isFullscreen:E,setIsFullscreen:b,showMediaButton:k,setShowMediaButton:V,mediaButtonPosition:W,setMediaButtonPosition:z,isZoomingToHotspot:j,setIsZoomingToHotspot:D,isExpandingToFullView:x,setIsExpandingToFullView:I,components:M,setComponents:F,modeStateManager:O,setModeStateManager:R,debugLevel:ne,setDebugLevel:ee,zoomSpeedMultiplier:ae,setZoomSpeedMultiplier:q,circleMultiplierValue:Q,setCircleMultiplierValue:J,ellipseXValue:se,setEllipseXValue:xe,ellipseYValue:pe,setEllipseYValue:X,gradientSpreadValue:Se,setGradientSpreadValue:Re,offsetXValue:tt,setOffsetXValue:We,offsetYValue:pt,setOffsetYValue:lt,showFloatingPanel:xt,setShowFloatingPanel:st,panelPosition:ot,setPanelPosition:gt,isDragging:mt,setIsDragging:le,dragStart:Oe,setDragStart:g,tapCount:P,setTapCount:L,tapTimeout:Y,setTapTimeout:te,interactionMode:he,setInteractionMode:Z,revealStyle:ye,setRevealStyle:Pe,updateRevealStyle:ut=>{Pe(ut),localStorage.setItem("revealStyle",ut),window.updateRevealStyle&&window.updateRevealStyle(ut)},performanceMetrics:Te,setPerformanceMetrics:de,safariHybridMetrics:Le,setSafariHybridMetrics:T,currentPalette:w,setCurrentPalette:C,currentOverlayType:A,setCurrentOverlayType:U}}const jh=(s,t,e)=>{let i;if(s.coordinates){let b=1/0,k=1/0,V=-1/0,W=-1/0;(j=>{Array.isArray(j[0])&&typeof j[0][0]=="number"?j.forEach(([D,x])=>{b=Math.min(b,D),k=Math.min(k,x),V=Math.max(V,D),W=Math.max(W,x)}):j.forEach(D=>{D.forEach(([x,I])=>{b=Math.min(b,x),k=Math.min(k,I),V=Math.max(V,x),W=Math.max(W,I)})})})(s.coordinates),i={minX:b,minY:k,maxX:V,maxY:W}}else return null;t.world.getItemAt(0).getContentSize();const r=t.viewport.imageToViewportCoordinates(new It.Point(i.minX,i.minY)),o=t.viewport.imageToViewportCoordinates(new It.Point(i.maxX,i.maxY)),a=o.x-r.x,l=o.y-r.y,u=r.x+a/2,h=r.y+l/2,d=t.viewport.getAspectRatio(),f=a/l,m=e?.85:.8;let v,_;f>d?(v=a/m,_=v/d):(_=l/m,v=_*d);const E=new It.Rect(u-v/2,h-_/2,v,_);return console.log("Hotspot zoom calculation:",{hotspotId:s.id,originalBounds:i,viewportCoords:{topLeft:r,bottomRight:o},center:{x:u,y:h},dimensions:{width:v,height:_},aspectRatios:{hotspot:f.toFixed(2),viewport:d.toFixed(2)},paddingFactor:m,zoomBounds:E}),E};function Wh(s,t,e){const{isZoomingToHotspot:i,setIsZoomingToHotspot:n,isExpandingToFullView:r,setIsExpandingToFullView:o,setShowExpandButton:a,zoomSpeedMultiplier:l}=t;return{isHotspotWellFramed:(m,v)=>{if(!s||!v)return!1;const _=s.viewport.getBounds();s.viewport.getZoom();const E=s.viewport.imageToViewportRectangle(v.x,v.y,v.width,v.height),b=_.intersection(E);if(!b)return!1;const k=E.width*E.height,W=b.width*b.height/k,z=E.getCenter(),j=_.getCenter(),D=Math.sqrt(Math.pow(z.x-j.x,2)+Math.pow(z.y-j.y,2)),x=W>.8&&D<.1;return console.log("Well-framed check:",{overlapRatio:W,centerDistance:D,isWellFramed:x}),x},zoomToHotspot:async m=>{var W;if(console.log("🎯 CINEMATIC FIX: zoomToHotspot called",{hotspotId:m.id,isZoomingToHotspot:i(),viewer:!!s}),!s||i()||r()){console.log("zoomToHotspot BLOCKED",{noViewer:!s,isZoomingToHotspot:i(),isExpandingToFullView:r()});return}const v=jh(m,s,He());if(!v)return;console.log("🔧 CINEMATIC FIX: Setting LowZoomOptimizer to cinematic mode"),e().lowZoomOptimizer&&e().lowZoomOptimizer.setCinematicMode(!0);const _=He()?2.8:1.8,E=He()?1.5:_*l(),b=4/l();let k;n(!0),e().overlayManager&&e().overlayManager.startZoomAnimation&&e().overlayManager.startZoomAnimation(),console.log("🎯 CINEMATIC FIX: Starting cinematic zoom to hotspot:",m.id),k=setTimeout(()=>{console.log("🔧 CINEMATIC FIX: Safety timeout - forcing cleanup"),n(!1),e().lowZoomOptimizer&&e().lowZoomOptimizer.setCinematicMode(!1),e().renderer&&e().renderer.resumeUpdates()},E*1e3+500);const V={animationTime:s.animationTime,springStiffness:s.springStiffness};if(e().tileCleanupManager&&e().tileCleanupManager.pauseCleanup(E*1e3+500),s.imageLoader&&s.imageLoader.clear(),e().renderOptimizer&&e().renderOptimizer.startCinematicZoom(),e().performanceMonitor&&He()&&e().performanceMonitor.pauseMonitoring(),e().renderer&&(He()||e().renderer.pauseUpdates(),He()&&e().renderer.hideOverlay()),s.animationTime=E,s.springStiffness=b,s.viewport.centerSpringX.animationTime=E,s.viewport.centerSpringY.animationTime=E,s.viewport.zoomSpring.animationTime=E,s.viewport.centerSpringX.springStiffness=b,s.viewport.centerSpringY.springStiffness=b,s.viewport.zoomSpring.springStiffness=b,s.viewport.applyConstraints(),console.log("🎯 CINEMATIC FIX: Settings applied:",{animTime:E,stiffness:b,actualAnimTime:s.animationTime,actualStiffness:s.springStiffness,zoomSpringTime:s.viewport.zoomSpring.animationTime,expectedDuration:`${E}s`,lowZoomOptimizerDisabled:!((W=e().lowZoomOptimizer)!=null&&W.isActive)}),He()){console.log("QUICK WIN #1: Mobile optimizations with cinematic zoom preserved");try{let z;if(s.viewport.getZoomForBounds)z=s.viewport.getZoomForBounds(v);else{const I=s.viewport.getBounds(),M=I.width/v.width,F=I.height/v.height;z=Math.min(M,F)*s.viewport.getZoom()}const j=v.getCenter(),D=s.viewport.getZoom(),x=5;if(console.log("QUICK WIN #1: Mobile zoom calculation",{currentZoom:D,targetZoom:z,center:j,willUseSteps:z/D>x}),z/D>x){console.log("QUICK WIN #1: Large zoom jump - using stepped approach with cinematic timing");const I=D*x,M=new It.Point(j.x,j.y);s.viewport.panTo(M),s.viewport.zoomTo(I),setTimeout(()=>{s.viewport.panTo(M),s.viewport.zoomTo(z)},E*500)}else{const I=new It.Point(j.x,j.y);s.viewport.panTo(I),s.viewport.zoomTo(z)}}catch(z){console.error("QUICK WIN #1: Mobile animation error, falling back to fitBounds:",z),s.viewport.fitBounds(v,!1)}}else{const z=v.getCenter(),j=new It.Point(z.x,z.y),D=s.viewport.getBounds(),x=D.width/v.width,I=D.height/v.height,M=Math.min(x,I)*s.viewport.getZoom();s.viewport.panTo(j),s.viewport.zoomTo(M)}setTimeout(()=>{a(!0),console.log("QUICK WIN #1: Full View button visible after cinematic zoom")},E*1e3+200),e().viewportManager&&e().viewportManager.setCacheEnabled(!1),console.log("QUICK WIN #1: Cinematic zoom animation started",{currentZoom:s.viewport.getZoom(),targetBounds:v,animationTime:s.animationTime,springStiffness:s.springStiffness,isAnimating:s.isAnimating(),platform:He()?"mobile":"desktop"}),setTimeout(()=>{e().viewportManager&&e().viewportManager.setCacheEnabled(!0)},E*1e3),setTimeout(()=>{clearTimeout(k),console.log("🔧 CINEMATIC FIX: Animation complete - restoring settings"),n(!1),s.animationTime=V.animationTime,s.springStiffness=V.springStiffness,s.viewport.centerSpringX.animationTime=V.animationTime,s.viewport.centerSpringY.animationTime=V.animationTime,s.viewport.zoomSpring.animationTime=V.animationTime,s.viewport.centerSpringX.springStiffness=V.springStiffness,s.viewport.centerSpringY.springStiffness=V.springStiffness,s.viewport.zoomSpring.springStiffness=V.springStiffness,console.log("🔧 CINEMATIC FIX: Exiting LowZoomOptimizer cinematic mode"),e().lowZoomOptimizer&&e().lowZoomOptimizer.setCinematicMode(!1),e().renderOptimizer&&e().renderOptimizer.endCinematicZoom(),e().performanceMonitor&&He()&&e().performanceMonitor.resumeMonitoring(),e().overlayManager&&e().overlayManager.endZoomAnimation&&e().overlayManager.endZoomAnimation()},E*1e3+1e3),setTimeout(()=>{e().renderer&&(console.log("Animation complete - restoring hotspots"),He()?(e().renderer.showOverlay(),setTimeout(()=>{"requestIdleCallback"in window?requestIdleCallback(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibilityLazy()},{timeout:1e3}):setTimeout(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibilityLazy()},300)},200)):(e().renderer.resumeUpdates(),setTimeout(()=>{e().renderer.updateVisibility(),s.forceRedraw()},100)))},E*1e3+300)},cleanupExpandAnimation:()=>{window.expandToFullViewTimeouts&&(window.expandToFullViewTimeouts.forEach(m=>clearTimeout(m)),window.expandToFullViewTimeouts=[])},expandToFullView:()=>{if(console.log("expandToFullView START",{isExpandingToFullView:r(),isZoomingToHotspot:i()}),window.expandToFullViewTimeouts||(window.expandToFullViewTimeouts=[]),!s||r())return;i()&&(console.log("Force resetting isZoomingToHotspot in expandToFullView"),n(!1),e().renderOptimizer&&e().renderOptimizer.endCinematicZoom(),e().renderer&&e().renderer.resumeUpdates()),a(!1),o(!0);const m=s.world.getItemAt(0);if(!m){o(!1);return}const v=m.getBounds(),E=s.viewport.getBounds().getCenter(),b=v.getCenter(),k=Math.sqrt(Math.pow(b.x-E.x,2)+Math.pow(b.y-E.y,2)),V=Math.min(1.5,Math.max(1.2,k*.4+1)),W=Math.max(6,10-k*1.5),z=setTimeout(()=>{console.log("Safety timeout: forcing isExpandingToFullView to false (was:",r(),")"),o(!1)},V*1e3+500);window.expandToFullViewTimeouts.push(z);const j={animationTime:s.animationTime,springStiffness:s.springStiffness};if(console.log("expandToFullView animation params:",{distance:k,animTime:V,stiffness:W,currentAnimationTime:s.animationTime,currentStiffness:s.springStiffness}),e().tileCleanupManager&&e().tileCleanupManager.pauseCleanup(V*1e3+500),s.imageLoader&&s.imageLoader.clear(),e().renderOptimizer&&e().renderOptimizer.startCinematicZoom(),e().renderer&&(e().renderer.pauseUpdates(),He()&&e().renderer.hideOverlay()),s.animationTime=V,s.springStiffness=W,s.viewport.centerSpringX.animationTime=V,s.viewport.centerSpringY.animationTime=V,s.viewport.zoomSpring.animationTime=V,s.viewport.centerSpringX.springStiffness=W,s.viewport.centerSpringY.springStiffness=W,s.viewport.zoomSpring.springStiffness=W*.85,s.viewport.centerSpringX.resetTo(s.viewport.centerSpringX.current.value),s.viewport.centerSpringY.resetTo(s.viewport.centerSpringY.current.value),s.viewport.zoomSpring.resetTo(s.viewport.zoomSpring.current.value),console.log("expandToFullView executing fitBounds"),console.log("Springs after reset:",{centerXTime:s.viewport.centerSpringX.animationTime,zoomTime:s.viewport.zoomSpring.animationTime}),He())s.viewport.fitBounds(v,!1);else{const M=v.x+v.width/2,F=v.y+v.height/2,O=new It.Rect(M-v.width*1.01/2,F-v.height*1.01/2,v.width*1.01,v.height*1.01);s.viewport.fitBounds(O,!1)}console.log("expandToFullView animation started",{actualAnimTime:s.animationTime,actualStiffness:s.springStiffness,timestamp:Date.now()});const D=setTimeout(()=>{clearTimeout(z),o(!1),s.animationTime=j.animationTime,s.springStiffness=j.springStiffness,s.viewport.centerSpringX.animationTime=j.animationTime,s.viewport.centerSpringY.animationTime=j.animationTime,s.viewport.zoomSpring.animationTime=j.animationTime,s.viewport.centerSpringX.springStiffness=j.springStiffness,s.viewport.centerSpringY.springStiffness=j.springStiffness,s.viewport.zoomSpring.springStiffness=j.springStiffness,e().renderOptimizer&&e().renderOptimizer.endCinematicZoom()},V*1e3+200);window.expandToFullViewTimeouts.push(D);const x=setTimeout(()=>{e().renderer&&(He()&&e().renderer.showOverlay(),setTimeout(()=>{e().renderer.resumeUpdates(),e().renderer.updateVisibility(),s.forceRedraw()},200))},V*1e3+100);window.expandToFullViewTimeouts.push(x)}}}var Gh=B('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3l8 5-8 5V3z"strokeLinejoin=round fill=rgba(255,255,255,0.9) stroke=none>'),qh=B('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M5 3v10M11 3v10"strokeLinecap=round>'),Zh=B('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 7V5L6 8l3 3V9c2 0 3.5 1.5 3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),Xh=B('<svg width=18 height=18 viewBox="0 0 18 18"fill=none stroke=currentColor strokeWidth=1><path d="M9 16A7 7 0 109 2a7 7 0 000 14z"opacity=0.3></path><path d="M9 9V5l3 3-3 3v-2c-2 0-3.5 1.5-3.5 3.5"strokeLinecap=round strokeLinejoin=round>'),Kh=B('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11.5 5.5c.8.7.8 2.3 0 3"strokeLinecap=round opacity=0.7>'),Yh=B('<svg width=16 height=16 viewBox="0 0 16 16"fill=none stroke=currentColor strokeWidth=1><path d="M3 6v4h2.5L9 13V3L5.5 6H3z"strokeLinejoin=round></path><path d="M11 6l3 3m0-3l-3 3"strokeLinecap=round opacity=0.7>'),Qh=B('<svg width=12 height=12 viewBox="0 0 12 12"fill=none stroke=currentColor strokeWidth=1><path d="M2 4.5h8M4.5 7.5l2 2 2-2"strokeLinecap=round strokeLinejoin=round>'),Jh=B("<div class=audio-player-minimized><button></button><div class=track-name-mini-container><span class=track-name-mini>"),$h=B('<button class="btn-skip btn-skip-back"title="Back 15s (Shift+←)">'),ed=B('<button class="btn-skip btn-skip-forward"title="Forward 15s (Shift+→)">'),td=B("<input type=range class=volume-slider min=0 max=100>"),id=B("<div class=keyboard-hints><span>Space: Play/Pause</span><span>Shift+←→: Skip</span><span>M: Mute</span><span>Esc: Minimize"),nd=B('<div class=audio-player-expanded><div class=player-header><h4 class=track-name></h4><button class=btn-minimize title="Minimize (Esc)"></button></div><div class=progress-section><span class=time-current></span><div class=progress-bar><div class=progress-track><div class=progress-fill></div><div class=progress-thumb></div></div></div><span class=time-duration></span></div><div class=controls-section><div class=controls-left><button></button></div><div class=controls-right><button class=btn-mute>'),rd=B("<div>");const Na=()=>Gh(),Ba=()=>qh(),sd=()=>Zh(),od=()=>Xh(),ad=()=>Kh(),ld=()=>Yh(),ud=()=>Qh();function cd(s){const{audioEngine:t,currentHotspot:e}=s,[i,n]=oe(!0),[r,o]=oe(!1),[a,l]=oe(0),[u,h]=oe(0),[d,f]=oe(0),[m,v]=oe(80),[_,E]=oe(!1),[b,k]=oe(!1),[V,W]=oe(!0),[z,j]=oe(!1);Ui(()=>{e()&&r()&&i()&&(j(!0),setTimeout(()=>j(!1),500))});const D=()=>window.innerWidth<=768;Ui(()=>{t&&(t.onProgress=Q=>{b()||(l(Q.percent),h(Q.current),f(Q.duration))},t.onPlaybackStart=()=>{o(!0),i()&&V()?(n(!1),W(!1)):i()||W(!1)},t.onPlaybackEnd=()=>{o(!1),l(0),h(0)},t.setVolume(m()/100))}),Ui(()=>{const Q=J=>{if(e()&&J.target.tagName!=="INPUT")switch(J.key){case" ":i()||(J.preventDefault(),x());break;case"ArrowLeft":J.shiftKey&&!i()&&(J.preventDefault(),M());break;case"ArrowRight":J.shiftKey&&!i()&&(J.preventDefault(),I());break;case"m":case"M":i()||F();break;case"Escape":i()||n(!0);break}};window.addEventListener("keydown",Q),Cn(()=>window.removeEventListener("keydown",Q))}),Ui(()=>{if(t){const Q=t.getState();o(Q.isPlaying),E(Q.isMuted)}});const x=()=>{!t||!e()||(r()?t.pause():t.resume())},I=()=>{t&&t.skip(15)},M=()=>{t&&t.skip(-15)},F=()=>{if(!t)return;const Q=t.toggleMute();E(Q)},O=Q=>{if(!t)return;const J=Q.currentTarget.getBoundingClientRect(),se=(Q.clientX-J.left)/J.width*100;t.seekToPercent(se),l(se)},R=Q=>{if(!b())return;const J=Q.currentTarget.getBoundingClientRect(),se=Math.max(0,Math.min(100,(Q.clientX-J.left)/J.width*100));l(se)},ne=()=>{b()&&t&&(t.seekToPercent(a()),k(!1))},ee=Q=>{const J=parseInt(Q.target.value);v(J),t&&(t.setVolume(J/100),J>0&&_()&&(t.toggleMute(),E(!1)))},ae=Q=>{if(!Q||isNaN(Q))return"0:00";const J=Math.floor(Q/60),se=Math.floor(Q%60);return`${J}:${se.toString().padStart(2,"0")}`},q=()=>{const Q=e();return Q?Q.narrationTitle||`Hotspot ${Q.id}`:""};return ge(ke,{get when(){return e()},get children(){var Q=rd();return Q.addEventListener("mouseleave",ne),Q.$$mouseup=ne,ie(Q,ge(ke,{get when(){return i()},get children(){var J=Jh(),se=J.firstChild,xe=se.nextSibling,pe=xe.firstChild;return se.$$click=()=>{r()?x():n(!1)},ie(se,(()=>{var X=Rt(()=>!!r());return()=>X()?ge(Ba,{}):ge(Na,{})})()),ie(pe,q),Ve(X=>{var Se=`btn-play-mini ${r()?"playing":""} ${z()?"changing":""}`,Re=r()?"Pause":"Play";return Se!==X.e&&Ze(se,X.e=Se),Re!==X.t&&ni(se,"title",X.t=Re),X},{e:void 0,t:void 0}),J}}),null),ie(Q,ge(ke,{get when(){return!i()},get children(){var J=nd(),se=J.firstChild,xe=se.firstChild,pe=xe.nextSibling,X=se.nextSibling,Se=X.firstChild,Re=Se.nextSibling,tt=Re.firstChild,We=tt.firstChild,pt=We.nextSibling,lt=Re.nextSibling,xt=X.nextSibling,st=xt.firstChild,ot=st.firstChild,gt=st.nextSibling,mt=gt.firstChild;return ie(xe,q),pe.$$click=()=>n(!0),ie(pe,ge(ud,{})),ie(Se,()=>ae(u())),Re.$$mousemove=R,Re.$$mousedown=()=>k(!0),Re.$$click=O,ie(lt,()=>ae(d())),ie(st,ge(ke,{get when(){return!D()},get children(){var le=$h();return le.$$click=M,ie(le,ge(sd,{})),le}}),ot),ot.$$click=x,ie(ot,ge(ke,{get when(){return!r()},get children(){return ge(Na,{})}}),null),ie(ot,ge(ke,{get when(){return r()},get children(){return ge(Ba,{})}}),null),ie(st,ge(ke,{get when(){return!D()},get children(){var le=ed();return le.$$click=I,ie(le,ge(od,{})),le}}),null),mt.$$click=F,ie(mt,ge(ke,{get when(){return Rt(()=>!_())()&&m()>0},get children(){return ge(ad,{})}}),null),ie(mt,ge(ke,{get when(){return _()||m()===0},get children(){return ge(ld,{})}}),null),ie(gt,ge(ke,{get when(){return!D()},get children(){var le=td();return le.$$input=ee,Ve(()=>ni(le,"title",`Volume: ${m()}%`)),Ve(()=>le.value=m()),le}}),null),ie(J,ge(ke,{when:!1,get children(){return id()}}),null),Ve(le=>{var Oe=`${a()}%`,g=`${a()}%`,P=`btn-play ${r()?"playing":""}`,L=r()?"Pause (Space)":"Play (Space)",Y=_()?"Unmute (M)":"Mute (M)";return Oe!==le.e&&((le.e=Oe)!=null?We.style.setProperty("width",Oe):We.style.removeProperty("width")),g!==le.t&&((le.t=g)!=null?pt.style.setProperty("left",g):pt.style.removeProperty("left")),P!==le.a&&Ze(ot,le.a=P),L!==le.o&&ni(ot,"title",le.o=L),Y!==le.i&&ni(mt,"title",le.i=Y),le},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),J}}),null),Ve(()=>Ze(Q,`audio-player ${i()?"minimized":""} ${D()?"mobile":"desktop"}`)),Q}})}Ji(["mouseup","click","mousedown","mousemove","input"]);var hd=B('<div><button><svg class=media-button-icon width=16 height=16 viewBox="0 0 16 16"fill=none><path d="M2 4C2 2.89543 2.89543 2 4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4Z"stroke=currentColor stroke-width=1.5></path><circle cx=8 cy=8 r=2.5 stroke=currentColor stroke-width=1.5></circle><path d="M2 11L5 8L7 10L10 7L14 11"stroke=currentColor stroke-width=1.5 stroke-linecap=round stroke-linejoin=round></path></svg><span class=media-button-text>');function dd(s){const{hotspotId:t,onClick:e,isVisible:i=!0,position:n={x:0,y:0},isMobile:r=!1}=s,[o,a]=oe(!1),[l,u]=oe(!1),h=()=>"View Image",d=f=>{f.stopPropagation(),u(!0),e&&e(t),setTimeout(()=>u(!1),300)};return ge(ke,{when:i,get children(){var f=hd(),m=f.firstChild,v=m.firstChild,_=v.nextSibling;return Ze(f,`media-button-container ${r?"mobile":"desktop"}`),m.addEventListener("mouseleave",()=>a(!1)),m.addEventListener("mouseenter",()=>a(!0)),m.$$click=d,ie(_,h),Ve(E=>{var b=`media-button ${o()?"hovered":""} ${l()?"clicked":""}`,k=h();return b!==E.e&&Ze(m,E.e=b),k!==E.t&&ni(m,"title",E.t=k),E},{e:void 0,t:void 0}),f}})}Ji(["click"]);var fd=B("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>Hovered</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Selected</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Type</span><span class=debug-stat-value>"),pd=B('<div class=debug-stat-row style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);"><span class=debug-stat-label style=color:#00ffff;>Safari Hybrid</span><span class=debug-stat-value style=color:#00ffff;>Active'),gd=B("<div class=debug-stat-row><span class=debug-stat-label>Render Time</span><span class=debug-stat-value>ms"),md=B("<div class=debug-stat-row><span class=debug-stat-label>Visible/Total</span><span class=debug-stat-value>/"),vd=B("<div class=debug-stats-classic><div class=debug-stat-row><span class=debug-stat-label>FPS</span><span class=debug-stat-value><span style=opacity:0.7;font-size:10px> (avg: <!>)</span></span></div><div class=debug-stat-row><span class=debug-stat-label>Status</span><span class=debug-stat-value></span></div><div class=debug-stat-row><span class=debug-stat-label>Memory</span><span class=debug-stat-value>MB</span></div><div class=debug-stat-row><span class=debug-stat-label>Frame Time</span><span class=debug-stat-value>ms</span></div><div class=debug-stat-row><span class=debug-stat-label>Zoom</span><span class=debug-stat-value>x"),yd=B("<div class=debug-control><label class=debug-control-label>Animation Speed<span class=debug-control-value>x</span></label><input type=range class=debug-slider min=0.5 max=2.5 step=0.1><p class=debug-control-description>How fast the artwork zooms when you click on elements"),wd=B('<div class=debug-control><label class=debug-control-label>Color Theme<span class=debug-help-icon title="Changes the highlight colors">?</span></label><div class=debug-toggle-group><button type=button>Cyan Tech</button><button type=button>Golden Magic</button><button type=button>Blue Moon</button></div><div class=debug-toggle-group style=margin-top:8px;><button type=button>Pure White</button><button type=button>Soft White</button><button type=button>Dark Mode'),_d=B("<div class=debug-control><label class=debug-control-label>Interaction Style</label><div class=debug-toggle-group><div>Instant Click</div><div>Hold & Release</div></div><p class=debug-control-description>"),Td=B("<div class=debug-control><label class=debug-control-label>Highlight Style</label><div class=debug-toggle-group><div>Sharp Outline</div><div>Soft Glow</div></div><p class=debug-control-description>"),Ed=B("<div class=debug-control><label class=debug-control-label>Activation</label><p class=debug-control-description>Press <strong>H</strong> key (desktop) or <strong>triple-tap</strong> (mobile)"),xd=B("<div class=debug-control><label class=debug-control-label>Visual Style</label><div class=debug-toggle-group><button type=button>Black Outline</button><button type=button>White Pulse"),bd=B("<span class=debug-mobile-compact-fps> FPS"),Sd=B("<div class=debug-mobile-compact><div class=debug-mobile-compact-content><span class=debug-mobile-compact-icon>⚙️</span><span class=debug-mobile-compact-label>Debug"),Pd=B("<div><div><div class=debug-mobile-sheet-handle><div class=debug-mobile-sheet-handle-bar></div></div><div class=debug-mobile-sheet-header><h3 class=debug-mobile-sheet-title><span>⚙️</span>Artwork Controls</h3></div><div class=debug-mobile-tabs></div><div class=debug-mobile-content>"),Cd=B("<button><span class=debug-mobile-tab-icon></span><span class=debug-mobile-tab-label>"),Rd=B("<span style=margin-left:8px;>Artwork Controls"),Id=B('<button title="Minimize panel"><svg viewBox="0 0 20 20"><rect x=11 y=15 width=14 height=2>'),Ad=B("<div class=debug-panel><div class=debug-panel-header><h3 class=debug-panel-title style=margin:0;><span>⚙️"),Dd=B("<div><div class=debug-section-header><div class=debug-section-title><span class=debug-section-icon></span><span></span></div><span class=debug-section-chevron>▼</span></div><div class=debug-section-content><div class=debug-section-body>");function Md(s){const[t,e]=oe(!1),[i,n]=oe({artwork:!0,performance:!1,visual:!1,navigation:!1,overlay:!1,reveal:!1}),[r,o]=oe({x:null,y:null}),[a,l]=oe(!1),[u,h]=oe({x:0,y:0,elementX:0,elementY:0}),[d,f]=oe(!1),[m,v]=oe(0),[_,E]=oe(!1),b=()=>{E(!0),setTimeout(()=>{f(!1),E(!1)},300)};let k,V=0,W=0;const z=R=>{V=R.touches[0].clientY,W=0},j=R=>{if(!d()||!k)return;const ee=R.touches[0].clientY-V;ee>0&&(W=ee,k.style.transform=`translateY(${ee}px)`)},D=()=>{k&&(W>100&&b(),k.style.transform="",W=0)},x=[{id:"artwork",icon:"🔍",title:"Active Element",content:()=>(()=>{var R=fd(),ne=R.firstChild,ee=ne.firstChild,ae=ee.nextSibling,q=ne.nextSibling,Q=q.firstChild,J=Q.nextSibling,se=q.nextSibling,xe=se.firstChild,pe=xe.nextSibling;return ie(ae,()=>{var X;return((X=s.hoveredHotspot())==null?void 0:X.id)||"none"}),ie(J,()=>{var X;return((X=s.selectedHotspot())==null?void 0:X.id)||"none"}),ie(pe,()=>{var X,Se;return((X=s.hoveredHotspot())==null?void 0:X.type)||((Se=s.selectedHotspot())==null?void 0:Se.type)||"none"}),R})()},{id:"performance",icon:"📊",title:"Performance",content:()=>(()=>{var R=vd(),ne=R.firstChild,ee=ne.firstChild,ae=ee.nextSibling,q=ae.firstChild,Q=q.firstChild,J=Q.nextSibling;J.nextSibling;var se=ne.nextSibling,xe=se.firstChild,pe=xe.nextSibling,X=se.nextSibling,Se=X.firstChild,Re=Se.nextSibling,tt=Re.firstChild,We=X.nextSibling,pt=We.firstChild,lt=pt.nextSibling,xt=lt.firstChild,st=We.nextSibling,ot=st.firstChild,gt=ot.nextSibling,mt=gt.firstChild;return ie(ae,()=>{var le,Oe;return((Oe=(le=s.performanceMetrics)==null?void 0:le.currentFPS)==null?void 0:Oe.toFixed(0))||"60"},q),ie(q,()=>{var le;return((le=s.performanceMetrics)==null?void 0:le.averageFPS)||"60"},J),ie(pe,()=>{var le;return((le=s.performanceMetrics)==null?void 0:le.performanceLevel)||"excellent"}),ie(Re,()=>{var le,Oe;return((Oe=(le=s.performanceMetrics)==null?void 0:le.memoryUsage)==null?void 0:Oe.toFixed(0))||"0"},tt),ie(lt,()=>{var le;return((le=s.performanceMetrics)==null?void 0:le.frameTime)||"16.67"},xt),ie(gt,()=>{var le;return((le=s.performanceMetrics)==null?void 0:le.zoomLevel)||"1.00"},mt),ie(R,ge(ke,{get when(){return s.safariHybridMetrics},get children(){return[pd(),(()=>{var le=gd(),Oe=le.firstChild,g=Oe.nextSibling,P=g.firstChild;return ie(g,()=>{var L;return((L=s.safariHybridMetrics.renderTime)==null?void 0:L.toFixed(2))||"0.00"},P),Ve(L=>(L=s.safariHybridMetrics.renderTime>16.67?"#FF9800":"#4CAF50")!=null?g.style.setProperty("color",L):g.style.removeProperty("color")),le})(),(()=>{var le=md(),Oe=le.firstChild,g=Oe.nextSibling,P=g.firstChild;return ie(g,()=>s.safariHybridMetrics.visibleHotspots||"0",P),ie(g,()=>s.safariHybridMetrics.hotspotCount||"0",null),le})()]}}),null),Ve(le=>{var Y,te,he,Z,ye;var Oe=(((Y=s.performanceMetrics)==null?void 0:Y.currentFPS)||60)<55?"#FF9800":"#4CAF50",g={excellent:"#4CAF50",good:"#8BC34A",acceptable:"#FFC107",poor:"#FF9800",critical:"#F44336"}[((te=s.performanceMetrics)==null?void 0:te.performanceLevel)||"excellent"],P=(((he=s.performanceMetrics)==null?void 0:he.memoryUsage)||0)>250?"#FF9800":"#4CAF50",L=parseFloat(((Z=s.performanceMetrics)==null?void 0:Z.frameTime)||16.67)>33?"#F44336":parseFloat(((ye=s.performanceMetrics)==null?void 0:ye.frameTime)||16.67)>20?"#FF9800":"#4CAF50";return Oe!==le.e&&((le.e=Oe)!=null?ae.style.setProperty("color",Oe):ae.style.removeProperty("color")),g!==le.t&&((le.t=g)!=null?pe.style.setProperty("color",g):pe.style.removeProperty("color")),P!==le.a&&((le.a=P)!=null?Re.style.setProperty("color",P):Re.style.removeProperty("color")),L!==le.o&&((le.o=L)!=null?lt.style.setProperty("color",L):lt.style.removeProperty("color")),le},{e:void 0,t:void 0,a:void 0,o:void 0}),R})()},{id:"visual",icon:"🎨",title:"Visual Settings",content:()=>[(()=>{var R=yd(),ne=R.firstChild,ee=ne.firstChild,ae=ee.nextSibling,q=ae.firstChild,Q=ne.nextSibling;return ie(ae,()=>s.zoomSpeed().toFixed(1),q),Q.$$input=J=>s.setZoomSpeed(parseFloat(J.target.value)),Ve(()=>Q.value=s.zoomSpeed()),R})(),(()=>{var R=wd(),ne=R.firstChild,ee=ne.nextSibling,ae=ee.firstChild,q=ae.nextSibling,Q=q.nextSibling,J=ee.nextSibling,se=J.firstChild,xe=se.nextSibling,pe=xe.nextSibling;return ae.$$click=()=>{console.log("Setting palette to tech"),s.setPalette("tech")},q.$$click=()=>{console.log("Setting palette to enchantedJournal"),s.setPalette("enchantedJournal")},Q.$$click=()=>{console.log("Setting palette to moonlitManuscript"),s.setPalette("moonlitManuscript")},se.$$click=()=>{console.log("Setting palette to pureWhiteHigh"),s.setPalette("pureWhiteHigh")},xe.$$click=()=>{console.log("Setting palette to pureWhiteBalanced"),s.setPalette("pureWhiteBalanced")},pe.$$click=()=>{console.log("Setting palette to blackOnBlack"),s.setPalette("blackOnBlack")},Ve(X=>{var Se=`debug-toggle-option ${s.currentPalette()==="tech"?"active":""}`,Re=`debug-toggle-option ${s.currentPalette()==="enchantedJournal"?"active":""}`,tt=`debug-toggle-option ${s.currentPalette()==="moonlitManuscript"?"active":""}`,We=`debug-toggle-option ${s.currentPalette()==="pureWhiteHigh"?"active":""}`,pt=`debug-toggle-option ${s.currentPalette()==="pureWhiteBalanced"?"active":""}`,lt=`debug-toggle-option ${s.currentPalette()==="blackOnBlack"?"active":""}`;return Se!==X.e&&Ze(ae,X.e=Se),Re!==X.t&&Ze(q,X.t=Re),tt!==X.a&&Ze(Q,X.a=tt),We!==X.o&&Ze(se,X.o=We),pt!==X.i&&Ze(xe,X.i=pt),lt!==X.n&&Ze(pe,X.n=lt),X},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),R})()]},{id:"navigation",icon:"🧭",title:"Click Behavior",content:()=>(()=>{var R=_d(),ne=R.firstChild,ee=ne.nextSibling,ae=ee.firstChild,q=ae.nextSibling,Q=ee.nextSibling;return ae.$$click=()=>s.setInteractionMode("direct"),q.$$click=()=>s.setInteractionMode("temporal"),ie(Q,()=>s.interactionMode()==="direct"?"Click/tap to immediately select and zoom":"Hold down to preview, release to activate"),Ve(J=>{var se=`debug-toggle-option ${s.interactionMode()==="direct"?"active":""}`,xe=`debug-toggle-option ${s.interactionMode()==="temporal"?"active":""}`;return se!==J.e&&Ze(ae,J.e=se),xe!==J.t&&Ze(q,J.t=xe),J},{e:void 0,t:void 0}),R})()},{id:"overlay",icon:"🎭",title:"Highlighting System",content:()=>(console.log("Overlay section render - overlayType:",s.overlayType),(()=>{var R=Td(),ne=R.firstChild,ee=ne.nextSibling,ae=ee.firstChild,q=ae.nextSibling,Q=ee.nextSibling;return ae.$$click=()=>s.toggleOverlay("css"),q.$$click=()=>s.toggleOverlay("safari"),ie(Q,()=>{const J=s.overlayType;return console.log("Description render - currentType:",J),J==="css"?"Precise borders that follow exact shapes (Chrome, Firefox)":"Universal glow effect that works on all devices and browsers"}),Ve(J=>{var se=`debug-toggle-option ${s.overlayType==="css"?"active":""}`,xe=`debug-toggle-option ${s.overlayType==="safari"?"active":""}`;return se!==J.e&&Ze(ae,J.e=se),xe!==J.t&&Ze(q,J.t=xe),J},{e:void 0,t:void 0}),R})())},{id:"reveal",icon:"👁️",title:"Hotspot Discovery",content:()=>[Ed(),(()=>{var R=xd(),ne=R.firstChild,ee=ne.nextSibling,ae=ee.firstChild,q=ae.nextSibling;return ae.$$click=()=>s.setRevealStyle("invert"),q.$$click=()=>s.setRevealStyle("neon"),Ve(Q=>{var J=`debug-toggle-option ${s.revealStyle()==="invert"?"active":""}`,se=`debug-toggle-option ${s.revealStyle()==="neon"?"active":""}`;return J!==Q.e&&Ze(ae,Q.e=J),se!==Q.t&&Ze(q,Q.t=se),Q},{e:void 0,t:void 0}),R})()]}];if(He()){const R=[{id:"visual",label:"Visual",icon:"🎨"},{id:"behavior",label:"Behavior",icon:"🎯"},{id:"highlighting",label:"Highlighting",icon:"🎭"},{id:"reveal",label:"Reveal",icon:"👁️"}];return[(()=>{var ne=Sd(),ee=ne.firstChild,ae=ee.firstChild;return ae.nextSibling,ne.$$click=()=>f(!0),ne.style.setProperty("position","fixed"),ne.style.setProperty("bottom","20px"),ne.style.setProperty("left","50%"),ne.style.setProperty("transform","translateX(-50%)"),ne.style.setProperty("zIndex","1000"),ie(ee,ge(ke,{get when(){var q;return(q=s.performanceMetrics)==null?void 0:q.currentFPS},get children(){var q=bd(),Q=q.firstChild;return ie(q,()=>{var J,se;return(se=(J=s.performanceMetrics)==null?void 0:J.currentFPS)==null?void 0:se.toFixed(0)},Q),Ve(J=>{var se;return(J=(((se=s.performanceMetrics)==null?void 0:se.currentFPS)||60)<45?"#FF9800":"#4CAF50")!=null?q.style.setProperty("color",J):q.style.removeProperty("color")}),q}}),null),Ve(q=>(q=d()?"none":"flex")!=null?ne.style.setProperty("display",q):ne.style.removeProperty("display")),ne})(),ge(ke,{get when(){return d()},get children(){var ne=Pd(),ee=ne.firstChild,ae=ee.firstChild,q=ae.nextSibling,Q=q.firstChild,J=q.nextSibling,se=J.nextSibling;ne.$$click=pe=>{pe.target===pe.currentTarget&&b()},ee.$$pointerdown=pe=>pe.stopPropagation(),ee.$$click=pe=>pe.stopPropagation(),ee.$$touchend=D,ee.$$touchmove=j,ee.$$touchstart=z;var xe=k;return typeof xe=="function"?cu(xe,ee):k=ee,ee.style.setProperty("position","fixed"),ee.style.setProperty("bottom","0"),ee.style.setProperty("left","0"),ee.style.setProperty("right","0"),ee.style.setProperty("transform","translateY(0)"),ee.style.setProperty("transition","transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"),ee.style.setProperty("willChange","transform"),ee.style.setProperty("minHeight","75vh"),ee.style.setProperty("height","80vh"),ee.style.setProperty("display","flex"),ee.style.setProperty("flexDirection","column"),ae.style.setProperty("padding","8px"),q.style.setProperty("padding","12px 20px"),Q.style.setProperty("fontSize","14px"),Q.style.setProperty("margin","0"),ie(J,ge(Is,{each:R,children:(pe,X)=>(()=>{var Se=Cd(),Re=Se.firstChild,tt=Re.nextSibling;return Se.$$click=()=>v(X()),ie(Re,()=>pe.icon),ie(tt,()=>pe.label),Ve(()=>Ze(Se,`debug-mobile-tab ${m()===X()?"active":""}`)),Se})()})),se.style.setProperty("flex","1"),se.style.setProperty("overflowY","auto"),se.style.setProperty("WebkitOverflowScrolling","touch"),se.style.setProperty("padding","32px 24px 40px"),se.style.setProperty("minHeight","300px"),ie(se,ge(Dh,{get children(){return[ge(ar,{get when(){return m()===0},get children(){return[Rt(()=>x[2].content())," "]}}),ge(ar,{get when(){return m()===1},get children(){return[Rt(()=>x[3].content())," "]}}),ge(ar,{get when(){return m()===2},get children(){return[Rt(()=>x[4].content())," "]}}),ge(ar,{get when(){return m()===3},get children(){return[Rt(()=>x[5].content())," "]}})]}})),Ve(pe=>{var X=`debug-mobile-backdrop ${_()?"closing":""}`,Se=`debug-mobile-sheet ${_()?"closing":"expanded"}`;return X!==pe.e&&Ze(ne,pe.e=X),Se!==pe.t&&Ze(ee,pe.t=Se),pe},{e:void 0,t:void 0}),ne}})]}const I=R=>{if(!R.target.closest(".debug-panel-header")||t())return;R.preventDefault(),l(!0);const ee=R.currentTarget.getBoundingClientRect();h({x:R.clientX,y:R.clientY,elementX:r().x!==null?r().x:ee.left,elementY:r().y!==null?r().y:ee.top})},M=R=>{if(!a())return;const ne=R.clientX-u().x,ee=R.clientY-u().y;o({x:u().elementX+ne,y:u().elementY+ee})},F=()=>{l(!1)};to(()=>{document.addEventListener("mousemove",M),document.addEventListener("mouseup",F)}),Cn(()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",F)});const O=R=>{n(ne=>({...ne,[R]:!ne[R]}))};return(()=>{var R=Ad(),ne=R.firstChild,ee=ne.firstChild,ae=ee.firstChild;return R.addEventListener("mouseleave",q=>{t()&&(q.currentTarget.style.background="",q.currentTarget.style.borderColor="")}),R.addEventListener("mouseenter",q=>{t()&&(q.currentTarget.style.background="rgba(30, 30, 30, 0.98)",q.currentTarget.style.borderColor="rgba(255,255,255,0.2)")}),R.$$mousedown=I,ne.$$click=()=>{t()&&e(!1)},ae.style.setProperty("display","inline-block"),ae.style.setProperty("transition","transform 0.3s"),ie(ee,ge(ke,{get when(){return!t()},get children(){return Rd()}}),null),ie(ne,ge(ke,{get when(){return!t()},get children(){var q=Id(),Q=q.firstChild;return q.addEventListener("mouseleave",J=>{J.currentTarget.style.background="rgba(255,255,255,0.08)",J.currentTarget.style.borderColor="rgba(255,255,255,0.12)",J.currentTarget.style.color="rgba(255,255,255,0.5)"}),q.addEventListener("mouseenter",J=>{J.currentTarget.style.background="rgba(255,255,255,0.12)",J.currentTarget.style.borderColor="rgba(255,255,255,0.2)",J.currentTarget.style.color="rgba(255,255,255,0.8)"}),q.$$click=J=>{J.stopPropagation(),e(!t())},q.style.setProperty("position","absolute"),q.style.setProperty("top","12px"),q.style.setProperty("right","12px"),q.style.setProperty("background","rgba(255,255,255,0.08)"),q.style.setProperty("border","1px solid rgba(255,255,255,0.12)"),q.style.setProperty("color","rgba(255,255,255,0.5)"),q.style.setProperty("fontSize","14px"),q.style.setProperty("lineHeight","1"),q.style.setProperty("cursor","pointer"),q.style.setProperty("padding","0"),q.style.setProperty("width","28px"),q.style.setProperty("height","28px"),q.style.setProperty("display","flex"),q.style.setProperty("alignItems","center"),q.style.setProperty("justifyContent","center"),q.style.setProperty("borderRadius","8px"),q.style.setProperty("transition","all 0.2s"),Q.style.setProperty("width","16px"),Q.style.setProperty("height","16px"),Q.style.setProperty("fill","currentColor"),q}}),null),ie(R,ge(ke,{get when(){return!t()},get children(){return ge(Is,{each:x,children:q=>(()=>{var Q=Dd(),J=Q.firstChild,se=J.firstChild,xe=se.firstChild,pe=xe.nextSibling,X=J.nextSibling,Se=X.firstChild;return J.$$click=()=>O(q.id),ie(xe,()=>q.icon),ie(pe,()=>q.title),ie(Se,()=>q.content()),Ve(()=>Ze(Q,`debug-section ${i()[q.id]?"expanded":""}`)),Q})()})}}),null),Ve(q=>{var xe,pe,X;var Q={...r().x!==null&&!t()?{position:"fixed",left:`${r().x}px`,top:`${r().y}px`,width:((xe=s.style)==null?void 0:xe.width)||"320px",maxWidth:((pe=s.style)==null?void 0:pe.maxWidth)||"320px",zIndex:((X=s.style)==null?void 0:X.zIndex)||1e3}:t()?{position:"fixed",top:"10px",right:"10px",zIndex:1e3,width:"52px",minWidth:"52px",height:"52px",borderRadius:"50%"}:{...s.style},cursor:a()?"grabbing":"default",transition:a()?"none":"all 0.2s"},J={cursor:t()?"pointer":"grab",...t()?{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:0}:{}},se=t()?"scale(1.3)":"scale(1)";return q.e=Tn(R,Q,q.e),q.t=Tn(ne,J,q.t),se!==q.a&&((q.a=se)!=null?ae.style.setProperty("transform",se):ae.style.removeProperty("transform")),q},{e:void 0,t:void 0,a:void 0}),R})()}Ji(["input","click","touchstart","touchmove","touchend","pointerdown","mousedown"]);let nt={blendTime:{value:0,min:0,max:.5,step:.01,description:"Tile blending duration - 0 eliminates transparency artifacts"},maxTilesPerFrame:{value:1,min:1,max:6,step:1,description:"Max concurrent tiles - lower prevents cascade artifacts"},animationTime:{value:1.2,min:.1,max:3,step:.1,description:"Zoom animation duration - affects smoothness"},springStiffness:{value:6.5,min:1,max:20,step:.5,description:"Animation responsiveness - affects zoom feel"},immediateRender:{value:!1,description:"Force immediate tile rendering"},imageLoaderLimit:{value:2,min:1,max:8,step:1,description:"Concurrent image loading limit"},enableProgressiveQuality:{value:!0,description:"Reduce quality during zoom for smoother animation"},qualityReductionThreshold:{value:2,min:.5,max:5,step:.1,description:"Zoom level to start quality reduction"},minQualityLevel:{value:.6,min:.1,max:1,step:.05,description:"Lowest quality during animation (0.1-1.0)"},enableMouseWheelSmoothing:{value:!0,description:"Smooth discrete mouse wheel events"},wheelEventThrottleMs:{value:16,min:8,max:100,step:4,description:"Mouse wheel event throttling (ms)"},wheelZoomStep:{value:.02,min:.01,max:.2,step:.01,description:"Zoom increment per wheel tick"},enableTileCascadePrevention:{value:!0,description:"Prevent multiple pyramid levels simultaneously"},maxTileLevels:{value:3,min:1,max:5,step:1,description:"Maximum tile pyramid levels at low zoom"},cascadePreventionZoom:{value:3,min:1,max:10,step:.5,description:"Zoom threshold for cascade prevention"},forceSafariCanvas:{value:!0,description:"Force Canvas renderer on Safari (40-50% performance boost)"},disableWebGLOnMobile:{value:!0,description:"Disable WebGL on mobile devices (research shows 15 FPS improvement)"},tileOverlap:{value:1,min:0,max:4,step:1,description:"Tile overlap in pixels (prevents seams)"},wheelEventThrottleMs:{value:16,min:8,max:100,step:4,description:"Mouse wheel event throttling (ms)"},wheelZoomStep:{value:.02,min:.01,max:.2,step:.01,description:"Zoom increment per wheel tick"}};function no(s,t){if(!s||!t)return;const e=nt;s.blendTime=e.blendTime.value,s.animationTime=e.animationTime.value,s.springStiffness=e.springStiffness.value,t.viewer.blendTime=e.blendTime.value,t.viewer.maxTilesPerFrame=e.maxTilesPerFrame.value,t.viewer.animationTime=e.animationTime.value,t.viewer.springStiffness=e.springStiffness.value,t.viewer.immediateRender=e.immediateRender.value,t.viewer.imageLoaderLimit=e.imageLoaderLimit.value,t.viewer.artifactElimination&&(t.viewer.artifactElimination.enableTileCascadePrevention=e.enableTileCascadePrevention.value,t.viewer.artifactElimination.enableBlendingOptimization=e.blendTime.value===0,t.viewer.artifactElimination.enableMouseWheelSmoothing=e.enableMouseWheelSmoothing.value,t.viewer.artifactElimination.enableProgressiveQuality=e.enableProgressiveQuality.value),s.forceRedraw&&s.forceRedraw(),console.log("Applied debug tuning values:",{blendTime:e.blendTime.value,maxTilesPerFrame:e.maxTilesPerFrame.value,animationTime:e.animationTime.value,springStiffness:e.springStiffness.value})}function kd(s,t){nt[s]&&(typeof nt[s].value=="boolean"?nt[s].value=!!t:nt[s].value=Number(t),localStorage.setItem(`debugTuning_${s}`,String(nt[s].value)),window.viewer&&no(window.viewer,window.performanceConfig),console.log(`Updated tuning parameter ${s}:`,nt[s].value))}function Fd(){Object.keys(nt).forEach(s=>{const t=localStorage.getItem(`debugTuning_${s}`);t!==null&&(typeof nt[s].value=="boolean"?nt[s].value=t==="true":nt[s].value=Number(t))}),console.log("Loaded saved tuning values:",nt)}function Od(){const s={blendTime:0,maxTilesPerFrame:1,animationTime:1.2,springStiffness:6.5,immediateRender:!1,imageLoaderLimit:2,enableProgressiveQuality:!0,qualityReductionThreshold:2,minQualityLevel:.6,enableMouseWheelSmoothing:!0,wheelEventThrottleMs:16,wheelZoomStep:.02,enableTileCascadePrevention:!0,maxTileLevels:3,cascadePreventionZoom:3,forceSafariCanvas:!0,disableWebGLOnMobile:!0,tileOverlap:1,wheelEventThrottleMs:16,wheelZoomStep:.02};Object.keys(s).forEach(t=>{nt[t]&&(nt[t].value=s[t],localStorage.setItem(`debugTuning_${t}`,String(s[t])))}),window.viewer&&no(window.viewer,window.performanceConfig),console.log("Reset tuning to research-based defaults")}function Vd(){const s={};Object.keys(nt).forEach(e=>{s[e]=nt[e].value});const t=JSON.stringify(s,null,2);return navigator.clipboard&&(navigator.clipboard.writeText(t),console.log("Tuning config copied to clipboard:",s)),s}function t_(){return nt}function Ld(){Fd(),window.debugTuning={state:nt,update:kd,reset:Od,export:Vd,apply:no},console.log("Debug tuning system initialized"),console.log("Access via window.debugTuning in console"),console.log("Current values:",nt)}var Nd=B('<img class=preview-image alt="Loading preview">'),Bd=B("<div class=viewer-loading><p>Loading high-resolution artwork...</p><p style=font-size:12px;margin-top:10px;opacity:0.7;>Debug: isLoading=<!>, viewerReady="),zd=B("<div><div><div style=font-size:12px;color:#FFFFFF;font-weight:600;letter-spacing:0.5px;text-align:center;>SPOTLIGHT FINE-TUNING</div><button>✕</button></div><div class=floating-panel-scrollable><div style=margin-bottom:12px;><label style=font-size:11px;color:rgba(255,255,255,0.8);display:block;margin-bottom:6px;>Circle Size: </label><input type=range max=3.0 step=0.05>"),Hd=B('<button class=expand-button aria-label="Expand to Full View"><svg width=24 height=24 viewBox="0 0 24 24"fill=none><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round></path></svg><span>Full View'),Ud=B("<div class=viewer-container><div class=openseadragon-viewer>");let lr=[];function jd(s){let t;const[e,i]=oe(null);let n={};const r=Uh(),[o,a]=oe(null),l=f=>{console.log(`Switching overlay system to: ${f}`);try{r.setCurrentOverlayType(f),r.components().overlayManager&&typeof r.components().overlayManager.destroy=="function"&&(console.log("Destroying old overlay manager"),r.components().overlayManager.destroy()),bi.setPreference(f),console.log("Creating new overlay manager with type:",f);const m=bi.createWithOverride(e());m.initialize(),r.setComponents(v=>({...v,overlayManager:m})),window.overlayManager=m,r.selectedHotspot()&&(console.log("Re-selecting hotspot after overlay switch:",r.selectedHotspot().id),setTimeout(()=>{m.selectHotspot(r.selectedHotspot())},100)),console.log("Overlay system switch completed successfully")}catch(m){console.error("Error switching overlay system:",m),alert("Error switching overlay system. Please refresh the page to continue.")}},u=()=>{n.handleKeyPress&&window.removeEventListener("keydown",n.handleKeyPress),Object.values(n).forEach(f=>{typeof f=="number"&&clearInterval(f)}),n.performanceUpdate&&clearInterval(n.performanceUpdate),r.components().resizeObserver&&t&&r.components().resizeObserver.disconnect(),Object.values(r.components()).forEach(f=>{f&&typeof f.destroy=="function"&&f.destroy()}),e()&&e().destroy(),["performanceMonitor","viewer","tileOptimizer","lowZoomOptimizer","safariPerformanceOptimizer"].forEach(f=>{(window[f]===r.components()[f]||window[f]===e())&&delete window[f]})},h=async f=>{var v,_,E,b,k,V,W,z,j,D;if(console.log("handleHotspotClick called in ArtworkViewer",{hotspotId:f?f.id:"null (deselecting)",isZoomingToHotspot:r.isZoomingToHotspot(),isExpandingToFullView:r.isExpandingToFullView(),timestamp:Date.now()}),r.isZoomingToHotspot()&&(console.log("🔧 FORCE RESET: Clearing stuck isZoomingToHotspot state"),r.setIsZoomingToHotspot(!1),r.components().renderOptimizer&&r.components().renderOptimizer.endCinematicZoom(),r.components().renderer&&(r.components().renderer.resumeUpdates(),He()&&r.components().renderer.showOverlay()),await new Promise(x=>setTimeout(x,16))),console.log("Components available?",!!r.components()),console.log("OverlayManager available?",!!((v=r.components())!=null&&v.overlayManager)),console.log("OverlayManager type:",(E=(_=r.components())==null?void 0:_.overlayManager)==null?void 0:E.constructor.name),console.log("OverlayManager initialized?",(k=(b=r.components())==null?void 0:b.overlayManager)==null?void 0:k.isInitialized),!f){r.setSelectedHotspot(null),r.setShowMediaButton(!1),r.setCurrentPlayingHotspot(null),r.setCurrentMediaHotspot(null),r.components().overlayManager?(console.log("Calling overlayManager.clearSelection()"),r.components().overlayManager.clearSelection()):console.error("No overlay manager available for clearSelection!");return}if(r.isExpandingToFullView()&&(console.log("Interrupting Full View animation for hotspot click"),(V=e())==null||V.viewport.stopAnimation(),(W=o())==null||W.cleanupExpandAnimation(),r.setIsExpandingToFullView(!1),r.components().renderOptimizer&&r.components().renderOptimizer.endCinematicZoom(),r.components().renderer&&(r.components().renderer.resumeUpdates(),He()&&r.components().renderer.showOverlay()),await new Promise(x=>setTimeout(x,50))),r.isZoomingToHotspot()&&(console.log("WARNING: isZoomingToHotspot was still true, forcing reset"),r.setIsZoomingToHotspot(!1)),r.setShowMediaButton(!1),r.setSelectedHotspot(f),r.setCurrentPlayingHotspot(f),(z=r.components())!=null&&z.overlayManager){console.log("Calling overlayManager.selectHotspot with:",(f==null?void 0:f.id)||"null"),console.log("Hotspot data being passed:",f),console.log("OverlayManager method exists?",typeof r.components().overlayManager.selectHotspot);try{r.components().overlayManager.selectHotspot(f),console.log("selectHotspot call completed")}catch(x){console.error("Error calling selectHotspot:",x)}}else console.error("No overlay manager available in components!"),console.error("Components object:",r.components());(f.image_url_1||((j=r.components().imageOverlayManager)==null?void 0:j.getOverlay(f.id)))&&(r.components().imageOverlayManager.shouldAutoReveal(f.id)?d(f.id):r.components().imageOverlayManager.shouldShowButton(f.id)&&(r.setCurrentMediaHotspot(f),r.setShowMediaButton(!0))),console.log("🎯 FIXED: Guaranteed zoom to hotspot:",f.id);try{await((D=o())==null?void 0:D.zoomToHotspot(f))}catch(x){console.error("Zoom failed, forcing state reset:",x),r.setIsZoomingToHotspot(!1)}},d=f=>{console.log("Media button clicked for:",f),r.setShowMediaButton(!1),r.components().imageOverlayManager&&r.components().imageOverlayManager.openOverlay(f)};return window.artworkViewerHandleHotspotClick=h,to(async()=>{Ld();try{lr=await(await fetch(`/data/hotspots.json?t=${Date.now()}`)).json(),console.log(`Loaded ${lr.length} hotspots`)}catch(z){console.error("Failed to load hotspots:",z),lr=[]}const f=new Image;f.onload=()=>r.setPreviewLoaded(!0),f.src=`/images/tiles/${s.artworkId}_1024/preview.jpg`,console.log("About to import and initialize viewer...");const{initializeViewer:m}=await Nh(async()=>{const{initializeViewer:z}=await import("./viewerSetup-D__f9bGq.js").then(j=>j.v);return{initializeViewer:z}},[]),v={setIsLoading:r.setIsLoading,setViewerReady:r.setViewerReady},_=await m(t,s,r,h);console.log("Viewer initialization result:",_),i(_.viewer),n=_.intervals,_.homeViewport,console.log("Viewer assigned:",!!_.viewer);const E=Wh(_.viewer,r,r.components);a(E),window.animations=E,console.log("Animation hooks set:",!!E);const b=setTimeout(()=>{var z;r.isLoading()&&(console.warn("⚠️ Failsafe: Force hiding loading screen after 5 seconds"),v.setIsLoading(!1),v.setViewerReady(!0),_.viewer&&((z=_.viewer.world)==null?void 0:z.getItemCount())>0&&console.log("Viewer has items, forcing ready state"))},5e3);document.addEventListener("fullscreenchange",()=>{r.setIsFullscreen(!!document.fullscreenElement)});const k=z=>{if(r.isDragging()){const j=z.touches?z.touches[0].clientX:z.clientX,D=z.touches?z.touches[0].clientY:z.clientY;r.setPanelPosition({x:j-r.dragStart().x,y:D-r.dragStart().y})}},V=z=>{r.isDragging()&&(z.preventDefault(),k(z))},W=()=>{r.setIsDragging(!1)};window.addEventListener("mousemove",k),window.addEventListener("mouseup",W),window.addEventListener("touchmove",V,{passive:!1}),window.addEventListener("touchend",W),Cn(()=>{window.removeEventListener("mousemove",k),window.removeEventListener("mouseup",W),window.removeEventListener("touchmove",V),window.removeEventListener("touchend",W),clearTimeout(b)}),Cn(u)}),(()=>{var f=Ud(),m=f.firstChild;return ie(f,ge(ke,{get when(){return Rt(()=>!!r.previewLoaded())()&&!r.viewerReady()},get children(){var v=Nd();return Ve(()=>ni(v,"src",`/images/tiles/${s.artworkId}_1024/preview.jpg`)),v}}),m),cu(v=>{t=v,console.log("ViewerRef assigned:",!!v)},m),ie(f,ge(ke,{get when(){return r.isLoading()},get children(){var v=Bd(),_=v.firstChild,E=_.nextSibling,b=E.firstChild,k=b.nextSibling;return k.nextSibling,ie(E,()=>String(r.isLoading()),k),ie(E,()=>String(r.viewerReady()),null),v}}),null),ie(f,ge(ke,{get when(){return Rt(()=>!!r.viewerReady())()&&r.debugLevel()===1},get children(){return ge(Md,{get style(){return{position:"fixed",top:"10px",right:"10px",width:He()?"90%":"320px",maxWidth:"320px",zIndex:1e3}},get selectedHotspot(){return r.selectedHotspot},get hoveredHotspot(){return r.hoveredHotspot},get totalHotspots(){return lr.length},get visibleHotspotCount(){var v,_;return(_=(v=r.components().renderer)==null?void 0:v.visibleOverlays)==null?void 0:_.size},get revealStyle(){return r.revealStyle},get setRevealStyle(){return r.updateRevealStyle},get performanceMetrics(){return r.performanceMetrics()},get zoomSpeed(){return r.zoomSpeedMultiplier},get setZoomSpeed(){return r.setZoomSpeedMultiplier},get setDebugLevel(){return r.setDebugLevel},get currentPalette(){return r.currentPalette},setPalette:v=>{var _;window.setHotspotPalette&&(window.setHotspotPalette(v),r.setCurrentPalette(v),(_=e())==null||_.forceRedraw())},get interactionMode(){return r.interactionMode},setInteractionMode:v=>{var _;r.setInteractionMode(v),localStorage.setItem("interactionMode",v),(_=r.components().renderer)!=null&&_.modeStateManager&&r.components().renderer.modeStateManager.setMode(v)},get overlayType(){return r.currentOverlayType()},toggleOverlay:v=>{console.log("DebugPanel requesting overlay switch to:",v),l(v)},get safariOptimizerState(){var v,_;return(_=(v=r.components().safariPerformanceOptimizer)==null?void 0:v.getState)==null?void 0:_.call(v)},get safariHybridMetrics(){return r.safariHybridMetrics()},isMobile:()=>He(),get showFloatingPanel(){return r.showFloatingPanel},get setShowFloatingPanel(){return r.setShowFloatingPanel}})}}),null),ie(f,ge(ke,{get when(){return Rt(()=>!!r.showFloatingPanel())()&&(bi.getCurrentType()==="safari"||bi.detectBrowser().isWebKitBased&&!bi.getCurrentType())},get children(){var v=zd(),_=v.firstChild,E=_.firstChild,b=E.nextSibling,k=_.nextSibling,V=k.firstChild,W=V.firstChild;W.firstChild;var z=W.nextSibling;return v.style.setProperty("position","fixed"),v.style.setProperty("width","220px"),v.style.setProperty("background","rgba(20,20,20,0.85)"),v.style.setProperty("border","1px solid rgba(255,255,255,0.2)"),v.style.setProperty("borderRadius","12px"),v.style.setProperty("boxShadow","0 8px 32px rgba(0,0,0,0.6)"),v.style.setProperty("zIndex","10000"),v.style.setProperty("userSelect","none"),v.style.setProperty("backdropFilter","blur(20px)"),v.style.setProperty("-webkit-backdrop-filter","blur(20px)"),v.style.setProperty("display","flex"),v.style.setProperty("flexDirection","column"),v.style.setProperty("overflowY","auto"),v.style.setProperty("overflowX","hidden"),_.$$touchstart=j=>{const D=j.touches[0];r.setIsDragging(!0),r.setDragStart({x:D.clientX-r.panelPosition().x,y:D.clientY-r.panelPosition().y})},_.$$mousedown=j=>{r.setIsDragging(!0),r.setDragStart({x:j.clientX-r.panelPosition().x,y:j.clientY-r.panelPosition().y})},_.style.setProperty("position","relative"),_.style.setProperty("padding","12px 40px 12px 16px"),_.style.setProperty("borderBottom","1px solid rgba(255,255,255,0.1)"),_.style.setProperty("cursor","grab"),_.style.setProperty("background","rgba(255,255,255,0.03)"),_.style.setProperty("borderRadius","12px 12px 0 0"),b.$$click=()=>r.setShowFloatingPanel(!1),b.addEventListener("mouseleave",j=>{j.target.style.background="transparent",j.target.style.color="rgba(255,255,255,0.5)"}),b.addEventListener("mouseenter",j=>{j.target.style.background="rgba(255,255,255,0.1)",j.target.style.color="rgba(255,255,255,0.8)"}),b.style.setProperty("position","absolute"),b.style.setProperty("top","8px"),b.style.setProperty("right","8px"),b.style.setProperty("background","transparent"),b.style.setProperty("border","none"),b.style.setProperty("color","rgba(255,255,255,0.5)"),b.style.setProperty("fontSize","16px"),b.style.setProperty("cursor","pointer"),b.style.setProperty("padding","4px"),b.style.setProperty("width","24px"),b.style.setProperty("height","24px"),b.style.setProperty("display","flex"),b.style.setProperty("alignItems","center"),b.style.setProperty("justifyContent","center"),b.style.setProperty("borderRadius","4px"),b.style.setProperty("transition","all 0.2s"),k.style.setProperty("padding","16px"),k.style.setProperty("overflowY","auto"),k.style.setProperty("overflowX","hidden"),k.style.setProperty("flex","1"),k.style.setProperty("WebkitOverflowScrolling","touch"),k.style.setProperty("scrollbarWidth","thin"),k.style.setProperty("scrollbarColor","rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05)"),ie(W,()=>r.circleMultiplierValue().toFixed(2),null),z.$$input=j=>{const D=parseFloat(j.target.value);r.setCircleMultiplierValue(D),window.safariTuning&&(window.safariTuning.circleMultiplier=D,r.components().overlayManager&&r.selectedHotspot()&&r.components().overlayManager.forceRecalculation())},z.style.setProperty("width","100%"),z.style.setProperty("height","20px"),z.style.setProperty("background","rgba(255,255,255,0.1)"),z.style.setProperty("borderRadius","10px"),z.style.setProperty("outline","none"),z.style.setProperty("appearance","none"),z.style.setProperty("WebkitAppearance","none"),Ve(j=>{var D=`${r.panelPosition().x}px`,x=`${r.panelPosition().y}px`,I=r.isDragging()?"grabbing":"default",M=He()?"80vh":"none",F=He()?"0.2":"0.1";return D!==j.e&&((j.e=D)!=null?v.style.setProperty("left",D):v.style.removeProperty("left")),x!==j.t&&((j.t=x)!=null?v.style.setProperty("top",x):v.style.removeProperty("top")),I!==j.a&&((j.a=I)!=null?v.style.setProperty("cursor",I):v.style.removeProperty("cursor")),M!==j.o&&((j.o=M)!=null?v.style.setProperty("maxHeight",M):v.style.removeProperty("maxHeight")),F!==j.i&&ni(z,"min",j.i=F),j},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),Ve(()=>z.value=r.circleMultiplierValue()),v}}),null),ie(f,ge(ke,{get when(){return r.showExpandButton()},get children(){var v=Hd();return v.$$click=()=>{var _;return(_=o())==null?void 0:_.expandToFullView()},v}}),null),ie(f,ge(ke,{get when(){return r.showMediaButton()},get children(){return ge(dd,{get position(){return r.mediaButtonPosition()},onClick:()=>{var v;return d((v=r.currentMediaHotspot())==null?void 0:v.id)},isLoading:!1})}}),null),ie(f,ge(ke,{get when(){return r.viewerReady()},get children(){return ge(cd,{get audioEngine(){return r.components().audioEngine},get currentHotspot(){return r.currentPlayingHotspot}})}}),null),f})()}Ji(["mousedown","touchstart","click","input"]);const Wd=()=>{};var za={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const du=function(s){const t=[];let e=0;for(let i=0;i<s.length;i++){let n=s.charCodeAt(i);n<128?t[e++]=n:n<2048?(t[e++]=n>>6|192,t[e++]=n&63|128):(n&64512)===55296&&i+1<s.length&&(s.charCodeAt(i+1)&64512)===56320?(n=65536+((n&1023)<<10)+(s.charCodeAt(++i)&1023),t[e++]=n>>18|240,t[e++]=n>>12&63|128,t[e++]=n>>6&63|128,t[e++]=n&63|128):(t[e++]=n>>12|224,t[e++]=n>>6&63|128,t[e++]=n&63|128)}return t},Gd=function(s){const t=[];let e=0,i=0;for(;e<s.length;){const n=s[e++];if(n<128)t[i++]=String.fromCharCode(n);else if(n>191&&n<224){const r=s[e++];t[i++]=String.fromCharCode((n&31)<<6|r&63)}else if(n>239&&n<365){const r=s[e++],o=s[e++],a=s[e++],l=((n&7)<<18|(r&63)<<12|(o&63)<<6|a&63)-65536;t[i++]=String.fromCharCode(55296+(l>>10)),t[i++]=String.fromCharCode(56320+(l&1023))}else{const r=s[e++],o=s[e++];t[i++]=String.fromCharCode((n&15)<<12|(r&63)<<6|o&63)}}return t.join("")},fu={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(s,t){if(!Array.isArray(s))throw Error("encodeByteArray takes an array as a parameter");this.init_();const e=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let n=0;n<s.length;n+=3){const r=s[n],o=n+1<s.length,a=o?s[n+1]:0,l=n+2<s.length,u=l?s[n+2]:0,h=r>>2,d=(r&3)<<4|a>>4;let f=(a&15)<<2|u>>6,m=u&63;l||(m=64,o||(f=64)),i.push(e[h],e[d],e[f],e[m])}return i.join("")},encodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(s):this.encodeByteArray(du(s),t)},decodeString(s,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(s):Gd(this.decodeStringToByteArray(s,t))},decodeStringToByteArray(s,t){this.init_();const e=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let n=0;n<s.length;){const r=e[s.charAt(n++)],a=n<s.length?e[s.charAt(n)]:0;++n;const u=n<s.length?e[s.charAt(n)]:64;++n;const d=n<s.length?e[s.charAt(n)]:64;if(++n,r==null||a==null||u==null||d==null)throw new qd;const f=r<<2|a>>4;if(i.push(f),u!==64){const m=a<<4&240|u>>2;if(i.push(m),d!==64){const v=u<<6&192|d;i.push(v)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let s=0;s<this.ENCODED_VALS.length;s++)this.byteToCharMap_[s]=this.ENCODED_VALS.charAt(s),this.charToByteMap_[this.byteToCharMap_[s]]=s,this.byteToCharMapWebSafe_[s]=this.ENCODED_VALS_WEBSAFE.charAt(s),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[s]]=s,s>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(s)]=s,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(s)]=s)}}};class qd extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Zd=function(s){const t=du(s);return fu.encodeByteArray(t,!0)},Cr=function(s){return Zd(s).replace(/\./g,"")},Xd=function(s){try{return fu.decodeString(s,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Kd(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yd=()=>Kd().__FIREBASE_DEFAULTS__,Qd=()=>{if(typeof process>"u"||typeof za>"u")return;const s=za.__FIREBASE_DEFAULTS__;if(s)return JSON.parse(s)},Jd=()=>{if(typeof document>"u")return;let s;try{s=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=s&&Xd(s[1]);return t&&JSON.parse(t)},ro=()=>{try{return Wd()||Yd()||Qd()||Jd()}catch(s){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${s}`);return}},$d=s=>{var t,e;return(e=(t=ro())===null||t===void 0?void 0:t.emulatorHosts)===null||e===void 0?void 0:e[s]},ef=s=>{const t=$d(s);if(!t)return;const e=t.lastIndexOf(":");if(e<=0||e+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const i=parseInt(t.substring(e+1),10);return t[0]==="["?[t.substring(1,e-1),i]:[t.substring(0,e),i]},pu=()=>{var s;return(s=ro())===null||s===void 0?void 0:s.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tf{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}wrapCallback(t){return(e,i)=>{e?this.reject(e):this.resolve(i),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(e):t(e,i))}}}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function so(s){try{return(s.startsWith("http://")||s.startsWith("https://")?new URL(s).hostname:s).endsWith(".cloudworkstations.dev")}catch{return!1}}async function nf(s){return(await fetch(s,{credentials:"include"})).ok}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function rf(s,t){if(s.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const e={alg:"none",type:"JWT"},i=t||"demo-project",n=s.iat||0,r=s.sub||s.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${i}`,aud:i,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},s);return[Cr(JSON.stringify(e)),Cr(JSON.stringify(o)),""].join(".")}const En={};function sf(){const s={prod:[],emulator:[]};for(const t of Object.keys(En))En[t]?s.emulator.push(t):s.prod.push(t);return s}function of(s){let t=document.getElementById(s),e=!1;return t||(t=document.createElement("div"),t.setAttribute("id",s),e=!0),{created:e,element:t}}let Ha=!1;function af(s,t){if(typeof window>"u"||typeof document>"u"||!so(window.location.host)||En[s]===t||En[s]||Ha)return;En[s]=t;function e(f){return`__firebase__banner__${f}`}const i="__firebase__banner",r=sf().prod.length>0;function o(){const f=document.getElementById(i);f&&f.remove()}function a(f){f.style.display="flex",f.style.background="#7faaf0",f.style.position="fixed",f.style.bottom="5px",f.style.left="5px",f.style.padding=".5em",f.style.borderRadius="5px",f.style.alignItems="center"}function l(f,m){f.setAttribute("width","24"),f.setAttribute("id",m),f.setAttribute("height","24"),f.setAttribute("viewBox","0 0 24 24"),f.setAttribute("fill","none"),f.style.marginLeft="-6px"}function u(){const f=document.createElement("span");return f.style.cursor="pointer",f.style.marginLeft="16px",f.style.fontSize="24px",f.innerHTML=" &times;",f.onclick=()=>{Ha=!0,o()},f}function h(f,m){f.setAttribute("id",m),f.innerText="Learn more",f.href="https://firebase.google.com/docs/studio/preview-apps#preview-backend",f.setAttribute("target","__blank"),f.style.paddingLeft="5px",f.style.textDecoration="underline"}function d(){const f=of(i),m=e("text"),v=document.getElementById(m)||document.createElement("span"),_=e("learnmore"),E=document.getElementById(_)||document.createElement("a"),b=e("preprendIcon"),k=document.getElementById(b)||document.createElementNS("http://www.w3.org/2000/svg","svg");if(f.created){const V=f.element;a(V),h(E,_);const W=u();l(k,b),V.append(k,v,E,W),document.body.appendChild(V)}r?(v.innerText="Preview backend disconnected.",k.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(k.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,v.innerText="Preview backend running in this workspace."),v.setAttribute("id",m)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",d):d()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lf(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function uf(){var s;const t=(s=ro())===null||s===void 0?void 0:s.forceEnvironment;if(t==="node")return!0;if(t==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function cf(){return!uf()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function hf(){try{return typeof indexedDB=="object"}catch{return!1}}function df(){return new Promise((s,t)=>{try{let e=!0;const i="validate-browser-context-for-indexeddb-analytics-module",n=self.indexedDB.open(i);n.onsuccess=()=>{n.result.close(),e||self.indexedDB.deleteDatabase(i),s(!0)},n.onupgradeneeded=()=>{e=!1},n.onerror=()=>{var r;t(((r=n.error)===null||r===void 0?void 0:r.message)||"")}}catch(e){t(e)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ff="FirebaseError";class $i extends Error{constructor(t,e,i){super(e),this.code=t,this.customData=i,this.name=ff,Object.setPrototypeOf(this,$i.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,gu.prototype.create)}}class gu{constructor(t,e,i){this.service=t,this.serviceName=e,this.errors=i}create(t,...e){const i=e[0]||{},n=`${this.service}/${t}`,r=this.errors[t],o=r?pf(r,i):"Error",a=`${this.serviceName}: ${o} (${n}).`;return new $i(n,a,i)}}function pf(s,t){return s.replace(gf,(e,i)=>{const n=t[i];return n!=null?String(n):`<${i}?>`})}const gf=/\{\$([^}]+)}/g;function Rr(s,t){if(s===t)return!0;const e=Object.keys(s),i=Object.keys(t);for(const n of e){if(!i.includes(n))return!1;const r=s[n],o=t[n];if(Ua(r)&&Ua(o)){if(!Rr(r,o))return!1}else if(r!==o)return!1}for(const n of i)if(!e.includes(n))return!1;return!0}function Ua(s){return s!==null&&typeof s=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wt(s){return s&&s._delegate?s._delegate:s}class In{constructor(t,e,i){this.name=t,this.instanceFactory=e,this.type=i,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xi="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mf{constructor(t,e){this.name=t,this.container=e,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const e=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(e)){const i=new tf;if(this.instancesDeferred.set(e,i),this.isInitialized(e)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:e});n&&i.resolve(n)}catch{}}return this.instancesDeferred.get(e).promise}getImmediate(t){var e;const i=this.normalizeInstanceIdentifier(t==null?void 0:t.identifier),n=(e=t==null?void 0:t.optional)!==null&&e!==void 0?e:!1;if(this.isInitialized(i)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:i})}catch(r){if(n)return null;throw r}else{if(n)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(yf(t))try{this.getOrInitializeService({instanceIdentifier:xi})}catch{}for(const[e,i]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const r=this.getOrInitializeService({instanceIdentifier:n});i.resolve(r)}catch{}}}}clearInstance(t=xi){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...t.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=xi){return this.instances.has(t)}getOptions(t=xi){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:e={}}=t,i=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(i))throw Error(`${this.name}(${i}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const n=this.getOrInitializeService({instanceIdentifier:i,options:e});for(const[r,o]of this.instancesDeferred.entries()){const a=this.normalizeInstanceIdentifier(r);i===a&&o.resolve(n)}return n}onInit(t,e){var i;const n=this.normalizeInstanceIdentifier(e),r=(i=this.onInitCallbacks.get(n))!==null&&i!==void 0?i:new Set;r.add(t),this.onInitCallbacks.set(n,r);const o=this.instances.get(n);return o&&t(o,n),()=>{r.delete(t)}}invokeOnInitCallbacks(t,e){const i=this.onInitCallbacks.get(e);if(i)for(const n of i)try{n(t,e)}catch{}}getOrInitializeService({instanceIdentifier:t,options:e={}}){let i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:vf(t),options:e}),this.instances.set(t,i),this.instancesOptions.set(t,e),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch{}return i||null}normalizeInstanceIdentifier(t=xi){return this.component?this.component.multipleInstances?t:xi:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function vf(s){return s===xi?void 0:s}function yf(s){return s.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wf{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const e=this.getProvider(t.name);if(e.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);e.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const e=new mf(t,this);return this.providers.set(t,e),e}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ae;(function(s){s[s.DEBUG=0]="DEBUG",s[s.VERBOSE=1]="VERBOSE",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR",s[s.SILENT=5]="SILENT"})(Ae||(Ae={}));const _f={debug:Ae.DEBUG,verbose:Ae.VERBOSE,info:Ae.INFO,warn:Ae.WARN,error:Ae.ERROR,silent:Ae.SILENT},Tf=Ae.INFO,Ef={[Ae.DEBUG]:"log",[Ae.VERBOSE]:"log",[Ae.INFO]:"info",[Ae.WARN]:"warn",[Ae.ERROR]:"error"},xf=(s,t,...e)=>{if(t<s.logLevel)return;const i=new Date().toISOString(),n=Ef[t];if(n)console[n](`[${i}]  ${s.name}:`,...e);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class mu{constructor(t){this.name=t,this._logLevel=Tf,this._logHandler=xf,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Ae))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?_f[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Ae.DEBUG,...t),this._logHandler(this,Ae.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Ae.VERBOSE,...t),this._logHandler(this,Ae.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Ae.INFO,...t),this._logHandler(this,Ae.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Ae.WARN,...t),this._logHandler(this,Ae.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Ae.ERROR,...t),this._logHandler(this,Ae.ERROR,...t)}}const bf=(s,t)=>t.some(e=>s instanceof e);let ja,Wa;function Sf(){return ja||(ja=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Pf(){return Wa||(Wa=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const vu=new WeakMap,Ds=new WeakMap,yu=new WeakMap,ws=new WeakMap,oo=new WeakMap;function Cf(s){const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("success",r),s.removeEventListener("error",o)},r=()=>{e(si(s.result)),n()},o=()=>{i(s.error),n()};s.addEventListener("success",r),s.addEventListener("error",o)});return t.then(e=>{e instanceof IDBCursor&&vu.set(e,s)}).catch(()=>{}),oo.set(t,s),t}function Rf(s){if(Ds.has(s))return;const t=new Promise((e,i)=>{const n=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",o),s.removeEventListener("abort",o)},r=()=>{e(),n()},o=()=>{i(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",r),s.addEventListener("error",o),s.addEventListener("abort",o)});Ds.set(s,t)}let Ms={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return Ds.get(s);if(t==="objectStoreNames")return s.objectStoreNames||yu.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return si(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function If(s){Ms=s(Ms)}function Af(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const i=s.call(_s(this),t,...e);return yu.set(i,t.sort?t.sort():[t]),si(i)}:Pf().includes(s)?function(...t){return s.apply(_s(this),t),si(vu.get(this))}:function(...t){return si(s.apply(_s(this),t))}}function Df(s){return typeof s=="function"?Af(s):(s instanceof IDBTransaction&&Rf(s),bf(s,Sf())?new Proxy(s,Ms):s)}function si(s){if(s instanceof IDBRequest)return Cf(s);if(ws.has(s))return ws.get(s);const t=Df(s);return t!==s&&(ws.set(s,t),oo.set(t,s)),t}const _s=s=>oo.get(s);function Mf(s,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){const o=indexedDB.open(s,t),a=si(o);return i&&o.addEventListener("upgradeneeded",l=>{i(si(o.result),l.oldVersion,l.newVersion,si(o.transaction),l)}),e&&o.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),a.then(l=>{r&&l.addEventListener("close",()=>r()),n&&l.addEventListener("versionchange",u=>n(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}const kf=["get","getKey","getAll","getAllKeys","count"],Ff=["put","add","delete","clear"],Ts=new Map;function Ga(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(Ts.get(t))return Ts.get(t);const e=t.replace(/FromIndex$/,""),i=t!==e,n=Ff.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||kf.includes(e)))return;const r=async function(o,...a){const l=this.transaction(o,n?"readwrite":"readonly");let u=l.store;return i&&(u=u.index(a.shift())),(await Promise.all([u[e](...a),n&&l.done]))[0]};return Ts.set(t,r),r}If(s=>({...s,get:(t,e,i)=>Ga(t,e)||s.get(t,e,i),has:(t,e)=>!!Ga(t,e)||s.has(t,e)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Of{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(Vf(e)){const i=e.getImmediate();return`${i.library}/${i.version}`}else return null}).filter(e=>e).join(" ")}}function Vf(s){const t=s.getComponent();return(t==null?void 0:t.type)==="VERSION"}const ks="@firebase/app",qa="0.13.2";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qt=new mu("@firebase/app"),Lf="@firebase/app-compat",Nf="@firebase/analytics-compat",Bf="@firebase/analytics",zf="@firebase/app-check-compat",Hf="@firebase/app-check",Uf="@firebase/auth",jf="@firebase/auth-compat",Wf="@firebase/database",Gf="@firebase/data-connect",qf="@firebase/database-compat",Zf="@firebase/functions",Xf="@firebase/functions-compat",Kf="@firebase/installations",Yf="@firebase/installations-compat",Qf="@firebase/messaging",Jf="@firebase/messaging-compat",$f="@firebase/performance",ep="@firebase/performance-compat",tp="@firebase/remote-config",ip="@firebase/remote-config-compat",np="@firebase/storage",rp="@firebase/storage-compat",sp="@firebase/firestore",op="@firebase/ai",ap="@firebase/firestore-compat",lp="firebase",up="11.10.0";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fs="[DEFAULT]",cp={[ks]:"fire-core",[Lf]:"fire-core-compat",[Bf]:"fire-analytics",[Nf]:"fire-analytics-compat",[Hf]:"fire-app-check",[zf]:"fire-app-check-compat",[Uf]:"fire-auth",[jf]:"fire-auth-compat",[Wf]:"fire-rtdb",[Gf]:"fire-data-connect",[qf]:"fire-rtdb-compat",[Zf]:"fire-fn",[Xf]:"fire-fn-compat",[Kf]:"fire-iid",[Yf]:"fire-iid-compat",[Qf]:"fire-fcm",[Jf]:"fire-fcm-compat",[$f]:"fire-perf",[ep]:"fire-perf-compat",[tp]:"fire-rc",[ip]:"fire-rc-compat",[np]:"fire-gcs",[rp]:"fire-gcs-compat",[sp]:"fire-fst",[ap]:"fire-fst-compat",[op]:"fire-vertex","fire-js":"fire-js",[lp]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ir=new Map,hp=new Map,Os=new Map;function Za(s,t){try{s.container.addComponent(t)}catch(e){Qt.debug(`Component ${t.name} failed to register with FirebaseApp ${s.name}`,e)}}function Ar(s){const t=s.name;if(Os.has(t))return Qt.debug(`There were multiple attempts to register component ${t}.`),!1;Os.set(t,s);for(const e of Ir.values())Za(e,s);for(const e of hp.values())Za(e,s);return!0}function dp(s,t){const e=s.container.getProvider("heartbeat").getImmediate({optional:!0});return e&&e.triggerHeartbeat(),s.container.getProvider(t)}function fp(s){return s==null?!1:s.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pp={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},oi=new gu("app","Firebase",pp);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gp{constructor(t,e,i){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},e),this._name=e.name,this._automaticDataCollectionEnabled=e.automaticDataCollectionEnabled,this._container=i,this.container.addComponent(new In("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw oi.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mp=up;function wu(s,t={}){let e=s;typeof t!="object"&&(t={name:t});const i=Object.assign({name:Fs,automaticDataCollectionEnabled:!0},t),n=i.name;if(typeof n!="string"||!n)throw oi.create("bad-app-name",{appName:String(n)});if(e||(e=pu()),!e)throw oi.create("no-options");const r=Ir.get(n);if(r){if(Rr(e,r.options)&&Rr(i,r.config))return r;throw oi.create("duplicate-app",{appName:n})}const o=new wf(n);for(const l of Os.values())o.addComponent(l);const a=new gp(e,i,o);return Ir.set(n,a),a}function vp(s=Fs){const t=Ir.get(s);if(!t&&s===Fs&&pu())return wu();if(!t)throw oi.create("no-app",{appName:s});return t}function ji(s,t,e){var i;let n=(i=cp[s])!==null&&i!==void 0?i:s;e&&(n+=`-${e}`);const r=n.match(/\s|\//),o=t.match(/\s|\//);if(r||o){const a=[`Unable to register library "${n}" with version "${t}":`];r&&a.push(`library name "${n}" contains illegal characters (whitespace or "/")`),r&&o&&a.push("and"),o&&a.push(`version name "${t}" contains illegal characters (whitespace or "/")`),Qt.warn(a.join(" "));return}Ar(new In(`${n}-version`,()=>({library:n,version:t}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const yp="firebase-heartbeat-database",wp=1,An="firebase-heartbeat-store";let Es=null;function _u(){return Es||(Es=Mf(yp,wp,{upgrade:(s,t)=>{switch(t){case 0:try{s.createObjectStore(An)}catch(e){console.warn(e)}}}}).catch(s=>{throw oi.create("idb-open",{originalErrorMessage:s.message})})),Es}async function _p(s){try{const e=(await _u()).transaction(An),i=await e.objectStore(An).get(Tu(s));return await e.done,i}catch(t){if(t instanceof $i)Qt.warn(t.message);else{const e=oi.create("idb-get",{originalErrorMessage:t==null?void 0:t.message});Qt.warn(e.message)}}}async function Xa(s,t){try{const i=(await _u()).transaction(An,"readwrite");await i.objectStore(An).put(t,Tu(s)),await i.done}catch(e){if(e instanceof $i)Qt.warn(e.message);else{const i=oi.create("idb-set",{originalErrorMessage:e==null?void 0:e.message});Qt.warn(i.message)}}}function Tu(s){return`${s.name}!${s.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tp=1024,Ep=30;class xp{constructor(t){this.container=t,this._heartbeatsCache=null;const e=this.container.getProvider("app").getImmediate();this._storage=new Sp(e),this._heartbeatsCachePromise=this._storage.read().then(i=>(this._heartbeatsCache=i,i))}async triggerHeartbeat(){var t,e;try{const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=Ka();if(((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===r||this._heartbeatsCache.heartbeats.some(o=>o.date===r))return;if(this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats.length>Ep){const o=Pp(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(o,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(i){Qt.warn(i)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const e=Ka(),{heartbeatsToSend:i,unsentEntries:n}=bp(this._heartbeatsCache.heartbeats),r=Cr(JSON.stringify({version:2,heartbeats:i}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return Qt.warn(e),""}}}function Ka(){return new Date().toISOString().substring(0,10)}function bp(s,t=Tp){const e=[];let i=s.slice();for(const n of s){const r=e.find(o=>o.agent===n.agent);if(r){if(r.dates.push(n.date),Ya(e)>t){r.dates.pop();break}}else if(e.push({agent:n.agent,dates:[n.date]}),Ya(e)>t){e.pop();break}i=i.slice(1)}return{heartbeatsToSend:e,unsentEntries:i}}class Sp{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return hf()?df().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const e=await _p(this.app);return e!=null&&e.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return Xa(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var e;if(await this._canUseIndexedDBPromise){const n=await this.read();return Xa(this.app,{lastSentHeartbeatDate:(e=t.lastSentHeartbeatDate)!==null&&e!==void 0?e:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...t.heartbeats]})}else return}}function Ya(s){return Cr(JSON.stringify({version:2,heartbeats:s})).length}function Pp(s){if(s.length===0)return-1;let t=0,e=s[0].date;for(let i=1;i<s.length;i++)s[i].date<e&&(e=s[i].date,t=i);return t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Cp(s){Ar(new In("platform-logger",t=>new Of(t),"PRIVATE")),Ar(new In("heartbeat",t=>new xp(t),"PRIVATE")),ji(ks,qa,s),ji(ks,qa,"esm2017"),ji("fire-js","")}Cp("");var Qa=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var ai,Eu;(function(){var s;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function t(D,x){function I(){}I.prototype=x.prototype,D.D=x.prototype,D.prototype=new I,D.prototype.constructor=D,D.C=function(M,F,O){for(var R=Array(arguments.length-2),ne=2;ne<arguments.length;ne++)R[ne-2]=arguments[ne];return x.prototype[F].apply(M,R)}}function e(){this.blockSize=-1}function i(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(i,e),i.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function n(D,x,I){I||(I=0);var M=Array(16);if(typeof x=="string")for(var F=0;16>F;++F)M[F]=x.charCodeAt(I++)|x.charCodeAt(I++)<<8|x.charCodeAt(I++)<<16|x.charCodeAt(I++)<<24;else for(F=0;16>F;++F)M[F]=x[I++]|x[I++]<<8|x[I++]<<16|x[I++]<<24;x=D.g[0],I=D.g[1],F=D.g[2];var O=D.g[3],R=x+(O^I&(F^O))+M[0]+3614090360&4294967295;x=I+(R<<7&4294967295|R>>>25),R=O+(F^x&(I^F))+M[1]+3905402710&4294967295,O=x+(R<<12&4294967295|R>>>20),R=F+(I^O&(x^I))+M[2]+606105819&4294967295,F=O+(R<<17&4294967295|R>>>15),R=I+(x^F&(O^x))+M[3]+3250441966&4294967295,I=F+(R<<22&4294967295|R>>>10),R=x+(O^I&(F^O))+M[4]+4118548399&4294967295,x=I+(R<<7&4294967295|R>>>25),R=O+(F^x&(I^F))+M[5]+1200080426&4294967295,O=x+(R<<12&4294967295|R>>>20),R=F+(I^O&(x^I))+M[6]+2821735955&4294967295,F=O+(R<<17&4294967295|R>>>15),R=I+(x^F&(O^x))+M[7]+4249261313&4294967295,I=F+(R<<22&4294967295|R>>>10),R=x+(O^I&(F^O))+M[8]+1770035416&4294967295,x=I+(R<<7&4294967295|R>>>25),R=O+(F^x&(I^F))+M[9]+2336552879&4294967295,O=x+(R<<12&4294967295|R>>>20),R=F+(I^O&(x^I))+M[10]+4294925233&4294967295,F=O+(R<<17&4294967295|R>>>15),R=I+(x^F&(O^x))+M[11]+2304563134&4294967295,I=F+(R<<22&4294967295|R>>>10),R=x+(O^I&(F^O))+M[12]+1804603682&4294967295,x=I+(R<<7&4294967295|R>>>25),R=O+(F^x&(I^F))+M[13]+4254626195&4294967295,O=x+(R<<12&4294967295|R>>>20),R=F+(I^O&(x^I))+M[14]+2792965006&4294967295,F=O+(R<<17&4294967295|R>>>15),R=I+(x^F&(O^x))+M[15]+1236535329&4294967295,I=F+(R<<22&4294967295|R>>>10),R=x+(F^O&(I^F))+M[1]+4129170786&4294967295,x=I+(R<<5&4294967295|R>>>27),R=O+(I^F&(x^I))+M[6]+3225465664&4294967295,O=x+(R<<9&4294967295|R>>>23),R=F+(x^I&(O^x))+M[11]+643717713&4294967295,F=O+(R<<14&4294967295|R>>>18),R=I+(O^x&(F^O))+M[0]+3921069994&4294967295,I=F+(R<<20&4294967295|R>>>12),R=x+(F^O&(I^F))+M[5]+3593408605&4294967295,x=I+(R<<5&4294967295|R>>>27),R=O+(I^F&(x^I))+M[10]+38016083&4294967295,O=x+(R<<9&4294967295|R>>>23),R=F+(x^I&(O^x))+M[15]+3634488961&4294967295,F=O+(R<<14&4294967295|R>>>18),R=I+(O^x&(F^O))+M[4]+3889429448&4294967295,I=F+(R<<20&4294967295|R>>>12),R=x+(F^O&(I^F))+M[9]+568446438&4294967295,x=I+(R<<5&4294967295|R>>>27),R=O+(I^F&(x^I))+M[14]+3275163606&4294967295,O=x+(R<<9&4294967295|R>>>23),R=F+(x^I&(O^x))+M[3]+4107603335&4294967295,F=O+(R<<14&4294967295|R>>>18),R=I+(O^x&(F^O))+M[8]+1163531501&4294967295,I=F+(R<<20&4294967295|R>>>12),R=x+(F^O&(I^F))+M[13]+2850285829&4294967295,x=I+(R<<5&4294967295|R>>>27),R=O+(I^F&(x^I))+M[2]+4243563512&4294967295,O=x+(R<<9&4294967295|R>>>23),R=F+(x^I&(O^x))+M[7]+1735328473&4294967295,F=O+(R<<14&4294967295|R>>>18),R=I+(O^x&(F^O))+M[12]+2368359562&4294967295,I=F+(R<<20&4294967295|R>>>12),R=x+(I^F^O)+M[5]+4294588738&4294967295,x=I+(R<<4&4294967295|R>>>28),R=O+(x^I^F)+M[8]+2272392833&4294967295,O=x+(R<<11&4294967295|R>>>21),R=F+(O^x^I)+M[11]+1839030562&4294967295,F=O+(R<<16&4294967295|R>>>16),R=I+(F^O^x)+M[14]+4259657740&4294967295,I=F+(R<<23&4294967295|R>>>9),R=x+(I^F^O)+M[1]+2763975236&4294967295,x=I+(R<<4&4294967295|R>>>28),R=O+(x^I^F)+M[4]+1272893353&4294967295,O=x+(R<<11&4294967295|R>>>21),R=F+(O^x^I)+M[7]+4139469664&4294967295,F=O+(R<<16&4294967295|R>>>16),R=I+(F^O^x)+M[10]+3200236656&4294967295,I=F+(R<<23&4294967295|R>>>9),R=x+(I^F^O)+M[13]+681279174&4294967295,x=I+(R<<4&4294967295|R>>>28),R=O+(x^I^F)+M[0]+3936430074&4294967295,O=x+(R<<11&4294967295|R>>>21),R=F+(O^x^I)+M[3]+3572445317&4294967295,F=O+(R<<16&4294967295|R>>>16),R=I+(F^O^x)+M[6]+76029189&4294967295,I=F+(R<<23&4294967295|R>>>9),R=x+(I^F^O)+M[9]+3654602809&4294967295,x=I+(R<<4&4294967295|R>>>28),R=O+(x^I^F)+M[12]+3873151461&4294967295,O=x+(R<<11&4294967295|R>>>21),R=F+(O^x^I)+M[15]+530742520&4294967295,F=O+(R<<16&4294967295|R>>>16),R=I+(F^O^x)+M[2]+3299628645&4294967295,I=F+(R<<23&4294967295|R>>>9),R=x+(F^(I|~O))+M[0]+4096336452&4294967295,x=I+(R<<6&4294967295|R>>>26),R=O+(I^(x|~F))+M[7]+1126891415&4294967295,O=x+(R<<10&4294967295|R>>>22),R=F+(x^(O|~I))+M[14]+2878612391&4294967295,F=O+(R<<15&4294967295|R>>>17),R=I+(O^(F|~x))+M[5]+4237533241&4294967295,I=F+(R<<21&4294967295|R>>>11),R=x+(F^(I|~O))+M[12]+1700485571&4294967295,x=I+(R<<6&4294967295|R>>>26),R=O+(I^(x|~F))+M[3]+2399980690&4294967295,O=x+(R<<10&4294967295|R>>>22),R=F+(x^(O|~I))+M[10]+4293915773&4294967295,F=O+(R<<15&4294967295|R>>>17),R=I+(O^(F|~x))+M[1]+2240044497&4294967295,I=F+(R<<21&4294967295|R>>>11),R=x+(F^(I|~O))+M[8]+1873313359&4294967295,x=I+(R<<6&4294967295|R>>>26),R=O+(I^(x|~F))+M[15]+4264355552&4294967295,O=x+(R<<10&4294967295|R>>>22),R=F+(x^(O|~I))+M[6]+2734768916&4294967295,F=O+(R<<15&4294967295|R>>>17),R=I+(O^(F|~x))+M[13]+1309151649&4294967295,I=F+(R<<21&4294967295|R>>>11),R=x+(F^(I|~O))+M[4]+4149444226&4294967295,x=I+(R<<6&4294967295|R>>>26),R=O+(I^(x|~F))+M[11]+3174756917&4294967295,O=x+(R<<10&4294967295|R>>>22),R=F+(x^(O|~I))+M[2]+718787259&4294967295,F=O+(R<<15&4294967295|R>>>17),R=I+(O^(F|~x))+M[9]+3951481745&4294967295,D.g[0]=D.g[0]+x&4294967295,D.g[1]=D.g[1]+(F+(R<<21&4294967295|R>>>11))&4294967295,D.g[2]=D.g[2]+F&4294967295,D.g[3]=D.g[3]+O&4294967295}i.prototype.u=function(D,x){x===void 0&&(x=D.length);for(var I=x-this.blockSize,M=this.B,F=this.h,O=0;O<x;){if(F==0)for(;O<=I;)n(this,D,O),O+=this.blockSize;if(typeof D=="string"){for(;O<x;)if(M[F++]=D.charCodeAt(O++),F==this.blockSize){n(this,M),F=0;break}}else for(;O<x;)if(M[F++]=D[O++],F==this.blockSize){n(this,M),F=0;break}}this.h=F,this.o+=x},i.prototype.v=function(){var D=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);D[0]=128;for(var x=1;x<D.length-8;++x)D[x]=0;var I=8*this.o;for(x=D.length-8;x<D.length;++x)D[x]=I&255,I/=256;for(this.u(D),D=Array(16),x=I=0;4>x;++x)for(var M=0;32>M;M+=8)D[I++]=this.g[x]>>>M&255;return D};function r(D,x){var I=a;return Object.prototype.hasOwnProperty.call(I,D)?I[D]:I[D]=x(D)}function o(D,x){this.h=x;for(var I=[],M=!0,F=D.length-1;0<=F;F--){var O=D[F]|0;M&&O==x||(I[F]=O,M=!1)}this.g=I}var a={};function l(D){return-128<=D&&128>D?r(D,function(x){return new o([x|0],0>x?-1:0)}):new o([D|0],0>D?-1:0)}function u(D){if(isNaN(D)||!isFinite(D))return d;if(0>D)return E(u(-D));for(var x=[],I=1,M=0;D>=I;M++)x[M]=D/I|0,I*=4294967296;return new o(x,0)}function h(D,x){if(D.length==0)throw Error("number format error: empty string");if(x=x||10,2>x||36<x)throw Error("radix out of range: "+x);if(D.charAt(0)=="-")return E(h(D.substring(1),x));if(0<=D.indexOf("-"))throw Error('number format error: interior "-" character');for(var I=u(Math.pow(x,8)),M=d,F=0;F<D.length;F+=8){var O=Math.min(8,D.length-F),R=parseInt(D.substring(F,F+O),x);8>O?(O=u(Math.pow(x,O)),M=M.j(O).add(u(R))):(M=M.j(I),M=M.add(u(R)))}return M}var d=l(0),f=l(1),m=l(16777216);s=o.prototype,s.m=function(){if(_(this))return-E(this).m();for(var D=0,x=1,I=0;I<this.g.length;I++){var M=this.i(I);D+=(0<=M?M:4294967296+M)*x,x*=4294967296}return D},s.toString=function(D){if(D=D||10,2>D||36<D)throw Error("radix out of range: "+D);if(v(this))return"0";if(_(this))return"-"+E(this).toString(D);for(var x=u(Math.pow(D,6)),I=this,M="";;){var F=W(I,x).g;I=b(I,F.j(x));var O=((0<I.g.length?I.g[0]:I.h)>>>0).toString(D);if(I=F,v(I))return O+M;for(;6>O.length;)O="0"+O;M=O+M}},s.i=function(D){return 0>D?0:D<this.g.length?this.g[D]:this.h};function v(D){if(D.h!=0)return!1;for(var x=0;x<D.g.length;x++)if(D.g[x]!=0)return!1;return!0}function _(D){return D.h==-1}s.l=function(D){return D=b(this,D),_(D)?-1:v(D)?0:1};function E(D){for(var x=D.g.length,I=[],M=0;M<x;M++)I[M]=~D.g[M];return new o(I,~D.h).add(f)}s.abs=function(){return _(this)?E(this):this},s.add=function(D){for(var x=Math.max(this.g.length,D.g.length),I=[],M=0,F=0;F<=x;F++){var O=M+(this.i(F)&65535)+(D.i(F)&65535),R=(O>>>16)+(this.i(F)>>>16)+(D.i(F)>>>16);M=R>>>16,O&=65535,R&=65535,I[F]=R<<16|O}return new o(I,I[I.length-1]&-2147483648?-1:0)};function b(D,x){return D.add(E(x))}s.j=function(D){if(v(this)||v(D))return d;if(_(this))return _(D)?E(this).j(E(D)):E(E(this).j(D));if(_(D))return E(this.j(E(D)));if(0>this.l(m)&&0>D.l(m))return u(this.m()*D.m());for(var x=this.g.length+D.g.length,I=[],M=0;M<2*x;M++)I[M]=0;for(M=0;M<this.g.length;M++)for(var F=0;F<D.g.length;F++){var O=this.i(M)>>>16,R=this.i(M)&65535,ne=D.i(F)>>>16,ee=D.i(F)&65535;I[2*M+2*F]+=R*ee,k(I,2*M+2*F),I[2*M+2*F+1]+=O*ee,k(I,2*M+2*F+1),I[2*M+2*F+1]+=R*ne,k(I,2*M+2*F+1),I[2*M+2*F+2]+=O*ne,k(I,2*M+2*F+2)}for(M=0;M<x;M++)I[M]=I[2*M+1]<<16|I[2*M];for(M=x;M<2*x;M++)I[M]=0;return new o(I,0)};function k(D,x){for(;(D[x]&65535)!=D[x];)D[x+1]+=D[x]>>>16,D[x]&=65535,x++}function V(D,x){this.g=D,this.h=x}function W(D,x){if(v(x))throw Error("division by zero");if(v(D))return new V(d,d);if(_(D))return x=W(E(D),x),new V(E(x.g),E(x.h));if(_(x))return x=W(D,E(x)),new V(E(x.g),x.h);if(30<D.g.length){if(_(D)||_(x))throw Error("slowDivide_ only works with positive integers.");for(var I=f,M=x;0>=M.l(D);)I=z(I),M=z(M);var F=j(I,1),O=j(M,1);for(M=j(M,2),I=j(I,2);!v(M);){var R=O.add(M);0>=R.l(D)&&(F=F.add(I),O=R),M=j(M,1),I=j(I,1)}return x=b(D,F.j(x)),new V(F,x)}for(F=d;0<=D.l(x);){for(I=Math.max(1,Math.floor(D.m()/x.m())),M=Math.ceil(Math.log(I)/Math.LN2),M=48>=M?1:Math.pow(2,M-48),O=u(I),R=O.j(x);_(R)||0<R.l(D);)I-=M,O=u(I),R=O.j(x);v(O)&&(O=f),F=F.add(O),D=b(D,R)}return new V(F,D)}s.A=function(D){return W(this,D).h},s.and=function(D){for(var x=Math.max(this.g.length,D.g.length),I=[],M=0;M<x;M++)I[M]=this.i(M)&D.i(M);return new o(I,this.h&D.h)},s.or=function(D){for(var x=Math.max(this.g.length,D.g.length),I=[],M=0;M<x;M++)I[M]=this.i(M)|D.i(M);return new o(I,this.h|D.h)},s.xor=function(D){for(var x=Math.max(this.g.length,D.g.length),I=[],M=0;M<x;M++)I[M]=this.i(M)^D.i(M);return new o(I,this.h^D.h)};function z(D){for(var x=D.g.length+1,I=[],M=0;M<x;M++)I[M]=D.i(M)<<1|D.i(M-1)>>>31;return new o(I,D.h)}function j(D,x){var I=x>>5;x%=32;for(var M=D.g.length-I,F=[],O=0;O<M;O++)F[O]=0<x?D.i(O+I)>>>x|D.i(O+I+1)<<32-x:D.i(O+I);return new o(F,D.h)}i.prototype.digest=i.prototype.v,i.prototype.reset=i.prototype.s,i.prototype.update=i.prototype.u,Eu=i,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=u,o.fromString=h,ai=o}).apply(typeof Qa<"u"?Qa:typeof self<"u"?self:typeof window<"u"?window:{});var ur=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var xu,vn,bu,mr,Vs,Su,Pu,Cu;(function(){var s,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(c,p,y){return c==Array.prototype||c==Object.prototype||(c[p]=y.value),c};function e(c){c=[typeof globalThis=="object"&&globalThis,c,typeof window=="object"&&window,typeof self=="object"&&self,typeof ur=="object"&&ur];for(var p=0;p<c.length;++p){var y=c[p];if(y&&y.Math==Math)return y}throw Error("Cannot find global object")}var i=e(this);function n(c,p){if(p)e:{var y=i;c=c.split(".");for(var S=0;S<c.length-1;S++){var N=c[S];if(!(N in y))break e;y=y[N]}c=c[c.length-1],S=y[c],p=p(S),p!=S&&p!=null&&t(y,c,{configurable:!0,writable:!0,value:p})}}function r(c,p){c instanceof String&&(c+="");var y=0,S=!1,N={next:function(){if(!S&&y<c.length){var H=y++;return{value:p(H,c[H]),done:!1}}return S=!0,{done:!0,value:void 0}}};return N[Symbol.iterator]=function(){return N},N}n("Array.prototype.values",function(c){return c||function(){return r(this,function(p,y){return y})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var o=o||{},a=this||self;function l(c){var p=typeof c;return p=p!="object"?p:c?Array.isArray(c)?"array":p:"null",p=="array"||p=="object"&&typeof c.length=="number"}function u(c){var p=typeof c;return p=="object"&&c!=null||p=="function"}function h(c,p,y){return c.call.apply(c.bind,arguments)}function d(c,p,y){if(!c)throw Error();if(2<arguments.length){var S=Array.prototype.slice.call(arguments,2);return function(){var N=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(N,S),c.apply(p,N)}}return function(){return c.apply(p,arguments)}}function f(c,p,y){return f=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?h:d,f.apply(null,arguments)}function m(c,p){var y=Array.prototype.slice.call(arguments,1);return function(){var S=y.slice();return S.push.apply(S,arguments),c.apply(this,S)}}function v(c,p){function y(){}y.prototype=p.prototype,c.aa=p.prototype,c.prototype=new y,c.prototype.constructor=c,c.Qb=function(S,N,H){for(var re=Array(arguments.length-2),Ne=2;Ne<arguments.length;Ne++)re[Ne-2]=arguments[Ne];return p.prototype[N].apply(S,re)}}function _(c){const p=c.length;if(0<p){const y=Array(p);for(let S=0;S<p;S++)y[S]=c[S];return y}return[]}function E(c,p){for(let y=1;y<arguments.length;y++){const S=arguments[y];if(l(S)){const N=c.length||0,H=S.length||0;c.length=N+H;for(let re=0;re<H;re++)c[N+re]=S[re]}else c.push(S)}}class b{constructor(p,y){this.i=p,this.j=y,this.h=0,this.g=null}get(){let p;return 0<this.h?(this.h--,p=this.g,this.g=p.next,p.next=null):p=this.i(),p}}function k(c){return/^[\s\xa0]*$/.test(c)}function V(){var c=a.navigator;return c&&(c=c.userAgent)?c:""}function W(c){return W[" "](c),c}W[" "]=function(){};var z=V().indexOf("Gecko")!=-1&&!(V().toLowerCase().indexOf("webkit")!=-1&&V().indexOf("Edge")==-1)&&!(V().indexOf("Trident")!=-1||V().indexOf("MSIE")!=-1)&&V().indexOf("Edge")==-1;function j(c,p,y){for(const S in c)p.call(y,c[S],S,c)}function D(c,p){for(const y in c)p.call(void 0,c[y],y,c)}function x(c){const p={};for(const y in c)p[y]=c[y];return p}const I="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function M(c,p){let y,S;for(let N=1;N<arguments.length;N++){S=arguments[N];for(y in S)c[y]=S[y];for(let H=0;H<I.length;H++)y=I[H],Object.prototype.hasOwnProperty.call(S,y)&&(c[y]=S[y])}}function F(c){var p=1;c=c.split(":");const y=[];for(;0<p&&c.length;)y.push(c.shift()),p--;return c.length&&y.push(c.join(":")),y}function O(c){a.setTimeout(()=>{throw c},0)}function R(){var c=J;let p=null;return c.g&&(p=c.g,c.g=c.g.next,c.g||(c.h=null),p.next=null),p}class ne{constructor(){this.h=this.g=null}add(p,y){const S=ee.get();S.set(p,y),this.h?this.h.next=S:this.g=S,this.h=S}}var ee=new b(()=>new ae,c=>c.reset());class ae{constructor(){this.next=this.g=this.h=null}set(p,y){this.h=p,this.g=y,this.next=null}reset(){this.next=this.g=this.h=null}}let q,Q=!1,J=new ne,se=()=>{const c=a.Promise.resolve(void 0);q=()=>{c.then(xe)}};var xe=()=>{for(var c;c=R();){try{c.h.call(c.g)}catch(y){O(y)}var p=ee;p.j(c),100>p.h&&(p.h++,c.next=p.g,p.g=c)}Q=!1};function pe(){this.s=this.s,this.C=this.C}pe.prototype.s=!1,pe.prototype.ma=function(){this.s||(this.s=!0,this.N())},pe.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function X(c,p){this.type=c,this.g=this.target=p,this.defaultPrevented=!1}X.prototype.h=function(){this.defaultPrevented=!0};var Se=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var c=!1,p=Object.defineProperty({},"passive",{get:function(){c=!0}});try{const y=()=>{};a.addEventListener("test",y,p),a.removeEventListener("test",y,p)}catch{}return c}();function Re(c,p){if(X.call(this,c?c.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,c){var y=this.type=c.type,S=c.changedTouches&&c.changedTouches.length?c.changedTouches[0]:null;if(this.target=c.target||c.srcElement,this.g=p,p=c.relatedTarget){if(z){e:{try{W(p.nodeName);var N=!0;break e}catch{}N=!1}N||(p=null)}}else y=="mouseover"?p=c.fromElement:y=="mouseout"&&(p=c.toElement);this.relatedTarget=p,S?(this.clientX=S.clientX!==void 0?S.clientX:S.pageX,this.clientY=S.clientY!==void 0?S.clientY:S.pageY,this.screenX=S.screenX||0,this.screenY=S.screenY||0):(this.clientX=c.clientX!==void 0?c.clientX:c.pageX,this.clientY=c.clientY!==void 0?c.clientY:c.pageY,this.screenX=c.screenX||0,this.screenY=c.screenY||0),this.button=c.button,this.key=c.key||"",this.ctrlKey=c.ctrlKey,this.altKey=c.altKey,this.shiftKey=c.shiftKey,this.metaKey=c.metaKey,this.pointerId=c.pointerId||0,this.pointerType=typeof c.pointerType=="string"?c.pointerType:tt[c.pointerType]||"",this.state=c.state,this.i=c,c.defaultPrevented&&Re.aa.h.call(this)}}v(Re,X);var tt={2:"touch",3:"pen",4:"mouse"};Re.prototype.h=function(){Re.aa.h.call(this);var c=this.i;c.preventDefault?c.preventDefault():c.returnValue=!1};var We="closure_listenable_"+(1e6*Math.random()|0),pt=0;function lt(c,p,y,S,N){this.listener=c,this.proxy=null,this.src=p,this.type=y,this.capture=!!S,this.ha=N,this.key=++pt,this.da=this.fa=!1}function xt(c){c.da=!0,c.listener=null,c.proxy=null,c.src=null,c.ha=null}function st(c){this.src=c,this.g={},this.h=0}st.prototype.add=function(c,p,y,S,N){var H=c.toString();c=this.g[H],c||(c=this.g[H]=[],this.h++);var re=gt(c,p,S,N);return-1<re?(p=c[re],y||(p.fa=!1)):(p=new lt(p,this.src,H,!!S,N),p.fa=y,c.push(p)),p};function ot(c,p){var y=p.type;if(y in c.g){var S=c.g[y],N=Array.prototype.indexOf.call(S,p,void 0),H;(H=0<=N)&&Array.prototype.splice.call(S,N,1),H&&(xt(p),c.g[y].length==0&&(delete c.g[y],c.h--))}}function gt(c,p,y,S){for(var N=0;N<c.length;++N){var H=c[N];if(!H.da&&H.listener==p&&H.capture==!!y&&H.ha==S)return N}return-1}var mt="closure_lm_"+(1e6*Math.random()|0),le={};function Oe(c,p,y,S,N){if(Array.isArray(p)){for(var H=0;H<p.length;H++)Oe(c,p[H],y,S,N);return null}return y=Pe(y),c&&c[We]?c.K(p,y,u(S)?!!S.capture:!1,N):g(c,p,y,!1,S,N)}function g(c,p,y,S,N,H){if(!p)throw Error("Invalid event type");var re=u(N)?!!N.capture:!!N,Ne=Z(c);if(Ne||(c[mt]=Ne=new st(c)),y=Ne.add(p,y,S,re,H),y.proxy)return y;if(S=P(),y.proxy=S,S.src=c,S.listener=y,c.addEventListener)Se||(N=re),N===void 0&&(N=!1),c.addEventListener(p.toString(),S,N);else if(c.attachEvent)c.attachEvent(te(p.toString()),S);else if(c.addListener&&c.removeListener)c.addListener(S);else throw Error("addEventListener and attachEvent are unavailable.");return y}function P(){function c(y){return p.call(c.src,c.listener,y)}const p=he;return c}function L(c,p,y,S,N){if(Array.isArray(p))for(var H=0;H<p.length;H++)L(c,p[H],y,S,N);else S=u(S)?!!S.capture:!!S,y=Pe(y),c&&c[We]?(c=c.i,p=String(p).toString(),p in c.g&&(H=c.g[p],y=gt(H,y,S,N),-1<y&&(xt(H[y]),Array.prototype.splice.call(H,y,1),H.length==0&&(delete c.g[p],c.h--)))):c&&(c=Z(c))&&(p=c.g[p.toString()],c=-1,p&&(c=gt(p,y,S,N)),(y=-1<c?p[c]:null)&&Y(y))}function Y(c){if(typeof c!="number"&&c&&!c.da){var p=c.src;if(p&&p[We])ot(p.i,c);else{var y=c.type,S=c.proxy;p.removeEventListener?p.removeEventListener(y,S,c.capture):p.detachEvent?p.detachEvent(te(y),S):p.addListener&&p.removeListener&&p.removeListener(S),(y=Z(p))?(ot(y,c),y.h==0&&(y.src=null,p[mt]=null)):xt(c)}}}function te(c){return c in le?le[c]:le[c]="on"+c}function he(c,p){if(c.da)c=!0;else{p=new Re(p,this);var y=c.listener,S=c.ha||c.src;c.fa&&Y(c),c=y.call(S,p)}return c}function Z(c){return c=c[mt],c instanceof st?c:null}var ye="__closure_events_fn_"+(1e9*Math.random()>>>0);function Pe(c){return typeof c=="function"?c:(c[ye]||(c[ye]=function(p){return c.handleEvent(p)}),c[ye])}function Te(){pe.call(this),this.i=new st(this),this.M=this,this.F=null}v(Te,pe),Te.prototype[We]=!0,Te.prototype.removeEventListener=function(c,p,y,S){L(this,c,p,y,S)};function de(c,p){var y,S=c.F;if(S)for(y=[];S;S=S.F)y.push(S);if(c=c.M,S=p.type||p,typeof p=="string")p=new X(p,c);else if(p instanceof X)p.target=p.target||c;else{var N=p;p=new X(S,c),M(p,N)}if(N=!0,y)for(var H=y.length-1;0<=H;H--){var re=p.g=y[H];N=Le(re,S,!0,p)&&N}if(re=p.g=c,N=Le(re,S,!0,p)&&N,N=Le(re,S,!1,p)&&N,y)for(H=0;H<y.length;H++)re=p.g=y[H],N=Le(re,S,!1,p)&&N}Te.prototype.N=function(){if(Te.aa.N.call(this),this.i){var c=this.i,p;for(p in c.g){for(var y=c.g[p],S=0;S<y.length;S++)xt(y[S]);delete c.g[p],c.h--}}this.F=null},Te.prototype.K=function(c,p,y,S){return this.i.add(String(c),p,!1,y,S)},Te.prototype.L=function(c,p,y,S){return this.i.add(String(c),p,!0,y,S)};function Le(c,p,y,S){if(p=c.i.g[String(p)],!p)return!0;p=p.concat();for(var N=!0,H=0;H<p.length;++H){var re=p[H];if(re&&!re.da&&re.capture==y){var Ne=re.listener,ct=re.ha||re.src;re.fa&&ot(c.i,re),N=Ne.call(ct,S)!==!1&&N}}return N&&!S.defaultPrevented}function T(c,p,y){if(typeof c=="function")y&&(c=f(c,y));else if(c&&typeof c.handleEvent=="function")c=f(c.handleEvent,c);else throw Error("Invalid listener argument");return 2147483647<Number(p)?-1:a.setTimeout(c,p||0)}function w(c){c.g=T(()=>{c.g=null,c.i&&(c.i=!1,w(c))},c.l);const p=c.h;c.h=null,c.m.apply(null,p)}class C extends pe{constructor(p,y){super(),this.m=p,this.l=y,this.h=null,this.i=!1,this.g=null}j(p){this.h=arguments,this.g?this.i=!0:w(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function A(c){pe.call(this),this.h=c,this.g={}}v(A,pe);var U=[];function $(c){j(c.g,function(p,y){this.g.hasOwnProperty(y)&&Y(p)},c),c.g={}}A.prototype.N=function(){A.aa.N.call(this),$(this)},A.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var fe=a.JSON.stringify,De=a.JSON.parse,me=class{stringify(c){return a.JSON.stringify(c,void 0)}parse(c){return a.JSON.parse(c,void 0)}};function Ke(){}Ke.prototype.h=null;function je(c){return c.h||(c.h=c.i())}function Dt(){}var kt={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function qt(){X.call(this,"d")}v(qt,X);function Zt(){X.call(this,"c")}v(Zt,X);var ut={},jo=null;function qn(){return jo=jo||new Te}ut.La="serverreachability";function Wo(c){X.call(this,ut.La,c)}v(Wo,X);function on(c){const p=qn();de(p,new Wo(p))}ut.STAT_EVENT="statevent";function Go(c,p){X.call(this,ut.STAT_EVENT,c),this.stat=p}v(Go,X);function bt(c){const p=qn();de(p,new Go(p,c))}ut.Ma="timingevent";function qo(c,p){X.call(this,ut.Ma,c),this.size=p}v(qo,X);function an(c,p){if(typeof c!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){c()},p)}function ln(){this.g=!0}ln.prototype.xa=function(){this.g=!1};function Qc(c,p,y,S,N,H){c.info(function(){if(c.g)if(H)for(var re="",Ne=H.split("&"),ct=0;ct<Ne.length;ct++){var Me=Ne[ct].split("=");if(1<Me.length){var vt=Me[0];Me=Me[1];var yt=vt.split("_");re=2<=yt.length&&yt[1]=="type"?re+(vt+"="+Me+"&"):re+(vt+"=redacted&")}}else re=null;else re=H;return"XMLHTTP REQ ("+S+") [attempt "+N+"]: "+p+`
`+y+`
`+re})}function Jc(c,p,y,S,N,H,re){c.info(function(){return"XMLHTTP RESP ("+S+") [ attempt "+N+"]: "+p+`
`+y+`
`+H+" "+re})}function ki(c,p,y,S){c.info(function(){return"XMLHTTP TEXT ("+p+"): "+eh(c,y)+(S?" "+S:"")})}function $c(c,p){c.info(function(){return"TIMEOUT: "+p})}ln.prototype.info=function(){};function eh(c,p){if(!c.g)return p;if(!p)return null;try{var y=JSON.parse(p);if(y){for(c=0;c<y.length;c++)if(Array.isArray(y[c])){var S=y[c];if(!(2>S.length)){var N=S[1];if(Array.isArray(N)&&!(1>N.length)){var H=N[0];if(H!="noop"&&H!="stop"&&H!="close")for(var re=1;re<N.length;re++)N[re]=""}}}}return fe(y)}catch{return p}}var Zn={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Zo={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},os;function Xn(){}v(Xn,Ke),Xn.prototype.g=function(){return new XMLHttpRequest},Xn.prototype.i=function(){return{}},os=new Xn;function ei(c,p,y,S){this.j=c,this.i=p,this.l=y,this.R=S||1,this.U=new A(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Xo}function Xo(){this.i=null,this.g="",this.h=!1}var Ko={},as={};function ls(c,p,y){c.L=1,c.v=Jn(Xt(p)),c.m=y,c.P=!0,Yo(c,null)}function Yo(c,p){c.F=Date.now(),Kn(c),c.A=Xt(c.v);var y=c.A,S=c.R;Array.isArray(S)||(S=[String(S)]),ca(y.i,"t",S),c.C=0,y=c.j.J,c.h=new Xo,c.g=Ra(c.j,y?p:null,!c.m),0<c.O&&(c.M=new C(f(c.Y,c,c.g),c.O)),p=c.U,y=c.g,S=c.ca;var N="readystatechange";Array.isArray(N)||(N&&(U[0]=N.toString()),N=U);for(var H=0;H<N.length;H++){var re=Oe(y,N[H],S||p.handleEvent,!1,p.h||p);if(!re)break;p.g[re.key]=re}p=c.H?x(c.H):{},c.m?(c.u||(c.u="POST"),p["Content-Type"]="application/x-www-form-urlencoded",c.g.ea(c.A,c.u,c.m,p)):(c.u="GET",c.g.ea(c.A,c.u,null,p)),on(),Qc(c.i,c.u,c.A,c.l,c.R,c.m)}ei.prototype.ca=function(c){c=c.target;const p=this.M;p&&Kt(c)==3?p.j():this.Y(c)},ei.prototype.Y=function(c){try{if(c==this.g)e:{const yt=Kt(this.g);var p=this.g.Ba();const Vi=this.g.Z();if(!(3>yt)&&(yt!=3||this.g&&(this.h.h||this.g.oa()||va(this.g)))){this.J||yt!=4||p==7||(p==8||0>=Vi?on(3):on(2)),us(this);var y=this.g.Z();this.X=y;t:if(Qo(this)){var S=va(this.g);c="";var N=S.length,H=Kt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){_i(this),un(this);var re="";break t}this.h.i=new a.TextDecoder}for(p=0;p<N;p++)this.h.h=!0,c+=this.h.i.decode(S[p],{stream:!(H&&p==N-1)});S.length=0,this.h.g+=c,this.C=0,re=this.h.g}else re=this.g.oa();if(this.o=y==200,Jc(this.i,this.u,this.A,this.l,this.R,yt,y),this.o){if(this.T&&!this.K){t:{if(this.g){var Ne,ct=this.g;if((Ne=ct.g?ct.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!k(Ne)){var Me=Ne;break t}}Me=null}if(y=Me)ki(this.i,this.l,y,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,cs(this,y);else{this.o=!1,this.s=3,bt(12),_i(this),un(this);break e}}if(this.P){y=!0;let Ft;for(;!this.J&&this.C<re.length;)if(Ft=th(this,re),Ft==as){yt==4&&(this.s=4,bt(14),y=!1),ki(this.i,this.l,null,"[Incomplete Response]");break}else if(Ft==Ko){this.s=4,bt(15),ki(this.i,this.l,re,"[Invalid Chunk]"),y=!1;break}else ki(this.i,this.l,Ft,null),cs(this,Ft);if(Qo(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),yt!=4||re.length!=0||this.h.h||(this.s=1,bt(16),y=!1),this.o=this.o&&y,!y)ki(this.i,this.l,re,"[Invalid Chunked Response]"),_i(this),un(this);else if(0<re.length&&!this.W){this.W=!0;var vt=this.j;vt.g==this&&vt.ba&&!vt.M&&(vt.j.info("Great, no buffering proxy detected. Bytes received: "+re.length),ms(vt),vt.M=!0,bt(11))}}else ki(this.i,this.l,re,null),cs(this,re);yt==4&&_i(this),this.o&&!this.J&&(yt==4?ba(this.j,this):(this.o=!1,Kn(this)))}else yh(this.g),y==400&&0<re.indexOf("Unknown SID")?(this.s=3,bt(12)):(this.s=0,bt(13)),_i(this),un(this)}}}catch{}finally{}};function Qo(c){return c.g?c.u=="GET"&&c.L!=2&&c.j.Ca:!1}function th(c,p){var y=c.C,S=p.indexOf(`
`,y);return S==-1?as:(y=Number(p.substring(y,S)),isNaN(y)?Ko:(S+=1,S+y>p.length?as:(p=p.slice(S,S+y),c.C=S+y,p)))}ei.prototype.cancel=function(){this.J=!0,_i(this)};function Kn(c){c.S=Date.now()+c.I,Jo(c,c.I)}function Jo(c,p){if(c.B!=null)throw Error("WatchDog timer not null");c.B=an(f(c.ba,c),p)}function us(c){c.B&&(a.clearTimeout(c.B),c.B=null)}ei.prototype.ba=function(){this.B=null;const c=Date.now();0<=c-this.S?($c(this.i,this.A),this.L!=2&&(on(),bt(17)),_i(this),this.s=2,un(this)):Jo(this,this.S-c)};function un(c){c.j.G==0||c.J||ba(c.j,c)}function _i(c){us(c);var p=c.M;p&&typeof p.ma=="function"&&p.ma(),c.M=null,$(c.U),c.g&&(p=c.g,c.g=null,p.abort(),p.ma())}function cs(c,p){try{var y=c.j;if(y.G!=0&&(y.g==c||hs(y.h,c))){if(!c.K&&hs(y.h,c)&&y.G==3){try{var S=y.Da.g.parse(p)}catch{S=null}if(Array.isArray(S)&&S.length==3){var N=S;if(N[0]==0){e:if(!y.u){if(y.g)if(y.g.F+3e3<c.F)rr(y),ir(y);else break e;gs(y),bt(18)}}else y.za=N[1],0<y.za-y.T&&37500>N[2]&&y.F&&y.v==0&&!y.C&&(y.C=an(f(y.Za,y),6e3));if(1>=ta(y.h)&&y.ca){try{y.ca()}catch{}y.ca=void 0}}else Ei(y,11)}else if((c.K||y.g==c)&&rr(y),!k(p))for(N=y.Da.g.parse(p),p=0;p<N.length;p++){let Me=N[p];if(y.T=Me[0],Me=Me[1],y.G==2)if(Me[0]=="c"){y.K=Me[1],y.ia=Me[2];const vt=Me[3];vt!=null&&(y.la=vt,y.j.info("VER="+y.la));const yt=Me[4];yt!=null&&(y.Aa=yt,y.j.info("SVER="+y.Aa));const Vi=Me[5];Vi!=null&&typeof Vi=="number"&&0<Vi&&(S=1.5*Vi,y.L=S,y.j.info("backChannelRequestTimeoutMs_="+S)),S=y;const Ft=c.g;if(Ft){const or=Ft.g?Ft.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(or){var H=S.h;H.g||or.indexOf("spdy")==-1&&or.indexOf("quic")==-1&&or.indexOf("h2")==-1||(H.j=H.l,H.g=new Set,H.h&&(ds(H,H.h),H.h=null))}if(S.D){const vs=Ft.g?Ft.g.getResponseHeader("X-HTTP-Session-Id"):null;vs&&(S.ya=vs,ze(S.I,S.D,vs))}}y.G=3,y.l&&y.l.ua(),y.ba&&(y.R=Date.now()-c.F,y.j.info("Handshake RTT: "+y.R+"ms")),S=y;var re=c;if(S.qa=Ca(S,S.J?S.ia:null,S.W),re.K){ia(S.h,re);var Ne=re,ct=S.L;ct&&(Ne.I=ct),Ne.B&&(us(Ne),Kn(Ne)),S.g=re}else Ea(S);0<y.i.length&&nr(y)}else Me[0]!="stop"&&Me[0]!="close"||Ei(y,7);else y.G==3&&(Me[0]=="stop"||Me[0]=="close"?Me[0]=="stop"?Ei(y,7):ps(y):Me[0]!="noop"&&y.l&&y.l.ta(Me),y.v=0)}}on(4)}catch{}}var ih=class{constructor(c,p){this.g=c,this.map=p}};function $o(c){this.l=c||10,a.PerformanceNavigationTiming?(c=a.performance.getEntriesByType("navigation"),c=0<c.length&&(c[0].nextHopProtocol=="hq"||c[0].nextHopProtocol=="h2")):c=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=c?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function ea(c){return c.h?!0:c.g?c.g.size>=c.j:!1}function ta(c){return c.h?1:c.g?c.g.size:0}function hs(c,p){return c.h?c.h==p:c.g?c.g.has(p):!1}function ds(c,p){c.g?c.g.add(p):c.h=p}function ia(c,p){c.h&&c.h==p?c.h=null:c.g&&c.g.has(p)&&c.g.delete(p)}$o.prototype.cancel=function(){if(this.i=na(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const c of this.g.values())c.cancel();this.g.clear()}};function na(c){if(c.h!=null)return c.i.concat(c.h.D);if(c.g!=null&&c.g.size!==0){let p=c.i;for(const y of c.g.values())p=p.concat(y.D);return p}return _(c.i)}function nh(c){if(c.V&&typeof c.V=="function")return c.V();if(typeof Map<"u"&&c instanceof Map||typeof Set<"u"&&c instanceof Set)return Array.from(c.values());if(typeof c=="string")return c.split("");if(l(c)){for(var p=[],y=c.length,S=0;S<y;S++)p.push(c[S]);return p}p=[],y=0;for(S in c)p[y++]=c[S];return p}function rh(c){if(c.na&&typeof c.na=="function")return c.na();if(!c.V||typeof c.V!="function"){if(typeof Map<"u"&&c instanceof Map)return Array.from(c.keys());if(!(typeof Set<"u"&&c instanceof Set)){if(l(c)||typeof c=="string"){var p=[];c=c.length;for(var y=0;y<c;y++)p.push(y);return p}p=[],y=0;for(const S in c)p[y++]=S;return p}}}function ra(c,p){if(c.forEach&&typeof c.forEach=="function")c.forEach(p,void 0);else if(l(c)||typeof c=="string")Array.prototype.forEach.call(c,p,void 0);else for(var y=rh(c),S=nh(c),N=S.length,H=0;H<N;H++)p.call(void 0,S[H],y&&y[H],c)}var sa=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function sh(c,p){if(c){c=c.split("&");for(var y=0;y<c.length;y++){var S=c[y].indexOf("="),N=null;if(0<=S){var H=c[y].substring(0,S);N=c[y].substring(S+1)}else H=c[y];p(H,N?decodeURIComponent(N.replace(/\+/g," ")):"")}}}function Ti(c){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,c instanceof Ti){this.h=c.h,Yn(this,c.j),this.o=c.o,this.g=c.g,Qn(this,c.s),this.l=c.l;var p=c.i,y=new dn;y.i=p.i,p.g&&(y.g=new Map(p.g),y.h=p.h),oa(this,y),this.m=c.m}else c&&(p=String(c).match(sa))?(this.h=!1,Yn(this,p[1]||"",!0),this.o=cn(p[2]||""),this.g=cn(p[3]||"",!0),Qn(this,p[4]),this.l=cn(p[5]||"",!0),oa(this,p[6]||"",!0),this.m=cn(p[7]||"")):(this.h=!1,this.i=new dn(null,this.h))}Ti.prototype.toString=function(){var c=[],p=this.j;p&&c.push(hn(p,aa,!0),":");var y=this.g;return(y||p=="file")&&(c.push("//"),(p=this.o)&&c.push(hn(p,aa,!0),"@"),c.push(encodeURIComponent(String(y)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),y=this.s,y!=null&&c.push(":",String(y))),(y=this.l)&&(this.g&&y.charAt(0)!="/"&&c.push("/"),c.push(hn(y,y.charAt(0)=="/"?lh:ah,!0))),(y=this.i.toString())&&c.push("?",y),(y=this.m)&&c.push("#",hn(y,ch)),c.join("")};function Xt(c){return new Ti(c)}function Yn(c,p,y){c.j=y?cn(p,!0):p,c.j&&(c.j=c.j.replace(/:$/,""))}function Qn(c,p){if(p){if(p=Number(p),isNaN(p)||0>p)throw Error("Bad port number "+p);c.s=p}else c.s=null}function oa(c,p,y){p instanceof dn?(c.i=p,hh(c.i,c.h)):(y||(p=hn(p,uh)),c.i=new dn(p,c.h))}function ze(c,p,y){c.i.set(p,y)}function Jn(c){return ze(c,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),c}function cn(c,p){return c?p?decodeURI(c.replace(/%25/g,"%2525")):decodeURIComponent(c):""}function hn(c,p,y){return typeof c=="string"?(c=encodeURI(c).replace(p,oh),y&&(c=c.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),c):null}function oh(c){return c=c.charCodeAt(0),"%"+(c>>4&15).toString(16)+(c&15).toString(16)}var aa=/[#\/\?@]/g,ah=/[#\?:]/g,lh=/[#\?]/g,uh=/[#\?@]/g,ch=/#/g;function dn(c,p){this.h=this.g=null,this.i=c||null,this.j=!!p}function ti(c){c.g||(c.g=new Map,c.h=0,c.i&&sh(c.i,function(p,y){c.add(decodeURIComponent(p.replace(/\+/g," ")),y)}))}s=dn.prototype,s.add=function(c,p){ti(this),this.i=null,c=Fi(this,c);var y=this.g.get(c);return y||this.g.set(c,y=[]),y.push(p),this.h+=1,this};function la(c,p){ti(c),p=Fi(c,p),c.g.has(p)&&(c.i=null,c.h-=c.g.get(p).length,c.g.delete(p))}function ua(c,p){return ti(c),p=Fi(c,p),c.g.has(p)}s.forEach=function(c,p){ti(this),this.g.forEach(function(y,S){y.forEach(function(N){c.call(p,N,S,this)},this)},this)},s.na=function(){ti(this);const c=Array.from(this.g.values()),p=Array.from(this.g.keys()),y=[];for(let S=0;S<p.length;S++){const N=c[S];for(let H=0;H<N.length;H++)y.push(p[S])}return y},s.V=function(c){ti(this);let p=[];if(typeof c=="string")ua(this,c)&&(p=p.concat(this.g.get(Fi(this,c))));else{c=Array.from(this.g.values());for(let y=0;y<c.length;y++)p=p.concat(c[y])}return p},s.set=function(c,p){return ti(this),this.i=null,c=Fi(this,c),ua(this,c)&&(this.h-=this.g.get(c).length),this.g.set(c,[p]),this.h+=1,this},s.get=function(c,p){return c?(c=this.V(c),0<c.length?String(c[0]):p):p};function ca(c,p,y){la(c,p),0<y.length&&(c.i=null,c.g.set(Fi(c,p),_(y)),c.h+=y.length)}s.toString=function(){if(this.i)return this.i;if(!this.g)return"";const c=[],p=Array.from(this.g.keys());for(var y=0;y<p.length;y++){var S=p[y];const H=encodeURIComponent(String(S)),re=this.V(S);for(S=0;S<re.length;S++){var N=H;re[S]!==""&&(N+="="+encodeURIComponent(String(re[S]))),c.push(N)}}return this.i=c.join("&")};function Fi(c,p){return p=String(p),c.j&&(p=p.toLowerCase()),p}function hh(c,p){p&&!c.j&&(ti(c),c.i=null,c.g.forEach(function(y,S){var N=S.toLowerCase();S!=N&&(la(this,S),ca(this,N,y))},c)),c.j=p}function dh(c,p){const y=new ln;if(a.Image){const S=new Image;S.onload=m(ii,y,"TestLoadImage: loaded",!0,p,S),S.onerror=m(ii,y,"TestLoadImage: error",!1,p,S),S.onabort=m(ii,y,"TestLoadImage: abort",!1,p,S),S.ontimeout=m(ii,y,"TestLoadImage: timeout",!1,p,S),a.setTimeout(function(){S.ontimeout&&S.ontimeout()},1e4),S.src=c}else p(!1)}function fh(c,p){const y=new ln,S=new AbortController,N=setTimeout(()=>{S.abort(),ii(y,"TestPingServer: timeout",!1,p)},1e4);fetch(c,{signal:S.signal}).then(H=>{clearTimeout(N),H.ok?ii(y,"TestPingServer: ok",!0,p):ii(y,"TestPingServer: server error",!1,p)}).catch(()=>{clearTimeout(N),ii(y,"TestPingServer: error",!1,p)})}function ii(c,p,y,S,N){try{N&&(N.onload=null,N.onerror=null,N.onabort=null,N.ontimeout=null),S(y)}catch{}}function ph(){this.g=new me}function gh(c,p,y){const S=y||"";try{ra(c,function(N,H){let re=N;u(N)&&(re=fe(N)),p.push(S+H+"="+encodeURIComponent(re))})}catch(N){throw p.push(S+"type="+encodeURIComponent("_badmap")),N}}function $n(c){this.l=c.Ub||null,this.j=c.eb||!1}v($n,Ke),$n.prototype.g=function(){return new er(this.l,this.j)},$n.prototype.i=function(c){return function(){return c}}({});function er(c,p){Te.call(this),this.D=c,this.o=p,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}v(er,Te),s=er.prototype,s.open=function(c,p){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=c,this.A=p,this.readyState=1,pn(this)},s.send=function(c){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const p={headers:this.u,method:this.B,credentials:this.m,cache:void 0};c&&(p.body=c),(this.D||a).fetch(new Request(this.A,p)).then(this.Sa.bind(this),this.ga.bind(this))},s.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,fn(this)),this.readyState=0},s.Sa=function(c){if(this.g&&(this.l=c,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=c.headers,this.readyState=2,pn(this)),this.g&&(this.readyState=3,pn(this),this.g)))if(this.responseType==="arraybuffer")c.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in c){if(this.j=c.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;ha(this)}else c.text().then(this.Ra.bind(this),this.ga.bind(this))};function ha(c){c.j.read().then(c.Pa.bind(c)).catch(c.ga.bind(c))}s.Pa=function(c){if(this.g){if(this.o&&c.value)this.response.push(c.value);else if(!this.o){var p=c.value?c.value:new Uint8Array(0);(p=this.v.decode(p,{stream:!c.done}))&&(this.response=this.responseText+=p)}c.done?fn(this):pn(this),this.readyState==3&&ha(this)}},s.Ra=function(c){this.g&&(this.response=this.responseText=c,fn(this))},s.Qa=function(c){this.g&&(this.response=c,fn(this))},s.ga=function(){this.g&&fn(this)};function fn(c){c.readyState=4,c.l=null,c.j=null,c.v=null,pn(c)}s.setRequestHeader=function(c,p){this.u.append(c,p)},s.getResponseHeader=function(c){return this.h&&this.h.get(c.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const c=[],p=this.h.entries();for(var y=p.next();!y.done;)y=y.value,c.push(y[0]+": "+y[1]),y=p.next();return c.join(`\r
`)};function pn(c){c.onreadystatechange&&c.onreadystatechange.call(c)}Object.defineProperty(er.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(c){this.m=c?"include":"same-origin"}});function da(c){let p="";return j(c,function(y,S){p+=S,p+=":",p+=y,p+=`\r
`}),p}function fs(c,p,y){e:{for(S in y){var S=!1;break e}S=!0}S||(y=da(y),typeof c=="string"?y!=null&&encodeURIComponent(String(y)):ze(c,p,y))}function qe(c){Te.call(this),this.headers=new Map,this.o=c||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}v(qe,Te);var mh=/^https?$/i,vh=["POST","PUT"];s=qe.prototype,s.Ha=function(c){this.J=c},s.ea=function(c,p,y,S){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+c);p=p?p.toUpperCase():"GET",this.D=c,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():os.g(),this.v=this.o?je(this.o):je(os),this.g.onreadystatechange=f(this.Ea,this);try{this.B=!0,this.g.open(p,String(c),!0),this.B=!1}catch(H){fa(this,H);return}if(c=y||"",y=new Map(this.headers),S)if(Object.getPrototypeOf(S)===Object.prototype)for(var N in S)y.set(N,S[N]);else if(typeof S.keys=="function"&&typeof S.get=="function")for(const H of S.keys())y.set(H,S.get(H));else throw Error("Unknown input type for opt_headers: "+String(S));S=Array.from(y.keys()).find(H=>H.toLowerCase()=="content-type"),N=a.FormData&&c instanceof a.FormData,!(0<=Array.prototype.indexOf.call(vh,p,void 0))||S||N||y.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[H,re]of y)this.g.setRequestHeader(H,re);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{ma(this),this.u=!0,this.g.send(c),this.u=!1}catch(H){fa(this,H)}};function fa(c,p){c.h=!1,c.g&&(c.j=!0,c.g.abort(),c.j=!1),c.l=p,c.m=5,pa(c),tr(c)}function pa(c){c.A||(c.A=!0,de(c,"complete"),de(c,"error"))}s.abort=function(c){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=c||7,de(this,"complete"),de(this,"abort"),tr(this))},s.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),tr(this,!0)),qe.aa.N.call(this)},s.Ea=function(){this.s||(this.B||this.u||this.j?ga(this):this.bb())},s.bb=function(){ga(this)};function ga(c){if(c.h&&typeof o<"u"&&(!c.v[1]||Kt(c)!=4||c.Z()!=2)){if(c.u&&Kt(c)==4)T(c.Ea,0,c);else if(de(c,"readystatechange"),Kt(c)==4){c.h=!1;try{const re=c.Z();e:switch(re){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var p=!0;break e;default:p=!1}var y;if(!(y=p)){var S;if(S=re===0){var N=String(c.D).match(sa)[1]||null;!N&&a.self&&a.self.location&&(N=a.self.location.protocol.slice(0,-1)),S=!mh.test(N?N.toLowerCase():"")}y=S}if(y)de(c,"complete"),de(c,"success");else{c.m=6;try{var H=2<Kt(c)?c.g.statusText:""}catch{H=""}c.l=H+" ["+c.Z()+"]",pa(c)}}finally{tr(c)}}}}function tr(c,p){if(c.g){ma(c);const y=c.g,S=c.v[0]?()=>{}:null;c.g=null,c.v=null,p||de(c,"ready");try{y.onreadystatechange=S}catch{}}}function ma(c){c.I&&(a.clearTimeout(c.I),c.I=null)}s.isActive=function(){return!!this.g};function Kt(c){return c.g?c.g.readyState:0}s.Z=function(){try{return 2<Kt(this)?this.g.status:-1}catch{return-1}},s.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},s.Oa=function(c){if(this.g){var p=this.g.responseText;return c&&p.indexOf(c)==0&&(p=p.substring(c.length)),De(p)}};function va(c){try{if(!c.g)return null;if("response"in c.g)return c.g.response;switch(c.H){case"":case"text":return c.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in c.g)return c.g.mozResponseArrayBuffer}return null}catch{return null}}function yh(c){const p={};c=(c.g&&2<=Kt(c)&&c.g.getAllResponseHeaders()||"").split(`\r
`);for(let S=0;S<c.length;S++){if(k(c[S]))continue;var y=F(c[S]);const N=y[0];if(y=y[1],typeof y!="string")continue;y=y.trim();const H=p[N]||[];p[N]=H,H.push(y)}D(p,function(S){return S.join(", ")})}s.Ba=function(){return this.m},s.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function gn(c,p,y){return y&&y.internalChannelParams&&y.internalChannelParams[c]||p}function ya(c){this.Aa=0,this.i=[],this.j=new ln,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=gn("failFast",!1,c),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=gn("baseRetryDelayMs",5e3,c),this.cb=gn("retryDelaySeedMs",1e4,c),this.Wa=gn("forwardChannelMaxRetries",2,c),this.wa=gn("forwardChannelRequestTimeoutMs",2e4,c),this.pa=c&&c.xmlHttpFactory||void 0,this.Xa=c&&c.Tb||void 0,this.Ca=c&&c.useFetchStreams||!1,this.L=void 0,this.J=c&&c.supportsCrossDomainXhr||!1,this.K="",this.h=new $o(c&&c.concurrentRequestLimit),this.Da=new ph,this.P=c&&c.fastHandshake||!1,this.O=c&&c.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=c&&c.Rb||!1,c&&c.xa&&this.j.xa(),c&&c.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&c&&c.detectBufferingProxy||!1,this.ja=void 0,c&&c.longPollingTimeout&&0<c.longPollingTimeout&&(this.ja=c.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}s=ya.prototype,s.la=8,s.G=1,s.connect=function(c,p,y,S){bt(0),this.W=c,this.H=p||{},y&&S!==void 0&&(this.H.OSID=y,this.H.OAID=S),this.F=this.X,this.I=Ca(this,null,this.W),nr(this)};function ps(c){if(wa(c),c.G==3){var p=c.U++,y=Xt(c.I);if(ze(y,"SID",c.K),ze(y,"RID",p),ze(y,"TYPE","terminate"),mn(c,y),p=new ei(c,c.j,p),p.L=2,p.v=Jn(Xt(y)),y=!1,a.navigator&&a.navigator.sendBeacon)try{y=a.navigator.sendBeacon(p.v.toString(),"")}catch{}!y&&a.Image&&(new Image().src=p.v,y=!0),y||(p.g=Ra(p.j,null),p.g.ea(p.v)),p.F=Date.now(),Kn(p)}Pa(c)}function ir(c){c.g&&(ms(c),c.g.cancel(),c.g=null)}function wa(c){ir(c),c.u&&(a.clearTimeout(c.u),c.u=null),rr(c),c.h.cancel(),c.s&&(typeof c.s=="number"&&a.clearTimeout(c.s),c.s=null)}function nr(c){if(!ea(c.h)&&!c.s){c.s=!0;var p=c.Ga;q||se(),Q||(q(),Q=!0),J.add(p,c),c.B=0}}function wh(c,p){return ta(c.h)>=c.h.j-(c.s?1:0)?!1:c.s?(c.i=p.D.concat(c.i),!0):c.G==1||c.G==2||c.B>=(c.Va?0:c.Wa)?!1:(c.s=an(f(c.Ga,c,p),Sa(c,c.B)),c.B++,!0)}s.Ga=function(c){if(this.s)if(this.s=null,this.G==1){if(!c){this.U=Math.floor(1e5*Math.random()),c=this.U++;const N=new ei(this,this.j,c);let H=this.o;if(this.S&&(H?(H=x(H),M(H,this.S)):H=this.S),this.m!==null||this.O||(N.H=H,H=null),this.P)e:{for(var p=0,y=0;y<this.i.length;y++){t:{var S=this.i[y];if("__data__"in S.map&&(S=S.map.__data__,typeof S=="string")){S=S.length;break t}S=void 0}if(S===void 0)break;if(p+=S,4096<p){p=y;break e}if(p===4096||y===this.i.length-1){p=y+1;break e}}p=1e3}else p=1e3;p=Ta(this,N,p),y=Xt(this.I),ze(y,"RID",c),ze(y,"CVER",22),this.D&&ze(y,"X-HTTP-Session-Id",this.D),mn(this,y),H&&(this.O?p="headers="+encodeURIComponent(String(da(H)))+"&"+p:this.m&&fs(y,this.m,H)),ds(this.h,N),this.Ua&&ze(y,"TYPE","init"),this.P?(ze(y,"$req",p),ze(y,"SID","null"),N.T=!0,ls(N,y,null)):ls(N,y,p),this.G=2}}else this.G==3&&(c?_a(this,c):this.i.length==0||ea(this.h)||_a(this))};function _a(c,p){var y;p?y=p.l:y=c.U++;const S=Xt(c.I);ze(S,"SID",c.K),ze(S,"RID",y),ze(S,"AID",c.T),mn(c,S),c.m&&c.o&&fs(S,c.m,c.o),y=new ei(c,c.j,y,c.B+1),c.m===null&&(y.H=c.o),p&&(c.i=p.D.concat(c.i)),p=Ta(c,y,1e3),y.I=Math.round(.5*c.wa)+Math.round(.5*c.wa*Math.random()),ds(c.h,y),ls(y,S,p)}function mn(c,p){c.H&&j(c.H,function(y,S){ze(p,S,y)}),c.l&&ra({},function(y,S){ze(p,S,y)})}function Ta(c,p,y){y=Math.min(c.i.length,y);var S=c.l?f(c.l.Na,c.l,c):null;e:{var N=c.i;let H=-1;for(;;){const re=["count="+y];H==-1?0<y?(H=N[0].g,re.push("ofs="+H)):H=0:re.push("ofs="+H);let Ne=!0;for(let ct=0;ct<y;ct++){let Me=N[ct].g;const vt=N[ct].map;if(Me-=H,0>Me)H=Math.max(0,N[ct].g-100),Ne=!1;else try{gh(vt,re,"req"+Me+"_")}catch{S&&S(vt)}}if(Ne){S=re.join("&");break e}}}return c=c.i.splice(0,y),p.D=c,S}function Ea(c){if(!c.g&&!c.u){c.Y=1;var p=c.Fa;q||se(),Q||(q(),Q=!0),J.add(p,c),c.v=0}}function gs(c){return c.g||c.u||3<=c.v?!1:(c.Y++,c.u=an(f(c.Fa,c),Sa(c,c.v)),c.v++,!0)}s.Fa=function(){if(this.u=null,xa(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var c=2*this.R;this.j.info("BP detection timer enabled: "+c),this.A=an(f(this.ab,this),c)}},s.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,bt(10),ir(this),xa(this))};function ms(c){c.A!=null&&(a.clearTimeout(c.A),c.A=null)}function xa(c){c.g=new ei(c,c.j,"rpc",c.Y),c.m===null&&(c.g.H=c.o),c.g.O=0;var p=Xt(c.qa);ze(p,"RID","rpc"),ze(p,"SID",c.K),ze(p,"AID",c.T),ze(p,"CI",c.F?"0":"1"),!c.F&&c.ja&&ze(p,"TO",c.ja),ze(p,"TYPE","xmlhttp"),mn(c,p),c.m&&c.o&&fs(p,c.m,c.o),c.L&&(c.g.I=c.L);var y=c.g;c=c.ia,y.L=1,y.v=Jn(Xt(p)),y.m=null,y.P=!0,Yo(y,c)}s.Za=function(){this.C!=null&&(this.C=null,ir(this),gs(this),bt(19))};function rr(c){c.C!=null&&(a.clearTimeout(c.C),c.C=null)}function ba(c,p){var y=null;if(c.g==p){rr(c),ms(c),c.g=null;var S=2}else if(hs(c.h,p))y=p.D,ia(c.h,p),S=1;else return;if(c.G!=0){if(p.o)if(S==1){y=p.m?p.m.length:0,p=Date.now()-p.F;var N=c.B;S=qn(),de(S,new qo(S,y)),nr(c)}else Ea(c);else if(N=p.s,N==3||N==0&&0<p.X||!(S==1&&wh(c,p)||S==2&&gs(c)))switch(y&&0<y.length&&(p=c.h,p.i=p.i.concat(y)),N){case 1:Ei(c,5);break;case 4:Ei(c,10);break;case 3:Ei(c,6);break;default:Ei(c,2)}}}function Sa(c,p){let y=c.Ta+Math.floor(Math.random()*c.cb);return c.isActive()||(y*=2),y*p}function Ei(c,p){if(c.j.info("Error code "+p),p==2){var y=f(c.fb,c),S=c.Xa;const N=!S;S=new Ti(S||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||Yn(S,"https"),Jn(S),N?dh(S.toString(),y):fh(S.toString(),y)}else bt(2);c.G=0,c.l&&c.l.sa(p),Pa(c),wa(c)}s.fb=function(c){c?(this.j.info("Successfully pinged google.com"),bt(2)):(this.j.info("Failed to ping google.com"),bt(1))};function Pa(c){if(c.G=0,c.ka=[],c.l){const p=na(c.h);(p.length!=0||c.i.length!=0)&&(E(c.ka,p),E(c.ka,c.i),c.h.i.length=0,_(c.i),c.i.length=0),c.l.ra()}}function Ca(c,p,y){var S=y instanceof Ti?Xt(y):new Ti(y);if(S.g!="")p&&(S.g=p+"."+S.g),Qn(S,S.s);else{var N=a.location;S=N.protocol,p=p?p+"."+N.hostname:N.hostname,N=+N.port;var H=new Ti(null);S&&Yn(H,S),p&&(H.g=p),N&&Qn(H,N),y&&(H.l=y),S=H}return y=c.D,p=c.ya,y&&p&&ze(S,y,p),ze(S,"VER",c.la),mn(c,S),S}function Ra(c,p,y){if(p&&!c.J)throw Error("Can't create secondary domain capable XhrIo object.");return p=c.Ca&&!c.pa?new qe(new $n({eb:y})):new qe(c.pa),p.Ha(c.J),p}s.isActive=function(){return!!this.l&&this.l.isActive(this)};function Ia(){}s=Ia.prototype,s.ua=function(){},s.ta=function(){},s.sa=function(){},s.ra=function(){},s.isActive=function(){return!0},s.Na=function(){};function sr(){}sr.prototype.g=function(c,p){return new Ct(c,p)};function Ct(c,p){Te.call(this),this.g=new ya(p),this.l=c,this.h=p&&p.messageUrlParams||null,c=p&&p.messageHeaders||null,p&&p.clientProtocolHeaderRequired&&(c?c["X-Client-Protocol"]="webchannel":c={"X-Client-Protocol":"webchannel"}),this.g.o=c,c=p&&p.initMessageHeaders||null,p&&p.messageContentType&&(c?c["X-WebChannel-Content-Type"]=p.messageContentType:c={"X-WebChannel-Content-Type":p.messageContentType}),p&&p.va&&(c?c["X-WebChannel-Client-Profile"]=p.va:c={"X-WebChannel-Client-Profile":p.va}),this.g.S=c,(c=p&&p.Sb)&&!k(c)&&(this.g.m=c),this.v=p&&p.supportsCrossDomainXhr||!1,this.u=p&&p.sendRawJson||!1,(p=p&&p.httpSessionIdParam)&&!k(p)&&(this.g.D=p,c=this.h,c!==null&&p in c&&(c=this.h,p in c&&delete c[p])),this.j=new Oi(this)}v(Ct,Te),Ct.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Ct.prototype.close=function(){ps(this.g)},Ct.prototype.o=function(c){var p=this.g;if(typeof c=="string"){var y={};y.__data__=c,c=y}else this.u&&(y={},y.__data__=fe(c),c=y);p.i.push(new ih(p.Ya++,c)),p.G==3&&nr(p)},Ct.prototype.N=function(){this.g.l=null,delete this.j,ps(this.g),delete this.g,Ct.aa.N.call(this)};function Aa(c){qt.call(this),c.__headers__&&(this.headers=c.__headers__,this.statusCode=c.__status__,delete c.__headers__,delete c.__status__);var p=c.__sm__;if(p){e:{for(const y in p){c=y;break e}c=void 0}(this.i=c)&&(c=this.i,p=p!==null&&c in p?p[c]:void 0),this.data=p}else this.data=c}v(Aa,qt);function Da(){Zt.call(this),this.status=1}v(Da,Zt);function Oi(c){this.g=c}v(Oi,Ia),Oi.prototype.ua=function(){de(this.g,"a")},Oi.prototype.ta=function(c){de(this.g,new Aa(c))},Oi.prototype.sa=function(c){de(this.g,new Da)},Oi.prototype.ra=function(){de(this.g,"b")},sr.prototype.createWebChannel=sr.prototype.g,Ct.prototype.send=Ct.prototype.o,Ct.prototype.open=Ct.prototype.m,Ct.prototype.close=Ct.prototype.close,Cu=function(){return new sr},Pu=function(){return qn()},Su=ut,Vs={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Zn.NO_ERROR=0,Zn.TIMEOUT=8,Zn.HTTP_ERROR=6,mr=Zn,Zo.COMPLETE="complete",bu=Zo,Dt.EventType=kt,kt.OPEN="a",kt.CLOSE="b",kt.ERROR="c",kt.MESSAGE="d",Te.prototype.listen=Te.prototype.K,vn=Dt,qe.prototype.listenOnce=qe.prototype.L,qe.prototype.getLastError=qe.prototype.Ka,qe.prototype.getLastErrorCode=qe.prototype.Ba,qe.prototype.getStatus=qe.prototype.Z,qe.prototype.getResponseJson=qe.prototype.Oa,qe.prototype.getResponseText=qe.prototype.oa,qe.prototype.send=qe.prototype.ea,qe.prototype.setWithCredentials=qe.prototype.Ha,xu=qe}).apply(typeof ur<"u"?ur:typeof self<"u"?self:typeof window<"u"?window:{});const Ja="@firebase/firestore",$a="4.8.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _t{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}_t.UNAUTHENTICATED=new _t(null),_t.GOOGLE_CREDENTIALS=new _t("google-credentials-uid"),_t.FIRST_PARTY=new _t("first-party-uid"),_t.MOCK_USER=new _t("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let en="11.10.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ri=new mu("@firebase/firestore");function Ni(){return Ri.logLevel}function ce(s,...t){if(Ri.logLevel<=Ae.DEBUG){const e=t.map(ao);Ri.debug(`Firestore (${en}): ${s}`,...e)}}function Jt(s,...t){if(Ri.logLevel<=Ae.ERROR){const e=t.map(ao);Ri.error(`Firestore (${en}): ${s}`,...e)}}function ci(s,...t){if(Ri.logLevel<=Ae.WARN){const e=t.map(ao);Ri.warn(`Firestore (${en}): ${s}`,...e)}}function ao(s){if(typeof s=="string")return s;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(e){return JSON.stringify(e)}(s)}catch{return s}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function we(s,t,e){let i="Unexpected state";typeof t=="string"?i=t:e=t,Ru(s,i,e)}function Ru(s,t,e){let i=`FIRESTORE (${en}) INTERNAL ASSERTION FAILED: ${t} (ID: ${s.toString(16)})`;if(e!==void 0)try{i+=" CONTEXT: "+JSON.stringify(e)}catch{i+=" CONTEXT: "+e}throw Jt(i),new Error(i)}function Fe(s,t,e,i){let n="Unexpected state";typeof e=="string"?n=e:i=e,s||Ru(t,n,i)}function Ee(s,t){return s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const G={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class ue extends $i{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pi{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Iu{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Rp{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(_t.UNAUTHENTICATED))}shutdown(){}}class Ip{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class Ap{constructor(t){this.t=t,this.currentUser=_t.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){Fe(this.o===void 0,42304);let i=this.i;const n=l=>this.i!==i?(i=this.i,e(l)):Promise.resolve();let r=new Pi;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Pi,t.enqueueRetryable(()=>n(this.currentUser))};const o=()=>{const l=r;t.enqueueRetryable(async()=>{await l.promise,await n(this.currentUser)})},a=l=>{ce("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=l,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(l=>a(l)),setTimeout(()=>{if(!this.auth){const l=this.t.getImmediate({optional:!0});l?a(l):(ce("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Pi)}},0),o()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(i=>this.i!==t?(ce("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):i?(Fe(typeof i.accessToken=="string",31837,{l:i}),new Iu(i.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return Fe(t===null||typeof t=="string",2055,{h:t}),new _t(t)}}class Dp{constructor(t,e,i){this.P=t,this.T=e,this.I=i,this.type="FirstParty",this.user=_t.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const t=this.R();return t&&this.A.set("Authorization",t),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class Mp{constructor(t,e,i){this.P=t,this.T=e,this.I=i}getToken(){return Promise.resolve(new Dp(this.P,this.T,this.I))}start(t,e){t.enqueueRetryable(()=>e(_t.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class el{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class kp{constructor(t,e){this.V=e,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,fp(t)&&t.settings.appCheckToken&&(this.p=t.settings.appCheckToken)}start(t,e){Fe(this.o===void 0,3512);const i=r=>{r.error!=null&&ce("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${r.error.message}`);const o=r.token!==this.m;return this.m=r.token,ce("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(r.token):Promise.resolve()};this.o=r=>{t.enqueueRetryable(()=>i(r))};const n=r=>{ce("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=r,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(r=>n(r)),setTimeout(()=>{if(!this.appCheck){const r=this.V.getImmediate({optional:!0});r?n(r):ce("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new el(this.p));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(Fe(typeof e.token=="string",44558,{tokenResult:e}),this.m=e.token,new el(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fp(s){const t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(s);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let i=0;i<s;i++)e[i]=Math.floor(256*Math.random());return e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Au(){return new TextEncoder}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lo{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=62*Math.floor(4.129032258064516);let i="";for(;i.length<20;){const n=Fp(40);for(let r=0;r<n.length;++r)i.length<20&&n[r]<e&&(i+=t.charAt(n[r]%62))}return i}}function be(s,t){return s<t?-1:s>t?1:0}function Ls(s,t){let e=0;for(;e<s.length&&e<t.length;){const i=s.codePointAt(e),n=t.codePointAt(e);if(i!==n){if(i<128&&n<128)return be(i,n);{const r=Au(),o=Op(r.encode(tl(s,e)),r.encode(tl(t,e)));return o!==0?o:be(i,n)}}e+=i>65535?2:1}return be(s.length,t.length)}function tl(s,t){return s.codePointAt(t)>65535?s.substring(t,t+2):s.substring(t,t+1)}function Op(s,t){for(let e=0;e<s.length&&e<t.length;++e)if(s[e]!==t[e])return be(s[e],t[e]);return be(s.length,t.length)}function qi(s,t,e){return s.length===t.length&&s.every((i,n)=>e(i,t[n]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const il="__name__";class Nt{constructor(t,e,i){e===void 0?e=0:e>t.length&&we(637,{offset:e,range:t.length}),i===void 0?i=t.length-e:i>t.length-e&&we(1746,{length:i,range:t.length-e}),this.segments=t,this.offset=e,this.len=i}get length(){return this.len}isEqual(t){return Nt.comparator(this,t)===0}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Nt?t.forEach(i=>{e.push(i)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,i=this.limit();e<i;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const i=Math.min(t.length,e.length);for(let n=0;n<i;n++){const r=Nt.compareSegments(t.get(n),e.get(n));if(r!==0)return r}return be(t.length,e.length)}static compareSegments(t,e){const i=Nt.isNumericId(t),n=Nt.isNumericId(e);return i&&!n?-1:!i&&n?1:i&&n?Nt.extractNumericId(t).compare(Nt.extractNumericId(e)):Ls(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return ai.fromString(t.substring(4,t.length-2))}}class Be extends Nt{construct(t,e,i){return new Be(t,e,i)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const i of t){if(i.indexOf("//")>=0)throw new ue(G.INVALID_ARGUMENT,`Invalid segment (${i}). Paths must not contain // in them.`);e.push(...i.split("/").filter(n=>n.length>0))}return new Be(e)}static emptyPath(){return new Be([])}}const Vp=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class dt extends Nt{construct(t,e,i){return new dt(t,e,i)}static isValidIdentifier(t){return Vp.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),dt.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)===il}static keyField(){return new dt([il])}static fromServerFormat(t){const e=[];let i="",n=0;const r=()=>{if(i.length===0)throw new ue(G.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(i),i=""};let o=!1;for(;n<t.length;){const a=t[n];if(a==="\\"){if(n+1===t.length)throw new ue(G.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const l=t[n+1];if(l!=="\\"&&l!=="."&&l!=="`")throw new ue(G.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=l,n+=2}else a==="`"?(o=!o,n++):a!=="."||o?(i+=a,n++):(r(),n++)}if(r(),o)throw new ue(G.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new dt(e)}static emptyPath(){return new dt([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ve{constructor(t){this.path=t}static fromPath(t){return new ve(Be.fromString(t))}static fromName(t){return new ve(Be.fromString(t).popFirst(5))}static empty(){return new ve(Be.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Be.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Be.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ve(new Be(t.slice()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Du(s,t,e){if(!e)throw new ue(G.INVALID_ARGUMENT,`Function ${s}() cannot be called with an empty ${t}.`)}function Lp(s,t,e,i){if(t===!0&&i===!0)throw new ue(G.INVALID_ARGUMENT,`${s} and ${e} cannot be used together.`)}function nl(s){if(!ve.isDocumentKey(s))throw new ue(G.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${s} has ${s.length}.`)}function rl(s){if(ve.isDocumentKey(s))throw new ue(G.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${s} has ${s.length}.`)}function Mu(s){return typeof s=="object"&&s!==null&&(Object.getPrototypeOf(s)===Object.prototype||Object.getPrototypeOf(s)===null)}function jr(s){if(s===void 0)return"undefined";if(s===null)return"null";if(typeof s=="string")return s.length>20&&(s=`${s.substring(0,20)}...`),JSON.stringify(s);if(typeof s=="number"||typeof s=="boolean")return""+s;if(typeof s=="object"){if(s instanceof Array)return"an array";{const t=function(i){return i.constructor?i.constructor.name:null}(s);return t?`a custom ${t} object`:"an object"}}return typeof s=="function"?"a function":we(12329,{type:typeof s})}function li(s,t){if("_delegate"in s&&(s=s._delegate),!(s instanceof t)){if(t.name===s.constructor.name)throw new ue(G.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const e=jr(s);throw new ue(G.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return s}/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $e(s,t){const e={typeString:s};return t&&(e.value=t),e}function zn(s,t){if(!Mu(s))throw new ue(G.INVALID_ARGUMENT,"JSON must be an object");let e;for(const i in t)if(t[i]){const n=t[i].typeString,r="value"in t[i]?{value:t[i].value}:void 0;if(!(i in s)){e=`JSON missing required field: '${i}'`;break}const o=s[i];if(n&&typeof o!==n){e=`JSON field '${i}' must be a ${n}.`;break}if(r!==void 0&&o!==r.value){e=`Expected '${i}' field to equal '${r.value}'`;break}}if(e)throw new ue(G.INVALID_ARGUMENT,e);return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sl=-62135596800,ol=1e6;class Ue{static now(){return Ue.fromMillis(Date.now())}static fromDate(t){return Ue.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),i=Math.floor((t-1e3*e)*ol);return new Ue(e,i)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new ue(G.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new ue(G.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<sl)throw new ue(G.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new ue(G.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/ol}_compareTo(t){return this.seconds===t.seconds?be(this.nanoseconds,t.nanoseconds):be(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:Ue._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(t){if(zn(t,Ue._jsonSchema))return new Ue(t.seconds,t.nanoseconds)}valueOf(){const t=this.seconds-sl;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}Ue._jsonSchemaVersion="firestore/timestamp/1.0",Ue._jsonSchema={type:$e("string",Ue._jsonSchemaVersion),seconds:$e("number"),nanoseconds:$e("number")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _e{static fromTimestamp(t){return new _e(t)}static min(){return new _e(new Ue(0,0))}static max(){return new _e(new Ue(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Dn=-1;function Np(s,t){const e=s.toTimestamp().seconds,i=s.toTimestamp().nanoseconds+1,n=_e.fromTimestamp(i===1e9?new Ue(e+1,0):new Ue(e,i));return new hi(n,ve.empty(),t)}function Bp(s){return new hi(s.readTime,s.key,Dn)}class hi{constructor(t,e,i){this.readTime=t,this.documentKey=e,this.largestBatchId=i}static min(){return new hi(_e.min(),ve.empty(),Dn)}static max(){return new hi(_e.max(),ve.empty(),Dn)}}function zp(s,t){let e=s.readTime.compareTo(t.readTime);return e!==0?e:(e=ve.comparator(s.documentKey,t.documentKey),e!==0?e:be(s.largestBatchId,t.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hp="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Up{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function tn(s){if(s.code!==G.FAILED_PRECONDITION||s.message!==Hp)throw s;ce("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class K{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&we(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new K((i,n)=>{this.nextCallback=r=>{this.wrapSuccess(t,r).next(i,n)},this.catchCallback=r=>{this.wrapFailure(e,r).next(i,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof K?e:K.resolve(e)}catch(e){return K.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):K.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):K.reject(e)}static resolve(t){return new K((e,i)=>{e(t)})}static reject(t){return new K((e,i)=>{i(t)})}static waitFor(t){return new K((e,i)=>{let n=0,r=0,o=!1;t.forEach(a=>{++n,a.next(()=>{++r,o&&r===n&&e()},l=>i(l))}),o=!0,r===n&&e()})}static or(t){let e=K.resolve(!1);for(const i of t)e=e.next(n=>n?K.resolve(n):i());return e}static forEach(t,e){const i=[];return t.forEach((n,r)=>{i.push(e.call(this,n,r))}),this.waitFor(i)}static mapArray(t,e){return new K((i,n)=>{const r=t.length,o=new Array(r);let a=0;for(let l=0;l<r;l++){const u=l;e(t[u]).next(h=>{o[u]=h,++a,a===r&&i(o)},h=>n(h))}})}static doWhile(t,e){return new K((i,n)=>{const r=()=>{t()===!0?e().next(()=>{r()},n):i()};r()})}}function jp(s){const t=s.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}function nn(s){return s.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wr{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=i=>this._e(i),this.ae=i=>e.writeSequenceNumber(i))}_e(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ae&&this.ae(t),t}}Wr.ue=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const uo=-1;function Gr(s){return s==null}function Dr(s){return s===0&&1/s==-1/0}function Wp(s){return typeof s=="number"&&Number.isInteger(s)&&!Dr(s)&&s<=Number.MAX_SAFE_INTEGER&&s>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ku="";function Gp(s){let t="";for(let e=0;e<s.length;e++)t.length>0&&(t=al(t)),t=qp(s.get(e),t);return al(t)}function qp(s,t){let e=t;const i=s.length;for(let n=0;n<i;n++){const r=s.charAt(n);switch(r){case"\0":e+="";break;case ku:e+="";break;default:e+=r}}return e}function al(s){return s+ku+""}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ll(s){let t=0;for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t++;return t}function yi(s,t){for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&t(e,s[e])}function Fu(s){for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ge{constructor(t,e){this.comparator=t,this.root=e||ht.EMPTY}insert(t,e){return new Ge(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ht.BLACK,null,null))}remove(t){return new Ge(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ht.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const i=this.comparator(t,e.key);if(i===0)return e.value;i<0?e=e.left:i>0&&(e=e.right)}return null}indexOf(t){let e=0,i=this.root;for(;!i.isEmpty();){const n=this.comparator(t,i.key);if(n===0)return e+i.left.size;n<0?i=i.left:(e+=i.left.size+1,i=i.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,i)=>(t(e,i),!1))}toString(){const t=[];return this.inorderTraversal((e,i)=>(t.push(`${e}:${i}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new cr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new cr(this.root,t,this.comparator,!1)}getReverseIterator(){return new cr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new cr(this.root,t,this.comparator,!0)}}class cr{constructor(t,e,i,n){this.isReverse=n,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?i(t.key,e):1,e&&n&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(r===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class ht{constructor(t,e,i,n,r){this.key=t,this.value=e,this.color=i??ht.RED,this.left=n??ht.EMPTY,this.right=r??ht.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,i,n,r){return new ht(t??this.key,e??this.value,i??this.color,n??this.left,r??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,i){let n=this;const r=i(t,n.key);return n=r<0?n.copy(null,null,null,n.left.insert(t,e,i),null):r===0?n.copy(null,e,null,null,null):n.copy(null,null,null,null,n.right.insert(t,e,i)),n.fixUp()}removeMin(){if(this.left.isEmpty())return ht.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let i,n=this;if(e(t,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),e(t,n.key)===0){if(n.right.isEmpty())return ht.EMPTY;i=n.right.min(),n=n.copy(i.key,i.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,ht.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,ht.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw we(43730,{key:this.key,value:this.value});if(this.right.isRed())throw we(14113,{key:this.key,value:this.value});const t=this.left.check();if(t!==this.right.check())throw we(27949);return t+(this.isRed()?0:1)}}ht.EMPTY=null,ht.RED=!0,ht.BLACK=!1;ht.EMPTY=new class{constructor(){this.size=0}get key(){throw we(57766)}get value(){throw we(16141)}get color(){throw we(16727)}get left(){throw we(29726)}get right(){throw we(36894)}copy(t,e,i,n,r){return this}insert(t,e,i){return new ht(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rt{constructor(t){this.comparator=t,this.data=new Ge(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,i)=>(t(e),!1))}forEachInRange(t,e){const i=this.data.getIteratorFrom(t[0]);for(;i.hasNext();){const n=i.getNext();if(this.comparator(n.key,t[1])>=0)return;e(n.key)}}forEachWhile(t,e){let i;for(i=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();i.hasNext();)if(!t(i.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new ul(this.data.getIterator())}getIteratorFrom(t){return new ul(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(i=>{e=e.add(i)}),e}isEqual(t){if(!(t instanceof rt)||this.size!==t.size)return!1;const e=this.data.getIterator(),i=t.data.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(this.comparator(n,r)!==0)return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new rt(this.comparator);return e.data=t,e}}class ul{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class At{constructor(t){this.fields=t,t.sort(dt.comparator)}static empty(){return new At([])}unionWith(t){let e=new rt(dt.comparator);for(const i of this.fields)e=e.add(i);for(const i of t)e=e.add(i);return new At(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return qi(this.fields,t.fields,(e,i)=>e.isEqual(i))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ou extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ft{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(n){try{return atob(n)}catch(r){throw typeof DOMException<"u"&&r instanceof DOMException?new Ou("Invalid base64 string: "+r):r}}(t);return new ft(e)}static fromUint8Array(t){const e=function(n){let r="";for(let o=0;o<n.length;++o)r+=String.fromCharCode(n[o]);return r}(t);return new ft(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){const i=new Uint8Array(e.length);for(let n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return be(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}ft.EMPTY_BYTE_STRING=new ft("");const Zp=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function di(s){if(Fe(!!s,39018),typeof s=="string"){let t=0;const e=Zp.exec(s);if(Fe(!!e,46558,{timestamp:s}),e[1]){let n=e[1];n=(n+"000000000").substr(0,9),t=Number(n)}const i=new Date(s);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:Xe(s.seconds),nanos:Xe(s.nanos)}}function Xe(s){return typeof s=="number"?s:typeof s=="string"?Number(s):0}function fi(s){return typeof s=="string"?ft.fromBase64String(s):ft.fromUint8Array(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Vu="server_timestamp",Lu="__type__",Nu="__previous_value__",Bu="__local_write_time__";function co(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[Lu])===null||e===void 0?void 0:e.stringValue)===Vu}function qr(s){const t=s.mapValue.fields[Nu];return co(t)?qr(t):t}function Mn(s){const t=di(s.mapValue.fields[Bu].timestampValue);return new Ue(t.seconds,t.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xp{constructor(t,e,i,n,r,o,a,l,u,h){this.databaseId=t,this.appId=e,this.persistenceKey=i,this.host=n,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=l,this.useFetchStreams=u,this.isUsingEmulator=h}}const Mr="(default)";class kn{constructor(t,e){this.projectId=t,this.database=e||Mr}static empty(){return new kn("","")}get isDefaultDatabase(){return this.database===Mr}isEqual(t){return t instanceof kn&&t.projectId===this.projectId&&t.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zu="__type__",Kp="__max__",hr={mapValue:{}},Hu="__vector__",kr="value";function pi(s){return"nullValue"in s?0:"booleanValue"in s?1:"integerValue"in s||"doubleValue"in s?2:"timestampValue"in s?3:"stringValue"in s?5:"bytesValue"in s?6:"referenceValue"in s?7:"geoPointValue"in s?8:"arrayValue"in s?9:"mapValue"in s?co(s)?4:Qp(s)?9007199254740991:Yp(s)?10:11:we(28295,{value:s})}function Gt(s,t){if(s===t)return!0;const e=pi(s);if(e!==pi(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return s.booleanValue===t.booleanValue;case 4:return Mn(s).isEqual(Mn(t));case 3:return function(n,r){if(typeof n.timestampValue=="string"&&typeof r.timestampValue=="string"&&n.timestampValue.length===r.timestampValue.length)return n.timestampValue===r.timestampValue;const o=di(n.timestampValue),a=di(r.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(s,t);case 5:return s.stringValue===t.stringValue;case 6:return function(n,r){return fi(n.bytesValue).isEqual(fi(r.bytesValue))}(s,t);case 7:return s.referenceValue===t.referenceValue;case 8:return function(n,r){return Xe(n.geoPointValue.latitude)===Xe(r.geoPointValue.latitude)&&Xe(n.geoPointValue.longitude)===Xe(r.geoPointValue.longitude)}(s,t);case 2:return function(n,r){if("integerValue"in n&&"integerValue"in r)return Xe(n.integerValue)===Xe(r.integerValue);if("doubleValue"in n&&"doubleValue"in r){const o=Xe(n.doubleValue),a=Xe(r.doubleValue);return o===a?Dr(o)===Dr(a):isNaN(o)&&isNaN(a)}return!1}(s,t);case 9:return qi(s.arrayValue.values||[],t.arrayValue.values||[],Gt);case 10:case 11:return function(n,r){const o=n.mapValue.fields||{},a=r.mapValue.fields||{};if(ll(o)!==ll(a))return!1;for(const l in o)if(o.hasOwnProperty(l)&&(a[l]===void 0||!Gt(o[l],a[l])))return!1;return!0}(s,t);default:return we(52216,{left:s})}}function Fn(s,t){return(s.values||[]).find(e=>Gt(e,t))!==void 0}function Zi(s,t){if(s===t)return 0;const e=pi(s),i=pi(t);if(e!==i)return be(e,i);switch(e){case 0:case 9007199254740991:return 0;case 1:return be(s.booleanValue,t.booleanValue);case 2:return function(r,o){const a=Xe(r.integerValue||r.doubleValue),l=Xe(o.integerValue||o.doubleValue);return a<l?-1:a>l?1:a===l?0:isNaN(a)?isNaN(l)?0:-1:1}(s,t);case 3:return cl(s.timestampValue,t.timestampValue);case 4:return cl(Mn(s),Mn(t));case 5:return Ls(s.stringValue,t.stringValue);case 6:return function(r,o){const a=fi(r),l=fi(o);return a.compareTo(l)}(s.bytesValue,t.bytesValue);case 7:return function(r,o){const a=r.split("/"),l=o.split("/");for(let u=0;u<a.length&&u<l.length;u++){const h=be(a[u],l[u]);if(h!==0)return h}return be(a.length,l.length)}(s.referenceValue,t.referenceValue);case 8:return function(r,o){const a=be(Xe(r.latitude),Xe(o.latitude));return a!==0?a:be(Xe(r.longitude),Xe(o.longitude))}(s.geoPointValue,t.geoPointValue);case 9:return hl(s.arrayValue,t.arrayValue);case 10:return function(r,o){var a,l,u,h;const d=r.fields||{},f=o.fields||{},m=(a=d[kr])===null||a===void 0?void 0:a.arrayValue,v=(l=f[kr])===null||l===void 0?void 0:l.arrayValue,_=be(((u=m==null?void 0:m.values)===null||u===void 0?void 0:u.length)||0,((h=v==null?void 0:v.values)===null||h===void 0?void 0:h.length)||0);return _!==0?_:hl(m,v)}(s.mapValue,t.mapValue);case 11:return function(r,o){if(r===hr.mapValue&&o===hr.mapValue)return 0;if(r===hr.mapValue)return 1;if(o===hr.mapValue)return-1;const a=r.fields||{},l=Object.keys(a),u=o.fields||{},h=Object.keys(u);l.sort(),h.sort();for(let d=0;d<l.length&&d<h.length;++d){const f=Ls(l[d],h[d]);if(f!==0)return f;const m=Zi(a[l[d]],u[h[d]]);if(m!==0)return m}return be(l.length,h.length)}(s.mapValue,t.mapValue);default:throw we(23264,{le:e})}}function cl(s,t){if(typeof s=="string"&&typeof t=="string"&&s.length===t.length)return be(s,t);const e=di(s),i=di(t),n=be(e.seconds,i.seconds);return n!==0?n:be(e.nanos,i.nanos)}function hl(s,t){const e=s.values||[],i=t.values||[];for(let n=0;n<e.length&&n<i.length;++n){const r=Zi(e[n],i[n]);if(r)return r}return be(e.length,i.length)}function Xi(s){return Ns(s)}function Ns(s){return"nullValue"in s?"null":"booleanValue"in s?""+s.booleanValue:"integerValue"in s?""+s.integerValue:"doubleValue"in s?""+s.doubleValue:"timestampValue"in s?function(e){const i=di(e);return`time(${i.seconds},${i.nanos})`}(s.timestampValue):"stringValue"in s?s.stringValue:"bytesValue"in s?function(e){return fi(e).toBase64()}(s.bytesValue):"referenceValue"in s?function(e){return ve.fromName(e).toString()}(s.referenceValue):"geoPointValue"in s?function(e){return`geo(${e.latitude},${e.longitude})`}(s.geoPointValue):"arrayValue"in s?function(e){let i="[",n=!0;for(const r of e.values||[])n?n=!1:i+=",",i+=Ns(r);return i+"]"}(s.arrayValue):"mapValue"in s?function(e){const i=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const o of i)r?r=!1:n+=",",n+=`${o}:${Ns(e.fields[o])}`;return n+"}"}(s.mapValue):we(61005,{value:s})}function vr(s){switch(pi(s)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=qr(s);return t?16+vr(t):16;case 5:return 2*s.stringValue.length;case 6:return fi(s.bytesValue).approximateByteSize();case 7:return s.referenceValue.length;case 9:return function(i){return(i.values||[]).reduce((n,r)=>n+vr(r),0)}(s.arrayValue);case 10:case 11:return function(i){let n=0;return yi(i.fields,(r,o)=>{n+=r.length+vr(o)}),n}(s.mapValue);default:throw we(13486,{value:s})}}function dl(s,t){return{referenceValue:`projects/${s.projectId}/databases/${s.database}/documents/${t.path.canonicalString()}`}}function Bs(s){return!!s&&"integerValue"in s}function ho(s){return!!s&&"arrayValue"in s}function fl(s){return!!s&&"nullValue"in s}function pl(s){return!!s&&"doubleValue"in s&&isNaN(Number(s.doubleValue))}function yr(s){return!!s&&"mapValue"in s}function Yp(s){var t,e;return((e=(((t=s==null?void 0:s.mapValue)===null||t===void 0?void 0:t.fields)||{})[zu])===null||e===void 0?void 0:e.stringValue)===Hu}function xn(s){if(s.geoPointValue)return{geoPointValue:Object.assign({},s.geoPointValue)};if(s.timestampValue&&typeof s.timestampValue=="object")return{timestampValue:Object.assign({},s.timestampValue)};if(s.mapValue){const t={mapValue:{fields:{}}};return yi(s.mapValue.fields,(e,i)=>t.mapValue.fields[e]=xn(i)),t}if(s.arrayValue){const t={arrayValue:{values:[]}};for(let e=0;e<(s.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=xn(s.arrayValue.values[e]);return t}return Object.assign({},s)}function Qp(s){return(((s.mapValue||{}).fields||{}).__type__||{}).stringValue===Kp}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pt{constructor(t){this.value=t}static empty(){return new Pt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let i=0;i<t.length-1;++i)if(e=(e.mapValue.fields||{})[t.get(i)],!yr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=xn(e)}setAll(t){let e=dt.emptyPath(),i={},n=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){const l=this.getFieldsMap(e);this.applyChanges(l,i,n),i={},n=[],e=a.popLast()}o?i[a.lastSegment()]=xn(o):n.push(a.lastSegment())});const r=this.getFieldsMap(e);this.applyChanges(r,i,n)}delete(t){const e=this.field(t.popLast());yr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Gt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let i=0;i<t.length;++i){let n=e.mapValue.fields[t.get(i)];yr(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},e.mapValue.fields[t.get(i)]=n),e=n}return e.mapValue.fields}applyChanges(t,e,i){yi(e,(n,r)=>t[n]=r);for(const n of i)delete t[n]}clone(){return new Pt(xn(this.value))}}function Uu(s){const t=[];return yi(s.fields,(e,i)=>{const n=new dt([e]);if(yr(i)){const r=Uu(i.mapValue).fields;if(r.length===0)t.push(n);else for(const o of r)t.push(n.child(o))}else t.push(n)}),new At(t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tt{constructor(t,e,i,n,r,o,a){this.key=t,this.documentType=e,this.version=i,this.readTime=n,this.createTime=r,this.data=o,this.documentState=a}static newInvalidDocument(t){return new Tt(t,0,_e.min(),_e.min(),_e.min(),Pt.empty(),0)}static newFoundDocument(t,e,i,n){return new Tt(t,1,e,_e.min(),i,n,0)}static newNoDocument(t,e){return new Tt(t,2,e,_e.min(),_e.min(),Pt.empty(),0)}static newUnknownDocument(t,e){return new Tt(t,3,e,_e.min(),_e.min(),Pt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(_e.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Pt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Pt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=_e.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof Tt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Tt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fr{constructor(t,e){this.position=t,this.inclusive=e}}function gl(s,t,e){let i=0;for(let n=0;n<s.position.length;n++){const r=t[n],o=s.position[n];if(r.field.isKeyField()?i=ve.comparator(ve.fromName(o.referenceValue),e.key):i=Zi(o,e.data.field(r.field)),r.dir==="desc"&&(i*=-1),i!==0)break}return i}function ml(s,t){if(s===null)return t===null;if(t===null||s.inclusive!==t.inclusive||s.position.length!==t.position.length)return!1;for(let e=0;e<s.position.length;e++)if(!Gt(s.position[e],t.position[e]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class On{constructor(t,e="asc"){this.field=t,this.dir=e}}function Jp(s,t){return s.dir===t.dir&&s.field.isEqual(t.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ju{}class Je extends ju{constructor(t,e,i){super(),this.field=t,this.op=e,this.value=i}static create(t,e,i){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,i):new eg(t,e,i):e==="array-contains"?new ng(t,i):e==="in"?new rg(t,i):e==="not-in"?new sg(t,i):e==="array-contains-any"?new og(t,i):new Je(t,e,i)}static createKeyFieldInFilter(t,e,i){return e==="in"?new tg(t,i):new ig(t,i)}matches(t){const e=t.data.field(this.field);return this.op==="!="?e!==null&&e.nullValue===void 0&&this.matchesComparison(Zi(e,this.value)):e!==null&&pi(this.value)===pi(e)&&this.matchesComparison(Zi(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return we(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Lt extends ju{constructor(t,e){super(),this.filters=t,this.op=e,this.he=null}static create(t,e){return new Lt(t,e)}matches(t){return Wu(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.he!==null||(this.he=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.he}getFilters(){return Object.assign([],this.filters)}}function Wu(s){return s.op==="and"}function Gu(s){return $p(s)&&Wu(s)}function $p(s){for(const t of s.filters)if(t instanceof Lt)return!1;return!0}function zs(s){if(s instanceof Je)return s.field.canonicalString()+s.op.toString()+Xi(s.value);if(Gu(s))return s.filters.map(t=>zs(t)).join(",");{const t=s.filters.map(e=>zs(e)).join(",");return`${s.op}(${t})`}}function qu(s,t){return s instanceof Je?function(i,n){return n instanceof Je&&i.op===n.op&&i.field.isEqual(n.field)&&Gt(i.value,n.value)}(s,t):s instanceof Lt?function(i,n){return n instanceof Lt&&i.op===n.op&&i.filters.length===n.filters.length?i.filters.reduce((r,o,a)=>r&&qu(o,n.filters[a]),!0):!1}(s,t):void we(19439)}function Zu(s){return s instanceof Je?function(e){return`${e.field.canonicalString()} ${e.op} ${Xi(e.value)}`}(s):s instanceof Lt?function(e){return e.op.toString()+" {"+e.getFilters().map(Zu).join(" ,")+"}"}(s):"Filter"}class eg extends Je{constructor(t,e,i){super(t,e,i),this.key=ve.fromName(i.referenceValue)}matches(t){const e=ve.comparator(t.key,this.key);return this.matchesComparison(e)}}class tg extends Je{constructor(t,e){super(t,"in",e),this.keys=Xu("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class ig extends Je{constructor(t,e){super(t,"not-in",e),this.keys=Xu("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function Xu(s,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(i=>ve.fromName(i.referenceValue))}class ng extends Je{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return ho(e)&&Fn(e.arrayValue,this.value)}}class rg extends Je{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return e!==null&&Fn(this.value.arrayValue,e)}}class sg extends Je{constructor(t,e){super(t,"not-in",e)}matches(t){if(Fn(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return e!==null&&e.nullValue===void 0&&!Fn(this.value.arrayValue,e)}}class og extends Je{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!ho(e)||!e.arrayValue.values)&&e.arrayValue.values.some(i=>Fn(this.value.arrayValue,i))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ag{constructor(t,e=null,i=[],n=[],r=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=i,this.filters=n,this.limit=r,this.startAt=o,this.endAt=a,this.Pe=null}}function vl(s,t=null,e=[],i=[],n=null,r=null,o=null){return new ag(s,t,e,i,n,r,o)}function fo(s){const t=Ee(s);if(t.Pe===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(i=>zs(i)).join(","),e+="|ob:",e+=t.orderBy.map(i=>function(r){return r.field.canonicalString()+r.dir}(i)).join(","),Gr(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(i=>Xi(i)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(i=>Xi(i)).join(",")),t.Pe=e}return t.Pe}function po(s,t){if(s.limit!==t.limit||s.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<s.orderBy.length;e++)if(!Jp(s.orderBy[e],t.orderBy[e]))return!1;if(s.filters.length!==t.filters.length)return!1;for(let e=0;e<s.filters.length;e++)if(!qu(s.filters[e],t.filters[e]))return!1;return s.collectionGroup===t.collectionGroup&&!!s.path.isEqual(t.path)&&!!ml(s.startAt,t.startAt)&&ml(s.endAt,t.endAt)}function Hs(s){return ve.isDocumentKey(s.path)&&s.collectionGroup===null&&s.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rn{constructor(t,e=null,i=[],n=[],r=null,o="F",a=null,l=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=i,this.filters=n,this.limit=r,this.limitType=o,this.startAt=a,this.endAt=l,this.Te=null,this.Ie=null,this.de=null,this.startAt,this.endAt}}function lg(s,t,e,i,n,r,o,a){return new rn(s,t,e,i,n,r,o,a)}function go(s){return new rn(s)}function yl(s){return s.filters.length===0&&s.limit===null&&s.startAt==null&&s.endAt==null&&(s.explicitOrderBy.length===0||s.explicitOrderBy.length===1&&s.explicitOrderBy[0].field.isKeyField())}function Ku(s){return s.collectionGroup!==null}function bn(s){const t=Ee(s);if(t.Te===null){t.Te=[];const e=new Set;for(const r of t.explicitOrderBy)t.Te.push(r),e.add(r.field.canonicalString());const i=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new rt(dt.comparator);return o.filters.forEach(l=>{l.getFlattenedFilters().forEach(u=>{u.isInequality()&&(a=a.add(u.field))})}),a})(t).forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Te.push(new On(r,i))}),e.has(dt.keyField().canonicalString())||t.Te.push(new On(dt.keyField(),i))}return t.Te}function Bt(s){const t=Ee(s);return t.Ie||(t.Ie=ug(t,bn(s))),t.Ie}function ug(s,t){if(s.limitType==="F")return vl(s.path,s.collectionGroup,t,s.filters,s.limit,s.startAt,s.endAt);{t=t.map(n=>{const r=n.dir==="desc"?"asc":"desc";return new On(n.field,r)});const e=s.endAt?new Fr(s.endAt.position,s.endAt.inclusive):null,i=s.startAt?new Fr(s.startAt.position,s.startAt.inclusive):null;return vl(s.path,s.collectionGroup,t,s.filters,s.limit,e,i)}}function Us(s,t){const e=s.filters.concat([t]);return new rn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),e,s.limit,s.limitType,s.startAt,s.endAt)}function js(s,t,e){return new rn(s.path,s.collectionGroup,s.explicitOrderBy.slice(),s.filters.slice(),t,e,s.startAt,s.endAt)}function Zr(s,t){return po(Bt(s),Bt(t))&&s.limitType===t.limitType}function Yu(s){return`${fo(Bt(s))}|lt:${s.limitType}`}function Bi(s){return`Query(target=${function(e){let i=e.path.canonicalString();return e.collectionGroup!==null&&(i+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(i+=`, filters: [${e.filters.map(n=>Zu(n)).join(", ")}]`),Gr(e.limit)||(i+=", limit: "+e.limit),e.orderBy.length>0&&(i+=`, orderBy: [${e.orderBy.map(n=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(n)).join(", ")}]`),e.startAt&&(i+=", startAt: ",i+=e.startAt.inclusive?"b:":"a:",i+=e.startAt.position.map(n=>Xi(n)).join(",")),e.endAt&&(i+=", endAt: ",i+=e.endAt.inclusive?"a:":"b:",i+=e.endAt.position.map(n=>Xi(n)).join(",")),`Target(${i})`}(Bt(s))}; limitType=${s.limitType})`}function Xr(s,t){return t.isFoundDocument()&&function(i,n){const r=n.key.path;return i.collectionGroup!==null?n.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(r):ve.isDocumentKey(i.path)?i.path.isEqual(r):i.path.isImmediateParentOf(r)}(s,t)&&function(i,n){for(const r of bn(i))if(!r.field.isKeyField()&&n.data.field(r.field)===null)return!1;return!0}(s,t)&&function(i,n){for(const r of i.filters)if(!r.matches(n))return!1;return!0}(s,t)&&function(i,n){return!(i.startAt&&!function(o,a,l){const u=gl(o,a,l);return o.inclusive?u<=0:u<0}(i.startAt,bn(i),n)||i.endAt&&!function(o,a,l){const u=gl(o,a,l);return o.inclusive?u>=0:u>0}(i.endAt,bn(i),n))}(s,t)}function cg(s){return s.collectionGroup||(s.path.length%2==1?s.path.lastSegment():s.path.get(s.path.length-2))}function Qu(s){return(t,e)=>{let i=!1;for(const n of bn(s)){const r=hg(n,t,e);if(r!==0)return r;i=i||n.field.isKeyField()}return 0}}function hg(s,t,e){const i=s.field.isKeyField()?ve.comparator(t.key,e.key):function(r,o,a){const l=o.data.field(r),u=a.data.field(r);return l!==null&&u!==null?Zi(l,u):we(42886)}(s.field,t,e);switch(s.dir){case"asc":return i;case"desc":return-1*i;default:return we(19790,{direction:s.dir})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ai{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i!==void 0){for(const[n,r]of i)if(this.equalsFn(n,t))return r}}has(t){return this.get(t)!==void 0}set(t,e){const i=this.mapKeyFn(t),n=this.inner[i];if(n===void 0)return this.inner[i]=[[t,e]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return void(n[r]=[t,e]);n.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),i=this.inner[e];if(i===void 0)return!1;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return i.length===1?delete this.inner[e]:i.splice(n,1),this.innerSize--,!0;return!1}forEach(t){yi(this.inner,(e,i)=>{for(const[n,r]of i)t(n,r)})}isEmpty(){return Fu(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dg=new Ge(ve.comparator);function $t(){return dg}const Ju=new Ge(ve.comparator);function yn(...s){let t=Ju;for(const e of s)t=t.insert(e.key,e);return t}function $u(s){let t=Ju;return s.forEach((e,i)=>t=t.insert(e,i.overlayedDocument)),t}function Si(){return Sn()}function ec(){return Sn()}function Sn(){return new Ai(s=>s.toString(),(s,t)=>s.isEqual(t))}const fg=new Ge(ve.comparator),pg=new rt(ve.comparator);function Ce(...s){let t=pg;for(const e of s)t=t.add(e);return t}const gg=new rt(be);function mg(){return gg}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mo(s,t){if(s.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Dr(t)?"-0":t}}function tc(s){return{integerValue:""+s}}function vg(s,t){return Wp(t)?tc(t):mo(s,t)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kr{constructor(){this._=void 0}}function yg(s,t,e){return s instanceof Or?function(n,r){const o={fields:{[Lu]:{stringValue:Vu},[Bu]:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return r&&co(r)&&(r=qr(r)),r&&(o.fields[Nu]=r),{mapValue:o}}(e,t):s instanceof Vn?nc(s,t):s instanceof Ln?rc(s,t):function(n,r){const o=ic(n,r),a=wl(o)+wl(n.Ee);return Bs(o)&&Bs(n.Ee)?tc(a):mo(n.serializer,a)}(s,t)}function wg(s,t,e){return s instanceof Vn?nc(s,t):s instanceof Ln?rc(s,t):e}function ic(s,t){return s instanceof Vr?function(i){return Bs(i)||function(r){return!!r&&"doubleValue"in r}(i)}(t)?t:{integerValue:0}:null}class Or extends Kr{}class Vn extends Kr{constructor(t){super(),this.elements=t}}function nc(s,t){const e=sc(t);for(const i of s.elements)e.some(n=>Gt(n,i))||e.push(i);return{arrayValue:{values:e}}}class Ln extends Kr{constructor(t){super(),this.elements=t}}function rc(s,t){let e=sc(t);for(const i of s.elements)e=e.filter(n=>!Gt(n,i));return{arrayValue:{values:e}}}class Vr extends Kr{constructor(t,e){super(),this.serializer=t,this.Ee=e}}function wl(s){return Xe(s.integerValue||s.doubleValue)}function sc(s){return ho(s)&&s.arrayValue.values?s.arrayValue.values.slice():[]}function _g(s,t){return s.field.isEqual(t.field)&&function(i,n){return i instanceof Vn&&n instanceof Vn||i instanceof Ln&&n instanceof Ln?qi(i.elements,n.elements,Gt):i instanceof Vr&&n instanceof Vr?Gt(i.Ee,n.Ee):i instanceof Or&&n instanceof Or}(s.transform,t.transform)}class Tg{constructor(t,e){this.version=t,this.transformResults=e}}class Vt{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Vt}static exists(t){return new Vt(void 0,t)}static updateTime(t){return new Vt(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function wr(s,t){return s.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(s.updateTime):s.exists===void 0||s.exists===t.isFoundDocument()}class Yr{}function oc(s,t){if(!s.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return s.isNoDocument()?new vo(s.key,Vt.none()):new Hn(s.key,s.data,Vt.none());{const e=s.data,i=Pt.empty();let n=new rt(dt.comparator);for(let r of t.fields)if(!n.has(r)){let o=e.field(r);o===null&&r.length>1&&(r=r.popLast(),o=e.field(r)),o===null?i.delete(r):i.set(r,o),n=n.add(r)}return new wi(s.key,i,new At(n.toArray()),Vt.none())}}function Eg(s,t,e){s instanceof Hn?function(n,r,o){const a=n.value.clone(),l=Tl(n.fieldTransforms,r,o.transformResults);a.setAll(l),r.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(s,t,e):s instanceof wi?function(n,r,o){if(!wr(n.precondition,r))return void r.convertToUnknownDocument(o.version);const a=Tl(n.fieldTransforms,r,o.transformResults),l=r.data;l.setAll(ac(n)),l.setAll(a),r.convertToFoundDocument(o.version,l).setHasCommittedMutations()}(s,t,e):function(n,r,o){r.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function Pn(s,t,e,i){return s instanceof Hn?function(r,o,a,l){if(!wr(r.precondition,o))return a;const u=r.value.clone(),h=El(r.fieldTransforms,l,o);return u.setAll(h),o.convertToFoundDocument(o.version,u).setHasLocalMutations(),null}(s,t,e,i):s instanceof wi?function(r,o,a,l){if(!wr(r.precondition,o))return a;const u=El(r.fieldTransforms,l,o),h=o.data;return h.setAll(ac(r)),h.setAll(u),o.convertToFoundDocument(o.version,h).setHasLocalMutations(),a===null?null:a.unionWith(r.fieldMask.fields).unionWith(r.fieldTransforms.map(d=>d.field))}(s,t,e,i):function(r,o,a){return wr(r.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(s,t,e)}function xg(s,t){let e=null;for(const i of s.fieldTransforms){const n=t.data.field(i.field),r=ic(i.transform,n||null);r!=null&&(e===null&&(e=Pt.empty()),e.set(i.field,r))}return e||null}function _l(s,t){return s.type===t.type&&!!s.key.isEqual(t.key)&&!!s.precondition.isEqual(t.precondition)&&!!function(i,n){return i===void 0&&n===void 0||!(!i||!n)&&qi(i,n,(r,o)=>_g(r,o))}(s.fieldTransforms,t.fieldTransforms)&&(s.type===0?s.value.isEqual(t.value):s.type!==1||s.data.isEqual(t.data)&&s.fieldMask.isEqual(t.fieldMask))}class Hn extends Yr{constructor(t,e,i,n=[]){super(),this.key=t,this.value=e,this.precondition=i,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class wi extends Yr{constructor(t,e,i,n,r=[]){super(),this.key=t,this.data=e,this.fieldMask=i,this.precondition=n,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function ac(s){const t=new Map;return s.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){const i=s.data.field(e);t.set(e,i)}}),t}function Tl(s,t,e){const i=new Map;Fe(s.length===e.length,32656,{Ae:e.length,Re:s.length});for(let n=0;n<e.length;n++){const r=s[n],o=r.transform,a=t.data.field(r.field);i.set(r.field,wg(o,a,e[n]))}return i}function El(s,t,e){const i=new Map;for(const n of s){const r=n.transform,o=e.data.field(n.field);i.set(n.field,yg(r,o,t))}return i}class vo extends Yr{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class bg extends Yr{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sg{constructor(t,e,i,n){this.batchId=t,this.localWriteTime=e,this.baseMutations=i,this.mutations=n}applyToRemoteDocument(t,e){const i=e.mutationResults;for(let n=0;n<this.mutations.length;n++){const r=this.mutations[n];r.key.isEqual(t.key)&&Eg(r,t,i[n])}}applyToLocalView(t,e){for(const i of this.baseMutations)i.key.isEqual(t.key)&&(e=Pn(i,t,e,this.localWriteTime));for(const i of this.mutations)i.key.isEqual(t.key)&&(e=Pn(i,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const i=ec();return this.mutations.forEach(n=>{const r=t.get(n.key),o=r.overlayedDocument;let a=this.applyToLocalView(o,r.mutatedFields);a=e.has(n.key)?null:a;const l=oc(o,a);l!==null&&i.set(n.key,l),o.isValidDocument()||o.convertToNoDocument(_e.min())}),i}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Ce())}isEqual(t){return this.batchId===t.batchId&&qi(this.mutations,t.mutations,(e,i)=>_l(e,i))&&qi(this.baseMutations,t.baseMutations,(e,i)=>_l(e,i))}}class yo{constructor(t,e,i,n){this.batch=t,this.commitVersion=e,this.mutationResults=i,this.docVersions=n}static from(t,e,i){Fe(t.mutations.length===i.length,58842,{Ve:t.mutations.length,me:i.length});let n=function(){return fg}();const r=t.mutations;for(let o=0;o<r.length;o++)n=n.insert(r[o].key,i[o].version);return new yo(t,e,i,n)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pg{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cg{constructor(t,e){this.count=t,this.unchangedNames=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Ye,Ie;function Rg(s){switch(s){case G.OK:return we(64938);case G.CANCELLED:case G.UNKNOWN:case G.DEADLINE_EXCEEDED:case G.RESOURCE_EXHAUSTED:case G.INTERNAL:case G.UNAVAILABLE:case G.UNAUTHENTICATED:return!1;case G.INVALID_ARGUMENT:case G.NOT_FOUND:case G.ALREADY_EXISTS:case G.PERMISSION_DENIED:case G.FAILED_PRECONDITION:case G.ABORTED:case G.OUT_OF_RANGE:case G.UNIMPLEMENTED:case G.DATA_LOSS:return!0;default:return we(15467,{code:s})}}function lc(s){if(s===void 0)return Jt("GRPC error has no .code"),G.UNKNOWN;switch(s){case Ye.OK:return G.OK;case Ye.CANCELLED:return G.CANCELLED;case Ye.UNKNOWN:return G.UNKNOWN;case Ye.DEADLINE_EXCEEDED:return G.DEADLINE_EXCEEDED;case Ye.RESOURCE_EXHAUSTED:return G.RESOURCE_EXHAUSTED;case Ye.INTERNAL:return G.INTERNAL;case Ye.UNAVAILABLE:return G.UNAVAILABLE;case Ye.UNAUTHENTICATED:return G.UNAUTHENTICATED;case Ye.INVALID_ARGUMENT:return G.INVALID_ARGUMENT;case Ye.NOT_FOUND:return G.NOT_FOUND;case Ye.ALREADY_EXISTS:return G.ALREADY_EXISTS;case Ye.PERMISSION_DENIED:return G.PERMISSION_DENIED;case Ye.FAILED_PRECONDITION:return G.FAILED_PRECONDITION;case Ye.ABORTED:return G.ABORTED;case Ye.OUT_OF_RANGE:return G.OUT_OF_RANGE;case Ye.UNIMPLEMENTED:return G.UNIMPLEMENTED;case Ye.DATA_LOSS:return G.DATA_LOSS;default:return we(39323,{code:s})}}(Ie=Ye||(Ye={}))[Ie.OK=0]="OK",Ie[Ie.CANCELLED=1]="CANCELLED",Ie[Ie.UNKNOWN=2]="UNKNOWN",Ie[Ie.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ie[Ie.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ie[Ie.NOT_FOUND=5]="NOT_FOUND",Ie[Ie.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ie[Ie.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ie[Ie.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ie[Ie.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ie[Ie.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ie[Ie.ABORTED=10]="ABORTED",Ie[Ie.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ie[Ie.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ie[Ie.INTERNAL=13]="INTERNAL",Ie[Ie.UNAVAILABLE=14]="UNAVAILABLE",Ie[Ie.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ig=new ai([4294967295,4294967295],0);function xl(s){const t=Au().encode(s),e=new Eu;return e.update(t),new Uint8Array(e.digest())}function bl(s){const t=new DataView(s.buffer),e=t.getUint32(0,!0),i=t.getUint32(4,!0),n=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new ai([e,i],0),new ai([n,r],0)]}class wo{constructor(t,e,i){if(this.bitmap=t,this.padding=e,this.hashCount=i,e<0||e>=8)throw new wn(`Invalid padding: ${e}`);if(i<0)throw new wn(`Invalid hash count: ${i}`);if(t.length>0&&this.hashCount===0)throw new wn(`Invalid hash count: ${i}`);if(t.length===0&&e!==0)throw new wn(`Invalid padding when bitmap length is 0: ${e}`);this.fe=8*t.length-e,this.ge=ai.fromNumber(this.fe)}pe(t,e,i){let n=t.add(e.multiply(ai.fromNumber(i)));return n.compare(Ig)===1&&(n=new ai([n.getBits(0),n.getBits(1)],0)),n.modulo(this.ge).toNumber()}ye(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(this.fe===0)return!1;const e=xl(t),[i,n]=bl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);if(!this.ye(o))return!1}return!0}static create(t,e,i){const n=t%8==0?0:8-t%8,r=new Uint8Array(Math.ceil(t/8)),o=new wo(r,n,e);return i.forEach(a=>o.insert(a)),o}insert(t){if(this.fe===0)return;const e=xl(t),[i,n]=bl(e);for(let r=0;r<this.hashCount;r++){const o=this.pe(i,n,r);this.we(o)}}we(t){const e=Math.floor(t/8),i=t%8;this.bitmap[e]|=1<<i}}class wn extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qr{constructor(t,e,i,n,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=i,this.documentUpdates=n,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e,i){const n=new Map;return n.set(t,Un.createSynthesizedTargetChangeForCurrentChange(t,e,i)),new Qr(_e.min(),n,new Ge(be),$t(),Ce())}}class Un{constructor(t,e,i,n,r){this.resumeToken=t,this.current=e,this.addedDocuments=i,this.modifiedDocuments=n,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e,i){return new Un(i,e,Ce(),Ce(),Ce())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _r{constructor(t,e,i,n){this.Se=t,this.removedTargetIds=e,this.key=i,this.be=n}}class uc{constructor(t,e){this.targetId=t,this.De=e}}class cc{constructor(t,e,i=ft.EMPTY_BYTE_STRING,n=null){this.state=t,this.targetIds=e,this.resumeToken=i,this.cause=n}}class Sl{constructor(){this.ve=0,this.Ce=Pl(),this.Fe=ft.EMPTY_BYTE_STRING,this.Me=!1,this.xe=!0}get current(){return this.Me}get resumeToken(){return this.Fe}get Oe(){return this.ve!==0}get Ne(){return this.xe}Be(t){t.approximateByteSize()>0&&(this.xe=!0,this.Fe=t)}Le(){let t=Ce(),e=Ce(),i=Ce();return this.Ce.forEach((n,r)=>{switch(r){case 0:t=t.add(n);break;case 2:e=e.add(n);break;case 1:i=i.add(n);break;default:we(38017,{changeType:r})}}),new Un(this.Fe,this.Me,t,e,i)}ke(){this.xe=!1,this.Ce=Pl()}qe(t,e){this.xe=!0,this.Ce=this.Ce.insert(t,e)}Qe(t){this.xe=!0,this.Ce=this.Ce.remove(t)}$e(){this.ve+=1}Ue(){this.ve-=1,Fe(this.ve>=0,3241,{ve:this.ve})}Ke(){this.xe=!0,this.Me=!0}}class Ag{constructor(t){this.We=t,this.Ge=new Map,this.ze=$t(),this.je=dr(),this.Je=dr(),this.He=new Ge(be)}Ye(t){for(const e of t.Se)t.be&&t.be.isFoundDocument()?this.Ze(e,t.be):this.Xe(e,t.key,t.be);for(const e of t.removedTargetIds)this.Xe(e,t.key,t.be)}et(t){this.forEachTarget(t,e=>{const i=this.tt(e);switch(t.state){case 0:this.nt(e)&&i.Be(t.resumeToken);break;case 1:i.Ue(),i.Oe||i.ke(),i.Be(t.resumeToken);break;case 2:i.Ue(),i.Oe||this.removeTarget(e);break;case 3:this.nt(e)&&(i.Ke(),i.Be(t.resumeToken));break;case 4:this.nt(e)&&(this.rt(e),i.Be(t.resumeToken));break;default:we(56790,{state:t.state})}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ge.forEach((i,n)=>{this.nt(n)&&e(n)})}it(t){const e=t.targetId,i=t.De.count,n=this.st(e);if(n){const r=n.target;if(Hs(r))if(i===0){const o=new ve(r.path);this.Xe(e,o,Tt.newNoDocument(o,_e.min()))}else Fe(i===1,20013,{expectedCount:i});else{const o=this.ot(e);if(o!==i){const a=this._t(t),l=a?this.ut(a,t,o):1;if(l!==0){this.rt(e);const u=l===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.He=this.He.insert(e,u)}}}}}_t(t){const e=t.De.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:i="",padding:n=0},hashCount:r=0}=e;let o,a;try{o=fi(i).toUint8Array()}catch(l){if(l instanceof Ou)return ci("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{a=new wo(o,n,r)}catch(l){return ci(l instanceof wn?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return a.fe===0?null:a}ut(t,e,i){return e.De.count===i-this.ht(t,e.targetId)?0:2}ht(t,e){const i=this.We.getRemoteKeysForTarget(e);let n=0;return i.forEach(r=>{const o=this.We.lt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${r.path.canonicalString()}`;t.mightContain(a)||(this.Xe(e,r,null),n++)}),n}Pt(t){const e=new Map;this.Ge.forEach((r,o)=>{const a=this.st(o);if(a){if(r.current&&Hs(a.target)){const l=new ve(a.target.path);this.Tt(l).has(o)||this.It(o,l)||this.Xe(o,l,Tt.newNoDocument(l,t))}r.Ne&&(e.set(o,r.Le()),r.ke())}});let i=Ce();this.Je.forEach((r,o)=>{let a=!0;o.forEachWhile(l=>{const u=this.st(l);return!u||u.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(i=i.add(r))}),this.ze.forEach((r,o)=>o.setReadTime(t));const n=new Qr(t,e,this.He,this.ze,i);return this.ze=$t(),this.je=dr(),this.Je=dr(),this.He=new Ge(be),n}Ze(t,e){if(!this.nt(t))return;const i=this.It(t,e.key)?2:0;this.tt(t).qe(e.key,i),this.ze=this.ze.insert(e.key,e),this.je=this.je.insert(e.key,this.Tt(e.key).add(t)),this.Je=this.Je.insert(e.key,this.dt(e.key).add(t))}Xe(t,e,i){if(!this.nt(t))return;const n=this.tt(t);this.It(t,e)?n.qe(e,1):n.Qe(e),this.Je=this.Je.insert(e,this.dt(e).delete(t)),this.Je=this.Je.insert(e,this.dt(e).add(t)),i&&(this.ze=this.ze.insert(e,i))}removeTarget(t){this.Ge.delete(t)}ot(t){const e=this.tt(t).Le();return this.We.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}$e(t){this.tt(t).$e()}tt(t){let e=this.Ge.get(t);return e||(e=new Sl,this.Ge.set(t,e)),e}dt(t){let e=this.Je.get(t);return e||(e=new rt(be),this.Je=this.Je.insert(t,e)),e}Tt(t){let e=this.je.get(t);return e||(e=new rt(be),this.je=this.je.insert(t,e)),e}nt(t){const e=this.st(t)!==null;return e||ce("WatchChangeAggregator","Detected inactive target",t),e}st(t){const e=this.Ge.get(t);return e&&e.Oe?null:this.We.Et(t)}rt(t){this.Ge.set(t,new Sl),this.We.getRemoteKeysForTarget(t).forEach(e=>{this.Xe(t,e,null)})}It(t,e){return this.We.getRemoteKeysForTarget(t).has(e)}}function dr(){return new Ge(ve.comparator)}function Pl(){return new Ge(ve.comparator)}const Dg={asc:"ASCENDING",desc:"DESCENDING"},Mg={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},kg={and:"AND",or:"OR"};class Fg{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Ws(s,t){return s.useProto3Json||Gr(t)?t:{value:t}}function Lr(s,t){return s.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function hc(s,t){return s.useProto3Json?t.toBase64():t.toUint8Array()}function Og(s,t){return Lr(s,t.toTimestamp())}function zt(s){return Fe(!!s,49232),_e.fromTimestamp(function(e){const i=di(e);return new Ue(i.seconds,i.nanos)}(s))}function _o(s,t){return Gs(s,t).canonicalString()}function Gs(s,t){const e=function(n){return new Be(["projects",n.projectId,"databases",n.database])}(s).child("documents");return t===void 0?e:e.child(t)}function dc(s){const t=Be.fromString(s);return Fe(vc(t),10190,{key:t.toString()}),t}function qs(s,t){return _o(s.databaseId,t.path)}function xs(s,t){const e=dc(t);if(e.get(1)!==s.databaseId.projectId)throw new ue(G.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+s.databaseId.projectId);if(e.get(3)!==s.databaseId.database)throw new ue(G.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+s.databaseId.database);return new ve(pc(e))}function fc(s,t){return _o(s.databaseId,t)}function Vg(s){const t=dc(s);return t.length===4?Be.emptyPath():pc(t)}function Zs(s){return new Be(["projects",s.databaseId.projectId,"databases",s.databaseId.database]).canonicalString()}function pc(s){return Fe(s.length>4&&s.get(4)==="documents",29091,{key:s.toString()}),s.popFirst(5)}function Cl(s,t,e){return{name:qs(s,t),fields:e.value.mapValue.fields}}function Lg(s,t){let e;if("targetChange"in t){t.targetChange;const i=function(u){return u==="NO_CHANGE"?0:u==="ADD"?1:u==="REMOVE"?2:u==="CURRENT"?3:u==="RESET"?4:we(39313,{state:u})}(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=function(u,h){return u.useProto3Json?(Fe(h===void 0||typeof h=="string",58123),ft.fromBase64String(h||"")):(Fe(h===void 0||h instanceof Buffer||h instanceof Uint8Array,16193),ft.fromUint8Array(h||new Uint8Array))}(s,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(u){const h=u.code===void 0?G.UNKNOWN:lc(u.code);return new ue(h,u.message||"")}(o);e=new cc(i,n,r,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const n=xs(s,i.document.name),r=zt(i.document.updateTime),o=i.document.createTime?zt(i.document.createTime):_e.min(),a=new Pt({mapValue:{fields:i.document.fields}}),l=Tt.newFoundDocument(n,r,o,a),u=i.targetIds||[],h=i.removedTargetIds||[];e=new _r(u,h,l.key,l)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const n=xs(s,i.document),r=i.readTime?zt(i.readTime):_e.min(),o=Tt.newNoDocument(n,r),a=i.removedTargetIds||[];e=new _r([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const n=xs(s,i.document),r=i.removedTargetIds||[];e=new _r([],r,n,null)}else{if(!("filter"in t))return we(11601,{At:t});{t.filter;const i=t.filter;i.targetId;const{count:n=0,unchangedNames:r}=i,o=new Cg(n,r),a=i.targetId;e=new uc(a,o)}}return e}function Ng(s,t){let e;if(t instanceof Hn)e={update:Cl(s,t.key,t.value)};else if(t instanceof vo)e={delete:qs(s,t.key)};else if(t instanceof wi)e={update:Cl(s,t.key,t.data),updateMask:Zg(t.fieldMask)};else{if(!(t instanceof bg))return we(16599,{Rt:t.type});e={verify:qs(s,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(i=>function(r,o){const a=o.transform;if(a instanceof Or)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof Vn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Ln)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof Vr)return{fieldPath:o.field.canonicalString(),increment:a.Ee};throw we(20930,{transform:o.transform})}(0,i))),t.precondition.isNone||(e.currentDocument=function(n,r){return r.updateTime!==void 0?{updateTime:Og(n,r.updateTime)}:r.exists!==void 0?{exists:r.exists}:we(27497)}(s,t.precondition)),e}function Bg(s,t){return s&&s.length>0?(Fe(t!==void 0,14353),s.map(e=>function(n,r){let o=n.updateTime?zt(n.updateTime):zt(r);return o.isEqual(_e.min())&&(o=zt(r)),new Tg(o,n.transformResults||[])}(e,t))):[]}function zg(s,t){return{documents:[fc(s,t.path)]}}function Hg(s,t){const e={structuredQuery:{}},i=t.path;let n;t.collectionGroup!==null?(n=i,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n=i.popLast(),e.structuredQuery.from=[{collectionId:i.lastSegment()}]),e.parent=fc(s,n);const r=function(u){if(u.length!==0)return mc(Lt.create(u,"and"))}(t.filters);r&&(e.structuredQuery.where=r);const o=function(u){if(u.length!==0)return u.map(h=>function(f){return{field:zi(f.field),direction:Wg(f.dir)}}(h))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);const a=Ws(s,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(u){return{before:u.inclusive,values:u.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(u){return{before:!u.inclusive,values:u.position}}(t.endAt)),{Vt:e,parent:n}}function Ug(s){let t=Vg(s.parent);const e=s.structuredQuery,i=e.from?e.from.length:0;let n=null;if(i>0){Fe(i===1,65062);const h=e.from[0];h.allDescendants?n=h.collectionId:t=t.child(h.collectionId)}let r=[];e.where&&(r=function(d){const f=gc(d);return f instanceof Lt&&Gu(f)?f.getFilters():[f]}(e.where));let o=[];e.orderBy&&(o=function(d){return d.map(f=>function(v){return new On(Hi(v.field),function(E){switch(E){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(v.direction))}(f))}(e.orderBy));let a=null;e.limit&&(a=function(d){let f;return f=typeof d=="object"?d.value:d,Gr(f)?null:f}(e.limit));let l=null;e.startAt&&(l=function(d){const f=!!d.before,m=d.values||[];return new Fr(m,f)}(e.startAt));let u=null;return e.endAt&&(u=function(d){const f=!d.before,m=d.values||[];return new Fr(m,f)}(e.endAt)),lg(t,n,o,r,a,"F",l,u)}function jg(s,t){const e=function(n){switch(n){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return we(28987,{purpose:n})}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function gc(s){return s.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":const i=Hi(e.unaryFilter.field);return Je.create(i,"==",{doubleValue:NaN});case"IS_NULL":const n=Hi(e.unaryFilter.field);return Je.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Hi(e.unaryFilter.field);return Je.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Hi(e.unaryFilter.field);return Je.create(o,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return we(61313);default:return we(60726)}}(s):s.fieldFilter!==void 0?function(e){return Je.create(Hi(e.fieldFilter.field),function(n){switch(n){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return we(58110);default:return we(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(s):s.compositeFilter!==void 0?function(e){return Lt.create(e.compositeFilter.filters.map(i=>gc(i)),function(n){switch(n){case"AND":return"and";case"OR":return"or";default:return we(1026)}}(e.compositeFilter.op))}(s):we(30097,{filter:s})}function Wg(s){return Dg[s]}function Gg(s){return Mg[s]}function qg(s){return kg[s]}function zi(s){return{fieldPath:s.canonicalString()}}function Hi(s){return dt.fromServerFormat(s.fieldPath)}function mc(s){return s instanceof Je?function(e){if(e.op==="=="){if(pl(e.value))return{unaryFilter:{field:zi(e.field),op:"IS_NAN"}};if(fl(e.value))return{unaryFilter:{field:zi(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(pl(e.value))return{unaryFilter:{field:zi(e.field),op:"IS_NOT_NAN"}};if(fl(e.value))return{unaryFilter:{field:zi(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:zi(e.field),op:Gg(e.op),value:e.value}}}(s):s instanceof Lt?function(e){const i=e.getFilters().map(n=>mc(n));return i.length===1?i[0]:{compositeFilter:{op:qg(e.op),filters:i}}}(s):we(54877,{filter:s})}function Zg(s){const t=[];return s.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function vc(s){return s.length>=4&&s.get(0)==="projects"&&s.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ri{constructor(t,e,i,n,r=_e.min(),o=_e.min(),a=ft.EMPTY_BYTE_STRING,l=null){this.target=t,this.targetId=e,this.purpose=i,this.sequenceNumber=n,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=l}withSequenceNumber(t){return new ri(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new ri(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new ri(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new ri(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xg{constructor(t){this.gt=t}}function Kg(s){const t=Ug({parent:s.parent,structuredQuery:s.structuredQuery});return s.limitType==="LAST"?js(t,t.limit,"L"):t}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yg{constructor(){this.Dn=new Qg}addToCollectionParentIndex(t,e){return this.Dn.add(e),K.resolve()}getCollectionParents(t,e){return K.resolve(this.Dn.getEntries(e))}addFieldIndex(t,e){return K.resolve()}deleteFieldIndex(t,e){return K.resolve()}deleteAllFieldIndexes(t){return K.resolve()}createTargetIndexes(t,e){return K.resolve()}getDocumentsMatchingTarget(t,e){return K.resolve(null)}getIndexType(t,e){return K.resolve(0)}getFieldIndexes(t,e){return K.resolve([])}getNextCollectionGroupToUpdate(t){return K.resolve(null)}getMinOffset(t,e){return K.resolve(hi.min())}getMinOffsetFromCollectionGroup(t,e){return K.resolve(hi.min())}updateCollectionGroup(t,e,i){return K.resolve()}updateIndexEntries(t,e){return K.resolve()}}class Qg{constructor(){this.index={}}add(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e]||new rt(Be.comparator),r=!n.has(i);return this.index[e]=n.add(i),r}has(t){const e=t.lastSegment(),i=t.popLast(),n=this.index[e];return n&&n.has(i)}getEntries(t){return(this.index[t]||new rt(Be.comparator)).toArray()}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Rl={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},yc=41943040;class St{static withCacheSize(t){return new St(t,St.DEFAULT_COLLECTION_PERCENTILE,St.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,i){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */St.DEFAULT_COLLECTION_PERCENTILE=10,St.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,St.DEFAULT=new St(yc,St.DEFAULT_COLLECTION_PERCENTILE,St.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),St.DISABLED=new St(-1,0,0);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ki{constructor(t){this._r=t}next(){return this._r+=2,this._r}static ar(){return new Ki(0)}static ur(){return new Ki(-1)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Il="LruGarbageCollector",Jg=1048576;function Al([s,t],[e,i]){const n=be(s,e);return n===0?be(t,i):n}class $g{constructor(t){this.Tr=t,this.buffer=new rt(Al),this.Ir=0}dr(){return++this.Ir}Er(t){const e=[t,this.dr()];if(this.buffer.size<this.Tr)this.buffer=this.buffer.add(e);else{const i=this.buffer.last();Al(e,i)<0&&(this.buffer=this.buffer.delete(i).add(e))}}get maxValue(){return this.buffer.last()[0]}}class em{constructor(t,e,i){this.garbageCollector=t,this.asyncQueue=e,this.localStore=i,this.Ar=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Rr(6e4)}stop(){this.Ar&&(this.Ar.cancel(),this.Ar=null)}get started(){return this.Ar!==null}Rr(t){ce(Il,`Garbage collection scheduled in ${t}ms`),this.Ar=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,async()=>{this.Ar=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){nn(e)?ce(Il,"Ignoring IndexedDB error during garbage collection: ",e):await tn(e)}await this.Rr(3e5)})}}class tm{constructor(t,e){this.Vr=t,this.params=e}calculateTargetCount(t,e){return this.Vr.mr(t).next(i=>Math.floor(e/100*i))}nthSequenceNumber(t,e){if(e===0)return K.resolve(Wr.ue);const i=new $g(e);return this.Vr.forEachTarget(t,n=>i.Er(n.sequenceNumber)).next(()=>this.Vr.gr(t,n=>i.Er(n))).next(()=>i.maxValue)}removeTargets(t,e,i){return this.Vr.removeTargets(t,e,i)}removeOrphanedDocuments(t,e){return this.Vr.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(ce("LruGarbageCollector","Garbage collection skipped; disabled"),K.resolve(Rl)):this.getCacheSize(t).next(i=>i<this.params.cacheSizeCollectionThreshold?(ce("LruGarbageCollector",`Garbage collection skipped; Cache size ${i} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Rl):this.pr(t,e))}getCacheSize(t){return this.Vr.getCacheSize(t)}pr(t,e){let i,n,r,o,a,l,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(d=>(d>this.params.maximumSequenceNumbersToCollect?(ce("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${d}`),n=this.params.maximumSequenceNumbersToCollect):n=d,o=Date.now(),this.nthSequenceNumber(t,n))).next(d=>(i=d,a=Date.now(),this.removeTargets(t,i,e))).next(d=>(r=d,l=Date.now(),this.removeOrphanedDocuments(t,i))).next(d=>(u=Date.now(),Ni()<=Ae.DEBUG&&ce("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-h}ms
	Determined least recently used ${n} in `+(a-o)+`ms
	Removed ${r} targets in `+(l-a)+`ms
	Removed ${d} documents in `+(u-l)+`ms
Total Duration: ${u-h}ms`),K.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:r,documentsRemoved:d})))}}function im(s,t){return new tm(s,t)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nm{constructor(){this.changes=new Ai(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Tt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const i=this.changes.get(e);return i!==void 0?K.resolve(i):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rm{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sm{constructor(t,e,i,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=i,this.indexManager=n}getDocument(t,e){let i=null;return this.documentOverlayCache.getOverlay(t,e).next(n=>(i=n,this.remoteDocumentCache.getEntry(t,e))).next(n=>(i!==null&&Pn(i.mutation,n,At.empty(),Ue.now()),n))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.getLocalViewOfDocuments(t,i,Ce()).next(()=>i))}getLocalViewOfDocuments(t,e,i=Ce()){const n=Si();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,i).next(r=>{let o=yn();return r.forEach((a,l)=>{o=o.insert(a,l.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){const i=Si();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,Ce()))}populateOverlays(t,e,i){const n=[];return i.forEach(r=>{e.has(r)||n.push(r)}),this.documentOverlayCache.getOverlays(t,n).next(r=>{r.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,i,n){let r=$t();const o=Sn(),a=function(){return Sn()}();return e.forEach((l,u)=>{const h=i.get(u.key);n.has(u.key)&&(h===void 0||h.mutation instanceof wi)?r=r.insert(u.key,u):h!==void 0?(o.set(u.key,h.mutation.getFieldMask()),Pn(h.mutation,u,h.mutation.getFieldMask(),Ue.now())):o.set(u.key,At.empty())}),this.recalculateAndSaveOverlays(t,r).next(l=>(l.forEach((u,h)=>o.set(u,h)),e.forEach((u,h)=>{var d;return a.set(u,new rm(h,(d=o.get(u))!==null&&d!==void 0?d:null))}),a))}recalculateAndSaveOverlays(t,e){const i=Sn();let n=new Ge((o,a)=>o-a),r=Ce();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(const a of o)a.keys().forEach(l=>{const u=e.get(l);if(u===null)return;let h=i.get(l)||At.empty();h=a.applyToLocalView(u,h),i.set(l,h);const d=(n.get(a.batchId)||Ce()).add(l);n=n.insert(a.batchId,d)})}).next(()=>{const o=[],a=n.getReverseIterator();for(;a.hasNext();){const l=a.getNext(),u=l.key,h=l.value,d=ec();h.forEach(f=>{if(!r.has(f)){const m=oc(e.get(f),i.get(f));m!==null&&d.set(f,m),r=r.add(f)}}),o.push(this.documentOverlayCache.saveOverlays(t,u,d))}return K.waitFor(o)}).next(()=>i)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(i=>this.recalculateAndSaveOverlays(t,i))}getDocumentsMatchingQuery(t,e,i,n){return function(o){return ve.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Ku(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,i,n):this.getDocumentsMatchingCollectionQuery(t,e,i,n)}getNextDocuments(t,e,i,n){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,i,n).next(r=>{const o=n-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,i.largestBatchId,n-r.size):K.resolve(Si());let a=Dn,l=r;return o.next(u=>K.forEach(u,(h,d)=>(a<d.largestBatchId&&(a=d.largestBatchId),r.get(h)?K.resolve():this.remoteDocumentCache.getEntry(t,h).next(f=>{l=l.insert(h,f)}))).next(()=>this.populateOverlays(t,u,r)).next(()=>this.computeViews(t,l,u,Ce())).next(h=>({batchId:a,changes:$u(h)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new ve(e)).next(i=>{let n=yn();return i.isFoundDocument()&&(n=n.insert(i.key,i)),n})}getDocumentsMatchingCollectionGroupQuery(t,e,i,n){const r=e.collectionGroup;let o=yn();return this.indexManager.getCollectionParents(t,r).next(a=>K.forEach(a,l=>{const u=function(d,f){return new rn(f,null,d.explicitOrderBy.slice(),d.filters.slice(),d.limit,d.limitType,d.startAt,d.endAt)}(e,l.child(r));return this.getDocumentsMatchingCollectionQuery(t,u,i,n).next(h=>{h.forEach((d,f)=>{o=o.insert(d,f)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,i,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,i.largestBatchId).next(o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,i,r,n))).next(o=>{r.forEach((l,u)=>{const h=u.getKey();o.get(h)===null&&(o=o.insert(h,Tt.newInvalidDocument(h)))});let a=yn();return o.forEach((l,u)=>{const h=r.get(l);h!==void 0&&Pn(h.mutation,u,At.empty(),Ue.now()),Xr(e,u)&&(a=a.insert(l,u))}),a})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class om{constructor(t){this.serializer=t,this.Br=new Map,this.Lr=new Map}getBundleMetadata(t,e){return K.resolve(this.Br.get(e))}saveBundleMetadata(t,e){return this.Br.set(e.id,function(n){return{id:n.id,version:n.version,createTime:zt(n.createTime)}}(e)),K.resolve()}getNamedQuery(t,e){return K.resolve(this.Lr.get(e))}saveNamedQuery(t,e){return this.Lr.set(e.name,function(n){return{name:n.name,query:Kg(n.bundledQuery),readTime:zt(n.readTime)}}(e)),K.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class am{constructor(){this.overlays=new Ge(ve.comparator),this.kr=new Map}getOverlay(t,e){return K.resolve(this.overlays.get(e))}getOverlays(t,e){const i=Si();return K.forEach(e,n=>this.getOverlay(t,n).next(r=>{r!==null&&i.set(n,r)})).next(()=>i)}saveOverlays(t,e,i){return i.forEach((n,r)=>{this.wt(t,e,r)}),K.resolve()}removeOverlaysForBatchId(t,e,i){const n=this.kr.get(i);return n!==void 0&&(n.forEach(r=>this.overlays=this.overlays.remove(r)),this.kr.delete(i)),K.resolve()}getOverlaysForCollection(t,e,i){const n=Si(),r=e.length+1,o=new ve(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const l=a.getNext().value,u=l.getKey();if(!e.isPrefixOf(u.path))break;u.path.length===r&&l.largestBatchId>i&&n.set(l.getKey(),l)}return K.resolve(n)}getOverlaysForCollectionGroup(t,e,i,n){let r=new Ge((u,h)=>u-h);const o=this.overlays.getIterator();for(;o.hasNext();){const u=o.getNext().value;if(u.getKey().getCollectionGroup()===e&&u.largestBatchId>i){let h=r.get(u.largestBatchId);h===null&&(h=Si(),r=r.insert(u.largestBatchId,h)),h.set(u.getKey(),u)}}const a=Si(),l=r.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((u,h)=>a.set(u,h)),!(a.size()>=n)););return K.resolve(a)}wt(t,e,i){const n=this.overlays.get(i.key);if(n!==null){const o=this.kr.get(n.largestBatchId).delete(i.key);this.kr.set(n.largestBatchId,o)}this.overlays=this.overlays.insert(i.key,new Pg(e,i));let r=this.kr.get(e);r===void 0&&(r=Ce(),this.kr.set(e,r)),this.kr.set(e,r.add(i.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lm{constructor(){this.sessionToken=ft.EMPTY_BYTE_STRING}getSessionToken(t){return K.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,K.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class To{constructor(){this.qr=new rt(at.Qr),this.$r=new rt(at.Ur)}isEmpty(){return this.qr.isEmpty()}addReference(t,e){const i=new at(t,e);this.qr=this.qr.add(i),this.$r=this.$r.add(i)}Kr(t,e){t.forEach(i=>this.addReference(i,e))}removeReference(t,e){this.Wr(new at(t,e))}Gr(t,e){t.forEach(i=>this.removeReference(i,e))}zr(t){const e=new ve(new Be([])),i=new at(e,t),n=new at(e,t+1),r=[];return this.$r.forEachInRange([i,n],o=>{this.Wr(o),r.push(o.key)}),r}jr(){this.qr.forEach(t=>this.Wr(t))}Wr(t){this.qr=this.qr.delete(t),this.$r=this.$r.delete(t)}Jr(t){const e=new ve(new Be([])),i=new at(e,t),n=new at(e,t+1);let r=Ce();return this.$r.forEachInRange([i,n],o=>{r=r.add(o.key)}),r}containsKey(t){const e=new at(t,0),i=this.qr.firstAfterOrEqual(e);return i!==null&&t.isEqual(i.key)}}class at{constructor(t,e){this.key=t,this.Hr=e}static Qr(t,e){return ve.comparator(t.key,e.key)||be(t.Hr,e.Hr)}static Ur(t,e){return be(t.Hr,e.Hr)||ve.comparator(t.key,e.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class um{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.er=1,this.Yr=new rt(at.Qr)}checkEmpty(t){return K.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,i,n){const r=this.er;this.er++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new Sg(r,e,i,n);this.mutationQueue.push(o);for(const a of n)this.Yr=this.Yr.add(new at(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return K.resolve(o)}lookupMutationBatch(t,e){return K.resolve(this.Zr(e))}getNextMutationBatchAfterBatchId(t,e){const i=e+1,n=this.Xr(i),r=n<0?0:n;return K.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return K.resolve(this.mutationQueue.length===0?uo:this.er-1)}getAllMutationBatches(t){return K.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const i=new at(e,0),n=new at(e,Number.POSITIVE_INFINITY),r=[];return this.Yr.forEachInRange([i,n],o=>{const a=this.Zr(o.Hr);r.push(a)}),K.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let i=new rt(be);return e.forEach(n=>{const r=new at(n,0),o=new at(n,Number.POSITIVE_INFINITY);this.Yr.forEachInRange([r,o],a=>{i=i.add(a.Hr)})}),K.resolve(this.ei(i))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,n=i.length+1;let r=i;ve.isDocumentKey(r)||(r=r.child(""));const o=new at(new ve(r),0);let a=new rt(be);return this.Yr.forEachWhile(l=>{const u=l.key.path;return!!i.isPrefixOf(u)&&(u.length===n&&(a=a.add(l.Hr)),!0)},o),K.resolve(this.ei(a))}ei(t){const e=[];return t.forEach(i=>{const n=this.Zr(i);n!==null&&e.push(n)}),e}removeMutationBatch(t,e){Fe(this.ti(e.batchId,"removed")===0,55003),this.mutationQueue.shift();let i=this.Yr;return K.forEach(e.mutations,n=>{const r=new at(n.key,e.batchId);return i=i.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,n.key)}).next(()=>{this.Yr=i})}rr(t){}containsKey(t,e){const i=new at(e,0),n=this.Yr.firstAfterOrEqual(i);return K.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.mutationQueue.length,K.resolve()}ti(t,e){return this.Xr(t)}Xr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Zr(t){const e=this.Xr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cm{constructor(t){this.ni=t,this.docs=function(){return new Ge(ve.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const i=e.key,n=this.docs.get(i),r=n?n.size:0,o=this.ni(e);return this.docs=this.docs.insert(i,{document:e.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(t,i.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const i=this.docs.get(e);return K.resolve(i?i.document.mutableCopy():Tt.newInvalidDocument(e))}getEntries(t,e){let i=$t();return e.forEach(n=>{const r=this.docs.get(n);i=i.insert(n,r?r.document.mutableCopy():Tt.newInvalidDocument(n))}),K.resolve(i)}getDocumentsMatchingQuery(t,e,i,n){let r=$t();const o=e.path,a=new ve(o.child("__id-9223372036854775808__")),l=this.docs.getIteratorFrom(a);for(;l.hasNext();){const{key:u,value:{document:h}}=l.getNext();if(!o.isPrefixOf(u.path))break;u.path.length>o.length+1||zp(Bp(h),i)<=0||(n.has(h.key)||Xr(e,h))&&(r=r.insert(h.key,h.mutableCopy()))}return K.resolve(r)}getAllFromCollectionGroup(t,e,i,n){we(9500)}ri(t,e){return K.forEach(this.docs,i=>e(i))}newChangeBuffer(t){return new hm(this)}getSize(t){return K.resolve(this.size)}}class hm extends nm{constructor(t){super(),this.Or=t}applyChanges(t){const e=[];return this.changes.forEach((i,n)=>{n.isValidDocument()?e.push(this.Or.addEntry(t,n)):this.Or.removeEntry(i)}),K.waitFor(e)}getFromCache(t,e){return this.Or.getEntry(t,e)}getAllFromCache(t,e){return this.Or.getEntries(t,e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dm{constructor(t){this.persistence=t,this.ii=new Ai(e=>fo(e),po),this.lastRemoteSnapshotVersion=_e.min(),this.highestTargetId=0,this.si=0,this.oi=new To,this.targetCount=0,this._i=Ki.ar()}forEachTarget(t,e){return this.ii.forEach((i,n)=>e(n)),K.resolve()}getLastRemoteSnapshotVersion(t){return K.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return K.resolve(this.si)}allocateTargetId(t){return this.highestTargetId=this._i.next(),K.resolve(this.highestTargetId)}setTargetsMetadata(t,e,i){return i&&(this.lastRemoteSnapshotVersion=i),e>this.si&&(this.si=e),K.resolve()}hr(t){this.ii.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this._i=new Ki(e),this.highestTargetId=e),t.sequenceNumber>this.si&&(this.si=t.sequenceNumber)}addTargetData(t,e){return this.hr(e),this.targetCount+=1,K.resolve()}updateTargetData(t,e){return this.hr(e),K.resolve()}removeTargetData(t,e){return this.ii.delete(e.target),this.oi.zr(e.targetId),this.targetCount-=1,K.resolve()}removeTargets(t,e,i){let n=0;const r=[];return this.ii.forEach((o,a)=>{a.sequenceNumber<=e&&i.get(a.targetId)===null&&(this.ii.delete(o),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),n++)}),K.waitFor(r).next(()=>n)}getTargetCount(t){return K.resolve(this.targetCount)}getTargetData(t,e){const i=this.ii.get(e)||null;return K.resolve(i)}addMatchingKeys(t,e,i){return this.oi.Kr(e,i),K.resolve()}removeMatchingKeys(t,e,i){this.oi.Gr(e,i);const n=this.persistence.referenceDelegate,r=[];return n&&e.forEach(o=>{r.push(n.markPotentiallyOrphaned(t,o))}),K.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.oi.zr(e),K.resolve()}getMatchingKeysForTargetId(t,e){const i=this.oi.Jr(e);return K.resolve(i)}containsKey(t,e){return K.resolve(this.oi.containsKey(e))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wc{constructor(t,e){this.ai={},this.overlays={},this.ui=new Wr(0),this.ci=!1,this.ci=!0,this.li=new lm,this.referenceDelegate=t(this),this.hi=new dm(this),this.indexManager=new Yg,this.remoteDocumentCache=function(n){return new cm(n)}(i=>this.referenceDelegate.Pi(i)),this.serializer=new Xg(e),this.Ti=new om(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.ci=!1,Promise.resolve()}get started(){return this.ci}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new am,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let i=this.ai[t.toKey()];return i||(i=new um(e,this.referenceDelegate),this.ai[t.toKey()]=i),i}getGlobalsCache(){return this.li}getTargetCache(){return this.hi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ti}runTransaction(t,e,i){ce("MemoryPersistence","Starting transaction:",t);const n=new fm(this.ui.next());return this.referenceDelegate.Ii(),i(n).next(r=>this.referenceDelegate.di(n).next(()=>r)).toPromise().then(r=>(n.raiseOnCommittedEvent(),r))}Ei(t,e){return K.or(Object.values(this.ai).map(i=>()=>i.containsKey(t,e)))}}class fm extends Up{constructor(t){super(),this.currentSequenceNumber=t}}class Eo{constructor(t){this.persistence=t,this.Ai=new To,this.Ri=null}static Vi(t){return new Eo(t)}get mi(){if(this.Ri)return this.Ri;throw we(60996)}addReference(t,e,i){return this.Ai.addReference(i,e),this.mi.delete(i.toString()),K.resolve()}removeReference(t,e,i){return this.Ai.removeReference(i,e),this.mi.add(i.toString()),K.resolve()}markPotentiallyOrphaned(t,e){return this.mi.add(e.toString()),K.resolve()}removeTarget(t,e){this.Ai.zr(e.targetId).forEach(n=>this.mi.add(n.toString()));const i=this.persistence.getTargetCache();return i.getMatchingKeysForTargetId(t,e.targetId).next(n=>{n.forEach(r=>this.mi.add(r.toString()))}).next(()=>i.removeTargetData(t,e))}Ii(){this.Ri=new Set}di(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return K.forEach(this.mi,i=>{const n=ve.fromPath(i);return this.fi(t,n).next(r=>{r||e.removeEntry(n,_e.min())})}).next(()=>(this.Ri=null,e.apply(t)))}updateLimboDocument(t,e){return this.fi(t,e).next(i=>{i?this.mi.delete(e.toString()):this.mi.add(e.toString())})}Pi(t){return 0}fi(t,e){return K.or([()=>K.resolve(this.Ai.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ei(t,e)])}}class Nr{constructor(t,e){this.persistence=t,this.gi=new Ai(i=>Gp(i.path),(i,n)=>i.isEqual(n)),this.garbageCollector=im(this,e)}static Vi(t,e){return new Nr(t,e)}Ii(){}di(t){return K.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}mr(t){const e=this.yr(t);return this.persistence.getTargetCache().getTargetCount(t).next(i=>e.next(n=>i+n))}yr(t){let e=0;return this.gr(t,i=>{e++}).next(()=>e)}gr(t,e){return K.forEach(this.gi,(i,n)=>this.Sr(t,i,n).next(r=>r?K.resolve():e(n)))}removeTargets(t,e,i){return this.persistence.getTargetCache().removeTargets(t,e,i)}removeOrphanedDocuments(t,e){let i=0;const n=this.persistence.getRemoteDocumentCache(),r=n.newChangeBuffer();return n.ri(t,o=>this.Sr(t,o,e).next(a=>{a||(i++,r.removeEntry(o,_e.min()))})).next(()=>r.apply(t)).next(()=>i)}markPotentiallyOrphaned(t,e){return this.gi.set(e,t.currentSequenceNumber),K.resolve()}removeTarget(t,e){const i=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,i)}addReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),K.resolve()}removeReference(t,e,i){return this.gi.set(i,t.currentSequenceNumber),K.resolve()}updateLimboDocument(t,e){return this.gi.set(e,t.currentSequenceNumber),K.resolve()}Pi(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=vr(t.data.value)),e}Sr(t,e,i){return K.or([()=>this.persistence.Ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const n=this.gi.get(e);return K.resolve(n!==void 0&&n>i)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xo{constructor(t,e,i,n){this.targetId=t,this.fromCache=e,this.Is=i,this.ds=n}static Es(t,e){let i=Ce(),n=Ce();for(const r of e.docChanges)switch(r.type){case 0:i=i.add(r.doc.key);break;case 1:n=n.add(r.doc.key)}return new xo(t,e.fromCache,i,n)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class pm{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gm{constructor(){this.As=!1,this.Rs=!1,this.Vs=100,this.fs=function(){return cf()?8:jp(lf())>0?6:4}()}initialize(t,e){this.gs=t,this.indexManager=e,this.As=!0}getDocumentsMatchingQuery(t,e,i,n){const r={result:null};return this.ps(t,e).next(o=>{r.result=o}).next(()=>{if(!r.result)return this.ys(t,e,n,i).next(o=>{r.result=o})}).next(()=>{if(r.result)return;const o=new pm;return this.ws(t,e,o).next(a=>{if(r.result=a,this.Rs)return this.Ss(t,e,o,a.size)})}).next(()=>r.result)}Ss(t,e,i,n){return i.documentReadCount<this.Vs?(Ni()<=Ae.DEBUG&&ce("QueryEngine","SDK will not create cache indexes for query:",Bi(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Vs,"documents"),K.resolve()):(Ni()<=Ae.DEBUG&&ce("QueryEngine","Query:",Bi(e),"scans",i.documentReadCount,"local documents and returns",n,"documents as results."),i.documentReadCount>this.fs*n?(Ni()<=Ae.DEBUG&&ce("QueryEngine","The SDK decides to create cache indexes for query:",Bi(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Bt(e))):K.resolve())}ps(t,e){if(yl(e))return K.resolve(null);let i=Bt(e);return this.indexManager.getIndexType(t,i).next(n=>n===0?null:(e.limit!==null&&n===1&&(e=js(e,null,"F"),i=Bt(e)),this.indexManager.getDocumentsMatchingTarget(t,i).next(r=>{const o=Ce(...r);return this.gs.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,i).next(l=>{const u=this.bs(e,a);return this.Ds(e,u,o,l.readTime)?this.ps(t,js(e,null,"F")):this.vs(t,u,e,l)}))})))}ys(t,e,i,n){return yl(e)||n.isEqual(_e.min())?K.resolve(null):this.gs.getDocuments(t,i).next(r=>{const o=this.bs(e,r);return this.Ds(e,o,i,n)?K.resolve(null):(Ni()<=Ae.DEBUG&&ce("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Bi(e)),this.vs(t,o,e,Np(n,Dn)).next(a=>a))})}bs(t,e){let i=new rt(Qu(t));return e.forEach((n,r)=>{Xr(t,r)&&(i=i.add(r))}),i}Ds(t,e,i,n){if(t.limit===null)return!1;if(i.size!==e.size)return!0;const r=t.limitType==="F"?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(n)>0)}ws(t,e,i){return Ni()<=Ae.DEBUG&&ce("QueryEngine","Using full collection scan to execute query:",Bi(e)),this.gs.getDocumentsMatchingQuery(t,e,hi.min(),i)}vs(t,e,i,n){return this.gs.getDocumentsMatchingQuery(t,i,n).next(r=>(e.forEach(o=>{r=r.insert(o.key,o)}),r))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bo="LocalStore",mm=3e8;class vm{constructor(t,e,i,n){this.persistence=t,this.Cs=e,this.serializer=n,this.Fs=new Ge(be),this.Ms=new Ai(r=>fo(r),po),this.xs=new Map,this.Os=t.getRemoteDocumentCache(),this.hi=t.getTargetCache(),this.Ti=t.getBundleCache(),this.Ns(i)}Ns(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new sm(this.Os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Os.setIndexManager(this.indexManager),this.Cs.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Fs))}}function ym(s,t,e,i){return new vm(s,t,e,i)}async function _c(s,t){const e=Ee(s);return await e.persistence.runTransaction("Handle user change","readonly",i=>{let n;return e.mutationQueue.getAllMutationBatches(i).next(r=>(n=r,e.Ns(t),e.mutationQueue.getAllMutationBatches(i))).next(r=>{const o=[],a=[];let l=Ce();for(const u of n){o.push(u.batchId);for(const h of u.mutations)l=l.add(h.key)}for(const u of r){a.push(u.batchId);for(const h of u.mutations)l=l.add(h.key)}return e.localDocuments.getDocuments(i,l).next(u=>({Bs:u,removedBatchIds:o,addedBatchIds:a}))})})}function wm(s,t){const e=Ee(s);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",i=>{const n=t.batch.keys(),r=e.Os.newChangeBuffer({trackRemovals:!0});return function(a,l,u,h){const d=u.batch,f=d.keys();let m=K.resolve();return f.forEach(v=>{m=m.next(()=>h.getEntry(l,v)).next(_=>{const E=u.docVersions.get(v);Fe(E!==null,48541),_.version.compareTo(E)<0&&(d.applyToRemoteDocument(_,u),_.isValidDocument()&&(_.setReadTime(u.commitVersion),h.addEntry(_)))})}),m.next(()=>a.mutationQueue.removeMutationBatch(l,d))}(e,i,t,r).next(()=>r.apply(i)).next(()=>e.mutationQueue.performConsistencyCheck(i)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(i,n,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(i,function(a){let l=Ce();for(let u=0;u<a.mutationResults.length;++u)a.mutationResults[u].transformResults.length>0&&(l=l.add(a.batch.mutations[u].key));return l}(t))).next(()=>e.localDocuments.getDocuments(i,n))})}function Tc(s){const t=Ee(s);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.hi.getLastRemoteSnapshotVersion(e))}function _m(s,t){const e=Ee(s),i=t.snapshotVersion;let n=e.Fs;return e.persistence.runTransaction("Apply remote event","readwrite-primary",r=>{const o=e.Os.newChangeBuffer({trackRemovals:!0});n=e.Fs;const a=[];t.targetChanges.forEach((h,d)=>{const f=n.get(d);if(!f)return;a.push(e.hi.removeMatchingKeys(r,h.removedDocuments,d).next(()=>e.hi.addMatchingKeys(r,h.addedDocuments,d)));let m=f.withSequenceNumber(r.currentSequenceNumber);t.targetMismatches.get(d)!==null?m=m.withResumeToken(ft.EMPTY_BYTE_STRING,_e.min()).withLastLimboFreeSnapshotVersion(_e.min()):h.resumeToken.approximateByteSize()>0&&(m=m.withResumeToken(h.resumeToken,i)),n=n.insert(d,m),function(_,E,b){return _.resumeToken.approximateByteSize()===0||E.snapshotVersion.toMicroseconds()-_.snapshotVersion.toMicroseconds()>=mm?!0:b.addedDocuments.size+b.modifiedDocuments.size+b.removedDocuments.size>0}(f,m,h)&&a.push(e.hi.updateTargetData(r,m))});let l=$t(),u=Ce();if(t.documentUpdates.forEach(h=>{t.resolvedLimboDocuments.has(h)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(r,h))}),a.push(Tm(r,o,t.documentUpdates).next(h=>{l=h.Ls,u=h.ks})),!i.isEqual(_e.min())){const h=e.hi.getLastRemoteSnapshotVersion(r).next(d=>e.hi.setTargetsMetadata(r,r.currentSequenceNumber,i));a.push(h)}return K.waitFor(a).next(()=>o.apply(r)).next(()=>e.localDocuments.getLocalViewOfDocuments(r,l,u)).next(()=>l)}).then(r=>(e.Fs=n,r))}function Tm(s,t,e){let i=Ce(),n=Ce();return e.forEach(r=>i=i.add(r)),t.getEntries(s,i).next(r=>{let o=$t();return e.forEach((a,l)=>{const u=r.get(a);l.isFoundDocument()!==u.isFoundDocument()&&(n=n.add(a)),l.isNoDocument()&&l.version.isEqual(_e.min())?(t.removeEntry(a,l.readTime),o=o.insert(a,l)):!u.isValidDocument()||l.version.compareTo(u.version)>0||l.version.compareTo(u.version)===0&&u.hasPendingWrites?(t.addEntry(l),o=o.insert(a,l)):ce(bo,"Ignoring outdated watch update for ",a,". Current version:",u.version," Watch version:",l.version)}),{Ls:o,ks:n}})}function Em(s,t){const e=Ee(s);return e.persistence.runTransaction("Get next mutation batch","readonly",i=>(t===void 0&&(t=uo),e.mutationQueue.getNextMutationBatchAfterBatchId(i,t)))}function xm(s,t){const e=Ee(s);return e.persistence.runTransaction("Allocate target","readwrite",i=>{let n;return e.hi.getTargetData(i,t).next(r=>r?(n=r,K.resolve(n)):e.hi.allocateTargetId(i).next(o=>(n=new ri(t,o,"TargetPurposeListen",i.currentSequenceNumber),e.hi.addTargetData(i,n).next(()=>n))))}).then(i=>{const n=e.Fs.get(i.targetId);return(n===null||i.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Fs=e.Fs.insert(i.targetId,i),e.Ms.set(t,i.targetId)),i})}async function Xs(s,t,e){const i=Ee(s),n=i.Fs.get(t),r=e?"readwrite":"readwrite-primary";try{e||await i.persistence.runTransaction("Release target",r,o=>i.persistence.referenceDelegate.removeTarget(o,n))}catch(o){if(!nn(o))throw o;ce(bo,`Failed to update sequence numbers for target ${t}: ${o}`)}i.Fs=i.Fs.remove(t),i.Ms.delete(n.target)}function Dl(s,t,e){const i=Ee(s);let n=_e.min(),r=Ce();return i.persistence.runTransaction("Execute query","readwrite",o=>function(l,u,h){const d=Ee(l),f=d.Ms.get(h);return f!==void 0?K.resolve(d.Fs.get(f)):d.hi.getTargetData(u,h)}(i,o,Bt(t)).next(a=>{if(a)return n=a.lastLimboFreeSnapshotVersion,i.hi.getMatchingKeysForTargetId(o,a.targetId).next(l=>{r=l})}).next(()=>i.Cs.getDocumentsMatchingQuery(o,t,e?n:_e.min(),e?r:Ce())).next(a=>(bm(i,cg(t),a),{documents:a,qs:r})))}function bm(s,t,e){let i=s.xs.get(t)||_e.min();e.forEach((n,r)=>{r.readTime.compareTo(i)>0&&(i=r.readTime)}),s.xs.set(t,i)}class Ml{constructor(){this.activeTargetIds=mg()}Gs(t){this.activeTargetIds=this.activeTargetIds.add(t)}zs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ws(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Sm{constructor(){this.Fo=new Ml,this.Mo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,i){}addLocalQueryTarget(t,e=!0){return e&&this.Fo.Gs(t),this.Mo[t]||"not-current"}updateQueryState(t,e,i){this.Mo[t]=e}removeLocalQueryTarget(t){this.Fo.zs(t)}isLocalQueryTarget(t){return this.Fo.activeTargetIds.has(t)}clearQueryState(t){delete this.Mo[t]}getAllActiveQueryTargets(){return this.Fo.activeTargetIds}isActiveQueryTarget(t){return this.Fo.activeTargetIds.has(t)}start(){return this.Fo=new Ml,Promise.resolve()}handleUserChange(t,e,i){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pm{xo(t){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const kl="ConnectivityMonitor";class Fl{constructor(){this.Oo=()=>this.No(),this.Bo=()=>this.Lo(),this.ko=[],this.qo()}xo(t){this.ko.push(t)}shutdown(){window.removeEventListener("online",this.Oo),window.removeEventListener("offline",this.Bo)}qo(){window.addEventListener("online",this.Oo),window.addEventListener("offline",this.Bo)}No(){ce(kl,"Network connectivity changed: AVAILABLE");for(const t of this.ko)t(0)}Lo(){ce(kl,"Network connectivity changed: UNAVAILABLE");for(const t of this.ko)t(1)}static C(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let fr=null;function Ks(){return fr===null?fr=function(){return 268435456+Math.round(2147483648*Math.random())}():fr++,"0x"+fr.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const bs="RestConnection",Cm={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Rm{get Qo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.$o=e+"://"+t.host,this.Uo=`projects/${i}/databases/${n}`,this.Ko=this.databaseId.database===Mr?`project_id=${i}`:`project_id=${i}&database_id=${n}`}Wo(t,e,i,n,r){const o=Ks(),a=this.Go(t,e.toUriEncodedString());ce(bs,`Sending RPC '${t}' ${o}:`,a,i);const l={"google-cloud-resource-prefix":this.Uo,"x-goog-request-params":this.Ko};this.zo(l,n,r);const{host:u}=new URL(a),h=so(u);return this.jo(t,a,l,i,h).then(d=>(ce(bs,`Received RPC '${t}' ${o}: `,d),d),d=>{throw ci(bs,`RPC '${t}' ${o} failed with error: `,d,"url: ",a,"request:",i),d})}Jo(t,e,i,n,r,o){return this.Wo(t,e,i,n,r)}zo(t,e,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+en}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((n,r)=>t[r]=n),i&&i.headers.forEach((n,r)=>t[r]=n)}Go(t,e){const i=Cm[t];return`${this.$o}/v1/${e}:${i}`}terminate(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Im{constructor(t){this.Ho=t.Ho,this.Yo=t.Yo}Zo(t){this.Xo=t}e_(t){this.t_=t}n_(t){this.r_=t}onMessage(t){this.i_=t}close(){this.Yo()}send(t){this.Ho(t)}s_(){this.Xo()}o_(){this.t_()}__(t){this.r_(t)}a_(t){this.i_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wt="WebChannelConnection";class Am extends Rm{constructor(t){super(t),this.u_=[],this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}jo(t,e,i,n,r){const o=Ks();return new Promise((a,l)=>{const u=new xu;u.setWithCredentials(!0),u.listenOnce(bu.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case mr.NO_ERROR:const d=u.getResponseJson();ce(wt,`XHR for RPC '${t}' ${o} received:`,JSON.stringify(d)),a(d);break;case mr.TIMEOUT:ce(wt,`RPC '${t}' ${o} timed out`),l(new ue(G.DEADLINE_EXCEEDED,"Request time out"));break;case mr.HTTP_ERROR:const f=u.getStatus();if(ce(wt,`RPC '${t}' ${o} failed with status:`,f,"response text:",u.getResponseText()),f>0){let m=u.getResponseJson();Array.isArray(m)&&(m=m[0]);const v=m==null?void 0:m.error;if(v&&v.status&&v.message){const _=function(b){const k=b.toLowerCase().replace(/_/g,"-");return Object.values(G).indexOf(k)>=0?k:G.UNKNOWN}(v.status);l(new ue(_,v.message))}else l(new ue(G.UNKNOWN,"Server responded with status "+u.getStatus()))}else l(new ue(G.UNAVAILABLE,"Connection failed."));break;default:we(9055,{c_:t,streamId:o,l_:u.getLastErrorCode(),h_:u.getLastError()})}}finally{ce(wt,`RPC '${t}' ${o} completed.`)}});const h=JSON.stringify(n);ce(wt,`RPC '${t}' ${o} sending request:`,n),u.send(e,"POST",h,i,15)})}P_(t,e,i){const n=Ks(),r=[this.$o,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=Cu(),a=Pu(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;u!==void 0&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.zo(l.initMessageHeaders,e,i),l.encodeInitMessageHeaders=!0;const h=r.join("");ce(wt,`Creating RPC '${t}' stream ${n}: ${h}`,l);const d=o.createWebChannel(h,l);this.T_(d);let f=!1,m=!1;const v=new Im({Ho:E=>{m?ce(wt,`Not sending because RPC '${t}' stream ${n} is closed:`,E):(f||(ce(wt,`Opening RPC '${t}' stream ${n} transport.`),d.open(),f=!0),ce(wt,`RPC '${t}' stream ${n} sending:`,E),d.send(E))},Yo:()=>d.close()}),_=(E,b,k)=>{E.listen(b,V=>{try{k(V)}catch(W){setTimeout(()=>{throw W},0)}})};return _(d,vn.EventType.OPEN,()=>{m||(ce(wt,`RPC '${t}' stream ${n} transport opened.`),v.s_())}),_(d,vn.EventType.CLOSE,()=>{m||(m=!0,ce(wt,`RPC '${t}' stream ${n} transport closed`),v.__(),this.I_(d))}),_(d,vn.EventType.ERROR,E=>{m||(m=!0,ci(wt,`RPC '${t}' stream ${n} transport errored. Name:`,E.name,"Message:",E.message),v.__(new ue(G.UNAVAILABLE,"The operation could not be completed")))}),_(d,vn.EventType.MESSAGE,E=>{var b;if(!m){const k=E.data[0];Fe(!!k,16349);const V=k,W=(V==null?void 0:V.error)||((b=V[0])===null||b===void 0?void 0:b.error);if(W){ce(wt,`RPC '${t}' stream ${n} received error:`,W);const z=W.status;let j=function(I){const M=Ye[I];if(M!==void 0)return lc(M)}(z),D=W.message;j===void 0&&(j=G.INTERNAL,D="Unknown error status: "+z+" with message "+W.message),m=!0,v.__(new ue(j,D)),d.close()}else ce(wt,`RPC '${t}' stream ${n} received:`,k),v.a_(k)}}),_(a,Su.STAT_EVENT,E=>{E.stat===Vs.PROXY?ce(wt,`RPC '${t}' stream ${n} detected buffering proxy`):E.stat===Vs.NOPROXY&&ce(wt,`RPC '${t}' stream ${n} detected no buffering proxy`)}),setTimeout(()=>{v.o_()},0),v}terminate(){this.u_.forEach(t=>t.close()),this.u_=[]}T_(t){this.u_.push(t)}I_(t){this.u_=this.u_.filter(e=>e===t)}}function Ss(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Jr(s){return new Fg(s,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ec{constructor(t,e,i=1e3,n=1.5,r=6e4){this.Fi=t,this.timerId=e,this.d_=i,this.E_=n,this.A_=r,this.R_=0,this.V_=null,this.m_=Date.now(),this.reset()}reset(){this.R_=0}f_(){this.R_=this.A_}g_(t){this.cancel();const e=Math.floor(this.R_+this.p_()),i=Math.max(0,Date.now()-this.m_),n=Math.max(0,e-i);n>0&&ce("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.R_} ms, delay with jitter: ${e} ms, last attempt: ${i} ms ago)`),this.V_=this.Fi.enqueueAfterDelay(this.timerId,n,()=>(this.m_=Date.now(),t())),this.R_*=this.E_,this.R_<this.d_&&(this.R_=this.d_),this.R_>this.A_&&(this.R_=this.A_)}y_(){this.V_!==null&&(this.V_.skipDelay(),this.V_=null)}cancel(){this.V_!==null&&(this.V_.cancel(),this.V_=null)}p_(){return(Math.random()-.5)*this.R_}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ol="PersistentStream";class xc{constructor(t,e,i,n,r,o,a,l){this.Fi=t,this.w_=i,this.S_=n,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=l,this.state=0,this.b_=0,this.D_=null,this.v_=null,this.stream=null,this.C_=0,this.F_=new Ec(t,e)}M_(){return this.state===1||this.state===5||this.x_()}x_(){return this.state===2||this.state===3}start(){this.C_=0,this.state!==4?this.auth():this.O_()}async stop(){this.M_()&&await this.close(0)}N_(){this.state=0,this.F_.reset()}B_(){this.x_()&&this.D_===null&&(this.D_=this.Fi.enqueueAfterDelay(this.w_,6e4,()=>this.L_()))}k_(t){this.q_(),this.stream.send(t)}async L_(){if(this.x_())return this.close(0)}q_(){this.D_&&(this.D_.cancel(),this.D_=null)}Q_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){this.q_(),this.Q_(),this.F_.cancel(),this.b_++,t!==4?this.F_.reset():e&&e.code===G.RESOURCE_EXHAUSTED?(Jt(e.toString()),Jt("Using maximum backoff delay to prevent overloading the backend."),this.F_.f_()):e&&e.code===G.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.U_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.n_(e)}U_(){}auth(){this.state=1;const t=this.K_(this.b_),e=this.b_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([i,n])=>{this.b_===e&&this.W_(i,n)},i=>{t(()=>{const n=new ue(G.UNKNOWN,"Fetching auth token failed: "+i.message);return this.G_(n)})})}W_(t,e){const i=this.K_(this.b_);this.stream=this.z_(t,e),this.stream.Zo(()=>{i(()=>this.listener.Zo())}),this.stream.e_(()=>{i(()=>(this.state=2,this.v_=this.Fi.enqueueAfterDelay(this.S_,1e4,()=>(this.x_()&&(this.state=3),Promise.resolve())),this.listener.e_()))}),this.stream.n_(n=>{i(()=>this.G_(n))}),this.stream.onMessage(n=>{i(()=>++this.C_==1?this.j_(n):this.onNext(n))})}O_(){this.state=5,this.F_.g_(async()=>{this.state=0,this.start()})}G_(t){return ce(Ol,`close with error: ${t}`),this.stream=null,this.close(4,t)}K_(t){return e=>{this.Fi.enqueueAndForget(()=>this.b_===t?e():(ce(Ol,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Dm extends xc{constructor(t,e,i,n,r,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}z_(t,e){return this.connection.P_("Listen",t,e)}j_(t){return this.onNext(t)}onNext(t){this.F_.reset();const e=Lg(this.serializer,t),i=function(r){if(!("targetChange"in r))return _e.min();const o=r.targetChange;return o.targetIds&&o.targetIds.length?_e.min():o.readTime?zt(o.readTime):_e.min()}(t);return this.listener.J_(e,i)}H_(t){const e={};e.database=Zs(this.serializer),e.addTarget=function(r,o){let a;const l=o.target;if(a=Hs(l)?{documents:zg(r,l)}:{query:Hg(r,l).Vt},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=hc(r,o.resumeToken);const u=Ws(r,o.expectedCount);u!==null&&(a.expectedCount=u)}else if(o.snapshotVersion.compareTo(_e.min())>0){a.readTime=Lr(r,o.snapshotVersion.toTimestamp());const u=Ws(r,o.expectedCount);u!==null&&(a.expectedCount=u)}return a}(this.serializer,t);const i=jg(this.serializer,t);i&&(e.labels=i),this.k_(e)}Y_(t){const e={};e.database=Zs(this.serializer),e.removeTarget=t,this.k_(e)}}class Mm extends xc{constructor(t,e,i,n,r,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,i,n,o),this.serializer=r}get Z_(){return this.C_>0}start(){this.lastStreamToken=void 0,super.start()}U_(){this.Z_&&this.X_([])}z_(t,e){return this.connection.P_("Write",t,e)}j_(t){return Fe(!!t.streamToken,31322),this.lastStreamToken=t.streamToken,Fe(!t.writeResults||t.writeResults.length===0,55816),this.listener.ea()}onNext(t){Fe(!!t.streamToken,12678),this.lastStreamToken=t.streamToken,this.F_.reset();const e=Bg(t.writeResults,t.commitTime),i=zt(t.commitTime);return this.listener.ta(i,e)}na(){const t={};t.database=Zs(this.serializer),this.k_(t)}X_(t){const e={streamToken:this.lastStreamToken,writes:t.map(i=>Ng(this.serializer,i))};this.k_(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class km{}class Fm extends km{constructor(t,e,i,n){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=i,this.serializer=n,this.ra=!1}ia(){if(this.ra)throw new ue(G.FAILED_PRECONDITION,"The client has already been terminated.")}Wo(t,e,i,n){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,o])=>this.connection.Wo(t,Gs(e,i),n,r,o)).catch(r=>{throw r.name==="FirebaseError"?(r.code===G.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),r):new ue(G.UNKNOWN,r.toString())})}Jo(t,e,i,n,r){return this.ia(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Jo(t,Gs(e,i),n,o,a,r)).catch(o=>{throw o.name==="FirebaseError"?(o.code===G.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new ue(G.UNKNOWN,o.toString())})}terminate(){this.ra=!0,this.connection.terminate()}}class Om{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.sa=0,this.oa=null,this._a=!0}aa(){this.sa===0&&(this.ua("Unknown"),this.oa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.oa=null,this.ca("Backend didn't respond within 10 seconds."),this.ua("Offline"),Promise.resolve())))}la(t){this.state==="Online"?this.ua("Unknown"):(this.sa++,this.sa>=1&&(this.ha(),this.ca(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ua("Offline")))}set(t){this.ha(),this.sa=0,t==="Online"&&(this._a=!1),this.ua(t)}ua(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ca(t){const e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this._a?(Jt(e),this._a=!1):ce("OnlineStateTracker",e)}ha(){this.oa!==null&&(this.oa.cancel(),this.oa=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ii="RemoteStore";class Vm{constructor(t,e,i,n,r){this.localStore=t,this.datastore=e,this.asyncQueue=i,this.remoteSyncer={},this.Pa=[],this.Ta=new Map,this.Ia=new Set,this.da=[],this.Ea=r,this.Ea.xo(o=>{i.enqueueAndForget(async()=>{Di(this)&&(ce(Ii,"Restarting streams for network reachability change."),await async function(l){const u=Ee(l);u.Ia.add(4),await jn(u),u.Aa.set("Unknown"),u.Ia.delete(4),await $r(u)}(this))})}),this.Aa=new Om(i,n)}}async function $r(s){if(Di(s))for(const t of s.da)await t(!0)}async function jn(s){for(const t of s.da)await t(!1)}function bc(s,t){const e=Ee(s);e.Ta.has(t.targetId)||(e.Ta.set(t.targetId,t),Ro(e)?Co(e):sn(e).x_()&&Po(e,t))}function So(s,t){const e=Ee(s),i=sn(e);e.Ta.delete(t),i.x_()&&Sc(e,t),e.Ta.size===0&&(i.x_()?i.B_():Di(e)&&e.Aa.set("Unknown"))}function Po(s,t){if(s.Ra.$e(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(_e.min())>0){const e=s.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}sn(s).H_(t)}function Sc(s,t){s.Ra.$e(t),sn(s).Y_(t)}function Co(s){s.Ra=new Ag({getRemoteKeysForTarget:t=>s.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>s.Ta.get(t)||null,lt:()=>s.datastore.serializer.databaseId}),sn(s).start(),s.Aa.aa()}function Ro(s){return Di(s)&&!sn(s).M_()&&s.Ta.size>0}function Di(s){return Ee(s).Ia.size===0}function Pc(s){s.Ra=void 0}async function Lm(s){s.Aa.set("Online")}async function Nm(s){s.Ta.forEach((t,e)=>{Po(s,t)})}async function Bm(s,t){Pc(s),Ro(s)?(s.Aa.la(t),Co(s)):s.Aa.set("Unknown")}async function zm(s,t,e){if(s.Aa.set("Online"),t instanceof cc&&t.state===2&&t.cause)try{await async function(n,r){const o=r.cause;for(const a of r.targetIds)n.Ta.has(a)&&(await n.remoteSyncer.rejectListen(a,o),n.Ta.delete(a),n.Ra.removeTarget(a))}(s,t)}catch(i){ce(Ii,"Failed to remove targets %s: %s ",t.targetIds.join(","),i),await Br(s,i)}else if(t instanceof _r?s.Ra.Ye(t):t instanceof uc?s.Ra.it(t):s.Ra.et(t),!e.isEqual(_e.min()))try{const i=await Tc(s.localStore);e.compareTo(i)>=0&&await function(r,o){const a=r.Ra.Pt(o);return a.targetChanges.forEach((l,u)=>{if(l.resumeToken.approximateByteSize()>0){const h=r.Ta.get(u);h&&r.Ta.set(u,h.withResumeToken(l.resumeToken,o))}}),a.targetMismatches.forEach((l,u)=>{const h=r.Ta.get(l);if(!h)return;r.Ta.set(l,h.withResumeToken(ft.EMPTY_BYTE_STRING,h.snapshotVersion)),Sc(r,l);const d=new ri(h.target,l,u,h.sequenceNumber);Po(r,d)}),r.remoteSyncer.applyRemoteEvent(a)}(s,e)}catch(i){ce(Ii,"Failed to raise snapshot:",i),await Br(s,i)}}async function Br(s,t,e){if(!nn(t))throw t;s.Ia.add(1),await jn(s),s.Aa.set("Offline"),e||(e=()=>Tc(s.localStore)),s.asyncQueue.enqueueRetryable(async()=>{ce(Ii,"Retrying IndexedDB access"),await e(),s.Ia.delete(1),await $r(s)})}function Cc(s,t){return t().catch(e=>Br(s,e,t))}async function es(s){const t=Ee(s),e=gi(t);let i=t.Pa.length>0?t.Pa[t.Pa.length-1].batchId:uo;for(;Hm(t);)try{const n=await Em(t.localStore,i);if(n===null){t.Pa.length===0&&e.B_();break}i=n.batchId,Um(t,n)}catch(n){await Br(t,n)}Rc(t)&&Ic(t)}function Hm(s){return Di(s)&&s.Pa.length<10}function Um(s,t){s.Pa.push(t);const e=gi(s);e.x_()&&e.Z_&&e.X_(t.mutations)}function Rc(s){return Di(s)&&!gi(s).M_()&&s.Pa.length>0}function Ic(s){gi(s).start()}async function jm(s){gi(s).na()}async function Wm(s){const t=gi(s);for(const e of s.Pa)t.X_(e.mutations)}async function Gm(s,t,e){const i=s.Pa.shift(),n=yo.from(i,t,e);await Cc(s,()=>s.remoteSyncer.applySuccessfulWrite(n)),await es(s)}async function qm(s,t){t&&gi(s).Z_&&await async function(i,n){if(function(o){return Rg(o)&&o!==G.ABORTED}(n.code)){const r=i.Pa.shift();gi(i).N_(),await Cc(i,()=>i.remoteSyncer.rejectFailedWrite(r.batchId,n)),await es(i)}}(s,t),Rc(s)&&Ic(s)}async function Vl(s,t){const e=Ee(s);e.asyncQueue.verifyOperationInProgress(),ce(Ii,"RemoteStore received new credentials");const i=Di(e);e.Ia.add(3),await jn(e),i&&e.Aa.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ia.delete(3),await $r(e)}async function Zm(s,t){const e=Ee(s);t?(e.Ia.delete(2),await $r(e)):t||(e.Ia.add(2),await jn(e),e.Aa.set("Unknown"))}function sn(s){return s.Va||(s.Va=function(e,i,n){const r=Ee(e);return r.ia(),new Dm(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:Lm.bind(null,s),e_:Nm.bind(null,s),n_:Bm.bind(null,s),J_:zm.bind(null,s)}),s.da.push(async t=>{t?(s.Va.N_(),Ro(s)?Co(s):s.Aa.set("Unknown")):(await s.Va.stop(),Pc(s))})),s.Va}function gi(s){return s.ma||(s.ma=function(e,i,n){const r=Ee(e);return r.ia(),new Mm(i,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(s.datastore,s.asyncQueue,{Zo:()=>Promise.resolve(),e_:jm.bind(null,s),n_:qm.bind(null,s),ea:Wm.bind(null,s),ta:Gm.bind(null,s)}),s.da.push(async t=>{t?(s.ma.N_(),await es(s)):(await s.ma.stop(),s.Pa.length>0&&(ce(Ii,`Stopping write stream with ${s.Pa.length} pending writes`),s.Pa=[]))})),s.ma}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Io{constructor(t,e,i,n,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=i,this.op=n,this.removalCallback=r,this.deferred=new Pi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,i,n,r){const o=Date.now()+i,a=new Io(t,e,o,n,r);return a.start(i),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new ue(G.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ao(s,t){if(Jt("AsyncQueue",`${t}: ${s}`),nn(s))return new ue(G.UNAVAILABLE,`${t}: ${s}`);throw s}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wi{static emptySet(t){return new Wi(t.comparator)}constructor(t){this.comparator=t?(e,i)=>t(e,i)||ve.comparator(e.key,i.key):(e,i)=>ve.comparator(e.key,i.key),this.keyedMap=yn(),this.sortedSet=new Ge(this.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,i)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Wi)||this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),i=t.sortedSet.getIterator();for(;e.hasNext();){const n=e.getNext().key,r=i.getNext().key;if(!n.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){const i=new Wi;return i.comparator=this.comparator,i.keyedMap=t,i.sortedSet=e,i}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ll{constructor(){this.fa=new Ge(ve.comparator)}track(t){const e=t.doc.key,i=this.fa.get(e);i?t.type!==0&&i.type===3?this.fa=this.fa.insert(e,t):t.type===3&&i.type!==1?this.fa=this.fa.insert(e,{type:i.type,doc:t.doc}):t.type===2&&i.type===2?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):t.type===2&&i.type===0?this.fa=this.fa.insert(e,{type:0,doc:t.doc}):t.type===1&&i.type===0?this.fa=this.fa.remove(e):t.type===1&&i.type===2?this.fa=this.fa.insert(e,{type:1,doc:i.doc}):t.type===0&&i.type===1?this.fa=this.fa.insert(e,{type:2,doc:t.doc}):we(63341,{At:t,ga:i}):this.fa=this.fa.insert(e,t)}pa(){const t=[];return this.fa.inorderTraversal((e,i)=>{t.push(i)}),t}}class Yi{constructor(t,e,i,n,r,o,a,l,u){this.query=t,this.docs=e,this.oldDocs=i,this.docChanges=n,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=l,this.hasCachedResults=u}static fromInitialDocuments(t,e,i,n,r){const o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new Yi(t,e,Wi.emptySet(e),o,i,n,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Zr(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,i=t.docChanges;if(e.length!==i.length)return!1;for(let n=0;n<e.length;n++)if(e[n].type!==i[n].type||!e[n].doc.isEqual(i[n].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xm{constructor(){this.ya=void 0,this.wa=[]}Sa(){return this.wa.some(t=>t.ba())}}class Km{constructor(){this.queries=Nl(),this.onlineState="Unknown",this.Da=new Set}terminate(){(function(e,i){const n=Ee(e),r=n.queries;n.queries=Nl(),r.forEach((o,a)=>{for(const l of a.wa)l.onError(i)})})(this,new ue(G.ABORTED,"Firestore shutting down"))}}function Nl(){return new Ai(s=>Yu(s),Zr)}async function Ym(s,t){const e=Ee(s);let i=3;const n=t.query;let r=e.queries.get(n);r?!r.Sa()&&t.ba()&&(i=2):(r=new Xm,i=t.ba()?0:1);try{switch(i){case 0:r.ya=await e.onListen(n,!0);break;case 1:r.ya=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(o){const a=Ao(o,`Initialization of query '${Bi(t.query)}' failed`);return void t.onError(a)}e.queries.set(n,r),r.wa.push(t),t.va(e.onlineState),r.ya&&t.Ca(r.ya)&&Do(e)}async function Qm(s,t){const e=Ee(s),i=t.query;let n=3;const r=e.queries.get(i);if(r){const o=r.wa.indexOf(t);o>=0&&(r.wa.splice(o,1),r.wa.length===0?n=t.ba()?0:1:!r.Sa()&&t.ba()&&(n=2))}switch(n){case 0:return e.queries.delete(i),e.onUnlisten(i,!0);case 1:return e.queries.delete(i),e.onUnlisten(i,!1);case 2:return e.onLastRemoteStoreUnlisten(i);default:return}}function Jm(s,t){const e=Ee(s);let i=!1;for(const n of t){const r=n.query,o=e.queries.get(r);if(o){for(const a of o.wa)a.Ca(n)&&(i=!0);o.ya=n}}i&&Do(e)}function $m(s,t,e){const i=Ee(s),n=i.queries.get(t);if(n)for(const r of n.wa)r.onError(e);i.queries.delete(t)}function Do(s){s.Da.forEach(t=>{t.next()})}var Ys,Bl;(Bl=Ys||(Ys={})).Fa="default",Bl.Cache="cache";class ev{constructor(t,e,i){this.query=t,this.Ma=e,this.xa=!1,this.Oa=null,this.onlineState="Unknown",this.options=i||{}}Ca(t){if(!this.options.includeMetadataChanges){const i=[];for(const n of t.docChanges)n.type!==3&&i.push(n);t=new Yi(t.query,t.docs,t.oldDocs,i,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.xa?this.Na(t)&&(this.Ma.next(t),e=!0):this.Ba(t,this.onlineState)&&(this.La(t),e=!0),this.Oa=t,e}onError(t){this.Ma.error(t)}va(t){this.onlineState=t;let e=!1;return this.Oa&&!this.xa&&this.Ba(this.Oa,t)&&(this.La(this.Oa),e=!0),e}Ba(t,e){if(!t.fromCache||!this.ba())return!0;const i=e!=="Offline";return(!this.options.ka||!i)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}Na(t){if(t.docChanges.length>0)return!0;const e=this.Oa&&this.Oa.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}La(t){t=Yi.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.xa=!0,this.Ma.next(t)}ba(){return this.options.source!==Ys.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ac{constructor(t){this.key=t}}class Dc{constructor(t){this.key=t}}class tv{constructor(t,e){this.query=t,this.Ha=e,this.Ya=null,this.hasCachedResults=!1,this.current=!1,this.Za=Ce(),this.mutatedKeys=Ce(),this.Xa=Qu(t),this.eu=new Wi(this.Xa)}get tu(){return this.Ha}nu(t,e){const i=e?e.ru:new Ll,n=e?e.eu:this.eu;let r=e?e.mutatedKeys:this.mutatedKeys,o=n,a=!1;const l=this.query.limitType==="F"&&n.size===this.query.limit?n.last():null,u=this.query.limitType==="L"&&n.size===this.query.limit?n.first():null;if(t.inorderTraversal((h,d)=>{const f=n.get(h),m=Xr(this.query,d)?d:null,v=!!f&&this.mutatedKeys.has(f.key),_=!!m&&(m.hasLocalMutations||this.mutatedKeys.has(m.key)&&m.hasCommittedMutations);let E=!1;f&&m?f.data.isEqual(m.data)?v!==_&&(i.track({type:3,doc:m}),E=!0):this.iu(f,m)||(i.track({type:2,doc:m}),E=!0,(l&&this.Xa(m,l)>0||u&&this.Xa(m,u)<0)&&(a=!0)):!f&&m?(i.track({type:0,doc:m}),E=!0):f&&!m&&(i.track({type:1,doc:f}),E=!0,(l||u)&&(a=!0)),E&&(m?(o=o.add(m),r=_?r.add(h):r.delete(h)):(o=o.delete(h),r=r.delete(h)))}),this.query.limit!==null)for(;o.size>this.query.limit;){const h=this.query.limitType==="F"?o.last():o.first();o=o.delete(h.key),r=r.delete(h.key),i.track({type:1,doc:h})}return{eu:o,ru:i,Ds:a,mutatedKeys:r}}iu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,i,n){const r=this.eu;this.eu=t.eu,this.mutatedKeys=t.mutatedKeys;const o=t.ru.pa();o.sort((h,d)=>function(m,v){const _=E=>{switch(E){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return we(20277,{At:E})}};return _(m)-_(v)}(h.type,d.type)||this.Xa(h.doc,d.doc)),this.su(i),n=n!=null&&n;const a=e&&!n?this.ou():[],l=this.Za.size===0&&this.current&&!n?1:0,u=l!==this.Ya;return this.Ya=l,o.length!==0||u?{snapshot:new Yi(this.query,t.eu,r,o,t.mutatedKeys,l===0,u,!1,!!i&&i.resumeToken.approximateByteSize()>0),_u:a}:{_u:a}}va(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({eu:this.eu,ru:new Ll,mutatedKeys:this.mutatedKeys,Ds:!1},!1)):{_u:[]}}au(t){return!this.Ha.has(t)&&!!this.eu.has(t)&&!this.eu.get(t).hasLocalMutations}su(t){t&&(t.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=t.current)}ou(){if(!this.current)return[];const t=this.Za;this.Za=Ce(),this.eu.forEach(i=>{this.au(i.key)&&(this.Za=this.Za.add(i.key))});const e=[];return t.forEach(i=>{this.Za.has(i)||e.push(new Dc(i))}),this.Za.forEach(i=>{t.has(i)||e.push(new Ac(i))}),e}uu(t){this.Ha=t.qs,this.Za=Ce();const e=this.nu(t.documents);return this.applyChanges(e,!0)}cu(){return Yi.fromInitialDocuments(this.query,this.eu,this.mutatedKeys,this.Ya===0,this.hasCachedResults)}}const Mo="SyncEngine";class iv{constructor(t,e,i){this.query=t,this.targetId=e,this.view=i}}class nv{constructor(t){this.key=t,this.lu=!1}}class rv{constructor(t,e,i,n,r,o){this.localStore=t,this.remoteStore=e,this.eventManager=i,this.sharedClientState=n,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.hu={},this.Pu=new Ai(a=>Yu(a),Zr),this.Tu=new Map,this.Iu=new Set,this.du=new Ge(ve.comparator),this.Eu=new Map,this.Au=new To,this.Ru={},this.Vu=new Map,this.mu=Ki.ur(),this.onlineState="Unknown",this.fu=void 0}get isPrimaryClient(){return this.fu===!0}}async function sv(s,t,e=!0){const i=Lc(s);let n;const r=i.Pu.get(t);return r?(i.sharedClientState.addLocalQueryTarget(r.targetId),n=r.view.cu()):n=await Mc(i,t,e,!0),n}async function ov(s,t){const e=Lc(s);await Mc(e,t,!0,!1)}async function Mc(s,t,e,i){const n=await xm(s.localStore,Bt(t)),r=n.targetId,o=s.sharedClientState.addLocalQueryTarget(r,e);let a;return i&&(a=await av(s,t,r,o==="current",n.resumeToken)),s.isPrimaryClient&&e&&bc(s.remoteStore,n),a}async function av(s,t,e,i,n){s.gu=(d,f,m)=>async function(_,E,b,k){let V=E.view.nu(b);V.Ds&&(V=await Dl(_.localStore,E.query,!1).then(({documents:D})=>E.view.nu(D,V)));const W=k&&k.targetChanges.get(E.targetId),z=k&&k.targetMismatches.get(E.targetId)!=null,j=E.view.applyChanges(V,_.isPrimaryClient,W,z);return Hl(_,E.targetId,j._u),j.snapshot}(s,d,f,m);const r=await Dl(s.localStore,t,!0),o=new tv(t,r.qs),a=o.nu(r.documents),l=Un.createSynthesizedTargetChangeForCurrentChange(e,i&&s.onlineState!=="Offline",n),u=o.applyChanges(a,s.isPrimaryClient,l);Hl(s,e,u._u);const h=new iv(t,e,o);return s.Pu.set(t,h),s.Tu.has(e)?s.Tu.get(e).push(t):s.Tu.set(e,[t]),u.snapshot}async function lv(s,t,e){const i=Ee(s),n=i.Pu.get(t),r=i.Tu.get(n.targetId);if(r.length>1)return i.Tu.set(n.targetId,r.filter(o=>!Zr(o,t))),void i.Pu.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(n.targetId),i.sharedClientState.isActiveQueryTarget(n.targetId)||await Xs(i.localStore,n.targetId,!1).then(()=>{i.sharedClientState.clearQueryState(n.targetId),e&&So(i.remoteStore,n.targetId),Qs(i,n.targetId)}).catch(tn)):(Qs(i,n.targetId),await Xs(i.localStore,n.targetId,!0))}async function uv(s,t){const e=Ee(s),i=e.Pu.get(t),n=e.Tu.get(i.targetId);e.isPrimaryClient&&n.length===1&&(e.sharedClientState.removeLocalQueryTarget(i.targetId),So(e.remoteStore,i.targetId))}async function cv(s,t,e){const i=vv(s);try{const n=await function(o,a){const l=Ee(o),u=Ue.now(),h=a.reduce((m,v)=>m.add(v.key),Ce());let d,f;return l.persistence.runTransaction("Locally write mutations","readwrite",m=>{let v=$t(),_=Ce();return l.Os.getEntries(m,h).next(E=>{v=E,v.forEach((b,k)=>{k.isValidDocument()||(_=_.add(b))})}).next(()=>l.localDocuments.getOverlayedDocuments(m,v)).next(E=>{d=E;const b=[];for(const k of a){const V=xg(k,d.get(k.key).overlayedDocument);V!=null&&b.push(new wi(k.key,V,Uu(V.value.mapValue),Vt.exists(!0)))}return l.mutationQueue.addMutationBatch(m,u,b,a)}).next(E=>{f=E;const b=E.applyToLocalDocumentSet(d,_);return l.documentOverlayCache.saveOverlays(m,E.batchId,b)})}).then(()=>({batchId:f.batchId,changes:$u(d)}))}(i.localStore,t);i.sharedClientState.addPendingMutation(n.batchId),function(o,a,l){let u=o.Ru[o.currentUser.toKey()];u||(u=new Ge(be)),u=u.insert(a,l),o.Ru[o.currentUser.toKey()]=u}(i,n.batchId,e),await Wn(i,n.changes),await es(i.remoteStore)}catch(n){const r=Ao(n,"Failed to persist write");e.reject(r)}}async function kc(s,t){const e=Ee(s);try{const i=await _m(e.localStore,t);t.targetChanges.forEach((n,r)=>{const o=e.Eu.get(r);o&&(Fe(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,22616),n.addedDocuments.size>0?o.lu=!0:n.modifiedDocuments.size>0?Fe(o.lu,14607):n.removedDocuments.size>0&&(Fe(o.lu,42227),o.lu=!1))}),await Wn(e,i,t)}catch(i){await tn(i)}}function zl(s,t,e){const i=Ee(s);if(i.isPrimaryClient&&e===0||!i.isPrimaryClient&&e===1){const n=[];i.Pu.forEach((r,o)=>{const a=o.view.va(t);a.snapshot&&n.push(a.snapshot)}),function(o,a){const l=Ee(o);l.onlineState=a;let u=!1;l.queries.forEach((h,d)=>{for(const f of d.wa)f.va(a)&&(u=!0)}),u&&Do(l)}(i.eventManager,t),n.length&&i.hu.J_(n),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function hv(s,t,e){const i=Ee(s);i.sharedClientState.updateQueryState(t,"rejected",e);const n=i.Eu.get(t),r=n&&n.key;if(r){let o=new Ge(ve.comparator);o=o.insert(r,Tt.newNoDocument(r,_e.min()));const a=Ce().add(r),l=new Qr(_e.min(),new Map,new Ge(be),o,a);await kc(i,l),i.du=i.du.remove(r),i.Eu.delete(t),ko(i)}else await Xs(i.localStore,t,!1).then(()=>Qs(i,t,e)).catch(tn)}async function dv(s,t){const e=Ee(s),i=t.batch.batchId;try{const n=await wm(e.localStore,t);Oc(e,i,null),Fc(e,i),e.sharedClientState.updateMutationState(i,"acknowledged"),await Wn(e,n)}catch(n){await tn(n)}}async function fv(s,t,e){const i=Ee(s);try{const n=await function(o,a){const l=Ee(o);return l.persistence.runTransaction("Reject batch","readwrite-primary",u=>{let h;return l.mutationQueue.lookupMutationBatch(u,a).next(d=>(Fe(d!==null,37113),h=d.keys(),l.mutationQueue.removeMutationBatch(u,d))).next(()=>l.mutationQueue.performConsistencyCheck(u)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(u,h,a)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(u,h)).next(()=>l.localDocuments.getDocuments(u,h))})}(i.localStore,t);Oc(i,t,e),Fc(i,t),i.sharedClientState.updateMutationState(t,"rejected",e),await Wn(i,n)}catch(n){await tn(n)}}function Fc(s,t){(s.Vu.get(t)||[]).forEach(e=>{e.resolve()}),s.Vu.delete(t)}function Oc(s,t,e){const i=Ee(s);let n=i.Ru[i.currentUser.toKey()];if(n){const r=n.get(t);r&&(e?r.reject(e):r.resolve(),n=n.remove(t)),i.Ru[i.currentUser.toKey()]=n}}function Qs(s,t,e=null){s.sharedClientState.removeLocalQueryTarget(t);for(const i of s.Tu.get(t))s.Pu.delete(i),e&&s.hu.pu(i,e);s.Tu.delete(t),s.isPrimaryClient&&s.Au.zr(t).forEach(i=>{s.Au.containsKey(i)||Vc(s,i)})}function Vc(s,t){s.Iu.delete(t.path.canonicalString());const e=s.du.get(t);e!==null&&(So(s.remoteStore,e),s.du=s.du.remove(t),s.Eu.delete(e),ko(s))}function Hl(s,t,e){for(const i of e)i instanceof Ac?(s.Au.addReference(i.key,t),pv(s,i)):i instanceof Dc?(ce(Mo,"Document no longer in limbo: "+i.key),s.Au.removeReference(i.key,t),s.Au.containsKey(i.key)||Vc(s,i.key)):we(19791,{yu:i})}function pv(s,t){const e=t.key,i=e.path.canonicalString();s.du.get(e)||s.Iu.has(i)||(ce(Mo,"New document in limbo: "+e),s.Iu.add(i),ko(s))}function ko(s){for(;s.Iu.size>0&&s.du.size<s.maxConcurrentLimboResolutions;){const t=s.Iu.values().next().value;s.Iu.delete(t);const e=new ve(Be.fromString(t)),i=s.mu.next();s.Eu.set(i,new nv(e)),s.du=s.du.insert(e,i),bc(s.remoteStore,new ri(Bt(go(e.path)),i,"TargetPurposeLimboResolution",Wr.ue))}}async function Wn(s,t,e){const i=Ee(s),n=[],r=[],o=[];i.Pu.isEmpty()||(i.Pu.forEach((a,l)=>{o.push(i.gu(l,t,e).then(u=>{var h;if((u||e)&&i.isPrimaryClient){const d=u?!u.fromCache:(h=e==null?void 0:e.targetChanges.get(l.targetId))===null||h===void 0?void 0:h.current;i.sharedClientState.updateQueryState(l.targetId,d?"current":"not-current")}if(u){n.push(u);const d=xo.Es(l.targetId,u);r.push(d)}}))}),await Promise.all(o),i.hu.J_(n),await async function(l,u){const h=Ee(l);try{await h.persistence.runTransaction("notifyLocalViewChanges","readwrite",d=>K.forEach(u,f=>K.forEach(f.Is,m=>h.persistence.referenceDelegate.addReference(d,f.targetId,m)).next(()=>K.forEach(f.ds,m=>h.persistence.referenceDelegate.removeReference(d,f.targetId,m)))))}catch(d){if(!nn(d))throw d;ce(bo,"Failed to update sequence numbers: "+d)}for(const d of u){const f=d.targetId;if(!d.fromCache){const m=h.Fs.get(f),v=m.snapshotVersion,_=m.withLastLimboFreeSnapshotVersion(v);h.Fs=h.Fs.insert(f,_)}}}(i.localStore,r))}async function gv(s,t){const e=Ee(s);if(!e.currentUser.isEqual(t)){ce(Mo,"User change. New user:",t.toKey());const i=await _c(e.localStore,t);e.currentUser=t,function(r,o){r.Vu.forEach(a=>{a.forEach(l=>{l.reject(new ue(G.CANCELLED,o))})}),r.Vu.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await Wn(e,i.Bs)}}function mv(s,t){const e=Ee(s),i=e.Eu.get(t);if(i&&i.lu)return Ce().add(i.key);{let n=Ce();const r=e.Tu.get(t);if(!r)return n;for(const o of r){const a=e.Pu.get(o);n=n.unionWith(a.view.tu)}return n}}function Lc(s){const t=Ee(s);return t.remoteStore.remoteSyncer.applyRemoteEvent=kc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=mv.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=hv.bind(null,t),t.hu.J_=Jm.bind(null,t.eventManager),t.hu.pu=$m.bind(null,t.eventManager),t}function vv(s){const t=Ee(s);return t.remoteStore.remoteSyncer.applySuccessfulWrite=dv.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=fv.bind(null,t),t}class zr{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=Jr(t.databaseInfo.databaseId),this.sharedClientState=this.bu(t),this.persistence=this.Du(t),await this.persistence.start(),this.localStore=this.vu(t),this.gcScheduler=this.Cu(t,this.localStore),this.indexBackfillerScheduler=this.Fu(t,this.localStore)}Cu(t,e){return null}Fu(t,e){return null}vu(t){return ym(this.persistence,new gm,t.initialUser,this.serializer)}Du(t){return new wc(Eo.Vi,this.serializer)}bu(t){return new Sm}async terminate(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}zr.provider={build:()=>new zr};class yv extends zr{constructor(t){super(),this.cacheSizeBytes=t}Cu(t,e){Fe(this.persistence.referenceDelegate instanceof Nr,46915);const i=this.persistence.referenceDelegate.garbageCollector;return new em(i,t.asyncQueue,e)}Du(t){const e=this.cacheSizeBytes!==void 0?St.withCacheSize(this.cacheSizeBytes):St.DEFAULT;return new wc(i=>Nr.Vi(i,e),this.serializer)}}class Js{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>zl(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=gv.bind(null,this.syncEngine),await Zm(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return function(){return new Km}()}createDatastore(t){const e=Jr(t.databaseInfo.databaseId),i=function(r){return new Am(r)}(t.databaseInfo);return function(r,o,a,l){return new Fm(r,o,a,l)}(t.authCredentials,t.appCheckCredentials,i,e)}createRemoteStore(t){return function(i,n,r,o,a){return new Vm(i,n,r,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>zl(this.syncEngine,e,0),function(){return Fl.C()?new Fl:new Pm}())}createSyncEngine(t,e){return function(n,r,o,a,l,u,h){const d=new rv(n,r,o,a,l,u);return h&&(d.fu=!0),d}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(n){const r=Ee(n);ce(Ii,"RemoteStore shutting down."),r.Ia.add(5),await jn(r),r.Ea.shutdown(),r.Aa.set("Unknown")}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(e=this.eventManager)===null||e===void 0||e.terminate()}}Js.provider={build:()=>new Js};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wv{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.xu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.xu(this.observer.error,t):Jt("Uncaught Error in snapshot listener:",t.toString()))}Ou(){this.muted=!0}xu(t,e){setTimeout(()=>{this.muted||t(e)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const mi="FirestoreClient";class _v{constructor(t,e,i,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=i,this.databaseInfo=n,this.user=_t.UNAUTHENTICATED,this.clientId=lo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=r,this.authCredentials.start(i,async o=>{ce(mi,"Received user=",o.uid),await this.authCredentialListener(o),this.user=o}),this.appCheckCredentials.start(i,o=>(ce(mi,"Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Pi;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const i=Ao(e,"Failed to shutdown persistence");t.reject(i)}}),t.promise}}async function Ps(s,t){s.asyncQueue.verifyOperationInProgress(),ce(mi,"Initializing OfflineComponentProvider");const e=s.configuration;await t.initialize(e);let i=e.initialUser;s.setCredentialChangeListener(async n=>{i.isEqual(n)||(await _c(t.localStore,n),i=n)}),t.persistence.setDatabaseDeletedListener(()=>{ci("Terminating Firestore due to IndexedDb database deletion"),s.terminate().then(()=>{ce("Terminating Firestore due to IndexedDb database deletion completed successfully")}).catch(n=>{ci("Terminating Firestore due to IndexedDb database deletion failed",n)})}),s._offlineComponents=t}async function Ul(s,t){s.asyncQueue.verifyOperationInProgress();const e=await Tv(s);ce(mi,"Initializing OnlineComponentProvider"),await t.initialize(e,s.configuration),s.setCredentialChangeListener(i=>Vl(t.remoteStore,i)),s.setAppCheckTokenChangeListener((i,n)=>Vl(t.remoteStore,n)),s._onlineComponents=t}async function Tv(s){if(!s._offlineComponents)if(s._uninitializedComponentsProvider){ce(mi,"Using user provided OfflineComponentProvider");try{await Ps(s,s._uninitializedComponentsProvider._offline)}catch(t){const e=t;if(!function(n){return n.name==="FirebaseError"?n.code===G.FAILED_PRECONDITION||n.code===G.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}(e))throw e;ci("Error using user provided cache. Falling back to memory cache: "+e),await Ps(s,new zr)}}else ce(mi,"Using default OfflineComponentProvider"),await Ps(s,new yv(void 0));return s._offlineComponents}async function Nc(s){return s._onlineComponents||(s._uninitializedComponentsProvider?(ce(mi,"Using user provided OnlineComponentProvider"),await Ul(s,s._uninitializedComponentsProvider._online)):(ce(mi,"Using default OnlineComponentProvider"),await Ul(s,new Js))),s._onlineComponents}function Ev(s){return Nc(s).then(t=>t.syncEngine)}async function jl(s){const t=await Nc(s),e=t.eventManager;return e.onListen=sv.bind(null,t.syncEngine),e.onUnlisten=lv.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=ov.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=uv.bind(null,t.syncEngine),e}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Bc(s){const t={};return s.timeoutSeconds!==void 0&&(t.timeoutSeconds=s.timeoutSeconds),t}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wl=new Map;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zc="firestore.googleapis.com",Gl=!0;class ql{constructor(t){var e,i;if(t.host===void 0){if(t.ssl!==void 0)throw new ue(G.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=zc,this.ssl=Gl}else this.host=t.host,this.ssl=(e=t.ssl)!==null&&e!==void 0?e:Gl;if(this.isUsingEmulator=t.emulatorOptions!==void 0,this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=yc;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<Jg)throw new ue(G.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Lp("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Bc((i=t.experimentalLongPollingOptions)!==null&&i!==void 0?i:{}),function(r){if(r.timeoutSeconds!==void 0){if(isNaN(r.timeoutSeconds))throw new ue(G.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (must not be NaN)`);if(r.timeoutSeconds<5)throw new ue(G.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (minimum allowed value is 5)`);if(r.timeoutSeconds>30)throw new ue(G.INVALID_ARGUMENT,`invalid long polling timeout: ${r.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(i,n){return i.timeoutSeconds===n.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class ts{constructor(t,e,i,n){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=i,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new ql({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new ue(G.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new ue(G.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new ql(t),this._emulatorOptions=t.emulatorOptions||{},t.credentials!==void 0&&(this._authCredentials=function(i){if(!i)return new Rp;switch(i.type){case"firstParty":return new Mp(i.sessionIndex||"0",i.iamToken||null,i.authTokenFactory||null);case"provider":return i.client;default:throw new ue(G.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const i=Wl.get(e);i&&(ce("ComponentProvider","Removing Datastore"),Wl.delete(e),i.terminate())}(this),Promise.resolve()}}function xv(s,t,e,i={}){var n;s=li(s,ts);const r=so(t),o=s._getSettings(),a=Object.assign(Object.assign({},o),{emulatorOptions:s._getEmulatorOptions()}),l=`${t}:${e}`;r&&(nf(`https://${l}`),af("Firestore",!0)),o.host!==zc&&o.host!==l&&ci("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const u=Object.assign(Object.assign({},o),{host:l,ssl:r,emulatorOptions:i});if(!Rr(u,a)&&(s._setSettings(u),i.mockUserToken)){let h,d;if(typeof i.mockUserToken=="string")h=i.mockUserToken,d=_t.MOCK_USER;else{h=rf(i.mockUserToken,(n=s._app)===null||n===void 0?void 0:n.options.projectId);const f=i.mockUserToken.sub||i.mockUserToken.user_id;if(!f)throw new ue(G.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");d=new _t(f)}s._authCredentials=new Ip(new Iu(h,d))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mi{constructor(t,e,i){this.converter=e,this._query=i,this.type="query",this.firestore=t}withConverter(t){return new Mi(this.firestore,t,this._query)}}class et{constructor(t,e,i){this.converter=e,this._key=i,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ui(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new et(this.firestore,t,this._key)}toJSON(){return{type:et._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(t,e,i){if(zn(e,et._jsonSchema))return new et(t,i||null,new ve(Be.fromString(e.referencePath)))}}et._jsonSchemaVersion="firestore/documentReference/1.0",et._jsonSchema={type:$e("string",et._jsonSchemaVersion),referencePath:$e("string")};class ui extends Mi{constructor(t,e,i){super(t,e,go(i)),this._path=i,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new et(this.firestore,null,new ve(t))}withConverter(t){return new ui(this.firestore,t,this._path)}}function Zl(s,t,...e){if(s=Wt(s),Du("collection","path",t),s instanceof ts){const i=Be.fromString(t,...e);return rl(i),new ui(s,null,i)}{if(!(s instanceof et||s instanceof ui))throw new ue(G.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Be.fromString(t,...e));return rl(i),new ui(s.firestore,null,i)}}function $s(s,t,...e){if(s=Wt(s),arguments.length===1&&(t=lo.newId()),Du("doc","path",t),s instanceof ts){const i=Be.fromString(t,...e);return nl(i),new et(s,null,new ve(i))}{if(!(s instanceof et||s instanceof ui))throw new ue(G.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=s._path.child(Be.fromString(t,...e));return nl(i),new et(s.firestore,s instanceof ui?s.converter:null,new ve(i))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Xl="AsyncQueue";class Kl{constructor(t=Promise.resolve()){this.Zu=[],this.Xu=!1,this.ec=[],this.tc=null,this.nc=!1,this.rc=!1,this.sc=[],this.F_=new Ec(this,"async_queue_retry"),this.oc=()=>{const i=Ss();i&&ce(Xl,"Visibility state changed to "+i.visibilityState),this.F_.y_()},this._c=t;const e=Ss();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.oc)}get isShuttingDown(){return this.Xu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ac(),this.uc(t)}enterRestrictedMode(t){if(!this.Xu){this.Xu=!0,this.rc=t||!1;const e=Ss();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.oc)}}enqueue(t){if(this.ac(),this.Xu)return new Promise(()=>{});const e=new Pi;return this.uc(()=>this.Xu&&this.rc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Zu.push(t),this.cc()))}async cc(){if(this.Zu.length!==0){try{await this.Zu[0](),this.Zu.shift(),this.F_.reset()}catch(t){if(!nn(t))throw t;ce(Xl,"Operation failed with retryable error: "+t)}this.Zu.length>0&&this.F_.g_(()=>this.cc())}}uc(t){const e=this._c.then(()=>(this.nc=!0,t().catch(i=>{throw this.tc=i,this.nc=!1,Jt("INTERNAL UNHANDLED ERROR: ",Yl(i)),i}).then(i=>(this.nc=!1,i))));return this._c=e,e}enqueueAfterDelay(t,e,i){this.ac(),this.sc.indexOf(t)>-1&&(e=0);const n=Io.createAndSchedule(this,t,e,i,r=>this.lc(r));return this.ec.push(n),n}ac(){this.tc&&we(47125,{hc:Yl(this.tc)})}verifyOperationInProgress(){}async Pc(){let t;do t=this._c,await t;while(t!==this._c)}Tc(t){for(const e of this.ec)if(e.timerId===t)return!0;return!1}Ic(t){return this.Pc().then(()=>{this.ec.sort((e,i)=>e.targetTimeMs-i.targetTimeMs);for(const e of this.ec)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.Pc()})}dc(t){this.sc.push(t)}lc(t){const e=this.ec.indexOf(t);this.ec.splice(e,1)}}function Yl(s){let t=s.message||"";return s.stack&&(t=s.stack.includes(s.message)?s.stack:s.message+`
`+s.stack),t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ql(s){return function(e,i){if(typeof e!="object"||e===null)return!1;const n=e;for(const r of i)if(r in n&&typeof n[r]=="function")return!0;return!1}(s,["next","error","complete"])}class Qi extends ts{constructor(t,e,i,n){super(t,e,i,n),this.type="firestore",this._queue=new Kl,this._persistenceKey=(n==null?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new Kl(t),this._firestoreClient=void 0,await t}}}function bv(s,t){const e=typeof s=="object"?s:vp(),i=typeof s=="string"?s:Mr,n=dp(e,"firestore").getImmediate({identifier:i});if(!n._initialized){const r=ef("firestore");r&&xv(n,...r)}return n}function Hc(s){if(s._terminated)throw new ue(G.FAILED_PRECONDITION,"The client has already been terminated.");return s._firestoreClient||Sv(s),s._firestoreClient}function Sv(s){var t,e,i;const n=s._freezeSettings(),r=function(a,l,u,h){return new Xp(a,l,u,h.host,h.ssl,h.experimentalForceLongPolling,h.experimentalAutoDetectLongPolling,Bc(h.experimentalLongPollingOptions),h.useFetchStreams,h.isUsingEmulator)}(s._databaseId,((t=s._app)===null||t===void 0?void 0:t.options.appId)||"",s._persistenceKey,n);s._componentsProvider||!((e=n.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((i=n.localCache)===null||i===void 0)&&i._onlineComponentProvider)&&(s._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),s._firestoreClient=new _v(s._authCredentials,s._appCheckCredentials,s._queue,r,s._componentsProvider&&function(a){const l=a==null?void 0:a._online.build();return{_offline:a==null?void 0:a._offline.build(l),_online:l}}(s._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Mt{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Mt(ft.fromBase64String(t))}catch(e){throw new ue(G.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new Mt(ft.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}toJSON(){return{type:Mt._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(t){if(zn(t,Mt._jsonSchema))return Mt.fromBase64String(t.bytes)}}Mt._jsonSchemaVersion="firestore/bytes/1.0",Mt._jsonSchema={type:$e("string",Mt._jsonSchemaVersion),bytes:$e("string")};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class is{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new ue(G.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new dt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fo{constructor(t){this._methodName=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ht{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new ue(G.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new ue(G.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}_compareTo(t){return be(this._lat,t._lat)||be(this._long,t._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:Ht._jsonSchemaVersion}}static fromJSON(t){if(zn(t,Ht._jsonSchema))return new Ht(t.latitude,t.longitude)}}Ht._jsonSchemaVersion="firestore/geoPoint/1.0",Ht._jsonSchema={type:$e("string",Ht._jsonSchemaVersion),latitude:$e("number"),longitude:$e("number")};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ut{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(i,n){if(i.length!==n.length)return!1;for(let r=0;r<i.length;++r)if(i[r]!==n[r])return!1;return!0}(this._values,t._values)}toJSON(){return{type:Ut._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(t){if(zn(t,Ut._jsonSchema)){if(Array.isArray(t.vectorValues)&&t.vectorValues.every(e=>typeof e=="number"))return new Ut(t.vectorValues);throw new ue(G.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}Ut._jsonSchemaVersion="firestore/vectorValue/1.0",Ut._jsonSchema={type:$e("string",Ut._jsonSchemaVersion),vectorValues:$e("object")};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pv=/^__.*__$/;class Cv{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return this.fieldMask!==null?new wi(t,this.data,this.fieldMask,e,this.fieldTransforms):new Hn(t,this.data,e,this.fieldTransforms)}}class Uc{constructor(t,e,i){this.data=t,this.fieldMask=e,this.fieldTransforms=i}toMutation(t,e){return new wi(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function jc(s){switch(s){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw we(40011,{Ec:s})}}class Oo{constructor(t,e,i,n,r,o){this.settings=t,this.databaseId=e,this.serializer=i,this.ignoreUndefinedProperties=n,r===void 0&&this.Ac(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Ec(){return this.settings.Ec}Rc(t){return new Oo(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Vc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.fc(t),n}gc(t){var e;const i=(e=this.path)===null||e===void 0?void 0:e.child(t),n=this.Rc({path:i,mc:!1});return n.Ac(),n}yc(t){return this.Rc({path:void 0,mc:!0})}wc(t){return Hr(t,this.settings.methodName,this.settings.Sc||!1,this.path,this.settings.bc)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}Ac(){if(this.path)for(let t=0;t<this.path.length;t++)this.fc(this.path.get(t))}fc(t){if(t.length===0)throw this.wc("Document fields must not be empty");if(jc(this.Ec)&&Pv.test(t))throw this.wc('Document fields cannot begin and end with "__"')}}class Rv{constructor(t,e,i){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=i||Jr(t)}Dc(t,e,i,n=!1){return new Oo({Ec:t,methodName:e,bc:i,path:dt.emptyPath(),mc:!1,Sc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Vo(s){const t=s._freezeSettings(),e=Jr(s._databaseId);return new Rv(s._databaseId,!!t.ignoreUndefinedProperties,e)}function Iv(s,t,e,i,n,r={}){const o=s.Dc(r.merge||r.mergeFields?2:0,t,e,n);Lo("Data must be an object, but it was:",o,i);const a=Wc(i,o);let l,u;if(r.merge)l=new At(o.fieldMask),u=o.fieldTransforms;else if(r.mergeFields){const h=[];for(const d of r.mergeFields){const f=eo(t,d,e);if(!o.contains(f))throw new ue(G.INVALID_ARGUMENT,`Field '${f}' is specified in your field mask but missing from your input data.`);qc(h,f)||h.push(f)}l=new At(h),u=o.fieldTransforms.filter(d=>l.covers(d.field))}else l=null,u=o.fieldTransforms;return new Cv(new Pt(a),l,u)}class ns extends Fo{_toFieldTransform(t){if(t.Ec!==2)throw t.Ec===1?t.wc(`${this._methodName}() can only appear at the top level of your update data`):t.wc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof ns}}function Av(s,t,e,i){const n=s.Dc(1,t,e);Lo("Data must be an object, but it was:",n,i);const r=[],o=Pt.empty();yi(i,(l,u)=>{const h=No(t,l,e);u=Wt(u);const d=n.gc(h);if(u instanceof ns)r.push(h);else{const f=Gn(u,d);f!=null&&(r.push(h),o.set(h,f))}});const a=new At(r);return new Uc(o,a,n.fieldTransforms)}function Dv(s,t,e,i,n,r){const o=s.Dc(1,t,e),a=[eo(t,i,e)],l=[n];if(r.length%2!=0)throw new ue(G.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<r.length;f+=2)a.push(eo(t,r[f])),l.push(r[f+1]);const u=[],h=Pt.empty();for(let f=a.length-1;f>=0;--f)if(!qc(u,a[f])){const m=a[f];let v=l[f];v=Wt(v);const _=o.gc(m);if(v instanceof ns)u.push(m);else{const E=Gn(v,_);E!=null&&(u.push(m),h.set(m,E))}}const d=new At(u);return new Uc(h,d,o.fieldTransforms)}function Mv(s,t,e,i=!1){return Gn(e,s.Dc(i?4:3,t))}function Gn(s,t){if(Gc(s=Wt(s)))return Lo("Unsupported field value:",t,s),Wc(s,t);if(s instanceof Fo)return function(i,n){if(!jc(n.Ec))throw n.wc(`${i._methodName}() can only be used with update() and set()`);if(!n.path)throw n.wc(`${i._methodName}() is not currently supported inside arrays`);const r=i._toFieldTransform(n);r&&n.fieldTransforms.push(r)}(s,t),null;if(s===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),s instanceof Array){if(t.settings.mc&&t.Ec!==4)throw t.wc("Nested arrays are not supported");return function(i,n){const r=[];let o=0;for(const a of i){let l=Gn(a,n.yc(o));l==null&&(l={nullValue:"NULL_VALUE"}),r.push(l),o++}return{arrayValue:{values:r}}}(s,t)}return function(i,n){if((i=Wt(i))===null)return{nullValue:"NULL_VALUE"};if(typeof i=="number")return vg(n.serializer,i);if(typeof i=="boolean")return{booleanValue:i};if(typeof i=="string")return{stringValue:i};if(i instanceof Date){const r=Ue.fromDate(i);return{timestampValue:Lr(n.serializer,r)}}if(i instanceof Ue){const r=new Ue(i.seconds,1e3*Math.floor(i.nanoseconds/1e3));return{timestampValue:Lr(n.serializer,r)}}if(i instanceof Ht)return{geoPointValue:{latitude:i.latitude,longitude:i.longitude}};if(i instanceof Mt)return{bytesValue:hc(n.serializer,i._byteString)};if(i instanceof et){const r=n.databaseId,o=i.firestore._databaseId;if(!o.isEqual(r))throw n.wc(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:_o(i.firestore._databaseId||n.databaseId,i._key.path)}}if(i instanceof Ut)return function(o,a){return{mapValue:{fields:{[zu]:{stringValue:Hu},[kr]:{arrayValue:{values:o.toArray().map(u=>{if(typeof u!="number")throw a.wc("VectorValues must only contain numeric values.");return mo(a.serializer,u)})}}}}}}(i,n);throw n.wc(`Unsupported field value: ${jr(i)}`)}(s,t)}function Wc(s,t){const e={};return Fu(s)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):yi(s,(i,n)=>{const r=Gn(n,t.Vc(i));r!=null&&(e[i]=r)}),{mapValue:{fields:e}}}function Gc(s){return!(typeof s!="object"||s===null||s instanceof Array||s instanceof Date||s instanceof Ue||s instanceof Ht||s instanceof Mt||s instanceof et||s instanceof Fo||s instanceof Ut)}function Lo(s,t,e){if(!Gc(e)||!Mu(e)){const i=jr(e);throw i==="an object"?t.wc(s+" a custom object"):t.wc(s+" "+i)}}function eo(s,t,e){if((t=Wt(t))instanceof is)return t._internalPath;if(typeof t=="string")return No(s,t);throw Hr("Field path arguments must be of type string or ",s,!1,void 0,e)}const kv=new RegExp("[~\\*/\\[\\]]");function No(s,t,e){if(t.search(kv)>=0)throw Hr(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,s,!1,void 0,e);try{return new is(...t.split("."))._internalPath}catch{throw Hr(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,s,!1,void 0,e)}}function Hr(s,t,e,i,n){const r=i&&!i.isEmpty(),o=n!==void 0;let a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let l="";return(r||o)&&(l+=" (found",r&&(l+=` in field ${i}`),o&&(l+=` in document ${n}`),l+=")"),new ue(G.INVALID_ARGUMENT,a+s+l)}function qc(s,t){return s.some(e=>e.isEqual(t))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zc{constructor(t,e,i,n,r){this._firestore=t,this._userDataWriter=e,this._key=i,this._document=n,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new et(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const t=new Fv(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(rs("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}}class Fv extends Zc{data(){return super.data()}}function rs(s,t){return typeof t=="string"?No(s,t):t instanceof is?t._internalPath:t._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ov(s){if(s.limitType==="L"&&s.explicitOrderBy.length===0)throw new ue(G.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Bo{}class Xc extends Bo{}function Vv(s,t,...e){let i=[];t instanceof Bo&&i.push(t),i=i.concat(e),function(r){const o=r.filter(l=>l instanceof zo).length,a=r.filter(l=>l instanceof ss).length;if(o>1||o>0&&a>0)throw new ue(G.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(i);for(const n of i)s=n._apply(s);return s}class ss extends Xc{constructor(t,e,i){super(),this._field=t,this._op=e,this._value=i,this.type="where"}static _create(t,e,i){return new ss(t,e,i)}_apply(t){const e=this._parse(t);return Kc(t._query,e),new Mi(t.firestore,t.converter,Us(t._query,e))}_parse(t){const e=Vo(t.firestore);return function(r,o,a,l,u,h,d){let f;if(u.isKeyField()){if(h==="array-contains"||h==="array-contains-any")throw new ue(G.INVALID_ARGUMENT,`Invalid Query. You can't perform '${h}' queries on documentId().`);if(h==="in"||h==="not-in"){$l(d,h);const v=[];for(const _ of d)v.push(Jl(l,r,_));f={arrayValue:{values:v}}}else f=Jl(l,r,d)}else h!=="in"&&h!=="not-in"&&h!=="array-contains-any"||$l(d,h),f=Mv(a,o,d,h==="in"||h==="not-in");return Je.create(u,h,f)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}}function Lv(s,t,e){const i=t,n=rs("where",s);return ss._create(n,i,e)}class zo extends Bo{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new zo(t,e)}_parse(t){const e=this._queryConstraints.map(i=>i._parse(t)).filter(i=>i.getFilters().length>0);return e.length===1?e[0]:Lt.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return e.getFilters().length===0?t:(function(n,r){let o=n;const a=r.getFlattenedFilters();for(const l of a)Kc(o,l),o=Us(o,l)}(t._query,e),new Mi(t.firestore,t.converter,Us(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}}class Ho extends Xc{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new Ho(t,e)}_apply(t){const e=function(n,r,o){if(n.startAt!==null)throw new ue(G.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(n.endAt!==null)throw new ue(G.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new On(r,o)}(t._query,this._field,this._direction);return new Mi(t.firestore,t.converter,function(n,r){const o=n.explicitOrderBy.concat([r]);return new rn(n.path,n.collectionGroup,o,n.filters.slice(),n.limit,n.limitType,n.startAt,n.endAt)}(t._query,e))}}function Nv(s,t="asc"){const e=t,i=rs("orderBy",s);return Ho._create(i,e)}function Jl(s,t,e){if(typeof(e=Wt(e))=="string"){if(e==="")throw new ue(G.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ku(t)&&e.indexOf("/")!==-1)throw new ue(G.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);const i=t.path.child(Be.fromString(e));if(!ve.isDocumentKey(i))throw new ue(G.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return dl(s,new ve(i))}if(e instanceof et)return dl(s,e._key);throw new ue(G.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${jr(e)}.`)}function $l(s,t){if(!Array.isArray(s)||s.length===0)throw new ue(G.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Kc(s,t){const e=function(n,r){for(const o of n)for(const a of o.getFlattenedFilters())if(r.indexOf(a.op)>=0)return a.op;return null}(s.filters,function(n){switch(n){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new ue(G.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new ue(G.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}class Bv{convertValue(t,e="none"){switch(pi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Xe(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(fi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw we(62114,{value:t})}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const i={};return yi(t,(n,r)=>{i[n]=this.convertValue(r,e)}),i}convertVectorValue(t){var e,i,n;const r=(n=(i=(e=t.fields)===null||e===void 0?void 0:e[kr].arrayValue)===null||i===void 0?void 0:i.values)===null||n===void 0?void 0:n.map(o=>Xe(o.doubleValue));return new Ut(r)}convertGeoPoint(t){return new Ht(Xe(t.latitude),Xe(t.longitude))}convertArray(t,e){return(t.values||[]).map(i=>this.convertValue(i,e))}convertServerTimestamp(t,e){switch(e){case"previous":const i=qr(t);return i==null?null:this.convertValue(i,e);case"estimate":return this.convertTimestamp(Mn(t));default:return null}}convertTimestamp(t){const e=di(t);return new Ue(e.seconds,e.nanos)}convertDocumentKey(t,e){const i=Be.fromString(t);Fe(vc(i),9688,{name:t});const n=new kn(i.get(1),i.get(3)),r=new ve(i.popFirst(5));return n.isEqual(e)||Jt(`Document ${r} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zv(s,t,e){let i;return i=s?s.toFirestore(t):t,i}class _n{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Ci extends Zc{constructor(t,e,i,n,r,o){super(t,e,i,n,o),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Tr(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const i=this._document.data.field(rs("DocumentSnapshot.get",t));if(i!==null)return this._userDataWriter.convertValue(i,e.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new ue(G.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t=this._document,e={};return e.type=Ci._jsonSchemaVersion,e.bundle="",e.bundleSource="DocumentSnapshot",e.bundleName=this._key.toString(),!t||!t.isValidDocument()||!t.isFoundDocument()?e:(this._userDataWriter.convertObjectMap(t.data.value.mapValue.fields,"previous"),e.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED"),e)}}Ci._jsonSchemaVersion="firestore/documentSnapshot/1.0",Ci._jsonSchema={type:$e("string",Ci._jsonSchemaVersion),bundleSource:$e("string","DocumentSnapshot"),bundleName:$e("string"),bundle:$e("string")};class Tr extends Ci{data(t={}){return super.data(t)}}class Gi{constructor(t,e,i,n){this._firestore=t,this._userDataWriter=e,this._snapshot=n,this.metadata=new _n(n.hasPendingWrites,n.fromCache),this.query=i}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(i=>{t.call(e,new Tr(this._firestore,this._userDataWriter,i.key,i,new _n(this._snapshot.mutatedKeys.has(i.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new ue(G.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(n,r){if(n._snapshot.oldDocs.isEmpty()){let o=0;return n._snapshot.docChanges.map(a=>{const l=new Tr(n._firestore,n._userDataWriter,a.doc.key,a.doc,new _n(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);return a.doc,{type:"added",doc:l,oldIndex:-1,newIndex:o++}})}{let o=n._snapshot.oldDocs;return n._snapshot.docChanges.filter(a=>r||a.type!==3).map(a=>{const l=new Tr(n._firestore,n._userDataWriter,a.doc.key,a.doc,new _n(n._snapshot.mutatedKeys.has(a.doc.key),n._snapshot.fromCache),n.query.converter);let u=-1,h=-1;return a.type!==0&&(u=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),h=o.indexOf(a.doc.key)),{type:Hv(a.type),doc:l,oldIndex:u,newIndex:h}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new ue(G.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");const t={};t.type=Gi._jsonSchemaVersion,t.bundleSource="QuerySnapshot",t.bundleName=lo.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;const e=[],i=[],n=[];return this.docs.forEach(r=>{r._document!==null&&(e.push(r._document),i.push(this._userDataWriter.convertObjectMap(r._document.data.value.mapValue.fields,"previous")),n.push(r.ref.path))}),t.bundle=(this._firestore,this.query._query,t.bundleName,"NOT SUPPORTED"),t}}function Hv(s){switch(s){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return we(61501,{type:s})}}Gi._jsonSchemaVersion="firestore/querySnapshot/1.0",Gi._jsonSchema={type:$e("string",Gi._jsonSchemaVersion),bundleSource:$e("string","QuerySnapshot"),bundleName:$e("string"),bundle:$e("string")};class Yc extends Bv{constructor(t){super(),this.firestore=t}convertBytes(t){return new Mt(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new et(this.firestore,null,e)}}function Uv(s,t,e,...i){s=li(s,et);const n=li(s.firestore,Qi),r=Vo(n);let o;return o=typeof(t=Wt(t))=="string"||t instanceof is?Dv(r,"updateDoc",s._key,t,e,i):Av(r,"updateDoc",s._key,t),Uo(n,[o.toMutation(s._key,Vt.exists(!0))])}function jv(s){return Uo(li(s.firestore,Qi),[new vo(s._key,Vt.none())])}function Wv(s,t){const e=li(s.firestore,Qi),i=$s(s),n=zv(s.converter,t);return Uo(e,[Iv(Vo(s.firestore),"addDoc",i._key,n,s.converter!==null,{}).toMutation(i._key,Vt.exists(!1))]).then(()=>i)}function Gv(s,...t){var e,i,n;s=Wt(s);let r={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||Ql(t[o])||(r=t[o++]);const a={includeMetadataChanges:r.includeMetadataChanges,source:r.source};if(Ql(t[o])){const d=t[o];t[o]=(e=d.next)===null||e===void 0?void 0:e.bind(d),t[o+1]=(i=d.error)===null||i===void 0?void 0:i.bind(d),t[o+2]=(n=d.complete)===null||n===void 0?void 0:n.bind(d)}let l,u,h;if(s instanceof et)u=li(s.firestore,Qi),h=go(s._key.path),l={next:d=>{t[o]&&t[o](qv(u,s,d))},error:t[o+1],complete:t[o+2]};else{const d=li(s,Mi);u=li(d.firestore,Qi),h=d._query;const f=new Yc(u);l={next:m=>{t[o]&&t[o](new Gi(u,f,d,m))},error:t[o+1],complete:t[o+2]},Ov(s._query)}return function(f,m,v,_){const E=new wv(_),b=new ev(m,E,v);return f.asyncQueue.enqueueAndForget(async()=>Ym(await jl(f),b)),()=>{E.Ou(),f.asyncQueue.enqueueAndForget(async()=>Qm(await jl(f),b))}}(Hc(u),h,a,l)}function Uo(s,t){return function(i,n){const r=new Pi;return i.asyncQueue.enqueueAndForget(async()=>cv(await Ev(i),n,r)),r.promise}(Hc(s),t)}function qv(s,t,e){const i=e.docs.get(t._key),n=new Yc(s);return new Ci(s,n,t._key,i,new _n(e.hasPendingWrites,e.fromCache),t.converter)}(function(t,e=!0){(function(n){en=n})(mp),Ar(new In("firestore",(i,{instanceIdentifier:n,options:r})=>{const o=i.getProvider("app").getImmediate(),a=new Qi(new Ap(i.getProvider("auth-internal")),new kp(o,i.getProvider("app-check-internal")),function(u,h){if(!Object.prototype.hasOwnProperty.apply(u.options,["projectId"]))throw new ue(G.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new kn(u.options.projectId,h)}(o,n),o);return r=Object.assign({useFetchStreams:e},r),a._setSettings(r),a},"PUBLIC").setMultipleInstances(!0)),ji(Ja,$a,t),ji(Ja,$a,"esm2017")})();var Zv="firebase",Xv="11.10.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ji(Zv,Xv,"app");const Kv={apiKey:"AIzaSyBZBzj1i49dITFoNCZVNhdGzg0_Hgy7B84",authDomain:"diary-deji.firebaseapp.com",projectId:"diary-deji",storageBucket:"diary-deji.firebasestorage.app",messagingSenderId:"192929296187",appId:"1:192929296187:web:3af2132df4a755936b911e"},Yv=wu(Kv),pr=bv(Yv);var Qv=B('<button style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:11px;padding:4px 0;width:100%;text-align:center;">'),Jv=B("<div style=margin-bottom:12px;>"),$v=B('<button style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;">💬 Add feedback'),ey=B("<div style=margin-top:16px;>"),ty=B('<div><textarea style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"></textarea><div style=margin-top:6px;><button style="background:#0088cc;color:white;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px;">Save</button><button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">Cancel'),iy=B('<div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.1);">'),ny=B('<p style="margin:0 0 6px 0;color:rgba(255,255,255,0.9);font-size:13px;">'),ry=B("<div style=display:flex;justify-content:space-between;align-items:center;><span style=color:rgba(255,255,255,0.5);font-size:11px;> • </span><div><button style=background:none;border:none;color:#0088cc;cursor:pointer;font-size:11px;margin-right:8px;>Edit</button><button style=background:none;border:none;color:#ff4444;cursor:pointer;font-size:11px;>Delete"),sy=B("<div style=background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-bottom:8px;><div style=display:flex;gap:6px;><button>Leonard</button><button>Deji"),oy=B('<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:12px;"><div style=margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;><span style=color:rgba(255,255,255,0.7);font-size:11px;>Posting as: <strong></strong></span><button style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;">Change</button></div><form><textarea placeholder="Add your feedback here..."style="width:100%;padding:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;border-radius:4px;font-size:13px;resize:vertical;min-height:50px;"autofocus></textarea><div style=display:flex;gap:6px;margin-top:6px;><button type=submit></button><button type=button style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel');function eu({updateId:s,updateTitle:t}){const[e,i]=oe([]),[n,r]=oe(""),[o,a]=oe(null),[l,u]=oe(""),[h,d]=oe(!1),[f,m]=oe(localStorage.getItem("feedbackAuthor")||"Deji"),[v,_]=oe(!1),[E,b]=oe(!1),[k,V]=oe(!1);Ui(()=>{const x=Vv(Zl(pr,"feedbacks"),Lv("updateId","==",s),Nv("timestamp","desc")),I=Gv(x,M=>{const F=[];M.forEach(O=>{F.push({id:O.id,...O.data()})}),i(F)});return()=>I()});const W=async x=>{if(x.preventDefault(),!!n().trim()){d(!0);try{await Wv(Zl(pr,"feedbacks"),{updateId:s,updateTitle:t,text:n(),author:f(),timestamp:new Date,edited:!1}),r(""),V(!1)}catch(I){console.error("Error adding feedback:",I)}d(!1)}},z=async x=>{if(l().trim())try{await Uv($s(pr,"feedbacks",x),{text:l(),edited:!0,editedAt:new Date}),a(null),u("")}catch(I){console.error("Error editing feedback:",I)}},j=async x=>{if(confirm("Delete this feedback?"))try{await jv($s(pr,"feedbacks",x))}catch(I){console.error("Error deleting feedback:",I)}},D=x=>{if(!x)return"";const I=x.toDate?x.toDate():new Date(x),F=new Date-I,O=Math.floor(F/(1e3*60*60));return O<1?"Just now":O<24?`${O} hour${O>1?"s":""} ago`:O<48?"Yesterday":I.toLocaleDateString()};return(()=>{var x=ey();return ie(x,ge(ke,{get when(){return e().length>0},get children(){var I=Jv();return ie(I,ge(Is,{get each(){return Rt(()=>!!E())()?e():e().slice(0,2)},children:M=>(()=>{var F=iy();return ie(F,ge(ke,{get when(){return o()===M.id},get fallback(){return[(()=>{var O=ny();return ie(O,()=>M.text),O})(),(()=>{var O=ry(),R=O.firstChild,ne=R.firstChild,ee=R.nextSibling,ae=ee.firstChild,q=ae.nextSibling;return ie(R,()=>M.author,ne),ie(R,()=>D(M.timestamp),null),ie(R,()=>M.edited&&" (edited)",null),ae.$$click=()=>{a(M.id),u(M.text)},q.$$click=()=>j(M.id),O})()]},get children(){var O=ty(),R=O.firstChild,ne=R.nextSibling,ee=ne.firstChild,ae=ee.nextSibling;return R.$$input=q=>u(q.target.value),ee.$$click=()=>z(M.id),ae.$$click=()=>{a(null),u("")},Ve(()=>R.value=l()),O}})),F})()}),null),ie(I,ge(ke,{get when(){return e().length>2},get children(){var M=Qv();return M.$$click=()=>b(!E()),ie(M,(()=>{var F=Rt(()=>!!E());return()=>F()?`− Hide ${e().length-2} older feedback${e().length-2>1?"s":""}`:`+ Show ${e().length-2} more feedback${e().length-2>1?"s":""}`})()),M}}),null),I}}),null),ie(x,ge(ke,{get when(){return!k()},get fallback(){return(()=>{var I=oy(),M=I.firstChild,F=M.firstChild,O=F.firstChild,R=O.nextSibling,ne=F.nextSibling,ee=M.nextSibling,ae=ee.firstChild,q=ae.nextSibling,Q=q.firstChild,J=Q.nextSibling;return ie(R,f),ne.$$click=()=>_(!v()),ie(I,ge(ke,{get when(){return v()},get children(){var se=sy(),xe=se.firstChild,pe=xe.firstChild,X=pe.nextSibling;return pe.$$click=()=>{m("Leonard"),localStorage.setItem("feedbackAuthor","Leonard"),_(!1)},X.$$click=()=>{m("Deji"),localStorage.setItem("feedbackAuthor","Deji"),_(!1)},Ve(Se=>{var Re=`background: ${f()==="Leonard"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`,tt=`background: ${f()==="Deji"?"#0088cc":"rgba(255,255,255,0.1)"}; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 11px;`;return Se.e=Tn(pe,Re,Se.e),Se.t=Tn(X,tt,Se.t),Se},{e:void 0,t:void 0}),se}}),ee),ee.addEventListener("submit",W),ae.$$input=se=>r(se.target.value),ie(Q,()=>h()?"Posting...":"Post"),J.$$click=()=>{V(!1),r("")},Ve(se=>{var xe=h(),pe=h()||!n().trim(),X=`background: ${h()||!n().trim()?"rgba(0,136,204,0.5)":"#0088cc"}; color: white; border: none; padding: 6px 16px; border-radius: 4px; cursor: ${h()||!n().trim()?"not-allowed":"pointer"}; font-size: 12px;`;return xe!==se.e&&(ae.disabled=se.e=xe),pe!==se.t&&(Q.disabled=se.t=pe),se.a=Tn(Q,X,se.a),se},{e:void 0,t:void 0,a:void 0}),Ve(()=>ae.value=n()),I})()},get children(){var I=$v();return I.$$click=()=>V(!0),I}}),null),x})()}Ji(["click","input"]);var ay=B('<p>Removed the complex "Zoom Performance" section from the debug menu to simplify the interface.'),Cs=B("<h4>What changed"),ly=B("<p>The debug menu now focuses on essential controls for visual customization, interaction behavior, and hotspot discovery. Advanced zoom tuning parameters have been removed as they were rarely used and added unnecessary complexity."),uy=B("<p><em>The artwork already performs at 60 FPS with the default settings, making manual tuning unnecessary for most users."),cy=B("<p>Fixed the issue where Playwright manual tests weren't opening a visible browser window. The tests were running in headless mode by default."),hy=B("<p>Added the <code>--headed</code> option to all manual test scripts. Now when you run tests for Safari or mobile debugging, an actual browser window will open for visual inspection."),dy=B("<h4>Available test commands"),fy=B("<p><strong>Safari Desktop Manual Test:</strong><br><code>npm run test:safari-desktop</code><br>Opens webkit browser for desktop Safari testing with debug overlays."),py=B("<p><strong>iOS Safari Manual Test:</strong><br><code>npm run test:ios-safari</code><br>Opens webkit browser for mobile Safari testing."),gy=B("<p><strong>Direct command with options:</strong><br><code>npx playwright test tests/safari-desktop-manual-test.spec.js --project=webkit --headed"),my=B("<p><em>The test window stays open for 10 minutes to allow thorough manual testing. Press Ctrl+C to stop the test when done."),vy=B("<p>Fixed a visual issue where the artwork was displaying grainy artifacts. The monochrome drawings now render cleanly at all zoom levels."),yy=B("<p>The image had a noisy, pixelated appearance that was distracting. Adjusted the rendering settings to better handle black and white artwork - the difference is quite striking."),wy=B("<p>Fixed several mobile-specific issues that were affecting the zoom experience and made the debug controls more reliable across all devices."),_y=B("<h4>Mobile zoom improvements"),Ty=B("<p><strong>Smoother zooming</strong><br>The cinematic zoom when tapping hotspots now performs better on phones and tablets. Reduced stuttering during the animation and improved frame rates on lower-end devices."),Ey=B("<p><strong>Touch responsiveness</strong><br>Fixed an issue where hotspots would sometimes become unresponsive after zooming. Touch interactions now reset properly after each zoom animation completes."),xy=B("<h4>Debug panel refinements"),by=B("<p>Made the mobile debug controls more stable - the slide-up panel now opens and closes more reliably, and the FPS counter updates consistently. Also improved the visual spacing on smaller screens."),Sy=B("<p><em>Small but important fixes that should make the mobile experience feel more polished and responsive."),Py=B("<p>The debug controls (press 'C' to open) now work on phones and tablets."),Cy=B("<h4>What's new"),Ry=B("<p><strong>Mobile devices</strong><br>A compact bar at the bottom shows FPS and a settings icon. Tap it to reveal controls that slide up. Swipe down or tap outside to dismiss."),Iy=B("<p><strong>Desktop</strong><br>The panel can now be minimized to a small floating button instead of closing completely."),Ay=B("<p><em>Small quality-of-life improvement, but it makes testing on different devices much more pleasant!"),Dy=B("<p>The experimental touch-hold system I mentioned yesterday is now more reliable. After testing, I found and fixed an issue where hotspots would sometimes stop responding after being activated once."),My=B("<h4>What's improved"),ky=B(`<p>If you enable "Temporal" mode in the debug menu (press 'C'), the hold-to-interact system now works consistently. Hotspots stay visible while you hold them, and each interaction resets cleanly for the next one.`),Fy=B("<h4>Also tweaked"),Oy=B("<p>Added white color options to the border palette since you're working with black ink artwork. More importantly, <strong>temporal mode is now the default on mobile devices</strong> - meaning visitors will use the hold-to-interact system instead of direct taps. You can always switch back to standard tap-to-zoom in the debug menu if needed."),Vy=B("<p>With ~600 interactive zones hidden throughout your artwork, I've added a way to briefly reveal what's clickable without disrupting the visual experience."),Ly=B("<h4>How it works"),Ny=B("<p>Press 'H' (desktop) or triple-tap anywhere (mobile) to make all nearby hotspots gently pulse for 6 seconds. The effect uses contrast inversion to ensure visibility on your black ink artwork while staying subtle enough not to break immersion."),By=B("<h4>Also included: Alternative touch controls"),zy=B(`<p>For mobile users, I've prepared an experimental hold-to-interact system that's currently tucked away in the debug menu. If you're curious, press 'C' to open debug options and switch from "Direct" to "Temporal" interaction. This changes how taps work - but the standard tap-to-zoom remains the default for now.`),Hy=B("<p>The reveal helper should make exploration feel less like guesswork and more like discovery. Let me know if the visibility needs adjusting - it's easy to make it bolder or more subtle based on your preference."),Uy=B("<p><strong>Safari animations:</strong> Now working! Chrome/Firefox/Edge still have the edge visually, but Safari's functional. Requires Safari 13.1+ (2020 or newer)."),jy=B("<p><strong>Smart zoom behavior:</strong> Following Google Arts & Culture's approach, animations now adapt to zoom level. Below 8x zoom = full animations. Above 8x = quick 150ms transitions only. When you're examining details up close, decorative animations would just distract."),Wy=B("<p><strong>Next:</strong> Making the cinematic zoom buttery smooth when clicking hotspots. Also thinking the stroke animation makes sense for desktop, but mobile needs something snappier."),Gy=B("<p><em>Personal note: Getting really excited - it's starting to take shape! :D"),qy=B("<p><strong>Current status:</strong> While the hover animations now work on Safari, the visual effect isn't as pronounced as on Chrome/Firefox. I'm quite proud of the result on chrome at the moment. I think it's quite satisfying."),Zy=B("<p><strong>Recommendation:</strong> Use Chrome for now to see the intended visual impact. The difference is noticeable - Chrome displays richer glows and better depth."),Xy=B("<p><strong>What's next:</strong> Working on Safari-specific optimizations to improve the visual quality without compromising performance."),Ky=B("<p><strong>Following up on January 7th:</strong> The Safari issue is fixed! The stroke reveal animation now works properly on Safari desktop where you can actually hover."),Yy=B("<p><strong>Next up</strong>: Making the animation more visible and impactful for desktop users, plus exploring touch-friendly animations for mobile devices."),Qy=B("<p><strong>Responding to your feedback:</strong> You mentioned the hover effect felt static with just the white border appearing. I've implemented a first animation to bring more life to the interactions."),Jy=B(`<p><strong>What's new:</strong> A stroke reveal animation that progressively traces the hotspot outline when you hover. Instead of the border just "popping" into view, it now draws itself smoothly around the shape - like watching someone trace the contour with a pen.`),$y=B("<p><strong>Current settings:</strong><br>• White stroke with subtle shadow for visibility<br>• 1.2 second drawing animation<br>• Works on Chrome, Firefox, and Edge"),ew=B("<p><strong>Needs refinement:</strong> The animation is quite subtle right now - you might have to look closely to see the progressive drawing effect. I'll be adjusting the timing and visibility to make it more noticeable and satisfying."),tw=B("<p><strong>Safari issue discovered:</strong> Just noticed the animation isn't working properly on Safari (There's always something with Safari 🙃). Will fix this tomorrow along with the other refinements."),iw=B("<p><strong>Note:</strong> This is one hover effect I wanted to try first. I'm planning to experiment with additional animations to find what feels best for your artwork. Let me know your thoughts!"),nw=B("<p><strong>What's improved:</strong> The circular spotlight effect in Apple Mode (Safari/iOS) now adapts much better to different hotspot shapes."),rw=B("<p><strong>What changed:</strong><br>• Spotlights are now tighter and more focused around each hotspot (both mobile and desktop)<br>• Better detection of when to use circles vs ellipses based on hotspot shape"),sw=B("<p><strong>The result:</strong> Whether a hotspot is round, tall, wide, or irregular, the spotlight should now feel more natural and better frame the content the user is exploring."),ow=B("<p>Try clicking on different shaped hotspots - the spotlight should feel more consistent and purposeful now!"),aw=B("<p><strong>The issue:</strong> Some complex hotspots still extend outside the spotlight area after yesterday's improvements."),lw=B("<p><strong>Today's attempt:</strong> Since a single circular spotlight can't perfectly cover irregular shapes, I tried combining multiple circles at different positions to fill in the gaps. Unfortunately, Safari doesn't support this technique - it only displays one spotlight instead of blending them together like other browsers do."),uw=B("<p><strong>Next:</strong> Fine-tuning the spotlight sizing parameters to better fit each hotspot's unique shape."),cw=B("<p><strong>What's improved:</strong> The spotlight effect on Safari and iOS devices now much better matches the actual hotspot shapes, especially on desktop Safari!"),hw=B("<p><strong>Key changes:</strong><br>• Spotlights now use elliptical shapes for elongated hotspots<br>• Tighter, more precise spotlight coverage that follows the hotspot boundaries closely<br>• Better visual consistency between the outline of the hotspot and the darkened area<br>• Desktop Safari shows the most dramatic improvements, mobile iOS continues to be refined"),dw=B("<p><strong>Still fine-tuning:</strong> Some complex hotspots have small areas that peek slightly outside the spotlight. Mobile Safari needs additional optimization for the same precision as desktop."),fw=B("<p><strong>What's new:</strong> You can now leave feedback directly on each update! No need to switch to Telegram for quick comments."),pw=B('<p><strong>How it works:</strong><br>• Type your feedback in the text box below any update<br>• Click "Post Feedback" to send<br>• Edit or delete your comments anytime<br>• Everything syncs in real-time between us'),gw=B('<p><strong>Quick tip:</strong> The system remembers who you are. If it shows the wrong name, just click "Change" above the feedback box to switch between Deji and Leonard.'),mw=B("<p>Feel free to test it out below! This makes it much easier to discuss specific features without jumping between apps."),vw=B("<p><strong>The Problem:</strong> In Apple Mode, the circular gradient spotlight doesn't show the exact boundaries of the clickable area. Users might not know where the hotspot actually ends."),yw=B("<p><strong>Context:</strong> Since Apple/Safari doesn't support the precise polygon cutouts we have in Standard Mode (that's their technical limitation), we need to work within these constraints."),ww=B("<p><strong>Today's Experiment:</strong> Added a subtle outline that follows the exact hotspot shape. The gradient spotlight stays circular, but now the actual boundaries are visible."),_w=B("<p><strong>Note:</strong> This is very much a work in progress. The current implementation might be too distracting, not visible enough, or just not the right approach entirely."),Tw=B("<p><strong>Try it yourself:</strong> In debug mode (press 'C'), there's now a button to cycle through different border styles - from subtle to bold. Your feedback will help determine if we should refine this solution or try something completely different."),Ew=B("<p><strong>Following up on July 1st:</strong> The Safari compatibility issue has been resolved with a custom implementation."),xw=B("<p><strong>The Solution:</strong> Created a Safari-specific spotlight system that works within WebKit's limitations:<br>• Uses radial gradient masks instead of polygon cutouts<br>• Provides a circular/elliptical spotlight effect around hotspots<br>• Maintains smooth 60 FPS performance on all iOS devices"),bw=B("<p><strong>What's Different:</strong><br>• <strong>Chrome/Firefox:</strong> Precise polygon cutout matching exact hotspot shape<br>• <strong>Safari/iOS:</strong> Smooth gradient spotlight that adapts to hotspot size"),Sw=B("<p><strong>Added Intelligence:</strong> While implementing the Safari solution, the system now analyzes each hotspot's complexity to determine optimal spotlight sizing. Complex shapes get more breathing room, simple shapes stay tight and focused."),Pw=B("<p><strong>Current Status:</strong> The spotlight effect now works on ALL devices and browsers, with each platform getting an optimized implementation."),Cw=B("<p><strong>Good news:</strong> The spotlight effect works great on the vast majority of devices and browsers. It works on Mac computers except when using Safari."),Rw=B("<p><strong>The only exception:</strong> Apple devices with Safari/WebKit. This includes:<br>• iPhone (Safari & Chrome)<br>• iPad (Safari & Chrome)<br>• Mac (Safari only - Chrome works fine!)"),Iw=B("<p><strong>Why it can't work on these devices:</strong> Safari has a long-standing bug with creating transparent cutouts in overlays. On iOS, Apple forces all browsers (including Chrome) to use Safari's engine internally, so they inherit the same limitation."),Aw=B("<p><strong>What happens instead:</strong> The darkening works, but the hotspot shape doesn't get cut out - so everything stays dark instead of creating a spotlight effect."),Dw=B("<p><strong>To see the full effect:</strong> Use any non-Apple device, or use Chrome/Firefox on your Mac. The effect is smooth, precise, and quite satisfying to interact with!"),Mw=B("<p><strong>Next steps:</strong> Creating a fallback specifically for Safari/iOS that will still provide visual focus, just using a different method."),kw=B("<p><strong>New Feature - Zoom Speed Slider:</strong> Added a debug panel slider (desktop only) so you can test different cinematic zoom speeds when clicking hotspots. Press 'C' to toggle the debug panel and adjust the speed from 0.5x to 2.5x. Once you find your preferred speed, let me know and I'll make it permanent."),Fw=B("<p><strong>Zoom Behavior:</strong> The current zoom animation is really basic right now and will be improved."),Ow=B(`<p><strong>Known Issues:</strong> There are some bugs with the zoom system - sometimes hotspots don't respond properly to clicks, and the zoom can behave unpredictably. These will be fixed along with the performance improvements. Oh and the "Full View" button does not appear on mobile right now 🤷 `),Vw=B("<p><strong>Performance Status:</strong> While the spotlight effect is now perfect at 60 FPS, I'm still working on zoom performance. Currently experiencing significant lag on mobile when zooming to distant hotspots, and occasional frame drops on desktop during the zoom animation. This is my top priority to fix."),Lw=B(`<p><strong>Flawless Synchronization:</strong> Fixed the "elastic lag" where spotlight would trail behind during zoom/pan (was using DOM positioning, now uses OpenSeadragon's native overlay system for perfect sync). Added intelligent progressive fade: as you pan/zoom away, the darkening smoothly fades before releasing focus. Creates a natural, cinematic experience that guides viewer attention. <em>(Fade transitions still being refined)`),Nw=B("<p><strong>Focus Mode (Darkening Overlay):</strong> Implemented the spotlight effect you requested! When clicking a hotspot, surrounding areas darken to help viewers focus. This first version is basic but functional - ready for your feedback and refinement."),Bw=B("<p>Hey Deji! 👋"),zw=B("<p>I've been visiting friends and family in my hometown for the past 3 days, so I haven't been able to work as intensively on the project during that time."),Hw=B("<p>I totally relate to your potato mode confession 😅 We all have those moments where we just need to disconnect and recharge. Though honestly, your project is so motivating that it's been the perfect antidote to my own potato tendencies - I find myself constantly drawn back to it."),Uw=B("<p>I'm back home today and excited to dedicate my full attention to the project again. Your feedback was incredibly valuable – I'll be implementing all the adjustments you mentioned progressively. Right now, I'm focusing hard on eliminating FPS drops on mobile as I now understand how critical the mobile experience is."),jw=B(`<p><strong>P.S.</strong> I've temporarily been locked out of Upwork (they flagged some "unusual activity" on my account). They said it should be resolved by Monday, but if you need to reach me before then, I'm available on Telegram: <a href=https://t.me/LeonardCote target=_blank>@LeonardCote`),Ww=B("<p>Looking forward to showing you the improvements!<br>- Leonard"),Gw=B('<div class=message-content><h3 style="margin-top:30px;margin-bottom:20px;font-size:18px;color:rgba(255, 255, 255, 0.95);">Previous Updates'),qw=B(`<div class=developer-message><div class=message-header><h3>Project Updates</h3><button class=close-btn>×</button></div><div class=update-section style="background:linear-gradient(135deg, #1a1f2e 0%, #1e2330 100%);border:1px solid rgba(0, 136, 204, 0.3);margin-bottom:20px;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.3);"><h4 style="color:#0088cc;margin:0 0 16px 0;font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px;"><span style=font-size:20px;>📱</span> Communication Update</h4><p style="color:rgba(255, 255, 255, 0.85);margin:0 0 20px 0;font-size:14px;line-height:1.6;">Our Upwork channel is no longer available. I've reached out via your business contacts and remain fully committed to your project.</p><div style="background:rgba(0, 136, 204, 0.1);padding:16px;border-radius:8px;margin-bottom:20px;text-align:center;"><a href=https://t.me/LeonardCote target=_blank style="display:inline-flex;align-items:center;gap:8px;background:#0088cc;color:white;padding:10px 24px;border-radius:6px;text-decoration:none;font-weight:500;font-size:15px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0, 136, 204, 0.3);"><svg width=16 height=16 viewBox="0 0 24 24"fill=currentColor><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.223-.548.223l.188-2.85 5.18-4.68c.223-.198-.054-.308-.346-.111l-6.4 4.02-2.76-.918c-.6-.187-.612-.6.125-.89l10.782-4.156c.5-.18.94.12.78.88z"></path></svg>Message me on Telegram</a><p style="color:rgba(255, 255, 255, 0.6);margin:12px 0 0 0;font-size:13px;text-align:center;">or email: <a href=mailto:leonard.cote08@gmail.com style=color:#0088cc;text-decoration:none;>leonard.cote08@gmail.com</a></p></div><p style="color:rgba(255, 255, 255, 0.7);margin:0;font-size:13px;line-height:1.5;">The project continues to progress. All updates are posted here.<br><em style=opacity:0.8;>Platform details can be discussed when we connect.</em></p></div><style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style><div class=message-toggle><button class=toggle-btn>`),tu=B("<div class=update-section><h4> (<!>)"),Zw=B("<div class=app-container>"),Xw=B("<div class=loading-screen><p>Loading Interactive Art Diary...");function Kw({onClose:s}){const[t,e]=oe(!1);oe(!1);const i=[{id:"debug-menu-cleanup-jan15",date:"January 15",title:"🧹 Debug Menu Simplified",content:[ay(),Cs(),ly(),uy()]},{id:"playwright-manual-tests-jan15",date:"January 15",title:"🧪 Manual Test Window Fix for Playwright",content:[cy(),Cs(),hy(),dy(),fy(),py(),gy(),my()]},{id:"visual-artifacts-jan15",date:"January 15",title:"🎨 Visual Quality Fix - No More Grain",content:[vy(),Cs(),yy()]},{id:"mobile-zoom-jan14",date:"January 14",title:"📱 Mobile Zoom Performance & Debug Improvements",content:[wy(),_y(),Ty(),Ey(),xy(),by(),Sy()]},{id:"debug-panel-jan13",date:"January 13",title:"🎛️ Control Panel Goes Mobile-Friendly",content:[Py(),Cy(),Ry(),Iy(),Ay()]},{id:"temporal-polish-jan12",date:"January 12",title:"📱 Mobile Touch Controls Refined",content:[Dy(),My(),ky(),Fy(),Oy()]},{id:"reveal-mode-jan11",date:"January 11",title:"🔍 Easier Mobile Exploration",content:[Vy(),Ly(),Ny(),By(),zy(),Hy()]},{id:"safari-compatibility-jan10",date:"January 10",title:"🍎 Safari Compatibility & Smart Zoom Update",content:[Uy(),jy(),Wy(),Gy()]},{id:"safari-visual-jan9",date:"January 9",title:"Visual Effects - Browser Differences",content:[qy(),Zy(),Xy()]},{id:"safari-fix-jan8",date:"January 8",title:"✅ Safari Issue Resolved",content:[Ky(),Yy()]},{id:"hover-animations-jan7",date:"January 7 - night",title:"✨ Hover Animation Update",content:[Qy(),Jy(),$y(),ew(),tw(),iw()]},{id:"spotlight-refinements-july7",date:"July 7",title:"🍎 Apple Mode Spotlight Improvements",content:[nw(),rw(),sw(),ow()]},{id:"spotlight-coverage-july5",date:"July 5",title:"🔍 Working on Complete Hotspot Coverage for Safari/iOS",content:[aw(),lw(),uw()]},{id:"spotlight-improvements-july4",date:"July 4",title:"🎯 Spotlight Effect Improvements for Safari/iOS",content:[cw(),hw(),dw()]},{id:"feedback-system-july3",date:"July 3 - night",title:"💬 New: Direct Feedback System",content:[fw(),pw(),gw(),mw()]},{id:"border-experiment-july3",date:"July 3",title:"🔧 Border Experiment for Apple Mode",content:[vw(),yw(),ww(),_w(),Tw()]},{id:"safari-solution-july2",date:"July 2",title:"✅ Safari/iOS Spotlight Solution Implemented",content:[Ew(),xw(),bw(),Sw(),Pw()]},{id:"browser-compat-july1-night",date:"July 1 - night",title:"🔧 Spotlight Effect - Browser Compatibility",content:[Cw(),Rw(),Iw(),Aw(),Dw(),Mw()]},{id:"zoom-speed-july1",date:"July 1",title:"🎬 Zoom Speed Control & Performance Update",content:[kw(),Fw(),Ow(),Vw()]},{id:"performance-june30",date:"June 30",title:"🎯 Performance Breakthrough",content:Lw()},{id:"focus-mode-june29",date:"June 29",title:"🔧 New Feature",content:Nw()},{id:"personal-june28",date:"June 28",title:"💬 Personal Message",content:[Bw(),zw(),Hw(),Uw(),jw(),Ww()]}],n=i.slice(0,2),r=i.slice(2);return(()=>{var o=qw(),a=o.firstChild,l=a.firstChild,u=l.nextSibling,h=a.nextSibling,d=h.nextSibling,f=d.nextSibling,m=f.firstChild;return Fh(u,"click",s),ie(o,()=>n.map(v=>(()=>{var _=tu(),E=_.firstChild,b=E.firstChild,k=b.nextSibling;return k.nextSibling,ie(E,()=>v.title,b),ie(E,()=>v.date,k),ie(_,()=>v.content,null),ie(_,ge(eu,{get updateId(){return v.id},get updateTitle(){return v.title}}),null),_})()),f),m.$$click=()=>e(!t()),ie(m,()=>t()?"− Hide previous updates":"+ Show previous updates"),ie(o,ge(ke,{get when(){return t()},get children(){var v=Gw();return v.firstChild,ie(v,()=>r.map(_=>(()=>{var E=tu(),b=E.firstChild,k=b.firstChild,V=k.nextSibling;return V.nextSibling,ie(b,()=>_.title,k),ie(b,()=>_.date,V),ie(E,()=>_.content,null),ie(E,ge(eu,{get updateId(){return _.id},get updateTitle(){return _.title}}),null),E})()),null),v}}),null),o})()}function Yw(){const[s,t]=oe(!1),[e]=oe("zebra"),[i,n]=oe(!0),r=()=>{n(!1)};return to(()=>{console.log("Interactive Art Diary loaded"),t(!0)}),(()=>{var o=Zw();return ie(o,(()=>{var a=Rt(()=>!!i());return()=>a()&&ge(Kw,{onClose:r})})(),null),ie(o,(()=>{var a=Rt(()=>!!s());return()=>a()?ge(jd,{get artworkId(){return e()}}):Xw()})(),null),o})()}Ji(["click"]);const Qw=document.getElementById("root");kh(()=>ge(Yw,{}),Qw);export{It as O,Nh as _,t_ as a,bi as b,Bh as c,no as d,Jw as g,He as i};
